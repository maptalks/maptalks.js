!function(){"use strict";"0.15.6";var t={};t.node=function(){return new Function("try { return this === global; } catch(e) { return false; }")()}(),t.node?t.Browser={canvas:!0}:function(){var e=navigator.userAgent.toLowerCase(),i=document.documentElement,n="ActiveXObject"in window,r=e.indexOf("webkit")!==-1,o=e.indexOf("phantom")!==-1,s=e.search("android [23]")!==-1,a=e.indexOf("chrome")!==-1,h=e.indexOf("gecko")!==-1&&!r&&!window.opera&&!n,l="undefined"!=typeof orientation||e.indexOf("mobile")!==-1,u=!window.PointerEvent&&window.MSPointerEvent,c=window.PointerEvent&&navigator.pointerEnabled||u,d=n&&"transition"in i.style,m="WebKitCSSMatrix"in window&&"m11"in new window.WebKitCSSMatrix&&!s,f="MozPerspective"in i.style,g="OTransition"in i.style,p=(d||m||f)&&!g&&!o,_=!o&&(c||"ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch);t.Browser={ie:n,ielt9:n&&!document.addEventListener,edge:"msLaunchUri"in navigator&&!("documentMode"in document),webkit:r,gecko:h,android:e.indexOf("android")!==-1,android23:s,chrome:a,safari:!a&&e.indexOf("safari")!==-1,phantomjs:o,ie3d:d,webkit3d:m,gecko3d:f,opera12:g,any3d:p,mobile:l,mobileWebkit:l&&r,mobileWebkit3d:l&&m,mobileOpera:l&&window.opera,mobileGecko:l&&h,touch:!!_,msPointer:!!u,pointer:!!c,retina:(window.devicePixelRatio||window.screen.deviceXDPI/window.screen.logicalXDPI)>1,language:navigator.browserLanguage?navigator.browserLanguage:navigator.language,ie9:n&&9===document.documentMode,ie10:n&&10===document.documentMode,canvas:!!document.createElement("canvas").getContext}}(),t.node||function(){for(var e=document.getElementsByTagName("head")[0],i=e.childNodes,n=null,r=0,o=i.length;r<o;r++)if("meta"===i[r].nodeName.toLowerCase()){var s=i[r].getAttribute?i[r].getAttribute("name"):null;"viewport"===s&&(n=i[r])}if(t.Browser.mobile)if(null===n)n=document.createElement("meta"),n.setAttribute("name","viewport"),n.setAttribute("content","user-scalable=no"),e.appendChild(n);else{var a=n.getAttribute("content");a.indexOf("user-scalable=no")<0&&n.setAttribute("content",a+",user-scalable=no")}if(t.Browser.ielt9){var h=document.createElement("meta");h.setAttribute("http-equiv","X-UA-Compatible"),h.setAttribute("content","IE=edge,chrome=1"),e.appendChild(h)}}(),t.internalLayerPrefix="_maptalks__internal_layer_",t.Util={uid:0,now:function(){return Date.now?Date.now():(new Date).getTime()},extend:function(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var n in i)t[n]=i[n]}return t},setOptions:function(e,i){e.hasOwnProperty("options")||(e.options=e.options?t.Util.create(e.options):{});for(var n in i)e.options[n]=i[n];return e.options},isSVG:function(t){return t.length>4&&".svg"===t.slice(-4)?1:"data:image/svg+xml"===t.slice(0,"data:image/svg+xml".length)?2:0},loadImage:function(e,i){function n(t){t&&(console.error(t),console.error(t.stack));var i=e.onerror;i&&i.call(e)}function r(t,i){if(t)return void n(t);var r=e.onload;r&&(e.onload=function(){r.call(e)}),e.src=i}if(!t.node)return e.src=i[0],this;var o=i[0],s=i[1],a=i[2];try{t.Util.isSVG(o)&&t.Util.convertSVG?t.Util.convertSVG(o,s,a,r):t.Util.isURL(o)?this._loadRemoteImage(e,o,r):this._loadLocalImage(e,o,r)}catch(t){n(t)}return this},_loadRemoteImage:function(t,e,i){var n;n=0===e.indexOf("https://")?require("https"):require("http");var r=require("url").parse(e);r.headers={Accept:"image/*,*/*;q=0.8","Accept-Encoding":"gzip, deflate","Cache-Control":"no-cache",Connection:"keep-alive",Host:r.host,Pragma:"no-cache","User-Agent":"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/50.0.2661.94 Safari/537.36"},n.request(r,function(t){var e=[];t.on("data",function(t){e.push(t)}),t.on("end",function(){i(null,Buffer.concat(e))})}).on("error",i).end()},_loadLocalImage:function(t,e,i){require("fs").readFile(e,i)},fixPNG:function(){},UID:function(){return t.Util.uid++},parseJSON:function(e){return e&&t.Util.isString(e)?JSON.parse(e):e},create:Object.create||function(){function t(){}return function(e){return t.prototype=e,new t}}(),bind:function(t,e){var i=Array.prototype.slice;if(t.bind)return t.bind.apply(t,i.call(arguments,1));var n=i.call(arguments,2);return function(){return t.apply(e,n.length?n.concat(i.call(arguments)):arguments)}},throttle:function(t,e,i){var n,r,o,s;return s=function(){n=!1,r&&(o.apply(i,r),r=!1)},o=function(){n?r=arguments:(t.apply(i,arguments),setTimeout(s,e),n=!0)}},executeWhen:function(e,i){var n=function(){i()?e():t.Util.requestAnimFrame(n)};return n(),this},removeFromArray:function(t,e){for(var i=e.length-1;i>=0;i--)if(e[i]===t)return e.splice(i,1);return null},mapArrayRecursively:function(e,i,n){if(!this.isArray(e))return null;for(var r,o,s=[],a=0,h=e.length;a<h;a++)r=e[a],t.Util.isNil(r)?s.push(null):t.Util.isArray(r)?s.push(t.Util.mapArrayRecursively(r,i,n)):(o=n?i.call(n,r):i(r),s.push(o));return s},mapArray:function(e,i,n){if(!this.isArray(e))return null;for(var r,o,s=[],a=0,h=e.length;a<h;a++)r=e[a],t.Util.isNil(r)?s.push(null):(o=n?i.call(n,r):i(r),s.push(o));return s},indexOfArray:function(e,i){if(!t.Util.isArrayHasData(i))return-1;for(var n=0,r=i.length;n<r;n++)if(i[n]===e)return n;return-1},getValueOrDefault:function(t,e){return void 0===t?e:t},objEqual:function(e,i){return t.Util._objEqual(e,i)},objDeepEqual:function(e,i){return t.Util._objEqual(e,i,!0)},_objEqual:function(e,i,n){function r(t){if(Object.keys)return Object.keys(t);var e=[];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&e.push(i);return e}if(t.Util.isNil(e)||t.Util.isNil(i))return!1;if(e.prototype!==i.prototype)return!1;var o,s,a,h;try{o=r(e),s=r(i)}catch(t){return!1}if(o.length!==s.length)return!1;for(h=o.length-1;h>=0;h--)if(o[h]!==s[h])return!1;if(n)for(h=o.length-1;h>=0;h--)if(a=o[h],!t.Util.objEqual(e[a],i[a]))return!1;return!0},round:function(t){return t>0?.5+t<<0:t-.5<<0},sign:function(t){return Math.sign?Math.sign(t):(t=+t,0===t||isNaN(t)?Number(t):t>0?1:-1)},isCoordinate:function(e){return e instanceof t.Coordinate},isNil:function(t){return null==t},isNumber:function(t){return"number"==typeof t&&!isNaN(t)},isInteger:function(t){return(0|t)===t},isObject:function(t){return"object"==typeof t&&!!t},isArrayHasData:function(t){return this.isArray(t)&&t.length>0},isArray:function(t){return!!t&&(Array.isArray?Array.isArray(t):"[object Array]"===Object.prototype.toString.call(t))},isString:function(e){return!t.Util.isNil(e)&&("string"==typeof e||null!==e.constructor&&e.constructor===String)},isFunction:function(t){return!this.isNil(t)&&("function"==typeof t||null!==t.constructor&&t.constructor===Function)},isURL:function(t){if(!t)return!1;var e=t.slice(0,6);return"http:/"===e||"https:"===e},cssUrlReWithQuote:/^url\(([\'\"])(.+)\1\)$/i,cssUrlRe:/^url\(([^\'\"].*[^\'\"])\)$/i,isCssUrl:function(e){if(!t.Util.isString(e))return 0;var i=e.slice(0,6);return"http:/"===i||"https:"===i?3:t.Util.cssUrlRe.test(e)?1:t.Util.cssUrlReWithQuote.test(e)?2:0},extractCssUrl:function(e){var i,n=t.Util.isCssUrl(e);return 3===n?e:1===n?(i=t.Util.cssUrlRe.exec(e),i[1]):2===n?(i=t.Util.cssUrlReWithQuote.exec(e),i[2]):e},b64chrs:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",btoa:function(e){if("undefined"!=typeof window&&window.btoa)return window.btoa(e);for(var i,n,r=String(e),o=0,s=t.Util.b64chrs,a="";r.charAt(0|o)||(s="=",o%1);a+=s.charAt(63&i>>8-o%1*8)){if((n=r.charCodeAt(o+=.75))>255)throw new Error("'btoa' failed: The string to be encoded contains characters outside of the Latin1 range.");i=i<<8|n}return a},globalEval:function(t){var e=document.createElement("script");e.text=t,document.head.appendChild(e).parentNode.removeChild(e)},globalScript:function(t){var e=document.createElement("script");e.type="text/javascript",e.src=t,document.head.appendChild(e)},lowerSymbolOpacity:function(e,i){function n(e,i){var n=e.opacity;t.Util.isNil(n)?e.opacity=i:e.opacity*=i}var r;if(t.Util.isArray(e)){r=[];for(var o=0;o<e.length;o++){var s=t.Util.extend({},e[o]);n(s,i),r.push(s)}}else r=t.Util.extend({},e),n(r,i);return r},extendSymbol:function(e){var i=Array.prototype.slice.call(arguments,1);if(i&&i.length||(i=[{}]),t.Util.isArray(e)){var n,r,o,s,a,h,l=[];for(o=0,a=e.length;o<a;o++){for(n=e[o],r={},s=0,h=i.length;s<h;s++)t.Util.isArray(i[s])?t.Util.isNil(i[s][o])?t.Util.extend(r,n?n:{}):t.Util.extend(r,n,i[s][o]):t.Util.extend(r,n,i[s]?i[s]:{});l.push(r)}return l}var u=[{},e];return u.push.apply(u,i),t.Util.extend.apply(t.Util,u)},computeDegree:function(t,e){var i=e.x-t.x,n=e.y-t.y;return Math.atan2(n,i)},isGradient:function(t){return t&&t.colorStops},getGradientStamp:function(t){var e=[t.type];if(t.places&&e.push(t.places.join()),t.colorStops){for(var i=[],n=t.colorStops.length-1;n>=0;n--)i.push(t.colorStops[n].join());e.push(i.join(","))}return e.join("_")},getSymbolStamp:function(e){var i=[];if(t.Util.isArray(e)){for(var n=0;n<e.length;n++)i.push(t.Util.getSymbolStamp(e[n]));return"[ "+i.join(" , ")+" ]"}for(var r in e)e.hasOwnProperty(r)&&(t.Util.isFunction(e[r])||(t.Util.isGradient(e[r])?i.push(r+"="+t.Util.getGradientStamp(e[r])):i.push(r+"="+e[r])));return i.join(";")},getExternalResources:function(e,i){if(!e)return null;var n=e;t.Util.isArray(e)||(n=[e]);var r,o,s,a,h,l,u,c=[],d=t.Symbolizer.resourceProperties;for(r=n.length-1;r>=0;r--)if(e=n[r]){for(i&&(e=t.Util.convertResourceUrl(e)),o=0;o<d.length;o++)if(a=e[d[o]],t.Util.isFunctionDefinition(a)&&(a=t.Util.getFunctionTypeResources(a)),a)for(t.Util.isArray(a)||(a=[a]),s=0;s<a.length;s++)"url("===a[s].slice(0,4)&&(a[s]=t.Util.extractCssUrl(a[s])),h=t.Symbolizer.resourceSizeProperties[o],c.push([a[s],e[h[0]],e[h[1]]]);if("path"===e.markerType&&e.markerPath)if(l=t.Util.isFunctionDefinition(e.markerWidth)?200:e.markerWidth,u=t.Util.isFunctionDefinition(e.markerHeight)?200:e.markerHeight,t.Util.isFunctionDefinition(e.markerPath)){a=t.Util.getFunctionTypeResources(e.markerPath);var m=e.markerPath;for(s=0;s<a.length;s++)e.markerPath=a[s],c.push([t.Geometry.getMarkerPathBase64(e),l,u]);e.markerPath=m}else c.push([t.Geometry.getMarkerPathBase64(e),l,u])}return c},convertResourceUrl:function(e){if(!e)return null;var i=e;if(t.node)return i;for(var n,r=t.Symbolizer.resourceProperties,o=0,s=r.length;o<s;o++)(n=i[r[o]])&&(i[r[o]]=this._convertUrlToAbsolute(n));return i},_convertUrlToAbsolute:function(e){if(t.Util.isFunctionDefinition(e)){for(var i=e.stops,n=0;n<i.length;n++)i[n][1]=t.Util._convertUrlToAbsolute(i[n][1]);return e}return"url("===e.slice(0,4)&&(e=t.Util.extractCssUrl(e)),!t.Util.isURL(e)&&(e.length<="data:".length||"data:"!==e.substring(0,"data:".length))&&(e=this._absolute(location.href,e)),e},_absolute:function(t,e){var i=t.split("/"),n=e.split("/");if(0===e.slice(0,1))return i.slice(0,3).join("/")+e;i.pop();for(var r=0;r<n.length;r++)"."!==n[r]&&(".."===n[r]?i.pop():i.push(n[r]));return i.join("/")},compileStyle:function(e){if(!t.Util.isArray(e))return t.Util.compileStyle([e]);for(var i=[],n=0;n<e.length;n++)e[n].filter===!0?i.push({filter:function(){return!0},symbol:e[n].symbol}):i.push({filter:t.Util.createFilter(e[n].filter),symbol:e[n].symbol});return i},callImmediate:function(e){return"undefined"!=typeof setImmediate?setImmediate(e):t.Util.requestAnimFrame(e)},clearCallImmediate:function(e){return"undefined"!=typeof clearImmediate?clearImmediate(e):t.Util.cancelAnimFrame(e)}},t.Util.GUID=t.Util.UID,function(){function e(t){var e=+new Date,i=Math.max(0,16-(e-o));return o=e+i,setTimeout(t,i)}function i(t){return window["webkit"+t]||window["moz"+t]||window["ms"+t]}if(t.node)return t.Util.requestAnimFrame=function(t){return setTimeout(t,16)},void(t.Util.cancelAnimFrame=clearTimeout);var n,r,o=0;"undefined"!=typeof window?(n=window.requestAnimationFrame||i("RequestAnimationFrame")||e,r=window.cancelAnimationFrame||i("CancelAnimationFrame")||i("CancelRequestAnimationFrame")||function(t){window.clearTimeout(t)}):(n=e,r=function(t){clearTimeout(t)}),t.Util.requestAnimFrame=function(t){return n(t)},t.Util.cancelAnimFrame=function(t){t&&r(t)}}(),t.StringUtil={trim:function(t){return t.trim?t.trim():t.replace(/^\s+|\s+$/g,"")},splitWords:function(e){return t.StringUtil.trim(e).split(/\s+/)},stringLength:function(e,i){var n=t.DomUtil._getDomRuler("span");n.style.font=i,n.innerHTML=e;var r=new t.Size(n.clientWidth,n.clientHeight);return t.DomUtil.removeDomNode(n),r},splitContent:function(t,e,i){for(var n=Math.ceil(e/i),r=e/t.length,o=Math.floor(i/r),s=[],a=0;a<n;a++)a<n-1?s.push(t.substring(a*o,(a+1)*o)):s.push(t.substring(a*o));return s},replaceVariable:function(e,i){return t.Util.isObject(i)&&t.Util.isString(e)?e.replace(t.StringUtil._contentExpRe,function(e,n){var r=i[n];return t.Util.isNil(r)?e:r}):e},_contentExpRe:/\{([\w_]+)\}/g,splitTextToRow:function(e,i){var n=t.symbolizer.TextMarkerSymbolizer.getFont(i),r=i.textLineSpacing||0,o=t.StringUtil.stringLength(e,n),s=o.width,a=o.height,h=i.textWrapCharacter,l=i.textWrapWidth,u=[];(!l||l>s)&&(l=s),t.Util.isString(e)||(e+="");var c,d,m,f=0;if(h&&e.indexOf(h)>=0){var g,p,_,y,v,x,w=e.split(h);for(d=0,m=w.length;d<m;d++)if(g=w[d],p=t.StringUtil.stringLength(g,n),(_=p.width)>l)for(y=t.StringUtil.splitContent(g,_,l),v=0,x=y.length;v<x;v++)c=t.StringUtil.stringLength(y[v],n),c.width>f&&(f=c.width),u.push({text:y[v],size:c});else p.width>f&&(f=p.width),u.push({text:g,size:p})}else if(s>l){var C=t.StringUtil.splitContent(e,s,l);for(d=0;d<C.length;d++)c=t.StringUtil.stringLength(C[d],n),c.width>f&&(f=c.width),u.push({text:C[d],size:c})}else o.width>f&&(f=o.width),u.push({text:e,size:o});var b=u.length;return{total:b,size:new t.Size(f,a*b+r*(b-1)),rows:u,rawSize:o}},getAlignPoint:function(e,i,n){var r,o,s=e.width,a=e.height;return"left"===i?r=-s:"middle"===i?r=-s/2:"right"===i&&(r=0),"top"===n?o=-a:"middle"===n?o=-a/2:"bottom"===n&&(o=0),new t.Point(r,o)},filterContent:function(e){if(!t.Util.isString(e))return e;return e.replace(/[\b\t\r\v\f]/gim,"")},filterLastEnter:function(e){if(!t.Util.isString(e))return e;return e.replace(/[\r\n]+$/gi,"")}},t.DomUtil={createEl:function(e,i){var n=document.createElement(e);return i&&t.DomUtil.setClass(n,i),n},createElOn:function(t,e,i){var n=this.createEl(t);return e&&this.setStyle(n,e),i&&i.appendChild(n),n},removeDomNode:function(e){if(e)if(t.Browser.ielt9||t.Browser.ie9){var i=t.DomUtil.createEl("div");i.appendChild(e),i.innerHTML="",i=null}else e.parentNode&&e.parentNode.removeChild(e)},addDomEvent:function(e,i,n,r){if(!e||!i||!n)return t.DomUtil;for(var o=function(t){return t||(t=window.event),n.call(r||e,t)},s=i.split(" "),a=s.length-1;a>=0;a--){var h=s[a];if(h){e["Z__"+h]||(e["Z__"+h]=[]);t.DomUtil.listensDomEvent(e,h,n)>=0&&t.DomUtil.removeDomEvent(e,h,n),e["Z__"+h].push({callback:o,src:n}),"addEventListener"in e?("mousewheel"===h&&void 0!==document.mozHidden&&(h="DOMMouseScroll"),e.addEventListener(h,o,!1)):"attachEvent"in e&&e.attachEvent("on"+h,o)}}return t.DomUtil},removeDomEvent:function(t,e,i){function n(e,i){"removeEventListener"in t?("mousewheel"===e&&void 0!==document.mozHidden&&(e="DOMMouseScroll"),t.removeEventListener(e,i,!1)):"detachEvent"in t&&t.detachEvent("on"+e,i)}if(!t||!e)return this;for(var r=e.split(" "),o=r.length-1;o>=0;o--){var s=r[o];if(s){if(!i&&t["Z__"+s]){for(var a=t["Z__"+s],h=0,l=a.length;h<l;h++)n(a[h].callback);return delete t["Z__"+s],this}var u=this.listensDomEvent(t,s,i);if(u<0)return this;n(s,t["Z__"+s][u].callback),t["Z__"+s].splice(u,1)}}return this},listensDomEvent:function(t,e,i){if(!t||!t["Z__"+e]||!i)return-1;for(var n=t["Z__"+e],r=0,o=n.length;r<o;r++)if(n[r].src===i)return r;return-1},preventDefault:function(t){t.preventDefault?t.preventDefault():t.returnValue=!1},stopPropagation:function(t){return t.stopPropagation?t.stopPropagation():t.cancelBubble=!0,this},preventSelection:function(t){return t.onselectstart=function(){return!1},t.ondragstart=function(){return!1},t.setAttribute("unselectable","on"),this},offsetDom:function(e,i){return e?(t.Browser.any3d?t.DomUtil.setTransform(e,i):(e.style.left=i.x+"px",e.style.top=i.y+"px"),i):null},getPagePosition:function(e){var i=document.documentElement,n=e.getBoundingClientRect();return new t.Point(n.left+i.scrollLeft,n.top+i.scrollTop)},getEventContainerPoint:function(e,i){e||(e=window.event);var n=i.getBoundingClientRect();return new t.Point(e.clientX-n.left-i.clientLeft,e.clientY-n.top-i.clientTop)},setStyle:function(t,e){var i=t.style,n=i.cssText;(function(t,e){var i=t.length-e.length;return i>=0&&t.indexOf(e,i)===i})(n,";")||(n+=";"),t.style.cssText=n+e},removeStyle:function(t){t.style.cssText=""},addStyle:function(t,e,i){var n=t.style.cssText;if(e&&i){var r=e+":"+i+";";t.style.cssText=n+r}},hasClass:function(e,i){if(void 0!==e.classList)return e.classList.contains(i);var n=t.DomUtil.getClass(e);return n.length>0&&new RegExp("(^|\\s)"+i+"(\\s|$)").test(n)},addClass:function(e,i){if(void 0!==e.classList)for(var n=t.StringUtil.splitWords(i),r=0,o=n.length;r<o;r++)e.classList.add(n[r]);else if(!t.DomUtil.hasClass(e,i)){var s=t.DomUtil.getClass(e);t.DomUtil.setClass(e,(s?s+" ":"")+i)}},removeClass:function(e,i){void 0!==e.classList?e.classList.remove(i):t.DomUtil.setClass(e,t.StringUtil.trim((" "+t.DomUtil.getClass(e)+" ").replace(" "+i+" "," ")))},setClass:function(e,i){t.Util.isNil(e.className.baseVal)?e.className=i:e.className.baseVal=i},getClass:function(e){return t.Util.isNil(e.className.baseVal)?e.className:e.className.baseVal},setOpacity:function(e,i){"opacity"in e.style?e.style.opacity=i:"filter"in e.style&&t.DomUtil._setOpacityIE(e,i)},_setOpacityIE:function(t,e){var i=!1,n="DXImageTransform.Microsoft.Alpha";try{i=t.filters.item(n)}catch(t){if(1===e)return}e=Math.round(100*e),i?(i.Enabled=100!==e,i.Opacity=e):t.style.filter+=" progid:"+n+"(opacity="+e+")"},copyCanvas:function(e){if(t.node)return null;var i=t.DomUtil.createEl("canvas");return i.width=e.width,i.height=e.height,i.getContext("2d").drawImage(e,0,0),i},testCanvasSize:function(){if(t.node)return function(){return!0};var e=null,i=null;return function(n){if(!e){var r=t.DomUtil.createEl("canvas");r.width=1,r.height=1,e=r.getContext("2d"),i=e.createImageData(1,1);var o=i.data;o[0]=42,o[1]=84,o[2]=126,o[3]=255}var s=e.canvas,a=n.width<=s.width&&n.height<=s.height;if(!a){s.width=n.width,s.height=n.height;var h=n.width-1,l=n.height-1;e.putImageData(i,h,l);for(var u=e.getImageData(h,l,1,1),c=!0,d=u.data.length-1;d>=0;d--)if(u.data[d]!==i.data[d]){c=!1;break}a=c}return a}}(),testProp:function(t){for(var e=document.documentElement.style,i=0;i<t.length;i++)if(t[i]in e)return t[i];return!1},setTransform:function(e,i){var n=i||new t.Point(0,0);return e.style[t.DomUtil.TRANSFORM]=t.Browser.ie3d?"translate("+n.x+"px,"+n.y+"px)":"translate3d("+n.x+"px,"+n.y+"px,0)",this},setTransformMatrix:function(e,i){return e.style[t.DomUtil.TRANSFORM]="matrix("+i.join()+")",this},removeTransform:function(e){return e.style[t.DomUtil.TRANSFORM]=null,this},isHTML:function(t){return/<[a-z\][\s\S]*>/i.test(t)},measureDom:function(e,i){var n=t.DomUtil._getDomRuler(e);t.Util.isString(i)?n.innerHTML=i:n.appendChild(i);var r=new t.Size(n.clientWidth,n.clientHeight);return t.DomUtil.removeDomNode(n),r},_getDomRuler:function(t){var e=document.createElement(t);return e.style.cssText="position:absolute;left:-10000px;top:-10000px;",document.body.appendChild(e),e}},t.DomUtil.on=t.DomUtil.addDomEvent,t.DomUtil.off=t.DomUtil.removeDomEvent,function(){t.node||(t.DomUtil.TRANSFORM=t.DomUtil.testProp(["transform","WebkitTransform","OTransform","MozTransform","msTransform"]),t.DomUtil.TRANSFORMORIGIN=t.DomUtil.testProp(["transformOrigin","WebkitTransformOrigin","OTransformOrigin","MozTransformOrigin","msTransformOrigin"]),t.DomUtil.TRANSITION=t.DomUtil.testProp(["transition","WebkitTransition","OTransition","MozTransition","msTransition"]),t.DomUtil.CSSFILTER=t.DomUtil.testProp(["filter","WebkitFilter","OFilter","MozFilter","msFilter"]))}(),t.Eventable={on:function(e,i,n){if(!e||!i)return this;if(!t.Util.isString(e))return this._switch("on",e,i);this._eventMap||(this._eventMap={});var r,o=e.toLowerCase().split(" ");n||(n=this);for(var s,a,h,l=0,u=o.length;l<u;l++){if(r=o[l],s=this._eventMap[r],s||(s=[],this._eventMap[r]=s),(h=s.length)>0)for(a=0;a<h;a++)if(i===s[a].handler&&s[a].context===n)return this;s.push({handler:i,context:n})}return this},once:function(e,i,n){if(!t.Util.isString(e)){var r={};for(var o in e)e.hasOwnProperty(o)&&(r[o]=this._wrapOnceHandler(o,e[o],n));return this._switch("on",r)}for(var s=e.split(" "),a=0,h=s.length;a<h;a++)this.on(s[a],this._wrapOnceHandler(s[a],i,n));return this},_wrapOnceHandler:function(t,e,i){var n=this,r=!1;return function o(){r||(r=!0,i?e.apply(i,arguments):e.apply(this,arguments),n.off(t,o,this))}},off:function(e,i,n){if(!e||!this._eventMap||!i)return this;if(!t.Util.isString(e))return this._switch("off",e,i);var r,o,s=e.split(" ");n||(n=this);for(var a,h=0,l=s.length;h<l;h++){if(r=s[h].toLowerCase(),!(o=this._eventMap[r]))return this;for(a=o.length-1;a>=0;a--)i===o[a].handler&&o[a].context===n&&o.splice(a,1)}return this},_switch:function(t,e,i){for(var n in e)e.hasOwnProperty(n)&&this[t](n,e[n],i);return this},_clearListeners:function(e){if(this._eventMap&&t.Util.isString(e)){this._eventMap[e.toLowerCase()]&&(this._eventMap[e]=null)}},_clearAllListeners:function(){this._eventMap=null},listens:function(e,i,n){if(!this._eventMap||!t.Util.isString(e))return 0;var r=this._eventMap[e.toLowerCase()];if(!r||0===r.length)return 0;for(var o=0,s=0,a=r.length;s<a;s++)if(i){if(i===r[s].handler&&(t.Util.isNil(n)||r[s].context===n))return 1}else o++;return o},copyEventListeners:function(t){var e=t._eventMap;if(!e)return this;var i,n,r;for(var o in e)for(i=e[o],n=0,r=i.length;n<r;n++)this.on(o,i[n].handler,i[n].context);return this},fire:function(){return this._eventParent?this._eventParent.fire.apply(this._eventParent,arguments):this._fire.apply(this,arguments)},_setEventParent:function(t){return this._eventParent=t,this},_fire:function(e,i){if(!this._eventMap)return this;var n=this._eventMap[e.toLowerCase()];if(!n)return this;i||(i={}),i.type=e,i.target=this;for(var r,o,s=n.slice(0),a=0,h=s.length;a<h;a++)s[a]&&(r=s[a].context,!0,o=t.Util.extend({},i),(r?s[a].handler.call(r,o):s[a].handler(o))===!1&&i.domEvent&&t.DomUtil.stopPropagation(i.domEvent));return this}},t.Eventable.addEventListener=t.Eventable.on,t.Eventable.removeEventListener=t.Eventable.off,t.Class=function(){},t.Class.extend=function(e){var i=function(){var e=this;return this instanceof i||(e=t.Util.create(i.prototype)),e.initialize&&e.initialize.apply(e,arguments),e._initHooks&&e.callInitHooks(),e},n=i.__super__=this.prototype,r=t.Util.create(n);r.constructor=i,i.prototype=r;for(var o in this)"_"===o[0]||!this.hasOwnProperty(o)||"prototype"===o||this[o]instanceof t.Class||(i[o]=this[o]);return e.statics&&(t.Util.extend(i,e.statics),delete e.statics),e.includes&&(t.Util.extend.apply(null,[r].concat(e.includes)),delete e.includes),r.options&&(e.options=t.Util.extend(t.Util.create(r.options),e.options)),t.Util.extend(r,e),r._initHooks=[],r.callInitHooks=function(){if(!this._initHooksCalled){n.callInitHooks&&n.callInitHooks.call(this),this._initHooksCalled=!0;for(var t=0,e=r._initHooks.length;t<e;t++)r._initHooks[t].call(this)}},r.config=function(e){if(!e){var i={};for(var n in this.options)this.options.hasOwnProperty(n)&&(i[n]=this.options[n]);return i}if(2===arguments.length){var r={};r[e]=arguments[1],e=r}for(var o in e)e.hasOwnProperty(o)&&(this.options[o]=e[o],this[o]&&this[o]instanceof t.Handler&&(e[o]?this[o].enable():this[o].disable()));return this.onConfig&&this.onConfig(e),this},i},t.Class.include=function(){for(var e=arguments,i=0,n=e.length;i<n;i++)t.Util.extend(this.prototype,e[i]);return this},t.Class.mergeOptions=function(e){return t.Util.extend(this.prototype.options,e),this},t.Class.addInitHook=function(t){var e=Array.prototype.slice.call(arguments,1),i="function"==typeof t?t:function(){this[t].apply(this,e)};return this.prototype._initHooks=this.prototype._initHooks||[],this.prototype._initHooks.push(i),this},t.animation={},t.Animation={speed:{slow:2e3,normal:1e3,fast:500},_resolveStyles:function(e){if(!e)return null;var i={},n={},r={};for(var o in e)if(e.hasOwnProperty(o)){var s,a=e[o];s=function(e){return!t.Util.isArray(e)&&e.constructor===Object||!(!t.Util.isArray(e)||e[0].constructor!==Object)}(a)?function(e){if(!t.Util.isArray(e))return t.Animation._resolveStyles(e);for(var i=[],n=[],r=[],o=0;o<e.length;o++){var s=t.Animation._resolveStyles(e[o]);s&&(i.push(s[0]),n.push(s[1]),r.push(s[2]))}return 0===i.length?null:[i,n,r]}(a):function(e){var i,n=e;t.Util.isArray(e)||(t.Util.isNumber(e)?n=[0,e]:e instanceof t.Point||e instanceof t.Coordinate?(i=e.constructor,n=[new i(0,0),e]):n=[e,e]);var r=n[0],o=n[1];return t.Util.isNumber(r)&&t.Util.isNumber(o)?r===o?null:[r,o-r,o]:t.Util.isArray(r)||r instanceof t.Coordinate||r instanceof t.Point?(t.Util.isArray(r)?(r=new t.Coordinate(r),o=new t.Coordinate(o)):(i=r.constructor,r=new i(r),o=new i(o)),r.equals(o)?null:[r,o.substract(r),o]):[r,0,o]}(a),s&&(n[o]=s[0],i[o]=s[1],r[o]=s[2])}return[n,i,r]},framing:function(e,i){i||(i={});var n=i.easing?t.animation.Easing[i.easing]:t.animation.Easing.linear;n||(n=t.animation.Easing.linear);var r,o,s;(e=t.Animation._resolveStyles(e))&&(o=e[0],r=e[1],s=e[2]);var a=function(e,i,n){if(!i||!n)return null;var r={};for(var o in n)if(n.hasOwnProperty(o)){if(i[o]===s[o]){r[o]=i[o];continue}var h=i[o],l=n[o];if(t.Util.isNumber(l))r[o]=h+e*l;else if(t.Util.isArray(l)){for(var u=[],c=0;c<l.length;c++)u.push(a(e,h[c],l[c]));r[o]=u}else{var d=l.constructor;d===Object?r[o]=a(e,h,l):(h instanceof t.Point||h instanceof t.Coordinate)&&(r[o]=h.add(l.multi(e)))}}return r};return function(e,i){var h,l;if(e<0)h={playState:"idle",delta:0},l=o;else if(e<i){var u=n(e/i);h={playState:"running",delta:u},l=a(u,o,r)}else h={playState:"finished",delta:1},l=s;return h.startStyles=o,h.destStyles=s,new t.animation.Frame(h,l)}},_requestAnimFrame:function(t){this._frameQueue||(this._frameQueue=[]),this._frameQueue.push(t),this._a()},_a:function(){this._animationFrameId||(this._animationFrameId=t.Util.requestAnimFrame(t.Animation._frameFn))},_run:function(){if(this._frameQueue.length){var e=this._frameQueue;this._frameQueue=[];for(var i=0,n=e.length;i<n;i++)e[i]();this._frameQueue.length?this._animationFrameId=t.Util.requestAnimFrame(t.Animation._frameFn):delete this._animationFrameId}},animate:function(e,i,n){i||(i={});var r=t.Animation.framing(e,i);return new t.animation.Player(r,i,n)}},t.Animation._frameFn=t.Util.bind(t.Animation._run,t.Animation),t.animation.Player=function(t,e,i){this._animation=t,this._options=e,this._stepFn=i,this.playState="idle",this.ready=!0,this.finished=!1},t.Util.extend(t.animation.Player.prototype,{_prepare:function(){var e=this._options,i=e.speed;t.Util.isString(i)&&(i=t.Animation.speed[i]),i||(i=t.Animation.speed.normal),this.duration=i},play:function(){if("idle"!==this.playState&&"paused"!==this.playState)return this;"idle"===this.playState&&(this.currentTime=0,this._prepare());var e=t.Util.now();if(!this.startTime){var i=this._options;this.startTime=i.startTime?i.startTime:e}return this._playStartTime=Math.max(e,this.startTime),"paused"===this.playState&&(this._playStartTime-=this.currentTime),this.playState="running",this._run(),this},pause:function(){return this.playState="paused",this},cancel:function(){return this.playState="idle",this.finished=!1,this},finish:function(){return this.playState="finished",this.finished=!0,this},reverse:function(){},_run:function(){if("finished"!==this.playState&&"paused"!==this.playState){var e=this,i=t.Util.now(),n=i-this._playStartTime;this._options.repeat&&n>=this.duration&&(this._playStartTime=i,n=0);var r=this._animation(n,this.duration);this.playState=r.state.playState;var o=this._stepFn;"idle"===this.playState?setTimeout(t.Util.bind(this._run,this),this.startTime-i):"running"===this.playState?this._animeFrameId=t.Animation._requestAnimFrame(function(){"running"===e.playState&&(e.currentTime=i-e._playStartTime,o&&o(r),e._run())}):"finished"===this.playState&&(this.finished=!0,o&&t.Util.requestAnimFrame(function(){o(r)}))}}}),t.animation.Easing={in:function(t){return Math.pow(t,2)},out:function(e){return 1-t.animation.Easing.in(1-e)},inAndOut:function(t){return 3*t*t-2*t*t*t},linear:function(t){return t},upAndDown:function(e){return e<.5?t.animation.Easing.inAndOut(2*e):1-t.animation.Easing.inAndOut(2*(e-.5))}},t.animation.Frame=function(t,e){this.state=t,this.styles=e},t.Canvas={createCanvas:function(e,i,n){var r;return t.node?r=new n(e,i):(r=t.DomUtil.createEl("canvas"),r.width=e,r.height=i),r},setDefaultCanvasSetting:function(t){t.lineWidth=1,t.lineCap="butt",t.lineJoin="miter",t.strokeStyle="rgba(0,0,0,1)",t.fillStyle="rgba(255,255,255,0)",t.textAlign="start",t.textBaseline="top";t.font="11px monospace",t.shadowBlur=null,t.shadowColor=null,t.setLineDash&&t.setLineDash([]),t.globalAlpha=1},prepareCanvasFont:function(e,i){e.textBaseline="top",e.font=t.symbolizer.TextMarkerSymbolizer.getFont(i);var n=i.textFill;n||(n=t.Symbolizer.DEFAULT_TEXT_COLOR),e.fillStyle=t.Canvas.getRgba(n,i.textOpacity)},prepareCanvas:function(e,i,n){if(i){var r=i.lineWidth;t.Util.isNil(r)||e.lineWidth===r||(e.lineWidth=r);var o=i.linePatternFile||i.lineColor||t.Symbolizer.DEFAULT_STROKE_COLOR;t.Util.isCssUrl(o)&&n?(t.Canvas._setStrokePattern(e,o,r,n),i.lineDasharray=[]):t.Util.isGradient(o)?i.lineGradientExtent?e.strokeStyle=t.Canvas._createGradient(e,o,i.lineGradientExtent):e.strokeStyle="rgba(0,0,0,1)":e.strokeStyle=o,i.lineJoin&&(e.lineJoin=i.lineJoin),i.lineCap&&(e.lineCap=i.lineCap),e.setLineDash&&t.Util.isArrayHasData(i.lineDasharray)&&e.setLineDash(i.lineDasharray);var s=i.polygonPatternFile||i.polygonFill||t.Symbolizer.DEFAULT_FILL_COLOR;if(t.Util.isCssUrl(s)){var a=t.Util.extractCssUrl(s),h=n.getImage([a,null,null]);if(h||(h=n.getImage([a+"-texture",null,r])),t.Util.isSVG(a)&&h instanceof Image&&(t.Browser.edge||t.Browser.ie)){var l=h.width||20,u=h.height||20,c=t.Canvas.createCanvas(l,u);t.Canvas.image(c.getContext("2d"),h,0,0,l,u),h=c}h?e.fillStyle=e.createPattern(h,"repeat"):!t.Browser.phantomjs&&console&&console.warn("img not found for",a)}else t.Util.isGradient(s)?i.polygonGradientExtent?e.fillStyle=t.Canvas._createGradient(e,s,i.polygonGradientExtent):e.fillStyle="rgba(255,255,255,0)":e.fillStyle=s}},_createGradient:function(t,e,i){var n=null,r=e.places,o=i.getMin(),s=i.getMax(),a=i.getWidth(),h=i.getHeight();if(e.type&&"linear"!==e.type){if("radial"===e.type){if(r){if(6!==r.length)throw new Error("A radial gradient's places should have 6 numbers.");r=[o.x+r[0]*a,o.y+r[1]*h,a*r[2],o.x+r[3]*a,o.y+r[4]*h,a*r[5]]}else{var l=i.getCenter()._round();r=[l.x,l.y,Math.abs(l.x-o.x),l.x,l.y,0]}n=t.createRadialGradient.apply(t,r)}}else{if(r){if(4!==r.length)throw new Error("A linear gradient's places should have 4 numbers.");r=[o.x+r[0]*a,o.y+r[1]*h,o.x+r[2]*a,o.y+r[3]*h]}else r=[o.x,o.y,s.x,o.y];n=t.createLinearGradient.apply(t,r)}return e.colorStops.forEach(function(t){n.addColorStop.apply(n,t)}),n},_setStrokePattern:function(e,i,n,r){var o,s=t.Util.extractCssUrl(i);if(t.node)o=r.getImage([s,null,n]);else{var a=s+"-texture-"+n;if(!(o=r.getImage(a))){var h=r.getImage([s,null,null]);if(h){var l;l=h.width&&h.height?t.Util.round(h.width*n/h.height):n;var u=t.Canvas.createCanvas(l,n,e.canvas.constructor);t.Canvas.image(u.getContext("2d"),h,0,0,l,n),r.addResource([a,null,n],u),o=u}}}o?e.strokeStyle=e.createPattern(o,"repeat"):!t.Browser.phantomjs&&console&&console.warn("img not found for",s)},clearRect:function(t,e,i,n,r){t.clearRect(e,i,n,r)},fillCanvas:function(e,i,n,r){if(0!==i){var o=t.Canvas._isPattern(e.fillStyle);t.Util.isNil(i)&&(i=1);var s;i<1&&(s=e.globalAlpha,e.globalAlpha*=i),o&&e.translate(n,r),e.fill(),o&&e.translate(-n,-r),i<1&&(e.globalAlpha=s)}},getRgba:function(e,i){if(t.Util.isNil(i)&&(i=1),"#"!==e[0])return e;var n,r,o;return 7===e.length?(n=parseInt(e.substring(1,3),16),r=parseInt(e.substring(3,5),16),
o=parseInt(e.substring(5,7),16)):(n=17*parseInt(e.substring(1,2),16),r=17*parseInt(e.substring(2,3),16),o=17*parseInt(e.substring(3,4),16)),"rgba("+n+","+r+","+o+","+i+")"},image:function(e,i,n,r,o,s){try{t.Util.isNumber(o)&&t.Util.isNumber(s)?e.drawImage(i,n,r,o,s):e.drawImage(i,n,r)}catch(t){console&&(console.warn("error when drawing image on canvas:",t),console.warn(i))}},text:function(e,i,n,r,o){t.Canvas._textOnMultiRow(e,o.rows,r,n,o.size,o.rawSize)},_textOnMultiRow:function(e,i,n,r,o,s){for(var a,h,l=t.StringUtil.getAlignPoint(o,n.textHorizontalAlignment,n.textVerticalAlignment),u=s.height+n.textLineSpacing,c=r.add(0,l.y),d=0,m=i.length;d<m;d++)a=i[d].text,h=t.StringUtil.getAlignPoint(i[d].size,n.textHorizontalAlignment,n.textVerticalAlignment),t.Canvas._textOnLine(e,a,c.add(h.x,d*u),n.textHaloRadius,n.textHaloFill,n.textHaloOpacity)},_textOnLine:function(t,e,i,n,r,o){if(t.textBaseline="top",0!==o&&0!==n){if(o){var s=t.globalAlpha;t.globalAlpha*=o}n&&(t.miterLimit=2,t.lineJoin="round",t.lineCap="round",t.lineWidth=2*n-1,t.strokeStyle=r,t.strokeText(e,i.x,i.y),t.lineWidth=1,t.miterLimit=10),o&&(t.globalAlpha=s)}t.fillText(e,i.x,i.y)},fillText:function(t,e,i,n){n&&(t.fillStyle=n),t.fillText(e,i.x,i.y)},_stroke:function(e,i,n,r){var o=t.Canvas._isPattern(e.strokeStyle)&&!t.Util.isNil(n)&&!t.Util.isNil(r);t.Util.isNil(i)&&(i=1);var s;i<1&&(s=e.globalAlpha,e.globalAlpha*=i),o&&e.translate(n,r),e.stroke(),o&&e.translate(-n,-r),i<1&&(e.globalAlpha=s)},_path:function(e,i,n,r,o){if(t.Util.isArrayHasData(i))for(var s,a,h,l=t.Util.isArrayHasData(n),u=o!==!0&&t.Canvas._isPattern(e.strokeStyle),c=0,d=i.length;c<d;c++)if(s=i[c],!l||e.setLineDash)e.lineTo(s.x,s.y),u&&c>0&&(a=i[c-1],function(i,n){var o=t.Util.computeDegree(i,n);e.save(),e.translate(i.x,i.y-e.lineWidth/2/Math.cos(o)),e.rotate(o),t.Canvas._stroke(e,r),e.restore()}(a,s),e.beginPath(),e.moveTo(s.x,s.y));else if(l){if(c===d-1)break;h=i[c+1],function(t,i,n){var r=t.x,o=t.y,s=i.x,a=i.y,h=n,l=function(t,e){return t<=e},u=function(t,e){return t>=e},c=function(t,e){return Math.min(t,e)},d=function(t,e){return Math.max(t,e)},m={thereYet:u,cap:c},f={thereYet:u,cap:c};o-a>0&&(f.thereYet=l,f.cap=d),r-s>0&&(m.thereYet=l,m.cap=d),e.moveTo(r,o);for(var g,p,_=r,y=o,v=0,x=!0;!m.thereYet(_,s)||!f.thereYet(y,a);)g=Math.atan2(a-o,s-r),p=h[v],_=m.cap(s,_+Math.cos(g)*p),y=f.cap(a,y+Math.sin(g)*p),x?e.lineTo(_,y):e.moveTo(_,y),v=(v+1)%h.length,x=!x}(s,h,n)}},path:function(e,i,n,r,o){e.beginPath(),e.moveTo(i[0].x,i[0].y),t.Canvas._path(e,i,o,n),t.Canvas._stroke(e,n)},polygon:function(e,i,n,r,o){function s(i,n,r){t.Canvas.fillCanvas(e,r,i[n][0].x,i[n][0].y)}var a=t.Canvas._isPattern(e.strokeStyle),h=t.Util.isArrayHasData(o)&&!e.setLineDash||a;t.Util.isArrayHasData(i[0])||(i=[i]);var l,u,c;if(h){for(e.save(),u=0,c=i.length;u<c;u++)t.Canvas._ring(e,i[u],null,0,!0),l=r,u>0&&(e.globalCompositeOperation="destination-out",l=1),s(i,u,l),u>0?e.globalCompositeOperation="source-over":e.fillStyle="#fff",t.Canvas._stroke(e,0);e.restore()}for(u=0,c=i.length;u<c;u++)t.Canvas._ring(e,i[u],o,n),h||(l=r,u>0&&(e.globalCompositeOperation="destination-out",l=1),s(i,u,l),u>0?e.globalCompositeOperation="source-over":e.fillStyle="#fff"),t.Canvas._stroke(e,n)},_ring:function(e,i,n,r,o){var s=o!==!0&&t.Canvas._isPattern(e.strokeStyle);s&&!i[0].equals(i[i.length-1])&&(i=i.concat([i[0]])),e.beginPath(),e.moveTo(i[0].x,i[0].y),t.Canvas._path(e,i,n,r,o),s||e.closePath()},_arcBetween:function(t,e,i,n){var r=n,o=e.distanceTo(i),s=o/2/Math.sin(r/2),a=Math.asin((i.y-e.y)/o);e.x>i.x&&(a=Math.PI-a);var h=90*Math.PI/180-r/2,l=a-h,u=Math.cos(l)*s,c=Math.sin(l)*s,d=e.x+u,m=e.y+c,f=Math.asin((i.y-m)/s);d>i.x&&(f=Math.PI-f);var g=f+r;t.beginPath(),t.arc(d,m,s,f,g)},_lineTo:function(t,e){t.lineTo(e.x,e.y)},bezierCurveAndFill:function(e,i,n,r){e.beginPath();var o=i[0];e.moveTo(o.x,o.y),t.Canvas._bezierCurveTo.apply(t.Canvas,[e].concat(i.splice(1))),t.Canvas.fillCanvas(e,r),t.Canvas._stroke(e,n)},_bezierCurveTo:function(t,e,i,n){t.bezierCurveTo(e.x,e.y,i.x,i.y,n.x,n.y)},ellipse:function(e,i,n,r,o,s){n===r?(e.beginPath(),e.arc(i.x,i.y,n,0,2*Math.PI),t.Canvas.fillCanvas(e,s,i.x-n,i.y-r),t.Canvas._stroke(e,o,i.x-n,i.y-r)):function(a,h,l,u){var c=.5522848,d=l*c,m=u*c;e.beginPath(),e.moveTo(a-l,h),e.bezierCurveTo(a-l,h-m,a-d,h-u,a,h-u),e.bezierCurveTo(a+d,h-u,a+l,h-m,a+l,h),e.bezierCurveTo(a+l,h+m,a+d,h+u,a,h+u),e.bezierCurveTo(a-d,h+u,a-l,h+m,a-l,h),e.closePath(),t.Canvas.fillCanvas(e,s,i.x-n,i.y-r),t.Canvas._stroke(e,o,i.x-n,i.y-r)}(i.x,i.y,n,r)},rectangle:function(e,i,n,r,o){e.beginPath(),e.rect(i.x,i.y,n.width,n.height),t.Canvas.fillCanvas(e,o,i.x,i.y),t.Canvas._stroke(e,r,i.x,i.y)},sector:function(e,i,n,r,o,s){var a=r[0],h=r[1];!function(e,i,n,r,a,h){var l=Math.PI/180,u=l*-h,c=l*-a;e.beginPath(),e.moveTo(i,n),e.arc(i,n,r,u,c),e.lineTo(i,n),t.Canvas.fillCanvas(e,s,i-r,n-r),t.Canvas._stroke(e,o,i-r,n-r)}(e,i.x,i.y,n,a,h)},_isPattern:function(e){return!(t.Util.isString(e)||"addColorStop"in e)},quadraticCurve:function(e,i){if(i&&!(i.length<=2)){var n=(i[0].x+i[1].x)/2,r=(i[0].y+i[1].y)/2;e.lineTo(n,r);var o,s=t.Canvas._getQuadCurvePoints(i),a=s.length;for(o=0;o<a;o+=4)e.quadraticCurveTo(s[o],s[o+1],s[o+2],s[o+3]);e.lineTo(i[i.length-1].x,i[i.length-1].y)}},_getQuadCurvePoints:function(t){var e,i,n,r=[],o=t.length;for(e=1;e<o-1;e++)i=(t[e].x+t[e+1].x)/2,n=(t[e].y+t[e+1].y)/2,r.push(t[e].x,t[e].y,i,n);return r}},function(){var e;if(t.node){var i=require("url"),n=require("http"),r=require("https");e={get:function(t,e){var n=i.parse(t);return this._getClient(n.protocol).get(t,this._wrapCallback(e)).on("error",e),this},post:function(e,n,r){var o=i.parse(e.url);o.method="POST",e.headers||(e.headers={}),e.headers["Content-Type"]||(e.headers["Content-Type"]="application/x-www-form-urlencoded"),o.headers=e.headers;var s=this._getClient(o.protocol).request(o,this._wrapCallback(r));return s.on("error",r),t.Util.isString(n)||(n=JSON.stringify(n)),s.write(n),s.end(),this},_wrapCallback:function(t){return function(e){var i=[],n=!1;e.setEncoding("utf8"),e.on("data",function(t){t instanceof Buffer&&(n=!0),i.push(t)}),e.on("end",function(){t(null,n?Buffer.concat(i).toString("utf8"):i.join(""))})}},_getClient:function(t){return this._client||(this._client=t&&"https:"===t?r:n),this._client}}}else e={get:function(t,e){var i=this._getClient(e);return i.open("GET",t,!0),i.send(null),this},post:function(e,i,n){var r=this._getClient(n);if(r.open("POST",e.url,!0),e.headers||(e.headers={}),e.headers["Content-Type"]||(e.headers["Content-Type"]="application/x-www-form-urlencoded"),"setRequestHeader"in r)for(var o in e.headers)e.headers.hasOwnProperty(o)&&r.setRequestHeader(o,e.headers[o]);return t.Util.isString(i)||(i=JSON.stringify(i)),r.send(i),this},_wrapCallback:function(t,e){var i=this;return function(){if(void 0!==t.withCredentials||i._isIE8())e(null,t.responseText);else if(4===t.readyState)if(200===t.status)e(null,t.responseText);else{if(0===t.status)return;e(null,'{"success":false,"error":"Status:'+t.status+","+t.statusText+'"}')}}},_isIE8:function(){return t.Browser.ie&&8===document.documentMode},_getClient:function(t){var e;if(this._isIE8())try{e=new XDomainRequest}catch(t){}else try{e=new XMLHttpRequest}catch(t){try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(t){try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(t){}}}return this._isIE8()||void 0!==e.withCredentials?e.onload=this._wrapCallback(e,t):e.onreadystatechange=this._wrapCallback(e,t),e}};e.getResource=function(t,e){return this.get(t,e)},e.getJSON=function(i,n){var r=function(e,i){n(e,i?t.Util.parseJSON(i):null)};return e.getResource(i,r)},t.Util.getJSON=e.getJSON,t.Ajax=e}(),function(){function e(t){return new Function("f","var p = (f && f.properties || {}); return "+i(t))}function i(t){if(!t)return"true";var e=t[0];return t.length<=1?"any"===e?"false":"true":"("+("=="===e?r(t[1],t[2],"===",!1):"!="===e?r(t[1],t[2],"!==",!1):"<"===e||">"===e||"<="===e||">="===e?r(t[1],t[2],e,!0):"any"===e?o(t.slice(1),"||"):"all"===e?o(t.slice(1),"&&"):"none"===e?h(o(t.slice(1),"||")):"in"===e?s(t[1],t.slice(2)):"!in"===e?h(s(t[1],t.slice(2))):"has"===e?a(t[1]):"!has"===e?h(a([t[1]])):"true")+")"}function n(t){return"$"===t[0]?"f."+t.substring(1):"p["+JSON.stringify(t)+"]"}function r(e,i,r,o){var s=n(e),a="$type"===e?t.Util.indexOfArray(i,u):JSON.stringify(i);return(o?"typeof "+s+"=== typeof "+a+"&&":"")+s+r+a}function o(e,n){return t.Util.mapArray(e,i).join(n)}function s(e,i){"$type"===e&&(i=t.Util.mapArray(i,function(e){return t.Util.indexOfArray(e,u)}));var r=JSON.stringify(i.sort(l)),o=n(e);return i.length<=200?"maptalks.Util.indexOfArray("+o+", "+r+") !== -1":"function(v, a, i, j) {while (i <= j) { var m = (i + j) >> 1;    if (a[m] === v) return true; if (a[m] > v) j = m - 1; else i = m + 1;}return false; }("+o+", "+r+",0,"+(i.length-1)+")"}function a(t){return JSON.stringify(t)+" in p"}function h(t){return"!("+t+")"}function l(t,e){return t<e?-1:t>e?1:0}var u=["Unknown","Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"];t.Util.createFilter=e,t.Util.getFilterFeature=function(e){var i=e._toJSON(),n=i.feature;return n.type=t.Util.indexOfArray(n.geometry.type,u),n.subType=i.subType,n}}(),function(){function e(t,o){var s;if(h(t)){var a,l="object"==typeof t.stops[0][0],u=l||void 0!==t.property,c=l||!u,d=t.type||o||"exponential";if("exponential"===d)a=r;else if("interval"===d)a=n;else{if("categorical"!==d)throw new Error('Unknown function type "'+d+'"');a=i}if(l){for(var m={},f=[],g=0;g<t.stops.length;g++){var p=t.stops[g];void 0===m[p[0].zoom]&&(m[p[0].zoom]={zoom:p[0].zoom,type:t.type,property:t.property,stops:[]}),m[p[0].zoom].stops.push([p[0].value,p[1]])}for(var _ in m)f.push([m[_].zoom,e(m[_])]);s=function(e,i){return r({stops:f,base:t.base},e)(e,i)},s.isFeatureConstant=!1,s.isZoomConstant=!1}else c?(s=function(e){return a(t,e)},s.isFeatureConstant=!0,s.isZoomConstant=!1):(s=function(e,i){return a(t,i[t.property])},s.isFeatureConstant=!1,s.isZoomConstant=!0)}else s=function(){return t},s.isFeatureConstant=!0,s.isZoomConstant=!0;return s}function i(t,e){for(var i=0;i<t.stops.length;i++)if(e===t.stops[i][0])return t.stops[i][1];return t.stops[0][1]}function n(t,e){for(var i=0;i<t.stops.length&&!(e<t.stops[i][0]);i++);return t.stops[Math.max(i-1,0)][1]}function r(t,e){for(var i=void 0!==t.base?t.base:1,n=0;;){if(n>=t.stops.length)break;if(e<=t.stops[n][0])break;n++}return 0===n?t.stops[n][1]:n===t.stops.length?t.stops[n-1][1]:o(e,i,t.stops[n-1][0],t.stops[n][0],t.stops[n-1][1],t.stops[n][1])}function o(t,e,i,n,r,h){return"function"==typeof r?function(){return o(t,e,i,n,r.apply(void 0,arguments),h.apply(void 0,arguments))}:r.length?a(t,e,i,n,r,h):s(t,e,i,n,r,h)}function s(t,e,i,n,r,o){var s,a=n-i,h=t-i;return s=1===e?h/a:(Math.pow(e,h)-1)/(Math.pow(e,a)-1),r*(1-s)+o*s}function a(t,e,i,n,r,o){for(var a=[],h=0;h<r.length;h++)a[h]=s(t,e,i,n,r[h],o[h]);return a}function h(t){return t&&"object"==typeof t&&t.stops}t.Util.isFunctionDefinition=h,t.Util.interpolated=function(t){return e(t,"exponential")},t.Util["piecewise-constant"]=function(t){return e(t,"interval")},t.Util.loadFunctionTypes=function(e,i){if(!e)return null;var n=!1;if(t.Util.isArray(e)){for(var r,o=[],s=0;s<e.length;s++)r=t.Util.loadFunctionTypes(e[s],i),r?(o.push(r),n=!0):o.push(e[s]);return n?o:null}var a,h={},l=[];for(a in e)e.hasOwnProperty(a)&&l.push(a);for(var s=0,u=l.length;s<u;s++)a=l[s],t.Util.isFunctionDefinition(e[a])?(n=!0,h["_"+a]=e[a],function(e){Object.defineProperty(h,e,{get:function(){return this["__fn_"+e]||(this["__fn_"+e]=t.Util.interpolated(this["_"+e])),this["__fn_"+e].apply(this,i())},set:function(t){this["_"+e]=t},configurable:!0,enumerable:!0})}(a)):h[a]=e[a];return n?h:null},t.Util.getFunctionTypeResources=function(t){if(!t||!t.stops)return null;for(var e=[],i=0,n=t.stops.length;i<n;i++)e.push(t.stops[i][1]);return e}}(),"undefined"!=typeof Promise?t.Promise=Promise:function(t){function e(t){if(t){var e=this;t(function(t){e.resolve(t)},function(t){e.reject(t)})}}function i(t,e){if("function"==typeof t.y)try{var i=t.y.call(r,e);t.p.resolve(i)}catch(e){t.p.reject(e)}else t.p.resolve(e)}function n(t,e){if("function"==typeof t.n)try{var i=t.n.call(r,e);t.p.resolve(i)}catch(e){t.p.reject(e)}else t.p.reject(e)}var r,o=function(){function t(){for(;e.length-i;)e[i](),e[i++]=r,i==n&&(e.splice(0,n),i=0)}var e=[],i=0,n=1024,o=function(){if("undefined"!=typeof MutationObserver){var e=document.createElement("div");return new MutationObserver(t).observe(e,{attributes:!0}),function(){e.setAttribute("a",0)}}return"undefined"!=typeof setImmediate?function(){setImmediate(t)}:function(){setTimeout(t,0)}}();return function(t){e.push(t),e.length-i==1&&o()}}();e.prototype={resolve:function(t){if(void 0===this.state){if(t===this)return this.reject(new TypeError("Attempt to resolve promise with self"));var e=this;if(t&&("function"==typeof t||"object"==typeof t))try{var n=!0,r=t.then;if("function"==typeof r)return void r.call(t,function(t){n&&(n=!1,e.resolve(t))},function(t){n&&(n=!1,e.reject(t))})}catch(t){return void(n&&this.reject(t))}this.state="fulfilled",this.v=t,e.c&&o(function(){for(var n=0,r=e.c.length;n<r;n++)i(e.c[n],t)})}},reject:function(t){if(void 0===this.state){this.state="rejected",this.v=t;var i=this.c;i?o(function(){for(var e=0,r=i.length;e<r;e++)n(i[e],t)}):e.suppressUncaughtRejectionError||console.log("You upset Zousan. Please catch rejections: ",t,t.stack)}},then:function(t,r){var s=new e,a={y:t,n:r,p:s};if(void 0===this.state)this.c?this.c.push(a):this.c=[a];else{var h=this.state,l=this.v;o(function(){"fulfilled"===h?i(a,l):n(a,l)})}return s},catch:function(t){return this.then(null,t)},finally:function(t){return this.then(t,t)},timeout:function(t,i){i=i||"Timeout";var n=this;return new e(function(e,r){setTimeout(function(){r(Error(i))},t),n.then(function(t){e(t)},function(t){r(t)})})}},e.resolve=function(t){var i=new e;return i.resolve(t),i},e.reject=function(t){var i=new e;return i.reject(t),i},e.all=function(t){for(var i=[],n=0,r=new e,o=0;o<t.length;o++)!function(o,s){"function"!=typeof o.then&&(o=e.resolve(o)),o.then(function(e){i[s]=e,++n==t.length&&r.resolve(i)},function(t){r.reject(t)})}(t[o],o);return t.length||r.resolve(i),r},t.Promise=e}(t),t.Coordinate=function(e,i){if(t.Util.isNil(e)||t.Util.isNil(i)?t.Util.isArray(e)?(this.x=+e[0],this.y=+e[1]):t.Util.isNil(e.x)||t.Util.isNil(e.y)||(this.x=+e.x,this.y=+e.y):(this.x=+e,this.y=+i),this.isNaN())throw new Error("coordinate is NaN")},t.Util.extend(t.Coordinate.prototype,{copy:function(){return new t.Coordinate(this.x,this.y)},_add:function(e,i){return e instanceof t.Coordinate?(this.x+=e.x,this.y+=e.y):(this.x+=e,this.y+=i),this},add:function(e,i){var n,r;return e instanceof t.Coordinate?(n=this.x+e.x,r=this.y+e.y):(n=this.x+e,r=this.y+i),new t.Coordinate(n,r)},_substract:function(e,i){return e instanceof t.Coordinate?(this.x-=e.x,this.y-=e.y):(this.x-=e,this.y-=i),this},substract:function(e,i){var n,r;return e instanceof t.Coordinate?(n=this.x-e.x,r=this.y-e.y):(n=this.x-e,r=this.y-i),new t.Coordinate(n,r)},multi:function(e){return new t.Coordinate(this.x*e,this.y*e)},_multi:function(t){return this.x*=t,this.y*=t,this},equals:function(e){return!!t.Util.isCoordinate(e)&&(this.x===e.x&&this.y===e.y)},isNaN:function(){return isNaN(this.x)||isNaN(this.y)},toArray:function(){return[this.x,this.y]},toJSON:function(){return{x:this.x,y:this.y}}}),t.Point=function(e,i){if(t.Util.isNil(e)||t.Util.isNil(i)?t.Util.isNil(e.x)||t.Util.isNil(e.y)?t.Util.isArrayHasData(e)&&(this.x=e[0],this.y=e[1]):(this.x=e.x,this.y=e.y):(this.x=e,this.y=i),this.isNaN())throw new Error("point is NaN")},t.Util.extend(t.Point.prototype,{abs:function(){return new t.Point(Math.abs(this.x),Math.abs(this.y))},_abs:function(){return this.x=Math.abs(this.x),this.y=Math.abs(this.y),this},copy:function(){return new t.Point(this.x,this.y)},_round:function(){return this.x=t.Util.round(this.x),this.y=t.Util.round(this.y),this},round:function(){return new t.Point(t.Util.round(this.x),t.Util.round(this.y))},equals:function(t){return this.x===t.x&&this.y===t.y},distanceTo:function(t){var e=t.x-this.x,i=t.y-this.y;return Math.sqrt(e*e+i*i)},_add:function(e,i){return e instanceof t.Point?(this.x+=e.x,this.y+=e.y):(this.x+=e,this.y+=i),this},add:function(e,i){var n,r;return e instanceof t.Point?(n=this.x+e.x,r=this.y+e.y):(n=this.x+e,r=this.y+i),new t.Point(n,r)},_substract:function(e,i){return e instanceof t.Point?(this.x-=e.x,this.y-=e.y):(this.x-=e,this.y-=i),this},substract:function(e,i){var n,r;return e instanceof t.Point?(n=this.x-e.x,r=this.y-e.y):(n=this.x-e,r=this.y-i),new t.Point(n,r)},_multi:function(t){return this.x*=t,this.y*=t,this},multi:function(e){return new t.Point(this.x*e,this.y*e)},div:function(t){return this.multi(1/t)},_div:function(t){return this._multi(1/t)},isNaN:function(){return isNaN(this.x)||isNaN(this.y)},toArray:function(){return[this.x,this.y]},toJSON:function(){return{x:this.x,y:this.y}},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},unit:function(){return this.copy()._unit()},_unit:function(){return this._div(this.mag()),this},perp:function(){return this.copy()._perp()},_perp:function(){var t=this.y;return this.y=this.x,this.x=-t,this}}),t.Size=function(t,e){this.width=t,this.height=e},t.Util.extend(t.Size.prototype,{copy:function(){return new t.Size(this.width,this.height)},add:function(e){return new t.Size(this.width+e.width,this.height+e.height)},equals:function(t){return this.width===t.width&&this.height===t.height},multi:function(e){return new t.Size(this.width*e,this.height*e)},_multi:function(t){return this.width*=t,this.height*=t,this},_round:function(){return this.width=t.Util.round(this.width),this.height=t.Util.round(this.height),this},toPoint:function(){return new t.Point(this.width,this.height)},toArray:function(){return[this.width,this.height]},toJSON:function(){return{width:this.width,height:this.height}}}),t.CRS=function(t,e){this.type=t,this.properties=e},t.CRS.createProj4=function(e){return new t.CRS("proj4",{proj:e})},t.CRS.WGS84=t.CRS.createProj4("+proj=longlat +datum=WGS84 +no_defs"),t.CRS.EPSG4326=t.CRS.WGS84,t.CRS.EPSG3857=t.CRS.createProj4("+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs"),t.CRS.IDENTITY=t.CRS.createProj4("+proj=identity +no_defs"),t.CRS.CGCS2000=t.CRS.createProj4("+proj=longlat +datum=CGCS2000"),t.CRS.EPSG4490=t.CRS.CGCS2000,t.CRS.BD09LL=t.CRS.createProj4("+proj=longlat +datum=BD09"),t.CRS.GCJ02=t.CRS.createProj4("+proj=longlat +datum=GCJ02"),t.Extent=function(e,i,n,r){this._clazz=t.Coordinate,this._initialize(e,i,n,r)},t.Util.extend(t.Extent.prototype,{_initialize:function(e,i,n,r){if(this.xmin=null,this.xmax=null,this.ymin=null,this.ymax=null,!t.Util.isNil(e))return t.Util.isNumber(e)&&t.Util.isNumber(i)&&t.Util.isNumber(n)&&t.Util.isNumber(r)?(this.xmin=Math.min(e,n),this.ymin=Math.min(i,r),this.xmax=Math.max(e,n),void(this.ymax=Math.max(i,r))):void(t.Util.isNumber(e.x)&&t.Util.isNumber(i.x)&&t.Util.isNumber(e.y)&&t.Util.isNumber(i.y)?(e.x>i.x?(this.xmin=i.x,this.xmax=e.x):(this.xmin=e.x,this.xmax=i.x),e.y>i.y?(this.ymin=i.y,this.ymax=e.y):(this.ymin=e.y,this.ymax=i.y)):t.Util.isNumber(e.xmin)&&t.Util.isNumber(e.xmax)&&t.Util.isNumber(e.ymin)&&t.Util.isNumber(e.ymax)&&(this.xmin=e.xmin,this.ymin=e.ymin,this.xmax=e.xmax,this.ymax=e.ymax))},_add:function(t){return this.xmin+=t.x,this.ymin+=t.y,this.xmax+=t.x,this.ymax+=t.y,this},add:function(t){return new this.constructor(this.xmin+t.x,this.ymin+t.y,this.xmax+t.x,this.ymax+t.y)},_substract:function(t){return this.xmin-=t.x,this.ymin-=t.y,this.xmax-=t.x,this.ymax-=t.y,this},substract:function(t){return new this.constructor(this.xmin-t.x,this.ymin-t.y,this.xmax-t.x,this.ymax-t.y)},round:function(){return new this.constructor(t.Util.round(this.xmin),t.Util.round(this.ymin),t.Util.round(this.xmax),t.Util.round(this.ymax))},_round:function(){return this.xmin=t.Util.round(this.xmin),this.ymin=t.Util.round(this.ymin),this.xmax=t.Util.round(this.xmax),this.ymax=t.Util.round(this.ymax),this},getMin:function(){return new this._clazz(this.xmin,this.ymin)},getMax:function(){return new this._clazz(this.xmax,this.ymax)},getCenter:function(){return new this._clazz((this.xmin+this.xmax)/2,(this.ymin+this.ymax)/2)},isValid:function(){return t.Util.isNumber(this.xmin)&&t.Util.isNumber(this.ymin)&&t.Util.isNumber(this.xmax)&&t.Util.isNumber(this.ymax)},equals:function(t){return this.xmin===t.xmin&&this.xmax===t.xmax&&this.ymin===t.ymin&&this.ymax===t.ymax},intersects:function(t){var e=Math.max(this.xmin,t.xmin),i=Math.max(this.ymin,t.ymin),n=Math.min(this.xmax,t.xmax),r=Math.min(this.ymax,t.ymax);return!(e>n||i>r)},contains:function(t){return t.x>=this.xmin&&t.x<=this.xmax&&t.y>=this.ymin&&t.y<=this.ymax},getWidth:function(){return this.xmax-this.xmin},getHeight:function(){return this.ymax-this.ymin},__combine:function(e){e instanceof t.Point&&(e={xmin:e.x,xmax:e.x,ymin:e.y,ymax:e.y});var i=this.xmin;t.Util.isNumber(i)?t.Util.isNumber(e.xmin)&&i>e.xmin&&(i=e.xmin):i=e.xmin;var n=this.xmax;t.Util.isNumber(n)?t.Util.isNumber(e.xmax)&&n<e.xmax&&(n=e.xmax):n=e.xmax;var r=this.ymin;t.Util.isNumber(r)?t.Util.isNumber(e.ymin)&&r>e.ymin&&(r=e.ymin):r=e.ymin;var o=this.ymax;return t.Util.isNumber(o)?t.Util.isNumber(e.ymax)&&o<e.ymax&&(o=e.ymax):o=e.ymax,[i,r,n,o]},_combine:function(t){if(!t)return this;var e=this.__combine(t);return this.xmin=e[0],this.ymin=e[1],this.xmax=e[2],this.ymax=e[3],this},combine:function(t){if(!t)return this;var e=this.__combine(t);return new this.constructor(e[0],e[1],e[2],e[3])},intersection:function(t){return this.intersects(t)?new this.constructor(Math.max(this.xmin,t.xmin),Math.max(this.ymin,t.ymin),Math.min(this.xmax,t.xmax),Math.min(this.ymax,t.ymax)):null},expand:function(e){return e instanceof t.Size?new this.constructor(this.xmin-e.width,this.ymin-e.height,this.xmax+e.width,this.ymax+e.height):new this.constructor(this.xmin-e,this.ymin-e,this.xmax+e,this.ymax+e)},_expand:function(e){return e instanceof t.Size?(this.xmin-=e.width,this.ymin-=e.height,this.xmax+=e.width,this.ymax+=e.height):(this.xmin-=e,this.ymin-=e,this.xmax+=e,this.ymax+=e),this},toJSON:function(){return{xmin:this.xmin,ymin:this.ymin,xmax:this.xmax,ymax:this.ymax}},toArray:function(){var t=this.xmin,e=this.ymin,i=this.xmax,n=this.ymax;return[new this._clazz([t,n]),new this._clazz([i,n]),new this._clazz([i,e]),new this._clazz([t,e]),new this._clazz([t,n])]},copy:function(){return new this.constructor(this.xmin,this.ymin,this.xmax,this.ymax)}}),t.PointExtent=function(e,i,n,r){this._clazz=t.Point,this._initialize(e,i,n,r)},t.Util.extend(t.PointExtent.prototype,t.Extent.prototype,{getSize:function(){return new t.Size(this.getWidth(),this.getHeight())}}),t.Transformation=function(t){this.matrix=t},t.Util.extend(t.Transformation.prototype,{transform:function(e,i){return new t.Point(this.matrix[0]*(e.x-this.matrix[2])/i,this.matrix[1]*(e.y-this.matrix[3])/i)},untransform:function(e,i){return new t.Coordinate(e.x*i/this.matrix[0]+this.matrix[2],e.y*i/this.matrix[1]+this.matrix[3])}}),t.measurer={},t.MeasurerUtil={getInstance:function(e){if(!e)return t.MeasurerUtil.DEFAULT;for(var i in t.measurer)if(t.measurer.hasOwnProperty(i)){var n=t.measurer[i].measure;if(!n)continue;if(e.toLowerCase()===n.toLowerCase())return t.measurer[i]}return null},isSphere:function(e){return!t.Util.isNil(e.sphere)},DEFAULT:t.measurer.WGS84Sphere},t.measurer.Sphere=function(t){this.radius=t},t.Util.extend(t.measurer.Sphere.prototype,{rad:function(t){return t*Math.PI/180},measureLength:function(t,e){if(!t||!e)return 0;var i=this.rad(t.y),n=this.rad(e.y),r=i-n,o=this.rad(t.x)-this.rad(e.x);return i=2*Math.asin(Math.sqrt(Math.pow(Math.sin(r/2),2)+Math.cos(i)*Math.cos(n)*Math.pow(Math.sin(o/2),2))),i*=this.radius,Math.round(1e5*i)/1e5},measureArea:function(t){var e=this.radius*Math.PI/180,i=0,n=t,r=n.length;if(r<3)return 0;for(var o=0;o<r-1;o++){var s=n[o],a=n[o+1];i+=s.x*e*Math.cos(s.y*Math.PI/180)*a.y*e-a.x*e*Math.cos(a.y*Math.PI/180)*s.y*e}return r=n[o],n=n[0],i+=r.x*e*Math.cos(r.y*Math.PI/180)*n.y*e-n.x*e*Math.cos(n.y*Math.PI/180)*r.y*e,.5*Math.abs(i)},locate:function(e,i,n){if(!e)return null;if(i||(i=0),n||(n=0),!i&&!n)return e;var r=Math.abs(i),o=Math.abs(n),s=this.rad(e.y),a=this.rad(e.x);return s+=2*Math.sin(o/(2*this.radius))*(n>0?1:-1),a+=2*Math.sqrt(Math.pow(Math.sin(r/(2*this.radius)),2)/Math.pow(Math.cos(s),2))*(i>0?1:-1),new t.Coordinate(180*a/Math.PI,180*s/Math.PI)}}),t.measurer.WGS84Sphere={measure:"EPSG:4326",sphere:new t.measurer.Sphere(6378137),measureLength:function(){return this.sphere.measureLength.apply(this.sphere,arguments)},measureArea:function(){return this.sphere.measureArea.apply(this.sphere,arguments)},locate:function(){return this.sphere.locate.apply(this.sphere,arguments)}},t.measurer.BaiduSphere={measure:"BAIDU",sphere:new t.measurer.Sphere(6370996.81),measureLength:function(){return this.sphere.measureLength.apply(this.sphere,arguments)},measureArea:function(){return this.sphere.measureArea.apply(this.sphere,arguments)},locate:function(){return this.sphere.locate.apply(this.sphere,arguments)}},t.measurer.Identity={measure:"IDENTITY",measureLength:function(t,e){if(!t||!e)return 0;try{return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))}catch(t){return 0}},measureArea:function(e){if(!t.Util.isArrayHasData(e))return 0;for(var i=0,n=0,r=e.length;n<r;n++){var o=e[n],s=null;s=n===r-1?e[0]:e[n+1],i+=o.x*s.y-o.y*s.x}return Math.abs(i/2)},locate:function(e,i,n){return e?(i||(i=0),n||(n=0),i||n?new t.Coordinate(e.x+i,e.y+n):e):null}},t.projection={},t.projection.Common={project:function(){},unproject:function(){},projectCoords:function(e){return t.Util.mapArrayRecursively(e,this.project,this)},unprojectCoords:function(e){return t.Util.mapArrayRecursively(e,this.unproject,this)}},t.projection.EPSG3857=t.Util.extend({},t.projection.Common,{code:"EPSG:3857",rad:Math.PI/180,metersPerDegree:20037508.34/180,maxLatitude:85.0511287798,project:function(e){var i,n=this.rad,r=this.metersPerDegree,o=this.maxLatitude,s=e.x,a=Math.max(Math.min(o,e.y),-o);return i=0===a?0:Math.log(Math.tan((90+a)*n/2))/n,new t.Coordinate(s*r,i*r)},unproject:function(e){var i,n=e.x,r=e.y,o=this.rad,s=this.metersPerDegree;return 0===r?i=0:(i=r/s,i=(2*Math.atan(Math.exp(i*o))-Math.PI/2)/o),new t.Coordinate(n/s,i)}},t.measurer.WGS84Sphere),t.projection.DEFAULT=t.projection.EPSG3857,t.projection.EPSG4326=t.Util.extend({},t.projection.Common,{code:"EPSG:4326",project:function(e){return new t.Coordinate(e)},unproject:function(e){return new t.Coordinate(e)}},t.measurer.WGS84Sphere),t.projection.BAIDU=t.Util.extend({},t.projection.Common,{code:"BAIDU",project:function(t){return this.convertLL2MC(t)},unproject:function(t){return this.convertMC2LL(t)}},t.measurer.BaiduSphere,{EARTHRADIUS:6370996.81,MCBAND:[12890594.86,8362377.87,5591021,3481989.83,1678043.12,0],LLBAND:[75,60,45,30,15,0],MC2LL:[[1.410526172116255e-8,898305509648872e-20,-1.9939833816331,200.9824383106796,-187.2403703815547,91.6087516669843,-23.38765649603339,2.57121317296198,-.03801003308653,17337981.2],[-7.435856389565537e-9,8983055097726239e-21,-.78625201886289,96.32687599759846,-1.85204757529826,-59.36935905485877,47.40033549296737,-16.50741931063887,2.28786674699375,10260144.86],[-3.030883460898826e-8,898305509983578e-20,.30071316287616,59.74293618442277,7.357984074871,-25.38371002664745,13.45380521110908,-3.29883767235584,.32710905363475,6856817.37],[-1.981981304930552e-8,8983055099779535e-21,.03278182852591,40.31678527705744,.65659298677277,-4.44255534477492,.85341911805263,.12923347998204,-.04625736007561,4482777.06],[3.09191371068437e-9,8983055096812155e-21,6995724062e-14,23.10934304144901,-.00023663490511,-.6321817810242,-.00663494467273,.03430082397953,-.00466043876332,2555164.4],[2.890871144776878e-9,8983055095805407e-21,-3.068298e-8,7.47137025468032,-353937994e-14,-.02145144861037,-1234426596e-14,.00010322952773,-323890364e-14,826088.5]],LL2MC:[[-.0015702102444,111320.7020616939,0x60e374c3105a3,-0x24bb4115e2e164,0x5cc55543bb0ae8,-0x7ce070193f3784,0x5e7ca61ddf8150,-0x261a578d8b24d0,0x665d60f3742ca,82.5],[.0008277824516172526,111320.7020463578,647795574.6671607,-4082003173.641316,10774905663.51142,-15171875531.51559,12053065338.62167,-5124939663.577472,913311935.9512032,67.5],[.00337398766765,111320.7020202162,4481351.045890365,-23393751.19931662,79682215.47186455,-115964993.2797253,97236711.15602145,-43661946.33752821,8477230.501135234,52.5],[.00220636496208,111320.7020209128,51751.86112841131,3796837.749470245,992013.7397791013,-1221952.21711287,1340652.697009075,-620943.6990984312,144416.9293806241,37.5],[-.0003441963504368392,111320.7020576856,278.2353980772752,2485758.690035394,6070.750963243378,54821.18345352118,9540.606633304236,-2710.55326746645,1405.483844121726,22.5],[-.0003218135878613132,111320.7020701615,.00369383431289,823725.6402795718,.46104986909093,2351.343141331292,1.58060784298199,8.77738589078284,.37238884252424,7.45]],convertMC2LL:function(e){var i,n;i={x:Math.abs(e.x),y:Math.abs(e.y)};for(var r=0,o=this.MCBAND.length;r<o;r++)if(i.y>=this.MCBAND[r]){n=this.MC2LL[r];break}var s=this.convertor(e,n);return new t.Coordinate(s.x.toFixed(6),s.y.toFixed(6))},convertLL2MC:function(e){var i,n,r,o;for(e.x=this.getLoop(e.x,-180,180),e.y=this.getRange(e.y,-74,74),i=new t.Coordinate(e.x,e.y),r=0,o=this.LLBAND.length;r<o;r++)if(i.y>=this.LLBAND[r]){n=this.LL2MC[r];break}if(!n)for(r=this.LLBAND.length-1;r>=0;r--)if(i.y<=-this.LLBAND[r]){n=this.LL2MC[r];break}var s=this.convertor(e,n);return new t.Coordinate(s.x.toFixed(2),s.y.toFixed(2))},convertor:function(e,i){if(!e||!i)return null;var n=i[0]+i[1]*Math.abs(e.x),r=Math.abs(e.y)/i[9],o=i[2]+i[3]*r+i[4]*r*r+i[5]*r*r*r+i[6]*r*r*r*r+i[7]*r*r*r*r*r+i[8]*r*r*r*r*r*r;return n*=e.x<0?-1:1,o*=e.y<0?-1:1,new t.Coordinate(n,o)},toRadians:function(t){return Math.PI*t/180},toDegrees:function(t){return 180*t/Math.PI},getRange:function(t,e,i){return null!=e&&(t=Math.max(t,e)),null!=i&&(t=Math.min(t,i)),t},getLoop:function(t,e,i){for(;t>i;)t-=i-e;for(;t<e;)t+=i-e;return t}}),t.projection.IDENTITY=t.Util.extend({},t.projection.Common,{code:"IDENTITY",project:function(t){return t.copy()},unproject:function(t){return t.copy()}},t.measurer.Identity),t.GeoUtil={distanceToSegment:function(t,e,i){var n=t.x,r=t.y,o=e.x,s=e.y,a=i.x,h=i.y,l=(a-o)*(n-o)+(h-s)*(r-s);if(l<=0)return Math.sqrt((n-o)*(n-o)+(r-s)*(r-s));var u=(a-o)*(a-o)+(h-s)*(h-s);if(l>=u)return Math.sqrt((n-a)*(n-a)+(r-h)*(r-h));var c=l/u,d=o+(a-o)*c,m=s+(h-s)*c;return Math.sqrt((n-d)*(n-d)+(r-m)*(r-m))},pointInsidePolygon:function(t,e){var i,n,r,o,s=e.length,a=!1;for(i=0,n=s-1;i<s;n=i++)r=e[i],o=e[n],r.y>t.y!=o.y>t.y&&t.x<(o.x-r.x)*(t.y-r.y)/(o.y-r.y)+r.x&&(a=!a);return a},_computeLength:function(t,e){for(var i=0,n=0,r=t.length;n<r-1;n++)i+=e.measureLength(t[n],t[n+1]);return i},_computeArea:function(t,e){return e.measureArea(t)}},t.Simplify={getSqDist:function(t,e){var i=t.x-e.x,n=t.y-e.y;return i*i+n*n},getSqSegDist:function(t,e,i){var n=e.x,r=e.y,o=i.x-n,s=i.y-r;if(0!==o||0!==s){var a=((t.x-n)*o+(t.y-r)*s)/(o*o+s*s);a>1?(n=i.x,r=i.y):a>0&&(n+=o*a,r+=s*a)}return o=t.x-n,s=t.y-r,o*o+s*s},simplifyRadialDist:function(t,e){for(var i,n=t[0],r=[n],o=1,s=t.length;o<s;o++)i=t[o],this.getSqDist(i,n)>e&&(r.push(i),n=i);return n!==i&&r.push(i),r},simplifyDPStep:function(t,e,i,n,r){for(var o,s=n,a=e+1;a<i;a++){var h=this.getSqSegDist(t[a],t[e],t[i]);h>s&&(o=a,s=h)}s>n&&(o-e>1&&this.simplifyDPStep(t,e,o,n,r),r.push(t[o]),i-o>1&&this.simplifyDPStep(t,o,i,n,r))},simplifyDouglasPeucker:function(t,e){var i=t.length-1,n=[t[0]];return this.simplifyDPStep(t,0,i,e,n),n.push(t[i]),n},simplify:function(t,e,i){if(t.length<=2)return t;var n=void 0!==e?e*e:1;return t=i?t:this.simplifyRadialDist(t,n),t=this.simplifyDouglasPeucker(t,n)}},t.Handler=t.Class.extend({includes:t.Eventable,initialize:function(t){this.target=t},enable:function(){
return this._enabled?this:(this._enabled=!0,this.addHooks(),this)},disable:function(){return this._enabled?(this._enabled=!1,this.removeHooks(),this):this},enabled:function(){return!!this._enabled},remove:function(){this.disable(),delete this.target,delete this.dom}}),t.Handlerable={addHandler:function(t,e){if(!e)return this;if(this._handlers||(this._handlers=[]),this[t])return this[t].enable(),this;var i=this[t]=new e(this);return this._handlers.push(i),this.options[t]&&i.enable(),this},removeHandler:function(e){if(!e)return this;var i=this[e];if(i){var n=t.Util.indexOfArray(i,this._handlers);n>=0&&this._handlers.splice(n,1),this[e].remove(),delete this[e]}return this},_clearHandlers:function(){for(var t=0,e=this._handlers.length;t<e;t++)this._handlers[t].remove();this._handlers=[]}},t.Handler.Drag=t.Handler.extend({START:t.Browser.touch?["touchstart","mousedown"]:["mousedown"],END:{mousedown:"mouseup",touchstart:"touchend",pointerdown:"touchend",MSPointerDown:"touchend"},MOVE:{mousedown:"mousemove",touchstart:"touchmove",pointerdown:"touchmove",MSPointerDown:"touchmove"},initialize:function(t,e){this.dom=t,this.options=e},enable:function(){this.dom&&t.DomUtil.on(this.dom,this.START.join(" "),this.onMouseDown,this)},disable:function(){this.dom&&t.DomUtil.off(this.dom,this.START.join(" "),this.onMouseDown)},onMouseDown:function(e){if(!(t.Util.isNumber(e.button)&&2===e.button||this.options&&this.options.cancelOn&&this.options.cancelOn(e)===!0)){var i=this.dom;i.setCapture?i.setCapture():window.captureEvents&&window.captureEvents(window.Event.MOUSEMOVE|window.Event.MOUSEUP),i.ondragstart=function(){return!1},this.moved=!1;var n=e.touches?e.touches[0]:e;this.startPos=new t.Point(n.clientX,n.clientY),t.DomUtil.on(document,this.MOVE[e.type],this.onMouseMove,this).on(document,this.END[e.type],this.onMouseUp,this),this.fire("mousedown",{domEvent:e,mousePos:new t.Point(n.clientX,n.clientY)})}},onMouseMove:function(e){if(!(e.touches&&e.touches.length>1)){var i=e.touches?e.touches[0]:e,n=new t.Point(i.clientX,i.clientY),r=n.substract(this.startPos);(r.x||r.y)&&(this.moved?this.fire("dragging",{domEvent:e,mousePos:new t.Point(i.clientX,i.clientY)}):(this.fire("dragstart",{domEvent:e,mousePos:this.startPos.copy()}),this.moved=!0))}},onMouseUp:function(e){var i=this.dom,n=e.changedTouches?e.changedTouches[0]:e;for(var r in this.MOVE)t.DomUtil.off(document,this.MOVE[r],this.onMouseMove,this).off(document,this.END[r],this.onMouseUp,this);i.releaseCapture?i.releaseCapture():window.captureEvents&&window.captureEvents(window.Event.MOUSEMOVE|window.Event.MOUSEUP);var o={domEvent:e};t.Util.isNumber(n.clientX)&&(o.mousePos=new t.Point(parseInt(n.clientX,0),parseInt(n.clientY,0))),this.moved&&this.fire("dragend",o),this.fire("mouseup",o)}}),t.MapTool=t.Class.extend({includes:[t.Eventable],addTo:function(t){if(!t)return this;this._map=t;var e="_tool"+this.name;return t[e]&&t[e].disable(),this.onAdd&&this.onAdd(),this.enable(),t[e]=this,this._fireEvent("add"),this},getMap:function(){return this._map},enable:function(){return!this._map||this._enabled?this:(this._enabled=!0,this._switchEvents("off"),this._registerEvents(),this.onEnable&&this.onEnable(),this._fireEvent("enable"),this)},disable:function(){return this._enabled&&this._map?(this._enabled=!1,this._switchEvents("off"),this.onDisable&&this.onDisable(),this._fireEvent("disable"),this):this},isEnabled:function(){return!!this._enabled},_registerEvents:function(){this._switchEvents("on")},_switchEvents:function(t){var e=this.getEvents();e&&this._map[t](e,this)},_fireEvent:function(t,e){e||(e={}),this.fire(t,e)}}),t.DrawTool=t.MapTool.extend({options:{symbol:{lineColor:"#000",lineWidth:2,lineOpacity:1,polygonFill:"#fff",polygonOpacity:.3},mode:null,once:!1},initialize:function(e){t.Util.setOptions(this,e),this._checkMode()},getMode:function(){return this.options.mode?this.options.mode.toLowerCase():null},setMode:function(t){return this._geometry&&(this._geometry.remove(),delete this._geometry),this._clearStage(),this._switchEvents("off"),this.options.mode=t,this._checkMode(),this.isEnabled()&&this._switchEvents("on"),this},getSymbol:function(){var e=this.options.symbol;return e?t.Util.extendSymbol(e):t.Util.extendSymbol(this.options.symbol)},setSymbol:function(t){return t?(this.options.symbol=t,this._geometry&&this._geometry.setSymbol(t),this):this},onAdd:function(){this._checkMode()},onEnable:function(){var t=this.getMap();return this._mapDraggable=t.options.draggable,this._mapDoubleClickZoom=t.options.doubleClickZoom,this._autoBorderPanning=t.options.autoBorderPanning,t.config({autoBorderPanning:!0,draggable:!1,doubleClickZoom:!1}),this._drawToolLayer=this._getDrawLayer(),this._clearStage(),this._loadResources(),this},_checkMode:function(){this._getRegisterMode()},onDisable:function(){var t=this.getMap();return t.config({autoBorderPanning:this._autoBorderPanning,draggable:this._mapDraggable,doubleClickZoom:this._mapDoubleClickZoom}),delete this._autoBorderPanning,delete this._mapDraggable,delete this._mapDoubleClickZoom,this._endDraw(),t.removeLayer(this._getDrawLayer()),this},_loadResources:function(){var e=this.getSymbol(),i=t.Util.getExternalResources(e);t.Util.isArrayHasData(i)&&this._drawToolLayer._getRenderer().loadResources(i)},_getProjection:function(){return this._map.getProjection()},_getRegisterMode:function(){var e=this.getMode(),i=t.DrawTool.getRegisterMode(e);if(!i)throw new Error(e+" is not a valid mode of maptalks.DrawTool.");return i},getEvents:function(){var t=this._getRegisterMode().action;return"clickDblclick"===t?{click:this._clickForPath,mousemove:this._mousemoveForPath,dblclick:this._dblclickForPath}:"click"===t?{click:this._clickForPoint}:"drag"===t?{mousedown:this._mousedownToDraw}:null},_addGeometryToStage:function(t){this._getDrawLayer().addGeometry(t)},_clickForPoint:function(t){var e=this._getRegisterMode();this._geometry=e.create(t.coordinate),this.options.symbol&&this.options.hasOwnProperty("symbol")&&this._geometry.setSymbol(this.options.symbol),this._endDraw()},_clickForPath:function(t){var e=this._getRegisterMode(),i=t.coordinate,n=this.getSymbol();this._geometry?(this._clickCoords.push(i),e.update(this._clickCoords,this._geometry),this._fireEvent("drawvertex",t)):(this._clickCoords=[i],this._geometry=e.create(this._clickCoords),n&&this._geometry.setSymbol(n),this._addGeometryToStage(this._geometry),this._fireEvent("drawstart",t))},_mousemoveForPath:function(t){if(this._geometry){var e=this._getMouseContainerPoint(t);if(this._isValidContainerPoint(e)){var i=t.coordinate,n=this._getRegisterMode(),r=this._clickCoords;r&&r.length>0&&i.equals(r[r.length-1])||(n.update(r.concat([i]),this._geometry),this._fireEvent("mousemove",t))}}},_dblclickForPath:function(e){if(this._geometry){var i=this._getMouseContainerPoint(e);if(this._isValidContainerPoint(i)){var n=this._getRegisterMode(),r=e.coordinate,o=this._clickCoords;if(o.push(r),!(o.length<2)){var s,a,h=[];for(s=1,a=o.length;s<a;s++)o[s].x===o[s-1].x&&o[s].y===o[s-1].y&&h.push(s);for(s=h.length-1;s>=0;s--)o.splice(h[s],1);o.length<2||this._geometry&&this._geometry instanceof t.Polygon&&o.length<3||(n.update(o,this._geometry),this._endDraw(e))}}}},_mousedownToDraw:function(t){function e(t){var e=r.getSymbol(),i=r._geometry;i?n.update(t,i):(i=n.create(t),i.setSymbol(e),r._addGeometryToStage(i),r._geometry=i)}function i(i){if(!this._geometry)return!1;var n=this._getMouseContainerPoint(i);return!!this._isValidContainerPoint(n)&&(e(i.coordinate),this._fireEvent("mousemove",t),!1)}var n=this._getRegisterMode(),r=this,o=this._getMouseContainerPoint(t);if(!this._isValidContainerPoint(o))return!1;var s=t.coordinate,a=function(n){if(!this._geometry)return!1;var r=this._getMouseContainerPoint(n);if(this._isValidContainerPoint(r)){e(n.coordinate)}return this._map.off("mousemove",i,this),this._map.off("mouseup",a,this),this._endDraw(t),!1};return this._fireEvent("drawstart",t),e(s),this._map.on("mousemove",i,this),this._map.on("mouseup",a,this),!1},_endDraw:function(t){if(this._geometry&&!this._ending){this._ending=!0;var e=this._geometry;this._clearStage(),t||(t={}),this._geometry=e,this._fireEvent("drawend",t),delete this._geometry,this.options.once&&this.disable(),delete this._ending}},_clearStage:function(){this._getDrawLayer().clear(),delete this._geometry,delete this._clickCoords},_getMouseContainerPoint:function(e){return t.DomUtil.stopPropagation(e.domEvent),e.containerPoint},_isValidContainerPoint:function(t){var e=this._map.getSize(),i=e.width,n=e.height;return!(t.x<0||t.y<0)&&!(t.x>i||t.y>n)},_getDrawLayer:function(){var e=t.internalLayerPrefix+"drawtool",i=this._map.getLayer(e);return i||(i=new t.VectorLayer(e,{enableSimplify:!1}),this._map.addLayer(i)),i},_fireEvent:function(e,i){i||(i={}),this._geometry&&(i.geometry=this._getRegisterMode().generate(this._geometry).copy()),t.MapTool.prototype._fireEvent.call(this,e,i)}}),t.DrawTool.registerMode=function(e,i){t.DrawTool._registeredMode||(t.DrawTool._registeredMode={}),t.DrawTool._registeredMode[e.toLowerCase()]=i},t.DrawTool.getRegisterMode=function(e){return t.DrawTool._registeredMode?t.DrawTool._registeredMode[e.toLowerCase()]:null},t.DrawTool.registerMode("circle",{action:"drag",geometryClass:t.Circle,create:function(e){return new t.Circle(e,0)},update:function(t,e){var i=e.getMap(),n=e.getCenter(),r=i.computeLength(n,t);e.setRadius(r)},generate:function(t){return t}}),t.DrawTool.registerMode("ellipse",{action:"drag",geometryClass:t.Ellipse,create:function(e){return t.Ellipse(e,0,0)},update:function(e,i){var n=i.getMap(),r=i.getCenter(),o=n.computeLength(r,new t.Coordinate({x:e.x,y:r.y})),s=n.computeLength(r,new t.Coordinate({x:r.x,y:e.y}));i.setWidth(2*o),i.setHeight(2*s)},generate:function(t){return t}}),t.DrawTool.registerMode("rectangle",{action:"drag",geometryClass:t.Rectangle,create:function(e){var i=t.Rectangle(e,0,0);return i._firstClick=e,i},update:function(e,i){var n=i._firstClick,r=i.getMap(),o=r.computeLength(n,new t.Coordinate(e.x,n.y)),s=r.computeLength(n,new t.Coordinate(n.x,e.y)),a=r.coordinateToContainerPoint(n),h=r.coordinateToContainerPoint(e),l=Math.min(a.x,h.x),u=Math.min(a.y,h.y);i.setCoordinates(r.containerPointToCoordinate(new t.Point(l,u))),i.setWidth(o),i.setHeight(s)},generate:function(t){return t}}),t.DrawTool.registerMode("point",{action:"click",create:function(e){return new t.Marker(e)},generate:function(t){return t}}),t.DrawTool.registerMode("polygon",{action:"clickDblclick",create:function(e){return new t.LineString(e)},update:function(e,i){var n=i.getSymbol();if(i.setCoordinates(e),e.length>=3){var r=i.getLayer();if(r){var o=r.getGeometryById("polygon");if(!o){if(o=new t.Polygon([e],{id:"polygon"}),n){var s=t.Util.extendSymbol(n,{lineOpacity:0});o.setSymbol(s)}o.addTo(r)}o.setCoordinates(e)}}},generate:function(e){return new t.Polygon(e.getCoordinates(),{symbol:e.getSymbol()})}}),t.DrawTool.registerMode("linestring",{action:"clickDblclick",create:function(e){return new t.LineString(e)},update:function(t,e){e.setCoordinates(t)},generate:function(t){return t}}),t.DrawTool.registerMode("arccurve",{action:"clickDblclick",create:function(e){return new t.ArcCurve(e)},update:function(t,e){e.setCoordinates(t)},generate:function(t){return t}}),t.DrawTool.registerMode("quadbeziercurve",{action:"clickDblclick",create:function(e){return new t.QuadBezierCurve(e)},update:function(t,e){e.setCoordinates(t)},generate:function(t){return t}}),t.DrawTool.registerMode("cubicbeziercurve",{action:"clickDblclick",create:function(e){return new t.CubicBezierCurve(e)},update:function(t,e){e.setCoordinates(t)},generate:function(t){return t}}),t.DistanceTool=t.DrawTool.extend({options:{mode:"LineString",language:"zh-CN",metric:!0,imperial:!1,symbol:{lineColor:"#000",lineWidth:3,lineOpacity:1},vertexSymbol:{markerType:"ellipse",markerFill:"#fff",markerLineColor:"#000",markerLineWidth:3,markerWidth:10,markerHeight:10},labelOptions:{symbol:{textWrapCharacter:"\n",textFaceName:"monospace",textLineSpacing:1,textHorizontalAlignment:"right",markerLineColor:"#b4b3b3",textDx:15},boxPadding:{width:6,height:4}}},initialize:function(e){t.Util.setOptions(this,e),this.on("enable",this._afterEnable,this).on("disable",this._afterDisable,this),this._measureLayers=[]},clear:function(){if(t.Util.isArrayHasData(this._measureLayers))for(var e=0;e<this._measureLayers.length;e++)this._measureLayers[e].remove();return delete this._lastMeasure,delete this._lastVertex,this._measureLayers=[],this},getMeasureLayers:function(){return this._measureLayers},getLastMeasure:function(){return this._lastMeasure?this._lastMeasure:0},_measure:function(e){var i,n=this.getMap();e instanceof t.Geometry?i=n.computeGeometryLength(e):t.Util.isArray(e)&&(i=t.GeoUtil._computeLength(e,n.getProjection())),this._lastMeasure=i;var r;r="zh-CN"===this.options.language?[" "," "," "," "]:[" m"," km"," feet"," mile"];var o="";return this.options.metric&&(o+=i<1e3?i.toFixed(0)+r[0]:(i/1e3).toFixed(2)+r[1]),this.options.imperial&&(i*=3.2808399,o.length>0&&(o+="\n"),o+=i<5280?i.toFixed(0)+r[2]:(i/5280).toFixed(2)+r[3]),o},_registerMeasureEvents:function(){this.on("drawstart",this._msOnDrawStart,this).on("drawvertex",this._msOnDrawVertex,this).on("mousemove",this._msOnMouseMove,this).on("drawend",this._msOnDrawEnd,this)},_afterEnable:function(){this._registerMeasureEvents()},_afterDisable:function(){this.off("drawstart",this._msOnDrawStart,this).off("drawvertex",this._msOnDrawVertex,this).off("mousemove",this._msOnMouseMove,this).off("drawend",this._msOnDrawEnd,this)},_msOnDrawStart:function(e){var i=this.getMap(),n=t.Util.UID(),r="distancetool_"+n,o="distancetool_markers_"+n;i.getLayer(r)?(this._measureLineLayer=i.getLayer(r),this._measureMarkerLayer=i.getLayer(o)):(this._measureLineLayer=new t.VectorLayer(r,{drawImmediate:!0}).addTo(i),this._measureMarkerLayer=new t.VectorLayer(o,{drawImmediate:!0}).addTo(i)),this._measureLayers.push(this._measureLineLayer),this._measureLayers.push(this._measureMarkerLayer),new t.Marker(e.coordinate,{symbol:this.options.vertexSymbol}).addTo(this._measureMarkerLayer);var s="zh-CN"===this.options.language?"":"start",a=new t.Label(s,e.coordinate,this.options.labelOptions);this._measureMarkerLayer.addGeometry(a)},_msOnMouseMove:function(e){var i=this._measure(e.geometry.getCoordinates().concat([e.coordinate]));if(!this._tailMarker){var n=t.Util.extendSymbol(this.options.vertexSymbol);n.markerWidth/=2,n.markerHeight/=2,this._tailMarker=new t.Marker(e.coordinate,{symbol:n}).addTo(this._measureMarkerLayer),this._tailLabel=new t.Label(i,e.coordinate,this.options.labelOptions).addTo(this._measureMarkerLayer)}this._tailMarker.setCoordinates(e.coordinate),this._tailLabel.setContent(i),this._tailLabel.setCoordinates(e.coordinate)},_msOnDrawVertex:function(e){var i=e.geometry;new t.Marker(e.coordinate,{symbol:this.options.vertexSymbol}).addTo(this._measureMarkerLayer);var n=this._measure(i),r=new t.Label(n,e.coordinate,this.options.labelOptions);this._measureMarkerLayer.addGeometry(r),this._lastVertex=r},_msOnDrawEnd:function(e){this._clearTailMarker();var i=this._lastVertex.getSize();i||(i=new t.Size(10,10)),this._addClearMarker(this._lastVertex.getCoordinates(),i.width);var n=e.geometry.copy();n.addTo(this._measureLineLayer),this._lastMeasure=n.getLength()},_addClearMarker:function(e,i){var n=new t.Marker(e,{symbol:[{markerType:"square",markerFill:"#ffffff",markerLineColor:"#b4b3b3",markerLineWidth:2,markerWidth:15,markerHeight:15,markerDx:20+i},{markerType:"x",markerWidth:10,markerHeight:10,markerDx:20+i}]}),r=this._measureLineLayer,o=this._measureMarkerLayer;n.on("click",function(){return r.remove(),o.remove(),!1},this),n.addTo(this._measureMarkerLayer)},_clearTailMarker:function(){this._tailMarker&&(this._tailMarker.remove(),delete this._tailMarker),this._tailLabel&&(this._tailLabel.remove(),delete this._tailLabel)}}),t.AreaTool=t.DistanceTool.extend({options:{mode:"Polygon",symbol:{lineColor:"#000000",lineWidth:2,lineOpacity:1,lineDasharray:"",polygonFill:"#ffffff",polygonOpacity:.5}},initialize:function(e){t.Util.setOptions(this,e),this.on("enable",this._afterEnable,this).on("disable",this._afterDisable,this),this._measureLayers=[]},_measure:function(e){var i,n=this.getMap();e instanceof t.Geometry?i=n.computeGeometryArea(e):t.Util.isArray(e)&&(i=t.GeoUtil._computeArea(e,n.getProjection())),this._lastMeasure=i;var r;r="zh-CN"===this.options.language?[" "," "," "," "]:[" sq.m"," sq.km"," sq.ft"," sq.mi"];var o="";if(this.options.metric&&(o+=i<1e6?i.toFixed(0)+r[0]:(i/1e6).toFixed(2)+r[1]),this.options.imperial){i*=3.2808399,o.length>0&&(o+="\n");o+=i<27878400?i.toFixed(0)+r[2]:(i/27878400).toFixed(2)+r[3]}return o},_msOnDrawVertex:function(e){var i=new t.Marker(e.coordinate,{symbol:this.options.vertexSymbol}).addTo(this._measureMarkerLayer);this._lastVertex=i},_msOnDrawEnd:function(e){this._clearTailMarker();var i=this._measure(e.geometry),n=new t.Label(i,e.coordinate,this.options.labelOptions).addTo(this._measureMarkerLayer),r=n.getSize();r||(r=new t.Size(10,10)),this._addClearMarker(e.coordinate,r.width);var o=e.geometry.copy();o.addTo(this._measureLineLayer),this._lastMeasure=o.getArea()}}),t.TileSystem=function(e,i,n,r){t.Util.isArray(e)?(this.scale={x:e[0],y:e[1]},this.origin={x:e[2],y:e[3]}):(this.scale={x:e,y:i},this.origin={x:n,y:r})},t.Util.extend(t.TileSystem,{"web-mercator":new t.TileSystem([1,-1,-20037508.34,20037508.34]),"tms-global-mercator":new t.TileSystem([1,1,-20037508.34,-20037508.34]),"tms-global-geodetic":new t.TileSystem([1,1,-180,-90]),baidu:new t.TileSystem([1,1,0,0])}),t.TileSystem.getDefault=function(t){return"baidu"===t.code.toLowerCase()?"baidu":t.code.toLowerCase()==="EPSG:4326".toLowerCase()?"tms-global-geodetic":"identity"===t.code.toLowerCase()?[1,-1,0,0]:"web-mercator"},t.TileConfig=t.Class.extend({initialize:function(t,e,i){this.tileSize=i,this.fullExtent=e,this.prepareTileInfo(t,e)},prepareTileInfo:function(e,i){if(t.Util.isString(e)?e=t.TileSystem[e.toLowerCase()]:t.Util.isArray(e)&&(e=new t.TileSystem(e)),!e)throw new Error("Invalid TileSystem");this.tileSystem=e;var n=i.right>i.left?1:-1,r=i.top>i.bottom?-1:1,o=e.origin.x,s=e.origin.y;this.transformation=new t.Transformation([n,r,o,s]),e.transOrigin=this.transformation.transform(e.origin,1)},getTileIndex:function(t,e){var i=this.tileSystem,n=this.tileSize,r=i.transOrigin,o=Math.floor(1e-7+(t.x-r.x)/(n.width*e)),s=-Math.floor(1e-7+(t.y-r.y)/(n.height*e));return{x:i.scale.x*o,y:i.scale.y*s}},getCenterTile:function(t,e){var i=this.tileSystem,n=this.tileSize,r=this.transformation.transform(t,1),o=this.getTileIndex(r,e),s=o.x*n.width,a=o.y*n.height,h=r.x/e-i.scale.x*s,l=r.y/e+i.scale.y*a;return i.scale.x<0&&(o.x-=1),i.scale.y>0&&(o.y-=1),o=this.getNeighorTileIndex(o.y,o.x,0,0,!0),{x:o.x,y:o.y,offsetLeft:h,offsetTop:l}},getNeighorTileIndex:function(t,e,i,n,r,o){var s=this.tileSystem,a=e+s.scale.x*n,h=t-s.scale.y*i;if(o){var l=this._getTileFullIndex(r);a<l.xmin?(a=l.xmax-(l.xmin-a)%(l.xmax-l.xmin))===l.xmax&&(a=l.xmin):a>=l.xmax&&(a=l.xmin+(a-l.xmin)%(l.xmax-l.xmin)),h>=l.ymax?h=l.ymin+(h-l.ymin)%(l.ymax-l.ymin):h<l.ymin&&(h=l.ymax-(l.ymin-h)%(l.ymax-l.ymin))===l.ymax&&(h=l.ymin)}return{x:a,y:h}},_getTileFullIndex:function(e){var i=this.fullExtent,n=this.transformation,r=this.getTileIndex(n.transform(new t.Coordinate(i.left,i.top),1),e),o=this.getTileIndex(n.transform(new t.Coordinate(i.right,i.bottom),1),e);return new t.Extent(r,o)},getTileProjectedSw:function(t,e,i){var n=this.tileSystem,r=this.tileSize,o=n.origin.y+n.scale.y*(t+(1===n.scale.y?0:1))*(i*r.height);return[n.scale.x*(e+(1===n.scale.x?0:1))*i*r.width+n.origin.x,o]}}),t.Renderable={registerRenderer:function(t,e){return this._regRenderers||(this._regRenderers={}),this._regRenderers[t.toLowerCase()]=e,this},getRendererClass:function(t){return this._regRenderers?this._regRenderers[t.toLowerCase()]:null}},t.Layer=t.Class.extend({includes:t.Eventable,options:{minZoom:null,maxZoom:null,visible:!0,opacity:1,drawImmediate:!1,globalCompositeOperation:null,renderer:"canvas",dx:0,dy:0},initialize:function(e,i){this.setId(e),t.Util.setOptions(this,i)},load:function(){if(!this.getMap())return this;this._initRenderer();var e=this.getZIndex();return this.onAdd()&&(t.Util.isNil(e)||this._renderer.setZIndex(e),this._renderer.render(!0)),this},getId:function(){return this._id},setId:function(e){var i=this._id;return t.Util.isNil(e)||(e+=""),this._id=e,this.fire("idchange",{old:i,new:e}),this},addTo:function(t){return t.addLayer(this),this},setZIndex:function(t){if(this._zIndex=t,this.map){var e=this._getLayerList();this.map._sortLayersByZIndex(e)}return this._renderer&&this._renderer.setZIndex(t),this},getZIndex:function(){return this._zIndex},isCanvasRender:function(){var t=this._getRenderer();return!!t&&t.isCanvasRender()},getMap:function(){return this.map?this.map:null},bringToFront:function(){var t=this._getLayerList();if(!t)return this;var e=t[t.length-1];if(1===t.length||e===this)return this;var i=e.getZIndex();return this.setZIndex(i+1),this},bringToBack:function(){var t=this._getLayerList();if(!t)return this;var e=t[0];if(1===t.length||e===this)return this;var i=e.getZIndex();return this.setZIndex(i-1),this},show:function(){return this.options.visible||(this.options.visible=!0,this._getRenderer()&&this._getRenderer().show()),this.fire("show"),this},hide:function(){return this.options.visible&&(this.options.visible=!1,this._getRenderer()&&this._getRenderer().hide()),this.fire("hide"),this},isLoaded:function(){return!!this._renderer&&this._renderer.isLoaded()},isVisible:function(){if(t.Util.isNumber(this.options.opacity)&&this.options.opacity<=0)return!1;var e=this.getMap();if(e){var i=e.getZoom();if(!t.Util.isNil(this.options.maxZoom)&&this.options.maxZoom<i||!t.Util.isNil(this.options.minZoom)&&this.options.minZoom>i)return!1}return t.Util.isNil(this.options.visible)&&(this.options.visible=!0),this.options.visible},remove:function(){return this.map&&this.map.removeLayer(this),this},getMask:function(){return this._mask},setMask:function(e){if(!(e instanceof t.Marker&&t.symbolizer.VectorMarkerSymbolizer.test(e.getSymbol())||e instanceof t.Polygon))throw new Error("Mask for a layer must be either a marker with vector marker symbol, a Polygon or a MultiPolygon.");return e instanceof t.Marker?e.updateSymbol({markerLineColor:"rgba(0, 0, 0, 0)",markerFillOpacity:0}):e.setSymbol({lineColor:"rgba(0, 0, 0, 0)",polygonOpacity:0}),e._bindLayer(this),this._mask=e,!this.getMap()||this.getMap()._isBusy()?this:(this._getRenderer()&&this._getRenderer().render(),this)},removeMask:function(){return delete this._mask,!this.getMap()||this.getMap()._isBusy()?this:(this._getRenderer()&&this._getRenderer().render(),this)},onAdd:function(){return!0},_refreshMask:function(){this._mask&&this._mask.onZoomEnd()},_bindMap:function(t,e){t&&(this.map=t,this.setZIndex(e),this._registerEvents(),this._switchEvents("on",this),this.fire("add"))},_initRenderer:function(){var t=this.options.renderer;if(this.constructor.getRendererClass){var e=this.constructor.getRendererClass(t);if(!e)throw new Error("Invalid renderer for Layer("+this.getId()+"):"+t);this._renderer=new e(this),this._renderer.layer=this,this._renderer.setZIndex(this.getZIndex()),this._switchEvents("on",this._renderer)}},_doRemove:function(){this.onRemove&&this.onRemove(),this._switchEvents("off",this),this._removeEvents(),this._renderer&&(this._switchEvents("off",this._renderer),this._renderer.remove(),delete this._renderer),delete this._mask,delete this.map},_switchEvents:function(t,e){e&&e.getEvents&&this.getMap()[t](e.getEvents(),e)},_registerEvents:function(){this.getMap().on("_zoomend",this._refreshMask,this)},_removeEvents:function(){this.getMap().off("_zoomend",this._refreshMask,this)},_getRenderer:function(){return this._renderer},_getLayerList:function(){return this.map?this.map._layers:null}}),t.Util.extend(t.Layer,t.Renderable),t.Layer.extend=function(e){var i=t.Class.extend.call(this,e);return this._regRenderers&&(i._regRenderers=t.Util.extend({},this._regRenderers)),i},t.TileLayer=t.Layer.extend({options:{errorTileUrl:null,urlTemplate:null,subdomains:null,gradualLoading:!0,repeatWorld:!0,renderWhenPanning:!1,updateInterval:function(){return t.Browser.mobile?-1:200}(),cssFilter:null,crossOrigin:null,tileSize:{width:256,height:256},tileSystem:null,debug:!1,cacheTiles:!0,keepBuffer:null,container:"back",baseLayerRenderer:function(){return t.node?"canvas":"dom"}()},getTileSize:function(){var e=this.options.tileSize;return new t.Size(e.width,e.height)},clear:function(){return this._renderer&&this._renderer.clear(),this.fire("clear"),this},_initRenderer:function(){var t=this.options.renderer;if(this.getMap().getBaseLayer()===this&&(t=this.options.baseLayerRenderer,this.getMap()._getRenderer()._isCanvasContainer&&(t="canvas")),this.constructor.getRendererClass){var e=this.constructor.getRendererClass(t);e&&(this._renderer=new e(this),this._renderer.setZIndex(this.getZIndex()),this._switchEvents("on",this._renderer))}},_initTileConfig:function(){var e=this.getMap();this._defaultTileConfig=new t.TileConfig(t.TileSystem.getDefault(e.getProjection()),e.getFullExtent(),this.getTileSize()),this.options.tileSystem&&(this._tileConfig=new t.TileConfig(this.options.tileSystem,e.getFullExtent(),this.getTileSize()))},_getTileConfig:function(){this._defaultTileConfig||this._initTileConfig();var t=this._tileConfig;if(t)return t;var e=this.getMap();return e&&e.getBaseLayer()&&e.getBaseLayer()._getTileConfig?e.getBaseLayer()._getTileConfig():this._defaultTileConfig},_getTiles:function(){var e=this.getMap();if(!e)return null;if(!this.isVisible())return null;var i=this._getTileConfig();if(!i)return null;for(var n=this.getTileSize(),r=e.getZoom(),o=e._getResolution(),s=e.width,a=e.height,h=new t.Point(s/2,a/2),l=e.getContainerExtent(),u=i.getCenterTile(e._getPrjCenter(),o),c=new t.Point(s/2-u.offsetLeft,a/2-u.offsetTop),d=e._containerPointToPoint(c),m=this.getMask()?0:null===this.options.keepBuffer?e.getBaseLayer()===this?1:0:this.options.keepBuffer,f=Math.ceil(Math.abs(h.y-l.ymin-u.offsetTop)/n.height)+m,g=Math.ceil(Math.abs(h.x-l.xmin-u.offsetLeft)/n.width)+m,p=Math.ceil(Math.abs(l.ymax-h.y+u.offsetTop)/n.height)+m,_=Math.ceil(Math.abs(l.xmax-h.x+u.offsetLeft)/n.width)+m,y=[],v=new t.PointExtent,x=new t.Point(d.x-g*n.width,d.y-f*n.height),w=-g;w<_;w++)for(var C=-f;C<p;C++){var b=i.getNeighorTileIndex(u.y,u.x,C,w,o,this.options.repeatWorld),P=this._getTileUrl(b.x,b.y,r),M=[b.y,b.x,r].join("__"),S={url:P,point:new t.Point(d.x+n.width*w,d.y+n.height*C),id:M,zoom:r};y.push(S),v._combine(new t.PointExtent(S.point,S.point.add(n.width,n.height)))}return y.sort(function(t,e){return e.point.distanceTo(d)-t.point.distanceTo(d)}),{tiles:y,fullExtent:v,northWest:x}},_getTileUrl:function(e,i,n){if(!this.options.urlTemplate)return this.options.errorTileUrl;var r=this.options.urlTemplate,o="";if(this.options.subdomains){var s=this.options.subdomains;if(t.Util.isArrayHasData(s)){var a=s.length,h=(e+i)%a;h<0&&(h=0),o=s[h]}}if(t.Util.isFunction(r))return r(e,i,n,o);var l={x:e,y:i,z:n,s:o};return r.replace(/\{ *([\w_]+) *\}/g,function(t,e){var i=l[e];if(void 0===i)throw new Error("No value provided for variable "+t);return"function"==typeof i&&(i=i(l)),i})}}),t.TileLayer.prototype.toJSON=function(){return{type:"TileLayer",id:this.getId(),options:this.config()}},t.TileLayer.fromJSON=function(e){return e&&"TileLayer"===e.type?new t.TileLayer(e.id,e.options):null},t.CanvasTileLayer=t.TileLayer.extend({}),t.CanvasTileLayer.prototype.toJSON=function(){return{type:"CanvasTileLayer",id:this.getId(),options:this.config()}},t.CanvasTileLayer.fromJSON=function(e){return e&&"CanvasTileLayer"===e.type?new t.CanvasTileLayer(e.id,e.options):null},t.OverlayLayer=t.Layer.extend({getGeometryById:function(e){return t.Util.isNil(e)||""===e?null:this._geoMap[e]?this._geoMap[e]:null},getGeometries:function(t,e){if(!t)return this._geoList.slice(0);for(var i,n=[],r=0,o=this._geoList.length;r<o;r++)i=this._geoList[r],(e?t.call(e,i):t(i))&&n.push(i);return n},getFirstGeometry:function(){return 0===this._geoList.length?null:this._geoList[0]},getLastGeometry:function(){var t=this._geoList.length;return 0===t?null:this._geoList[t-1]},getCount:function(){return this._geoList.length},getExtent:function(){if(0===this.getCount())return null;var e=new t.Extent;return this.forEach(function(t){e._combine(t.getExtent())}),e},forEach:function(t,e){for(var i=this._geoList.slice(0),n=0,r=i.length;n<r;n++)e?t.call(e,i[n],n):t(i[n],n);return this},filter:function(e,i){var n=[];if(t.Util.isFunction(e))e&&this.forEach(function(t){(i?e.call(i,t):e(t))&&n.push(t)});else{var r=t.Util.createFilter(e);this.forEach(function(e){r(t.Util.getFilterFeature(e))&&n.push(e)},this)}return n.length>0?new t.GeometryCollection(n):null},isEmpty:function(){return 0===this._geoList.length},addGeometry:function(e,i){if(!e)return this;if(!t.Util.isArray(e)){var n=arguments.length,r=arguments[n-1];return e=Array.prototype.slice.call(arguments,0,n-1),i=r,r instanceof t.Geometry&&(e.push(r),i=!1),this.addGeometry(e,i)}if(!t.Util.isArrayHasData(e))return this;this._initCache();for(var o,s,a,h,l,u=0,c=new t.Coordinate(0,0),d=null,m=0,f=e.length;m<f;m++){if(!(o=e[m]))throw new Error("Invalid geometry to add to layer("+this.getId()+") at index:"+m);if(o instanceof t.Geometry||(o=t.Geometry.fromJSON(o)),s=o.getId(),!t.Util.isNil(s)){if(!t.Util.isNil(this._geoMap[s]))throw new Error("Duplicate geometry id in layer("+this.getId()+"):"+s+", at index:"+m);this._geoMap[s]=o}a=t.Util.UID(),o._setInternalId(a),this._geoList.push(o),i===!0&&(h=o.getCenter(),l=o.getExtent(),h&&l&&(c._add(h),d=null==d?l:d._combine(l),u++)),this.onAddGeometry&&this.onAddGeometry(o),o._bindLayer(this),o._fireEvent("add",{layer:this})}this._sortGeometries();var g=this.getMap();if(g&&(this._getRenderer().onGeometryAdd(e),i&&d)){var p=g.getFitZoom(d),_=c._multi(1/u);g.setCenterAndZoom(_,p)}return this.fire("addgeo",{geometries:e}),this},removeGeometry:function(e){if(!t.Util.isArray(e))return this.removeGeometry([e]);for(var i=e.length-1;i>=0;i--)e[i]instanceof t.Geometry||(e[i]=this.getGeometryById(e[i])),e[i]&&this===e[i].getLayer()&&e[i].remove();return this.fire("removegeo",{geometries:e}),this},clear:function(){this._clearing=!0,this.forEach(function(t){t.remove()}),this._geoMap={};var t=this._geoList;return this._geoList=[],this._getRenderer()&&this._getRenderer().onGeometryRemove(t),this._clearing=!1,this.fire("clear"),this},onRemoveGeometry:function(e){if(e&&!this._clearing&&this===e.getLayer()){var i=e._getInternalId();if(!t.Util.isNil(i)){var n=e.getId();t.Util.isNil(n)||delete this._geoMap[n];var r=this._findInList(e);r>=0&&this._geoList.splice(r,1),this._getRenderer()&&this._getRenderer().onGeometryRemove([e])}}},hide:function(){for(var e=0,i=this._geoList.length;e<i;e++)this._geoList[e].onHide();return t.Layer.prototype.hide.call(this)},identify:function(e,i){i=i||{};for(var n,r=this._geoList,o=i?i.filter:null,s=[],a=r.length-1;a>=0;a--){var h=r[a];if(h&&h.isVisible()&&h._getPainter()&&(h instanceof t.LineString&&h._getArrowStyle()||(n=h._getPainter().get2DExtent())&&n.contains(e))&&h._containsPoint(e)&&(!o||o(h))&&(s.push(h),i.count&&s.length>=i.count))break}return s},_initCache:function(){this._geoList||(this._geoList=[],this._geoMap={})},_sortGeometries:function(){var t=this;this._geoList.sort(function(e,i){return t._compare(e,i)})},_compare:function(t,e){return t.getZIndex()===e.getZIndex()?t._getInternalId()-e._getInternalId():t.getZIndex()-e.getZIndex()},_findInList:function(t){var e=this._geoList.length;if(0===e)return-1;for(var i,n=0,r=e-1;n<=r;){if(i=Math.floor((n+r)/2),this._geoList[i]===t)return i;this._compare(this._geoList[i],t)>0?r=i-1:n=i+1}return-1},_onGeometryEvent:function(t){if(t&&t.target){var e=t.type
;"idchange"===e?this._onGeometryIdChange(t):"zindexchange"===e?this._onGeometryZIndexChange(t):"positionchange"===e?this._onGeometryPositionChange(t):"shapechange"===e?this._onGeometryShapeChange(t):"symbolchange"===e?this._onGeometrySymbolChange(t):"show"===e?this._onGeometryShow(t):"hide"===e?this._onGeometryHide(t):"propertieschange"===e&&this._onGeometryPropertiesChange(t)}},_onGeometryIdChange:function(e){if(e.new!==e.old||!this._geoMap[e.old]||this._geoMap[e.old]!==e.target){if(!t.Util.isNil(e.new)){if(this._geoMap[e.new])throw new Error("Duplicate geometry id in layer("+this.getId()+"):"+e.new);this._geoMap[e.new]=e.target}t.Util.isNil(e.old)||e.new===e.old||delete this._geoMap[e.old]}},_onGeometryZIndexChange:function(t){t.old!==t.new&&(this._sortGeometries(),this._getRenderer()&&this._getRenderer().onGeometryZIndexChange(t))},_onGeometryPositionChange:function(t){this._getRenderer()&&this._getRenderer().onGeometryPositionChange(t)},_onGeometryShapeChange:function(t){this._getRenderer()&&this._getRenderer().onGeometryShapeChange(t)},_onGeometrySymbolChange:function(t){this._getRenderer()&&this._getRenderer().onGeometrySymbolChange(t)},_onGeometryShow:function(t){this._getRenderer()&&this._getRenderer().onGeometryShow(t)},_onGeometryHide:function(t){this._getRenderer()&&this._getRenderer().onGeometryHide(t)},_onGeometryPropertiesChange:function(t){this._getRenderer()&&this._getRenderer().onGeometryPropertiesChange(t)}}),t.OverlayLayer.addInitHook(function(){this._initCache()}),t.VectorLayer=t.OverlayLayer.extend({options:{debug:!1,enableSimplify:!0,cursor:"pointer",geometryEvents:!0,defaultIconSize:[20,20],cacheVectorOnCanvas:!0,cacheSvgOnCanvas:!1},initialize:function(e,i,n){!i||i instanceof t.Geometry||t.Util.isArray(i)||(n=i,i=null);var r=t.Util.extend({},n);r.style&&(this.setStyle(r.style),delete r.style),t.Layer.prototype.initialize.call(this,e,r),i&&this.addGeometry(i)},getStyle:function(){return this._style?this._style:null},setStyle:function(e){return this._style=e,this._cookedStyles=t.Util.compileStyle(e),this.forEach(function(t){this._styleGeometry(t)},this),this.fire("setstyle",{style:e}),this},removeStyle:function(){return this._style?(delete this._style,delete this._cookedStyles,this.forEach(function(t){t._setExternSymbol(null)},this),this.fire("removestyle"),this):this},onAddGeometry:function(t){this.getStyle()&&this._styleGeometry(t)},_styleGeometry:function(e){if(!this._cookedStyles)return!1;for(var i=t.Util.getFilterFeature(e),n=0,r=this._cookedStyles.length;n<r;n++)if(this._cookedStyles[n].filter(i)===!0)return e._setExternSymbol(this._cookedStyles[n].symbol),!0;return!1},toJSON:function(e){e||(e={});var i={type:"VectorLayer",id:this.getId(),options:this.config()};if((t.Util.isNil(e.style)||e.style)&&this.getStyle()&&(i.style=this.getStyle()),t.Util.isNil(e.geometries)||e.geometries){var n;e.clipExtent&&(n=new t.Extent(e.clipExtent));for(var r,o,s=[],a=this.getGeometries(),h=0,l=a.length;h<l;h++)!(r=a[h].getExtent())||n&&!n.intersects(r)||(o=a[h].toJSON(e.geometries),o.symbol&&this.getStyle()&&(o.symbol=a[h]._symbolBeforeStyle?t.Util.extend({},a[h]._symbolBeforeStyle):null),s.push(o));i.geometries=s}return i}}),t.VectorLayer.fromJSON=function(e){if(!e||"VectorLayer"!==e.type)return null;for(var i,n=new t.VectorLayer(e.id,e.options),r=e.geometries,o=[],s=0;s<r.length;s++)(i=t.Geometry.fromJSON(r[s]))&&o.push(i);return n.addGeometry(o),e.style&&n.setStyle(e.style),n},t.Geometry=t.Class.extend({includes:[t.Eventable,t.Handlerable],statics:{TYPE_POINT:"Point",TYPE_LINESTRING:"LineString",TYPE_POLYGON:"Polygon",TYPE_MULTIPOINT:"MultiPoint",TYPE_MULTILINESTRING:"MultiLineString",TYPE_MULTIPOLYGON:"MultiPolygon",TYPE_GEOMETRYCOLLECTION:"GeometryCollection"},options:{id:null,visible:!0,editable:!0,cursor:null,shadowBlur:0,shadowColor:"black",measure:"EPSG:4326"},getFirstCoordinate:function(){if(this instanceof t.GeometryCollection){var e=this.getGeometries();return e&&t.Util.isArrayHasData(e)?e[0].getFirstCoordinate():null}var i=this.getCoordinates();if(!t.Util.isArray(i))return i;var n=i;do{n=n[0]}while(t.Util.isArray(n));return n},getLastCoordinate:function(){if(this instanceof t.GeometryCollection){var e=this.getGeometries();return e&&t.Util.isArrayHasData(e)?e[e.length-1].getLastCoordinate():null}var i=this.getCoordinates();if(!t.Util.isArray(i))return i;var n=i;do{n=n[n.length-1]}while(t.Util.isArray(n));return n},addTo:function(t,e){return t.addGeometry(this,e),this},getLayer:function(){return this._layer?this._layer:null},getMap:function(){return this._layer?this._layer.getMap():null},getId:function(){return this._id},setId:function(t){var e=this.getId();return this._id=t,this._fireEvent("idchange",{old:e,new:t}),this},getProperties:function(){return this.properties?this.properties:this._getParent()?this._getParent().getProperties():null},setProperties:function(e){var i=this.properties;return this.properties=t.Util.isObject(e)?t.Util.extend({},e):e,this._fireEvent("propertieschange",{old:i,new:e}),this},getType:function(){return this.type},getSymbol:function(){var e=this._symbol;return e?t.Util.isArray(e)?t.Util.extendSymbol(e):t.Util.extend({},e):null},setSymbol:function(t){return this._symbol=this._prepareSymbol(t),this.onSymbolChanged(),this},updateSymbol:function(e){if(!e)return this;var i=this.getSymbol();return i=i?t.Util.extendSymbol(i,e):t.Util.extendSymbol(this._getInternalSymbol(),e),this.setSymbol(i)},getCenter:function(){return this._computeCenter(this._getMeasurer()).copy()},getExtent:function(){var e=this._getPrjExtent();if(e){var i=this._getProjection();return new t.Extent(i.unproject(new t.Coordinate(e.xmin,e.ymin)),i.unproject(new t.Coordinate(e.xmax,e.ymax)))}return this._computeExtent(this._getMeasurer())},getSize:function(){return this.getMap()?this._getPainter().get2DExtent().getSize():null},containsPoint:function(e,i){if(!this.getMap())throw new Error('The geometry is required to be added on a map to perform "containsPoint".');return e instanceof t.Coordinate&&(e=this.getMap().coordinateToContainerPoint(e)),this._containsPoint(this.getMap()._containerPointToPoint(new t.Point(e)),i)},show:function(){if(this.options.visible=!0,this.getMap()){var t=this._getPainter();t&&t.show(),this._fireEvent("show")}return this},hide:function(){if(this.options.visible=!1,this.getMap()){this.onHide();var t=this._getPainter();t&&t.hide(),this._fireEvent("hide")}return this},isVisible:function(){if(!this.options.visible)return!1;var e=this._getInternalSymbol();if(!e)return!0;if(t.Util.isArray(e)){if(0===e.length)return!0;for(var i=0,n=e.length;i<n;i++)if(t.Util.isNil(e[i].opacity)||e[i].opacity>0)return!0;return!1}return t.Util.isNil(e.opacity)||t.Util.isNumber(e.opacity)&&e.opacity>0},getZIndex:function(){return this.options.zIndex||0},setZIndex:function(t){var e=this.options.zIndex||0;return this.options.zIndex=t,this._fireEvent("zindexchange",{old:e,new:t}),this},setZIndexSilently:function(t){return this.options.zIndex=t,this},bringToFront:function(){var e=this.getLayer();if(!(e&&e instanceof t.OverlayLayer))return this;var i=e.getLastGeometry().getZIndex();return this.setZIndex(i+1),this},bringToBack:function(){var e=this.getLayer();if(!(e&&e instanceof t.OverlayLayer))return this;var i=e.getFirstGeometry().getZIndex();return this.setZIndex(i-1),this},translate:function(e){if(!e)return this;if(e=new t.Coordinate(e),0===e.x&&0===e.y)return this;var i=this.getCoordinates();if(i)if(t.Util.isArray(i)){var n=t.Util.mapArrayRecursively(i,function(t){return t.add(e)});this.setCoordinates(n)}else this.setCoordinates(i.add(e));return this},flash:function(t,e,i,n){function r(){if(0===e)return o.show(),void(i&&(n?i.call(n):i()));e%2==0?o.hide():o.show(),e--,o._flashTimeout=setTimeout(r,t)}t||(t=100),e||(e=4);var o=this;return e*=2,this._flashTimeout&&clearTimeout(this._flashTimeout),this._flashTimeout=setTimeout(r,t),this},copy:function(){var e=this.toJSON(),i=t.Geometry.fromJSON(e);return i.options.visible=!0,i},remove:function(){return this.getLayer()?(this._fireEvent("removestart"),this._unbind(),this._fireEvent("removeend"),this._fireEvent("remove"),this):this},toGeoJSONGeometry:function(){return this._exportGeoJSONGeometry()},toGeoJSON:function(e){e||(e={});var i={type:"Feature",geometry:null};if(t.Util.isNil(e.geometry)||e.geometry){var n=this._exportGeoJSONGeometry();i.geometry=n}var r=this.getId();t.Util.isNil(r)||(i.id=r);var o;return(t.Util.isNil(e.properties)||e.properties)&&(o=this._exportProperties()),i.properties=o,i},toJSON:function(e){e||(e={});var i=this._toJSON(e),n=this._exportGraphicOptions(e);return t.Util.extend(i,n),i},getLength:function(){return this._computeGeodesicLength(this._getMeasurer())},getArea:function(){return this._computeGeodesicArea(this._getMeasurer())},_getConnectPoints:function(){return[this.getCenter()]},_initOptions:function(e){e||(e={});var i=e.symbol,n=e.properties,r=e.id;t.Util.setOptions(this,e),delete this.options.symbol,delete this.options.id,delete this.options.properties,i&&this.setSymbol(i),n&&this.setProperties(n),t.Util.isNil(r)||this.setId(r)},_bindLayer:function(t){if(this.getLayer())throw new Error("Geometry cannot be added to two or more layers at the same time.");this._layer=t,this._clearProjection()},_prepareSymbol:function(e){if(t.Util.isArray(e)){for(var i=[],n=0;n<e.length;n++)i.push(t.Util.convertResourceUrl(this._checkAndCopySymbol(e[n])));return i}return e?(e=this._checkAndCopySymbol(e),t.Util.convertResourceUrl(e)):null},_checkAndCopySymbol:function(e){var i={},n=t.Symbolizer.numberProperties;for(var r in e)n[r]&&t.Util.isString(e[r])?i[r]=+e[r]:i[r]=e[r];return i},_setExternSymbol:function(t){return this._externSymbol=this._prepareSymbol(t),this.onSymbolChanged(),this},_getInternalSymbol:function(){return this._symbol?this._symbol:this._externSymbol?this._externSymbol:this.options.symbol?this.options.symbol:null},_getPrjExtent:function(){var e=this._getProjection();if(!this._extent&&e){var i=this._computeExtent(e);if(i){var n=this.options.antiMeridian&&t.MeasurerUtil.isSphere(e);if(n&&"default"!==n){var r=this.getFirstCoordinate();if("continuous"===n&&i.xmax-i.xmin>180&&(r.x>0?i.xmin+=360:i.xmax-=360),i.xmax<i.xmin){var o=i.xmax;i.xmax=i.xmin,i.xmin=o}}this._extent=new t.Extent(e.project(new t.Coordinate(i.xmin,i.ymin)),e.project(new t.Coordinate(i.xmax,i.ymax)))}}return this._extent},_unbind:function(){var t=this.getLayer();t&&(this._animPlayer&&this._animPlayer.finish(),this._unbindMenu(),this._unbindInfoWindow(),this.isEditing()&&this.endEdit(),this._removePainter(),this.onRemove&&this.onRemove(),t.onRemoveGeometry&&t.onRemoveGeometry(this),delete this._layer,delete this._internalId,delete this._extent)},_getInternalId:function(){return this._internalId},_setInternalId:function(t){this._internalId=t},_getMeasurer:function(){return this._getProjection()?this._getProjection():t.MeasurerUtil.getInstance(this.options.measure)},_getProjection:function(){var t=this.getMap();return t&&t.getProjection()?t.getProjection():null},_getExternalResources:function(){var e=this,i=e._getInternalSymbol();return t.Util.getExternalResources(i)},_getPainter:function(){return!this._painter&&this.getMap()&&(this instanceof t.GeometryCollection?this._painter=new t.CollectionPainter(this):this._painter=new t.Painter(this)),this._painter},_removePainter:function(){this._painter&&this._painter.remove(),delete this._painter},_paint:function(){this._painter&&this._painter.paint()},_repaint:function(){this._painter&&this._painter.repaint()},_removeZoomCache:function(){this._painter&&this._painter.removeZoomCache()},onHide:function(){this.closeMenu(),this.closeInfoWindow()},onShapeChanged:function(){this._extent=null,this._repaint(),this._fireEvent("shapechange")},onPositionChanged:function(){this._extent=null,this._repaint(),this._fireEvent("positionchange")},onSymbolChanged:function(){this._painter&&this._painter.refreshSymbol(),this._fireEvent("symbolchange")},onConfig:function(t){var e=!1;for(var i in t)if(t.hasOwnProperty(i)){var n=i.slice(0,5);if("arrow"===n||"shado"===n){e=!0;break}}e&&this._repaint()},_setParent:function(t){t&&(this._parent=t)},_getParent:function(){return this._parent},_fireEvent:function(t,e){this.getLayer()&&this.getLayer()._onGeometryEvent&&(e||(e={}),e.type=t,e.target=this,this.getLayer()._onGeometryEvent(e)),this.fire(t,e)},_toJSON:function(t){return{feature:this.toGeoJSON(t)}},_exportGraphicOptions:function(e){var i={};return(t.Util.isNil(e.options)||e.options)&&(i.options=this.config()),(t.Util.isNil(e.symbol)||e.symbol)&&(i.symbol=this.getSymbol()),(t.Util.isNil(e.infoWindow)||e.infoWindow)&&this._infoWinOptions&&(i.infoWindow=this._infoWinOptions),i},_exportGeoJSONGeometry:function(){var e=this.getCoordinates(),i=t.GeoJSON.toNumberArrays(e);return{type:this.getType(),coordinates:i}},_exportProperties:function(){var e=null,i=this.getProperties();return i&&(t.Util.isObject(i)?e=t.Util.extend({},i):i=e),e}}),t.Geometry.fromJSON=function(e){if(t.Util.isArray(e)){for(var i,n=[],r=0,o=e.length;r<o;r++)i=t.Geometry.fromJSON(e[r]),t.Util.isArray(e)?n=n.concat(i):n.push(i);return n}if(e&&!e.feature)return t.GeoJSON.toGeometry(e);var s;if(e.subType)s=t[e.subType].fromJSON(e),t.Util.isNil(e.feature.id)||s.setId(e.feature.id);else{var a=e.feature;s=t.GeoJSON.toGeometry(a),e.options&&s.config(e.options)}return e.symbol&&s.setSymbol(e.symbol),e.infoWindow&&s.setInfoWindow(e.infoWindow),s},t.Geometry.getMarkerPathBase64=function(e){if(!e.markerPath)return null;var i=1,n=t.symbolizer.VectorMarkerSymbolizer.translateToSVGStyles(e);t.Util.isNumber(e.markerOpacity)&&(i=e.markerOpacity),t.Util.isNumber(e.opacity)&&(i*=e.opacity);var r,o={};if(n){for(r in n.stroke)n.stroke.hasOwnProperty(r)&&(t.Util.isNil(n.stroke[r])||(o[r]=n.stroke[r]));for(r in n.fill)n.fill.hasOwnProperty(r)&&(t.Util.isNil(n.fill[r])||(o[r]=n.fill[r]))}var s,a,h=t.Util.isArray(e.markerPath)?e.markerPath:[e.markerPath],l=[];for(s=0;s<h.length;s++)a=t.Util.isString(h[s])?{path:h[s]}:h[s],a=t.Util.extend({},a,o),a.d=a.path,delete a.path,l.push(a);var u=['<svg version="1.1"','xmlns="http://www.w3.org/2000/svg"'];for(i<1&&u.push('opacity="'+i+'"'),e.markerPathWidth&&e.markerPathHeight&&u.push('viewBox="0 0 '+e.markerPathWidth+" "+e.markerPathHeight+'"'),u.push('preserveAspectRatio="none"'),u.push("><defs></defs>"),s=0;s<l.length;s++){var c="<path ";for(r in l[s])l[s].hasOwnProperty(r)&&(c+=" "+r+'="'+l[s][r]+'"');c+="></path>",u.push(c)}return u.push("</svg>"),"data:image/svg+xml;base64,"+t.Util.btoa(u.join(" "))},t.Geometry.include({startEdit:function(e){return this.getMap()&&this.options.editable?(this.endEdit(),this._editor=new t.Geometry.Editor(this,e),this._editor.start(),this.fire("editstart"),this):this},endEdit:function(){return this._editor&&(this._editor.stop(),delete this._editor,this.fire("editend")),this},isEditing:function(){return!!this._editor&&this._editor.isEditing()}}),t.Geometry.mergeOptions({draggable:!1,dragShadow:!0,dragOnAxis:null}),t.Geometry.Drag=t.Handler.extend({dragStageLayerId:t.internalLayerPrefix+"_drag_stage",START:t.Browser.touch?["touchstart","mousedown"]:["mousedown"],addHooks:function(){this.target.on(this.START.join(" "),this._startDrag,this)},removeHooks:function(){this.target.off(this.START.join(" "),this._startDrag,this)},_startDrag:function(t){if(this.target.getMap()&&!this.target._getParent()&&!this.isDragging()){var e=t.domEvent;e.touches&&e.touches.length>1||(this.target.on("click",this._endDrag,this),this._lastPos=t.coordinate,this._prepareMap(),this._prepareDragHandler(),this._dragHandler.onMouseDown(t.domEvent),this._moved=!1,this.target._fireEvent("dragstart",t))}},_prepareMap:function(){var t=this.target.getMap();this._mapDraggable=t.options.draggable,this._mapHitDetect=t.options.hitDetect,t._trySetCursor("move"),t.config({hitDetect:!1,draggable:!1})},_prepareDragHandler:function(){var e=this.target.getMap();this._dragHandler=new t.Handler.Drag(e._panels.mapWrapper||e._containerDOM),this._dragHandler.on("dragging",this._dragging,this),this._dragHandler.on("mouseup",this._endDrag,this),this._dragHandler.enable()},_prepareShadow:function(){var e=this.target;this._prepareDragStageLayer();var i=this._dragStageLayer._getRenderer().resources;this._shadow&&this._shadow.remove(),this._shadow=e.copy(),this._shadow.setSymbol(e._getInternalSymbol());var n=this._shadow;if(e.options.dragShadow){var r=t.Util.lowerSymbolOpacity(n._getInternalSymbol(),.5);n.setSymbol(r)}n.setId(null);var o=[];if(t.ConnectorLine._hasConnectors(e))for(var s=t.ConnectorLine._getConnectors(e),a=0;a<s.length;a++){var h=s[a],l=h.config(),u=h._getInternalSymbol();l.symbol=t.Util.lowerSymbolOpacity(u,.5);var c;c=h.getConnectSource()===e?new t.ConnectorLine(n,h.getConnectTarget(),l):new t.ConnectorLine(h.getConnectSource(),n,l),o.push(c),h.getLayer()&&h.getLayer()._getRenderer()&&i.merge(h.getLayer()._getRenderer().resources)}this._shadowConnectors=o,o.push(n),this._dragStageLayer.bringToFront().addGeometry(o)},_onTargetUpdated:function(){this._shadow&&this._shadow.setSymbol(this.target.getSymbol())},_prepareDragStageLayer:function(){var e=this.target.getMap(),i=this.target.getLayer();this._dragStageLayer=e.getLayer(this.dragStageLayerId),this._dragStageLayer||(this._dragStageLayer=new t.VectorLayer(this.dragStageLayerId,{drawImmediate:!0}),e.addLayer(this._dragStageLayer));var n=new t.renderer.Canvas.Resources;n.merge(i._getRenderer().resources),this._dragStageLayer._getRenderer().resources=n},_dragging:function(t){var e=this.target,i=e.getMap(),n=i._parseEvent(t.domEvent),r=n.domEvent;if(!(r.touches&&r.touches.length>1)){if(!this._moved)return this._moved=!0,e.on("symbolchange",this._onTargetUpdated,this),this._isDragging=!0,this._prepareShadow(),e.options.dragShadow||e.hide(),void this._shadow._fireEvent("dragstart",n);if(this._shadow){var o=this._shadow.options.dragOnAxis,s=n.coordinate;this._lastPos||(this._lastPos=s);var a=s.substract(this._lastPos);"x"===o?a.y=0:"y"===o&&(a.x=0),this._lastPos=s,this._shadow.translate(a),e.options.dragShadow||e.translate(a),n.dragOffset=a,this._shadow._fireEvent("dragging",n),e._fireEvent("dragging",n)}}},_endDrag:function(e){var i=this.target,n=i.getLayer(),r=i.getMap();if(this._dragHandler&&(i.off("click",this._endDrag,this),this._dragHandler.disable(),delete this._dragHandler),r){var o;if(r&&(o=r._parseEvent(e.domEvent)),i.off("symbolchange",this._onTargetUpdated,this),!i.options.dragShadow){var s=n.options.drawImmediate;n.config("drawImmediate",!0),i.show(),n.config("drawImmediate",s)}var a=this._shadow;a&&(i.options.dragShadow&&i.setCoordinates(a.getCoordinates()),a._fireEvent("dragend",o),a.remove(),delete this._shadow),this._shadowConnectors&&(r.getLayer(this.dragStageLayerId).removeGeometry(this._shadowConnectors),delete this._shadowConnectors),delete this._lastPos,r._trySetCursor("default"),t.Util.isNil(this._mapDraggable)&&(this._mapDraggable=!0),r.config({hitDetect:this._mapHitDetect,draggable:this._mapDraggable}),delete this._mapDraggable,delete this._mapHitDetect,this._dragStageLayer&&this._dragStageLayer.remove(),this._isDragging=!1,i._fireEvent("dragend",o)}},isDragging:function(){return!!this._isDragging}}),t.Geometry.addInitHook("addHandler","draggable",t.Geometry.Drag),t.Geometry.include({isDragging:function(){return this._getParent()?this._getParent().isDragging():!!this.draggable&&this.draggable.isDragging()}}),t.Geometry.include({_onEvent:function(e){if(this.getMap()){var i=this._getEventTypeToFire(e);"contextmenu"===i&&this.listens("contextmenu")&&(t.DomUtil.stopPropagation(e),t.DomUtil.preventDefault(e));var n=this._getEventParams(e);this._fireEvent(i,n)}},_getEventTypeToFire:function(t){var e=t.type;return"click"!==e&&"mousedown"!==e||2===t.button&&(e="contextmenu"),e},_getEventParams:function(e){var i=this.getMap(),n={domEvent:e},r=e.touches?e.touches[0]:e;if(r){var o=t.DomUtil.getEventContainerPoint(r,i._containerDOM);n.coordinate=i.containerPointToCoordinate(o),n.containerPoint=o,n.viewPoint=i.containerPointToViewPoint(o),n.pont2d=i._containerPointToPoint(o)}return n},_onMouseOver:function(t){if(this.getMap()){var e=t,i=this._getEventParams(e);this._fireEvent("mouseover",i)}},_onMouseOut:function(t){if(this.getMap()){var e=t,i=this._getEventParams(e);this._fireEvent("mouseout",i)}}}),t.Geometry.include({animate:function(e,i,n){this._animPlayer&&this._animPlayer.finish(),t.Util.isFunction(i)&&(n=i,i=null);var r,o,s=this.getMap(),a=this._getProjection(),h=this.getSymbol(),l=this._prepareAnimationStyles(e);i&&(o=i.focus),delete this._animationStarted;var u=t.Animation.animate(l,i,t.Util.bind(function(e){!this._animationStarted&&o&&s.onMoveStart();var i=e.styles;for(var l in i)if("symbol"!==l&&"translate"!==l&&i.hasOwnProperty(l)){var c="set"+l[0].toUpperCase()+l.slice(1);this[c](i[l])}var d=i.translate;if(d){var m=d;r&&(m=d.substract(r)),r=d,this.translate(m)}var f=i.symbol;if(f&&this.setSymbol(t.Util.extendSymbol(h,f)),o){var g=a.project(this.getCenter());s._setPrjCenterAndMove(g),"running"!==u.playState?s.onMoveEnd():s.onMoving()}this._fireAnimateEvent(u.playState),n&&n(e)},this));return this._animPlayer=u,this._animPlayer.play()},_prepareAnimationStyles:function(e){var i=this._getInternalSymbol(),n={};for(var r in e)if(e.hasOwnProperty(r)){var o,s=e[r];if("translate"!==r&&"symbol"!==r){var a="get"+r[0].toUpperCase()+r.substring(1),h=this[a]();n[r]=[h,s]}else if("symbol"===r){var l;if(t.Util.isArray(e.symbol)){if(!t.Util.isArray(i))throw new Error("geometry'symbol isn't a composite symbol, while the symbol in styles is.");l=[];for(var u=e.symbol,c=0;c<u.length;c++)if(u[c]){var d={};for(o in u[c])u[c].hasOwnProperty(o)&&(d[o]=[i[c][o],u[c][o]]);l.push(d)}else l.push(null)}else{if(t.Util.isArray(i))throw new Error("geometry'symbol is a composite symbol, while the symbol in styles isn't.");l={};for(o in s)s.hasOwnProperty(o)&&(l[o]=[i[o],s[o]])}n.symbol=l}else"translate"===r&&(n.translate=new t.Coordinate(s))}return n},_fireAnimateEvent:function(t){"finished"===t?(delete this._animationStarted,this._fireEvent("animateend")):"running"===t&&(this._animationStarted?this._fireEvent("animating"):(this._fireEvent("animatestart"),this._animationStarted=!0))}}),t.Vector=t.Geometry.extend({options:{symbol:{lineColor:"#000",lineWidth:2,lineOpacity:1,polygonFill:"#fff",polygonOpacity:1,opacity:1}},_hitTestTolerance:function(){var e,i=this._getInternalSymbol();if(t.Util.isArray(i)){e=0;for(var n=0;n<i.length;n++)t.Util.isNumber(i[n].lineWidth)&&i[n].lineWidth>e&&(e=i[n].lineWidth)}else e=i.lineWidth;return e?e/2:1.5}}),t.Geometry.Center={getCoordinates:function(){return this._coordinates},setCoordinates:function(e){var i=new t.Coordinate(e);if(i.equals(this._coordinates))return this;if(this._coordinates=i,!this.getMap())return this.onPositionChanged(),this;var n=this._getProjection();return this._setPrjCoordinates(n.project(this._coordinates)),this},_getCenter2DPoint:function(e){var i=this.getMap();if(!i)return null;var n=t.Util.isNil(e)?i.getZoom():i.getMaxZoom(),r=this._getPrjCoordinates();return r?i._prjToPoint(r,n):null},_getPrjCoordinates:function(){var t=this._getProjection();return t?(this._pcenter||this._coordinates&&(this._pcenter=t.project(this._coordinates)),this._pcenter):null},_setPrjCoordinates:function(t){this._pcenter=t,this.onPositionChanged()},_updateCache:function(){delete this._extent;var t=this._getProjection();this._pcenter&&t&&(this._coordinates=t.unproject(this._pcenter))},_clearProjection:function(){this._pcenter=null},_computeCenter:function(){return this._coordinates}},t.Geometry.Poly={_getPath2DPoints:function(e,i,n){var r=[];if(!t.Util.isArrayHasData(e))return r;delete this._simplified;var o=this.getMap(),s=o.getFullExtent(),a=this._getProjection(),h=this.options.antiMeridian&&t.MeasurerUtil.isSphere(a),l=o.options.clipFullExtent,u=!i&&this.getLayer()&&this.getLayer().options.enableSimplify,c=2*o._getResolution(),d=t.Util.isArray(e[0]);if(u&&!d){var m=e.length;e=t.Simplify.simplify(e,c,!1),this._simplified=e.length<m}t.Util.isNil(n)&&(n=o.getZoom());var f,g,p,_,y,v,x,w,C=[],b=[],P=C;for(f=0,g=e.length;f<g;f++)p=e[f],d?P.push(this._getPath2DPoints(p,i,n)):t.Util.isNil(p)||l&&!s.contains(p)||(f>0&&("continuous"===h||"split"===h)&&(y=a.unproject(p),"split"!==h&&_||(_=a.unproject(e[f-1])),_&&y&&(v=y.x-_.x,x=y.y-_.y,Math.abs(v)>180&&("continuous"===h?(y=this._anti(y,v),_=y,p=a.project(y)):"split"===h&&(v>0?(w=_.y+x*(_.x- -180)/(360-v)*(_.y>y.y?-1:1),P.push(o.coordinateToPoint(new t.Coordinate(-180,w),n)),P=P===C?b:C,P.push(o.coordinateToPoint(new t.Coordinate(180,w),n))):(w=_.y+x*(180-_.x)/(360+v)*(_.y>y.y?1:-1),P.push(o.coordinateToPoint(new t.Coordinate(180,w),n)),P=P===C?b:C,P.push(o.coordinateToPoint(new t.Coordinate(-180,w),n))))))),P.push(o._prjToPoint(p,n)));return r=b.length>0?[C,b]:P},_anti:function(t,e){return e>0?t.substract(360,0):t.add(360,0)},_setPrjCoordinates:function(t){this._prjCoords=t,this.onShapeChanged()},_getPrjCoordinates:function(){if(!this._prjCoords){var t=this._coordinates;this._prjCoords=this._projectCoords(t)}return this._prjCoords},_updateCache:function(){delete this._extent,this._getProjection()&&(this._prjCoords&&(this._coordinates=this._unprojectCoords(this._getPrjCoordinates())),this._prjHoles&&(this._holes=this._unprojectCoords(this._getPrjHoles())))},_clearProjection:function(){this._prjCoords=null,this._prjHoles&&(this._prjHoles=null)},_projectCoords:function(t){var e=this._getProjection();return e?e.projectCoords(t):null},_unprojectCoords:function(t){var e=this._getProjection();return e?e.unprojectCoords(t):null},_computeCenter:function(){var e=this._coordinates;if(!t.Util.isArrayHasData(e))return null;for(var i=0,n=0,r=0,o=e.length,s=0;s<o;s++)e[s]&&t.Util.isNumber(e[s].x)&&t.Util.isNumber(e[s].y)&&(i+=e[s].x,n+=e[s].y,r++);return new t.Coordinate(i/r,n/r)},_computeExtent:function(){var e=this._coordinates;if(!t.Util.isArrayHasData(e))return null;var i=[e];return this.hasHoles&&this.hasHoles()&&(i=i.concat(this.getHoles())),this._computeCoordsExtent(i)},_computeCoordsExtent:function(e){for(var i,n,r,o,s=null,a=this.options.antiMeridian,h=0,l=e.length;h<l;h++)for(var u=0,c=e[h].length;u<c;u++)n=e[h][u],u>0&&a&&(o||(o=e[h][u-1]),r=n.x-o.x,Math.abs(r)>180&&(n=this._anti(n,r),o=n)),i=new t.Extent(n,n),s=i.combine(s);return s},_get2DLength:function(){for(var t=this._getPath2DPoints(this._getPrjCoordinates(),!0),e=0,i=1,n=t.length;i<n;i++)e+=t[i].distanceTo(t[i-1]);return e}},t.Marker=t.Geometry.extend({includes:[t.Geometry.Center],type:t.Geometry.TYPE_POINT,options:{symbol:{markerType:"path",markerPath:[{path:"M8 23l0 0 0 0 0 0 0 0 0 0c-4,-5 -8,-10 -8,-14 0,-5 4,-9 8,-9l0 0 0 0c4,0 8,4 8,9 0,4 -4,9 -8,14z M5,9 a3,3 0,1,0,0,-0.9Z",fill:"#DE3333"}],markerPathWidth:16,markerPathHeight:23,markerWidth:24,markerHeight:34}},initialize:function(e,i){!e||e instanceof t.Coordinate||(e=new t.Coordinate(e)),this._coordinates=e,this._initOptions(i)},_canEdit:function(){var e=this._getInternalSymbol();return!t.Util.isArray(e)&&(t.symbolizer.VectorMarkerSymbolizer.test(e)||t.symbolizer.VectorPathMarkerSymbolizer.test(e)||t.symbolizer.ImageMarkerSymbolizer.test(e))},_containsPoint:function(t){return this._getPainter().get2DExtent().contains(t)},_computeExtent:function(){var e=this.getCenter();return e?new t.Extent(e,e):null},_computeGeodesicLength:function(){return 0},_computeGeodesicArea:function(){return 0},_getSprite:function(e){return this._getPainter()?this._getPainter().getSprite(e):new t.Painter(this).getSprite(e)}}),t.TextMarker=t.Marker.extend({options:{box:!0},defaultSymbol:{textFaceName:"monospace",textSize:12,textWrapBefore:!1,textWrapCharacter:"\n",textLineSpacing:8,textHorizontalAlignment:"middle",textVerticalAlignment:"middle",textOpacity:1,textDx:0,textDy:0},defaultBoxSymbol:{markerType:"square",markerLineColor:"#000",markerLineWidth:2,markerLineOpacity:1,markerFill:"#fff",markerOpacity:1},initialize:function(e,i,n){this._content=e,this._coordinates=new t.Coordinate(i),this._initOptions(n),this._registerEvents(),this._refresh()},getContent:function(){return this._content},setContent:function(e){var i=this._content;return e=t.StringUtil.filterContent(e),this._content=e,this._refresh(),this._fireEvent("contentchange",{old:i,new:e}),this},getSymbol:function(){return this._textSymbolChanged?t.Geometry.prototype.getSymbol.call(this):null},setSymbol:function(e){e&&e!==this.options.symbol?this._textSymbolChanged=!0:(this._textSymbolChanged=!1,e={});var i=this._prepareSymbol(e),n=this._getDefaultTextSymbol();return t.Util.extend(n,i),this._symbol=n,this._refresh(),this},onConfig:function(e){var i=!1;for(var n in e)if(e.hasOwnProperty(n)&&"box"===n.slice(0,3)){i=!0;break}return i&&this._refresh(),t.Marker.prototype.onConfig.apply(this,arguments)},_getBoxSize:function(e){e.markerType||(e.markerType="square");var i,n,r=t.StringUtil.splitTextToRow(this._content,e).size;if(this.options.boxAutoSize){var o=this.options.boxPadding;i=r.width+2*o.width,n=r.height+2*o.height}return this.options.boxMinWidth&&(!i||i<this.options.boxMinWidth)&&(i=this.options.boxMinWidth),this.options.boxMinHeight&&(!n||n<this.options.boxMinHeight)&&(n=this.options.boxMinHeight),[i&&n?new t.Size(i,n):null,r]},_getInternalSymbol:function(){return this._symbol},_getDefaultTextSymbol:function(){var e={};return t.Util.extend(e,this.defaultSymbol),this.options.box&&t.Util.extend(e,this.defaultBoxSymbol),e},_registerEvents:function(){this.on("shapechange",this._refresh,this)},onRemove:function(){this.off("shapechange",this._refresh,this)}}),t.Label=t.TextMarker.extend({options:{boxAutoSize:!0,boxMinWidth:0,boxMinHeight:0,boxPadding:{width:12,height:8},boxTextAlign:"middle"},_toJSON:function(t){return{feature:this.toGeoJSON(t),subType:"Label",content:this._content}},_refresh:function(){var e=this.getSymbol()||this._getDefaultTextSymbol();if(e.textName=this._content,this.options.box){var i=this._getBoxSize(e),n=i[0],r=i[1],o=this.options.boxPadding;if(n||e.markerWidth||e.markerHeight)n&&(e.markerWidth=n.width,e.markerHeight=n.height);else{var s=r.width+2*o.width,a=r.height+2*o.height;n=new t.Size(s,a),e.markerWidth=n.width,e.markerHeight=n.height}var h=this.options.boxTextAlign;if(h){var l=t.StringUtil.getAlignPoint(r,e.textHorizontalAlignment,e.textVerticalAlignment),u=e.textDx||0,c=e.textDy||0;l=l._add(u,c),e.markerDx=l.x,e.markerDy=l.y+r.height/2,"left"===h?e.markerDx+=e.markerWidth/2-o.width:"right"===h?e.markerDx-=e.markerWidth/2-r.width-o.width:e.markerDx+=r.width/2}}this._symbol=e,this.onSymbolChanged()}}),t.Label.fromJSON=function(e){var i=e.feature,n=new t.Label(e.content,i.geometry.coordinates,e.options);return n.setProperties(i.properties),n.setId(i.id),n},t.TextBox=t.TextMarker.extend({options:{boxAutoSize:!1,boxMinWidth:0,boxMinHeight:0,boxPadding:{width:12,height:8}},_toJSON:function(t){return{feature:this.toGeoJSON(t),subType:"TextBox",content:this._content}},_refresh:function(){var e=this.getSymbol()||this._getDefaultTextSymbol();e.textName=this._content;var i=this._getBoxSize(e),n=i[0],r=i[1];if(n||e.markerWidth||e.markerHeight)n&&(e.markerWidth=n.width,e.markerHeight=n.height);else{var o=this.options.boxPadding,s=r.width+2*o.width,a=r.height+2*o.height;n=new t.Size(s,a),e.markerWidth=n.width,e.markerHeight=n.height}var h=e.textHorizontalAlignment;h&&(e.textDx=e.markerDx||0,"left"===h?e.textDx-=e.markerWidth/2:"right"===h&&(e.textDx+=e.markerWidth/2));var l=e.textVerticalAlignment;l&&(e.textDy=e.markerDy||0,"top"===l?e.textDy-=e.markerHeight/2:"bottom"===l&&(e.textDy+=e.markerHeight/2)),this._symbol=e,this.onSymbolChanged()},_getInternalSymbol:function(){var e=t.Util.extend({},this._symbol);return"left"===e.textHorizontalAlignment?e.textHorizontalAlignment="right":"right"===e.textHorizontalAlignment&&(e.textHorizontalAlignment="left"),"top"===e.textVerticalAlignment?e.textVerticalAlignment="bottom":"bottom"===e.textVerticalAlignment&&(e.textVerticalAlignment="top"),e}}),t.TextBox.fromJSON=function(e){
var i=e.feature,n=new t.TextBox(e.content,i.geometry.coordinates,e.options);return n.setProperties(i.properties),n.setId(i.id),n},t.Polygon=t.Vector.extend({includes:[t.Geometry.Poly],type:t.Geometry.TYPE_POLYGON,options:{antiMeridian:"continuous"},initialize:function(t,e){this.setCoordinates(t),this._initOptions(e)},setCoordinates:function(e){if(!e)return this._coordinates=null,this._holes=null,this._projectRings(),this;var i=t.GeoJSON.toCoordinates(e),n=i.length;if(t.Util.isArray(i[0])){if(this._coordinates=this._trimRing(i[0]),n>1){for(var r=[],o=1;o<n;o++)i[o]&&r.push(this._trimRing(i[o]));this._holes=r}}else this._coordinates=this._trimRing(i);return this._projectRings(),this},getCoordinates:function(){if(!this._coordinates)return[];if(t.Util.isArrayHasData(this._holes)){for(var e=[],i=0;i<this._holes.length;i++)e.push(this._closeRing(this._holes[i]));return[this._closeRing(this._coordinates)].concat(e)}return[this._closeRing(this._coordinates)]},getShell:function(){return this._coordinates},getHoles:function(){return this.hasHoles()?this._holes:null},hasHoles:function(){return!(!t.Util.isArrayHasData(this._holes)||!t.Util.isArrayHasData(this._holes[0]))},_projectRings:function(){if(!this.getMap())return void this.onShapeChanged();this._prjCoords=this._projectCoords(this._coordinates),this._prjHoles=this._projectCoords(this._holes),this.onShapeChanged()},_cleanRing:function(t){for(var e=t.length-1;e>=0;e--)t[e]||t.splice(e,1)},_checkRing:function(e){if(this._cleanRing(e),!e||!t.Util.isArrayHasData(e))return!1;var i=e[e.length-1],n=!0;return e[0].x===i.x&&e[0].y===i.y||(n=!1),n},_trimRing:function(e){var i=this._checkRing(e);return t.Util.isArrayHasData(e)&&i?e.slice(0,e.length-1):e},_closeRing:function(e){var i=this._checkRing(e);return t.Util.isArrayHasData(e)&&!i?e.concat([new t.Coordinate(e[0].x,e[0].y)]):e},_getPrjHoles:function(){return this._prjHoles||(this._prjHoles=this._projectCoords(this._holes)),this._prjHoles},_computeGeodesicLength:function(e){var i=this.getCoordinates();if(!t.Util.isArrayHasData(i))return 0;for(var n=0,r=0,o=i.length;r<o;r++)n+=t.GeoUtil._computeLength(i[r],e);return n},_computeGeodesicArea:function(e){var i=this.getCoordinates();if(!t.Util.isArrayHasData(i))return 0;for(var n=e.measureArea(i[0]),r=1,o=i.length;r<o;r++)n-=e.measureArea(i[r]);return n},_containsPoint:function(e,i){function n(i){var n=t.GeoUtil.pointInsidePolygon(e,i);if(n)return n;var o,s,a,h,l=i.length;for(o=0,s=l-1;o<l;s=o++)if(a=i[o],h=i[s],t.GeoUtil.distanceToSegment(e,a,h)<=r)return!0;return!1}var r=t.Util.isNil(i)?this._hitTestTolerance():i;if(!this._getPainter().get2DExtent().expand(r).contains(e))return!1;var o=this._getPath2DPoints(this._getPrjCoordinates());if(t.Util.isArray(o[0])){for(var s=0;s<o.length;s++)if(n(o[s]))return!0;return!1}return n(o)}}),t.LineString=t.Polyline=t.Vector.extend({includes:[t.Geometry.Poly],type:t.Geometry.TYPE_LINESTRING,options:{antiMeridian:"continuous",arrowStyle:null,arrowPlacement:"vertex-last"},initialize:function(t,e){this.setCoordinates(t),this._initOptions(e)},setCoordinates:function(e){return e?(this._coordinates=t.GeoJSON.toCoordinates(e),this.getMap()?this._setPrjCoordinates(this._projectCoords(this._coordinates)):this.onShapeChanged(),this):(this._coordinates=null,this._setPrjCoordinates(null),this)},getCoordinates:function(){return this._coordinates?this._coordinates:[]},animateShow:function(e){e||(e={});var i=this.getCoordinates(),n=e.duration||1e3,r=this.getLength(),o=e.easing||"out";this.setCoordinates([]);var s=t.Animation.animate({t:n},{speed:n,easing:o},t.Util.bind(function(t){if(!this.getMap())return s.finish(),void this.setCoordinates(i);this._drawAnimFrame(t.styles.t,n,r,i)},this));return s.play(),this},_drawAnimFrame:function(e,i,n,r){if(0===e)return void this.setCoordinates([]);var o=this.getMap(),s=e/i*n;this._animIdx||(this._animIdx=0,this._animLenSoFar=0,this.show());var a,h,l=0;for(a=this._animIdx,h=r.length;a<h-1&&(l=o.computeLength(r[a],r[a+1]),!(this._animLenSoFar+l>s));a++)this._animLenSoFar+=l;if(this._animIdx=a,this._animIdx>=h-1)return void this.setCoordinates(r);var u=this._animIdx,c=r[u],d=r[u+1],m=s-this._animLenSoFar,f=m/l,g=c.x+(d.x-c.x)*f,p=c.y+(d.y-c.y)*f,_=new t.Coordinate(g,p),y=r.slice(0,this._animIdx+1);y.push(_),this.setCoordinates(y)},_computeGeodesicLength:function(e){return t.GeoUtil._computeLength(this.getCoordinates(),e)},_computeGeodesicArea:function(){return 0},_containsPoint:function(e,i){function n(i){var n,o,s,a=i.length;for(n=0,a=i.length;n<a-1;n++)if(o=i[n],s=i[n+1],t.GeoUtil.distanceToSegment(e,o,s)<=r)return!0;return!1}var r=t.Util.isNil(i)?this._hitTestTolerance():i;r<3&&(r=3);var o=this._getArrowStyle(),s=this._getInternalSymbol().lineWidth,a=this.getMap(),h=this._getPrjExtent(),l=new t.Coordinate(h.xmin,h.ymax),u=new t.Coordinate(h.xmax,h.ymin),c=a._prjToPoint(l),d=a._prjToPoint(u),m=new t.PointExtent(c.x-r,c.y-r,d.x+r,d.y+r);if(o&&m._expand(Math.max(o[0]*s,o[1]*s)),!m.contains(e))return!1;var f;if(this._getArrowStyle()){f=this._getPath2DPoints(this._getPrjCoordinates(),!0);for(var g=this._getArrows(f,s,(i?i:2)+s/2),p=g.length-1;p>=0;p--)if(t.GeoUtil.pointInsidePolygon(e,g[p]))return!0}if(f=f||this._getPath2DPoints(this._getPrjCoordinates()),f.length>0&&t.Util.isArray(f[0])){for(var _=0,y=f.length;_<y;_++)if(n(f[_]))return!0;return!1}return n(f)}}),t.Curve=t.LineString.extend({_arc:function(e,i,n){for(var r=this.options.arcDegree*Math.PI/180,o=1,s=i.length;o<s;o++)t.Canvas._arcBetween(e,i[o-1],i[o],r),t.Canvas._stroke(e,n)},_quadraticCurve:function(e,i){if(i.length<=2)return void t.Canvas._path(e,i);t.Canvas.quadraticCurve(e,i)},_getCubicCurvePoints:function(t){for(var e,i,n,r,o=[],s=0,a=0,h=0,l=t[0],u=1,c=t.length;u<c;u++)n=t[u],r=t[u+1],r?(s=(r.y-l.y)/(r.x-l.x),e=(r.x-n.x)*-.3,i=e*s*.6):(e=0,i=0),o.push(l.x-a,l.y-h,n.x+e,n.y+i,n.x,n.y),a=e,h=i,l=n;return o},_bezierCurve:function(e,i){if(i.length<=2)return void t.Canvas._path(e,i);var n,r=this._getCubicCurvePoints(i),o=r.length;for(n=0;n<o;n+=6)e.bezierCurveTo(r[n],r[n+1],r[n+2],r[n+3],r[n+4],r[n+5])}}),t.ArcCurve=t.Curve.extend({options:{arcDegree:90},_toJSON:function(t){return{feature:this.toGeoJSON(t),subType:"ArcCurve"}},_paintOn:function(e,i,n){e.beginPath(),this._arc(e,i,n),t.Canvas._stroke(e,n),this._paintArrow(e,i,n)}}),t.ArcCurve.fromJSON=function(e){var i=e.feature,n=new t.ArcCurve(i.geometry.coordinates,e.options);return n.setProperties(i.properties),n},t.QuadBezierCurve=t.Curve.extend({_toJSON:function(t){return{feature:this.toGeoJSON(t),subType:"QuadBezierCurve"}},_paintOn:function(e,i,n){e.beginPath(),e.moveTo(i[0].x,i[0].y),this._quadraticCurve(e,i,n),t.Canvas._stroke(e,n),this._paintArrow(e,i,n)},_getArrowPlacement:function(){var t=this.options.arrowPlacement;return"point"===t&&(t="vertex-last"),t}}),t.QuadBezierCurve.fromJSON=function(e){var i=e.feature,n=new t.QuadBezierCurve(i.geometry.coordinates,e.options);return n.setProperties(i.properties),n},t.CubicBezierCurve=t.Curve.extend({_toJSON:function(t){return{feature:this.toGeoJSON(t),subType:"CubicBezierCurve"}},_paintOn:function(e,i,n){e.beginPath(),e.moveTo(i[0].x,i[0].y),this._bezierCurve(e,i,n),t.Canvas._stroke(e,n),this._paintArrow(e,i,n)}}),t.CubicBezierCurve.fromJSON=function(e){var i=e.feature,n=new t.CubicBezierCurve(i.geometry.coordinates,e.options);return n.setProperties(i.properties),n},function(){var e={initialize:function(t,e,i){1===arguments.length&&(i=t,t=null,e=null),this._connSource=t,this._connTarget=e,this._initOptions(i),this._registEvents()},getConnectSource:function(){return this._connSource},setConnectSource:function(t){var e=this._connTarget;return this.onRemove(),this._connSource=t,this._connTarget=e,this._updateCoordinates(),this._registEvents(),this},getConnectTarget:function(){return this._connTarget},setConnectTarget:function(t){var e=this._connSource;return this.onRemove(),this._connSource=e,this._connTarget=t,this._updateCoordinates(),this._registEvents(),this},_updateCoordinates:function(){var e=this.getMap();if(!e&&this._connSource&&(e=this._connSource.getMap()),!e&&this._connTarget&&(e=this._connTarget.getMap()),e&&this._connSource&&this._connTarget){for(var i,n,r=this._connSource._getConnectPoints(),o=this._connTarget._getConnectPoints(),s=0,a=this.getCoordinates(),h=0,l=r.length;h<l;h++)for(var u=r[h],c=0,d=o.length;c<d;c++){var m=o[c],f=e.computeLength(u,m);0===h&&0===c?(i=u,n=m,s=f):f<s&&(i=u,n=m)}t.Util.isArrayHasData(a)&&a[0].equals(i)&&a[1].equals(n)||this.setCoordinates([i,n])}},onRemove:function(){this._connSource&&(this._connSource.__connectors&&t.Util.removeFromArray(this,this._connSource.__connectors),this._connSource.off("dragging positionchange",this._updateCoordinates,this).off("remove",this.onRemove,this),this._connSource.off("dragstart mousedown mouseover",this._showConnect,this),this._connSource.off("dragend mouseup mouseout",this.hide,this),this._connSource.off("show",this._showConnect,this).off("hide",this.hide,this),delete this._connSource),this._connTarget&&(t.Util.removeFromArray(this,this._connTarget.__connectors),this._connTarget.off("dragging positionchange",this._updateCoordinates,this).off("remove",this.onRemove,this),this._connTarget.off("show",this._showConnect,this).off("hide",this.hide,this),delete this._connTarget)},_showConnect:function(){this._connSource&&this._connTarget&&(this._connSource instanceof t.control.Control||this._connSource.isVisible())&&(this._connTarget instanceof t.control.Control||this._connTarget.isVisible())&&(this._updateCoordinates(),this.show())},_registEvents:function(){if(this._connSource&&this._connTarget){this._connSource.__connectors||(this._connSource.__connectors=[]),this._connTarget.__connectors||(this._connTarget.__connectors=[]),this._connSource.__connectors.push(this),this._connTarget.__connectors.push(this),this._connSource.on("dragging positionchange",this._updateCoordinates,this).on("remove",this.remove,this),this._connTarget.on("dragging positionchange",this._updateCoordinates,this).on("remove",this.remove,this),this._connSource.on("show",this._showConnect,this).on("hide",this.hide,this),this._connTarget.on("show",this._showConnect,this).on("hide",this.hide,this);var t=this.options.showOn;this.hide(),"moving"===t?(this._connSource.on("dragstart",this._showConnect,this).on("dragend",this.hide,this),this._connTarget.on("dragstart",this._showConnect,this).on("dragend",this.hide,this)):"click"===t?(this._connSource.on("mousedown",this._showConnect,this).on("mouseup",this.hide,this),this._connTarget.on("mousedown",this._showConnect,this).on("mouseup",this.hide,this)):"mouseover"===t?(this._connSource.on("mouseover",this._showConnect,this).on("mouseout",this.hide,this),this._connTarget.on("mouseover",this._showConnect,this).on("mouseout",this.hide,this)):this._showConnect()}}};t.ConnectorLine=t.LineString.extend({includes:[e],options:{showOn:"always"}}),t.Util.extend(t.ConnectorLine,{_hasConnectors:function(e){return!t.Util.isNil(e.__connectors)&&e.__connectors.length>0},_getConnectors:function(t){return t.__connectors}}),t.ArcConnectorLine=t.ArcCurve.extend({includes:[e],options:{showOn:"always"}})}(),t.Ellipse=t.Polygon.extend({includes:[t.Geometry.Center],options:{numberOfShellPoints:60},initialize:function(e,i,n,r){this._coordinates=new t.Coordinate(e),this.width=i,this.height=n,this._initOptions(r)},getWidth:function(){return this.width},setWidth:function(t){return this.width=t,this.onShapeChanged(),this},getHeight:function(){return this.height},setHeight:function(t){return this.height=t,this.onShapeChanged(),this},getShell:function(){for(var t,e,i,n,r=this._getMeasurer(),o=this.getCoordinates(),s=this.options.numberOfShellPoints,a=this.getWidth(),h=this.getHeight(),l=[],u=Math.pow(a/2,2)*Math.pow(h/2,2),c=Math.pow(a/2,2),d=Math.pow(h/2,2),m=0;m<s;m++){t=360*m/s,e=t*Math.PI/180,i=Math.sqrt(u/(c*Math.pow(Math.tan(e),2)+d)),n=Math.sqrt(u/(d*Math.pow(1/Math.tan(e),2)+c)),t>90&&t<270&&(i*=-1),t>180&&t<360&&(n*=-1);var f=r.locate(o,i,n);l.push(f)}return l},getHoles:function(){return null},_containsPoint:function(e,i){var n,r,o,s=this.getMap(),a=t.Util.isNil(i)?this._hitTestTolerance():i,h=s.distanceToPixel(this.width/2,0),l=s.distanceToPixel(0,this.height/2),u=h.width,c=l.height,d=Math.sqrt(Math.abs(u*u-c*c)),m=u>=c,f=this._getCenter2DPoint();return m?(n=new t.Point(f.x-d,f.y),r=new t.Point(f.x+d,f.y),o=2*u):(n=new t.Point(f.x,f.y-d),r=new t.Point(f.x,f.y+d),o=2*c),e=new t.Point(e.x,e.y),e.distanceTo(n)+e.distanceTo(r)<=o+2*a},_computeExtent:function(e){if(!e||!this._coordinates||t.Util.isNil(this.width)||t.Util.isNil(this.height))return null;var i=this.getWidth(),n=this.getHeight(),r=e.locate(this._coordinates,i/2,n/2),o=e.locate(this._coordinates,-i/2,-n/2);return new t.Extent(r,o)},_computeGeodesicLength:function(){if(t.Util.isNil(this.width)||t.Util.isNil(this.height))return 0;var e=this.width>this.height?this.width:this.height;return 2*Math.PI*e/2-4*Math.abs(this.width-this.height)},_computeGeodesicArea:function(){return t.Util.isNil(this.width)||t.Util.isNil(this.height)?0:Math.PI*this.width*this.height/4},_exportGeoJSONGeometry:function(){return{type:"Polygon",coordinates:t.GeoJSON.toNumberArrays([this.getShell()])}},_toJSON:function(e){var i=t.Util.extend({},e),n=this.getCenter();i.geometry=!1;var r=this.toGeoJSON(i);return r.geometry={type:"Polygon"},{feature:r,subType:"Ellipse",coordinates:[n.x,n.y],width:this.getWidth(),height:this.getHeight()}}}),t.Ellipse.fromJSON=function(e){var i=e.feature,n=new t.Ellipse(e.coordinates,e.width,e.height,e.options);return n.setProperties(i.properties),n},t.Circle=t.Polygon.extend({includes:[t.Geometry.Center],options:{numberOfShellPoints:60},initialize:function(e,i,n){this._coordinates=new t.Coordinate(e),this._radius=i,this._initOptions(n)},getRadius:function(){return this._radius},setRadius:function(t){return this._radius=t,this.onShapeChanged(),this},getShell:function(){for(var t,e,i,n=this._getMeasurer(),r=this.getCoordinates(),o=this.options.numberOfShellPoints,s=this.getRadius(),a=[],h=0;h<o;h++){t=360*h/o*Math.PI/180,e=s*Math.cos(t),i=s*Math.sin(t);var l=n.locate(r,e,i);a.push(l)}return a},getHoles:function(){return null},_containsPoint:function(e,i){var n=this._getCenter2DPoint(),r=this.getSize(),o=t.Util.isNil(i)?this._hitTestTolerance():i;return n.distanceTo(e)<=r.width/2+o},_computeExtent:function(e){if(!e||!this._coordinates||t.Util.isNil(this._radius))return null;var i=this._radius,n=e.locate(this._coordinates,i,i),r=e.locate(this._coordinates,-i,-i);return new t.Extent(n,r)},_computeGeodesicLength:function(){return t.Util.isNil(this._radius)?0:2*Math.PI*this._radius},_computeGeodesicArea:function(){return t.Util.isNil(this._radius)?0:Math.PI*Math.pow(this._radius,2)},_exportGeoJSONGeometry:function(){return{type:"Polygon",coordinates:t.GeoJSON.toNumberArrays([this.getShell()])}},_toJSON:function(e){var i=this.getCenter(),n=t.Util.extend({},e);n.geometry=!1;var r=this.toGeoJSON(n);return r.geometry={type:"Polygon"},{feature:r,subType:"Circle",coordinates:[i.x,i.y],radius:this.getRadius()}}}),t.Circle.fromJSON=function(e){var i=e.feature,n=new t.Circle(e.coordinates,e.radius,e.options);return n.setProperties(i.properties),n},t.Sector=t.Polygon.extend({includes:[t.Geometry.Center],options:{numberOfShellPoints:60},initialize:function(e,i,n,r,o){this._coordinates=new t.Coordinate(e),this._radius=i,this.startAngle=n,this.endAngle=r,this._initOptions(o)},getRadius:function(){return this._radius},setRadius:function(t){return this._radius=t,this.onShapeChanged(),this},getStartAngle:function(){return this.startAngle},setStartAngle:function(t){return this.startAngle=t,this.onShapeChanged(),this},getEndAngle:function(){return this.endAngle},setEndAngle:function(t){return this.endAngle=t,this.onShapeChanged(),this},getShell:function(){for(var t,e,i,n=this._getMeasurer(),r=this.getCoordinates(),o=this.options.numberOfShellPoints,s=this.getRadius(),a=[],h=this.getEndAngle()-this.getStartAngle(),l=0;l<o;l++){t=(h*l/(o-1)+this.getStartAngle())*Math.PI/180,e=s*Math.cos(t),i=s*Math.sin(t);var u=n.locate(r,e,i);a.push(u)}return a},getHoles:function(){return null},_containsPoint:function(e,i){var n=this._getCenter2DPoint(),r=t.Util.isNil(i)?this._hitTestTolerance():i,o=this.getSize(),s=n,a=e,h=a.x-s.x,l=s.y-a.y,u=Math.atan2(l,h),c=u<0?360*(u+2*Math.PI)/(2*Math.PI):360*u/(2*Math.PI),d=this.startAngle%360,m=this.endAngle%360,f=!1;return f=d>m?!(c>m&&c<d):c>=d&&c<=m,a.distanceTo(s)<=o.width/2+r&&f},_computeExtent:function(e){if(!e||!this._coordinates||t.Util.isNil(this._radius))return null;var i=this._radius,n=e.locate(this._coordinates,i,i),r=e.locate(this._coordinates,-i,-i);return new t.Extent(n,r)},_computeGeodesicLength:function(){return t.Util.isNil(this._radius)?0:2*Math.PI*this._radius*Math.abs(this.startAngle-this.endAngle)/360+2*this._radius},_computeGeodesicArea:function(){return t.Util.isNil(this._radius)?0:Math.PI*Math.pow(this._radius,2)*Math.abs(this.startAngle-this.endAngle)/360},_exportGeoJSONGeometry:function(){return{type:"Polygon",coordinates:t.GeoJSON.toNumberArrays([this.getShell()])}},_toJSON:function(e){var i=t.Util.extend({},e),n=this.getCenter();i.geometry=!1;var r=this.toGeoJSON(i);return r.geometry={type:"Polygon"},{feature:r,subType:"Sector",coordinates:[n.x,n.y],radius:this.getRadius(),startAngle:this.getStartAngle(),endAngle:this.getEndAngle()}}}),t.Sector.fromJSON=function(e){var i=e.feature,n=new t.Sector(e.coordinates,e.radius,e.startAngle,e.endAngle,e.options);return n.setProperties(i.properties),n},t.Rectangle=t.Polygon.extend({initialize:function(e,i,n,r){this._coordinates=new t.Coordinate(e),this._width=i,this._height=n,this._initOptions(r)},getCoordinates:function(){return this._coordinates},setCoordinates:function(e){if(this._coordinates=new t.Coordinate(e),!this._coordinates||!this.getMap())return this.onPositionChanged(),this;var i=this._getProjection();return this._setPrjCoordinates(i.project(this._coordinates)),this},getWidth:function(){return this._width},setWidth:function(t){return this._width=t,this.onShapeChanged(),this},getHeight:function(){return this._height},setHeight:function(t){return this._height=t,this.onShapeChanged(),this},getShell:function(){var t=this._getMeasurer(),e=this._coordinates,i=this.getMap(),n=-1;if(i){var r=i.getFullExtent();r.bottom>r.top&&(n=1)}var o=[];return o.push(e),o.push(t.locate(e,this._width,0)),o.push(t.locate(e,this._width,n*this._height)),o.push(t.locate(e,0,n*this._height)),o.push(e),o},getHoles:function(){return null},_getPrjCoordinates:function(){var t=this._getProjection();return t?(this._pnw||this._coordinates&&(this._pnw=t.project(this._coordinates)),this._pnw):null},_setPrjCoordinates:function(t){this._pnw=t,this.onPositionChanged()},_updateCache:function(){delete this._extent;var t=this._getProjection();this._pnw&&t&&(this._coordinates=t.unproject(this._pnw))},_clearProjection:function(){this._pnw=null},_computeCenter:function(t){return t.locate(this._coordinates,this._width/2,-this._height/2)},_containsPoint:function(e,i){var n=this.getMap(),r=t.Util.isNil(i)?this._hitTestTolerance():i,o=n.coordinateToPoint(this._coordinates),s=n.distanceToPixel(this._width,this._height),a=new t.Point(o.x,o.y),h=new t.Point(o.x+s.width,o.y+s.height),l=new t.PointExtent(a.x-r,a.y-r,h.x+r,h.y+r);return e=new t.Point(e.x,e.y),l.contains(e)},_computeExtent:function(e){if(!e||!this._coordinates||t.Util.isNil(this._width)||t.Util.isNil(this._height))return null;var i=this.getWidth(),n=this.getHeight(),r=e.locate(this._coordinates,i,-n);return new t.Extent(r,this._coordinates)},_computeGeodesicLength:function(){return t.Util.isNil(this._width)||t.Util.isNil(this._height)?0:2*(this._width+this._height)},_computeGeodesicArea:function(){return t.Util.isNil(this._width)||t.Util.isNil(this._height)?0:this._width*this._height},_exportGeoJSONGeometry:function(){return{type:"Polygon",coordinates:t.GeoJSON.toNumberArrays([this.getShell()])}},_toJSON:function(e){var i=t.Util.extend({},e),n=this.getCoordinates();i.geometry=!1;var r=this.toGeoJSON(i);return r.geometry={type:"Polygon"},{feature:r,subType:"Rectangle",coordinates:[n.x,n.y],width:this.getWidth(),height:this.getHeight()}}}),t.Rectangle.fromJSON=function(e){var i=e.feature,n=new t.Rectangle(e.coordinates,e.width,e.height,e.options);return n.setProperties(i.properties),n},t.GeometryCollection=t.Geometry.extend({type:t.Geometry.TYPE_GEOMETRYCOLLECTION,initialize:function(t,e){this._initOptions(e),this.setGeometries(t)},setGeometries:function(e){var i=this._checkGeometries(e);if(t.Util.isArray(i))for(var n=i.length-1;n>=0;n--)i[n]._initOptions(this.config()),i[n]._setParent(this),i[n]._setEventParent(this),i[n].setSymbol(this.getSymbol());return this._geometries=i,this.getLayer()&&(this._bindGeometriesToLayer(),this.onShapeChanged()),this},getGeometries:function(){return this._geometries?this._geometries:[]},forEach:function(t,e){for(var i=this.getGeometries(),n=0,r=i.length;n<r;n++)i[n]&&(e?t.call(e,i[n],n):t(i[n],n));return this},filter:function(){return t.VectorLayer.prototype.filter.apply(this,arguments)},translate:function(t){return t?this.isEmpty()?this:(this.forEach(function(e){e&&e.translate&&e.translate(t)}),this):this},isEmpty:function(){return!t.Util.isArrayHasData(this.getGeometries())},remove:function(){return this.forEach(function(t){t._unbind()}),t.Geometry.prototype.remove.apply(this,arguments)},show:function(){return this.options.visible=!0,this.forEach(function(t){t.show()}),this},hide:function(){return this.options.visible=!1,this.forEach(function(t){t.hide()}),this},setSymbol:function(t){return t=this._prepareSymbol(t),this._symbol=t,this.forEach(function(e){e.setSymbol(t)}),this.onSymbolChanged(),this},onConfig:function(t){this.forEach(function(e){e.config(t)})},_setExternSymbol:function(t){return t=this._prepareSymbol(t),this._externSymbol=t,this.forEach(function(e){e._setExternSymbol(t)}),this.onSymbolChanged(),this},_bindLayer:function(){t.Geometry.prototype._bindLayer.apply(this,arguments),this._bindGeometriesToLayer()},_bindGeometriesToLayer:function(){var t=this.getLayer();this.forEach(function(e){e._bindLayer(t)})},_checkGeometries:function(e){if(e&&!t.Util.isArray(e)){if(e instanceof t.Geometry)return[e];throw new Error("The geometry added to collection is invalid.")}if(t.Util.isArray(e)){for(var i=0,n=e.length;i<n;i++)if(!(e[i]instanceof t.Geometry))throw new Error("The geometry added to collection is invalid. Index: "+i);return e}return null},_updateCache:function(){delete this._extent,this.isEmpty()||this.forEach(function(t){t&&t._updateCache&&t._updateCache()})},_removePainter:function(){this._painter&&this._painter.remove(),delete this._painter,this.forEach(function(t){t._removePainter()})},_computeCenter:function(e){if(!e||this.isEmpty())return null;for(var i=0,n=0,r=0,o=this.getGeometries(),s=0,a=o.length;s<a;s++)if(o[s]){var h=o[s]._computeCenter(e);h&&(i+=h.x,n+=h.y,r++)}return 0===r?null:new t.Coordinate(i/r,n/r)},_containsPoint:function(t,e){if(this.isEmpty())return!1;var i,n,r=this.getGeometries();for(i=0,n=r.length;i<n;i++)if(r[i]._containsPoint(t,e))return!0;return!1},_computeExtent:function(t){if(this.isEmpty())return null;for(var e=this.getGeometries(),i=null,n=0,r=e.length;n<r;n++)if(e[n]){var o=e[n]._computeExtent(t);o&&(i=o.combine(i))}return i},_computeGeodesicLength:function(t){if(!t||this.isEmpty())return 0;for(var e=this.getGeometries(),i=0,n=0,r=e.length;n<r;n++)e[n]&&(i+=e[n]._computeGeodesicLength(t));return i},_computeGeodesicArea:function(t){if(!t||this.isEmpty())return 0;for(var e=this.getGeometries(),i=0,n=0,r=e.length;n<r;n++)e[n]&&(i+=e[n]._computeGeodesicArea(t));return i},_exportGeoJSONGeometry:function(){var t=[];if(!this.isEmpty())for(var e=this.getGeometries(),i=0,n=e.length;i<n;i++)e[i]&&t.push(e[i]._exportGeoJSONGeometry());return{type:"GeometryCollection",geometries:t}},_clearProjection:function(){if(!this.isEmpty())for(var t=this.getGeometries(),e=0,i=t.length;e<i;e++)t[e]&&t[e]._clearProjection()},_getConnectPoints:function(){var e=this.getExtent();return[new t.Coordinate(e.xmin,e.ymax),new t.Coordinate(e.xmax,e.ymin),new t.Coordinate(e.xmin,e.ymin),new t.Coordinate(e.xmax,e.ymax)]},_getExternalResources:function(){if(this.isEmpty())return null;var e,i,n,r,o,s,a,h=this.getGeometries(),l=[],u={};for(e=0,i=h.length;e<i;e++)if(h[e]&&(o=h[e]._getInternalSymbol(),s=t.Util.getExternalResources(o)))for(n=0,r=s.length;n<r;n++)a=s[n].join(),u[a]||(l.push(s[n]),u[a]=1);return l},startEdit:function(t){if(this.isEmpty())return this;t||(t={}),t.symbol&&(this._originalSymbol=this.getSymbol(),this.setSymbol(t.symbol)),this._draggbleBeforeEdit=this.options.draggable,this.config("draggable",!1);for(var e=this.getGeometries(),i=0,n=e.length;i<n;i++)e[i].startEdit(t);this._editing=!0,this.hide();var r=this;return setTimeout(function(){r.fire("editstart")},1),this},endEdit:function(){if(this.isEmpty())return this;for(var t=this.getGeometries(),e=0,i=t.length;e<i;e++)t[e].endEdit();return this._originalSymbol&&(this.setSymbol(this._originalSymbol),delete this._originalSymbol),this._editing=!1,this.show(),this.config("draggable",this._draggbleBeforeEdit),this.fire("editend"),this},isEditing:function(){return!!this._editing}}),t.Geometry.MultiPoly={getCoordinates:function(){var e=[],i=this.getGeometries();if(!t.Util.isArray(i))return null;for(var n=0,r=i.length;n<r;n++)e.push(i[n].getCoordinates());return e},setCoordinates:function(e){if(t.Util.isArrayHasData(e)){for(var i=[],n=0,r=e.length;n<r;n++){var o=new this.GeometryType(e[n],this.config());i.push(o)}this.setGeometries(i)}else this.setGeometries([]);return this},_initData:function(e){t.Util.isArrayHasData(e)&&(e[0]instanceof this.GeometryType?this.setGeometries(e):this.setCoordinates(e))},_checkGeometries:function(e){if(t.Util.isArray(e))for(var i=0,n=e.length;i<n;i++)if(e[i]&&!(e[i]instanceof this.GeometryType))throw new Error("Geometry is not valid for collection, index:"+i);return e},_exportGeoJSONGeometry:function(){var e=this.getCoordinates(),i=t.GeoJSON.toNumberArrays(e);return{type:this.getType(),coordinates:i}}},t.MultiPoint=t.GeometryCollection.extend({includes:[t.Geometry.MultiPoly],GeometryType:t.Marker,type:t.Geometry.TYPE_MULTIPOINT,initialize:function(t,e){this._initOptions(e),this._initData(t)}}),t.MultiLineString=t.MultiPolyline=t.GeometryCollection.extend({includes:[t.Geometry.MultiPoly],GeometryType:t.Polyline,type:t.Geometry.TYPE_MULTILINESTRING,initialize:function(t,e){this._initOptions(e),this._initData(t)}}),t.MultiPolygon=t.GeometryCollection.extend({includes:[t.Geometry.MultiPoly],GeometryType:t.Polygon,type:t.Geometry.TYPE_MULTIPOLYGON,initialize:function(t,e){this._initOptions(e),this._initData(t)}}),t.GeoJSON={toGeometry:function(e){if(t.Util.isString(e)&&(e=t.Util.parseJSON(e)),t.Util.isArray(e)){for(var i=[],n=0,r=e.length;n<r;n++){var o=this._convert(e[n]);t.Util.isArray(o)?i=i.concat(o):i.push(o)}return i}return this._convert(e)},toNumberArrays:function(e){return t.Util.isArray(e)?t.Util.mapArrayRecursively(e,function(t){return[t.x,t.y]}):[e.x,e.y]},toCoordinates:function(e){if(t.Util.isNumber(e[0])&&t.Util.isNumber(e[1]))return new t.Coordinate(e);for(var i=[],n=0,r=e.length;n<r;n++){var o=e[n];t.Util.isArray(o)?t.Util.isNumber(o[0])?i.push(new t.Coordinate(o)):i.push(this.toCoordinates(o)):i.push(new t.Coordinate(o))}return i},_convert:function(e){if(!e||t.Util.isNil(e.type))return null;var i={},n=e.type;if("Feature"===n){var r=e.geometry,o=this._convert(r);return o?(o.setId(e.id),o.setProperties(e.properties),o):null}if("FeatureCollection"===n){var s=e.features;if(!s)return null;return t.GeoJSON.toGeometry(s)}if(t.Util.indexOfArray(n,["Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon"])>=0){return new t["Point"===n?"Marker":n](e.coordinates,i)}if("GeometryCollection"===n){var a=e.geometries;if(!t.Util.isArrayHasData(a))return new t.GeometryCollection;for(var h=[],l=a.length,u=0;u<l;u++)h.push(this._convert(a[u]));return new t.GeometryCollection(h,i)}return"Circle"===n?new t.Circle(e.coordinates,e.radius,i):"Ellipse"===n||"Rectangle"===n?new t[n](e.coordinates,e.width,e.height,i):"Sector"===n?new t.Sector(e.coordinates,e.radius,e.startAngle,e.endAngle,i):null}},t.Geometry.Editor=t.Class.extend({includes:[t.Eventable],editStageLayerIdPrefix:t.internalLayerPrefix+"_edit_stage_",initialize:function(e,i){this._geometry=e,this._geometry&&t.Util.setOptions(this,i)},getMap:function(){return this._geometry.getMap()},prepare:function(){this.getMap()&&(this.options.symbol&&(this._originalSymbol=this._geometry.getSymbol(),this._geometry.setSymbol(this.options.symbol)),this._prepareEditStageLayer())},_prepareEditStageLayer:function(){var e=this.getMap(),i=t.Util.UID();this._editStageLayer=e.getLayer(this.editStageLayerIdPrefix+i),this._editStageLayer||(this._editStageLayer=new t.VectorLayer(this.editStageLayerIdPrefix+i),e.addLayer(this._editStageLayer))},start:function(){if(this._geometry&&this._geometry.getMap()&&!this._geometry.editing){this.editing=!0;var e=this._geometry;this._geometryDraggble=e.options.draggable,e.config("draggable",!1),this.prepare();var i=e.copy();i.setSymbol(e._getInternalSymbol()),i.copyEventListeners(e),e._getParent()&&i.copyEventListeners(e._getParent()),i.setId(null).config({draggable:!1}),this._shadow=i,this._switchGeometryEvents("on"),e.hide(),(e instanceof t.Marker||e instanceof t.Circle||e instanceof t.Rectangle||e instanceof t.Ellipse)&&this._createOrRefreshOutline(),this._editStageLayer.bringToFront().addGeometry(i),e instanceof t.Marker?(i.config("draggable",!0),i.on("dragend",this._onShadowDragEnd,this)):this._createCenterHandle(),e instanceof t.Marker?this.createMarkerEditor():e instanceof t.Circle?this.createCircleEditor():e instanceof t.Rectangle?this.createEllipseOrRectEditor():e instanceof t.Ellipse?this.createEllipseOrRectEditor():e instanceof t.Sector||(e instanceof t.Polygon||e instanceof t.Polyline)&&this.createPolygonEditor()}},stop:function(){if(this._switchGeometryEvents("off"),this.getMap()){if(this._shadow&&(this._update(),this._shadow._clearAllListeners(),this._shadow.remove(),delete this._shadow),this._geometry.config("draggable",this._geometryDraggble),delete this._geometryDraggble,this._geometry.show(),this._editStageLayer.remove(),t.Util.isArrayHasData(this._eventListeners)){for(var e=this._eventListeners.length-1;e>=0;e--){var i=this._eventListeners[e];i[0].off(i[1],i[2],this)}this._eventListeners=[]}this._refreshHooks=[],this.options.symbol&&(this._geometry.setSymbol(this._originalSymbol),delete this._originalSymbol),this.editing=!1}},isEditing:function(){return!t.Util.isNil(this.editing)&&this.editing},_getGeometryEvents:function(){return{symbolchange:this._onGeometrySymbolChange}},_switchGeometryEvents:function(t){if(this._geometry){var e=this._getGeometryEvents();for(var i in e)this._geometry[t](i,e[i],this)}},_onGeometrySymbolChange:function(t){this._shadow&&this._shadow.setSymbol(t.target._getInternalSymbol())},_onShadowDragEnd:function(){this._update(),this._refresh()},_update:function(){this._geometry.setCoordinates(this._shadow.getCoordinates()),this._geometry.getRadius&&this._geometry.setRadius(this._shadow.getRadius()),this._geometry.getWidth&&this._geometry.setWidth(this._shadow.getWidth()),this._geometry.getHeight&&this._geometry.setHeight(this._shadow.getHeight()),this._geometry.getStartAngle&&this._geometry.setStartAngle(this._shadow.getStartAngle()),this._geometry.getEndAngle&&this._geometry.setEndAngle(this._shadow.getEndAngle())},_updateAndFireEvent:function(t){this._shadow&&(this._update(),this._geometry.fire(t))},_createOrRefreshOutline:function(){var e=this._geometry,i=this.getMap(),n=this._editOutline,r=e._getPainter().get2DExtent(),o=r.getSize(),s=i.pointToCoordinate(r.getMin()),a=i.pixelToDistance(o.width,0),h=i.pixelToDistance(0,o.height);return n?(n.setCoordinates(s),n.setWidth(a),n.setHeight(h)):(n=new t.Rectangle(s,a,h,{symbol:{lineWidth:1,lineColor:"6b707b"}}),
this._editStageLayer.addGeometry(n),this._editOutline=n,this._addRefreshHook(this._createOrRefreshOutline)),n},_createCenterHandle:function(){var e,i=this,n=this._shadow.getCenter(),r=i.createHandle(n,{markerType:"ellipse",dxdy:new t.Point(0,0),cursor:"move",onDown:function(){e=this._shadow.copy();var i=t.Util.lowerSymbolOpacity(e._getInternalSymbol(),.5);e.setSymbol(i).addTo(this._editStageLayer)},onMove:function(t,i){var n=i.dragOffset;e&&(e.translate(n),this._geometry.translate(n))},onUp:function(){e&&(this._shadow.setCoordinates(this._geometry.getCoordinates()),e.remove(),i._refresh())}});this._addRefreshHook(function(){var t=this._shadow.getCenter();r.setCoordinates(t)})},_createHandleInstance:function(e,i){var n={markerType:i.markerType,markerFill:"#ffffff",markerLineColor:"#000000",markerLineWidth:2,markerWidth:10,markerHeight:10,markerDx:i.dxdy.x,markerDy:i.dxdy.y};return i.symbol&&t.Util.extend(n,i.symbol),new t.Marker(e,{draggable:!0,dragShadow:!1,dragOnAxis:i.axis,cursor:i.cursor,symbol:n})},createHandle:function(t,e){function i(t){e.onDown&&e.onDown.call(a,t.viewPoint,t)}function n(t){a._hideContext();var i=o._prjToViewPoint(s._getPrjCoordinates());e.onMove&&e.onMove.call(a,i,t)}function r(t){e.onUp&&e.onUp.call(a,t)}e||(e={});var o=this.getMap(),s=this._createHandleInstance(t,e),a=this;return s.on("dragstart",i,this),s.on("dragging",n,this),s.on("dragend",r,this),e.onRefresh&&(s["maptalks--editor-refresh-fn"]=e.onRefresh),this._editStageLayer.addGeometry(s),s},_createResizeHandles:function(e,i){function n(e){return[e.getMin(),new t.Point((e.xmax+e.xmin)/2,e.ymin),new t.Point(e.xmax,e.ymin),new t.Point(e.xmin,(e.ymax+e.ymin)/2),new t.Point(e.xmax,(e.ymax+e.ymin)/2),new t.Point(e.xmin,e.ymax),new t.Point((e.xmax+e.xmin)/2,e.ymax),e.getMax()]}var r=["nw-resize","n-resize","ne-resize","w-resize","e-resize","sw-resize","s-resize","se-resize"],o=[null,"y",null,"x","x",null,"y",null],s=this._geometry;e||(e=[]);var a=[],h={},l=this,u=this.getMap(),c=function(){for(var c=s._getPainter().get2DExtent(),d=n(c),m=0;m<d.length;m++){if(t.Util.isArrayHasData(e)){for(var f=!1,g=e.length-1;g>=0;g--)if(e[g]===m){f=!0;break}if(f)continue}var p=d[m],_=u.pointToCoordinate(p);if(a.length<d.length-e.length){var y=l.createHandle(_,{markerType:"square",dxdy:new t.Point(0,0),cursor:r[m],axis:o[m],onMove:function(t){return function(e){i(e,t)}}(m),onUp:function(){l._refresh()}});y.setId(m),h[m]=a.length,a.push(y)}else a[h[m]].setCoordinates(_)}};return c(),this._addRefreshHook(c),a},createMarkerEditor:function(){function e(){if(t.Util.isArrayHasData(n))for(var e=n.length-1;e>=0;e--)n[e].hide();this._editOutline&&this._editOutline.hide()}function i(){if(this._refresh(),t.Util.isArrayHasData(n))for(var e=n.length-1;e>=0;e--)n[e].show();this._editOutline&&this._editOutline.show()}var n,r=this._shadow,o=this._geometry,s=this.getMap();if(!r._canEdit())return void(console&&console.warn("A marker can't be resized with symbol:",r.getSymbol()));var a=r._getInternalSymbol(),h=new t.Point(0,0);t.Util.isNumber(a.markerDx)&&(h.x=a.markerDx),t.Util.isNumber(a.markerDy)&&(h.y=a.markerDy);var l=null;t.symbolizer.VectorMarkerSymbolizer.test(a)?"pin"!==a.markerType&&"pie"!==a.markerType&&"bar"!==a.markerType||(l=[5,6,7]):(t.symbolizer.ImageMarkerSymbolizer.test(a)||t.symbolizer.VectorPathMarkerSymbolizer.test(a))&&(l=[5,6,7]);var u,c=[2,1,2,0,0,2,1,2];if(this.options.fixAspectRatio){var d=r.getSize();u=d.width/d.height}n=this._createResizeHandles(null,function(e,i){if(l&&t.Util.indexOfArray(i,l)>=0){var a=s.viewPointToCoordinate(e.substract(h)),d=r.getCoordinates();a.x=d.x,r.setCoordinates(a),o.setCoordinates(a);var m=n[n.length-1-i];e=s.coordinateToViewPoint(m.getCoordinates())}var f=s._pointToViewPoint(r._getCenter2DPoint()).add(h),g=r._getInternalSymbol(),p=e.substract(f);l&&e.y>f.y&&(p.y=0);var _=l?1:2,y=2*Math.abs(p.x),v=Math.abs(p.y)*_;u&&(y=Math.max(y,v*u),v=y/u);var x=c[i];r instanceof t.TextMarker?((u||0===x||2===x)&&(o.config("boxMinWidth",y),r.config("boxMinWidth",y)),(u||1===x||2===x)&&(o.config("boxMinHeight",v),r.config("boxMinHeight",v))):((u||0===x||2===x)&&(g.markerWidth=y),(u||1===x||2===x)&&(g.markerHeight=v),r.setSymbol(g),o.setSymbol(g))}),this._addListener([s,"zoomstart",e]),this._addListener([s,"zoomend",i])},createCircleEditor:function(){var t=this._shadow,e=this._geometry,i=this.getMap();this._createResizeHandles(null,function(n){var r,o=i._pointToViewPoint(t._getCenter2DPoint()),s=n.substract(o),a=Math.abs(s.x),h=Math.abs(s.y);r=a>h?i.pixelToDistance(a,0):i.pixelToDistance(0,h),t.setRadius(r),e.setRadius(r)})},createEllipseOrRectEditor:function(){var e,i=[2,1,2,0,0,2,1,2],n=this._shadow,r=this._geometry,o=this.getMap(),s=this._geometry instanceof t.Rectangle;this.options.fixAspectRatio&&(e=r.getWidth()/r.getHeight());var a=this._createResizeHandles(null,function(h,l){var u,c,d,m=s?1:2,f=h,g=i[l];if(s){var p=a[7-l],_=o.coordinateToViewPoint(p.getCoordinates());u=f.substract(_);var y=u.abs();c=o.pixelToDistance(y.x,0),d=o.pixelToDistance(0,y.y);var v=r.getSize();0===g?(e&&(y.y=y.x/e,v.height=Math.abs(y.y),d=c/e),f.y=_.y-v.height/2):1===g?(e&&(y.x=y.y*e,v.width=Math.abs(y.x),c=d*e),f.x=_.x-v.width/2):e&&(c>d*e?(d=c/e,f.y=_.y+y.x*t.Util.sign(u.y)/e):(c=d*e,f.x=_.x+y.y*t.Util.sign(u.x)*e));var x=o.viewPointToCoordinate(new t.Point(Math.min(f.x,_.x),Math.min(f.y,_.y)));n.setCoordinates(x),r.setCoordinates(x)}else{u=o.coordinateToViewPoint(r.getCenter()).substract(f)._abs(),c=o.pixelToDistance(u.x,0),d=o.pixelToDistance(0,u.y),e&&(c=Math.max(c,d*e),d=c/e)}(e||0===g||2===g)&&(n.setWidth(c*m),r.setWidth(c*m)),(e||1===g||2===g)&&(n.setHeight(d*m),r.setHeight(d*m))})},createPolygonEditor:function(){function e(){if(l instanceof t.Polygon){var e=l.getCoordinates()[0];return e.slice(0,e.length-1)}return l.getCoordinates()}function i(){return l._getPrjCoordinates()}function n(){var t;for(t=g.length-1;t>=0;t--)g[t][f]=t;for(t=p.length-1;t>=0;t--)p[t][f]=t}function r(t){var e=t.target,r=e[f],o=i();if(!(o.length<=d)){o.splice(r,1),l._setPrjCoordinates(o),l._updateCache(),g.splice(r,1)[0].remove(),r<p.length&&p.splice(r,1)[0].remove();var s;s=0===r?p.length-1:r-1,p.splice(s,1)[0].remove(),p.splice(s,0,a.call(u,s)),n()}}function o(t,e){var n=i(),r=h._viewPointToPrj(t),o=n[e];o.x=r.x,o.y=r.y,l._updateCache(),l.onShapeChanged();var s;s=0===e?p.length-1:e-1,p[e]&&p[e][m](),p[s]&&p[s][m](),u._updateAndFireEvent("shapechange")}function s(i){var n=e()[i],s=u.createHandle(n,{markerType:"square",dxdy:new t.Point(0,0),cursor:"pointer",axis:null,onMove:function(t){o(t,s[f])},onRefresh:function(){n=e()[s[f]],s.setCoordinates(n)},onUp:function(){u._refresh()}});return s[f]=i,s.on("contextmenu",r),s}function a(r){var h,d=e();h=r+1>=d.length?d[0]:d[r+1];var m=d[r].add(h).multi(.5),_=u.createHandle(m,{markerType:"square",symbol:{opacity:.4},dxdy:new t.Point(0,0),cursor:"pointer",axis:null,onDown:function(){var t=i(),e=_[f],n=c.project(_.getCoordinates());t.splice(e+1,0,n),l._setPrjCoordinates(t),l._updateCache();var r=_.getSymbol();delete r.opacity,_.setSymbol(r),p.splice(e,0,a.call(u,e),a.call(u,e+1)),u._updateAndFireEvent("shapechange")},onMove:function(t){o(t,_[f]+1)},onUp:function(){var e=_[f];t.Util.removeFromArray(_,p),_.remove(),g.splice(e+1,0,s.call(u,e+1)),n()},onRefresh:function(){d=e();var t,i=_[f];t=i===d.length-1?0:i+1;var n=d[i].add(d[t]).multi(.5);_.setCoordinates(n)}});return _[f]=r,_}for(var h=this.getMap(),l=this._shadow,u=this,c=h.getProjection(),d=l instanceof t.Polygon?3:2,m="maptalks--editor-refresh-fn",f="maptalks--editor-vertex-index",g=[],p=[],_=e(),y=0,v=_.length;y<v;y++)g.push(s.call(this,y)),y<v-1&&p.push(a.call(this,y));l instanceof t.Polygon&&p.push(a.call(this,_.length-1)),this._addRefreshHook(function(){var t;for(t=p.length-1;t>=0;t--)p[t][m]();for(t=g.length-1;t>=0;t--)g[t][m]()})},_refresh:function(){if(this._refreshHooks)for(var t=this._refreshHooks.length-1;t>=0;t--)this._refreshHooks[t].call(this)},_hideContext:function(){this._geometry&&(this._geometry.closeMenu(),this._geometry.closeInfoWindow())},_addListener:function(t){this._eventListeners||(this._eventListeners=[]),this._eventListeners.push(t),t[0].on(t[1],t[2],this)},_addRefreshHook:function(t){t&&(this._refreshHooks||(this._refreshHooks=[]),this._refreshHooks.push(t))}}),t.TextMarker.Editor={startEditText:function(){return this.getMap()?(this.hide(),this.endEditText(),this._prepareEditor(),this._fireEvent("edittextstart"),this):this},endEditText:function(){if(this._textEditor){var e=this._textEditor.innerHTML;e=e.replace(/<p>/gi,""),e=e.replace(/<\/p>/gi,"<br/>"),this._textEditor.innerHTML=e;var i=this._textEditor.innerText;i=t.StringUtil.filterLastEnter(i),this.setContent(i),this.show(),t.DomUtil.off(this._textEditor,"mousedown dblclick",t.DomUtil.stopPropagation),this.getMap().off("mousedown",this.endEditText,this),this._editUIMarker.remove(),delete this._editUIMarker,this._textEditor.onkeyup=null,delete this._textEditor,this._fireEvent("edittextend")}return this},isEditingText:function(){return!!this._textEditor},getTextEditor:function(){return this._editUIMarker},_prepareEditor:function(){var e=this.getMap(),i=this._createEditor();this._textEditor=i,e.on("mousedown",this.endEditText,this);var n=this._getEditorOffset();this._editUIMarker=new t.ui.UIMarker(this.getCoordinates(),{content:i,dx:n.dx,dy:n.dy}).addTo(e).show(),this._setCursorToLast(this._textEditor)},_getEditorOffset:function(){var t=this._getInternalSymbol()||{},e=0,i=0,n=t.textHorizontalAlignment;return"middle"===n?(e=t.textDx-2||0,i=t.textDy-2||0):(e=t.markerDx-2||0,i=t.markerDy-2||0),{dx:e,dy:i}},_createEditor:function(){var e=this.getContent(),i=this.getSize(),n=this._getInternalSymbol()||{},r=e&&e.length>0?Math.max(i.width,this.options.boxMinWidth)||100:100,o=n.textFill||"#000000",s=n.textSize||12,a=Math.max(i.height,this.options.boxMinHeight)||1.5*s,h=n.markerLineColor||"#000",l=n.markerFill||"#3398CC",u=n.textLineSpacing||0,c=t.DomUtil.createEl("div");return c.contentEditable=!0,c.style.cssText="background: "+l+";border: 1px solid "+h+";color: "+o+";font-size: "+s+"px;width: "+(r-2)+"px;height: "+(a-2)+"px;margin-left: auto;margin-right: auto;line-height: "+(s+2*u)+"px;outline: 0; padding:0; margin:0;word-wrap: break-word;overflow-x: hidden;overflow-y: hidden;-webkit-user-modify: read-write-plaintext-only;",c.innerText=e,t.DomUtil.on(c,"mousedown dblclick",t.DomUtil.stopPropagation),c.onkeyup=function(t){var e=c.style.height;e||(e=0),13===t.keyCode&&(c.style.height=parseInt(e)+s/2+"px")},c},_setCursorToLast:function(t){var e;window.getSelection?(t.focus(),e=window.getSelection(),e.selectAllChildren(t),e.collapseToEnd()):document.selection&&(e=document.selection.createRange(),e.moveToElementText(t),e.collapse(!1),e.select())}},t.TextBox.include(t.TextMarker.Editor),t.Label.include(t.TextMarker.Editor),t.View=function(t){t||(t={}),this.options=t,this._initView()},t.Util.extend(t.View.prototype,{defaultView:{"EPSG:3857":{resolutions:function(){for(var t=[],e=12756274*Math.PI,i=0;i<21;i++)t[i]=e/(256*Math.pow(2,i));return t}(),fullExtent:{top:6378137*Math.PI,left:-6378137*Math.PI,bottom:-6378137*Math.PI,right:6378137*Math.PI}},"EPSG:4326":{fullExtent:{top:90,left:-180,bottom:-90,right:180},resolutions:function(){for(var t=[],e=0;e<21;e++)t[e]=180/(128*Math.pow(2,e));return t}()},BAIDU:{resolutions:function(){for(var t=Math.pow(2,18),e=[],i=0;i<20;i++)e[i]=t,t*=.5;return e[0]=null,e[1]=null,e[2]=null,e}(),fullExtent:{top:33554432,left:-33554432,bottom:-33554432,right:33554432}}},_initView:function(){var e=this.options.projection;if(e){if(t.Util.isString(e))for(var i in t.projection)if(t.projection.hasOwnProperty(i)){var n=t.projection[i].code;if(n&&n.toLowerCase()===e.toLowerCase()){e=t.projection[i];break}}}else e=t.projection.DEFAULT;if(!e||t.Util.isString(e))throw new Error("must provide a valid projection in map's view.");e=t.Util.extend({},t.projection.Common,e),e.measureLength||t.Util.extend(e,t.MeasurerUtil.DEFAULT),this._projection=e;var r,o=this.options.resolutions;if(!o&&(e.code&&(r=this.defaultView[e.code])&&(o=r.resolutions),!o))throw new Error("must provide valid resolutions in map's view.");this._resolutions=o;var s=this.options.fullExtent;if(!s&&(e.code&&(r=this.defaultView[e.code])&&(s=r.fullExtent),!s))throw new Error("must provide a valid fullExtent in map's view.");t.Util.isNil(s.left)?(this._fullExtent=new t.Extent(s),s.left=s.xmin,s.right=s.xmax,s.top=s.ymax,s.bottom=s.ymin):this._fullExtent=new t.Extent(new t.Coordinate(s.left,s.top),new t.Coordinate(s.right,s.bottom)),t.Util.extend(this._fullExtent,s);var a=s.right>=s.left?1:-1,h=s.top>=s.bottom?-1:1;this._transformation=new t.Transformation([a,h,0,0])},getResolutions:function(){return this._resolutions},getResolution:function(e){var i=0|e;i<0?i=0:i>this._resolutions.length-1&&(i=this._resolutions.length-1);var n=this._resolutions[i];if(!t.Util.isInteger(e)&&i!==this._resolutions.length-1){return n+(this._resolutions[i+1]-n)*(e-i)}return n},getProjection:function(){return this._projection},getFullExtent:function(){return this._fullExtent},getTransformation:function(){return this._transformation},getMinZoom:function(){for(var e=0;e<this._resolutions.length;e++)if(!t.Util.isNil(this._resolutions[e]))return e;return 0},getMaxZoom:function(){for(var e=this._resolutions.length-1;e>=0;e--)if(!t.Util.isNil(this._resolutions[e]))return e;return this._resolutions.length-1}}),function(){function e(t){for(var e=t.tileInfo,i={width:e.cols,height:e.rows},n=[],r=e.lods,o=0,s=r.length;o<s;o++)n.push(r[o].resolution);var a=t.fullExtent,h=e.origin,l=[1,-1,h.x,h.y];return delete a.spatialReference,{view:{resolutions:n,fullExtent:a},tileSystem:l,tileSize:i}}t.View.loadArcgis=function(i,n,r){if(t.Util.isString(i)&&"{"!==i.substring(0,1))t.Ajax.getJSON(i,function(t,i){if(t)return void(r?n.call(r,t):n(t));var o=e(i);r?n.call(r,null,o):n(null,o)});else{t.Util.isString(i)&&(i=t.Util.parseJSON(i));var o=e(i);r?n.call(r,null,o):n(null,o)}return this}}(),t.Map=t.Class.extend({includes:[t.Eventable,t.Handlerable],options:{centerCross:!1,clipFullExtent:!1,zoomAnimation:function(){return!t.node}(),zoomAnimationDuration:330,zoomBackground:!1,layerZoomAnimation:!0,pointThresholdOfZoomAnimation:200,panAnimation:function(){return!t.node}(),panAnimationDuration:600,zoomable:!0,enableInfoWindow:!0,hitDetect:function(){return!t.Browser.mobile}(),hitDetectLimit:5,numOfLayersOnInteracting:10,maxZoom:null,minZoom:null,maxExtent:null,checkSize:!0,renderer:"canvas"},initialize:function(e,i){if(!i)throw new Error("Invalid options when creating map.");if(this._loaded=!1,t.Util.isString(e)){if(this._containerDOM=document.getElementById(e),!this._containerDOM)throw new Error("invalid container when creating map: '"+e+"'")}else this._containerDOM=e,t.node&&(this.CanvasClass=this._containerDOM.constructor);if(!t.node&&this._containerDOM.childNodes&&this._containerDOM.childNodes.length>0&&"maptalks-wrapper"===this._containerDOM.childNodes[0].className)throw new Error("Container is already loaded with another map instance, use map.remove() to clear it.");if(!i.center)throw new Error("Invalid center when creating map.");this._panels={},this._baseLayer=null,this._layers=[];var n=t.Util.extend({},i);this._zoomLevel=n.zoom,delete n.zoom,this._center=new t.Coordinate(n.center),delete n.center;var r=n.baseLayer;delete n.baseLayer;var o=n.layers;delete n.layers,t.Util.setOptions(this,n),this.setView(n.view),r&&this.setBaseLayer(r),o&&this.addLayer(o),this._mapViewPoint=new t.Point(0,0),this._initRenderer(),this._getRenderer().initContainer(),this._updateMapSize(this._getContainerDomSize()),this._Load()},isLoaded:function(){return this._loaded},isCanvasRender:function(){var t=this._getRenderer();return!!t&&t.isCanvasRender()},getView:function(){return this._view?this._view:null},setView:function(e){var i=this.options.view;if(i&&!e)return this;if(this._center=this.getCenter(),this.options.view=e,this._view=new t.View(e),this.options.view&&t.Util.isFunction(this.options.view.projection)){var n=this._view.getProjection();this.options.view.projection=n.code}return this._resetMapStatus(),this._fireEvent("viewchange",{old:i,new:t.Util.extend({},this.options.view)}),this},onConfig:function(e){return t.Util.isNil(e.view)||this.setView(e.view),this},getProjection:function(){return this._view.getProjection()},getFullExtent:function(){return this._view.getFullExtent()},setCursor:function(t){return delete this._cursor,this._trySetCursor(t),this._cursor=t,this},getCenter:function(){return this._loaded&&this._prjCenter?this.getProjection().unproject(this._prjCenter):this._center},setCenter:function(e){if(!e)return this;if(e=new t.Coordinate(e),!this._verifyExtent(e))return this;if(!this._loaded)return this._center=e,this;this.onMoveStart();var i=this.getProjection(),n=i.project(e);return this._setPrjCenterAndMove(n),this.onMoveEnd(),this},getSize:function(){return t.Util.isNil(this.width)||t.Util.isNil(this.height)?this._getContainerDomSize():new t.Size(this.width,this.height)},getContainerExtent:function(){return new t.PointExtent(0,0,this.width,this.height)},getExtent:function(){return this._pointToExtent(this._get2DExtent())},getProjExtent:function(){var e=this._get2DExtent();return new t.Extent(this._pointToPrj(e.getMin()),this._pointToPrj(e.getMax()))},getMaxExtent:function(){return this.options.maxExtent?new t.Extent(this.options.maxExtent):null},setMaxExtent:function(e){if(e){var i=new t.Extent(e);this.options.maxExtent=i;var n=this.getCenter();this._verifyExtent(n)||this.panTo(i.getCenter())}else delete this.options.maxExtent;return this},getZoom:function(){return this._zoomLevel},getZoomForScale:function(e,i){t.Util.isNil(i)&&(i=this.getZoom());for(var n=this._getResolution(i),r=this._getResolutions(),o=this.getMinZoom(),s=this.getMaxZoom(),a=Number.MAX_VALUE,h=-1,l=r.length-1;l>=0;l--){var u=Math.abs(n/r[l]-e);u<a&&(a=u,h=l)}return t.Util.isNumber(o)&&h<o&&(h=o),t.Util.isNumber(s)&&h>s&&(h=s),h},getZoomFromRes:function(t){var e=this._getResolutions(),i=this._getResolution(this.getMinZoom()),n=this._getResolution(this.getMaxZoom());if(i<=n){if(t<=i)return this.getMinZoom();if(t>=n)return this.getMaxZoom()}else{if(t>=i)return this.getMinZoom();if(t<=n)return this.getMaxZoom()}for(var r=e.length,o=0;o<r-1;o++)if(e[o]){var s=Math.abs(e[o+1]-e[o]),a=Math.abs(t-e[o]);if(s>=a)return o+a/s}return r-1},setZoom:function(e){var i=this;return t.Util.executeWhen(function(){i._loaded&&i.options.zoomAnimation?i._zoomAnimation(e):i._zoom(e)},function(){return!i._zooming}),this},getMaxZoom:function(){if(!t.Util.isNil(this.options.maxZoom))return this.options.maxZoom;var e=this.getView();return e?e.getResolutions().length-1:null},setMaxZoom:function(t){var e=this._view.getMaxZoom();return t>e&&(t=e),t<this._zoomLevel&&this.setZoom(t),this.options.maxZoom=t,this},getMinZoom:function(){return t.Util.isNil(this.options.minZoom)?0:this.options.minZoom},setMinZoom:function(t){var e=this._view.getMinZoom();return t<e&&(t=e),this.options.minZoom=t,this},zoomIn:function(){var e=this;return t.Util.executeWhen(function(){e.setZoom(e.getZoom()+1)},function(){return!e._zooming}),this},zoomOut:function(){var e=this;return t.Util.executeWhen(function(){e.setZoom(e.getZoom()-1)},function(){return!e._zooming}),this},setCenterAndZoom:function(e,i){return this._zoomLevel!==i?(this.setCenter(e),t.Util.isNil(i)||this.setZoom(i)):this.setCenter(e),this},getFitZoom:function(e){if(!(e&&e instanceof t.Extent))return this._zoomLevel;if(e.xmin===e.xmax&&e.ymin===e.ymax)return this.getMaxZoom();for(var i=this.getProjection(),n=Math.abs(e.xmin-e.xmax),r=Math.abs(e.ymin-e.ymax),o=i.project({x:n,y:r}),s=this._getResolutions(),a=-1,h=-1,l=this.getMinZoom(),u=this.getMaxZoom();l<u&&(t.Util.round(o.x/s[l])>=this.width&&a===-1&&(a=l),t.Util.round(o.y/s[l])>=this.height&&h===-1&&(h=l),!(a>-1&&h>-1));l++);var c=a<h?a:h;return c===-1&&(c=a<h?h:a),c===-1?this.getMaxZoom():c},getResolution:function(t){return this._getResolution(t)},getScale:function(e){var i=t.Util.isNil(e)?this.getZoom():e,n=this._getResolution(this.getMaxZoom());return this._getResolution(i)/n},fitExtent:function(e,i){if(!e)return this;i=i||0;var n=this.getFitZoom(e);n+=i;var r=new t.Extent(e).getCenter();return this.setCenterAndZoom(r,n)},getBaseLayer:function(){return this._baseLayer},setBaseLayer:function(e){function i(){this._fireEvent("baselayerload"),n&&(n=!1,this._fireEvent("baselayerchangeend"))}var n=!1;return this._baseLayer&&(n=!0,this._fireEvent("baselayerchangestart"),this._baseLayer.remove()),e?(e instanceof t.TileLayer&&(e.config({renderWhenPanning:!0}),e.options.tileSystem||e.config("tileSystem",t.TileSystem.getDefault(this.getProjection()))),e._bindMap(this,-1),this._baseLayer=e,this._baseLayer.on("layerload",i,this),this._loaded&&this._baseLayer.load(),this._fireEvent("setbaselayer"),this):(delete this._baseLayer,this._fireEvent("baselayerchangeend"),this._fireEvent("setbaselayer"),this)},removeBaseLayer:function(){return this._baseLayer&&(this._baseLayer.remove(),delete this._baseLayer,this._fireEvent("baselayerremove")),this},getLayers:function(e){return this._getLayers(function(i){return!(i===this._baseLayer||i.getId().indexOf(t.internalLayerPrefix)>=0)&&(!e||e(i))})},getLayer:function(t){return t&&this._layerCache&&this._layerCache[t]?this._layerCache[t]:null},addLayer:function(e){if(!e)return this;if(!t.Util.isArray(e))return this.addLayer([e]);this._layerCache||(this._layerCache={});for(var i=0,n=e.length;i<n;i++){var r=e[i],o=r.getId();if(t.Util.isNil(o))throw new Error("Invalid id for the layer: "+o);if(this._layerCache[o])throw new Error("Duplicate layer id in the map: "+o);this._layerCache[o]=r,r._bindMap(this,this._layers.length),this._layers.push(r),this._loaded&&r.load()}return this._fireEvent("addlayer",{layers:e}),this},removeLayer:function(e){if(!e)return this;if(!t.Util.isArray(e))return this.removeLayer([e]);for(var i=0,n=e.length;i<n;i++){var r=e[i];if(r instanceof t.Layer||(r=this.getLayer(r)),r){var o=r.getMap();if(o&&o===this){this._removeLayer(r,this._layers),this._loaded&&r._doRemove();var s=r.getId();this._layerCache&&delete this._layerCache[s],r.fire("remove")}}}return this._fireEvent("removelayer",{layers:e}),this},sortLayers:function(e){if(!e||!t.Util.isArray(e))return this;var i=this._getRenderer();i.disableRender();for(var n=[],r=Number.MAX_VALUE,o=0;o<e.length;o++){var s=e[o];if(t.Util.isString(e[o])&&(s=this.getLayer(s)),!(s instanceof t.Layer&&s.getMap()&&s.getMap()===this))throw new Error("It must be a layer added to this map to order.");s.getZIndex()<r&&(r=s.getZIndex()),n.push(s)}for(var a=0;a<n.length;a++)n[a].setZIndex(r+a);return i.enableRender(),i.render(),this},toDataURL:function(t){t||(t={});var e=t.mimeType;e||(e="image/png");var i=t.save,n=this._getRenderer();if(n&&n.toDataURL){var r=t.filename;r||(r="export");var o=n.toDataURL(e);if(i&&o){var s=o,a=document.createElement("a");a.download=r,a.href=s,a.dataset.downloadurl=[e,a.download,a.href].join(":"),document.body.appendChild(a),a.click(),document.body.removeChild(a)}return o}return null},coordinateToPoint:function(t,e){var i=this.getProjection().project(t);return this._prjToPoint(i,e)},pointToCoordinate:function(t,e){var i=this._pointToPrj(t,e);return this.getProjection().unproject(i)},coordinateToViewPoint:function(t){return this._prjToViewPoint(this.getProjection().project(t))},viewPointToCoordinate:function(t){return this.getProjection().unproject(this._viewPointToPrj(t))},coordinateToContainerPoint:function(t){var e=this.getProjection().project(t);return this._prjToContainerPoint(e)},containerPointToCoordinate:function(t){var e=this._containerPointToPrj(t);return this.getProjection().unproject(e)},containerPointToViewPoint:function(t){return t.substract(this.offsetPlatform())},viewPointToContainerPoint:function(t){return t.add(this.offsetPlatform())},containerToExtent:function(e){var i=new t.PointExtent(this._containerPointToPoint(e.getMin()),this._containerPointToPoint(e.getMax()));return this._pointToExtent(i)},checkSize:function(){var e=t.Util.now()-this._initTime<1500&&0===this.width||0===this.height,i=this._getContainerDomSize(),n=this.height,r=this.width;if(i.width===r&&i.height===n)return this;var o=this.getCenter();this._updateMapSize(i);var s=new t.Point((r-i.width)/2,(n-i.height)/2);return this._offsetCenterByPixel(s),e&&(this._eventSuppressed=!0,this.setCenter(o),this._eventSuppressed=!1),this._fireEvent("resize"),this},distanceToPixel:function(e,i,n){var r=this.getProjection();if(!r)return null;var o=this.getCenter(),s=r.locate(o,e,i),a=this._getResolution(n),h=e?(r.project(new t.Coordinate(s.x,o.y)).x-r.project(o).x)/a:0,l=i?(r.project(new t.Coordinate(o.x,s.y)).y-r.project(o).y)/a:0;return new t.Size(Math.abs(h),Math.abs(l))},pixelToDistance:function(e,i,n){var r=this.getProjection();if(!r)return null;var o=this.getCenter(),s=this._getPrjCenter(),a=this._getResolution(n),h=new t.Coordinate(s.x+e*a,s.y+i*a),l=r.unproject(h);return r.measureLength(l,o)},locate:function(e,i,n){return this.getProjection().locate(new t.Coordinate(e),i,n)},getMainPanel:function(){return this._getRenderer().getMainPanel()},getPanels:function(){return this._panels},remove:function(){this._registerDomEvents(!0),this._clearHandlers(),this.removeBaseLayer();for(var t=this.getLayers(),e=0;e<t.length;e++)t[e].remove();return this._getRenderer()&&this._getRenderer().remove(),this._clearAllListeners(),this._containerDOM&&this._containerDOM.innerHTML&&(this._containerDOM.innerHTML=""),delete this._panels,delete this._containerDOM,this},onMoveStart:function(t){this._originCenter=this.getCenter(),this._enablePanAnimation=!1,this._moving=!0,this._trySetCursor("move"),this._fireEvent("movestart",this._parseEvent(t?t.domEvent:null,"movestart"))},onMoving:function(t){this._fireEvent("moving",this._parseEvent(t?t.domEvent:null,"moving"))},onMoveEnd:function(t){if(this._moving=!1,this._trySetCursor("default"),this._fireEvent("moveend",this._parseEvent(t?t.domEvent:null,"moveend")),!this._verifyExtent(this.getCenter())){var e=this._originCenter;this._verifyExtent(e)||(e=this.getMaxExtent().getCenter()),this.panTo(e)}},_isBusy:function(){return this._zooming},_trySetCursor:function(t){return this._cursor||this._priorityCursor||(t||(t="default"),this._setCursorToPanel(t)),this},_setPriorityCursor:function(t){if(t)this._priorityCursor=t,this._setCursorToPanel(t);else{var e=!1;this._priorityCursor&&(e=!0),delete this._priorityCursor,e&&this.setCursor(this._cursor)}return this},_setCursorToPanel:function(t){var e=this.getMainPanel();e&&e.style&&e.style.cursor!==t&&(e.style.cursor=t)},_get2DExtent:function(e){var i=this._containerPointToPoint(new t.Point(0,0),e),n=this._containerPointToPoint(new t.Point(this.width,0),e),r=this._containerPointToPoint(new t.Point(this.width,this.height),e),o=this._containerPointToPoint(new t.Point(0,this.height),e),s=Math.min(i.x,n.x,r.x,o.x),a=Math.max(i.x,n.x,r.x,o.x),h=Math.min(i.y,n.y,r.y,o.y),l=Math.max(i.y,n.y,r.y,o.y);return new t.PointExtent(s,h,a,l)},_pointToExtent:function(e){return new t.Extent(this.pointToCoordinate(e.getMin()),this.pointToCoordinate(e.getMax()))},_setPrjCenterAndMove:function(t){var e=this._getPixelDistance(t);this._setPrjCenter(t),this.offsetPlatform(e)},_removeLayer:function(e,i){if(e&&i){var n=t.Util.indexOfArray(e,i);if(n>-1){i.splice(n,1);var r=this._getRenderer();r.disableRender();for(var o=0,s=i.length;o<s;o++)i[o].setZIndex&&i[o].setZIndex(o);r.enableRender(),r.render()}}},_sortLayersByZIndex:function(t){t.sort(function(t,e){return t.getZIndex()-e.getZIndex()})},_getPixelDistance:function(e){var i=this._getPrjCenter(),n=this._prjToContainerPoint(i),r=this._prjToContainerPoint(e);return new t.Point(-r.x+n.x,n.y-r.y)},_fireEvent:function(t,e){this._eventSuppressed||(this.fire("_"+t,e),this.fire(t,e))},_Load:function(){this._resetMapStatus(),this._registerDomEvents(),this._loadAllLayers(),this._getRenderer().onLoad(),this._loaded=!0,this._callOnLoadHooks(),this._initTime=t.Util.now(),this._fireEvent("load")},_initRenderer:function(){var e=this.options.renderer,i=t.Map.getRendererClass(e);this._renderer=new i(this)},_getRenderer:function(){return this._renderer},_loadAllLayers:function(){function t(t){t&&t.load()}this._baseLayer&&this._baseLayer.load(),this._eachLayer(t,this.getLayers())},_getLayers:function(t){for(var e=this._baseLayer?[this._baseLayer].concat(this._layers):this._layers,i=[],n=0;n<e.length;n++)t&&!t.call(this,e[n])||i.push(e[n]);return i},_eachLayer:function(e){if(!(arguments.length<2)){var i=Array.prototype.slice.call(arguments,1);i&&!t.Util.isArray(i)&&(i=[i]);for(var n=[],r=0,o=i.length;r<o;r++)n=n.concat(i[r]);for(var s=0,a=n.length;s<a;s++)e.call(e,n[s])}},_resetMapStatus:function(){var t=this.getMaxZoom(),e=this.getMinZoom(),i=this._view.getMaxZoom(),n=this._view.getMinZoom();(!t||t===-1||t>i)&&this.setMaxZoom(i),(!e||e===-1||e<n)&&this.setMinZoom(n),t=this.getMaxZoom(),e=this.getMinZoom(),t<e&&this.setMaxZoom(e),(!this._zoomLevel||this._zoomLevel>t)&&(this._zoomLevel=t),this._zoomLevel<e&&(this._zoomLevel=e),delete this._prjCenter;var r=this.getProjection();this._prjCenter=r.project(this._center)},_getContainerDomSize:function(){if(!this._containerDOM)return null;var e,i,n=this._containerDOM;if(t.Util.isNil(n.width)||t.Util.isNil(n.height)){if(t.Util.isNil(n.clientWidth)||t.Util.isNil(n.clientHeight))throw new Error("can not get size of container");e=parseInt(n.clientWidth,0),i=parseInt(n.clientHeight,0)}else e=n.width,i=n.height,t.Browser.retina&&n[t.renderer.tilelayer.Canvas.prototype.propertyOfTileId]&&(e/=2,i/=2);return new t.Size(e,i)},_updateMapSize:function(t){return this.width=t.width,this.height=t.height,this._getRenderer().updateMapSize(t),this},_getPrjCenter:function(){return this._prjCenter},_setPrjCenter:function(t){this._prjCenter=t},_verifyExtent:function(t){if(!t)return!1;var e=this.getMaxExtent();return!e||e.contains(t)},_offsetCenterByPixel:function(e){var i=new t.Point(this.width/2-e.x,this.height/2-e.y),n=this._containerPointToPrj(i);return this._setPrjCenter(n),n},offsetPlatform:function(t){return t?(this._getRenderer().offsetPlatform(t),this._mapViewPoint=this._mapViewPoint.add(t),this):this._mapViewPoint},_resetMapViewPoint:function(){this._mapViewPoint=new t.Point(0,0)},_getResolution:function(e){return t.Util.isNil(e)&&(e=this.getZoom()),this._view.getResolution(e)},_getResolutions:function(){return this._view.getResolutions()},_prjToPoint:function(e,i){return i=t.Util.isNil(i)?this.getZoom():i,this._view.getTransformation().transform(e,this._getResolution(i))},_pointToPrj:function(e,i){return i=t.Util.isNil(i)?this.getZoom():i,this._view.getTransformation().untransform(e,this._getResolution(i))},_pointToPoint:function(e,i){return t.Util.isNil(i)?e:e.multi(this.getScale(i)/this.getScale())},_containerPointToPrj:function(t){return this._pointToPrj(this._containerPointToPoint(t))},_viewPointToPrj:function(t){return this._containerPointToPrj(this.viewPointToContainerPoint(t))},_prjToContainerPoint:function(t){return this._pointToContainerPoint(this._prjToPoint(t))},_prjToViewPoint:function(t){var e=this._prjToContainerPoint(t);return this._containerPointToViewPoint(e)},_containerPointToViewPoint:function(t){if(!t)return null;var e=this.offsetPlatform();return t._substract(e)},_pointToContainerPoint:function(e,i){e=this._pointToPoint(e,i);var n=this._prjToPoint(this._getPrjCenter());return new t.Point(this.width/2+e.x-n.x,this.height/2+e.y-n.y)},_containerPointToPoint:function(e,i){var n=this._prjToPoint(this._getPrjCenter(),i),r=t.Util.isNil(i)?1:this._getResolution()/this._getResolution(i);return new t.Point(n.x+r*(e.x-this.width/2),n.y+r*(e.y-this.height/2))},_viewPointToPoint:function(t){return this._containerPointToPoint(this.viewPointToContainerPoint(t))},_pointToViewPoint:function(t){return this._prjToViewPoint(this._pointToPrj(t))}}),t.Map.prototype._callOnLoadHooks=function(){
for(var e=t.Map.prototype,i=0,n=e._onLoadHooks.length;i<n;i++)e._onLoadHooks[i].call(this)},t.Map.addOnLoadHook=function(t){var e=Array.prototype.slice.call(arguments,1),i="function"==typeof t?t:function(){this[t].apply(this,e)};return this.prototype._onLoadHooks=this.prototype._onLoadHooks||[],this.prototype._onLoadHooks.push(i),this},t.Util.extend(t.Map,t.Renderable),t.Map.include({panTo:function(e,i){if(!e)return this;var n=this;e=new t.Coordinate(e);var r=this.coordinateToContainerPoint(e),o=this.coordinateToContainerPoint(this.getCenter());return this._panBy(r.substract(o),i,function(){var t=n.getProjection().project(e);n._setPrjCenterAndMove(t)})},panBy:function(t,e){return this._panBy(t,e)},_panBy:function(e,i,n){return e?(e=new t.Point(e).multi(-1),this.onMoveStart(),i||(i={}),void 0===i.animation||i.animation?this._panAnimation(e,i.duration,n):(this.offsetPlatform(e),this._offsetCenterByPixel(e),this.onMoving(),n&&n(),this.onMoveEnd()),this):this},_panAnimation:function(t,e,i){this._getRenderer().panAnimation(t,e,i)}}),t.Map.include({_zoom:function(t,e,i){this.options.zoomable&&!this._zooming&&(t=this._checkZoom(t),this.onZoomStart(t),this._frameZoom=this.getZoom(),this.onZoomEnd(t,e,i))},_isSeamlessZoom:function(){return!t.Util.isInteger(this._zoomLevel)},_zoomAnimation:function(e,i,n){this.options.zoomable&&!this._zooming&&(e=this._checkZoom(e),this.getZoom()!==e&&(this.onZoomStart(e),i||(i=new t.Point(this.width/2,this.height/2)),this._startZoomAnimation(e,i,n)))},_startZoomAnimation:function(e,i,n){t.Util.isNil(n)&&(n=1);var r=this,o=this._getResolution(this._startZoomVal)/this._getResolution(e),s=this.options.zoomAnimationDuration*Math.abs(o-n)/Math.abs(o-1);this._frameZoom=this._startZoomVal,t.Animation.animate({zoom:[this._startZoomVal,e]},{easing:"out",speed:s},t.Util.bind(function(t){"finished"===t.state.playState?r.onZoomEnd(t.styles.zoom,i):r.onZooming(t.styles.zoom,i,n)},this)).play()},onZoomStart:function(t){this._zooming=!0,this._enablePanAnimation=!1,this._startZoomVal=this.getZoom(),this._fireEvent("zoomstart",{from:this._startZoomVal,to:t})},onZooming:function(e,i,n){if(this._frameZoom!==e){t.Util.isNil(n)&&(n=1);var r=this._zoomTo(e,i,n),o=this.getResolution(e),s=this.getResolution(this._startZoomVal),a=s/o/n,h=this.offsetPlatform(),l={view:[a,0,0,a,(i.x-h.x)*(1-a),(i.y-h.y)*(1-a)]};t.Browser.retina&&(i=i.multi(2)),l.container=[a,0,0,a,i.x*(1-a),i.y*(1-a)],this._fireEvent("zooming",{from:this._startZoomVal,to:e,origin:r,matrix:l}),this._frameZoom=e;var u=this._getRenderer();u&&u.render()}},onZoomEnd:function(t,e){var i=this._startZoomVal;this._zoomTo(t,e),this._zooming=!1,this._getRenderer().onZoomEnd(),this._fireEvent("zoomend",{from:i,to:t})},_zoomTo:function(t,e,i){var n=this._getResolution(this._frameZoom)/this._getResolution(t),r=this._getZoomCenterOffset(t,e,i,n);return this._zoomLevel=t,!r||0===r.x&&0===r.y||this._offsetCenterByPixel(r._multi(-1)),r},_checkZoom:function(t){var e=this.getMaxZoom(),i=this.getMinZoom();return t<i&&(t=i),t>e&&(t=e),t},_getZoomCenterOffset:function(e,i,n,r){if(!i)return null;t.Util.isNil(n)&&(n=1);var o=new t.Point((i.x-this.width/2)*(r-n),(i.y-this.height/2)*(r-n)),s=this.containerPointToCoordinate(o.add(this.width/2,this.height/2));return this._verifyExtent(s)?o:new t.Point(0,0)},_getZoomMillisecs:function(){return 600}}),t.Map.include({computeLength:function(e,i){if(!this.getProjection())return null;var n=new t.Coordinate(e),r=new t.Coordinate(i);return n.equals(r)?0:this.getProjection().measureLength(n,r)},computeGeometryLength:function(t){return t._computeGeodesicLength(this.getProjection())},computeGeometryArea:function(t){return t._computeGeodesicArea(this.getProjection())},identify:function(e,i){if(!e)return this;var n=e.layers;if(!t.Util.isArrayHasData(n))return this;var r,o,s=[];for(r=0,o=n.length;r<o;r++)t.Util.isString(n[r])?s.push(this.getLayer(n[r])):s.push(n[r]);var a=this.coordinateToPoint(new t.Coordinate(e.coordinate)),h=t.Util.extend({},e),l=[];for(r=s.length-1;r>=0&&!(e.count&&l.length>=e.count);r--){var u=s[r];if(u&&u.getMap()&&u.isVisible()&&(e.includeInternals||!(u.getId().indexOf(t.internalLayerPrefix)>=0))){var c=u.identify(a,h);c&&(t.Util.isArray(c)?l=l.concat(c):l.push(c))}}return i.call(this,l),this}}),t.Map.include({_registerDomEvents:function(e){var i="mousedown mouseup mouseover mouseout mousemove click dblclick contextmenu keypress touchstart touchmove touchend ",n=this._panels.mapWrapper||this._containerDOM;e?t.DomUtil.removeDomEvent(n,i,this._handleDOMEvent,this):t.DomUtil.addDomEvent(n,i,this._handleDOMEvent,this)},_handleDOMEvent:function(e){var i=e.type;if("mousedown"===i||"click"===i){2===e.button&&(i="contextmenu")}if("contextmenu"===i&&t.DomUtil.preventDefault(e),!this._ignoreEvent(e)){if("mousedown"===i)this._mouseDownTime=t.Util.now();else if("click"===i&&this._mouseDownTime){var n=t.Util.now();if(n-this._mouseDownTime>300)return}this._fireDOMEvent(this,e,i)}},_ignoreEvent:function(t){if(!t||!this._panels.control)return!1;var e=t.srcElement||t.target;if(e)for(;e&&e!==this._containerDOM;){if(e.className&&e.className.indexOf&&(e.className.indexOf("maptalks-control")>=0||e.className.indexOf("maptalks-ui")>=0))return!0;e=e.parentNode}return!1},_parseEvent:function(e,i){if(!e)return null;var n={domEvent:e};if("keypress"!==i){var r=e.touches&&e.touches.length>0?e.touches[0]:e.changedTouches&&e.changedTouches.length>0?e.changedTouches[0]:e;if(r){var o=t.DomUtil.getEventContainerPoint(r,this._containerDOM);n.coordinate=this.containerPointToCoordinate(o),n.containerPoint=o,n.viewPoint=this.containerPointToViewPoint(o),n.point2d=this._containerPointToPoint(o)}}return n},_fireDOMEvent:function(t,e,i){var n=this._parseEvent(e,i);this._fireEvent(i,n)}}),t.Map.include({requestFullScreen:function(){return this._fireEvent("fullscreenstart"),this._requestFullScreen(this._containerDOM),this._fireEvent("fullscreenend"),this},cancelFullScreen:function(){return this._cancelFullScreen(this._containerDOM),this._fireEvent("cancelfullscreen"),this},_requestFullScreen:function(t){if(t.requestFullScreen)t.requestFullScreen();else if(t.mozRequestFullScreen)t.mozRequestFullScreen();else if(t.webkitRequestFullScreen)t.webkitRequestFullScreen();else if(t.msRequestFullScreen)t.msRequestFullScreen();else{var e="fullscreen=1,status=no,resizable=yes,top=0,left=0,scrollbars=no,titlebar=no,menubar=no,location=no,toolbar=no,z-look=yes,width="+(screen.availWidth-8)+",height="+(screen.availHeight-45),i=window.open(location.href,"_blank",e);null!==i&&(window.opener=null,window.close())}},_cancelFullScreen:function(){if(document.cancelFullScreen)document.cancelFullScreen();else if(document.mozCancelFullScreen)document.mozCancelFullScreen();else if(document.webkitCancelFullScreen)document.webkitCancelFullScreen();else{var t=window.open(location.href,"_blank","fullscreen=no,status=yes,resizable=yes,scrollbars=no,titlebar=no,menubar=yes,location=yes,toolbar=yes,z-look=yes");null!==t&&(window.opener=null,window.close())}}}),t.Layer.fromJSON=function(e){if(!e)return null;var i=e.type;if("vector"===i?i=e.type="VectorLayer":"dynamic"===i?i=e.type="DynamicLayer":"tile"===i&&(i=e.type="TileLayer"),void 0===t[i]||!t[i].fromJSON)throw new Error("unsupported layer type:"+i);return t[i].fromJSON(e)},t.Map.include({PROFILE_VERSION:"1.0",toJSON:function(e){e||(e={});var i={version:this.PROFILE_VERSION,extent:this.getExtent().toJSON()};i.options=this.config(),i.options.center=this.getCenter(),i.options.zoom=this.getZoom();var n=this.getBaseLayer();(t.Util.isNil(e.baseLayer)||e.baseLayer)&&n&&(i.baseLayer=n.toJSON(e.baseLayer));var r={};e.clipExtent&&(e.clipExtent===!0?r.clipExtent=this.getExtent():r.clipExtent=e.clipExtent);var o,s,a,h,l=[];if(t.Util.isNil(e.layers)||e.layers&&!t.Util.isArray(e.layers)){for(a=this.getLayers(),o=0,s=a.length;o<s;o++)a[o].toJSON&&(h=t.Util.extend({},t.Util.isObject(e.layers)?e.layers:{},r),l.push(a[o].toJSON(h)));i.layers=l}else if(t.Util.isArrayHasData(e.layers)){for(a=e.layers,o=0;o<a.length;o++){var u=a[o],c=this.getLayer(u.id);c.toJSON&&(h=t.Util.extend({},u.options,r),l.push(c.toJSON(h)))}i.layers=l}else i.layers=[];return i}}),t.Map.fromJSON=function(e,i,n){if(!e||!i)return null;n||(n={});var r=new t.Map(e,i.options);if(t.Util.isNil(n.baseLayer)||n.baseLayer){var o=t.Layer.fromJSON(i.baseLayer);o&&r.setBaseLayer(o)}if(t.Util.isNil(n.layers)||n.layers){for(var s=[],a=i.layers,h=0;h<a.length;h++){var l=t.Layer.fromJSON(a[h]);s.push(l)}r.addLayer(s)}return r},t.Map.mergeOptions({draggable:!0}),t.Map.Drag=t.Handler.extend({addHooks:function(){var e=this.target;if(e){var i=e._panels.mapWrapper||e._containerDOM;this._dragHandler=new t.Handler.Drag(i,{cancelOn:t.Util.bind(this._cancelOn,this)}),this._dragHandler.on("mousedown",this._onMouseDown,this).on("dragstart",this._onDragStart,this).on("dragging",this._onDragging,this).on("dragend",this._onDragEnd,this).enable()}},removeHooks:function(){this._dragHandler.off("mousedown",this._onMouseDown,this).off("dragstart",this._onDragStart,this).off("dragging",this._onDragging,this).off("dragend",this._onDragEnd,this).disable(),this._dragHandler.remove(),delete this._dragHandler},_cancelOn:function(t){return!!this._ignore(t)},_ignore:function(t){return!!t&&(t.domEvent&&(t=t.domEvent),this.target._ignoreEvent(t))},_onMouseDown:function(e){this.target._panAnimating&&(this.target._enablePanAnimation=!1),t.DomUtil.preventDefault(e.domEvent)},_onDragStart:function(e){var i=this.target;this.startDragTime=t.Util.now();var n=i.offsetPlatform();this.startLeft=n.x,this.startTop=n.y,this.preX=e.mousePos.x,this.preY=e.mousePos.y,this.startX=this.preX,this.startY=this.preY,i.onMoveStart(e)},_onDragging:function(e){if(void 0!==this.startLeft){var i=this.target,n=e.mousePos.x,r=e.mousePos.y,o=this.startLeft+n-this.startX,s=this.startTop+r-this.startY,a=i.offsetPlatform(),h=new t.Point(o,s)._substract(a);i.offsetPlatform(h),i._offsetCenterByPixel(h),i.onMoving(e)}},_onDragEnd:function(e){if(void 0!==this.startLeft){var i=this.target,n=t.Util.now()-this.startDragTime,r=i.offsetPlatform(),o=r.x-this.startLeft,s=r.y-this.startTop;if(delete this.startLeft,delete this.startTop,delete this.preX,delete this.preY,delete this.startX,delete this.startY,n<280&&Math.abs(s)+Math.abs(o)>5){var a=new t.Point(o,s);n=5*n*(Math.abs(a.x)+Math.abs(a.y))/500,i._panAnimation(a,n)}else i.onMoveEnd(e)}}}),t.Map.addInitHook("addHandler","draggable",t.Map.Drag),t.Map.mergeOptions({autoBorderPanning:!1}),t.Map.AutoBorderPanning=t.Handler.extend({threshold:10,step:4,addHooks:function(){this.dom=this.target._containerDOM,t.DomUtil.on(this.dom,"mousemove",this._onMouseMove,this),t.DomUtil.on(this.dom,"mouseout",this._onMouseOut,this)},removeHooks:function(){this._cancelPan(),t.DomUtil.off(this.dom,"mousemove",this._onMouseMove,this),t.DomUtil.off(this.dom,"mouseout",this._onMouseOut,this)},_onMouseMove:function(e){var i=this.target._parseEvent(e),n=i.containerPoint,r=this.target.getSize(),o=[n.x,r.width-n.x,n.y,r.height-n.y],s=Math.min.apply(Math,o),a=Math.abs(s);if(0===a||a>this.threshold)return void this._cancelPan();var h=this.step,l=new t.Point(0,0);o[0]===s?l.x=-h:o[1]===s&&(l.x=h),o[2]===s?l.y=-h:o[3]===s&&(l.y=h),this._stepOffset=l,this._pan()},_onMouseOut:function(){this._cancelPan()},_cancelPan:function(){delete this._stepOffset,this._animationId&&(t.Util.cancelAnimFrame(this._animationId),delete this._animationId)},_pan:function(){this._stepOffset&&(this.target.panBy(this._stepOffset,{animation:!1}),this._animationId=t.Util.requestAnimFrame(t.Util.bind(this._pan,this)))}}),t.Map.addInitHook("addHandler","autoBorderPanning",t.Map.AutoBorderPanning),t.Map.mergeOptions({doubleClickZoom:!0}),t.Map.DoubleClickZoom=t.Handler.extend({addHooks:function(){this.target.on("_dblclick",this._onDoubleClick,this)},removeHooks:function(){this.target.off("_dblclick",this._onDoubleClick,this)},_onDoubleClick:function(t){var e=this.target;if(e.options.doubleClickZoom){var i=e.getZoom(),n=t.domEvent.shiftKey?Math.ceil(i)-1:Math.floor(i)+1;e._zoomAnimation(n,t.containerPoint)}}}),t.Map.addInitHook("addHandler","doubleClickZoom",t.Map.DoubleClickZoom),t.Map.mergeOptions({scrollWheelZoom:!0}),t.Map.ScrollWheelZoom=t.Handler.extend({addHooks:function(){t.DomUtil.addDomEvent(this.target._containerDOM,"mousewheel",this._onWheelScroll,this)},removeHooks:function(){t.DomUtil.removeDomEvent(this.target._containerDOM,"mousewheel",this._onWheelScroll)},_onWheelScroll:function(e){var i=this.target,n=i._containerDOM;if(t.DomUtil.preventDefault(e),t.DomUtil.stopPropagation(e),i._zooming)return!1;var r=(e.wheelDelta?e.wheelDelta:e.detail)>0?1:-1;e.detail&&(r*=-1);var o=t.DomUtil.getEventContainerPoint(e,n);return this._scrollZoomFrame&&t.Util.cancelAnimFrame(this._scrollZoomFrame),this._scrollZoomFrame=t.Util.requestAnimFrame(function(){i._zoomAnimation(i.getZoom()+r,o)}),!1}}),t.Map.addInitHook("addHandler","scrollWheelZoom",t.Map.ScrollWheelZoom),t.Map.mergeOptions({touchZoom:!0}),t.Map.TouchZoom=t.Handler.extend({addHooks:function(){t.DomUtil.addDomEvent(this.target._containerDOM,"touchstart",this._onTouchStart,this)},removeHooks:function(){t.DomUtil.removeDomEvent(this.target._containerDOM,"touchstart",this._onTouchStart)},_onTouchStart:function(e){var i=this.target;if(e.touches&&2===e.touches.length&&!i._zooming){var n=i._containerDOM,r=t.DomUtil.getEventContainerPoint(e.touches[0],n),o=t.DomUtil.getEventContainerPoint(e.touches[1],n);this._startDist=r.distanceTo(o),this._startZoom=i.getZoom();var s=i.getSize();this._Origin=new t.Point(s.width/2,s.height/2),t.DomUtil.addDomEvent(document,"touchmove",this._onTouchMove,this).addDomEvent(document,"touchend",this._onTouchEnd,this),t.DomUtil.preventDefault(e),i.onZoomStart.apply(i),i._fireEvent("touchzoomstart",{from:this._startZoom})}},_onTouchMove:function(e){var i=this.target;if(e.touches&&2===e.touches.length&&i._zooming){var n=i._containerDOM,r=t.DomUtil.getEventContainerPoint(e.touches[0],n),o=t.DomUtil.getEventContainerPoint(e.touches[1],n),s=r.distanceTo(o)/this._startDist;this._scale=s;var a=i._getResolution(this._startZoom)/s,h=i.getZoomFromRes(a);i.onZooming(h,this._Origin),i._fireEvent("touchzooming")}},_onTouchEnd:function(){var e=this.target;if(!e._zooming)return void(e._zooming=!1);e._zooming=!1,t.DomUtil.off(document,"touchmove",this._onTouchMove,this).off(document,"touchend",this._onTouchEnd,this);var i=this._scale,n=e.getZoomForScale(i);n===-1&&(n=e.getZoom()),n!==e.getZoom()?e._zoomAnimation(n,this._Origin,this._scale):e.onZoomEnd(n),e._fireEvent("touchzoomend")}}),t.Map.addInitHook("addHandler","touchZoom",t.Map.TouchZoom),t.Map.mergeOptions({geometryEvents:!0}),t.Map.GeometryEvents=t.Handler.extend({EVENTS:"mousedown mouseup mousemove click dblclick contextmenu touchstart touchmove touchend",addHooks:function(){var e=this.target,i=e._panels.allLayers||e._containerDOM;i&&t.DomUtil.on(i,this.EVENTS,this._identifyGeometryEvents,this)},removeHooks:function(){var e=this.target,i=e._panels.allLayers||e._containerDOM;i&&t.DomUtil.off(i,this.EVENTS,this._identifyGeometryEvents,this)},_identifyGeometryEvents:function(e){function i(i){var r,s=!0;if("mousemove"===o){var a={};if(t.Util.isArrayHasData(i))for(r=i.length-1;r>=0;r--)i[r]instanceof t.Geometry&&(a[i[r]._getInternalId()]=i[r],i[r]._onEvent(e),s=i[r]._onMouseOver(e));n._setPriorityCursor(d);var h=g._prevMouseOverTargets;if(g._prevMouseOverTargets=i,t.Util.isArrayHasData(h))for(r=h.length-1;r>=0;r--){var l=h[r];if(l instanceof t.Geometry){var u=h[r]._getInternalId();if(i&&i.length>0){var c=!0;a[u]&&(c=!1),c&&l._onMouseOut(e)}else l._onMouseOut(e)}}}else{if(!i||0===i.length)return;for(r=i.length-1;r>=0;r--)if(i[r]instanceof t.Geometry){s=i[r]._onEvent(e);break}}s===!1&&t.DomUtil.stopPropagation(e)}var n=this.target,r=n._getLayers(function(e){return e instanceof t.VectorLayer});if(!n._isBusy()&&!n._moving&&r&&0!==r.length){var o=e.type;if("mousedown"===o)this._mouseDownTime=t.Util.now();else if("click"===o&&this._mouseDownTime){var s=t.Util.now();if(s-this._mouseDownTime>300)return}for(var a=[],h=0;h<r.length;h++)r[h].options.geometryEvents&&a.push(r[h]);if(0!==a.length){var l=e.touches&&e.touches.length>0?e.touches[0]:e.changedTouches&&e.changedTouches.length>0?e.changedTouches[0]:e;if(l){var u=t.DomUtil.getEventContainerPoint(l,n._containerDOM),c=n.containerPointToCoordinate(u);"touchstart"===o&&t.DomUtil.preventDefault(e);var d=null,m={includeInternals:!0,filter:function(t){var i=t._getEventTypeToFire(e);if("mousemove"===o){if(!d&&t.options.cursor&&(d=t.options.cursor),!t.listens("mousemove")&&!t.listens("mouseover"))return!1}else if(!t.listens(i))return!1;return!0},count:1,coordinate:c,layers:a},f=t.Util.bind(i,this),g=this;this._queryIdentifyTimeout&&t.Util.cancelAnimFrame(this._queryIdentifyTimeout),"mousemove"===o||"touchmove"===o?this._queryIdentifyTimeout=t.Util.requestAnimFrame(function(){n.identify(m,f)}):n.identify(m,f)}}}}}),t.Map.addInitHook("addHandler","geometryEvents",t.Map.GeometryEvents),t.renderer={},t.renderer.Canvas=t.Class.extend({isCanvasRender:function(){return!0},render:function(e){if(this.prepareRender(),this.getMap()){if(!this.layer.isVisible())return void this.completeRender();if(this.resources||(this.resources=new t.renderer.Canvas.Resources),this.checkResources&&e){var i=this,n=arguments,r=this.checkResources.apply(this,n);t.Util.isArrayHasData(r)?this.loadResources(r).then(function(){i.layer&&(i.layer.fire("resourceload"),i._tryToDraw.apply(i,n))}):this._tryToDraw.apply(this,n)}else this._tryToDraw.apply(this,arguments)}},remove:function(){this._clearTimeout(),this.onRemove&&this.onRemove(),delete this._northWest,delete this.canvas,delete this.context,delete this._extent2D,delete this.resources,t.renderer.Canvas.prototype.requestMapToRender.call(this),delete this.layer},getMap:function(){return this.layer?this.layer.getMap():null},getCanvasImage:function(){if(this._renderZoom!==this.getMap().getZoom()||!this.canvas)return null;if(this.layer.isEmpty&&this.layer.isEmpty()||!this._extent2D)return null;if(this.isBlank&&this.isBlank())return null;var t=this.getMap(),e=this._extent2D.getSize(),i=t._pointToContainerPoint(this._northWest,this._renderZoom);return{image:this.canvas,layer:this.layer,point:i,size:e,transform:this._transform}},isLoaded:function(){return!!this._loaded},show:function(){var t=this.layer.getMask();t&&t.onZoomEnd(),this.render(!0)},hide:function(){this.clearCanvas(),this.requestMapToRender()},setZIndex:function(){this.requestMapToRender()},hitDetect:function(e){if(!this.context||this.layer.isEmpty&&this.layer.isEmpty()||this._errorThrown||this.layer instanceof t.TileLayer)return!1;var i=this.getMap()._get2DExtent(),n=i.getSize(),r=i.getMin(),o=e.substract(r);if(o.x<0||o.x>n.width||o.y<0||o.y>n.height)return!1;try{if(this.context.getImageData(o.x,o.y,1,1).data[3]>0)return!0}catch(t){return this._errorThrown||(console&&console.warn("hit detect failed with tainted canvas, some geometries have external resources in another domain:\n",t),this._errorThrown=!0),!1}return!1},loadResources:function(e){var i=this.resources,n=[];if(t.Util.isArrayHasData(e))for(var r,o={},s=e.length-1;s>=0;s--)(r=e[s])&&!o[r.join("-")]&&(o[r.join("-")]=1,i.isResourceLoaded(r,!0)||n.push(new t.Promise(this._promiseResource(r))));return t.Promise.all(n)},prepareRender:function(){var e=this.getMap();this._renderZoom=e.getZoom(),this._extent2D=e._get2DExtent(),this._northWest=e._containerPointToPoint(new t.Point(0,0)),this._loaded=!1},createCanvas:function(){if(!this.canvas){var e=this.getMap(),i=e.getSize(),n=t.Browser.retina?2:1;this.canvas=t.Canvas.createCanvas(n*i.width,n*i.height,e.CanvasClass),this.context=this.canvas.getContext("2d"),this.layer.options.globalCompositeOperation&&(this.context.globalCompositeOperation=this.layer.options.globalCompositeOperation),t.Browser.retina&&this.context.scale(2,2),t.Canvas.setDefaultCanvasSetting(this.context),this.onCanvasCreate&&this.onCanvasCreate()}},resizeCanvas:function(e){if(this.canvas){var i;if(e)i=e;else{i=this.getMap().getSize()}var n=t.Browser.retina?2:1;this.canvas.width===n*i.width&&this.canvas.height===n*i.height||(this.canvas.height=n*i.height,this.canvas.width=n*i.width,t.Browser.retina&&this.context.scale(2,2))}},clearCanvas:function(){this.canvas&&t.Canvas.clearRect(this.context,0,0,this.canvas.width,this.canvas.height)},prepareCanvas:function(){this._clipped&&(this.context.restore(),this._clipped=!1),this.canvas?this.clearCanvas():this.createCanvas();var t=this.layer.getMask();if(!t)return this.layer.fire("renderstart",{context:this.context}),null;var e=t._getPainter().get2DExtent();return e.intersects(this._extent2D)?(this.context.save(),t._paint(),this.context.clip(),this._clipped=!0,this.layer.fire("renderstart",{context:this.context}),e):(this.layer.fire("renderstart",{context:this.context}),e)},get2DExtent:function(){return this._extent2D},requestMapToRender:function(){this.getMap()&&!this._suppressMapRender&&(this.context&&this.layer.fire("renderend",{context:this.context}),this.getMap()._getRenderer().render())},fireLoadedEvent:function(){this._loaded=!0,this.layer&&!this._suppressMapRender&&this.layer.fire("layerload")},completeRender:function(){this.requestMapToRender(),this.fireLoadedEvent()},getPaintContext:function(){return this.context?[this.context,this.resources]:null},getEvents:function(){return{_zoomstart:this.onZoomStart,_zoomend:this.onZoomEnd,_zooming:this.onZooming,_resize:this.onResize,_movestart:this.onMoveStart,_moving:this.onMoving,_moveend:this.onMoveEnd}},isUpdateWhenZooming:function(){return!1},onZooming:function(t){var e=this.getMap();e&&this.layer.isVisible()&&(this._suppressMapRender=!0,this.prepareRender(),this.drawOnZooming&&this.isUpdateWhenZooming()?(this.prepareCanvas(),this.drawOnZooming(t)):e._pitch?e._pitch&&this.prepareCanvas():this._transform=t.matrix.container,this._suppressMapRender=!1)},onZoomStart:function(){delete this._transform},onZoomEnd:function(){delete this._transform,this._drawOnEvent()},onMoveStart:function(){},onMoving:function(){this.getMap()._pitch&&this._drawOnEvent()},onMoveEnd:function(){this._drawOnEvent()},onResize:function(){delete this._extent2D,this.resizeCanvas(),this._drawOnEvent()},_tryToDraw:function(){if(this._clearTimeout(),!this.canvas&&this.layer.isEmpty&&this.layer.isEmpty())return void this.fireLoadedEvent();var e=this,i=arguments;this.layer.options.drawImmediate?(this._painted=!0,this.draw.apply(this,i)):this._currentFrameId=t.Util.callImmediate(function(){e.layer&&(e._painted=!0,e.draw.apply(e,i))})},_promiseResource:function(e){var i=this,n=this.resources,r=this.layer.options.crossOrigin;return function(o){if(n.isResourceLoaded(e,!0))return void o(e);var s=new Image;r&&(s.crossOrigin=r),t.Util.isSVG(e[0])&&!t.node&&(e[1]&&(e[1]*=2),e[2]&&(e[2]*=2)),s.onload=function(){i._cacheResource(e,s),o(e)},s.onabort=function(t){console&&console.warn("image loading aborted: "+e[0]),t&&console&&console.warn(t),o(e)},s.onerror=function(i){i&&!t.Browser.phantomjs&&console&&console.warn(i),n.markErrorResource(e),o(e)},t.Util.loadImage(s,e)}},_cacheResource:function(e,i){if(this.layer&&this.resources){var n=e[1],r=e[2];if(this.layer.options.cacheSvgOnCanvas&&1===t.Util.isSVG(e[0])&&(t.Browser.edge||t.Browser.ie)){t.Util.isNil(n)&&(n=i.width||this.layer.options.defaultIconSize[0]),t.Util.isNil(r)&&(r=i.height||this.layer.options.defaultIconSize[1]);var o=t.Canvas.createCanvas(n,r);t.Canvas.image(o.getContext("2d"),i,0,0,n,r),i=o}this.resources.addResource(e,i)}},_drawOnEvent:function(){this._painted?(this.prepareRender(),this.layer.isVisible()&&this.draw()):this.render(!0)},_clearTimeout:function(){this._currentFrameId&&t.Util.clearCallImmediate(this._currentFrameId)}}),t.renderer.Canvas.Resources=function(){this.resources={},this._errors={}},t.Util.extend(t.renderer.Canvas.Resources.prototype,{addResource:function(t,e){this.resources[t[0]]={image:e,width:+t[1],height:+t[2]}},isResourceLoaded:function(e,i){if(!e)return!1;if(this._errors[this._getImgUrl(e)])return!0;var n=this.resources[this._getImgUrl(e)];return!!n&&!(i&&t.Util.isSVG(e[0])&&(+e[1]>n.width||+e[2]>n.height))},getImage:function(t){return!this.isResourceLoaded(t)||this._errors[this._getImgUrl(t)]?null:this.resources[this._getImgUrl(t)].image},markErrorResource:function(t){this._errors[this._getImgUrl(t)]=1},merge:function(t){if(!t)return this;for(var e in t.resources){var i=t.resources[e];this.addResource([e,i.width,i.height],i.image)}return this},_getImgUrl:function(e){return t.Util.isArray(e)?e[0]:e}}),t.renderer.map={},t.renderer.map.Renderer=t.Class.extend({panAnimation:function(e,i,n){e=new t.Point(e);var r=this.map;if(r.options.panAnimation){var o;o=i?i:r.options.panAnimationDuration,r._enablePanAnimation=!0,r._panAnimating=!0;var s=null,a=t.Animation.animate({distance:e},{easing:"out",speed:o},function(t){if(!r._enablePanAnimation)return a.finish(),r._panAnimating=!1,void r.onMoveEnd();if("running"===a.playState&&t.styles.distance){var e=t.styles.distance;s||(s=e);var i=e.substract(s);r.offsetPlatform(i),r._offsetCenterByPixel(i),s=e,r.onMoving()}else"finished"===a.playState&&(r._panAnimating=!1,n&&n(),r.onMoveEnd())});a.play()}else r.onMoveEnd()},offsetPlatform:function(e){if(!this.map._panels.front)return this;var i=this.map.offsetPlatform().add(e)._round();return t.DomUtil.offsetDom(this.map._panels.back,i),t.DomUtil.offsetDom(this.map._panels.front,i),this},resetContainer:function(){if(this.map._resetMapViewPoint(),this.map._panels.front){var e=new t.Point(0,0);t.DomUtil.offsetDom(this.map._panels.back,e),t.DomUtil.offsetDom(this.map._panels.front,e)}},onZoomEnd:function(){this.resetContainer()},onLoad:function(){this.render()}}),t.renderer.map.Canvas=t.renderer.map.Renderer.extend({initialize:function(t){this.map=t,this._isCanvasContainer=!!t._containerDOM.getContext,this._registerEvents()},isCanvasRender:function(){return!0},enableRender:function(){this._suppressRender=!1},disableRender:function(){this._suppressRender=!0},render:function(){if(this.map&&!this._suppressRender){this.map._fireEvent("renderstart",{context:this.context}),this.canvas||this.createCanvas();var t=this._getAllLayerToRender();this._updateCanvasSize()||this.clearCanvas(),this._drawBackground();var e=0,i=t.length;if(this.map._zooming||this.map._moving){var n=this.map.options.numOfLayersOnInteracting;n>0&&i>n&&(e=i-n)}for(var r=e;r<i;r++)if(t[r].isVisible()&&t[r].isCanvasRender()){var o=t[r]._getRenderer();if(o){var s=this._getLayerImage(t[r]);s&&s.image&&this._drawLayerCanvasImage(t[r],s)}}this._drawCenterCross(),this.map._fireEvent("renderend",{context:this.context})}},updateMapSize:function(t){if(t&&!this._isCanvasContainer){var e=t.width+"px",i=t.height+"px",n=this.map._panels;n.mapWrapper.style.width=e,n.mapWrapper.style.height=i,n.front.style.width=n.frontLayer.style.width=e,n.front.style.height=n.frontLayer.style.height=i,n.back.style.width=n.layer.style.width=e,n.back.style.height=n.layer.style.height=i,n.front.style.perspective=n.back.style.perspective=i,this._updateCanvasSize()}},getMainPanel:function(){return this.map?this._isCanvasContainer?this.map._containerDOM:this.map._panels?this.map._panels.mapWrapper:null:null},toDataURL:function(t){return this.canvas?this.canvas.toDataURL(t):null},remove:function(){this._resizeInterval&&clearInterval(this._resizeInterval),this._resizeFrame&&t.Util.cancelAnimFrame(this._resizeFrame),delete this.context,delete this.canvas,delete this.map,delete this._canvasBgRes,delete this._canvasBgCoord,delete this._canvasBg},_getLayerImage:function(t){return t&&t._getRenderer()&&t._getRenderer().getCanvasImage?t._getRenderer().getCanvasImage():null},_getCountOfGeosToDraw:function(){for(var e,i=this._getAllLayerToRender(),n=0,r=i.length-1;r>=0;r--)e=i[r]._getRenderer(),i[r]instanceof t.OverlayLayer&&i[r].isVisible()&&!i[r].isEmpty()&&e._hasPointSymbolizer&&e._geosToDraw&&(n+=e._geosToDraw.length);return n},initContainer:function(){function e(e,n,r,o){var s=t.DomUtil.createEl("div",n);return r&&(s.style.cssText=r),i[e]=s,o||t.DomUtil.preventSelection(s),s}var i=this.map._panels,n=this.map._containerDOM;if(!this._isCanvasContainer){n.innerHTML="";var r=e("control","maptalks-control",null,!0),o=e("mapWrapper","maptalks-wrapper","position:absolute;overflow:hidden;",!0),s=e("front","maptalks-front","position:absolute;top:0px;left:0px;will-change:transform;",!0),a=e("ui","maptalks-ui","position:absolute;top:0px;left:0px;border:none;",!0),h=e("allLayers","maptalks-all-layers","position:absolute;",!0),l=e("back","maptalks-back","position:absolute;left:0px;top:0px;will-change:transform;"),u=e("layer","maptalks-layer","position:absolute;left:0px;top:0px;"),c=e("frontLayer","maptalks-front-layer","position:absolute;left:0px;top:0px;"),d=e("canvasContainer","maptalks-layer-canvas","position:relative;border:none;");n.appendChild(o),l.appendChild(u),h.appendChild(l),h.appendChild(d),s.appendChild(c),s.appendChild(a),h.appendChild(s),o.appendChild(h),o.appendChild(r),this.createCanvas(),this.resetContainer();var m=this.map._getContainerDomSize();this.updateMapSize(m)}},_drawLayerCanvasImage:function(e,i){if(e&&i){var n=this.context,r=i.point.multi(t.Browser.retina?2:1),o=i.image;if(!(r.x+o.width<=0||r.y+o.height<=0)){var s=e.options.opacity;if(t.Util.isNumber(s)||(s=1),!(s<=0)){var a=i.opacity;if(t.Util.isNumber(a)||(a=1),!(a<=0)){var h=n.globalAlpha;if(s<1&&(n.globalAlpha*=s),a<1&&(n.globalAlpha*=a),e.options.cssFilter&&(n.filter=e.options.cssFilter),i.transform&&(n.save(),n.setTransform.apply(n,i.transform)),t.node){var l=o.getContext("2d");l.getSvg&&(o=l)}(e.options.dx||e.options.dy)&&r._add(e.options.dx,e.options.dy),n.drawImage(o,r.x,r.y),n.globalAlpha=h,"none"!==n.filter&&(n.filter="none"),i.transform&&n.restore()}}}}},_storeBackground:function(e){if(e){var i=this.map;this._canvasBg=t.DomUtil.copyCanvas(e.image),this._canvasBgRes=i._getResolution(),this._canvasBgCoord=i.containerPointToCoordinate(e.point)}},_drawBackground:function(){var e=this.map;if(this._canvasBg){var i=this.map.getBaseLayer();i.options.cssFilter&&(this.context.filter=i.options.cssFilter);var n=this._canvasBgRes/e._getResolution(),r=e.coordinateToContainerPoint(this._canvasBgCoord)._multi(t.Browser.retina?2:1);t.Canvas.image(this.context,this._canvasBg,r.x,r.y,this._canvasBg.width*n,this._canvasBg.height*n),"none"!==this.context.filter&&(this.context.filter="none")}},_drawCenterCross:function(){var e=this.map.options.centerCross;if(e){var i=this.context,n=new t.Point(this.canvas.width/2,this.canvas.height/2);t.Util.isFunction(e)?e(i,n):(i.strokeStyle="#ff0000",i.lineWidth=2,i.beginPath(),i.moveTo(n.x-5,n.y),i.lineTo(n.x+5,n.y),i.moveTo(n.x,n.y-5),i.lineTo(n.x,n.y+5),i.stroke())}},_getAllLayerToRender:function(){return this.map._getLayers()},clearCanvas:function(){this.canvas&&t.Canvas.clearRect(this.context,0,0,this.canvas.width,this.canvas.height)},_updateCanvasSize:function(){if(!this.canvas||this._isCanvasContainer)return!1;var e=this.map,i=e.getSize(),n=this.canvas,r=t.Browser.retina?2:1;return(i.width*r!==n.width||i.height*r!==n.height)&&(n.height=r*i.height,n.width=r*i.width,n.style&&(n.style.width=i.width+"px",n.style.height=i.height+"px"),!0)},createCanvas:function(){this._isCanvasContainer?this.canvas=this.map._containerDOM:(this.canvas=t.DomUtil.createEl("canvas"),this._updateCanvasSize(),this.map._panels.canvasContainer.appendChild(this.canvas)),this.context=this.canvas.getContext("2d")},_checkSize:function(){t.Util.cancelAnimFrame(this._resizeFrame),this.map._zooming||this.map._moving||this.map._panAnimating||(this._resizeFrame=t.Util.requestAnimFrame(t.Util.bind(function(){this.map._moving||this.map._isBusy()||this.map.checkSize()},this)))},_registerEvents:function(){var e=this.map;e.on("_baselayerchangestart",function(){delete this._canvasBg},this),e.on("_baselayerload",function(){var t=e.getBaseLayer();e.options.zoomBackground&&!t.getMask()||delete this._canvasBg},this),e.on("_resize",function(){delete this._canvasBg
},this),e.on("_zoomstart",function(){delete this._canvasBg},this),e.options.checkSize&&!t.node&&"undefined"!=typeof window&&(this._resizeInterval=setInterval(t.Util.bind(function(){e._containerDOM.parentNode?this._checkSize():clearInterval(this._resizeInterval)},this),1e3)),!t.Browser.mobile&&t.Browser.canvas&&(this._onMapMouseMove=function(i){e._isBusy()||e._moving||!e.options.hitDetect||(this._hitDetectFrame&&t.Util.cancelAnimFrame(this._hitDetectFrame),this._hitDetectFrame=t.Util.requestAnimFrame(function(){if(!e._isBusy()&&!e._moving&&e.options.hitDetect){for(var t,n=i.point2d,r=e._getLayers(),o=!1,s=e.options.hitDetectLimit||0,a=0,h=r.length-1;h>=0;h--){var l=r[h],u=l._getRenderer();if((!l.isEmpty||!l.isEmpty())&&(!u.isBlank||!u.isBlank())&&u&&u.hitDetect){if("default"!==l.options.cursor&&u.hitDetect(n)){t=l.options.cursor,o=!0;break}if(a++,s>0&&a>s)break}}o?e._trySetCursor(t):e._trySetCursor("default")}}))},e.on("_mousemove",this._onMapMouseMove,this)),e.on("_moving _moveend",function(){e._pitch||this.render()},this)}}),t.Map.registerRenderer("canvas",t.renderer.map.Canvas),t.TileLayer.TileCache=function(t){this._queue=[],this._cache={},t||(t=128),this.capacity=t},t.Util.extend(t.TileLayer.TileCache.prototype,{add:function(t,e){this._cache[t]=e,this._queue.push(t),this._expireCache()},get:function(t){return this._cache[t]},remove:function(t){delete this._cache[t]},_expireCache:function(){this._expTimeout&&clearTimeout(this._expTimeout);var t=this;this._expTimeout=setTimeout(function(){var e=t._queue.length;if(e>t.capacity)for(var i=t._queue.splice(0,e-t.capacity),n=i.length-1;n>=0;n--)delete t._cache[i[n]]},1e3)}}),t.renderer.tilelayer={},t.renderer.tilelayer.Canvas=t.renderer.Canvas.extend({propertyOfPointOnTile:"--maptalks-tile-point",propertyOfTileId:"--maptalks-tile-id",propertyOfTileZoom:"--maptalks-tile-zoom",initialize:function(e){this.layer=e,this._mapRender=e.getMap()._getRenderer(),!t.node&&this.layer.options.cacheTiles&&(this._tileCache=new t.TileLayer.TileCache),this._tileQueue={}},clear:function(){this.clearCanvas(),this.requestMapToRender()},clearExecutors:function(){clearTimeout(this._loadQueueTimeout)},draw:function(){var e=this.layer,i=e._getTiles();if(!i)return void this.completeRender();this._tileRended||(this._tileRended={});var n=this._tileRended;this._tileRended={};var r=i.tiles,o=this._tileCache,s=e.getTileSize();this._extent2D=i.fullExtent,this._northWest=i.northWest,this.canvas||this.createCanvas(),this.resizeCanvas(i.fullExtent.getSize());var a=this.prepareCanvas();if(a&&!a.intersects(this._extent2D))return void this.completeRender();this._totalTileToLoad=this._tileToLoadCounter=0;for(var h,l,u,c,d=r.length-1;d>=0;d--)h=r[d],l=r[d].id,u=n[l]||(o?o.get(l):null),c=new t.PointExtent(h.point,h.point.add(s.toPoint())),!this._extent2D.intersects(c)||a&&!a.intersects(c)||(this._totalTileToLoad++,u?(this._drawTile(h.point,u),this._tileRended[l]=u):(this._tileToLoadCounter++,this._tileQueue[l+"@"+h.point.toString()]=h));0===this._tileToLoadCounter?this.completeRender():(this._tileToLoadCounter<this._totalTileToLoad&&this.requestMapToRender(),this._scheduleLoadTileQueue())},_scheduleLoadTileQueue:function(){this._loadQueueTimeout&&t.Util.cancelAnimFrame(this._loadQueueTimeout);var e=this;this._loadQueueTimeout=t.Util.requestAnimFrame(function(){e._loadTileQueue()})},_loadTileQueue:function(){function e(){t.node||(o._tileCache&&o._tileCache.add(this[o.propertyOfTileId],this),o._tileRended[this[o.propertyOfTileId]]=this),o._drawTileAndRequest(this)}function i(){o._clearTileRectAndRequest(this)}var n,r,o=this;for(var s in this._tileQueue)this._tileQueue.hasOwnProperty(s)&&(n=s.split("@")[0],r=this._tileQueue[s],delete this._tileQueue[s],this._tileCache&&this._tileCache[n]?this._drawTileAndRequest(this._tileCache[n]):this._loadTile(n,r,e,i))},_loadTile:function(e,i,n,r){var o=this.layer.options.crossOrigin,s=this.layer.getTileSize(),a=new Image;a.width=s.width,a.height=s.height,a[this.propertyOfTileId]=e,a[this.propertyOfPointOnTile]=i.point,a[this.propertyOfTileZoom]=i.zoom,a.onload=n,a.onabort=r,a.onerror=r,o&&(a.crossOrigin=o),t.Util.loadImage(a,[i.url])},_drawTile:function(e,i){if(e){var n=this.layer.getTileSize();if(t.Canvas.image(this.context,i,Math.floor(e.x-this._northWest.x),Math.floor(e.y-this._northWest.y),n.width,n.height),this.layer.options.debug){var r=e.substract(this._northWest);this.context.save(),this.context.strokeStyle="rgb(0,0,0)",this.context.fillStyle="rgb(0,0,0)",this.context.strokeWidth=10,this.context.font="15px monospace",t.Canvas.rectangle(this.context,r,n,1,0);var o=i[this.propertyOfTileId].split("__");t.Canvas.fillText(this.context,"x:"+o[1]+",y:"+o[0]+",z:"+o[2],r.add(10,20),"rgb(0,0,0)"),this.context.restore()}i=null}},_drawTileAndRequest:function(e){if(this.getMap()){if(this.getMap().getZoom()===e[this.propertyOfTileZoom]){this._tileToLoadCounter--;var i=e[this.propertyOfPointOnTile];if(this._drawTile(i,e),!t.node){var n=this.layer.getTileSize();this.getMap()._get2DExtent().intersects(new t.PointExtent(i,i.add(n.width,n.height)))&&this.requestMapToRender()}0===this._tileToLoadCounter&&this._onTileLoadComplete()}}},_onTileLoadComplete:function(){t.node&&this.requestMapToRender(),this.fireLoadedEvent()},_clearTileRectAndRequest:function(e){if(this.getMap()){this.getMap().getZoom()===e[this.propertyOfTileZoom]&&(t.node||this.requestMapToRender(),0===--this._tileToLoadCounter&&this._onTileLoadComplete())}},requestMapToRender:function(){if(t.node)return void(this.getMap()&&!this.getMap()._isBusy()&&this._mapRender.render());this._mapRenderRequest&&t.Util.cancelAnimFrame(this._mapRenderRequest);var e=this;this._mapRenderRequest=t.Util.requestAnimFrame(function(){e.getMap()&&!e.getMap()._isBusy()&&e._mapRender.render()})},onRemove:function(){delete this._mapRender,delete this._tileCache,delete this._tileRended,delete this._tileQueue}}),t.TileLayer.registerRenderer("canvas",t.renderer.tilelayer.Canvas),t.renderer.tilelayer.Dom=t.Class.extend({initialize:function(e){this.layer=e,this._tiles={},this._fadeAnimated=!t.Browser.mobile&&!0},getMap:function(){return this.layer.getMap()},show:function(){this._container&&(this.render(),this._container.style.display="")},hide:function(){this._container&&(this._container.style.display="none",this.clear())},remove:function(){delete this._tiles,delete this.layer,this._removeLayerContainer()},clear:function(){this._removeAllTiles(),this._clearLayerContainer()},setZIndex:function(t){this._zIndex=t,this._container&&(this._container.style.zIndex=t)},isCanvasRender:function(){return!1},render:function(){var e=this.layer;this._container||this._createLayerContainer();var i=e._getTiles();if(i){this._currentTileZoom=this.getMap().getZoom();var n=i.tiles,r=[];if(this._tiles)for(var o in this._tiles)this._tiles[o].current=!1;var s,a,h;for(s=n.length-1;s>=0;s--)h=n[s],this._tiles[h.id]?this._tiles[h.id].current=!0:(h.current=!0,r.push(h));var l=this._getTileContainer();if(t.DomUtil.removeTransform(l),r.length>0){var u=document.createDocumentFragment();for(s=0,a=r.length;s<a;s++)u.appendChild(this._loadTile(r[s]));l.appendChild(u)}}},onZooming:function(e){var i=Math.floor(e.from);this._levelContainers&&this._levelContainers[i]&&t.DomUtil.setTransformMatrix(this._levelContainers[i],e.matrix.view)},_loadTile:function(e){return this._tiles[e.id]=e,this._createTile(e,t.Util.bind(this._tileReady,this))},_createTile:function(e,i){var n=this.layer.getTileSize(),r=t.DomUtil.createEl("img");e.el=r,t.DomUtil.on(r,"load",t.Util.bind(this._tileOnLoad,this,i,e)),t.DomUtil.on(r,"error",t.Util.bind(this._tileOnError,this,i,e)),this.layer.options.crossOrigin&&(e.crossOrigin=this.layer.options.crossOrigin),r.style.position="absolute";var o=this.getMap()._pointToViewPoint(e.point);return r.style.left=Math.floor(o.x)+"px",r.style.top=Math.floor(o.y)+"px",r.alt="",r.width=n.width,r.height=n.height,t.DomUtil.setOpacity(r,0),this.layer.options.cssFilter&&(r.style[t.DomUtil.CSSFILTER]=this.layer.options.cssFilter),r.src=e.url,r},_tileReady:function(e,i){if(this.layer){e&&this.layer.fire("tileerror",{error:e,tile:i}),i.loaded=t.Util.now();var n=this.getMap();if(this._fadeAnimated&&(i.el.style[t.DomUtil.TRANSITION]="opacity 250ms"),t.DomUtil.setOpacity(i.el,1),i.active=!0,this.layer.fire("tileload",{tile:i}),this._noTilesToLoad())if(this.layer.fire("layerload"),t.Browser.ielt9)t.Util.requestAnimFrame(this._pruneTiles,this);else{this._pruneTimeout&&clearTimeout(this._pruneTimeout);var r=n?n.options.zoomAnimationDuration:250,o=!n||this.layer!==n.getBaseLayer()||!n.options.zoomBackground;this._pruneTimeout=setTimeout(t.Util.bind(this._pruneTiles,this,o),r+100)}}},_tileOnLoad:function(e,i){t.Browser.ielt9?setTimeout(t.Util.bind(e,this,null,i),0):e.call(this,null,i)},_tileOnError:function(t,e){var i=this.layer.options.errorTileUrl;i?e.el.src=i:e.el.style.display="none",t.call(this,"error",e)},_noTilesToLoad:function(){for(var t in this._tiles)if(!this._tiles[t].loaded)return!1;return!0},_pruneTiles:function(e){var i=this.getMap();if(i&&!i._moving){var n,r=this._currentTileZoom;if(!this.layer.isVisible())return void this._removeAllTiles();for(n in this._tiles)this._tiles[n].zoom!==r||this._tiles[n].current||this._removeTile(n);if(e){for(n in this._tiles)this._tiles[n].zoom!==r&&this._removeTile(n);for(var o in this._levelContainers)+o!==r&&(t.DomUtil.removeDomNode(this._levelContainers[o]),this._removeTilesAtZoom(o),delete this._levelContainers[o])}}},_removeTile:function(e){var i=this._tiles[e];i&&(t.DomUtil.removeDomNode(i.el),delete this._tiles[e],this.layer.fire("tileunload",{tile:i}))},_removeTilesAtZoom:function(t){for(var e in this._tiles)+this._tiles[e].zoom==+t&&this._removeTile(e)},_removeAllTiles:function(){for(var t in this._tiles)this._removeTile(t)},_getTileContainer:function(){this._levelContainers||(this._levelContainers={});var e=this.getMap().getZoom();if(!this._levelContainers[e]){var i=this._levelContainers[e]=t.DomUtil.createEl("div","maptalks-tilelayer-level");i.style.cssText="position:absolute;left:0px;top:0px;",i.style.willChange="transform",this._container.appendChild(i)}return this._levelContainers[e]},_createLayerContainer:function(){var e=this._container=t.DomUtil.createEl("div","maptalks-tilelayer");e.style.cssText="position:absolute;left:0px;top:0px;",this._zIndex&&(e.style.zIndex=this._zIndex),("front"===this.layer.options.container?this.getMap()._panels.frontLayer:this.getMap()._panels.layer).appendChild(e)},_clearLayerContainer:function(){this._container&&(this._container.innerHTML=""),delete this._levelContainers},_removeLayerContainer:function(){this._container&&t.DomUtil.removeDomNode(this._container),delete this._container,delete this._levelContainers},getEvents:function(){var e={_zoomstart:this.onZoomStart,_touchzoomstart:this._onTouchZoomStart,_zooming:this.onZooming,_zoomend:this.onZoomEnd,"_moveend _resize":this.render,_movestart:this.onMoveStart};if(!this._onMapMoving&&this.layer.options.renderWhenPanning){var i=this.layer.options.updateInterval;t.Util.isNumber(i)&&i>=0&&(this._onMapMoving=i>0?t.Util.throttle(function(){this.render()},i,this):function(){this.render()})}return this._onMapMoving&&(e._moving=this._onMapMoving),e},_canTransform:function(){return t.Browser.any3d||t.Browser.ie9},onMoveStart:function(){},_onTouchZoomStart:function(){this._pruneTiles(!0)},onZoomStart:function(){this._fadeAnimated=!t.Browser.mobile&&!0,this._pruneTiles(!0),this._zoomStartPos=this.getMap().offsetPlatform(),!this._canTransform()&&this._container&&(this._container.style.display="none")},onZoomEnd:function(t){this._pruneTimeout&&clearTimeout(this._pruneTimeout),this.render(),this._levelContainers&&(this._canTransform()?this._levelContainers[t.from]&&this._zoomStartPos&&(this._levelContainers[t.from].style.left=this._zoomStartPos.x+"px",this._levelContainers[t.from].style.top=this._zoomStartPos.y+"px"):(this._levelContainers[t.from]&&(this._levelContainers[t.from].style.display="none"),this._container.style.display=""))}});t.TileLayer.registerRenderer("dom",t.renderer.tilelayer.Dom),t.renderer.canvastilelayer={},t.renderer.canvastilelayer.Canvas=t.renderer.tilelayer.Canvas.extend({_loadTile:function(e,i,n,r){var o=this.layer.getTileSize(),s=this.canvas.constructor,a=this.getMap(),h=t.Browser.retina?2:1,l=t.Canvas.createCanvas(o.width*h,o.height*h,s);l[this.propertyOfTileId]=e,l[this.propertyOfPointOnTile]=i.viewPoint,l[this.propertyOfTileZoom]=i.zoom,this.layer.drawTile(l,{url:i.url,viewPoint:i.viewPoint,zoom:i.zoom,extent:a._pointToExtent(new t.PointExtent(i["2dPoint"],i["2dPoint"].add(o.toPoint())))},function(t){if(t)return void r.call(l);n.call(l)})}}),t.CanvasTileLayer.registerRenderer("canvas",t.renderer.canvastilelayer.Canvas),t.renderer.vectorlayer={},t.renderer.overlaylayer={},t.renderer.overlaylayer.Canvas=t.renderer.Canvas.extend({checkResources:function(e){if(this._resourceChecked||t.Util.isArray(e)||(e=this.layer._geoList),!e||!t.Util.isArrayHasData(e))return[];for(var i,n=this,r=[],o=e.length-1;o>=0;o--)!function(e){if(i=e._getExternalResources(),t.Util.isArrayHasData(i))if(n.resources)for(var o=0;o<i.length;o++)n.resources.isResourceLoaded(i[o])||r.push(i[o]);else r=r.concat(i)}(e[o]);return this._resourceChecked=!0,r},onGeometryAdd:function(t){this.render(t)},onGeometryRemove:function(){this.render()},onGeometrySymbolChange:function(t){this.render([t.target])},onGeometryShapeChange:function(){this.render()},onGeometryPositionChange:function(){this.render()},onGeometryZIndexChange:function(){this.render()},onGeometryShow:function(){this.render()},onGeometryHide:function(){this.render()},onGeometryPropertiesChange:function(){this.render()}}),t.renderer.vectorlayer.Canvas=t.renderer.overlaylayer.Canvas.extend({initialize:function(t){this.layer=t},checkResources:function(){var e=this,i=t.renderer.overlaylayer.Canvas.prototype.checkResources.apply(this,arguments),n=this.layer.getStyle();return n&&(t.Util.isArray(n)||(n=[n]),n.forEach(function(n){var r=t.Util.getExternalResources(n.symbol,!0);if(r)for(var o=0;o<r.length;o++)e.resources.isResourceLoaded(r[o])||i.push(r[o])})),i},draw:function(){if(this.getMap()){if(!this.layer.isVisible()||this.layer.isEmpty())return this.clearCanvas(),void this.completeRender();this._drawGeos(),this.completeRender()}},drawOnZooming:function(){for(var t=0,e=this._geosToDraw.length;t<e;t++)this._geosToDraw[t]._paint()},isBlank:function(){return this._isBlank},show:function(){this.layer.forEach(function(t){t._repaint()}),t.renderer.Canvas.prototype.show.apply(this,arguments)},isUpdateWhenZooming:function(){var t=this.getMap(),e=t._getRenderer()._getCountOfGeosToDraw();return this._hasPointSymbolizer&&e>0&&e<=t.options.pointThresholdOfZoomAnimation},_drawGeos:function(){if(this.getMap()){var t=this.layer;if(t.isEmpty())return void this.fireLoadedEvent();if(!t.isVisible())return void this.fireLoadedEvent();var e=this.prepareCanvas(),i=this._extent2D;if(e){if(!e.intersects(i))return void this.fireLoadedEvent();i=i.intersection(e)}this._prepareToDraw(),this._displayExtent=i,this._forEachGeo(this._checkGeo,this);for(var n=0,r=this._geosToDraw.length;n<r;n++)this._geosToDraw[n]._paint()}},_prepareToDraw:function(){this._isBlank=!0,this._hasPointSymbolizer=!1,this._geosToDraw=[]},_checkGeo:function(t){if(t&&t.isVisible()&&t.getMap()&&t.getLayer()&&t.getLayer().isCanvasRender()){var e=t._getPainter(),i=e.get2DExtent(this.resources);i&&i.intersects(this._displayExtent)&&(this._isBlank=!1,e.hasPointSymbolizer()&&(this._hasPointSymbolizer=!0),this._geosToDraw.push(t))}},_forEachGeo:function(t,e){this.layer.forEach(t,e)},onZooming:function(){var e=this.getMap();this.layer.isVisible()&&(e._pitch||this.isUpdateWhenZooming())&&this._geosToDraw.forEach(function(t){t._removeZoomCache()}),t.renderer.Canvas.prototype.onZooming.apply(this,arguments)},onZoomEnd:function(){delete this._extent2D,this.layer.isVisible()&&this.layer.forEach(function(t){t._removeZoomCache()}),t.renderer.Canvas.prototype.onZoomEnd.apply(this,arguments)},onRemove:function(){this._forEachGeo(function(t){t.onHide()}),delete this._geosToDraw},onGeometryPropertiesChange:function(t){t&&this.layer._styleGeometry(t.target)}}),t.VectorLayer.registerRenderer("canvas",t.renderer.vectorlayer.Canvas),t.symbolizer={},t.Symbolizer=t.Class.extend({getMap:function(){return this.geometry.getMap()},getPainter:function(){return this.painter}}),t.Symbolizer.resourceProperties=["markerFile","polygonPatternFile","linePatternFile","markerFillPatternFile","markerLinePatternFile"],t.Symbolizer.resourceSizeProperties=[["markerWidth","markerHeight"],[],[null,"lineWidth"],[],[null,"markerLineWidth"]],t.Symbolizer.numberProperties={lineWidth:1,lineOpacity:1,polygonOpacity:1,markerWidth:1,markerHeight:1,markerDx:1,markerDy:1,markerOpacity:1,markerFillOpacity:1,markerLineWidth:1,markerLineOpacity:1,textSize:1,textOpacity:1,textHaloRadius:1,textWrapWidth:1,textLineSpacing:1,textDx:1,textDy:1},t.Symbolizer.colorProperties=["lineColor","polygonFill","markerFill","markerLineColor","textFill"],t.Symbolizer.DEFAULT_STROKE_COLOR="#000",t.Symbolizer.DEFAULT_FILL_COLOR="rgba(255,255,255,0)",t.Symbolizer.DEFAULT_TEXT_COLOR="#000",t.Symbolizer.testColor=function(e){return!(!e||!t.Util.isString(e))&&t.Util.indexOfArray(e,t.Symbolizer.colorProperties)>=0},t.symbolizer.CanvasSymbolizer=t.Symbolizer.extend({_prepareContext:function(e){t.Util.isNumber(this.symbol.opacity)?e.globalAlpha!==this.symbol.opacity&&(e.globalAlpha=this.symbol.opacity):1!==e.globalAlpha&&(e.globalAlpha=1)},remove:function(){},setZIndex:function(){},show:function(){},hide:function(){},_defineStyle:function(e){var i=this,n=function(){return[i.getMap().getZoom(),i.geometry.getProperties()]},r=t.Util.loadFunctionTypes(e,n);return r?this._isFunctionStyle=!0:r=e,r}}),t.symbolizer.StrokeAndFillSymbolizer=t.symbolizer.CanvasSymbolizer.extend({initialize:function(e,i,n){this.symbol=e,this.geometry=i,this.painter=n,i instanceof t.Marker||(this.style=this._defineStyle(this.translate()))},symbolize:function(e,i){if(!(this.geometry instanceof t.Marker)){var n=this.style;if(0!==n.polygonOpacity||0!==n.lineOpacity){var r=this._getPaintParams();if(r){this._prepareContext(e);var o=t.Util.isGradient(n.lineColor),s=this.geometry.constructor===t.Polygon||this.geometry instanceof t.LineString;!o||!n.lineColor.places&&s||(n.lineGradientExtent=this.getPainter().getContainerExtent()._expand(n.lineWidth)),t.Util.isGradient(n.polygonFill)&&(n.polygonGradientExtent=this.getPainter().getContainerExtent());var a,h=r[0],l=this.geometry instanceof t.Polygon&&h.length>1&&t.Util.isArray(h[0][0])||this.geometry instanceof t.LineString&&h.length>1&&t.Util.isArray(h[0]);if(l)for(var u=0;u<h.length;u++)t.Canvas.prepareCanvas(e,n,i),o&&s&&!n.lineColor.places&&this._createGradient(e,h[u],n.lineColor),a=[e,h[u]],r.length>1&&a.push.apply(a,r.slice(1)),a.push(n.lineOpacity,n.polygonOpacity,n.lineDasharray),this.geometry._paintOn.apply(this.geometry,a);else t.Canvas.prepareCanvas(e,n,i),o&&s&&!n.lineColor.places&&this._createGradient(e,h,n.lineColor),a=[e],a.push.apply(a,r),a.push(n.lineOpacity,n.polygonOpacity,n.lineDasharray),this.geometry._paintOn.apply(this.geometry,a);e.setLineDash&&t.Util.isArrayHasData(n.lineDasharray)&&e.setLineDash([])}}}},get2DExtent:function(){if(this.geometry instanceof t.Marker)return null;var e=this.getMap(),i=this.geometry._getPrjExtent();if(!i)return null;this._extMin&&this._extMax||(this._extMin=new t.Coordinate(0,0),this._extMax=new t.Coordinate(0,0)),this._extMin.x=i.xmin,this._extMin.y=i.ymin,this._extMax.x=i.xmax,this._extMax.y=i.ymax;var n=e._prjToPoint(this._extMin),r=e._prjToPoint(this._extMax);return this._pxExtent?(n.x<r.x?(this._pxExtent.xmin=n.x,this._pxExtent.xmax=r.x):(this._pxExtent.xmax=n.x,this._pxExtent.xmin=r.x),n.y<r.y?(this._pxExtent.ymin=n.y,this._pxExtent.ymax=r.y):(this._pxExtent.ymax=n.y,this._pxExtent.ymin=r.y)):this._pxExtent=new t.PointExtent(n,r),this._pxExtent._expand(this.style.lineWidth/2)},_getPaintParams:function(){return this.getPainter().getPaintParams()},translate:function(){var e=this.symbol,i={lineColor:t.Util.getValueOrDefault(e.lineColor,"#000"),lineWidth:t.Util.getValueOrDefault(e.lineWidth,2),lineOpacity:t.Util.getValueOrDefault(e.lineOpacity,1),lineDasharray:t.Util.getValueOrDefault(e.lineDasharray,[]),lineCap:t.Util.getValueOrDefault(e.lineCap,"butt"),lineJoin:t.Util.getValueOrDefault(e.lineJoin,"miter"),linePatternFile:t.Util.getValueOrDefault(e.linePatternFile,null),polygonFill:t.Util.getValueOrDefault(e.polygonFill,null),polygonOpacity:t.Util.getValueOrDefault(e.polygonOpacity,1),polygonPatternFile:t.Util.getValueOrDefault(e.polygonPatternFile,null)};return 0===i.lineWidth&&(i.lineOpacity=0),this.geometry instanceof t.LineString&&!i.polygonFill&&(i.polygonFill=i.lineColor),i},_createGradient:function(t,e,i){var n=e.length,r=t.createLinearGradient(e[0].x,e[0].y,e[n-1].x,e[n-1].y);i.colorStops.forEach(function(t){r.addColorStop.apply(r,t)}),t.strokeStyle=r}}),t.symbolizer.StrokeAndFillSymbolizer.test=function(e,i){if(!e)return!1;if(i&&i instanceof t.Marker)return!1;for(var n in e){var r=n.slice(0,4);if("line"===r||"poly"===r)return!0}return!1},t.symbolizer.PointSymbolizer=t.symbolizer.CanvasSymbolizer.extend({get2DExtent:function(e){for(var i=this.getMap(),n=i.getMaxZoom(),r=new t.PointExtent,o=this.getMarkerExtent(e),s=this._getRenderPoints()[0],a=s.length-1;a>=0;a--)r._combine(i._pointToPoint(s[a],n));return r.xmin+=o.xmin,r.ymin+=o.ymin,r.xmax+=o.xmax,r.ymax+=o.ymax,r},_getRenderPoints:function(){return this.getPainter().getRenderPoints(this.getPlacement())},_getRenderContainerPoints:function(){var e=this.getPainter(),i=this._getRenderPoints()[0];if(e.isSpriting())return i;var n=this.getMap(),r=n.getMaxZoom(),o=this.getDxDy(),s=n._pointToContainerPoint(this.geometry.getLayer()._getRenderer()._northWest);return t.Util.mapArrayRecursively(i,function(t){return n._pointToContainerPoint(t,r)._add(o)._substract(s)})},_getRotationAt:function(t){var e=this.getRotation(),i=this._getRenderPoints()[1];return i?(e||(e=0),i[t]+e):e},_rotate:function(e,i,n){return t.Util.isNil(n)?null:(e.save(),e.translate(i.x,i.y),e.rotate(n),new t.Point(0,0))}}),t.symbolizer.ImageMarkerSymbolizer=t.symbolizer.PointSymbolizer.extend({initialize:function(t,e,i){this.symbol=t,this.geometry=e,this.painter=i,this.style=this._defineStyle(this.translate())},symbolize:function(e,i){var n=this.style;if(0!==n.markerWidth&&0!==n.markerHeight&&0!==n.markerOpacity){var r=this._getRenderContainerPoints();if(t.Util.isArrayHasData(r)){var o=this._getImage(i);if(!o)return void(!t.Browser.phantomjs&&console&&console.warn("no img found for "+(this.style.markerFile||this._url[0])));this._prepareContext(e);var s=n.markerWidth,a=n.markerHeight;if(!t.Util.isNumber(s)||!t.Util.isNumber(a)){s=o.width,a=o.height,n.markerWidth=s,n.markerHeight=a;var h=[n.markerFile,n.markerWidth,n.markerHeight];i.isResourceLoaded(h)||i.addResource(h,o);var l=this.getPainter();l.isSpriting()||l.removeCache()}var u;!(this instanceof t.symbolizer.VectorPathMarkerSymbolizer)&&t.Util.isNumber(n.markerOpacity)&&n.markerOpacity<1&&(u=e.globalAlpha,e.globalAlpha*=n.markerOpacity);for(var c,d=0,m=r.length;d<m;d++){c=r[d];var f=this._rotate(e,c,this._getRotationAt(d));f&&(c=f),t.Canvas.image(e,o,c.x-s/2,c.y-a,s,a),f&&e.restore()}void 0!==u&&(e.globalAlpha=u)}}},_getImage:function(t){return t?t.getImage([this.style.markerFile,this.style.markerWidth,this.style.markerHeight]):null},getPlacement:function(){return this.symbol.markerPlacement},getRotation:function(){var e=this.style.markerRotation;return t.Util.isNumber(e)?e*Math.PI/180:null},getDxDy:function(){var e=this.style,i=e.markerDx||0,n=e.markerDy||0;return new t.Point(i,n)},getMarkerExtent:function(e){var i=this.style.markerFile,n=e?e.getImage(i):null,r=this.style.markerWidth||(n?n.width:0),o=this.style.markerHeight||(n?n.height:0),s=this.getDxDy();return new t.PointExtent(s.add(-r/2,0),s.add(r/2,-o))},translate:function(){var e=this.symbol;return{markerFile:e.markerFile,markerOpacity:t.Util.getValueOrDefault(e.markerOpacity,1),markerWidth:t.Util.getValueOrDefault(e.markerWidth,null),markerHeight:t.Util.getValueOrDefault(e.markerHeight,null),markerDx:t.Util.getValueOrDefault(e.markerDx,0),markerDy:t.Util.getValueOrDefault(e.markerDy,0)}}}),t.symbolizer.ImageMarkerSymbolizer.test=function(e){return!!e&&!t.Util.isNil(e.markerFile)},t.symbolizer.VectorMarkerSymbolizer=t.symbolizer.PointSymbolizer.extend({padding:[2,2],initialize:function(e,i,n){this.symbol=e,this.geometry=i,this.painter=n;var r=this.translate();this.style=this._defineStyle(r),this.strokeAndFill=this._defineStyle(t.symbolizer.VectorMarkerSymbolizer.translateLineAndFill(r))},symbolize:function(e,i){var n=this.style;if(0!==n.markerWidth&&0!==n.markerHeight&&(0!==n.polygonOpacity||0!==n.lineOpacity)){var r=this._getRenderContainerPoints();t.Util.isArrayHasData(r)&&(this._prepareContext(e),this.getPainter().isSpriting()||this.geometry.getLayer().getMask()===this.geometry||this.geometry.getLayer().options.cacheVectorOnCanvas===!1?this._drawMarkers(e,r,i):this._drawMarkersWithCache(e,r,i))}},_drawMarkers:function(e,i,n){var r,o,s=this.strokeAndFill;t.Util.isGradient(s.lineColor)||t.Util.isGradient(s.polygonFill)||t.Canvas.prepareCanvas(e,s,n);for(var a=i.length-1;a>=0;a--)r=i[a],o=this._rotate(e,r,this._getRotationAt(a)),o&&(r=o),this._drawVectorMarker(e,r,n),o&&e.restore()},_drawMarkersWithCache:function(e,i,n){var r=this._stampSymbol(),o=this.strokeAndFill.lineWidth?this.strokeAndFill.lineWidth:0,s=this.geometry.options.shadowBlur,a=this.style.markerWidth+o+2*s+this.padding[0],h=this.style.markerHeight+o+2*s+this.padding[1],l=n.getImage(r);l||(l=this._createMarkerImage(e,n),n.addResource([r,a,h],l));for(var u,c,d=this._getAnchor(),m=i.length-1;m>=0;m--)u=i[m].substract(d),c=this._rotate(e,u,this._getRotationAt(m)),c&&(u=c),t.Canvas.image(e,l,u.x,u.y,a,h),c&&e.restore()},_createMarkerImage:function(e,i){var n=e.canvas.constructor,r=this.strokeAndFill.lineWidth?this.strokeAndFill.lineWidth:0,o=this.geometry.options.shadowBlur,s=this.style.markerWidth+r+2*o+this.padding[0],a=this.style.markerHeight+r+2*o+this.padding[1],h=t.Canvas.createCanvas(s,a,n),l=this._getAnchor(),u=h.getContext("2d");return t.Util.isGradient(this.strokeAndFill.lineColor)||t.Util.isGradient(this.strokeAndFill.polygonFill)||t.Canvas.prepareCanvas(u,this.strokeAndFill,i),this._drawVectorMarker(u,l,i),h},_stampSymbol:function(){return this._stamp||(this._stamp=[this.style.markerType,t.Util.isGradient(this.style.markerFill)?t.Util.getGradientStamp(this.style.markerFill):this.style.markerFill,this.style.markerFillOpacity,this.style.markerFillPatternFile,t.Util.isGradient(this.style.markerLineColor)?t.Util.getGradientStamp(this.style.markerLineColor):this.style.markerLineColor,this.style.markerLineWidth,this.style.markerLineOpacity,this.style.markerLineDasharray?this.style.markerLineDasharray.join(","):"",this.style.markerLinePatternFile,this.style.markerWidth,this.style.markerHeight].join("_")),this._stamp},_getAnchor:function(){var e=this.style.markerType.toLowerCase(),i=this.strokeAndFill.lineWidth?this.strokeAndFill.lineWidth:0,n=this.geometry.options.shadowBlur,r=this.style.markerWidth,o=this.style.markerHeight;return"bar"===e||"pie"===e||"pin"===e?new t.Point(r/2+i/2+n+this.padding[0]/2,o+i/2+n+this.padding[1]):new t.Point(r/2+i/2+n+this.padding[0]/2,o/2+i/2+n+this.padding[1]/2)},_getGraidentExtent:function(e){var i=new t.PointExtent,n=this.getMarkerExtent();if(t.Util.isArray(e))for(var r=e.length-1;r>=0;r--)i._combine(e[r]);else i._combine(e);return i.xmin+=n.xmin,i.ymin+=n.ymin,i.xmax+=n.xmax,i.ymax+=n.ymax,i},_drawVectorMarker:function(e,i,n){var r,o,s,a,h=this.style,l=this.strokeAndFill,u=h.markerType.toLowerCase(),c=t.symbolizer.VectorMarkerSymbolizer._getVectorPoints(u,h.markerWidth,h.markerHeight),d=l.lineOpacity,m=l.polygonOpacity;(t.Util.isGradient(l.lineColor)||t.Util.isGradient(l.polygonFill))&&(t.Util.isGradient(l.lineColor)&&(a=this._getGraidentExtent(i),l.lineGradientExtent=a.expand(l.lineWidth)),t.Util.isGradient(l.polygonFill)&&(a||(a=this._getGraidentExtent(i)),l.polygonGradientExtent=a),t.Canvas.prepareCanvas(e,l,n));var f=h.markerWidth,g=h.markerHeight;if("ellipse"===u)t.Canvas.ellipse(e,i,f/2,g/2,d,m);else if("cross"===u||"x"===u){for(r=c.length-1;r>=0;r--)c[r]._add(i);t.Canvas.path(e,c.slice(0,2),d),t.Canvas.path(e,c.slice(2,4),d)}else if("diamond"===u||"bar"===u||"square"===u||"triangle"===u){for("bar"===u&&(i=i.add(0,-h.markerLineWidth/2)),r=c.length-1;r>=0;r--)c[r]._add(i);t.Canvas.polygon(e,c,d,m)}else if("pin"===u){for(i=i.add(0,-h.markerLineWidth/2),r=c.length-1;r>=0;r--)c[r]._add(i);o=e.lineCap,e.lineCap="round",t.Canvas.bezierCurveAndFill(e,c,d,m),e.lineCap=o}else{if("pie"!==u)throw new Error("unsupported markerType: "+u);i=i.add(0,-h.markerLineWidth/2),s=180*Math.atan(f/2/g)/Math.PI,o=e.lineCap,e.lineCap="round",t.Canvas.sector(e,i,g,[90-s,90+s],d,m),e.lineCap=o}},getPlacement:function(){return this.symbol.markerPlacement},getRotation:function(){var e=this.style.markerRotation;return t.Util.isNumber(e)?e*Math.PI/180:null},getDxDy:function(){var e=this.style,i=e.markerDx,n=e.markerDy;return new t.Point(i,n)},getMarkerExtent:function(){var e,i=this.getDxDy(),n=this.style,r=n.markerType.toLowerCase(),o=n.markerWidth,s=n.markerHeight;return e="bar"===r||"pie"===r||"pin"===r?new t.PointExtent(i.add(-o/2,-s),i.add(o/2,0)):new t.PointExtent(i.add(-o/2,-s/2),i.add(o/2,s/2)),this.style.markerLineWidth&&e._expand(this.style.markerLineWidth/2),e},translate:function(){var e=this.symbol,i={markerType:t.Util.getValueOrDefault(e.markerType,"ellipse"),markerFill:t.Util.getValueOrDefault(e.markerFill,"#00f"),markerFillOpacity:t.Util.getValueOrDefault(e.markerFillOpacity,1),markerFillPatternFile:t.Util.getValueOrDefault(e.markerFillPatternFile,null),markerLineColor:t.Util.getValueOrDefault(e.markerLineColor,"#000"),markerLineWidth:t.Util.getValueOrDefault(e.markerLineWidth,1),markerLineOpacity:t.Util.getValueOrDefault(e.markerLineOpacity,1),markerLineDasharray:t.Util.getValueOrDefault(e.markerLineDasharray,[]),markerLinePatternFile:t.Util.getValueOrDefault(e.markerLinePatternFile,null),markerWidth:t.Util.getValueOrDefault(e.markerWidth,10),markerHeight:t.Util.getValueOrDefault(e.markerHeight,10),markerDx:t.Util.getValueOrDefault(e.markerDx,0),markerDy:t.Util.getValueOrDefault(e.markerDy,0)};return t.Util.isNumber(e.markerOpacity)&&(i.markerFillOpacity*=e.markerOpacity,i.markerLineOpacity*=e.markerOpacity),i}}),t.symbolizer.VectorMarkerSymbolizer.translateLineAndFill=function(t){var e={lineColor:t.markerLineColor,linePatternFile:t.markerLinePatternFile,lineWidth:t.markerLineWidth,lineOpacity:t.markerLineOpacity,lineDasharray:null,lineCap:"butt",lineJoin:"round",polygonFill:t.markerFill,polygonPatternFile:t.markerFillPatternFile,polygonOpacity:t.markerFillOpacity};return 0===e.lineWidth&&(e.lineOpacity=0),e},t.symbolizer.VectorMarkerSymbolizer.test=function(e){return!!e&&!(!t.Util.isNil(e.markerFile)||t.Util.isNil(e.markerType)||"path"===e.markerType)},t.symbolizer.VectorMarkerSymbolizer.translateToSVGStyles=function(e){var i={stroke:{stroke:e.markerLineColor,"stroke-width":e.markerLineWidth,"stroke-opacity":e.markerLineOpacity,"stroke-dasharray":null,"stroke-linecap":"butt","stroke-linejoin":"round"},fill:{fill:e.markerFill,"fill-opacity":e.markerFillOpacity}};return"butt"===i.stroke["stroke-linecap"]&&t.Browser.vml&&(i.stroke["stroke-linecap"]="flat"),0===i.stroke["stroke-width"]&&(i.stroke["stroke-opacity"]=0),i},t.symbolizer.VectorMarkerSymbolizer._getVectorPoints=function(e,i,n){var r,o,s,a,h=n/2,l=i/2;if("triangle"===e)return r=new t.Point(0,0-h),o=new t.Point(0-l,0+h),s=new t.Point(0+l,0+h),[r,o,s];if("cross"===e)return r=new t.Point(0-l,0),o=new t.Point(0+l,0),s=new t.Point(0,0-h),a=new t.Point(0,0+h),[r,o,s,a];if("diamond"===e)return r=new t.Point(0-l,0),o=new t.Point(0,0-h),s=new t.Point(0+l,0),a=new t.Point(0,0+h),[r,o,s,a]
;if("square"===e)return r=new t.Point(0-l,0+h),o=new t.Point(0+l,0+h),s=new t.Point(0+l,0-h),a=new t.Point(0-l,0-h),[r,o,s,a];if("x"===e)return r=new t.Point(0-l,0+h),o=new t.Point(0+l,0-h),s=new t.Point(0+l,0+h),a=new t.Point(0-l,0-h),[r,o,s,a];if("bar"===e)return r=new t.Point(0-l,0-n),o=new t.Point(0+l,0-n),s=new t.Point(0+l,0),a=new t.Point(0-l,0),[r,o,s,a];if("pin"===e){var u=n*Math.atan(l/h);return r=new t.Point(0,0),o=new t.Point(0-u,0-n),s=new t.Point(0+u,0-n),a=new t.Point(0,0),[r,o,s,a]}return null},t.symbolizer.VectorPathMarkerSymbolizer=t.symbolizer.ImageMarkerSymbolizer.extend({initialize:function(e,i,n){this.symbol=e,this.geometry=i,this.painter=n,this._url=[t.Geometry.getMarkerPathBase64(e),e.markerWidth,e.markerHeight],this.style=this._defineStyle(this.translate()),t.Util.isNil(this.style.markerWidth)&&(this.style.markerWidth=80),t.Util.isNil(this.style.markerHeight)&&(this.style.markerHeight=80)},_prepareContext:function(){},_getImage:function(t){if(t&&t.isResourceLoaded(this._url))return t.getImage(this._url);var e=new Image;return e.src=this._url[0],t&&t.addResource(this._url,e),e}}),t.symbolizer.VectorPathMarkerSymbolizer.test=function(e){return!!e&&!(!t.Util.isNil(e.markerFile)||"path"!==e.markerType)},t.symbolizer.TextMarkerSymbolizer=t.symbolizer.PointSymbolizer.extend({initialize:function(e,i,n){this.symbol=e,this.geometry=i,this.painter=n;var r=this.translate();this.style=this._defineStyle(r),this.strokeAndFill=this._defineStyle(this.translateLineAndFill(r));var o=t.StringUtil.replaceVariable(this.style.textName,this.geometry.getProperties());this._cacheKey=this._genCacheKey(o,this.style),this._descText(o)},symbolize:function(e,i){if(0!==this.style.textSize&&0!==this.style.textOpacity){var n=this._getRenderContainerPoints();if(t.Util.isArrayHasData(n)){var r=this.style,o=this.strokeAndFill,s=t.StringUtil.replaceVariable(this.style.textName,this.geometry.getProperties());this._descText(s),this._prepareContext(e),t.Canvas.prepareCanvas(e,o,i),t.Canvas.prepareCanvasFont(e,r);for(var a,h=0,l=n.length;h<l;h++){a=n[h];var u=this._rotate(e,a,this._getRotationAt(h));u&&(a=u),t.Canvas.text(e,s,a,r,this.textDesc),u&&e.restore()}}}},getPlacement:function(){return this.symbol.textPlacement},getRotation:function(){var e=this.style.textRotation;return t.Util.isNumber(e)?e*Math.PI/180:null},getDxDy:function(){var e=this.style,i=e.textDx,n=e.textDy;return new t.Point(i,n)},getMarkerExtent:function(){var e=this.getDxDy(),i=this.style,n=this.textDesc.size,r=t.StringUtil.getAlignPoint(n,i.textHorizontalAlignment,i.textVerticalAlignment),o=r.x,s=r.y;return new t.PointExtent(e.add(o,s),e.add(o+n.width,s+n.height))},translate:function(){var e=this.symbol;return{textName:e.textName,textFaceName:t.Util.getValueOrDefault(e.textFaceName,"monospace"),textWeight:t.Util.getValueOrDefault(e.textWeight,"normal"),textStyle:t.Util.getValueOrDefault(e.textStyle,"normal"),textSize:t.Util.getValueOrDefault(e.textSize,10),textFont:t.Util.getValueOrDefault(e.textFont,null),textFill:t.Util.getValueOrDefault(e.textFill,"#000"),textOpacity:t.Util.getValueOrDefault(e.textOpacity,1),textHaloFill:t.Util.getValueOrDefault(e.textHaloFill,"#ffffff"),textHaloRadius:t.Util.getValueOrDefault(e.textHaloRadius,0),textHaloOpacity:t.Util.getValueOrDefault(e.textHaloOpacity,1),textWrapWidth:t.Util.getValueOrDefault(e.textWrapWidth,null),textWrapBefore:t.Util.getValueOrDefault(e.textWrapBefore,!1),textWrapCharacter:t.Util.getValueOrDefault(e.textWrapCharacter,null),textLineSpacing:t.Util.getValueOrDefault(e.textLineSpacing,0),textDx:t.Util.getValueOrDefault(e.textDx,0),textDy:t.Util.getValueOrDefault(e.textDy,0),textHorizontalAlignment:t.Util.getValueOrDefault(e.textHorizontalAlignment,"middle"),textVerticalAlignment:t.Util.getValueOrDefault(e.textVerticalAlignment,"middle"),textAlign:t.Util.getValueOrDefault(e.textAlign,"center")}},translateLineAndFill:function(t){return{lineColor:t.textHaloRadius?t.textHaloFill:t.textFill,lineWidth:t.textHaloRadius,lineOpacity:t.textOpacity,lineDasharray:null,lineCap:"butt",lineJoin:"round",polygonFill:t.textFill,polygonOpacity:t.textOpacity}},_descText:function(e){this.textDesc=this._loadFromCache(),this.textDesc||(this.textDesc=t.StringUtil.splitTextToRow(e,this.style),this._storeToCache(this.textDesc))},_storeToCache:function(e){t.node||(this.geometry.___text_symbol_cache||(this.geometry.___text_symbol_cache={}),this.geometry.___text_symbol_cache[this._cacheKey]=e)},_loadFromCache:function(){return this.geometry.___text_symbol_cache?this.geometry.___text_symbol_cache[this._cacheKey]:null},_genCacheKey:function(t,e){var i=[t];for(var n in e)e.hasOwnProperty(n)&&n.length>4&&"text"===n.substring(0,4)&&i.push(n+"="+e[n]);return i.join("-")}}),t.symbolizer.TextMarkerSymbolizer.test=function(e){return!!e&&!t.Util.isNil(e.textName)},t.symbolizer.TextMarkerSymbolizer.getFont=function(t){return t.textFont?t.textFont:(t.textStyle?t.textStyle+" ":"")+(t.textWeight?t.textWeight+" ":"")+t.textSize+"px "+('"'===t.textFaceName[0]?t.textFaceName:'"'+t.textFaceName+'"')},t.symbolizer.DebugSymbolizer=t.symbolizer.PointSymbolizer.extend({styles:{lineColor:"#000",lineOpacity:1,lineWidth:1},initialize:function(t,e,i){this.symbol=t,this.geometry=e,this.painter=i},getPlacement:function(){return"point"},getDxDy:function(){return new t.Point(0,0)},symbolize:function(e){var i=this.geometry,n=i.getLayer();if(i.options.debug||!n||n.options.debug){var r=this.getMap();if(r&&!r._zooming){t.Canvas.prepareCanvas(e,this.styles);var o=this.styles.lineOpacity,s=this.getPainter().getContainerExtent(),a=s.getMin(),h=s.getSize();t.Canvas.rectangle(e,a,h,o,0);for(var l=this._getRenderContainerPoints(),u=this.geometry.getId(),c=t.symbolizer.VectorMarkerSymbolizer._getVectorPoints("cross",10,10),d=0;d<l.length;d++){var m=l[d];t.Util.isNil(u)||t.Canvas.fillText(e,u,m.add(8,-4),"rgba(0,0,0,1)");for(var f=[],g=0;g<c.length;g++)f.push(c[g].add(m));t.Canvas.path(e,f.slice(0,2),o),t.Canvas.path(e,f.slice(2,4),o)}}}}});var e={};if(e.Center={_getRenderPoints:function(){return[[this._getCenter2DPoint(this.getMap().getMaxZoom())],null]}},t.Marker.include(e.Center),t.Ellipse.include(e.Center,{_getRenderSize:function(){var t=this.getWidth(),e=this.getHeight(),i=this.getMap();return i.distanceToPixel(t/2,e/2,i.getMaxZoom())}}),t.Circle.include(e.Center,{_getRenderSize:function(){var t=this.getRadius(),e=this.getMap();return e.distanceToPixel(t,t,e.getMaxZoom())}}),t.Sector.include(e.Center,{_getRenderSize:function(){var t=this.getRadius(),e=this.getMap();return e.distanceToPixel(t,t,e.getMaxZoom())}}),t.Rectangle.include({_getRenderPoints:function(t){if("vertex"===t){for(var e=this.getShell(),i=[],n=0,r=e.length;n<r;n++)i.push(this.getMap().coordinateToPoint(e[n]));return[i,null]}return[[this.getMap().coordinateToPoint(this.getCenter())],null]},_getRenderSize:function(){var t=this.getWidth(),e=this.getHeight(),i=this.getMap();return i.distanceToPixel(t,e,i.getMaxZoom())}}),e.Poly={_getRenderPoints:function(e){var i,n=this.getMap(),r=n.getMaxZoom(),o=null;if("vertex"===e)(i=this._getPath2DPoints(this._getPrjCoordinates(),!1,r))&&i.length>0&&t.Util.isArray(i[0])&&(i=i[0].concat(i[1]));else if("line"===e){i=[],o=[];var s,a,h=this._getPath2DPoints(this._getPrjCoordinates(),!1,r),l=h.length>0&&t.Util.isArray(h[0]);if(l){var u,c,d;for(s=1,a=h.length;s<a;s++)for(u=h[s],this instanceof t.Polygon&&u.length>0&&!u[0].equals(u[u.length-1])&&u.push(u[0]),c=1,d=u.length;c<d;c++)i.push(u[c].add(u[c-1])._multi(.5)),o.push(t.Util.computeDegree(u[c-1],u[c]))}else for(this instanceof t.Polygon&&h.length>0&&!h[0].equals(h[h.length-1])&&h.push(h[0]),s=1,a=h.length;s<a;s++)i.push(h[s].add(h[s-1])._multi(.5)),o.push(t.Util.computeDegree(h[s-1],h[s]))}else if("vertex-first"===e){var m=this._getPrjCoordinates()[0];i=[n._prjToPoint(m,r)]}else if("vertex-last"===e){var f=this._getPrjCoordinates()[this._getPrjCoordinates().length-1];i=[n._prjToPoint(f,r)]}else{var g=this._getProjection().project(this.getCenter());i=[n._prjToPoint(g,r)]}return[i,o]}},t.Polyline.include(e.Poly),t.Polygon.include(e.Poly),t.Browser.canvas){var i={_getPaintParams:function(){var t=this.getMap(),e=this._getPrjCoordinates(),i=t._prjToPoint(e,t.getMaxZoom()),n=this._getRenderSize();return[i,n.width,n.height]},_paintOn:t.Canvas.ellipse};t.Ellipse.include(i),t.Circle.include(i),t.Rectangle.include({_getPaintParams:function(){var t=this.getMap();return[t._prjToPoint(this._getPrjCoordinates(),t.getMaxZoom()),this._getRenderSize()]},_paintOn:t.Canvas.rectangle}),t.Sector.include({_getPaintParams:function(){var t=this.getMap();return[t._prjToPoint(this._getPrjCoordinates(),t.getMaxZoom()),this._getRenderSize().width,[this.getStartAngle(),this.getEndAngle()]]},_paintOn:t.Canvas.sector}),t.LineString.include({arrowStyles:{classic:[3,4]},_getArrowPoints:function(t,e,i,n,r){r||(r=0);var o=i*n[0],s=i*n[1]+r,a=o/2+r,h=e.substract(t)._unit(),l=e.substract(h.multi(s));h._perp();var u=l.add(h.multi(a));return h._multi(-1),[u,e,l.add(h.multi(a)),u]},_getPaintParams:function(){var t=this._getPrjCoordinates();return[this._getPath2DPoints(t,!1,this.getMap().getMaxZoom())]},_paintOn:function(e,i,n,r,o){t.Canvas.path(e,i,n,null,o),this._paintArrow(e,i,n)},_getArrowPlacement:function(){return this.options.arrowPlacement},_getArrowStyle:function(){var e=this.options.arrowStyle;return e?t.Util.isArray(e)?e:this.arrowStyles[e]:null},_getArrows:function(e,i,n){var r=this._getArrowStyle();if(!r||e.length<2)return null;for(var o=e.length>0&&t.Util.isArray(e[0]),s=o?e:[e],a=this._getArrowPlacement(),h=[],l=s.length-1;l>=0;l--)if("vertex-first"!==a&&"vertex-firstlast"!==a||h.push(this._getArrowPoints(s[l][1],s[l][0],i,r,n)),"vertex-last"===a||"vertex-firstlast"===a)h.push(this._getArrowPoints(s[l][s[l].length-2],s[l][s[l].length-1],i,r,n));else if("point"===a)for(var u=0,c=s[l].length-1;u<c;u++)h.push(this._getArrowPoints(s[l][u],s[l][u+1],i,r,n));return h.length>0?h:null},_paintArrow:function(e,i,n){var r=this._getInternalSymbol().lineWidth;(!r||r<3)&&(r=3);var o=this._getArrows(i,r);if(o&&o){e.setLineDash&&e.setLineDash([]);for(var s=o.length-1;s>=0;s--)e.fillStyle=e.strokeStyle,t.Canvas.polygon(e,o[s],n,n)}}}),t.Polygon.include({_getPaintParams:function(){var e=this.getMap().getMaxZoom(),i=this._getPrjCoordinates(),n=this._getPath2DPoints(i,!1,e),r=n.length>0&&t.Util.isArray(n[0]);r&&(n=[[n[0]],[n[1]]]);var o=this._getPrjHoles(),s=[];if(t.Util.isArrayHasData(o))for(var a,h=0;h<o.length;h++)a=this._getPath2DPoints(o[h],!1,e),r?t.Util.isArray(a)?(n[0].push(a[0]),n[1].push(a[1])):n[0].push(a):s.push(a);return[r?n:[n].concat(s)]},_paintOn:t.Canvas.polygon})}t.Painter=t.Class.extend({initialize:function(t){this.geometry=t,this.symbolizers=this._createSymbolizers()},getMap:function(){return this.geometry.getMap()},_createSymbolizers:function(){var e=this.getSymbol(),i=[],n=t.Painter.registerSymbolizers,r=e;t.Util.isArray(e)||(r=[e]);for(var o,s,a=r.length-1;a>=0;a--){o=r[a];for(var h=n.length-1;h>=0;h--)n[h].test(o,this.geometry)&&(s=new n[h](o,this.geometry,this),i.push(s),s instanceof t.symbolizer.PointSymbolizer&&(this._hasPointSymbolizer=!0))}return 0===i.length&&console&&console.warn("invalid symbol for geometry("+(this.geometry?this.geometry.getType()+(this.geometry.getId()?":"+this.geometry.getId():""):"")+") to draw : "+JSON.stringify(e)),this._debugSymbolizer=new t.symbolizer.DebugSymbolizer(o,this.geometry,this),this._hasShadow=this.geometry.options.shadowBlur>0,i},hasPointSymbolizer:function(){return this._hasPointSymbolizer},getRenderPoints:function(t){return this._renderPoints||(this._renderPoints={}),t||(t="point"),this._renderPoints[t]||(this._renderPoints[t]=this.geometry._getRenderPoints(t)),this._renderPoints[t]},getPaintParams:function(){if(this._paintParams||(this._paintParams=this.geometry._getPaintParams()),!this._paintParams)return null;var e,i=this.getMap(),n=i.getMaxZoom(),r=i.getScale(),o=this.geometry.getLayer()._getRenderer()._northWest,s=i._pointToContainerPoint(o),a=this._paintParams,h=[],l=a[0];t.Util.isArray(l)?e=t.Util.mapArrayRecursively(l,function(t){return i._pointToContainerPoint(t,n)._substract(s)}):l instanceof t.Point&&(e=i._pointToContainerPoint(l,n)._substract(s)),h.push(e);for(var u=1,c=a.length;u<c;u++)t.Util.isNumber(a[u])||a[u]instanceof t.Size?t.Util.isNumber(a[u])?h.push(a[u]/r):h.push(a[u].multi(1/r)):h.push(a[u]);return h},getSymbol:function(){return this.geometry._getInternalSymbol()},paint:function(){var t=this.geometry.getLayer()._getRenderer().getPaintContext();t&&this.symbolizers&&this.symbolize(t)},symbolize:function(t){this._prepareShadow(t[0]);for(var e=this.symbolizers.length-1;e>=0;e--)this.symbolizers[e].symbolize.apply(this.symbolizers[e],t);this._painted=!0,this._debugSymbolizer.symbolize.apply(this._debugSymbolizer,t)},getSprite:function(e){if(!(this.geometry instanceof t.Marker))return null;if(this._genSprite=!0,!this._sprite&&this.symbolizers.length>0){var i=new t.PointExtent;this.symbolizers.forEach(function(t){var n=t.getMarkerExtent(e);i._combine(n)});var n,r=i.getMin().multi(-1),o=t.Canvas.createCanvas(i.getWidth(),i.getHeight(),this.getMap()?this.getMap().CanvasClass:null);this._renderPoints&&(n=this._renderPoints);var s=[o.getContext("2d"),e];this._prepareShadow(o.getContext("2d"));for(var a=this.symbolizers.length-1;a>=0;a--){var h=this.symbolizers[a].getDxDy();this._renderPoints={point:[[r.add(h)]]},this.symbolizers[a].symbolize.apply(this.symbolizers[a],s)}n&&(this._renderPoints=n),this._sprite={canvas:o,offset:i.getCenter()}}return this._genSprite=!1,this._sprite},isSpriting:function(){return this._genSprite},_prepareShadow:function(t){this._hasShadow?(t.shadowBlur=this.geometry.options.shadowBlur,t.shadowColor=this.geometry.options.shadowColor):t.shadowBlur&&(t.shadowBlur=null,t.shadowColor=null)},_eachSymbolizer:function(t,e){if(this.symbolizers){e||(e=this);for(var i=this.symbolizers.length-1;i>=0;i--)t.apply(e,[this.symbolizers[i]])}},get2DExtent:function(e){if(!this._extent2D&&this.symbolizers){for(var i=new t.PointExtent,n=this.symbolizers.length-1,r=n;r>=0;r--)i._combine(this.symbolizers[r].get2DExtent(e));this._extent2D=i}return this._extent2D},getContainerExtent:function(){var e=this.getMap(),i=this.get2DExtent(this.resources);return new t.PointExtent(e._pointToContainerPoint(i.getMin()),e._pointToContainerPoint(i.getMax()))},setZIndex:function(t){this._eachSymbolizer(function(e){e.setZIndex(t)})},show:function(){if(this._painted)this.removeCache(),this._eachSymbolizer(function(t){t.show()});else{this.geometry.getLayer().isCanvasRender()||this.paint()}},hide:function(){this._eachSymbolizer(function(t){t.hide()})},repaint:function(){this.removeCache()},refreshSymbol:function(){if(this.removeCache(),this._removeSymbolizers(),this.symbolizers=this._createSymbolizers(),this.getMap()){var e=this.geometry.getLayer();this.geometry.isVisible()&&e instanceof t.VectorLayer&&(e.isCanvasRender()||this.paint())}},remove:function(){this.removeCache(),this._removeSymbolizers()},_removeSymbolizers:function(){this._eachSymbolizer(function(t){delete t.painter,t.remove()}),delete this.symbolizers},removeCache:function(){delete this._renderPoints,delete this._paintParams,delete this._sprite,this.removeZoomCache()},removeZoomCache:function(){this.geometry._simplified&&delete this._paintParams,delete this._extent2D}}),t.Painter.registerSymbolizers=[t.symbolizer.StrokeAndFillSymbolizer,t.symbolizer.ImageMarkerSymbolizer,t.symbolizer.VectorPathMarkerSymbolizer,t.symbolizer.VectorMarkerSymbolizer,t.symbolizer.TextMarkerSymbolizer],t.CollectionPainter=t.Class.extend({initialize:function(t){this.geometry=t},_eachPainter:function(t){for(var e,i=this.geometry.getGeometries(),n=0,r=i.length;n<r&&(!(e=i[n]._getPainter())||!e||t.call(this,e)!==!1);n++);},paint:function(){this.geometry&&this._eachPainter(function(t){t.paint()})},get2DExtent:function(e){var i=new t.PointExtent;return this._eachPainter(function(t){i=i.combine(t.get2DExtent(e))}),i},remove:function(){var t=arguments;this._eachPainter(function(e){e.remove.apply(e,t)})},setZIndex:function(){var t=arguments;this._eachPainter(function(e){e.setZIndex.apply(e,t)})},show:function(){var t=arguments;this._eachPainter(function(e){e.show.apply(e,t)})},hide:function(){var t=arguments;this._eachPainter(function(e){e.hide.apply(e,t)})},onZoomEnd:function(){var t=arguments;this._eachPainter(function(e){e.onZoomEnd.apply(e,t)})},repaint:function(){var t=arguments;this._eachPainter(function(e){e.repaint.apply(e,t)})},refreshSymbol:function(){var t=arguments;this._eachPainter(function(e){e.refreshSymbol.apply(e,t)})},hasPointSymbolizer:function(){var t=!1;return this._eachPainter(function(e){return!e.hasPointSymbolizer()||(t=!0,!1)}),t},removeZoomCache:function(){var t=arguments;this._eachPainter(function(e){e.removeZoomCache.apply(e,t)})}}),t.GeoJSONLayer=t.VectorLayer.extend({initialize:function(e,i,n){if(this.setId(e),i&&!t.Util.isArray(i)&&(i.type||(n=i,i=null)),t.Util.setOptions(this,n),i){var r=this._parse(i);this.addGeometry(r)}},addData:function(t){var e=this._parse(t);return this.addGeometry(e),this},_parse:function(e){return e=t.Util.parseJSON(e),t.Geometry.fromJSON(e)},toJSON:function(e){var i=t.VectorLayer.prototype.toJSON.call(this,e);i.type="GeoJSONLayer";var n=[];if(i.geometries){for(var r,o=0,s=i.geometries.length;o<s;o++)r=i.geometries[o].feature,r.id||r.properties||(r=r.geometry),n.push(r);delete i.geometries}return i.geojson=n,i}}),t.GeoJSONLayer.fromJSON=function(e){if(!e||"GeoJSONLayer"!==e.type)return null;var i=new t.GeoJSONLayer(e.id,e.geojson,e.options);return e.style&&i.setStyle(e.style),i},t.CanvasLayer=t.Layer.extend({options:{doubleBuffer:!1,animation:!1,fps:70},prepareToDraw:function(){},draw:function(){},play:function(){return this._getRenderer()&&this._getRenderer().startAnim(),this},pause:function(){return this._getRenderer()&&this._getRenderer().pauseAnim(),this},isPlaying:function(){return!!this._getRenderer()&&this._getRenderer().isPlaying()},clearCanvas:function(){return this._getRenderer()&&this._getRenderer().clearCanvas(),this},requestMapToRender:function(){return this._getRenderer()&&this._getRenderer().requestMapToRender(),this},completeRender:function(){return this._getRenderer()&&this._getRenderer().completeRender(),this},onCanvasCreate:function(){return this},onZoomStart:function(){},onZoomEnd:function(){},onMoveStart:function(){},onMoveEnd:function(){},onResize:function(){},doubleBuffer:function(t){return t.clearRect(0,0,t.canvas.width,t.canvas.height),this}}),t.CanvasLayer.registerRenderer("canvas",t.renderer.Canvas.extend({onCanvasCreate:function(){if(this.canvas&&this.layer.options.doubleBuffer){var e=this.getMap();this.buffer=t.Canvas.createCanvas(this.canvas.width,this.canvas.height,e.CanvasClass)}},draw:function(){this._predrawed||(this._drawContext=this.layer.prepareToDraw(this.context),this._drawContext||(this._drawContext=[]),Array.isArray(this._drawContext)||(this._drawContext=[this._drawContext]),this._predrawed=!0),this.prepareCanvas(),this._drawLayer()},getCanvasImage:function(){var e=t.renderer.Canvas.prototype.getCanvasImage.apply(this,arguments);if(e&&e.image&&this.layer.options.doubleBuffer){var i=e.image;this.buffer.width===i.width&&this.buffer.height===i.height||(this.buffer.width=i.width,this.buffer.height=i.height);var n=this.buffer.getContext("2d");this.layer.doubleBuffer(n,this.context),n.drawImage(i,0,0),e.image=this.buffer}return e},startAnim:function(){this._animTime=t.Util.now(),this._paused=!1,this._play()},pauseAnim:function(){this._pause(),this._paused=!0,delete this._animTime},isPlaying:function(){return!t.Util.isNil(this._animFrame)},hide:function(){return this._pause(),t.renderer.Canvas.prototype.hide.call(this)},show:function(){return t.renderer.Canvas.prototype.show.call(this)},remove:function(){return this._pause(),delete this._drawContext,t.renderer.Canvas.prototype.remove.call(this)},onZoomStart:function(e){this._pause(),this.layer.onZoomStart(e),t.renderer.Canvas.prototype.onZoomStart.call(this)},onZoomEnd:function(e){this.layer.onZoomEnd(e),t.renderer.Canvas.prototype.onZoomEnd.call(this)},onMoveStart:function(e){this._pause(),this.layer.onMoveStart(e),t.renderer.Canvas.prototype.onMoveStart.call(this)},onMoveEnd:function(e){this.layer.onMoveEnd(e),t.renderer.Canvas.prototype.onMoveEnd.call(this)},onResize:function(e){this.layer.onResize(e),t.renderer.Canvas.prototype.onResize.call(this)},_drawLayer:function(){var e=[this.context];this._animTime&&e.push(t.Util.now()-this._animTime),e.push.apply(e,this._drawContext),this.layer.draw.apply(this.layer,e),this.completeRender(),this._play()},_pause:function(){this._animFrame&&(t.Util.cancelAnimFrame(this._animFrame),delete this._animFrame),this._fpsFrame&&(clearTimeout(this._fpsFrame),delete this._fpsFrame)},_play:function(){if(!this._paused&&this.layer&&this.layer.options.animation){this._animTime||(this._animTime=t.Util.now());var e=t.Util.bind(this._drawLayer,this);this._pause();this.layer.options.fps>=62.5?this._animFrame=t.Util.requestAnimFrame(e):this._fpsFrame=setTimeout(function(){t.Browser.ie9?(e(),this._animFrame=1):this._animFrame=t.Util.requestAnimFrame(e)}.bind(this),1e3/this.layer.options.fps)}}})),t.ParticleLayer=t.CanvasLayer.extend({options:{animation:!0,fps:70},getParticles:function(){},draw:function(e){var i=this.getMap(),n=i.getContainerExtent(),r=this.getParticles(t.Util.now());if(r){for(var o,s=0,a=r.length;s<a;s++)o=r[s].point,n.contains(o)&&(e.fillStyle!==r[s].color&&(e.fillStyle=r[s].color||this.options.lineColor||"#fff"),e.fillRect(o.x-r[s].r/2,o.y-r[s].r/2,r[s].r,r[s].r));this._fillCanvas(e)}},_fillCanvas:function(t){var e=t.globalCompositeOperation;t.globalCompositeOperation="destination-out";var i=this.options.trail||30;t.fillStyle="rgba(0, 0, 0, "+1/i+")",t.fillRect(0,0,t.canvas.width,t.canvas.height),t.globalCompositeOperation=e}}),t.ui={},t.ui.UIComponent=t.Class.extend({includes:[t.Eventable],options:{eventsToStop:"mousedown dblclick",dx:0,dy:0,autoPan:!1,single:!0,animation:"scale",animationOnHide:!0,animationDuration:500,animationDelay:0},initialize:function(e){t.Util.setOptions(this,e)},addTo:function(t){return this._owner=t,this.fire("add"),this},getMap:function(){return this._owner?this._owner instanceof t.Map?this._owner:this._owner.getMap():null},show:function(e){var i=this.getMap();if(!i)return this;if(!e){if(!this._coordinate)throw new Error("UI's show coordinate is invalid");e=this._coordinate}this.fire("showstart");var n=this._getUIContainer();this.__uiDOM||this._switchEvents("on"),this._coordinate=e,this._removePrevDOM();var r=this.__uiDOM=this.buildOn(i);if(!r)return this.fire("showend"),this;this._measureSize(r),this._singleton()&&(i[this._uiDomKey()]=r);var o=this.getPosition();r.style.position="absolute",r.style.left=o.x+"px",r.style.top=o.y+"px",r.style[t.DomUtil.TRANSITION]=null,n.appendChild(r);var s=this._getAnimation();if(s.fade&&(r.style.opacity=0),s.scale){if(this.getTransformOrigin){var a=this.getTransformOrigin();r.style[t.DomUtil.TRANSFORMORIGIN]=a.x+"px "+a.y+"px"}r.style[t.DomUtil.TRANSFORM]="scale(0)"}r.style.display="",this.options.eventsToStop&&t.DomUtil.on(r,this.options.eventsToStop,t.DomUtil.stopPropagation),this.options.autoPan&&this._autoPan();var h=s.transition;if(h){var l=function(){h&&(r.style[t.DomUtil.TRANSITION]=h),s.fade&&(r.style.opacity=1),s.scale&&(r.style[t.DomUtil.TRANSFORM]="scale(1)")};this.options.animationDelay?setTimeout(l,this.options.animationDelay):l()}return this.fire("showend"),this},hide:function(){if(!this.getDOM()||!this.getMap())return this;var e=this._getAnimation(),i=this.getDOM();return this.options.animationOnHide||(e.anim=!1),e.fade&&(i.style.opacity=0),e.scale&&(i.style[t.DomUtil.TRANSFORM]="scale(0)"),e.anim?setTimeout(function(){i.style.display="none"},this.options.animationDuration):i.style.display="none",this.fire("hide"),this},isVisible:function(){return this.getDOM()&&"none"!==this.getDOM().style.display},remove:function(){return this._owner?(this.hide(),this._switchEvents("off"),this.onRemove&&this.onRemove(),!this._singleton()&&this.__uiDOM&&this._removePrevDOM(),delete this._owner,this.fire("remove"),this):this},getSize:function(){return this._size?this._size.copy():null},getOwner:function(){return this._owner},getDOM:function(){return this.__uiDOM},getPosition:function(){if(!this.getMap())return null;var t=this._getViewPoint();if(this.getOffset){var e=this.getOffset();e&&t._add(e)}return t},_getAnimation:function(){for(var e={fade:!1,scale:!1},i=this.options.animation?this.options.animation.split(","):[],n=0;n<i.length;n++){var r=t.StringUtil.trim(i[n]);"fade"===r?e.fade=!0:"scale"===r&&(e.scale=!0)}var o=null;return e.fade&&(o="opacity "+this.options.animationDuration+"ms"),e.scale&&(o=o?o+",":"",o+="transform "+this.options.animationDuration+"ms"),e.transition=o,e.anim=null!==o,e},_getViewPoint:function(){return this.getMap().coordinateToViewPoint(this._coordinate)._add(this.options.dx,this.options.dy)},_autoPan:function(){var e=this.getMap(),i=this.getDOM();if(!e._moving&&!e._panAnimating){var n=new t.Point(parseInt(i.style.left),parseInt(i.style.top)),r=e.getSize(),o=r.width,s=r.height,a=e.viewPointToContainerPoint(n),h=parseInt(i.clientWidth),l=parseInt(i.clientHeight),u=0,c=0;a.x<0?u=-(a.x-h/2):a.x+h-35>o&&(u=o-(a.x+3*h/2)),a.y<0?c=50-a.y:a.y>s&&(c=s-a.y-l-30),0===c&&0===u||e._panAnimation(new t.Point(u,c),600)}},_measureSize:function(e){var i=this._getUIContainer();return e.style.position="absolute",e.style.left="-99999px",e.style.top="-99999px",e.style.display="",i.appendChild(e),this._size=new t.Size(e.clientWidth,e.clientHeight),e.style.display="none",this._size},_removePrevDOM:function(){if(this.onDomRemove&&this.onDomRemove(),this._singleton()){var e=this.getMap(),i=this._uiDomKey();e[i]&&(t.DomUtil.removeDomNode(e[i]),delete e[i]),delete this.__uiDOM}else this.__uiDOM&&(t.DomUtil.removeDomNode(this.__uiDOM),delete this.__uiDOM)},_uiDomKey:function(){return"__ui_"+this._getClassName()},_singleton:function(){return this.options.single},_getUIContainer:function(){return this.getMap()._panels.ui},_getClassName:function(){for(var e in t.ui)if(t.ui.hasOwnProperty(e)){if("UIComponent"===e)continue;if(this instanceof t.ui[e])return e}return null},_switchEvents:function(e){var i=this._getDefaultEvents();this.getEvents&&t.Util.extend(i,this.getEvents());var n;if(i){var r=this.getMap();for(n in i)i.hasOwnProperty(n)&&r[e](n,i[n],this)}var o=this._getOwnerEvents();if(this._owner&&o)for(n in o)o.hasOwnProperty(n)&&this._owner[e](n,o[n],this)},_getDefaultEvents:function(){return{zooming:this.onZooming,zoomend:this.onZoomEnd}},_getOwnerEvents:function(){return this._owner&&this._owner instanceof t.Geometry?{positionchange:this.onGeometryPositionChange}:null},onGeometryPositionChange:function(t){this._owner&&this.getDOM()&&this.isVisible()&&this.show(t.target.getCenter())},onZooming:function(){if(this.isVisible()&&this.getDOM()&&this.getMap()){var t=this.getDOM(),e=this.getMap().coordinateToViewPoint(this._coordinate),i=e._add(this.options.dx,this.options.dy);if(this.getOffset){var n=this.getOffset();n&&i._add(n)}t.style.left=i.x+"px",t.style.top=i.y+"px"}},onZoomEnd:function(){if(this.isVisible()&&this.getDOM()&&this.getMap()){var t=this.getDOM(),e=this.getPosition();t.style.left=e.x+"px",t.style.top=e.y+"px"}}}),t.ui.UIMarker=t.ui.UIComponent.extend({includes:[t.Handlerable],options:{draggable:!1,single:!1,content:null},initialize:function(e,i){this._markerCoord=new t.Coordinate(e),t.Util.setOptions(this,i)},setCoordinates:function(t){return this._markerCoord=t,this.fire("positionchange"),this.isVisible()&&this.show(),this},getCoordinates:function(){return this._markerCoord},setContent:function(t){var e=this.options.content;return this.options.content=t,this.fire("contentchange",{old:e,new:t}),this.isVisible()&&this.show(),this},getContent:function(){return this.options.content},show:function(){return t.ui.UIComponent.prototype.show.call(this,this._markerCoord)},buildOn:function(){var e;return t.Util.isString(this.options.content)?(e=t.DomUtil.createEl("div"),e.innerHTML=this.options.content):e=this.options.content,this._registerDOMEvents(e),e},getOffset:function(){var e=this.getSize();return new t.Point(-e.width/2,-e.height/2)},getTransformOrigin:function(){var e=this.getSize();return new t.Point(e.width/2,e.height/2)},onDomRemove:function(){var t=this.getDOM();this._removeDOMEvents(t)},_domEvents:"mousedown mouseup mouseover mouseout mousemove click dblclick contextmenu keypress touchstart touchmove touchend",_registerDOMEvents:function(e){t.DomUtil.on(e,this._domEvents,this._onDomEvents,this)},_onDomEvents:function(t){var e=this.getMap()._parseEvent(t,t.type);this.fire(t.type,e)},_removeDOMEvents:function(e){t.DomUtil.off(e,this._domEvents,this._onDomEvents,this)}}),t.ui.UIMarker.Drag=t.Handler.extend({START:t.Browser.touch?["touchstart","mousedown"]:["mousedown"],addHooks:function(){this.target.on(this.START.join(" "),this._startDrag,this)},removeHooks:function(){this.target.off(this.START.join(" "),this._startDrag,this)},_startDrag:function(t){var e=t.domEvent;e.touches&&e.touches.length>1||this.isDragging()||(this.target.on("click",this._endDrag,this),this._lastPos=t.coordinate,this._prepareDragHandler(),this._dragHandler.onMouseDown(t.domEvent),this.target.fire("dragstart",t))},_prepareDragHandler:function(){this._dragHandler=new t.Handler.Drag(this.target.getDOM(),{cancelOn:t.Util.bind(this._cancelOn,this)}),this._dragHandler.on("mousedown",this._onMouseDown,this),this._dragHandler.on("dragging",this._dragging,this),this._dragHandler.on("mouseup",this._endDrag,this),this._dragHandler.enable()},_cancelOn:function(t){var e=t.srcElement||t.target,i=e.tagName.toLowerCase();return"button"===i||"input"===i||"select"===i||"option"===i||"textarea"===i},_onMouseDown:function(e){t.DomUtil.stopPropagation(e.domEvent)},_dragging:function(t){var e=this.target,i=e.getMap(),n=i._parseEvent(t.domEvent),r=n.domEvent;if(!(r.touches&&r.touches.length>1)){if(!this._isDragging)return void(this._isDragging=!0);var o=n.coordinate;this._lastPos||(this._lastPos=o);var s=o.substract(this._lastPos);this._lastPos=o,this.target.setCoordinates(this.target.getCoordinates().add(s)),n.dragOffset=s,e.fire("dragging",n)}},_endDrag:function(t){var e=this.target,i=e.getMap();if(this._dragHandler&&(e.off("click",this._endDrag,this),this._dragHandler.disable(),delete this._dragHandler),delete this._lastPos,this._isDragging=!1,i){var n=i._parseEvent(t.domEvent);e.fire("dragend",n)}},isDragging:function(){return!!this._isDragging}}),t.ui.UIMarker.addInitHook("addHandler","draggable",t.ui.UIMarker.Drag),t.ui.UIMarker.include({isDragging:function(){return!!this.draggable&&this.draggable.isDragging()}}),t.ui.InfoWindow=t.ui.UIComponent.extend({options:{autoPan:!0,width:300,minHeight:120,custom:!1,title:null,content:null},addTo:function(e){return e instanceof t.Geometry&&(e.getInfoWindow()&&e.getInfoWindow()!==this&&e.removeInfoWindow(),e._infoWindow=this),t.ui.UIComponent.prototype.addTo.apply(this,arguments)},setContent:function(t){var e=this.options.content;return this.options.content=t,this.fire("contentchange",{old:e,new:t}),this.isVisible()&&this.show(this._coordinate),this},getContent:function(){return this.options.content},setTitle:function(t){var e=t;return this.options.title=t,this.fire("contentchange",{old:e,new:t}),this.isVisible()&&this.show(this._coordinate),this},getTitle:function(){return this.options.title},buildOn:function(){var e;if(this.options.custom)return t.Util.isString(this.options.content)?(e=t.DomUtil.createEl("div"),e.innerHTML=this.options.content,e):this.options.content;e=t.DomUtil.createEl("div"),e.className="maptalks-msgBox",e.style.width=this._getWindowWidth()+"px";var i='<em class="maptalks-ico"></em>';return this.options.title&&(i+="<h2>"+this.options.title+"</h2>"),
i+='<a href="javascript:void(0);" onclick="this.parentNode.style.display=\'none\';return false;"  class="maptalks-close"></a><div class="maptalks-msgContent">'+this.options.content+"</div>",e.innerHTML=i,e},getTransformOrigin:function(){var e=this.getSize(),i=new t.Point(e.width/2,e.height);return this.options.custom||i._add(4,12),i},getOffset:function(){var e=this.getSize(),i=new t.Point(-e.width/2,-e.height);if(this.options.custom||i._substract(4,12),this.getOwner()instanceof t.Marker){var n=this.getOwner().getSize();n&&i._add(0,-n.height)}return i},show:function(){return this.getMap()&&this.getMap().options.enableInfoWindow?t.ui.UIComponent.prototype.show.apply(this,arguments):this},_getWindowWidth:function(){var t=this.options.width;return t||(t=300),t}}),function(){var e={animation:null,animationDelay:10,animationOnHide:!1,eventsToStop:"mousewheel mousedown dblclick click",autoPan:!1,width:160,height:300,custom:!1,items:[]};t.ui.Menu=t.ui.UIComponent.extend({options:e,addTo:function(e){return e._menu&&e._menu!==this&&e.removeMenu(),e._menu=this,t.ui.UIComponent.prototype.addTo.apply(this,arguments)},setItems:function(t){return this.options.items=t,this},getItems:function(){return this.options.items},buildOn:function(){if(this.options.custom){if(t.Util.isString(this.options.items)){var e=t.DomUtil.createEl("div");return e.innerHTML=this.options.items,e}return this.options.items}var i=t.DomUtil.createEl("div");t.DomUtil.addClass(i,"maptalks-menu"),i.style.width=this._getMenuWidth()+"px";var n=this._createMenuItemDom();return i.appendChild(n),i},getOffset:function(){if(!this.getMap())return null;var e=this.getMap().getSize(),i=this.getMap().viewPointToContainerPoint(this._getViewPoint()),n=this.getSize(),r=0,o=0;return i.x+n.width>e.width&&(r=-n.width),i.y+n.height>e.height&&(o=-n.height),new t.Point(r,o)},getTransformOrigin:function(){return this.getOffset()._multi(-1)},getEvents:function(){return{"_zoomstart _zoomend _movestart _dblclick _click":this.hide}},_createMenuItemDom:function(){var e=this,i=this.getMap(),n=t.DomUtil.createEl("ul");t.DomUtil.addClass(n,"maptalks-menu-items");var r="height: "+this.options.height+"px; width: "+this.options.width+"px; overflow-y:auto;";t.DomUtil.setStyle(n,r);for(var o,s,a=this.getItems(),h=0,l=a.length;h<l;h++){if("-"===(o=a[h])||"_"===o)s=t.DomUtil.createEl("li"),t.DomUtil.addClass(s,"maptalks-menu-splitter");else{s=t.DomUtil.createEl("li");var u=o.item;t.Util.isFunction(u)&&(u=u({owner:this._owner,index:h})),s.innerHTML=u,s._callback=o.click,t.DomUtil.on(s,"click",function(t){return function(n){var r=i._parseEvent(n,"click");r.target=e,r.owner=e._owner,r.index=t,this._callback(r)!==!1&&e.hide()}}(h))}n.appendChild(s)}return n},_getMenuWidth:function(){var t=this.options.width;return t||(t=160),t}}),t.ui.Menu.Mixin={setMenu:function(i){return this._menuOptions=i,this._menu?t.Util.setOptions(this._menu,t.Util.extend(e,i)):this.on("contextmenu",this._defaultOpenMenu,this),this},openMenu:function(e){var i=this instanceof t.Map?this:this.getMap();return e||(e=this.getCenter()),this._menu?this._menu.show(e):this._menuOptions&&i&&(this._bindMenu(this._menuOptions),this._menu.show(e)),this},setMenuItems:function(e){return this._menuOptions||(this._menuOptions={}),t.Util.isArray(e)&&(this._menuOptions.custom=!1),this._menuOptions.items=e,this.setMenu(this._menuOptions),this},getMenuItems:function(){return this._menu?this._menu.getItems():this._menuOptions?this._menuOptions.items:null},closeMenu:function(){return this._menu&&this._menu.hide(),this},removeMenu:function(){return this.off("contextmenu",this._defaultOpenMenu,this),this._unbindMenu(),delete this._menuOptions,this},_bindMenu:function(e){return this._menu=new t.ui.Menu(e),this._menu.addTo(this),this},_unbindMenu:function(){return this._menu&&(this.closeMenu(),this._menu.remove(),delete this._menu),this},_defaultOpenMenu:function(t){return this.listens("contextmenu")>1||(this.openMenu(t.coordinate),!1)}}}(),t.Map.include(t.ui.Menu.Mixin),t.Geometry.include(t.ui.Menu.Mixin),t.Geometry.include({setInfoWindow:function(e){return this._infoWinOptions=t.Util.extend({},e),this._infoWindow?t.Util.setOptions(this._infoWindow,e):this.getMap()&&this._bindInfoWindow(this._infoWinOptions),this},getInfoWindow:function(){return this._infoWindow?this._infoWindow:null},openInfoWindow:function(t){return this.getMap()?(t||(t=this.getCenter()),this._infoWindow?this._infoWindow.show(t):this._infoWinOptions&&this.getMap()&&(this._bindInfoWindow(this._infoWinOptions),this._infoWindow.show(t)),this):this},closeInfoWindow:function(){return this._infoWindow&&this._infoWindow.hide(),this},removeInfoWindow:function(){return this._unbindInfoWindow(),delete this._infoWinOptions,delete this._infoWindow,this},_bindInfoWindow:function(e){return this._infoWindow=new t.ui.InfoWindow(e),this._infoWindow.addTo(this),this},_unbindInfoWindow:function(){return this._infoWindow&&(this.closeInfoWindow(),this._infoWindow.remove(),delete this._infoWindow),this}}),t.control={},t.control.Control=t.Class.extend({includes:[t.Eventable],statics:{positions:{"top-left":{top:"20",left:"20"},"top-right":{top:"40",right:"60"},"bottom-left":{bottom:"20",left:"60"},"bottom-right":{bottom:"20",right:"60"}}},initialize:function(e){e&&e.position&&!t.Util.isString(e.position)&&(e.position=t.Util.extend({},e.position)),t.Util.setOptions(this,e)},addTo:function(e){this.remove(),this._map=e;var i=e._panels.control;return this.__ctrlContainer=t.DomUtil.createEl("div"),t.DomUtil.setStyle(this.__ctrlContainer,"position:absolute"),t.DomUtil.addStyle(this.__ctrlContainer,"z-index",i.style.zIndex),this.update(),i.appendChild(this.__ctrlContainer),this.fire("add",{dom:i}),this},update:function(){return this.__ctrlContainer.innerHTML="",this._controlDom=this.buildOn(this.getMap()),this._controlDom&&(this._updatePosition(),this.__ctrlContainer.appendChild(this._controlDom)),this},getMap:function(){return this._map},getPosition:function(){return t.Util.extend({},this._parse(this.options.position))},setPosition:function(e){return t.Util.isString(e)?this.options.position=e:this.options.position=t.Util.extend({},e),this._updatePosition(),this},getContainerPoint:function(){var e,i,n=this.getPosition(),r=this.getMap().getSize();return t.Util.isNil(n.top)?t.Util.isNil(n.bottom)||(e=r.height-n.bottom):e=n.top,t.Util.isNil(n.left)?t.Util.isNil(n.right)||(i=r.width-n.right):i=n.left,new t.Point(e,i)},getContainer:function(){return this.__ctrlContainer},getDOM:function(){return this._controlDom},show:function(){return this.__ctrlContainer.style.display="",this},hide:function(){return this.__ctrlContainer.style.display="none",this},isVisible:function(){return this.__ctrlContainer&&""===this.__ctrlContainer.style.display},remove:function(){return this._map?(t.DomUtil.removeDomNode(this.__ctrlContainer),this.onRemove&&this.onRemove(),delete this._map,delete this.__ctrlContainer,delete this._controlDom,this.fire("remove"),this):this},_parse:function(e){var i=e;return t.Util.isString(e)&&(i=t.control.Control.positions[i]),i},_updatePosition:function(){var e=this.getPosition();e||(e={top:20,left:20});for(var i in e)e.hasOwnProperty(i)&&(e[i]=parseInt(e[i]),this.__ctrlContainer.style[i]=e[i]+"px");this.fire("positionchange",{position:t.Util.extend({},e)})}}),t.Map.mergeOptions({control:!0}),t.Map.include({addControl:function(t){return!this.options.control||this._containerDOM.getContext?this:(t.addTo(this),this)},removeControl:function(t){return t&&t.getMap()===this?(t.remove(),this):this}}),t.control.Zoom=t.control.Control.extend({options:{position:"top-left",slider:!0,zoomLevel:!0},buildOn:function(e){this._map=e;var i=this.options,n=t.DomUtil.createEl("div","maptalks-zoom");if(i.zoomLevel){var r=t.DomUtil.createEl("span","maptalks-zoom-zoomlevel");n.appendChild(r),this._levelDOM=r}var o=t.DomUtil.createEl("div","maptalks-zoom-slider"),s=t.DomUtil.createEl("a","maptalks-zoom-zoomin");if(s.href="javascript:;",s.innerHTML="+",o.appendChild(s),this._zoomInButton=s,i.slider){var a=t.DomUtil.createEl("div","maptalks-zoom-slider-box"),h=t.DomUtil.createEl("div","maptalks-zoom-slider-ruler"),l=t.DomUtil.createEl("span","maptalks-zoom-slider-reading"),u=t.DomUtil.createEl("span","maptalks-zoom-slider-dot");h.appendChild(l),h.appendChild(u),a.appendChild(h),o.appendChild(a),this._sliderBox=a,this._sliderRuler=h,this._sliderReading=l,this._sliderDot=u}var c=t.DomUtil.createEl("a","maptalks-zoom-zoomout");return c.href="javascript:;",c.innerHTML="-",o.appendChild(c),this._zoomOutButton=c,n.appendChild(o),e.on("_zoomend _zoomstart _viewchange",this._update,this),this._update(),this._registerDomEvents(),n},_update:function(){var t=this.getMap();if(this._sliderBox){var e=10*(t.getMaxZoom()-t.getMinZoom());this._sliderBox.style.height=e+6+"px",this._sliderRuler.style.height=e+"px";var i=10*(t.getZoom()-t.getMinZoom());this._sliderReading.style.height=i+"px",this._sliderDot.style.bottom=i+"px"}this._levelDOM&&(this._levelDOM.innerHTML=t.getZoom())},_registerDomEvents:function(){var e=this.getMap();this._zoomInButton&&t.DomUtil.on(this._zoomInButton,"click",e.zoomIn,e),this._zoomOutButton&&t.DomUtil.on(this._zoomOutButton,"click",e.zoomOut,e)},onRemove:function(){var e=this.getMap();this._zoomInButton&&t.DomUtil.off(this._zoomInButton,"click",e.zoomIn,e),this._zoomOutButton&&t.DomUtil.off(this._zoomOutButton,"click",e.zoomOut,e)}}),t.Map.mergeOptions({zoomControl:!1}),t.Map.addOnLoadHook(function(){this.options.zoomControl&&(this.zoomControl=new t.control.Zoom(this.options.zoomControl),this.addControl(this.zoomControl))}),t.control.Attribution=t.control.Control.extend({options:{position:"bottom-left",content:'Powered By <a href="http://www.maptalks.org" target="_blank">MapTalks</a>'},buildOn:function(){return this._attributionContainer=t.DomUtil.createEl("div","maptalks-attribution"),this._update(),this._attributionContainer},setContent:function(t){return this.options.content=t,this._update(),this},_update:function(){this.getMap()&&(this._attributionContainer.innerHTML=this.options.content)}}),t.Map.mergeOptions({attributionControl:!1}),t.Map.addOnLoadHook(function(){this.options.attributionControl&&(this.attributionControl=new t.control.Attribution(this.options.attributionControl),this.addControl(this.attributionControl))}),t.control.Scale=t.control.Control.extend({options:{position:"bottom-left",maxWidth:100,metric:!0,imperial:!1},buildOn:function(e){return this._map=e,this._scaleContainer=t.DomUtil.createEl("div"),this._addScales(),e.on("zoomend",this._update,this),this._map._loaded&&this._update(),this._scaleContainer},onRemove:function(){this.getMap().off("zoomend",this._update,this)},_addScales:function(){var e="border: 2px solid #000000;border-top: none;line-height: 1.1;padding: 2px 5px 1px;color: #000000;font-size: 11px;text-align:center;white-space: nowrap;overflow: hidden;-moz-box-sizing: content-box;box-sizing: content-box;background: #fff; background: rgba(255, 255, 255, 0);";this.options.metric&&(this._mScale=t.DomUtil.createElOn("div",e,this._scaleContainer)),this.options.imperial&&(this._iScale=t.DomUtil.createElOn("div",e,this._scaleContainer))},_update:function(){var t=this._map,e=t.pixelToDistance(this.options.maxWidth,0);this._updateScales(e)},_updateScales:function(t){this.options.metric&&t&&this._updateMetric(t),this.options.imperial&&t&&this._updateImperial(t)},_updateMetric:function(t){var e=this._getRoundNum(t),i=e<1e3?e+" m":e/1e3+" km";this._updateScale(this._mScale,i,e/t)},_updateImperial:function(t){var e,i,n,r=3.2808399*t;r>5280?(e=r/5280,i=this._getRoundNum(e),this._updateScale(this._iScale,i+" mile",i/e)):(n=this._getRoundNum(r),this._updateScale(this._iScale,n+" feet",n/r))},_updateScale:function(t,e,i){t.style.width=Math.round(this.options.maxWidth*i)+"px",t.innerHTML=e},_getRoundNum:function(t){var e=Math.pow(10,(Math.floor(t)+"").length-1),i=t/e;return i=i>=10?10:i>=5?5:i>=3?3:i>=2?2:1,e*i}}),t.Map.mergeOptions({scaleControl:!1}),t.Map.addOnLoadHook(function(){this.options.scaleControl&&(this.scaleControl=new t.control.Scale(this.options.scaleControl),this.addControl(this.scaleControl))}),t.control.Panel=t.control.Control.extend({options:{position:"top-right",draggable:!0,custom:!1,content:"",closeButton:!0},buildOn:function(){var e;if(this.options.custom)t.Util.isString(this.options.content)?(e=t.DomUtil.createEl("div"),e.innerHTML=this.options.content):e=this.options.content;else{if(e=t.DomUtil.createEl("div","maptalks-panel"),this.options.closeButton){var i=t.DomUtil.createEl("a","maptalks-close");i.href="javascript:;",i.onclick=function(){e.style.display="none"},e.appendChild(i)}var n=t.DomUtil.createEl("div","maptalks-panel-content");n.innerHTML=this.options.content,e.appendChild(n)}return this.draggable=new t.Handler.Drag(e,{cancelOn:t.Util.bind(this._cancelOn,this)}),this.draggable.on("dragstart",this._onDragStart,this).on("dragging",this._onDragging,this).on("dragend",this._onDragEnd,this),this.options.draggable&&this.draggable.enable(),e},update:function(){return this.draggable&&(this.draggable.disable(),delete this.draggable),t.control.Control.prototype.update.call(this)},setContent:function(t){var e=this.options.content;return this.options.content=t,this.fire("contentchange",{old:e,new:t}),this.isVisible()&&this.update(),this},getContent:function(){return this.options.content},_cancelOn:function(t){var e=t.srcElement||t.target,i=e.tagName.toLowerCase();return"button"===i||"input"===i||"select"===i||"option"===i||"textarea"===i},_onDragStart:function(e){this._startPos=e.mousePos,this._startPosition=t.Util.extend({},this.getPosition())},_onDragging:function(e){var i=e.mousePos,n=i.substract(this._startPos),r=this._startPosition,o=this.getPosition();t.Util.isNil(o.top)||(o.top=+r.top+n.y),t.Util.isNil(o.bottom)||(o.bottom=+r.bottom-n.y),t.Util.isNil(o.left)||(o.left=+r.left+n.x),t.Util.isNil(o.right)||(o.right=+r.right-n.x),this.setPosition(o)},_onDragEnd:function(){delete this._startPos,delete this._startPosition},_getConnectPoints:function(){var e=this._map,i=this.getContainerPoint(),n=this.getDOM(),r=n.clientWidth,o=n.clientHeight;return[e.containerPointToCoordinate(i.add(new t.Point(Math.round(r/2),0))),e.containerPointToCoordinate(i.add(new t.Point(r,Math.round(o/2)))),e.containerPointToCoordinate(i.add(new t.Point(Math.round(r/2),o))),e.containerPointToCoordinate(i.add(new t.Point(0,Math.round(o/2))))]}}),t.control.Toolbar=t.control.Control.extend({options:{height:28,vertical:!1,position:"top-right",items:{}},buildOn:function(e){this._map=e;var i=t.DomUtil.createEl("div"),n=t.DomUtil.createEl("ul","maptalks-toolbar-hx");i.appendChild(n),this.options.vertical?t.DomUtil.addClass(i,"maptalks-toolbar-vertical"):t.DomUtil.addClass(i,"maptalks-toolbar-horizonal");var r=this,o=this.options.items;if(t.Util.isArrayHasData(o))for(var s=0,a=o.length;s<a;s++){var h=o[s],l=t.DomUtil.createEl("li");if(28!==this.options.height&&(l.style.lineHeight=this.options.height+"px"),l.style.height=this.options.height+"px",l.style.cursor="pointer",t.DomUtil.isHTML(h.item)){l.style.textAlign="center";var u=t.DomUtil.measureDom("div",h.item);l.innerHTML='<div style="margin-top:'+(this.options.height-u.height)/2+'px;">'+h.item+"</div>"}else l.innerHTML=h.item;if(h.click&&t.DomUtil.on(l,"click",function(e,i,n,o){var s=r._getItems()[i];return function(r){return t.DomUtil.stopPropagation(r),e({target:s,index:i,childIndex:n,dom:o})}}(h.click,s,null,l)),t.Util.isArrayHasData(h.children)){var c=this._createDropMenu(s);l.appendChild(c),l._menu=c,t.DomUtil.on(l,"mouseover",function(){this._menu.style.display=""}),t.DomUtil.on(l,"mouseout",function(){this._menu.style.display="none"})}n.appendChild(l)}return i},_createDropMenu:function(e){var i=this,n=t.DomUtil.createEl("div","maptalks-dropMenu");n.style.display="none",n.appendChild(t.DomUtil.createEl("em","maptalks-ico"));var r=t.DomUtil.createEl("ul");n.appendChild(r);var o,s,a=this._getItems()[e].children,h=0;for(o=0,s=a.length;o<s;o++){var l=t.StringUtil.stringLength(a[o].item,"12px");l.width>h&&(h=l.width)}for(o=0,s=a.length;o<s;o++){var u=a[o],c=t.DomUtil.createEl("li");c.innerHTML='<a href="javascript:;">'+u.item+"</a>",c.style.cursor="pointer",c.style.width=h+24+"px",t.DomUtil.on(c.childNodes[0],"click",function(e,n,r){var o=i._getItems()[n].children[r];return function(i){return t.DomUtil.stopPropagation(i),e({target:o,index:n,childIndex:r})}}(u.click,e,o)),r.appendChild(c)}return n},_getItems:function(){return this.options.items}}),t.control.Overview=t.control.Control.extend({loadDelay:1600,options:{level:4,position:"bottom-right",size:{width:300,height:200},style:{color:"#1bbc9b"}},buildOn:function(e){var i=t.DomUtil.createEl("div");return i.style.cssText="border:1px solid #000;width:"+this.options.size.width+"px;height:"+this.options.size.height+"px;",e.isLoaded()?this._initOverview():e.on("load",this._initOverview,this),i},_initOverview:function(){var t=this;setTimeout(function(){t._createOverview()},this.loadDelay)},_createOverview:function(e){var i=this.getMap(),n=e||this.getDOM(),r=i.getExtent(),o=i.config();t.Util.extend(o,{center:i.getCenter(),zoom:this._getOverviewZoom(),scrollWheelZoom:!1,checkSize:!1,doubleClickZoom:!1,touchZoom:!1,control:!1}),this._overview=new t.Map(n,o),this._updateBaseLayer(),this._perspective=new t.Polygon(r.toArray(),{draggable:!0,cursor:"move",symbol:{lineWidth:3,lineColor:this.options.style.color,polygonFill:this.options.style.color,polygonOpacity:.4}}).on("dragstart",this._onDragStart,this).on("dragend",this._onDragEnd,this),i.on("resize moveend zoomend",this._update,this).on("setbaselayer",this._updateBaseLayer,this),new t.VectorLayer("v").addGeometry(this._perspective).addTo(this._overview),this.fire("load")},onRemove:function(){this.getMap().off("load",this._initOverview,this).off("resize moveend zoomend",this._update,this).off("setbaselayer",this._updateBaseLayer,this)},_getOverviewZoom:function(){var t,e=this.getMap(),i=e.getZoom(),n=e.getMinZoom(),r=this.options.level;if(r>0){for(t=r;t>0;t--)if(i-t>=n)return i-t}else for(t=r;t<0;t++)if(i-t>=n)return i-t;return i},_onDragStart:function(){this._origDraggable=this.getMap().options.draggable,this.getMap().config("draggable",!1)},_onDragEnd:function(){var t=this._perspective.getCenter();this._overview.setCenter(t),this.getMap().panTo(t),this.getMap().config("draggable",this._origDraggable)},_update:function(){this._perspective.setCoordinates(this.getMap().getExtent().toArray()),this._overview.setCenterAndZoom(this.getMap().getCenter(),this._getOverviewZoom())},_updateBaseLayer:function(){var e=this.getMap();e.getBaseLayer()?this._overview.setBaseLayer(t.Layer.fromJSON(e.getBaseLayer().toJSON())):this._overview.setBaseLayer(null)}}),t.Map.mergeOptions({overviewControl:!1}),t.Map.addOnLoadHook(function(){this.options.overviewControl&&(this.overviewControl=new t.control.Overview(this.options.overviewControl),this.addControl(this.overviewControl))}),"undefined"!=typeof module&&module.exports?exports=module.exports=t:"function"==typeof define&&define.amd&&define(t),"undefined"!=typeof window&&function(){var e=window.maptalks;t.noConflict=function(){return window.maptalks=e,this},window.maptalks=t}()}();