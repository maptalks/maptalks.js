/*!
 * ispace-gl v0.112.1
 * LICENSE : MIT
 * (c) 2016-2026 ispace.com
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).ispace=t.ispace||{})}(this,(function(t){"use strict";
/*!
   * ispace v1.4.1
   * LICENSE : BSD-3-Clause
   * (c) 2016-2025 ispace.org
   */var e="1.4.1",n="[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0)&&!process.versions.electron&&!process.versions.nw&&!process.versions["node-webkit"];function i(){return"undefined"!=typeof globalThis?globalThis:global||self}function o(t){var e=i().ispaceversion;if(e)throw new Error("Disallow duplicate imports of ispace version "+t+" and "+e);i().ispaceversion=t}var s={isTest:!1,idleLog:!1,idleForceTimeThreshold:48,workerCount:i().ispace_WORKER_COUNT||0,messagePostRatioPerWorker:.3,maxFPS:0,crsMaxNativeZoom:22};function a(){return Date.now()}function l(t,...e){for(var n=0;n<e.length;n++){var i=e[n];for(var o in i)t[o]=i[o]}return t}function h(t){return null==t}function c(t){return"number"==typeof t&&!isNaN(t)}function u(t){return(0|t)===t}function f(t){return"object"==typeof t&&!!t}function g(t){return!h(t)&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}function A(t){return!h(t)&&("function"==typeof t||null!==t.constructor&&t.constructor===Function)}var m=Object.prototype.hasOwnProperty;function w(t,e){return m.call(t,e)}var T=Math.PI/180;function M(t){return t*T}function C(t){return t/T}var P={};function I(){return window.devicePixelRatio||window.screen.deviceXDPI/window.screen.logicalXDPI}if(!n){var O=navigator.userAgent.toLowerCase(),E=document.documentElement||{style:{}},D="ActiveXObject"in window,N=-1!==O.indexOf("webkit"),H=-1!==O.indexOf("phantom"),U=-1!==O.search("android [23]"),W=-1!==O.indexOf("chrome"),q=-1!==O.indexOf("gecko")&&!N&&!window.opera&&!D,X=/iphone/i.test(O)&&/micromessenger/i.test(O),J="undefined"!=typeof orientation||-1!==O.indexOf("mobile"),Q=!window.PointerEvent&&window.MSPointerEvent,Y=window.PointerEvent&&navigator.pointerEnabled||Q,K=D&&"transition"in E.style,$="WebKitCSSMatrix"in window&&"m11"in new window.WebKitCSSMatrix&&!U,tt="MozPerspective"in E.style,et="OTransition"in E.style,nt=(K||$||tt)&&!et&&!H,it="undefined"!=typeof window&&A(window.createImageBitmap),rt="undefined"!=typeof window&&A(window.ResizeObserver),ot="undefined"!=typeof window&&A(window.btoa),st="undefined"!=typeof window&&A(window.Proxy),at="undefined"!=typeof window&&A(window.requestIdleCallback),ut="undefined"!=typeof CanvasRenderingContext2D&&A(CanvasRenderingContext2D.prototype.roundRect),ft=0;W&&(ft=O.match(/chrome\/([\d.]+)/)[1]);var gt=!H&&(Y||"ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch),vt="undefined"!=typeof window&&"WebGLRenderingContext"in window,xt=I(),bt=!1;try{new OffscreenCanvas(2,2).getContext("2d"),bt=!0}catch(t){bt=!1}var Ct=!1;try{var Ot=Object.defineProperty({},"passive",{get:function(){Ct=!0}});window.addEventListener("testPassive",null,Ot),window.removeEventListener("testPassive",null,Ot)}catch(lE){}(P={IS_NODE:n,isTest:!1,ie:D,ielt9:D&&!document.addEventListener,edge:"msLaunchUri"in navigator&&!("documentMode"in document),webkit:N,gecko:q,android:-1!==O.indexOf("android"),android23:U,chrome:W,chromeVersion:ft,safari:!W&&-1!==O.indexOf("safari"),phantomjs:H,ie3d:K,webkit3d:$,gecko3d:tt,opera12:et,any3d:nt,iosWeixin:X,mobile:J,mobileWebkit:J&&N,mobileWebkit3d:J&&$,mobileOpera:J&&window.opera,mobileGecko:J&&q,touch:!!gt,msPointer:!!Q,pointer:!!Y,retina:xt>1,devicePixelRatio:xt,language:navigator.browserLanguage?navigator.browserLanguage:navigator.language,ie9:D&&9===document.documentMode,ie10:D&&10===document.documentMode,webgl:vt,imageBitMap:it,roundRect:ut,resizeObserver:rt,btoa:ot,decodeImageInWorker:bt,monitorDPRChange:!0,supportsPassive:Ct,proxy:st,requestIdleCallback:at,checkDevicePixelRatio:function(){if("undefined"!=typeof window&&P.monitorDPRChange){var t=I(),e=t!==P.devicePixelRatio;return e&&(P.devicePixelRatio=t),e}return!1}}).roundRect||console.warn("current env the canvas not support roundRect")}var Gt=P;function $t(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=Array(e);n<e;n++)i[n]=t[n];return i}function ne(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function re(t,e,n){return e&&function(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,ge(i.key),i)}}(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}function oe(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(n)return(n=n.call(t)).next.bind(n);if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return $t(t,e);var n={}.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?$t(t,e):void 0}}(t))||e){n&&(t=n);var i=0;return function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function ae(t){return ae=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},ae(t)}function he(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,fe(t,e)}function ce(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(t){}return(ce=function(){return!!t})()}function ue(){ue=function(){return e};var t,e={},n=Object.prototype,i=n.hasOwnProperty,o=Object.defineProperty||function(t,e,n){t[e]=n.value},s="function"==typeof Symbol?Symbol:{},a=s.iterator||"@@iterator",l=s.asyncIterator||"@@asyncIterator",h=s.toStringTag||"@@toStringTag";function c(t,e,n){return Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{c({},"")}catch(t){c=function(t,e,n){return t[e]=n}}function u(t,e,n,i){var s=Object.create((e&&e.prototype instanceof M?e:M).prototype),a=new J(i||[]);return o(s,"_invoke",{value:U(t,n,a)}),s}function f(t,e,n){try{return{type:"normal",arg:t.call(e,n)}}catch(t){return{type:"throw",arg:t}}}e.wrap=u;var g="suspendedStart",A="suspendedYield",m="executing",w="completed",T={};function M(){}function C(){}function P(){}var I={};c(I,a,(function(){return this}));var O=Object.getPrototypeOf,E=O&&O(O(Q([])));E&&E!==n&&i.call(E,a)&&(I=E);var D=P.prototype=M.prototype=Object.create(I);function N(t){["next","throw","return"].forEach((function(e){c(t,e,(function(t){return this._invoke(e,t)}))}))}function H(t,e){function n(o,s,a,l){var h=f(t[o],t,s);if("throw"!==h.type){var c=h.arg,u=c.value;return u&&"object"==typeof u&&i.call(u,"__await")?e.resolve(u.__await).then((function(t){n("next",t,a,l)}),(function(t){n("throw",t,a,l)})):e.resolve(u).then((function(t){c.value=t,a(c)}),(function(t){return n("throw",t,a,l)}))}l(h.arg)}var s;o(this,"_invoke",{value:function(t,i){function o(){return new e((function(e,o){n(t,i,e,o)}))}return s=s?s.then(o,o):o()}})}function U(e,n,i){var o=g;return function(s,a){if(o===m)throw Error("Generator is already running");if(o===w){if("throw"===s)throw a;return{value:t,done:!0}}for(i.method=s,i.arg=a;;){var l=i.delegate;if(l){var h=W(l,i);if(h){if(h===T)continue;return h}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if(o===g)throw o=w,i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);o=m;var c=f(e,n,i);if("normal"===c.type){if(o=i.done?w:A,c.arg===T)continue;return{value:c.arg,done:i.done}}"throw"===c.type&&(o=w,i.method="throw",i.arg=c.arg)}}}function W(e,n){var i=n.method,o=e.iterator[i];if(o===t)return n.delegate=null,"throw"===i&&e.iterator.return&&(n.method="return",n.arg=t,W(e,n),"throw"===n.method)||"return"!==i&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+i+"' method")),T;var s=f(o,e.iterator,n.arg);if("throw"===s.type)return n.method="throw",n.arg=s.arg,n.delegate=null,T;var a=s.arg;return a?a.done?(n[e.resultName]=a.value,n.next=e.nextLoc,"return"!==n.method&&(n.method="next",n.arg=t),n.delegate=null,T):a:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,T)}function q(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function X(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function J(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(q,this),this.reset(!0)}function Q(e){if(e||""===e){var n=e[a];if(n)return n.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,s=function n(){for(;++o<e.length;)if(i.call(e,o))return n.value=e[o],n.done=!1,n;return n.value=t,n.done=!0,n};return s.next=s}}throw new TypeError(typeof e+" is not iterable")}return C.prototype=P,o(D,"constructor",{value:P,configurable:!0}),o(P,"constructor",{value:C,configurable:!0}),C.displayName=c(P,h,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===C||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,P):(t.__proto__=P,c(t,h,"GeneratorFunction")),t.prototype=Object.create(D),t},e.awrap=function(t){return{__await:t}},N(H.prototype),c(H.prototype,l,(function(){return this})),e.AsyncIterator=H,e.async=function(t,n,i,o,s){void 0===s&&(s=Promise);var a=new H(u(t,n,i,o),s);return e.isGeneratorFunction(n)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},N(D),c(D,h,"Generator"),c(D,a,(function(){return this})),c(D,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),n=[];for(var i in e)n.push(i);return n.reverse(),function t(){for(;n.length;){var i=n.pop();if(i in e)return t.value=i,t.done=!1,t}return t.done=!0,t}},e.values=Q,J.prototype={constructor:J,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(X),!e)for(var n in this)"t"===n.charAt(0)&&i.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var n=this;function o(i,o){return l.type="throw",l.arg=e,n.next=i,o&&(n.method="next",n.arg=t),!!o}for(var s=this.tryEntries.length-1;s>=0;--s){var a=this.tryEntries[s],l=a.completion;if("root"===a.tryLoc)return o("end");if(a.tryLoc<=this.prev){var h=i.call(a,"catchLoc"),c=i.call(a,"finallyLoc");if(h&&c){if(this.prev<a.catchLoc)return o(a.catchLoc,!0);if(this.prev<a.finallyLoc)return o(a.finallyLoc)}else if(h){if(this.prev<a.catchLoc)return o(a.catchLoc,!0)}else{if(!c)throw Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return o(a.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&i.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var s=o;break}}s&&("break"===t||"continue"===t)&&s.tryLoc<=e&&e<=s.finallyLoc&&(s=null);var a=s?s.completion:{};return a.type=t,a.arg=e,s?(this.method="next",this.next=s.finallyLoc,T):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),T},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),X(n),T}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.tryLoc===t){var i=n.completion;if("throw"===i.type){var o=i.arg;X(n)}return o}}throw Error("illegal catch attempt")},delegateYield:function(e,n,i){return this.delegate={iterator:Q(e),resultName:n,nextLoc:i},"next"===this.method&&(this.arg=t),T}},e}function fe(t,e){return fe=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},fe(t,e)}function ge(t){var e=function(t,e){if("object"!=typeof t||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var i=n.call(t,e);if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t,"string");return"symbol"==typeof e?e:e+""}function pe(t){var e="function"==typeof Map?new Map:void 0;return pe=function(t){if(null===t||!function(t){try{return-1!==Function.toString.call(t).indexOf("[native code]")}catch(e){return"function"==typeof t}}(t))return t;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(t))return e.get(t);e.set(t,n)}function n(){return function(t,e,n){if(ce())return Reflect.construct.apply(null,arguments);var i=[null];i.push.apply(i,e);var o=new(t.bind.apply(t,i));return n&&fe(o,n.prototype),o}(t,arguments,ae(this).constructor)}return n.prototype=Object.create(t.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),fe(n,t)},pe(t)}var Ae,me,ye=function(){function t(t,e,n){if(h(t)||h(e)?h(t.x)||h(t.y)?Array.isArray(t)&&(this.x=+t[0],this.y=+t[1],this.z=t[2]):(this.x=+t.x,this.y=+t.y,this.z=t.z):(this.x=+t,this.y=+e,this.z=n),this._isNaN())throw new Error("Position is NaN")}var e=t.prototype;return e.set=function(t,e,n){return this.x=t,this.y=e,this.z=n||0,this},e._abs=function(){return this.x=Math.abs(this.x),this.y=Math.abs(this.y),this},e._round=function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},e._ceil=function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this},e.distanceTo=function(t){var e=t.x-this.x,n=t.y-this.y;return Math.sqrt(e*e+n*n)},e.mag=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},e._floor=function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},e._add=function(t,e){return h(t.x)?h(t[0])?(this.x+=t,this.y+=e):(this.x+=t[0],this.y+=t[1]):(this.x+=t.x,this.y+=t.y),this},e._sub=function(t,e){return h(t.x)?h(t[0])?(this.x-=t,this.y-=e):(this.x-=t[0],this.y-=t[1]):(this.x-=t.x,this.y-=t.y),this},e._substract=function(t,e){return c(e)?this._sub(t,e):this._sub(t)},e.substract=function(t,e){return this.sub(t,e)},e._multi=function(t){return this.x*=t,this.y*=t,this},e.div=function(t){return this.multi(1/t)},e._div=function(t){return this._multi(1/t)},e._isNaN=function(){return isNaN(this.x)||isNaN(this.y)||c(this.z)&&isNaN(this.z)},e.isZero=function(){return 0===this.x&&0===this.y},e.toArray=function(){return c(this.z)?[this.x,this.y,this.z]:[this.x,this.y]},e.toJSON=function(){var t={x:this.x,y:this.y};return c(this.z)&&(t.z=this.z),t},t}(),_e=function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n.closeTo=function(t,e){return e||(e=0),this.x>=t.x-e&&this.x<=t.x+e&&this.y>=t.y-e&&this.y<=t.y+e},n.unit=function(){return this.copy()._unit()},n._unit=function(){return this._div(this.mag()),this},n.perp=function(){return this.copy()._perp()},n._perp=function(){return[this.x,this.y]=[-this.y,this.x],this},n.angleWith=function(t){return this.angleWithSep(t.x,t.y)},n.angleWithSep=function(t,e){return Math.atan2(this.x*e-this.y*t,this.x*t+this.y*e)},n._rotate=function(t){var e=Math.cos(t),n=Math.sin(t),i=n*this.x+e*this.y;return this.x=e*this.x-n*this.y,this.y=i,this},n.rotate=function(t){return this.copy()._rotate(t)},n.abs=function(){return new e(Math.abs(this.x),Math.abs(this.y))},n.round=function(){return new e(Math.round(this.x),Math.round(this.y))},n.ceil=function(){return new e(Math.ceil(this.x),Math.ceil(this.y))},n.floor=function(){return new e(Math.floor(this.x),Math.floor(this.y))},n.copy=function(){return new e(this.x,this.y,this.z)},n.toFixed=function(t){return new e(this.x.toFixed(t),this.y.toFixed(t),c(this.z)?this.z.toFixed(t):void 0)},n.add=function(t,n){var i,o;return h(t.x)?h(t[0])?(i=this.x+t,o=this.y+n):(i=this.x+t[0],o=this.y+t[1]):(i=this.x+t.x,o=this.y+t.y),new e(i,o)},n.sub=function(t,n){var i,o;return h(t.x)?h(t[0])?(i=this.x-t,o=this.y-n):(i=this.x-t[0],o=this.y-t[1]):(i=this.x-t.x,o=this.y-t.y),new e(i,o)},n.multi=function(t){return new e(this.x*t,this.y*t)},n.equals=function(t){return t instanceof this.constructor&&(this.x===t.x&&this.y===t.y&&this.z===t.z)},e}(ye);function ve(t){var e="data:image/svg+xml";return t.length>4&&".svg"===t.slice(-4)?1:t.slice(0,18)===e?2:0}function xe(t,e){n&&xe.node?xe.node(t,e):t.src=e[0]}!function(){if(n)return Ae=function(t){return setTimeout(t,16)},void(me=clearTimeout);Ae=function(t){return requestAnimationFrame(t)},me=function(t){return cancelAnimationFrame(t)}}();var be=0;function we(){return be++}var Me=we;function Ee(t){return t&&g(t)?JSON.parse(t):t}function ke(...t){for(var e=t[0],n=1;n<t.length;n++){var i=t[n];if(i&&i.length)for(var o=0,s=i.length;o<s;o++)e.push(i[o])}return e.length}function Re(...t){for(var e=[],n=-1,i=0;i<t.length;i++){var o=t[i];if(o&&o.length)for(var s=0,a=o.length;s<a;s++)e[++n]=o[s]}return e}function Le(t,e){var n=e.indexOf(t);n>-1&&e.splice(n,1)}function Fe(t,e,n){if(!Array.isArray(t))return n?e.call(n,t):e(t);for(var i,o,s=[],a=0,l=t.length;a<l;a++)h(i=t[a])?s.push(null):Array.isArray(i)?s.push(Fe(i,e,n)):(o=n?e.call(n,i):e(i),s.push(o));return s}function He(t,e){return void 0===t?e:t}function Ge(t){return Math.sign?Math.sign(t):0===(t=+t)||isNaN(t)?Number(t):t>0?1:-1}function Ue(t,e,n){return t*(1-n)+e*n}function We(t,e,n){if(t===n||t===e)return t;var i=n-e;return((t-e)%i+i)%i+e}function qe(t,e,n){return Math.min(n,Math.max(e,t))}function Je(t){return Array.isArray(t)&&t.length>0}var Qe=/^([a-z][a-z\d+\-.]*:)?\/\//i;function Ye(t){return Qe.test(t)}var Ke=/^url\((['"])(.+)\1\)$/i,tn=/^url\(([^'"].*[^'"])\)$/i;function nn(t){return g(t)?tn.test(t)?1:Ke.test(t)?2:3:0}function rn(t){var e=nn(t);return 3===e?t:1===e?tn.exec(t)[1]:2===e?Ke.exec(t)[2]:t}var on="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";function un(t){if(Gt.btoa)return window.btoa(t);for(var e,n,i=String(t),o="",s=0,a=on;i.charAt(0|s)||(a="=",s%1);o+=a.charAt(63&e>>8-s%1*8)){if((n=i.charCodeAt(s+=3/4))>255)throw new Error("'btoa' failed: The string to be encoded contains characters outside of the Latin1 range.");e=e<<8|n}return o}function pn(t,e){for(var n=atob(t),i=new ArrayBuffer(n.length),o=new Uint8Array(i),s=0;s<n.length;s++)o[s]=255&n.charCodeAt(s);return new Blob([i],{type:e})}function yn(t,e,n,i){return Math.atan2(i-e,n-t)}var vn="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";function xn(t,e){if(!t&&!e)return!0;if(!t||!e)return!1;for(var n in t)if("center"===n){if(!e[n]||!Tn(t[n][0],e[n][0])||!Tn(t[n][1],e[n][1]))return!1}else if(t[n]!==e[n])return!1;return!0}function Tn(t,e,n){return null==n&&(n=1e-6),t>=e-n&&t<=e+n}function Mn(t=100,e=4,n=null,i=null){t||(t=100),e||(e=4);var o=this,s=this.isVisible();return e*=2,this._flashTimeout&&clearTimeout(this._flashTimeout),this._flashTimeout=setTimeout((function a(){if(0===e)return s?o.show():o.hide(),void(n&&(i?n.call(i):n()));e%2==0?o.hide():o.show(),e--,o._flashTimeout=setTimeout(a,t)}),t),this}function Pn(t=[],e="_pt"){for(var n=[],i=0,o=t.length;i<o;i++){var s=t[i];if(s){s[e]||(s[e]=new _e(0,0));var a=s[e];a.x=0,a.y=0,n.push(a)}else n.push(null)}return n}function On(t,e){e(t.data)}function En(t){if(t&&0===t.indexOf("http://")||0===t.indexOf("https://"))return t;var e=document.createElement("a");return e.href=t,t=e.href,e=null,t}var Ln={cssWidth:"1px",cssHeight:"1px",width:1,height:1};function Dn(t,e=1){var{width:n,height:i}=t;return Ln.cssWidth=n+"px",Ln.cssHeight=i+"px",Ln.width=Math.round(n*e),Ln.height=Math.round(i*e),Ln}var Fn="_ispace__internal_layer_",Nn=["MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"],Hn=["FeatureCollection","Feature","Point","LineString","Polygon"].concat(Nn),Bn=["markerFile","polygonPatternFile","linePatternFile","markerFillPatternFile","markerLinePatternFile"],zn=[["markerWidth","markerHeight"],[],[null,"lineWidth"],[],[null,"markerLineWidth"]],Gn={lineWidth:1,lineOpacity:1,lineDx:1,lineDy:1,polygonOpacity:1,markerWidth:1,markerHeight:1,markerDx:1,markerDy:1,markerOpacity:1,markerFillOpacity:1,markerLineWidth:1,markerLineOpacity:1,textSize:1,textOpacity:1,textHaloRadius:1,textWrapWidth:1,textLineSpacing:1,textDx:1,textDy:1},Vn=["lineColor","polygonFill","markerFill","markerLineColor","textFill"],Wn=14,qn=function(){function t(t,e){c(t)&&c(e)?(this.width=t,this.height=e):c(t.width)?(this.width=t.width,this.height=t.height):Array.isArray(t)&&(this.width=t[0],this.height=t[1])}var e=t.prototype;return e.copy=function(){return new t(this.width,this.height)},e.add=function(e,n){var i,o;return e instanceof t?(i=this.width+e.width,o=this.height+e.height):(i=this.width+e,o=this.height+n),new t(i,o)},e.equals=function(t){return this.width===t.width&&this.height===t.height},e.multi=function(e){return new t(this.width*e,this.height*e)},e._multi=function(t){return this.width*=t,this.height*=t,this},e._round=function(){return this.width=Math.round(this.width),this.height=Math.round(this.height),this},e.toPoint=function(){return new _e(this.width,this.height)},e.toArray=function(){return[this.width,this.height]},e.toJSON=function(){return{width:this.width,height:this.height}},t}(),Jn="";function Yn(t){return t.trim?t.trim():t.replace(/^\s+|\s+$/g,"")}function Kn(t,e,n){if(!t)return t;for(;t.indexOf(e)>-1;)t=t.replace(e,n);return t}var $n=/[\b\t\r\v\f]/gim;function ei(t){return g(t)?t.replace($n,Jn):t}function ri(t){return Yn(t).split(/\s+/)}var oi="undefined"!=typeof document?document.createElement("canvas").getContext("2d"):null;function ai(t,e){return ai.node?ai.node(t,e):(oi.font=e,oi.measureText(t).width)}function li(t,e,n){var i=ai(t,e);return new qn(i,n||Wn)}function ci(t,e,n,i){if(!t||0===t.length)return[{text:"",width:0}];var o=h(i)?ai(t,e):i,s=o/t.length,a=Math.floor(n/s/2);if(s>=n||a<=0)return[{text:"",width:n}];if(o<=n)return[{text:t,width:o}];for(var l=[],c=t.substring(0,a),u=s*a,f=a,g=t.length;f<g;f++){var A=t[f],m=ai(c+A);m>=n?(l.push({text:c,width:u}),c=t.substring(f,a+f),f+=a-1,u=s*a):(c+=A,u=m),f>=g-1&&(u=ai(c),l.push({text:c,width:u}))}return l}var ui=["{","}"];function fi(t,e){if(!g(t))return t;var[n,i]=ui;if(-1===t.indexOf(n)&&-1===t.indexOf(i))return t;function o(t){if(!e)return Jn;var n=e[t];return h(n)?Jn:Array.isArray(n)?n.join():n}for(var s=function(t){t+=Jn;for(var[e,n]=ui,i=[],o=!1,s=Jn,a=0,l=t.length;a<l;a++){var h=t[a];o||h!==e||(o=!0),h===e&&o&&(s=Jn),o&&h!==e&&h!==n&&(s+=h),h===n&&s&&(o=!1,i.push(s),s=Jn)}return i}(t),a=0,l=s.length;a<l;a++){var c=s[a];t=Kn(t,""+n+c+i,o(c))}return t}function di(t,e){c(t)&&(t+="");var n=e.textMaxHeight||0,i=_i(t=t||"",e);return n&&n<i.size.height&&(i.size.height=n),i}function gi(t,e,n){var i=t.width,o=t.height;return new _e("left"===e?-i:"right"===e?0:-i/2,"top"===n?-o:"bottom"===n?0:-o/2)}var pi="sans-serif",Ai=14;function yi(t){if(t.textFont)return t.textFont;var e=t.textSize;return h(e)&&(e=Ai),(t.textStyle&&"normal"!==t.textStyle?t.textStyle+" ":"")+(t.textWeight&&"normal"!==t.textWeight?t.textWeight+" ":"")+e+"px "+(t.textFaceName&&function(t){for(var e=t.split(","),n=0;n<e.length;n++)e[n].trim&&(e[n]=e[n].trim()),e[n].indexOf(" ")>0&&'"'!==e[n][0]&&"'"!==e[n][0]&&(e[n]='"'+e[n]+'"');return e.join(",")}(t.textFaceName)||pi)}function _i(t,e){var n=yi(e),i=e.textLineSpacing||0,o=li(t,n,e.textSize),s=o.width,a=o.height,l=e.textWrapCharacter||"\n",h=[],c=e.textWrapWidth;(!c||c>s)&&(c=s),g(t)||(t+="");var u=0;if(l&&t.indexOf(l)>=0)for(var f=t.split(l),A=0,m=f.length;A<m;A++){var w=f[A],T=ai(w,n);if(T>c)for(var M=ci(w,n,c,T),C=0,P=M.length;C<P;C++){var I=M[C].width;I>u&&(u=I),h.push({text:M[C].text,size:new qn(I,a)})}else T>u&&(u=T),h.push({text:w,size:new qn(T,a)})}else if(s>c)for(var O=ci(t,n,c,s),E=0;E<O.length;E++){var D=O[E].width;D>u&&(u=D),h.push({text:O[E].text,size:new qn(D,a)})}else s>u&&(u=s),h.push({text:t,size:o});var N=h.length;return{total:N,size:new qn(u,a*N+i*(N-1)),rows:h,rawSize:o}}function vi(t){var e=0,n=t&&t.length||0;if(!n)return e;for(var i=0;i<n;i++)e=(e<<5)-e+t.charCodeAt(i),e|=0;return e}var xi=Object.freeze({__proto__:null,DEFAULT_FONT:pi,DEFAULT_TEXTSIZE:Ai,EMPTY_STRING:Jn,describeText:di,escapeSpecialChars:ei,getAlignPoint:gi,getFont:yi,hashCode:vi,replaceAll:Kn,replaceVariable:fi,splitContent:ci,splitTextToRow:_i,splitWords:ri,stringLength:li,stringWidth:ai,trim:Yn}),bi=n?function(t){return t[0]}:function(t){for(var e=document.documentElement&&document.documentElement.style||{},n=0;n<t.length;n++)if(t[n]in e)return t[n];return!1},wi=bi(["transform","WebkitTransform","OTransform","MozTransform","msTransform"]),Ti=bi(["transformOrigin","WebkitTransformOrigin","OTransformOrigin","MozTransformOrigin","msTransformOrigin"]),Mi=bi(["transition","WebkitTransition","OTransition","MozTransition","msTransition"]),Si=bi(["filter","WebkitFilter","OFilter","MozFilter","msFilter"]);function Pi(t,e){var n=document.createElement(t);return e&&Yi(n,e),n}function Ii(t,e,n){var i=Pi(t);return e&&qi(i,e),n&&n.appendChild(i),i}function ki(t){if(!t)return this;if(Gt.ielt9||Gt.ie9){var e=Pi("div");e.appendChild(t),e.innerHTML="",e=null}else t.parentNode&&t.parentNode.removeChild(t);return this}function Ri(t,e,n,i){if(!(t&&t.addEventListener&&e&&n))return this;for(var o=function(e){e||(e=window.event),n.call(i||t,e)},s=e.split(" "),a=s.length-1;a>=0;a--){var l=s[a];if(l)t["Z__"+l]||(t["Z__"+l]=[]),Fi(t,l,n)>=0&&(console.warn(t,"find '"+l+"' handler:",n," The old listener function will be removed"),Di(t,l,n)),t["Z__"+l].push({callback:o,src:n}),t.addEventListener(l,o,!!Gt.supportsPassive&&{capture:!1,passive:!1})}return this}function Di(t,e,n){function i(e,n){"mousewheel"===e&&Gt.gecko&&(e="DOMMouseScroll"),t.removeEventListener(e,n,!1)}if(!t||!t.removeEventListener||!e)return this;for(var o=e.split(" "),s=o.length-1;s>=0;s--){var a=o[s];if(a){if(!n&&t["Z__"+a]){for(var l=t["Z__"+a],h=0,c=l.length;h<c;h++)i(l[h].callback);return delete t["Z__"+a],this}var u=Fi(t,a,n);if(u<0)return this;i(a,t["Z__"+a][u].callback),t["Z__"+a].splice(u,1)}}return this}function Fi(t,e,n){if(!t||!t["Z__"+e]||!n)return-1;for(var i=t["Z__"+e],o=0,s=i.length;o<s;o++)if(i[o].src===n)return o;return-1}function Hi(t){return t.preventDefault?t.preventDefault():t.returnValue=!1,this}function zi(t){return t._cancelBubble=!0,t.stopPropagation?t.stopPropagation():t.cancelBubble=!0,this}function Gi(t){return t.onselectstart=function(){return!1},t.ondragstart=function(){return!1},t.setAttribute("unselectable","on"),this}function Ui(t,e){return t?(Gt.any3d?$i(t,e):(t.style.left=e.x+"px",t.style.top=e.y+"px"),e):null}function Wi(t){var e=window.getComputedStyle(t),n=[parseInt(e["padding-left"]),parseInt(e["padding-top"])],i=t.getBoundingClientRect(),o=t.offsetWidth,s=t.offsetHeight;return t.__position=[i.left+n[0],i.top+n[1],o?i.width/o:1,s?i.height/s:1],t.__position}function Zi(t,e){t||(t=window.event);var n=e.__position;n||(n=Wi(e));var i=t;return i.touches&&i.touches.length&&(t=i.touches[0]),i.changedTouches&&i.changedTouches.length&&(t=i.changedTouches[0]),new _e((t.clientX-n[0]-e.clientLeft)/n[2],(t.clientY-n[1]-e.clientTop)/n[3])}function qi(t,e){var n=t.style.cssText;return function(t,e){var n=t.length-e.length;return n>=0&&t.indexOf(e,n)===n}(n,";")||(n+=";"),t.style.cssText=n+e,this}function Ji(t,e){if(void 0!==t.classList)return t.classList.contains(e);var n=Ki(t);return n.length>0&&new RegExp("(^|\\s)"+e+"(\\s|$)").test(n)}function Qi(t,e){if(void 0===t.classList||Ji(t,e)){var n=Ki(t);Yi(t,(n?n+" ":"")+e)}else for(var i=ri(e),o=0,s=i.length;o<s;o++)t.classList.add(i[o]);return this}function Yi(t,e){return h(t.className.baseVal)?t.className=e:t.className.baseVal=e,this}function Ki(t){return h(t.className.baseVal)?t.className:t.className.baseVal}function $i(t,e){var n=e||new _e(0,0);return t.style[wi]=Gt.any3d?"translate3d("+n.x+"px,"+n.y+"px,0px)":"translate("+n.x+"px,"+n.y+"px)",this}function tr(t){return/<[a-z\][\s\S]*>/i.test(t)}function er(t,e){var n=nr(t);g(e)?n.innerHTML=e:n.appendChild(e);var i=new qn(n.clientWidth,n.clientHeight);return ki(n),i}function nr(t){var e=document.createElement(t);return e.style.cssText="position:absolute;left:-10000px;top:-10000px;",document.body.appendChild(e),e}var or=Ri,sr=Di;function ar(t){return t&&("mousemove"===t||"touchmove"===t)}function lr(t,e){var n=a();return!!(t._mousemoveTime&&n-t._mousemoveTime<(e||48))||(t._mousemoveTime=n,!1)}var hr=Object.freeze({__proto__:null,CSSFILTER:Si,MOUSEMOVE_THROTTLE_TIME:48,TRANSFORM:wi,TRANSFORMORIGIN:Ti,TRANSITION:Mi,addClass:Qi,addDomEvent:Ri,computeDomPosition:Wi,createEl:Pi,createElOn:Ii,getClass:Ki,getDomRuler:nr,getEventContainerPoint:Zi,hasClass:Ji,isHTML:tr,isMousemoveEventBlocked:lr,isMoveEvent:ar,listensDomEvent:Fi,measureDom:er,off:sr,offsetDom:Ui,on:or,preventDefault:Hi,preventSelection:Gi,removeDomEvent:Di,removeDomNode:ki,removeTransform:function(t){return t.style[wi]&&(t.style[wi]=""),this},setClass:Yi,setOpacity:function(t,e){return t.style.opacity=e,this},setStyle:qi,setTransform:$i,setTransformMatrix:function(t,e){var n="matrix("+(g(e)?e:e.join())+")";return t.style[wi]!==n&&(t.style[wi]=n),this},stopPropagation:zi}),cr={jsonp:function(t,e){var n="_ispace_jsonp_"+we();t.match(/\?/)?t+="&callback="+n:t+="?callback="+n;var i=document.createElement("script");return i.type="text/javascript",i.src=t,window[n]=function(t){e(null,t),document.getElementsByTagName("head")[0].removeChild(i),i=null,delete window[n]},document.getElementsByTagName("head")[0].appendChild(i),this},get:function(t,e,i){if(A(e)){var o=i;i=e,e=o}if(n&&cr.get.node)return cr.get.node(t,i,e);var s=cr._getClient(i);if(s.open("GET",t,!0),e){for(var a in e.headers)s.setRequestHeader(a,e.headers[a]);s.withCredentials="include"===e.credentials,e.responseType&&(s.responseType=e.responseType)}return s.send(null),s},post:function(t,e,i){var o;if(g(t)){if(A(e)){var s=i;i=e,e=s}o=(e=e||{}).postData}else{o=e,t=(e=t).url,i=i}if(n&&cr.post.node)return e.url=t,cr.post.node(e,o,i);var a=cr._getClient(i);if(a.open("POST",e.url,!0),e.headers||(e.headers={}),e.headers["Content-Type"]||(e.headers["Content-Type"]="application/x-www-form-urlencoded"),"setRequestHeader"in a)for(var l in e.headers)e.headers.hasOwnProperty(l)&&a.setRequestHeader(l,e.headers[l]);return g(o)||(o=JSON.stringify(o)),a.send(o),a},_wrapCallback:function(t,e){return function(){4===t.readyState&&(200===t.status?"arraybuffer"===t.responseType?0===t.response.byteLength?e(new Error("http status 200 returned without content.")):e(null,{data:t.response,cacheControl:t.getResponseHeader("Cache-Control"),expires:t.getResponseHeader("Expires"),contentType:t.getResponseHeader("Content-Type")}):e(null,t.responseText):e(new Error(t.statusText+","+t.status)))}},_getClient:function(t){var e;try{e=new XMLHttpRequest}catch(t){try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(t){try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(t){}}}return e.onreadystatechange=cr._wrapCallback(e,t),e},getArrayBuffer:function(t,e,n){if(A(e)){var i=n;n=e,e=i}return e||(e={}),e.responseType="arraybuffer",cr.get(t,e,n)},getImage:function(t,e,n){return cr.getArrayBuffer(e,n,(function(e,n){if(e)t.onerror&&t.onerror(e);else if(n){var i=window.URL||window.webkitURL,o=t.onload;t.onload=function(){o&&o(),i.revokeObjectURL(t.src)};var s=new Blob([new Uint8Array(n.data)],{type:n.contentType});t.cacheControl=n.cacheControl,t.expires=n.expires,t.src=n.data.byteLength?i.createObjectURL(s):vn}}))},getJSON:function(t,e,n){}};cr.getJSON=function(t,e,n){if(A(e)){var i=n;n=e,e=i}var o=function(t,e){var i=e?Ee(e):null;n(t,i)};return e&&e.jsonp?cr.jsonp(t,o):cr.get(t,e,o)};var fr="",gr=/data:image\/.*;base64,/;function mr(t,e={}){for(var n in e){var i=e[n];if(i&&i.target&&(a=n,c(s=t)&&(s+=fr),c(a)&&(a+=fr),s&&a&&(s.includes?s.includes(a):s.indexOf(a)>-1))){var{target:o}=i;return t.replace(n,o)}}var s,a;return fr}var yr,_r={host:fr,resources:{},proxy:{},origin:{},fromJSON:function(t){try{g(t)&&(t=JSON.parse(t)),f(t)&&l(_r,t)}catch(t){console.error(t)}},toJSON:function(){return{host:_r.host,proxy:l({},_r.proxy||{}),origin:l({},_r.origin||{})}},getResource:function(t){return _r.resources[t]},removeResource:function(t){delete _r.resources[t]},addResource:function(t,e){_r.resources[t]?console.warn(t+" resource Already exists,the "+t+" Cannot be added,the resource name Cannot repeat "):_r.resources[t]=e},updateResource:function(t,e){_r.resources[t]=e},allResource:function(){return _r.resources},loadSprite:function(t={imgUrl:"",jsonUrl:""}){return new Promise((function(e,n){var{imgUrl:i,jsonUrl:o}=t;if(!i||!o)return n(new Error("not find imgUrl/jsonUrl from options")),void console.error(t);function s(t,e,n){t.width=e,t.height=n;var i=t.getContext("2d");return i.clearRect(0,0,e,n),i}function a(i={},o){var a=function(){var t;return Gt.IS_NODE?console.error("Current environment does not support canvas dom"):t=Pi("canvas"),t}();if(a){var l=[];for(var h in i){l.push({name:h,spriteItem:i[h]})}var c=function(){var t;return Gt.decodeImageInWorker&&(t=new OffscreenCanvas(2,2)),t}(),u=t.sourceName||"";l.forEach((function(t){var e,{name:n,spriteItem:i}=t,{x:l,y:h,width:f,height:g}=i;c?(s(c,f,g).drawImage(o,l,h,f,g,0,0,f,g),e=c.transferToImageBitmap()):(s(a,f,g).drawImage(o,l,h,f,g,0,0,f,g),e=a.toDataURL());t.resource=e,_r.addResource(u+n,e)})),e(l)}else n(new Error("can not create canvas"))}cr.getJSON(o,{},(function(t,e){if(t)n(t);else{var o=new Image;o.onload=function(){a(e,o)},o.onerror=function(t){n(t)},cr.getImage(o,i,{})}}))}))},loadSvgs:function(t){return new Promise((function(e,n){var i="",o=[],s="",a="",l="";if(Array.isArray(t)||t instanceof NodeList)o=t;else if(f(t)){i=t.url,o=t.symbols,s=t.fill,a=t.stroke,l=t.sourceName||""}else g(t)&&(i=t);if(i||!o||0!==o.length){var h=[],c=function(t,e){var n=Ir(e);n&&(n.forEach((function(t){s&&(t.fill=s),a&&(t.stroke=a)})),_r.addResource(l+t,n)),h.push({name:t,paths:n,body:e})};if(i&&g(i))fetch(i).then((function(t){return t.json()})).then((function(t){t.forEach((function(t){var{name:e,body:n}=t;c(e,n)})),e(h)})).catch((function(t){console.log(t),n(t)}));else if(o){for(var u=0,A=o.length;u<A;u++){var m=o[u],w=m.id;w&&c(w,"<xml><svg>"+m.innerHTML+"</svg></xml>")}e(h)}else n(new Error("not support svgs params type"))}else n(new Error("not find svgs data"))}))}};function vr(t){if(c(t)&&(t+=fr),!t)return console.error("resouce path is null,path:",t),t;if(!g(t))return t;if(function(t){return gr.test(t)}(t)||function(t){return 0===t.indexOf("blob:")}(t))return t;if("$"===t[0])return _r.getResource(t.substring(1,1/0))||"";var e=_r.origin||{},n=Ye(t);if(n&&f(e)){var i=mr(t,e);return i||t}var o=_r.proxy||{};if(f(o)){var s=mr(t,o);if(s)return s}var{host:a}=_r;return!n&&a&&g(a)?""+a+t:En(t)}function br(t,e){return t?t[e]&&t[e].value:null}function Ir(t){var e=(yr||(yr=new DOMParser),yr).parseFromString(t,"text/xml").querySelector("svg");if(!e)return null;for(var n=e.childNodes,i=[],o=e.attributes,s=br(o,"fill"),a=br(o,"fill-opacity"),l=br(o,"stroke"),h=br(o,"stroke-opacity"),c=br(o,"stroke-width"),u=0,f=n.length;u<f;u++){var g=n[u],A=g.attributes;if(A){var m=void 0,w="path"===(g.tagName||"").toLowerCase();if(m=w?br(A,"d"):g){var T=br(A,"fill")||s,M=br(A,"stroke")||l,C={path:m};if(T&&(C.fill=T,C["fill-opacity"]=br(A,"fill-opacity")||a||1),M&&(C.stroke=M,C["stroke-opacity"]=br(A,"stroke-opacity")||h||1,C["stroke-width"]=br(A,"stroke-width")||c||1),i.push(C),!w)for(var P in C)"path"!==P&&C.hasOwnProperty(P)&&g.setAttribute(P,C[P])}}}return i}let Or;const Er={width:100,height:10};let kr=!1;try{const t=new OffscreenCanvas(1,1);t.getContext("2d").fillText("hello",0,0),kr=!0}catch(t){kr=!1}let Rr=class ColorIn{constructor(t,e={}){if(!Array.isArray(t))return void console.error("colors is not array");if(t.length<2)return void console.error("colors.length should >1");this.colors=t;let n=1/0,i=-1/0;for(let e=0,o=t.length;e<o;e++){const o=t[e][0];n=Math.min(o,n),i=Math.max(o,i)}this.min=n,this.max=i,this.valueOffset=this.max-this.min,this.options=Object.assign({},Er,e),this._initImgData()}getImageData(){return this.imgData}_initImgData(){const t=function(){if(!Or){const{width:t,height:e}=Er;kr?Or=new OffscreenCanvas(t,e):(Or=document.createElement("canvas"),Or.width=t,Or.height=e)}return Or}(),{width:e,height:n}=this.options;t.width=e,t.height=n;const i=t.getContext("2d");i.clearRect(0,0,t.width,t.height);const o=i.createLinearGradient(0,0,t.width,0),{colors:s,valueOffset:a}=this;for(let t=0,e=s.length;t<e;t++){const[e,n]=s[t];o.addColorStop((e-this.min)/a,n)}i.fillStyle=o,i.fillRect(0,0,t.width,t.height),this.imgData=i.getImageData(0,0,t.width,t.height)}getColor(t){t=Math.max(this.min,t),t=Math.min(t,this.max);let e=Math.round((t-this.min)/this.valueOffset*this.imgData.width);e=Math.min(e,this.imgData.width-1);const n=4*e;return[this.imgData.data[n],this.imgData.data[n+1],this.imgData.data[n+2],this.imgData.data[n+3]]}};var Lr;function Dr(t){return null==t}function Fr(t){return!Dr(t)}function Nr(t){return""===t}function Br(t,e){var n,i,o;if(Kr(t)){var s,a=t.stops&&"object"==typeof t.stops[0][0],l=a||Fr(t.property),h=a||!l,c=t.type||e||"exponential";if("exponential"===c)s=Ur;else if("interval"===c)s=Gr;else if("categorical"===c)s=zr;else if("identity"===c)s=qr;else if("color-interpolate"===c)s=Zr;else{if("calculate-expression"!==c)throw new Error('Unknown function type "'+c+'"');s=Jr}if(a){var u={},f=[];for(let e=0;e<t.stops.length;e++){var g=t.stops[e];void 0===u[g[0].zoom]&&(u[g[0].zoom]={zoom:g[0].zoom,type:t.type,property:t.property,default:t.default,stops:[]}),u[g[0].zoom].stops.push([g[0].value,g[1]])}for(let t in u)f.push([u[t].zoom,Br(u[t])]);n=function(e,n){const i=Ur({stops:f,base:t.base},e)(e,n);return"function"==typeof i?i(e,n):i},i=!1,o=!1}else h?(n=function(e){const n=s(t,e);return"function"==typeof n?n(e):n},i=!0,o=!1):(n=function(e,n){const i=s(t,n?n[t.property]:null);return"function"==typeof i?i(e,n):i},i=!1,o=!0)}else n=function(){return t},i=!0,o=!0;return n.isZoomConstant=o,n.isFeatureConstant=i,n}function zr(t,e){for(let n=0;n<t.stops.length;n++)if(e===t.stops[n][0])return t.stops[n][1];return t.default}function Gr(t,e){for(var n=0;n<t.stops.length&&!(e<t.stops[n][0]);n++);return t.stops[Math.max(n-1,0)][1]}function Ur(t,e){for(var n=Fr(t.base)&&!Nr(t.base)?t.base:1,i=0;!(i>=t.stops.length||e<=t.stops[i][0]);)i++;return 0===i?t.stops[i][1]:i===t.stops.length?t.stops[i-1][1]:Qr(e,n,t.stops[i-1][0],t.stops[i][0],t.stops[i-1][1],t.stops[i][1])}"function"==typeof Map&&(Lr=new Map);const Wr={width:100,height:1};function Zr(t,e){const n=t.stops;if(n&&n.length>1){let t;if(Lr){const e=JSON.stringify(n);if(!Lr.has(e)){const t=new Rr(n,Wr);Lr.set(e,t)}t=Lr.get(e)}else t=new Rr(n,Wr);const[i,o,s,a]=t.getColor(e);return[i/255,o/255,s/255,a/255]}return n&&1===n.length?n[0][1]:null}function qr(t,e){return function(t,e,n){return Fr(t)?t:Fr(e)?e:Fr(n)?n:null}(e,t.default)}function Jr(t,e){const n=String(t.property),i=t.expression,o=e;function s(e){return Dr(e)||Nr(e)||isNaN(e)?t.default:e}if(!Fr(e)||Nr(e)||isNaN(e)||e<0)return s(t.default);{const e=function t(e,n,i){const o=Number(i),s=String(n);return Array.isArray(e)?e.map((e=>t(e,s,o))):e===s?o:e}(i,n,o);return s(function e(n){if(!Array.isArray(n)){if("number"==typeof n)return n;throw new Error("Invalid expression format")}{const i=n[0];if(!["+","-","*","/"].includes(i))throw new Error(`Unknown operator: ${i}`);const o=n.slice(1).map((t=>e(t)));switch(i){case"+":return o.reduce(((t,e)=>t+e),0);case"-":return o.reduce(((t,e)=>t-e));case"*":return o.reduce(((t,e)=>t*e),1);case"/":return o.some((t=>0===t))?t.default:o.reduce(((t,e)=>t/e));default:throw new Error(`Unsupported operator: ${i}`)}}}(e))}}function Qr(t,e,n,i,o,s){return"function"==typeof o?function(){var a=o.apply(void 0,arguments),l=s.apply(void 0,arguments);return Qr(t,e,n,i,a,l)}:o.length?function(t,e,n,i,o,s){var a=[];for(let l=0;l<o.length;l++)a[l]=Yr(t,e,n,i,o[l],s[l]);return a}(t,e,n,i,o,s):Yr(t,e,n,i,o,s)}function Yr(t,e,n,i,o,s){var a,l=i-n,h=t-n;return o*(1-(a=1===e?h/l:(Math.pow(e,h)-1)/(Math.pow(e,l)-1)))+s*a}function Kr(t){return t&&"object"==typeof t&&(t.stops||t.property&&"identity"===t.type||t.expression&&"calculate-expression"===t.type)}function $r(t){for(const e in t)if(Kr(t[e]))return!0;return!1}function to(t){return ro(t,"exponential")}function no(t,e){if(!t)return null;var n=!1;if(Array.isArray(t)){var i,o=[];for(let s=0;s<t.length;s++)(i=no(t[s],e))?(o.push(i),n=!0):o.push(t[s]);return n?o:t}var s,a={__fn_types_loaded:!0},l=[];for(s in t)t.hasOwnProperty(s)&&l.push(s);const h=function(t){Object.defineProperty(a,t,{get:function(){return this["__fn_"+t]||(this["__fn_"+t]=to(this["_"+t])),this["__fn_"+t].apply(this,e())},set:function(e){this["_"+t]=e},configurable:!0,enumerable:!0})};for(let e=0,i=l.length;e<i;e++)Kr(t[s=l[e]])?(n=!0,a["_"+s]=t[s],h(s)):a[s]=t[s];return n?a:t}function io(t){if(!t||!t.stops)return[];const e=[];for(let n=0,i=t.stops.length;n<i;n++)e.push(t.stops[n][1]);return e}function ro(t,e){if(!Kr(t))return function(){return t};let n=!0,i=!0;const o=(t=JSON.parse(JSON.stringify(t))).stops;if(o)for(let t=0;t<o.length;t++)if(Kr(o[t][1])){const s=ro(o[t][1],e);n=n&&s.isZoomConstant,i=i&&s.isFeatureConstant,o[t]=[o[t][0],s]}const s=Br(t,e);return s.isZoomConstant=n&&s.isZoomConstant,s.isFeatureConstant=i&&s.isFeatureConstant,s}
/*!
      Feature Filter by

      (c) mapbox 2016 and ispace 2018
      www.mapbox.com | www.ispace.org
      License: MIT, header required.
  */const oo=["Unknown","Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"];function so(t){return new Function("f",`var p = (f && f.properties || {}); return ${ao(t)}`)}function ao(t){if(!t)return"true";const e=t[0];if(t.length<=1)return"any"===e?"false":"true";const n="=="===e?co(t[1],t[2],"===",!1):"!="===e?co(t[1],t[2],"!==",!1):"<"===e||">"===e||"<="===e||">="===e?co(t[1],t[2],e,!0):"any"===e?fo(t.slice(1),"||"):"all"===e?fo(t.slice(1),"&&"):"none"===e?_o(fo(t.slice(1),"||")):"in"===e?mo(t[1],t.slice(2)):"!in"===e?_o(mo(t[1],t.slice(2))):"has"===e?yo(t[1]):"!has"===e?_o(yo(t[1])):"contains"===e?function(t,e,n){const i=lo(t);return void 0!==n?`(${i} + '').indexOf("${e}") === ${n}`:`(${i} + '').indexOf("${e}") >= 0`}(t[1],t[2],t[3]):"true";return`(${n})`}function lo(t){return"$"===t[0]?"f."+t.substring(1):"p["+JSON.stringify(t)+"]"}function co(t,e,n,i){if("object"==typeof(o=t)&&o&&t.op)return function(t,e,n,i){const o=t.property,s=t.op;let a=lo(o);return"length"!==s?(console.error(`not support ${s} op`),"false"):(a=`((${a}+='').length)`,uo(a,o,e,n,i))}(t,e,n,i);var o;return uo(lo(t),t,e,n,i)}function uo(t,e,n,i,o){const s="$type"===e?oo.indexOf(n):JSON.stringify(n);return(o?`typeof ${t}=== typeof ${s}&&`:"")+t+i+s}function fo(t,e){return t.map(ao).join(e)}function mo(t,e){"$type"===t&&(e=e.map((t=>oo.indexOf(t))));const n=JSON.stringify(e.sort(vo)),i=lo(t);return e.length<=200?`${n}.indexOf(${i}) !== -1`:`function(v, a, i, j) {\n        while (i <= j) { var m = (i + j) >> 1;\n            if (a[m] === v) return true; if (a[m] > v) j = m - 1; else i = m + 1;\n        }\n    return false; }(${i}, ${n},0,${e.length-1})`}function yo(t){return"$id"===t?'"id" in f':`${JSON.stringify(t)} in p`}function _o(t){return`!(${t})`}function vo(t,e){return t<e?-1:t>e?1:0}function xo(t){const e=t._toJSON(),n=e.feature;return n.type=oo.indexOf(n.geometry.type),n.subType=e.subType,n}function bo(t){if(!Array.isArray(t))return bo([t]);const e=[];for(let n=0;n<t.length;n++){let i;i=!0===t[n].filter?function(){return!0}:so(t[n].filter),e.push(wo({},t[n],{filter:i}))}return e}function wo(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)t[e]=n[e]}return t}var Mo=[],Co={};function So(t,e){return no(t,(function(){var t=e.getMap();return function(t,e,n){return t[0]=e,t[1]=n,t}(Mo,t?t.getZoom():12,l({},e.getProperties(),function(t,e,n,i){return t["{bearing}"]=e,t["{pitch}"]=n,t["{zoom}"]=i,t}(Co,t&&t.getBearing()||0,t&&t.getPitch()||0,t?t.getZoom():10)))}))}var Po=Object.freeze({__proto__:null,compileStyle:bo,createFilter:so,getFilterFeature:xo,getFunctionTypeResources:io,hasFunctionDefinition:$r,interpolated:to,isFeatureFilter:function t(e){if(!0===e||!1===e)return!0;if(!Array.isArray(e)||0===e.length)return!1;switch(e[0]){case"has":case"!has":return 2===e.length&&("string"==typeof e[1]||e[1].property&&e[1].op);case"in":case"!in":return e.length>=2&&("string"==typeof e[1]||e[1].property&&e[1].op);case"==":case"!=":case">":case">=":case"<":case"<=":return 3===e.length&&("string"==typeof e[1]||e[1].property&&e[1].op);case"none":case"any":case"all":for(const n of e.slice(1))if(!t(n)&&"boolean"!=typeof n)return!1;return!0;case"contains":return!0;default:return!1}},isFunctionDefinition:Kr,loadFunctionTypes:no,loadGeoSymbol:So});function Io(t){var e={stroke:{stroke:t.markerLineColor,"stroke-width":t.markerLineWidth,"stroke-opacity":t.markerLineOpacity,"stroke-dasharray":null,"stroke-linecap":"butt","stroke-linejoin":"round"},fill:{fill:t.markerFill,"fill-opacity":t.markerFillOpacity}};return 0===e.stroke["stroke-width"]&&(e.stroke["stroke-opacity"]=0),e}function Oo(t,e,n){if(!t.markerPath)return null;var i=1,o=Io(t);c(t.markerOpacity)&&(i=t.markerOpacity),c(t.opacity)&&(i*=t.opacity);var s,a={};if(o){for(var u in o.stroke)o.stroke.hasOwnProperty(u)&&(h(o.stroke[u])||(a[u]=o.stroke[u]));for(var f in o.fill)o.fill.hasOwnProperty(f)&&(h(o.fill[f])||(a[f]=o.fill[f]))}var A,m=t.markerPath;s=g(m)&&"$"===m[0]?_r.getResource(m.substring(1,1/0))||[]:Array.isArray(t.markerPath)?t.markerPath:[t.markerPath];for(var w=[],T=0;T<s.length;T++)(A=l({},A=g(s[T])?{path:s[T]}:s[T],a)).d=A.path,delete A.path,w.push(A);var M=['<svg version="1.1"','xmlns="http://www.w3.org/2000/svg"'];i<1&&M.push('opacity="'+i+'"'),t.markerPathWidth&&t.markerPathHeight&&M.push('viewBox="0 0 '+t.markerPathWidth+" "+t.markerPathHeight+'"'),M.push('preserveAspectRatio="none"'),e&&M.push('width="'+e+'"'),n&&M.push('height="'+n+'"'),M.push("><defs></defs>");for(var C=0;C<w.length;C++)if(w[C].d instanceof Element)M.push(w[C].d.outerHTML);else{var P="<path ";for(var I in w[C])w[C].hasOwnProperty(I)&&(P+=" "+I+'="'+w[C][I]+'"');M.push(P+="></path>")}return M.push("</svg>"),"data:image/svg+xml;base64,"+un(M.join(" "))}function Eo(t,e){if(!t)return[];var n=t;Array.isArray(t)||(n=[t]);for(var i,o,s,a,l=[],h=Bn,c=n.length-1;c>=0;c--)if(t=n[c]){e&&(t=Ro(t));for(var u=0;u<h.length;u++)if(Kr(i=t[h[u]])&&(i=io(i)),i){Array.isArray(i)||(i=[i]);for(var f=0;f<i.length;f++)"url("===i[f].slice(0,4)&&(i[f]=rn(i[f])),l.push([i[f],t[(o=zn[u])[0]],t[o[1]]])}if("path"===t.markerType&&t.markerPath)if(s=Kr(t.markerWidth)?200:t.markerWidth,a=Kr(t.markerHeight)?200:t.markerHeight,Kr(t.markerPath)){i=io(t.markerPath);for(var g=t.markerPath,A=0;A<i.length;A++)t.markerPath=i[A],l.push([Oo(t),s,a]);t.markerPath=g}else l.push([Oo(t),s,a])}return l}function Ro(t){if(!t)return null;var e=t;if(n)return e;for(var i,o=Bn,s=0,a=o.length;s<a;s++)(i=e[o[s]])&&(e[o[s]]=Lo(i));return e}function Lo(t){if(Kr(t)&&t.stops){for(var e=t.stops,n=0;n<e.length;n++)e[n][1]=Lo(e[n][1]);return t}return"url("===t.slice(0,4)&&(t=rn(t)),t}function Fo(t){return t&&Gt.decodeImageInWorker&&t instanceof ImageBitmap}function Ho(t){return t&&t.colorStops}function Bo(t){var e=[t.type];if(t.places&&e.push(t.places.join()),t.colorStops){for(var n=[],i=t.colorStops.length-1;i>=0;i--)n.push(t.colorStops[i].join());e.push(n.join(","))}return e.join("_")}function zo(t,e){if(!t)return 1;var n=[];if(Array.isArray(t)){for(var i=0;i<t.length;i++)n.push(zo(t[i],e));return n.sort().join(",")}var o=Object.keys(t).sort().reduce((function(n,i){return e&&0!==i.indexOf(e)||(n[i]=t[i]),n}),{});return vi(JSON.stringify(o))}function Go(t,e){function n(t,e){h(t.opacity)?t.opacity=e:t.opacity*=e}var i;if(Array.isArray(t)){i=[];for(var o=0;o<t.length;o++){var s=l({},t[o]);n(s,e),i.push(s)}}else n(i=l({},t),e);return i}function jo(...t){var e=t[0],n=Array.prototype.slice.call(t,1);if(n&&n.length||(n=[{}]),Array.isArray(e)){for(var i,o,s=[],a=0,c=e.length;a<c;a++){i=e[a],o={};for(var u=0,f=n.length;u<f;u++)Array.isArray(n[u])?h(n[u][a])?l(o,i||{}):l(o,i,n[u][a]):l(o,i,n[u]?n[u]:{});s.push(o)}return s}var g=[{},e];return g.push.apply(g,n),l.apply(this,g)}function Uo(t){if(t.symbol&&(t=[t]),Array.isArray(t))return t;var e=t.$root,n=t.$iconset;if(t=t.style,e||n){e&&"/"===e[e.length-1]&&(e=e.substring(0,e.length-1)),n&&"/"===n[n.length-1]&&(n=n.substring(0,n.length-1));Vo(t,(function(t){return"{$root}"===t?e:"{$iconset}"===t?n:null}))}return t}function Vo(t,e){for(var n=0;n<t.length;n++){var{symbol:i}=t[n];i&&Zo(i,e)}}var Wo=/(\{\$root\}|\{\$iconset\})/g;function Zo(t,e){for(var n in t)t.hasOwnProperty(n)&&"textName"!==n&&(g(t[n])&&t[n].length>2?t[n]=t[n].replace(Wo,e):Kr(t[n])?t[n]=qo(t[n],e):f(t[n])&&Zo(t[n],e))}function qo(t,e){var n=t.default;g(n)&&(t.default=n.replace(Wo,e));var i=t.stops;if(!i)return t;for(var o=0;o<i.length;o++)Array.isArray(i[o])&&(g(i[o][1])?i[o][1]=i[o][1].replace(Wo,e):Kr(i[o][1])&&(i[o][1]=qo(i[o][1],e)));return t}function Xo(t=[]){Array.isArray(t)||(t=[t]);for(var e=t.length,n=0;n<e;n++){var i=t[n];if(i.style){var{lineDasharray:o,lineWidth:s}=i.style;if(s&&c(s)&&s>0&&o&&Array.isArray(o)&&o.length)return!0}}return!1}function Yo(t,e,n,i,o){var s=1/Math.tan(e/2),a=1/(i-o);return t[0]=s/n,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=s,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=(o+i)*a,t[11]=-1,t[12]=0,t[13]=0,t[14]=2*o*i*a,t[15]=0,t}function Ko(t,e,n){var i,o,s,a,l,h,c,u,f,g,A,m,w=n[0],T=n[1],M=n[2];return e===t?(t[12]=e[0]*w+e[4]*T+e[8]*M+e[12],t[13]=e[1]*w+e[5]*T+e[9]*M+e[13],t[14]=e[2]*w+e[6]*T+e[10]*M+e[14],t[15]=e[3]*w+e[7]*T+e[11]*M+e[15]):(o=e[1],s=e[2],a=e[3],l=e[4],h=e[5],c=e[6],u=e[7],f=e[8],g=e[9],A=e[10],m=e[11],t[0]=i=e[0],t[1]=o,t[2]=s,t[3]=a,t[4]=l,t[5]=h,t[6]=c,t[7]=u,t[8]=f,t[9]=g,t[10]=A,t[11]=m,t[12]=i*w+l*T+f*M+e[12],t[13]=o*w+h*T+g*M+e[13],t[14]=s*w+c*T+A*M+e[14],t[15]=a*w+u*T+m*M+e[15]),t}function $o(t,e,n){var i=n[0],o=n[1],s=n[2];return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t[4]=e[4]*o,t[5]=e[5]*o,t[6]=e[6]*o,t[7]=e[7]*o,t[8]=e[8]*s,t[9]=e[9]*s,t[10]=e[10]*s,t[11]=e[11]*s,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function es(t,e,n){var i=Math.sin(n),o=Math.cos(n),s=e[4],a=e[5],l=e[6],h=e[7],c=e[8],u=e[9],f=e[10],g=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=s*o+c*i,t[5]=a*o+u*i,t[6]=l*o+f*i,t[7]=h*o+g*i,t[8]=c*o-s*i,t[9]=u*o-a*i,t[10]=f*o-l*i,t[11]=g*o-h*i,t}function ns(t,e,n){var i=Math.sin(n),o=Math.cos(n),s=e[0],a=e[1],l=e[2],h=e[3],c=e[4],u=e[5],f=e[6],g=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=s*o+c*i,t[1]=a*o+u*i,t[2]=l*o+f*i,t[3]=h*o+g*i,t[4]=c*o-s*i,t[5]=u*o-a*i,t[6]=f*o-l*i,t[7]=g*o-h*i,t}function rs(t,e,n){var i=e[0],o=e[1],s=e[2],a=e[3],l=e[4],h=e[5],c=e[6],u=e[7],f=e[8],g=e[9],A=e[10],m=e[11],w=e[12],T=e[13],M=e[14],C=e[15],P=n[0],I=n[1],O=n[2],E=n[3];return t[0]=P*i+I*l+O*f+E*w,t[1]=P*o+I*h+O*g+E*T,t[2]=P*s+I*c+O*A+E*M,t[3]=P*a+I*u+O*m+E*C,t[4]=(P=n[4])*i+(I=n[5])*l+(O=n[6])*f+(E=n[7])*w,t[5]=P*o+I*h+O*g+E*T,t[6]=P*s+I*c+O*A+E*M,t[7]=P*a+I*u+O*m+E*C,t[8]=(P=n[8])*i+(I=n[9])*l+(O=n[10])*f+(E=n[11])*w,t[9]=P*o+I*h+O*g+E*T,t[10]=P*s+I*c+O*A+E*M,t[11]=P*a+I*u+O*m+E*C,t[12]=(P=n[12])*i+(I=n[13])*l+(O=n[14])*f+(E=n[15])*w,t[13]=P*o+I*h+O*g+E*T,t[14]=P*s+I*c+O*A+E*M,t[15]=P*a+I*u+O*m+E*C,t}function os(t,e){var n=e[0],i=e[1],o=e[2],s=e[3],a=e[4],l=e[5],h=e[6],c=e[7],u=e[8],f=e[9],g=e[10],A=e[11],m=e[12],w=e[13],T=e[14],M=e[15],C=n*l-i*a,P=n*h-o*a,I=n*c-s*a,O=i*h-o*l,E=i*c-s*l,D=o*c-s*h,N=u*w-f*m,H=u*T-g*m,U=u*M-A*m,W=f*T-g*w,q=f*M-A*w,X=g*M-A*T,J=C*X-P*q+I*W+O*U-E*H+D*N;return J?(t[0]=(l*X-h*q+c*W)*(J=1/J),t[1]=(o*q-i*X-s*W)*J,t[2]=(w*D-T*E+M*O)*J,t[3]=(g*E-f*D-A*O)*J,t[4]=(h*U-a*X-c*H)*J,t[5]=(n*X-o*U+s*H)*J,t[6]=(T*I-m*D-M*P)*J,t[7]=(u*D-g*I+A*P)*J,t[8]=(a*q-l*U+c*N)*J,t[9]=(i*U-n*q-s*N)*J,t[10]=(m*E-w*I+M*C)*J,t[11]=(f*I-u*E-A*C)*J,t[12]=(l*H-a*W-h*N)*J,t[13]=(n*W-i*H+o*N)*J,t[14]=(w*P-m*O-T*C)*J,t[15]=(u*O-f*P+g*C)*J,t):null}function as(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function ls(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}var hs=Object.freeze({__proto__:null,DEFAULT_FONT:pi,DEFAULT_TEXTSIZE:Ai,EMPTY_STRING:Jn,GUID:Me,IS_NODE:n,UID:we,_defaults:function(t,e){for(var n=Object.getOwnPropertyNames(e),i=0;i<n.length;i++){var o=n[i],s=Object.getOwnPropertyDescriptor(e,o);s&&s.configurable&&void 0===t[o]&&Object.defineProperty(t,o,s)}return t},b64toBlob:pn,btoa:un,calCanvasSize:Dn,get cancelAnimFrame(){return me},checkMTKVersion:o,clamp:qe,computeDegree:yn,convertResourceUrl:Ro,convertStylePath:Vo,copy:ls,describeText:di,emptyImageUrl:vn,equalMapView:xn,escapeSpecialChars:ei,extend:l,extendSymbol:jo,extractCssUrl:rn,flash:Mn,forEachCoord:Fe,getAbsoluteURL:En,getAlignPoint:gi,getExternalResources:Eo,getFont:yi,getGlobalThis:i,getGradientStamp:Bo,getImageBitMap:On,getMarkerPathBase64:Oo,getPointsResultPts:Pn,getSymbolHash:zo,getSymbolStamp:function(t,e){return zo(t,e)},getValueOrDefault:He,hasOwn:w,hashCode:vi,identity:as,interpolate:Ue,invert:os,isArrayHasData:Je,isCssUrl:nn,isDashLine:Xo,isEmpty:function(t){var e;for(e in t)return!1;return!e},isFunction:A,isGradient:Ho,isImageBitMap:Fo,isInteger:u,isNil:h,isNoContentHttpCode:function(t){return 204===t||t>=400&&t<500||501===t},isNumber:c,isObject:f,isSVG:ve,isString:g,isURL:Ye,join:function(t,e){return t.join?t.join(e||","):Array.prototype.join.call(t,e||",")},loadImage:xe,log2:function(t){if(Math.log2)return Math.log2(t);var e=Math.log(t)*Math.LOG2E,n=Math.round(e);return Math.abs(n-e)<1e-14?n:e},lowerSymbolOpacity:Go,mergeArray:Re,multiply:rs,now:a,parseJSON:Ee,parseStyleRootPath:Uo,parseSymbolPath:Zo,perspective:Yo,pushIn:ke,removeFromArray:Le,replaceAll:Kn,replaceVariable:fi,get requestAnimFrame(){return Ae},rotateX:es,rotateZ:ns,scale:$o,sign:Ge,splitContent:ci,splitTextToRow:_i,splitWords:ri,stringLength:li,stringWidth:ai,toDegree:C,toRadian:M,translate:Ko,translateToSVGStyles:Io,trim:Yn,wrap:We});"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function cs(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var us=fs;function fs(t,e,n){var i,o,s,a,l,h=t.length,c=As(t[0],e),u=[];for(n||(n=[]),i=1;i<h;i++){for(o=t[i-1],a=l=As(s=t[i],e);;){if(!(c|a)){u.push(o),a!==l?(u.push(s),i<h-1&&(n.push(u),u=[])):i===h-1&&u.push(s);break}if(c&a)break;c?c=As(o=ps(o,s,c,e),e):a=As(s=ps(o,s,a,e),e)}c=l}return u.length&&n.push(u),n}function ps(t,e,n,i){return 8&n?[t[0]+(e[0]-t[0])*(i[3]-t[1])/(e[1]-t[1]),i[3]]:4&n?[t[0]+(e[0]-t[0])*(i[1]-t[1])/(e[1]-t[1]),i[1]]:2&n?[i[2],t[1]+(e[1]-t[1])*(i[2]-t[0])/(e[0]-t[0])]:1&n?[i[0],t[1]+(e[1]-t[1])*(i[0]-t[0])/(e[0]-t[0])]:null}function As(t,e){var n=0;return t[0]<e[0]?n|=1:t[0]>e[2]&&(n|=2),t[1]<e[1]?n|=4:t[1]>e[3]&&(n|=8),n}fs.polyline=fs,fs.polygon=function(t,e){var n,i,o,s,a,l,h;for(i=1;i<=8;i*=2){for(n=[],s=!(As(o=t[t.length-1],e)&i),a=0;a<t.length;a++)(h=!(As(l=t[a],e)&i))!==s&&n.push(ps(o,l,i,e)),h&&n.push(l),o=l,s=h;if(!(t=n).length)break}return n};var ms=cs(us),ys=1/0,_s=1/0,vs=-1/0,bs=-1/0;function ws(){return[ys,_s,vs,bs]}var Cs=ws();function Ss(t){t[0]=ys,t[1]=_s,t[2]=vs,t[3]=bs}function Ps(t,e){if(t)if(Array.isArray(t[0]))for(var n=0,i=t.length;n<i;n++)Ps(t[n],e);else if(Array.isArray(t))for(var o=0,s=t.length;o<s;o++){var{x:a,y:l}=t[o];e[0]=Math.min(a,e[0]),e[1]=Math.min(l,e[1]),e[2]=Math.max(a,e[2]),e[3]=Math.max(l,e[3])}else{var{x:h,y:c}=t;e[0]=Math.min(h,e[0]),e[1]=Math.min(c,e[1]),e[2]=Math.max(h,e[2]),e[3]=Math.max(c,e[3])}}function Is(t,e,n,i,o){(0===e||e)&&(Array.isArray(e)&&(n=e[1],i=e[2],o=e[3],e=e[0]),t[0]=Math.min(e,t[0]),t[1]=Math.min(n,t[1]),t[2]=Math.max(i,t[2]),t[3]=Math.max(o,t[3]))}function Os(t){return t&&t[0]!==1/0&&void 0!==t[0]}function Es(t,e=0){t[0]-=e,t[1]-=e,t[2]+=e,t[3]+=e}function ks(t,e){return!(t[2]<e[0])&&(!(t[1]>e[3])&&(!(t[0]>e[2])&&!(t[3]<e[1])))}function Rs(t,e){var[n,i,o,s]=t;return n>=e[0]&&o<=e[2]&&i>=e[1]&&s<=e[3]}function Ls(t,e){var n=e.bbox;if(!n)return console.error("maskGeoJSON bbox is null:",e),!1;if(ks(n,t)){var i=e.geometry;if(!i)return console.error("maskGeoJSON is error,not find geometry.",e),!1;var{coordinates:o}=i;"Polygon"===i.type&&(o=[o]);for(var s=0,a=o.length;s<a;s++){var l=ms.polygon(o[s][0],t);if(l.length>0){for(var h=1/0,c=-1/0,u=1/0,f=-1/0,g=0,A=l.length;g<A;g++){var[m,w]=l[g];h=Math.min(m,h),u=Math.min(w,u),c=Math.max(m,c),f=Math.max(w,f)}if(h!==c&&u!==f)return!0}}return!1}return!1}var Ds=Object.freeze({__proto__:null,BBOX_TEMP:Cs,bboxInBBOX:Rs,bboxInMask:Ls,bboxIntersect:ks,bufferBBOX:Es,getDefaultBBOX:ws,pointsBBOX:Ps,resetBBOX:Ss,setBBOX:Is,validateBBOX:Os}),Fs=function(){function t(){this.resources=new Map,this._errors=new Map}var e=t.prototype;return e.addResource=function(t,e){var n=this,i=this._getImgUrl(t);if(this.resources.set(i,{image:e,width:+t[1],height:+t[2],refCnt:0}),e&&e.width&&e.height&&!e.close&&Gt.imageBitMap&&!Gt.safari&&!Gt.iosWeixin){if(e.src&&ve(e.src))return;createImageBitmap(e).then((function(t){n.resources.has(i)&&(n.resources.get(i).image=t)}))}},e.isResourceLoaded=function(t,e){if(!t)return!1;var n=this._getImgUrl(t);if(this._errors.has(n))return!0;var i=this.resources.get(n);return!!i&&!(e&&ve(t[0])&&(+t[1]>i.width||+t[2]>i.height))},e.login=function(t){var e=this.resources.get(t);e&&e.refCnt++},e.logout=function(t){var e=this.resources.get(t);e&&e.refCnt--<=0&&(e.image&&e.image.close&&e.image.close(),this.resources.delete(t))},e.getImage=function(t){var e=this._getImgUrl(t);return!this.isResourceLoaded(t)||this._errors.has(e)?null:this.resources.get(e).image},e.markErrorResource=function(t){var e=this._getImgUrl(t);this._errors.set(e,1)},e.merge=function(t){var e=this;if(!t)return this;var n=t.resources;return n&&n.forEach((function(t,n){e.addResource([n,t.width,t.height],t.image)})),this},e.forEach=function(t){return this.resources?(this.resources.forEach((function(e,n){t(n,e)})),this):this},e._getImgUrl=function(t){return Fo(t)?t:Array.isArray(t)?t[0]:t},e.remove=function(){return this.resources?(this.resources.forEach((function(t){t&&t.image&&t.image.close&&t.image.close()})),this.resources.clear(),this):this},t}(),Ns=function(){function t(){this.resources={},this._errors={}}var e=t.prototype;return e.addResource=function(t,e){var n=this;if(this.resources[t[0]]={image:e,width:+t[1],height:+t[2],refCnt:0},e&&e.width&&e.height&&!e.close&&Gt.imageBitMap&&!Gt.safari&&!Gt.iosWeixin){if(e.src&&ve(e.src))return;createImageBitmap(e).then((function(e){n.resources[t[0]]&&(n.resources[t[0]].image=e)}))}},e.isResourceLoaded=function(t,e){if(!t)return!1;var n=this._getImgUrl(t);if(this._errors[n])return!0;var i=this.resources[n];return!!i&&!(e&&ve(t[0])&&(+t[1]>i.width||+t[2]>i.height))},e.login=function(t){var e=this.resources[t];e&&e.refCnt++},e.logout=function(t){var e=this.resources[t];e&&e.refCnt--<=0&&(e.image&&e.image.close&&e.image.close(),delete this.resources[t])},e.getImage=function(t){var e=this._getImgUrl(t);return!this.isResourceLoaded(t)||this._errors[e]?null:this.resources[e].image},e.markErrorResource=function(t){this._errors[this._getImgUrl(t)]=1},e.merge=function(t){if(!t)return this;for(var e in t.resources){var n=t.resources[e];this.addResource([e,n.width,n.height],n.image)}return this},e.forEach=function(t){if(!this.resources)return this;for(var e in this.resources)w(this.resources,e)&&t(e,this.resources[e]);return this},e._getImgUrl=function(t){return Array.isArray(t)?t[0]:t},e.remove=function(){for(var t in this.resources){var e=this.resources[t];e&&e.image&&e.image.close&&e.image.close()}this.resources={}},t}();function zs(){return Gt.decodeImageInWorker?new Fs:new Ns}function Gs(t,e,n,i){return t[0]=e,t[1]=n,t[2]=i,t}function Us(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t}function Ws(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t}function Xs(t,e,n){return Ws(t,e,n)}function Qs(t){var e=t[0],n=t[1],i=t[2];return Math.sqrt(e*e+n*n+i*i)}function Ys(t,e){var n=e[0],i=e[1],o=e[2],s=n*n+i*i+o*o;return s>0&&(s=1/Math.sqrt(s),t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s),t}function Ks(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function $s(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}function ta(t,e,n){var i=e[0],o=e[1],s=e[2],a=n[0],l=n[1],h=n[2];return t[0]=o*h-s*l,t[1]=s*a-i*h,t[2]=i*l-o*a,t}function ea(t,e){var n=e[0]-t[0],i=e[1]-t[1],o=e[2]-t[2];return Math.hypot?Math.hypot(n,i,o):function(...t){var e=0,n=t.length;for(;n--;)e+=t[n]*t[n];return Math.sqrt(e)}(n,i,o)}function na(t,e){Ys(t,t),Ys(e,e);var n=Ks(t,e);return n>1?0:n<-1?Math.PI:Math.acos(n)}var ia,ra=function(){function t(t,e){this.normal=t,this.constant=e}return t.prototype.distanceToPoint=function(t){return Ks(this.normal,t)+this.constant},t}(),oa=[0,0,0],sa=[0,0,0],aa=[0,0,0],la=[0,0,0],ha=[0,0,0],ca=new ra([0,0,1],0),ua=function(){function t(t,e){this.setFromTo(t,e)}var e=t.prototype;return e.setFromTo=function(t,e){this.origin=t;var n=this.direction||[0,0,0];this.direction=Ys(n,Xs(n,e,t))},e.distanceToPlane=function(t){var e=Ks(t.normal,this.direction);if(0===e)return 0===t.distanceToPoint(this.origin)?0:null;var n=-(Ks(this.origin,t.normal)+t.constant)/e;return n>=0?n:null},e.intersectGround=function(t){return this.intersectPlane(ca,t)},e.distanceToGround=function(){return this.distanceToPlane(ca)},e.intersectPlane=function(t,e){var n=this.distanceToPlane(t);return null===n?null:this.at(n,e)},e.intersectBox=function(t,e){var n,i,o,s,a,l,h=1/this.direction[0],c=1/this.direction[1],u=1/this.direction[2],f=this.origin;return h>=0?(n=(t[0][0]-f[0])*h,i=(t[1][0]-f[0])*h):(n=(t[1][0]-f[0])*h,i=(t[0][0]-f[0])*h),c>=0?(o=(t[0][1]-f[1])*c,s=(t[1][1]-f[1])*c):(o=(t[1][1]-f[1])*c,s=(t[0][1]-f[1])*c),n>s||o>i?null:((o>n||isNaN(n))&&(n=o),(s<i||isNaN(i))&&(i=s),u>=0?(a=(t[0][2]-f[2])*u,l=(t[1][2]-f[2])*u):(a=(t[1][2]-f[2])*u,l=(t[0][2]-f[2])*u),n>l||a>i?null:((a>n||n!=n)&&(n=a),(l<i||i!=i)&&(i=l),i<0?null:this.at(n>=0?n:i,e)))},e.intersectTriangle=function(t,e,n,i,o){Xs(sa,e,t),Xs(aa,n,t),ta(la,sa,aa);var s,a=Ks(this.direction,la);if(a>0){if(i)return null;s=1}else{if(!(a<0))return null;s=-1,a=-a}Xs(ha,this.origin,t),ta(aa,ha,aa);var l=s*Ks(this.direction,aa);if(l<0)return null;ta(sa,sa,ha);var h=s*Ks(this.direction,sa);if(h<0)return null;if(l+h>a)return null;var c=-s*Ks(ha,la);return c<0?null:this.at(c/a,o)},e.at=function(t,e){return function(t,e){t[0]=e[0],t[1]=e[1],t[2]=e[2]}(e,this.origin),Us(e,e,$s(oa,this.direction,t))},t}(),fa=Object.freeze({__proto__:null,Plane:ra,Ray:ua}),da="core-fetch-image";var pa=!1;var Aa=[];function ma(t){return Aa.indexOf(t)>-1}function ya(t){ma(t)||Aa.push(t)}var _a={};function va(t,e){_a[t]=e}var xa,ba="\n    var adapters = {};\n    // Dynamic Create Adapter\n    function createAdapter(key,code){\n        if(adapters[key]||!code){\n            return;\n        }\n        var func=new Function('exports',code+'(exports)');\n        var workerExports={};\n        func(workerExports,self);\n        adapters[key]=workerExports;\n        workerExports.initialize && workerExports.initialize(self);\n\n    }\n    onmessage = function (msg) {\n        msg = msg.data;\n        //createAdapter\n        if (msg.messageType === 'createAdapter') {\n           var key=msg.key;\n           var code=msg.code;\n           createAdapter(key,code);\n           postMessage({adapterName:key});\n           return;\n        }\n        // postMessage when main thread idle\n        if(msg.messageType==='idle'){\n            var messageRatio = msg.messageRatio;\n            handleMessageQueue(messageRatio);\n            return;\n        }\n        if (msg.messageType === 'batch') {\n            const messages = msg.messages;\n            if (messages) {\n                for (let i = 0; i < messages.length; i++) {\n                    dispatch(messages[i]);\n                }\n            }\n        } else {\n            dispatch(msg);\n        }\n    };\n\n    function dispatch(msg) {\n        var workerKey = msg.workerKey;\n        var adapter = adapters[workerKey];\n        if (!adapter) {\n            post(msg.callback, 'Unregistered worker adapters for ' + workerKey);\n            return;\n        }\n        try {\n            adapter.onmessage(msg, wrap(msg.callback));\n        } catch (err) {\n            post(msg.callback, workerKey + ':' + err.message);\n            console.error(err);\n            throw err;\n        }\n    }\n\n    var messageResultQueue = [];\n\n    function handleMessageQueue(messageRatio){\n       if(messageResultQueue.length===0){\n          return;\n       }\n       var count = Math.ceil((messageRatio || 1) * messageResultQueue.length);\n       var queues = messageResultQueue.slice(0, count);\n       queues.forEach(function(queue){\n          post(queue.callback,queue.err,queue.data,queue.buffers);\n       });\n       messageResultQueue=messageResultQueue.slice(count, Infinity);\n    }\n\n    function post(callback, err, data, buffers) {\n        var msg = {\n            callback : callback\n        };\n        if (err) {\n            msg.error = err;\n        } else {\n            msg.data = data;\n        }\n        if (buffers && buffers.length > 0) {\n            postMessage(msg, buffers);\n        } else {\n            postMessage(msg);\n        }\n    }\n\n    function joinQueue(callback,err,data,buffers){\n        messageResultQueue.push({\n            callback:callback,\n            err:err,\n            data:data,\n            buffers:buffers\n        });\n    }\n\n    function wrap(callback) {\n        return function (err, data, buffers) {\n            joinQueue(callback, err, data, buffers);\n        };\n    }\n    var workerExports;\n",wa="\n    workerExports = null;\n";function Ta(){if("undefined"==typeof window)return null;if(!xa){var t=function(){var t=ba;for(var e in _a){var n=_a[e];ya(e),A(n)&&0===n.length&&(n=n()),t+="\n    workerExports = {};\n    ("+n+")(workerExports, self);\n    adapters['"+e+"'] = workerExports",t+="\n    workerExports.initialize && workerExports.initialize(self);\n        "}return t+wa}();xa=window.URL.createObjectURL(new Blob([t],{type:"text/javascript"})),_a={}}return xa}function Ca(t,e){if(_a[t]){var n=_a[t];A(n)&&0===n.length&&(n=n()),n="("+n+")";if(ia){var i=ia.workers||[];0===i.length&&console.error("workerpool workers count is 0");var o=0,s=function(n){(n=n.data||{}).adapterName===t&&++o===i.length&&(i.forEach((function(t){t.removeEventListener("message",s)})),delete _a[t],e())};i.forEach((function(e){e.addEventListener("message",s),e.postMessage({key:t,code:n,messageType:"createAdapter"})}))}}else console.error("not find "+t+" adapter")}var Sa,Pa="undefined"!=typeof window?window.navigator.hardwareConcurrency||4:0,Oa=Math.max(Math.floor(Pa/2),1),Ea=function(){function t(t=50){this._limit=t,this._messages=[],this.buffers=[]}var e=t.prototype;return e.addMessage=function(t,e){if(this._messages.push(t),Array.isArray(e))for(var n=0;n<e.length;n++)this.buffers.indexOf(e[n])<0&&this.buffers.push(e[n])},e.isFull=function(){return this._messages.length>=this._limit},e.getMessage=function(){return{messageType:"batch",messages:this._messages}},t}(),ka=function(){function t(){this.active={},this.workerCount="undefined"!=typeof window?s.workerCount||Oa:0,this._messages=[],this._messageBuffers=[]}var e=t.prototype;return e.acquire=function(t){if(!this.workers){this.workers=[];for(var e=Ta(),n=0;n<this.workerCount;n++){var i=new Worker(e);i.id=n,this.workers.push(i)}URL.revokeObjectURL(e),pa=!0}return this.active[t]=!0,this.workers.slice()},e.release=function(t){delete this.active[t],0===Object.keys(this.active).length&&(this.workers.forEach((function(t){t.terminate()})),this.workers=null)},e.addMessage=function(t,e,n){var i=this._messages[t];i&&i.length||(i=this._messages[t]=[new Ea]);var o=i[i.length-1];o.isFull()&&(o=new Ea,this._messages[t].push(o)),o.addMessage(e,n)},e.commit=function(){if(this.workers&&this._messages.length)for(var t=0;t<this._messages.length;t++)if(this._messages[t]&&this._messages[t].length){var e=this._messages[t].shift();this.workers[t].postMessage(e.getMessage(),e.buffers)}},e.getWorkers=function(){return this.workers||[]},e.broadcastIdleMessage=function(t){return this.getWorkers().forEach((function(e){e.postMessage({messageType:"idle",messageRatio:t})})),this},t}();function La(){return Sa||(Sa=new ka,ia=Sa),Sa}var Da=[],Na=[];function Ha(t){return Wa(),new Promise((function(e,n){if(t)if(A(t)&&(t={count:1,run:t}),t.run)if(h(t.count)&&(t.count=1),t.count=Math.ceil(t.count),c(t.count)){var i=t;i.results=[],Da.push(i),i.resolve=e}else n(new Error("task.count is not number"));else n(new Error("task.run is null"));else n(new Error("task is null"))}))}function Ba(t){var e=s.messagePostRatioPerWorker*(t?.5:1);La().commit(),La().broadcastIdleMessage(e),function(){if(0!==Da.length){for(var t=[],e=[],n=Da.length,i=0;i<n;i++){var o=Da[i];if(o.count--,-1===o.count)e.push(o);else{t.push(o);var s=o.run();o.results.push(s)}}Da=t,n=e.length;for(var a=0;a<n;a++){var l=e[a];l.resolve&&l.resolve(l.results)}}}(),Na.forEach((function(t){t()}))}var za=a();function Ga(){Ba(),za=a(),requestIdleCallback(Ga)}function ja(){if(Gt.requestIdleCallback){var{idleForceTimeThreshold:t,idleLog:e}=s;a()-za>t&&(Ba(!0),za=a(),e&&console.warn("did not apply for availability, forced run idle"))}else Ba();Ae(ja)}var Ua=!1;function Wa(){Ua||(Ua=!0,Gt.requestIdleCallback&&requestIdleCallback(Ga),Ae(ja))}function Za(t){Na.indexOf(t)>-1||A(t)&&Na.push(t)}var qa=Object.freeze({__proto__:null,pushLoopHook:Za,runTaskAsync:Ha,startTasks:Wa}),Xa=function(){function t(t,e){this.max=t,this.onRemove=e||function(){},this.reset()}var e=t.prototype;return e.reset=function(){if(this.data)for(var t,e=oe(this.data.values());!(t=e()).done;){this.onRemove(t.value)}return this.data=new Map,this},e.clear=function(){this.reset(),delete this.onRemove},e.add=function(t,e){return e?(this.has(t)?(this.data.delete(t),this.data.set(t,e)):this.data.set(t,e),this):this},e.keys=function(){for(var t,e=new Array(this.data.size),n=0,i=oe(this.data.keys());!(t=i()).done;){e[n++]=t.value}return e},e.shrink=function(){for(var t=this.data.keys(),e=t.next();this.data.size>this.max;){var n=this.getAndRemove(e.value);n&&this.onRemove(n),e=t.next()}},e.has=function(t){return this.data.has(t)},e.getAndRemove=function(t){if(!this.has(t))return null;var e=this.data.get(t);return this.data.delete(t),e},e.get=function(t){return this.has(t)?this.data.get(t):null},e.remove=function(t){if(!this.has(t))return this;var e=this.data.get(t);return this.data.delete(t),this.onRemove(e),this},e.setMaxSize=function(t){return this.max=t,this.data.size>this.max&&this.shrink(),this},t}(),Ja={exports:{}},Qa={exports:{}};!function(t,e){t.exports=function(){function t(t,n,o,s,a){e(t,n,o||0,s||t.length-1,a||i)}function e(t,i,o,s,a){for(;s>o;){if(s-o>600){var l=s-o+1,h=i-o+1,c=Math.log(l),u=.5*Math.exp(2*c/3),f=.5*Math.sqrt(c*u*(l-u)/l)*(h-l/2<0?-1:1);e(t,i,Math.max(o,Math.floor(i-h*u/l+f)),Math.min(s,Math.floor(i+(l-h)*u/l+f)),a)}var g=t[i],A=o,m=s;for(n(t,o,i),a(t[s],g)>0&&n(t,o,s);A<m;){for(n(t,A,m),A++,m--;a(t[A],g)<0;)A++;for(;a(t[m],g)>0;)m--}0===a(t[o],g)?n(t,o,m):n(t,++m,s),m<=i&&(o=m+1),i<=m&&(s=m-1)}}function n(t,e,n){var i=t[e];t[e]=t[n],t[n]=i}function i(t,e){return t<e?-1:t>e?1:0}return t}()}(Qa);var Ya=Qa.exports;Ja.exports=el,Ja.exports.default=el;var $a=Ya;function el(t,e){if(!(this instanceof el))return new el(t,e);this._maxEntries=Math.max(4,t||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),e&&this._initFormat(e),this.clear()}function nl(t,e,n){if(!n)return e.indexOf(t);for(var i=0;i<e.length;i++)if(n(t,e[i]))return i;return-1}function il(t,e){rl(t,0,t.children.length,e,t)}function rl(t,e,n,i,o){o||(o=gl(null)),o.minX=1/0,o.minY=1/0,o.maxX=-1/0,o.maxY=-1/0;for(var s,a=e;a<n;a++)s=t.children[a],ol(o,t.leaf?i(s):s);return o}function ol(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function sl(t,e){return t.minX-e.minX}function al(t,e){return t.minY-e.minY}function ll(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function hl(t){return t.maxX-t.minX+(t.maxY-t.minY)}function cl(t,e){return(Math.max(e.maxX,t.maxX)-Math.min(e.minX,t.minX))*(Math.max(e.maxY,t.maxY)-Math.min(e.minY,t.minY))}function ul(t,e){var n=Math.max(t.minX,e.minX),i=Math.max(t.minY,e.minY),o=Math.min(t.maxX,e.maxX),s=Math.min(t.maxY,e.maxY);return Math.max(0,o-n)*Math.max(0,s-i)}function fl(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function dl(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function gl(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function pl(t,e,n,i,o){for(var s,a=[e,n];a.length;)(n=a.pop())-(e=a.pop())<=i||(s=e+Math.ceil((n-e)/i/2)*i,$a(t,s,e,n,o),a.push(e,s,s,n))}el.prototype={all:function(){return this._all(this.data,[])},search:function(t){var e=this.data,n=[],i=this.toBBox;if(!dl(t,e))return n;for(var o,s,a,l,h=[];e;){for(o=0,s=e.children.length;o<s;o++)a=e.children[o],dl(t,l=e.leaf?i(a):a)&&(e.leaf?n.push(a):fl(t,l)?this._all(a,n):h.push(a));e=h.pop()}return n},collides:function(t){var e=this.data,n=this.toBBox;if(!dl(t,e))return!1;for(var i,o,s,a,l=[];e;){for(i=0,o=e.children.length;i<o;i++)if(s=e.children[i],dl(t,a=e.leaf?n(s):s)){if(e.leaf||fl(t,a))return!0;l.push(s)}e=l.pop()}return!1},load:function(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(var e=0,n=t.length;e<n;e++)this.insert(t[e]);return this}var i=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===i.height)this._splitRoot(this.data,i);else{if(this.data.height<i.height){var o=this.data;this.data=i,i=o}this._insert(i,this.data.height-i.height-1,!0)}else this.data=i;return this},insert:function(t){return t&&this._insert(t,this.data.height-1),this},clear:function(){return this.data=gl([]),this},remove:function(t,e){if(!t)return this;for(var n,i,o,s,a=this.data,l=this.toBBox(t),h=[],c=[];a||h.length;){if(a||(a=h.pop(),i=h[h.length-1],n=c.pop(),s=!0),a.leaf&&-1!==(o=nl(t,a.children,e)))return a.children.splice(o,1),h.push(a),this._condense(h),this;s||a.leaf||!fl(a,l)?i?(n++,a=i.children[n],s=!1):a=null:(h.push(a),c.push(n),n=0,i=a,a=a.children[0])}return this},toBBox:function(t){return t},compareMinX:sl,compareMinY:al,toJSON:function(){return this.data},fromJSON:function(t){return this.data=t,this},_all:function(t,e){for(var n=[];t;)t.leaf?e.push.apply(e,t.children):n.push.apply(n,t.children),t=n.pop();return e},_build:function(t,e,n,i){var o,s=n-e+1,a=this._maxEntries;if(s<=a)return il(o=gl(t.slice(e,n+1)),this.toBBox),o;i||(i=Math.ceil(Math.log(s)/Math.log(a)),a=Math.ceil(s/Math.pow(a,i-1))),(o=gl([])).leaf=!1,o.height=i;var l,h,c,u,f=Math.ceil(s/a),g=f*Math.ceil(Math.sqrt(a));for(pl(t,e,n,g,this.compareMinX),l=e;l<=n;l+=g)for(pl(t,l,c=Math.min(l+g-1,n),f,this.compareMinY),h=l;h<=c;h+=f)u=Math.min(h+f-1,c),o.children.push(this._build(t,h,u,i-1));return il(o,this.toBBox),o},_chooseSubtree:function(t,e,n,i){for(var o,s,a,l,h,c,u,f;i.push(e),!e.leaf&&i.length-1!==n;){for(u=f=1/0,o=0,s=e.children.length;o<s;o++)h=ll(a=e.children[o]),(c=cl(t,a)-h)<f?(f=c,u=h<u?h:u,l=a):c===f&&h<u&&(u=h,l=a);e=l||e.children[0]}return e},_insert:function(t,e,n){var i=n?t:(0,this.toBBox)(t),o=[],s=this._chooseSubtree(i,this.data,e,o);for(s.children.push(t),ol(s,i);e>=0&&o[e].children.length>this._maxEntries;)this._split(o,e),e--;this._adjustParentBBoxes(i,o,e)},_split:function(t,e){var n=t[e],i=n.children.length,o=this._minEntries;this._chooseSplitAxis(n,o,i);var s=this._chooseSplitIndex(n,o,i),a=gl(n.children.splice(s,n.children.length-s));a.height=n.height,a.leaf=n.leaf,il(n,this.toBBox),il(a,this.toBBox),e?t[e-1].children.push(a):this._splitRoot(n,a)},_splitRoot:function(t,e){this.data=gl([t,e]),this.data.height=t.height+1,this.data.leaf=!1,il(this.data,this.toBBox)},_chooseSplitIndex:function(t,e,n){var i,o,s,a,l,h,c,u;for(h=c=1/0,i=e;i<=n-e;i++)a=ul(o=rl(t,0,i,this.toBBox),s=rl(t,i,n,this.toBBox)),l=ll(o)+ll(s),a<h?(h=a,u=i,c=l<c?l:c):a===h&&l<c&&(c=l,u=i);return u},_chooseSplitAxis:function(t,e,n){var i=t.leaf?this.compareMinX:sl,o=t.leaf?this.compareMinY:al;this._allDistMargin(t,e,n,i)<this._allDistMargin(t,e,n,o)&&t.children.sort(i)},_allDistMargin:function(t,e,n,i){t.children.sort(i);var o,s,a=this.toBBox,l=rl(t,0,e,a),h=rl(t,n-e,n,a),c=hl(l)+hl(h);for(o=e;o<n-e;o++)s=t.children[o],ol(l,t.leaf?a(s):s),c+=hl(l);for(o=n-e-1;o>=e;o--)s=t.children[o],ol(h,t.leaf?a(s):s),c+=hl(h);return c},_adjustParentBBoxes:function(t,e,n){for(var i=n;i>=0;i--)ol(e[i],t)},_condense:function(t){for(var e,n=t.length-1;n>=0;n--)0===t[n].children.length?n>0?(e=t[n-1].children).splice(e.indexOf(t[n]),1):this.clear():il(t[n],this.toBBox)},_initFormat:function(t){var e=["return a"," - b",";"];this.compareMinX=new Function("a","b",e.join(t[0])),this.compareMinY=new Function("a","b",e.join(t[1])),this.toBBox=new Function("a","return {minX: a"+t[0]+", minY: a"+t[1]+", maxX: a"+t[2]+", maxY: a"+t[3]+"};")}};var Al=cs(Ja.exports),ml={},yl=function(){function t(){this._tree=Al(9,["[0]","[1]","[2]","[3]"])}var e=t.prototype;return e.collides=function(t){return[ml.minX,ml.minY,ml.maxX,ml.maxY]=t,this._tree.collides(ml)},e.insertBox=function(t){return this._tree.insert(t),this},e.bulkInsertBox=function(t){return this._tree.load(t),this},e.clear=function(){return this._tree.clear(),this},t}(),_l=new Xa(5e4);function vl(t,e,n){var i=t.font,o=t.fillStyle,s=t.strokeStyle,a=e.textHaloFill||xl,l=e.textHaloRadius||0,h=e.textHaloOpacity;c(h)||(h=1);var u=i+"_"+o+"_"+a+"_"+l+"_"+h+"_"+n,f=_l.get(u);if(!f){var g=0!==h&&0!==l,A=2*(1.2*(e.textSize||14)+l),m=zl.createCanvas(A,A);m.style.width=A/2+"px",m.style.height=A/2+"px";var w=A/4,T=A/4,M=zl.getCanvas2DContext(m);M.scale(2,2),M.font=i,M.textAlign="center",M.textBaseline="middle",g&&(M.strokeStyle=s,M.lineWidth=2*l,M.globalAlpha=1,M.globalAlpha*=h,M.strokeText(n,w,T),M.globalAlpha=1),M.fillStyle=o,M.fillText(n,w,T),_l.add(u,f=m)}return f}var xl="#000",bl=!1,wl=null,Tl=Math.PI/180,Ml=new yl,Cl=new yl;var Sl,Pl=function(){for(var t={},e=32;e<128;e++){var n=String.fromCharCode(e);t[n]=n}return t}();function Il(t){if(t.toReversed)return t.toReversed();for(var e=[],n=0,i=t.length-1;n<=i;n++)e[n]=t[i-n];return e}function Ol(t,e,n,i,o){var s=Math.atan2(e.y-t.y,e.x-t.x),a=s/Math.PI*180;return"left"===i?s=(a+=180)/180*Math.PI:"down"!==i||o?"up"!==i||o?s:s=(a+=90)/180*Math.PI:s=(a-=90)/180*Math.PI}function El(t,e){var n=e,i=e;return Pl[t]&&(n=e/4,i=e),Math.sqrt(n*n+i*i)}function kl(t,e){var{distance:n,p1:i,p2:o}=t,s=e/n;return new _e(i.x+s*(o.x-i.x),i.y+s*(o.y-i.y),(i.z||0)+s*((o.z||0)-(i.z||0)))}function Rl(t){for(var e=t[0].point,n=t[t.length-1].point,i=ws(),o=0,s=t.length;o<s;o++){Ps(t[o].point,i)}var[a,l,h,c]=i,u=!0;return c-l>h-a&&(u=!1),u?e.x<n.x?"right":"left":e.y<n.y?"down":"up"}function Ll(t,e,n,i){var o=Nl(t),s=[],a=0,l=!1;Ml.clear();for(var h=1,c=0,u=e.length;c<u;c++){for(var f=e[c],g=El(f,n),A=g+a,m=h,w=t.length;m<w;m++){var T=t[m-1],M=t[m];if(!(M.distance<A)){h=m;var C=(A-T.distance)/(M.distance-T.distance),P=new _e(T.x+(M.x-T.x)*C,T.y+(M.y-T.y)*C),{x:I,y:O}=P,E=g/3,D=[I-E,O-E,I+E,O+E];if(i&&i.collides(D)){l=!0;break}if(Ml.collides(D)){l=!0;break}Ml.insertBox(D),s.push({char:f,charSize:g,point:P,bbox:[I-(E=g/2),O-E,I+E,O+E]}),a+=g;break}}if(l)break}return l||o<a?[]:s}function Fl(t,e,n,i,o,s,a,l,h,c){var u=(t+n)/2,f=(e+i)/2,g=(n+o)/2,A=(i+s)/2,m=(o+a)/2,w=(s+l)/2,T=Math.sqrt((n-t)*(n-t)+(i-e)*(i-e)),M=Math.sqrt((o-n)*(o-n)+(s-i)*(s-i)),C=T/(T+M),P=M/(M+Math.sqrt((a-o)*(a-o)+(l-s)*(l-s))),I=u+(g-u)*C,O=f+(A-f)*C,E=g+(m-g)*P,D=A+(w-A)*P,N=I+(g-I)*h+n-I,H=O+(A-O)*h+i-O,U=E+(g-E)*h+o-E,W=D+(A-D)*h+s-D,q=[N,H,U,W];return c<1?function(t,e,n,i,o,s,a,l,h,c){var u=1-t,f=1-e,g=n*f*f+2*o*e*f+a*e*e,A=o*f*f+2*a*e*f+h*e*e,m=i*f*f+2*s*e*f+l*e*e,w=s*f*f+2*l*e*f+c*e*e;return[(n*u*u+2*o*t*u+a*t*t)*f+(o*u*u+2*a*t*u+h*t*t)*e,(i*u*u+2*s*t*u+l*t*t)*f+(s*u*u+2*l*t*u+c*t*t)*e,g*u+A*t,m*u+w*t,g*f+A*e,m*f+w*e]}(0,c,n,i,N,H,U,W,o,s):q}function Nl(t){if(t.length<2)return 0;var e=0;t[0].distance=0;for(var n=1,i=t.length;n<i;n++){var o=t[n-1],s=t[n],a=o.distanceTo(s);s.distance=a+o.distance,e+=a}return e}function Hl(t,e,n){var i=t.x,o=t.y;return new _e(i+(e.x-i)*n,o+(e.y-o)*n)}function Bl(t,e,n,i){return"rgba("+t+", "+e+", "+n+", "+i/255+")"}var zl={getTempCanvas:function(){return Sl||(Sl=zl.createCanvas(1,1)),Sl},getCanvas2DPerformanceContext:function(t){return t.getContext("2d",{})},getCanvas2DContext:function(t){return t.getContext("2d",{willReadFrequently:!0})},setHitTesting:function(t){bl=t},createCanvas:function(t,e,i){var o;return n?o=new i(t,e):((o=Pi("canvas")).width=t,o.height=e),o},prepareCanvasFont:function(t,e,n){"top"!==t.textBaseline&&(t.textBaseline="top"),n=n||yi(e),t.font!==n&&(t.font=n);var i=e.textFill;i||(i="#000");var o=zl.getRgba(i,e.textOpacity);t.fillStyle!==o&&(t.fillStyle=o)},prepareCanvas:function(t,e,n,i){if(e){var o=e.lineWidth;h(o)||t.lineWidth===o||(t.lineWidth=o);var s=e.linePatternFile,a=e.lineColor||xl;if(i)t.strokeStyle="#000";else if(s&&n){var l;(e.linePatternDx||e.linePatternDy)&&(l=[e.linePatternDx,e.linePatternDy]),zl._setStrokePattern(t,s,o,l,n),e.lineDasharray=[]}else Ho(a)?t.strokeStyle=e.lineGradientExtent?zl._createGradient(t,a,e.lineGradientExtent):xl:(Array.isArray(a)&&(a=zl.normalizeColorToRGBA(a)),t.strokeStyle=a);e.lineJoin&&(t.lineJoin=e.lineJoin),e.lineCap&&(t.lineCap=e.lineCap),t.setLineDash&&Je(e.lineDasharray)&&t.setLineDash(e.lineDasharray);var c=e.polygonPatternFile,u=e.polygonFill||"rgba(255,255,255,0)";if(i)t.fillStyle="#000";else if(c&&n){var f=Vl(c),g=n.getImage([f,null,null]);if(g||(g=n.getImage([f+"-texture",null,o])),ve(f)&&g instanceof Image&&(Gt.edge||Gt.ie)){var A=g.width||20,m=g.height||20,w=zl.createCanvas(A,m);zl.image(w.getContext("2d"),g,0,0,A,m),g=w}g?(t.fillStyle=t.createPattern(g,"repeat"),(e.polygonPatternDx||e.polygonPatternDy)&&(t.fillStyle.polygonPatternOffset=[e.polygonPatternDx,e.polygonPatternDy])):"undefined"!=typeof console&&console.warn("img not found for",f)}else Ho(u)?t.fillStyle=e.polygonGradientExtent?zl._createGradient(t,u,e.polygonGradientExtent):"rgba(255,255,255,0)":(Array.isArray(u)&&(u=zl.normalizeColorToRGBA(u)),t.fillStyle=u)}},_createGradient:function(t,e,n){var i=null,o=e.places,s=n.getMin(),a=n.getMax(),l=n.getWidth(),h=n.getHeight();if(e.type&&"linear"!==e.type){if("radial"===e.type){if(o){if(6!==o.length)throw new Error("A radial gradient's places should have 6 numbers.");o=[s.x+o[0]*l,s.y+o[1]*h,l*o[2],s.x+o[3]*l,s.y+o[4]*h,l*o[5]]}else{var c=n.getCenter()._round();o=[c.x,c.y,Math.abs(c.x-s.x),c.x,c.y,0]}i=t.createRadialGradient.apply(t,o)}}else{if(o){if(4!==o.length)throw new Error("A linear gradient's places should have 4 numbers.");o=[s.x+o[0]*l,s.y+o[1]*h,s.x+o[2]*l,s.y+o[3]*h]}else o=[s.x,s.y,a.x,s.y];i=t.createLinearGradient.apply(t,o)}return e.colorStops.forEach((function(t){i.addColorStop.apply(i,t)})),i},_setStrokePattern:function(t,e,i,o,s){var a,l=Vl(e);if(n)a=s.getImage([l,null,i]);else{var h=l+"-texture-"+i;if(!(a=s.getImage(h))){var c=s.getImage([l,null,null]);if(c){var u;u=c.width&&c.height?Math.round(c.width*i/c.height):i;var f=zl.createCanvas(u,i,t.canvas.constructor);zl.image(f.getContext("2d"),c,0,0,u,i),s.addResource([h,null,i],f),a=f}}}a?(t.strokeStyle=t.createPattern(a,"repeat"),t.strokeStyle.linePatternOffset=o):"undefined"!=typeof console&&console.warn("img not found for",l)},clearRect:function(t,e,n,i,o){t.canvas._drawn=!1,t.clearRect(e,n,i,o)},fillCanvas:function(t,e,n,i){if(bl&&(e=1),t.canvas._drawn=!0,0!==e){var o,s=zl._isPattern(t.fillStyle),a=t.fillStyle&&t.fillStyle.polygonPatternOffset,l=a?a[0]:0,c=a?a[1]:0;h(e)&&(e=1),e<1&&(o=t.globalAlpha,t.globalAlpha*=e),s&&t.translate((n=n||0)+l,(i=i||0)+c),t.fill(),s&&t.translate(-n-l,-i-c),e<1&&(t.globalAlpha=o)}},getRgba:function(t,e){return h(e)&&(e=1),"#"===t[0]&&1===e?t:"#"!==t[0]?(Array.isArray(t)&&(t=zl.normalizeColorToRGBA(t,e)),t):(7===t.length?(n=parseInt(t.substring(1,3),16),i=parseInt(t.substring(3,5),16),o=parseInt(t.substring(5,7),16)):(n=17*parseInt(t.substring(1,2),16),i=17*parseInt(t.substring(2,3),16),o=17*parseInt(t.substring(3,4),16)),"rgba("+n+","+i+","+o+","+e+")");var n,i,o},normalizeColorToRGBA:function(t,e=1){return"rgba("+255*t[0]+", "+255*t[1]+", "+255*t[2]+", "+(4===t.length?t[3]:1)*e+")"},image:function(t,e,n,i,o,s){t.canvas._drawn=!0;try{c(o)&&c(s)?t.drawImage(e,n,i,o,s):t.drawImage(e,n,i)}catch(t){console&&(console.warn("error when drawing image on canvas:",t),console.warn(e))}},text:function(t,e,n,i,o){return zl._textOnMultiRow(t,o.rows,i,n,o.size,o.rawSize)},_textOnMultiRow:function(t,e,n,i,o,s){var a,l,h=gi(o,n.textHorizontalAlignment,n.textVerticalAlignment),c=s.height+n.textLineSpacing,u=i.add(0,h.y),f=n.textMaxHeight,g=0;Ss(Cs);for(var A=0,m=e.length;A<m;A++){a=e[A].text,l=gi(e[A].size,n.textHorizontalAlignment,n.textVerticalAlignment);var w=u.add(l.x,A*c);zl._textOnLine(t,a,w,n.textHaloRadius,n.textHaloFill,n.textHaloOpacity);var T=e[A].size,M=w.x,C=w.y;if(Is(Cs,M,C,M+T.width,C+T.height),f>0&&(g+=c)+T.height>=f)break}return Cs},_textOnLine:function(t,e,n,i,o,s){bl&&(s=1);var a,l,h=0!==s&&0!==i;t.textBaseline="top";var c=t.shadowBlur,u=t.shadowOffsetX,f=t.shadowOffsetY;if(h){var g=t.globalAlpha;t.globalAlpha*=s,t.miterLimit=2,t.lineJoin="round",t.lineCap="round",t.lineWidth=2*i,Array.isArray(o)&&(o=zl.normalizeColorToRGBA(o)),t.strokeStyle=o,t.strokeText(e,n.x,n.y+1),t.miterLimit=10,t.globalAlpha=g,a=t.globalCompositeOperation,t.globalCompositeOperation="destination-out",l=t.fillStyle,t.fillStyle="#000"}c&&h&&(t.shadowBlur=t.shadowOffsetX=t.shadowOffsetY=0),zl.fillText(t,e,n),a&&(t.globalCompositeOperation=a,zl.fillText(t,e,n,l),c&&(t.shadowBlur=c,t.shadowOffsetX=u,t.shadowOffsetY=f))},fillText:function(t,e,n,i){t.canvas._drawn=!0,i&&(t.fillStyle=i),t.fillText(e,n.x,n.y+1)},textAlongLine:function(t,e,n,i,o,s){if(e){var a=i.textSize||14,l=i.textSpacing||0,h=function(t,e){for(var n=0,i=0,o=t.length;i<o;i++)n+=El(t[i],e);return n}(e,a);if(!(l<h)){Array.isArray(n[0])||(n=[n]);var u=t.textBaseline,f=t.textAlign,g=t.strokeStyle,A=t.globalAlpha,m=t.lineWidth,w=i.textAlongDebug,T=i.textHaloFill||xl,M=i.textHaloRadius||0,C=i.textHaloOpacity;c(C)||(C=1);var P=0!==C&&0!==M;t.textBaseline="middle",t.textAlign="center",P&&(Array.isArray(T)&&(T=zl.normalizeColorToRGBA(T)),t.strokeStyle=T,t.lineWidth=2*M),Cl.clear();var I=ws(),O=e.split(""),E=function(t){for(var e=0,n=t.length;e<n;e++)if(!Pl[t[e]])return!1;return!0}(O);if(n.forEach((function(e){if(!(Nl(e)<h)){var n=function(t,e){e=Object.assign({segDistance:1,isGeo:!0},e);for(var n=Math.max(e.segDistance,1e-17),i=[],o=0,s=0,a=0,l=t.length;a<l-1;a++){var h=t[a],c=t[a+1],u=c.distanceTo(h);i[s]={p1:h,distance:u,p2:c},s++,o+=u}if(o<=n)return[{distance:o,points:t}];var f,g=i.length;s=0;for(var A=0,m=[],w=[i[0].p1];s<g;){var{distance:T,p2:M}=i[s];if((A+=T)<n)w.push(M),s++;else if(A!==n){if(A>n){var C=n-(A-T);f=kl(i[s],C),w.push(f),m.push(w),A=0,i[s].p1=f,i[s].distance=T-C,w=[f]}}else w.push(M),A=0,m.push(w),w=[M],s++}w.length&&m.push(w);for(var P=[],I=0,O=m.length;I<O;I++){var E=m[I];P[I]={points:E,distance:Nl(E)}}return P}(e,{segDistance:l});if(n&&n.length)for(var o=0,c=n.length;o<c;o++){var u=n[o];if(!(u.distance<h)){var f=u.points;if(w){var g=t.fillStyle;t.fillStyle="red";var{x:A,y:m}=f[0];t.beginPath(),t.fillRect(A-2,m-2,4,4),t.fillStyle=g}var T=O,M=Ll(f,T,a,s);if(M.length){var C=Rl(M);"left"===C&&(M=Ll(f,T=Il(T),a,s)),"up"!==C||E||(M=Ll(f,T=Il(T),a,s));for(var P=!1,D=0,N=M.length;D<N;D++){var{bbox:H}=M[D];if(Cl.collides(H)){P=!0;break}if(s&&s.collides(H)){P=!0;break}}if(!P)for(var U=0,W=M.length;U<W;U++){var q=void 0,X=void 0;0===U?(q=M[U].point,X=M[1].point):U===W-1?(q=M[W-2].point,X=M[W-1].point):(q=M[U-1].point,X=M[U].point);var J=T[U],{point:Q,bbox:Y}=M[U];Cl.insertBox(Y),s&&s.insertBox(Y);var{x:K,y:$}=Q,tt=Ol(q,X,0,C,E);t.save(),t.translate(K,$),t.rotate(tt);var et=vl(t,i,J),{width:nt,height:it}=et;if(t.drawImage(et,-nt/4,-it/4,nt/2,it/2),t.restore(),Is(I,Y),w){var rt=t.strokeStyle,ot=t.lineWidth;t.strokeStyle="red",t.lineWidth=.5;var[st,at,ut,ft]=Y;t.beginPath(),t.rect(st,at,ut-st,ft-at),t.stroke(),t.lineWidth=ot,t.strokeStyle=rt}}}}}}})),t.textBaseline=u,t.textAlign=f,t.strokeStyle=g,t.globalAlpha=A,t.lineWidth=m,Os(I))return I}}},_stroke:function(t,e,n,i){if(bl&&(e=1),t.canvas._drawn=!0,0!==e){var o,s=t.strokeStyle&&t.strokeStyle.linePatternOffset,a=s?s[0]:0,l=s?s[1]:0,c=zl._isPattern(t.strokeStyle)&&(!h(n)&&!h(i)||!h(a)&&!h(l));h(e)&&(e=1),e<1&&(o=t.globalAlpha,t.globalAlpha*=e),c&&t.translate((n=n||0)+a,(i=i||0)+l),t.stroke(),c&&t.translate(-n-a,-i-l),e<1&&(t.globalAlpha=o)}},_gradientPath:function(t,e,n,i,o=!1){if(c(i)||(i=1),bl&&(i=1),0!==i&&0!==t.lineWidth){var s=t.globalAlpha;t.globalAlpha*=i;var a,l,h,u,f,g,A,m=t.lineColorIn,w=function(t){if(c(t.minStep))return t.minStep;for(var e=t.colors||[],n=e.length,i=[],o=0;o<n;o++)i[o]=e[o][0];i.sort((function(t,e){return t-e}));for(var s=1/0,a=1;a<n;a++)s=Math.min(s,i[a]-i[a-1]);return t.minStep=s,s}(m),T=Nl(e),M=0,[C,P,I,O]=m.getColor(0);a=Bl(C,P,I,O);var E=e[0];if(h=E.x,u=E.y,o)E.equals(e[e.length-1])||e.push(E);for(var D=n&&Array.isArray(n)&&n.length>1,N=function(){!D&&A&&(t.strokeStyle=l,t.beginPath(),t.moveTo(h,u),t.lineTo(f,g),t.lineTo(A.x,A.y),t.stroke());var e=t.createLinearGradient(h,u,f,g);e.addColorStop(0,a),e.addColorStop(1,l),t.strokeStyle=e,t.beginPath(),t.moveTo(h,u),t.lineTo(f,g),t.stroke(),a=l,h=f,u=g},H=1,U=e.length;H<U;H++){var W=e[H-1],q=e[H];A=e[H+1];var X=q.x,J=q.y,Q=q.distanceTo(W)/T;if(Q<=w){var[Y,K,$,tt]=m.getColor(M+Q);l=Bl(Y,K,$,tt),f=X,g=J,N()}else{var et=Math.ceil(Q/w);A=q;for(var nt=1;nt<=et;nt++){var it=Math.min(nt*w,Q),[rt,ot,st,at]=m.getColor(M+it);if((l=Bl(rt,ot,st,at))!==a){var ut=Hl(W,q,it/Q);f=ut.x,g=ut.y,N()}}}M+=Q}t.globalAlpha=s}},_path:function(t,e,n,i,o){if(Je(e))for(var s,a=Je(n),l=!0!==o&&zl._isPattern(t.strokeStyle),h=0,c=e.length;h<c;h++)if(s=e[h],!a||t.setLineDash)t.lineTo(s.x,s.y),l&&h>0&&(u(e[h-1],s),t.beginPath(),t.moveTo(s.x,s.y));else if(a){if(h===c-1)break;Gl(t,s,e[h+1],n)}function u(e,n){var o=yn(e.x,e.y,n.x,n.y);t.save();var s=Math.cos(o);Math.abs(s)<1e-7?t.translate(e.x-t.lineWidth/2,e.y):t.translate(e.x,e.y-t.lineWidth/2/s),t.rotate(o),zl._stroke(t,i),t.restore()}},path:function(t,e,n,i,o){Je(e)&&(t.lineColorIn?zl._gradientPath(t,e,o,n):(t.beginPath(),t.moveTo(e[0].x,e[0].y),zl._path(t,e,o,n)),zl._stroke(t,n))},roundRect:function(t,e,n,i){if(Gt.roundRect){for(var o=1/0,s=1/0,a=-1/0,l=-1/0,h=0,u=e.length;h<u;h++){var f=e[h],{x:g,y:A}=f;o=Math.min(o,g),s=Math.min(s,A),a=Math.max(a,g),l=Math.max(l,A)}var m=Math.abs(a-o),w=Math.abs(l-s);if(!(m*w<=0)){var T=Math.min(m,w);t.roundRect(o,s,m,w,T/4);var M=t.globalAlpha;c(i)&&i<1&&(t.globalAlpha=1,t.globalAlpha*=i),t.fill(),t.globalAlpha=M,c(n)&&n<1&&(t.globalAlpha=1,t.globalAlpha*=n),t.stroke(),t.globalAlpha=M}}},_multiClip:function(t,e){e&&0!==e.length&&e.forEach((function(e){for(var n=0,i=e.length;n<i;n++){var o=e[n],s=o.x,a=o.y;0===n?t.moveTo(s,a):t.lineTo(s,a),n===i-1&&t.lineTo(s=e[0].x,a=e[0].y)}}))},polygon:function(t,e,i,o,s,a){if(t.isMultiClip)zl._multiClip(t,e);else if(t.isClip)zl._multiClip(t,Array.isArray(e[0])?e:[e]);else if(Je(e)){var l=zl._isPattern(t.strokeStyle),h=Je(s)&&!t.setLineDash||l&&!a;Je(e[0])||(e=[e]);var c=t,u=t.dpr||1,f=1!==u;e.length>1&&!n&&(wl||(wl=zl.createCanvas(1,1)),t.canvas._drawn=!1,wl.width=t.canvas.width,wl.height=t.canvas.height,Zl(t=wl.getContext("2d"),[]),Zl(t,s),Wl(t,c),f&&t.scale(u,u));var g,A,m,w=t.lineColorIn,T=t.lineWidth;if(h){for(t.save(),A=0,m=e.length;A<m;A++)Je(e[A])&&(w&&(t.lineWidth=.1),zl._ring(t,e[A],null,0,!0),g=o,A>0&&(t.globalCompositeOperation="destination-out",g=1),zl.fillCanvas(t,g,e[A][0].x,e[A][0].y),A>0?t.globalCompositeOperation="source-over":m>1&&(t.fillStyle="#fff"),zl._stroke(t,0),t.lineWidth=T,w&&zl._gradientPath(t,e,null,0,!0));t.restore()}var M=t.fillStyle;for(A=0,m=e.length;A<m;A++)Je(e[A])&&(w&&(t.lineWidth=.1),a?(zl.paintSmoothLine(t,e[A],i,a,!0),t.closePath()):zl._ring(t,e[A],s,i),h||(g=o,A>0&&(t.globalCompositeOperation="destination-out",g=1),zl.fillCanvas(t,g,e[A][0].x,e[A][0].y),A>0?t.globalCompositeOperation="source-over":m>1&&(t.fillStyle="#fff")),zl._stroke(t,i),t.lineWidth=T,w&&zl._gradientPath(t,e[A],s,i,!0));if(t.fillStyle!==M&&(t.fillStyle=M),e.length>1&&!n){if(f){var C=1/u;c.scale(C,C)}c.drawImage(wl,0,0),f&&c.scale(u,u),c.canvas._drawn=t.canvas._drawn,Wl(c,t)}}},_ring:function(t,e,n,i,o){var s=zl._isPattern(t.strokeStyle);o||!s||e[0].equals(e[e.length-1])||(e=e.concat([e[0]])),t.beginPath(),t.moveTo(e[0].x,e[0].y),zl._path(t,e,n,i,o),s||t.closePath()},paintSmoothLine_bak:function(t,e,n,i,o,s,a){if(e)if(e.length<=2||!i)zl.path(t,e,n);else{var l,h=e.length,c=o?h:h-1;t.beginPath(),t.moveTo(e[0].x,e[0].y),void 0!==a&&(c-=Math.max(c-s-1,0));for(var u=0;u<c;u++){var f=void 0,g=void 0,A=void 0,m=void 0,w=void 0,T=void 0;u-1<0?o?(f=e[c-1].x,g=e[c-1].y):(f=e[u+1].x,g=e[u+1].y):(f=e[u-1].x,g=e[u-1].y),u+1<h?(A=e[u+1].x,m=e[u+1].y):(A=e[u+1-h].x,m=e[u+1-h].y),u+2<h?(w=e[u+2].x,T=e[u+2].y):o?(w=e[u+2-h].x,T=e[u+2-h].y):(w=e[u].x,T=e[u].y);var M=Fl(f,g,e[u].x,e[u].y,A,m,w,T,i,u===c-1?a:1);if(u===c-1&&a>=0&&a<1){t.bezierCurveTo(M[0],M[1],M[2],M[3],M[4],M[5]),e.splice(c-1,h-(c-1)-1);var C=new _e(M[4],M[5]);C.prevCtrlPoint=new _e(M[2],M[3]),e.push(C),h=e.length}else t.bezierCurveTo(M[0],M[1],M[2],M[3],A,m);e[u].nextCtrlPoint=M.slice(0,2),e[u].prevCtrlPoint=l?l.slice(2):null,l=M}!o&&e[1].prevCtrlPoint&&(e[0].nextCtrlPoint=e[1].prevCtrlPoint,delete e[0].prevCtrlPoint),e[h-1].prevCtrlPoint||(e[h-1].prevCtrlPoint=e[h-2].nextCtrlPoint),zl._stroke(t,n)}},paintSmoothLine:function(t,e,n,i,o,s,a){if(e)if(e.length<=2||!i)zl.path(t,e,n);else{var l,h,c=e.length,u=o?c:c-1;t.beginPath(),t.moveTo(e[0].x,e[0].y),void 0!==a&&(u-=Math.max(u-s-1,0));for(var f=0;f<u;f++){var g=void 0,A=void 0,m=void 0,w=void 0,T=void 0,M=void 0;f-1<0?o?(g=e[u-1].x,A=e[u-1].y):(g=e[f+1].x,A=e[f+1].y):(g=e[f-1].x,A=e[f-1].y),f+1<c?(m=e[f+1].x,w=e[f+1].y):(m=e[f+1-c].x,w=e[f+1-c].y),f+2<c?(T=e[f+2].x,M=e[f+2].y):o?(T=e[f+2-c].x,M=e[f+2-c].y):(T=e[f].x,M=e[f].y);var C=e[f],P=Fl(g,A,e[f].x,e[f].y,m,w,T,M,i,f===u-1?a:1);if(f===u-1&&a>=0&&a<1){t.bezierCurveTo(P[0],P[1],P[2],P[3],P[4],P[5]),e.splice(u-1,c-(u-1)-1);var I=new _e(P[4],P[5]);e.push(I),c=e.length}else t.bezierCurveTo(P[0],P[1],P[2],P[3],m,w);0===f?(C.arrowNextPoint=C.arrowNextPoint||new _e(0,0),h=P[3],C.arrowNextPoint.x=l=P[2],C.arrowNextPoint.y=h):(C.arrowPrePoint=C.arrowPrePoint||new _e(0,0),C.arrowPrePoint.x=l,C.arrowPrePoint.y=h,l=P[2],h=P[3],f===u-1&&e[f+1]&&(e[f+1].arrowPrePoint=e[f+1].arrowPrePoint||new _e(0,0),e[f+1].arrowPrePoint.x=P[0],e[f+1].arrowPrePoint.y=P[1]))}zl._stroke(t,n)}},_arcBetween:function(t,e,n,i){var o=Math.abs(i),s=e.distanceTo(n),a=Math.abs(s/2/Math.sin(o/2)),l=Math.asin((n.y-e.y)/s);e.x>n.x&&(l=Math.PI-l);var h=l-(90*Tl-o/2),c=Math.cos(h)*a,u=Math.sin(h)*a,f=e.x+c,g=e.y+u,A=Math.asin((n.y-g)/a);f>n.x&&(A=Math.PI-A);var m=A+o;if(i<0){A+=Math.PI,m+=Math.PI;var w=(e.x+n.x)/2,T=(e.y+n.y)/2;f=w-(f-w),g=T-(g-T)}t.beginPath(),t.arc(f,g,a,A,m);var M=(m-A)/100,C=Math.cos(A+M)*a+f,P=Math.sin(A+M)*a+g,I=Math.cos(m-M)*a+f,O=Math.sin(m-M)*a+g;return e.arrowNextPoint=e.arrowNextPoint||new _e(0,0),n.arrowPrePoint=n.arrowPrePoint||new _e(0,0),i<0?(e.arrowNextPoint.x=C,e.arrowNextPoint.y=P,n.arrowPrePoint.x=I,n.arrowPrePoint.y=O):(e.arrowNextPoint.x=I,e.arrowNextPoint.y=O,n.arrowPrePoint.x=C,n.arrowPrePoint.y=P),[f,g]},_lineTo:function(t,e){t.lineTo(e.x,e.y)},bezierCurveAndFill:function(t,e,n,i){t.beginPath();var o=e[0];t.moveTo(o.x,o.y);var s=[t];s.push.apply(s,e.splice(1)),zl._bezierCurveTo.apply(zl,s),zl.fillCanvas(t,i),zl._stroke(t,n)},_bezierCurveTo:function(t,e,n,i){t.bezierCurveTo(e.x,e.y,n.x,n.y,i.x,i.y)},ellipse:function(t,e,n,i,o,s,a){t.beginPath(),n===i&&n===o?t.arc(e.x,e.y,n,0,2*Math.PI):t.ellipse?i!==o?(t.ellipse(e.x,e.y,n,i,0,180*Tl,360*Tl,!1),t.ellipse(e.x,e.y,n,o,0,0,180*Tl,!1)):t.ellipse(e.x,e.y,n,i,0,0,360*Tl,!1):function(e,n,i,o,s){var a=.5522848,l=i*a,h=o*a,c=s*a;t.moveTo(e-i,n),t.bezierCurveTo(e-i,n-h,e-l,n-o,e,n-o),t.bezierCurveTo(e+l,n-o,e+i,n-h,e+i,n),t.bezierCurveTo(e+i,n+c,e+l,n+s,e,n+s),t.bezierCurveTo(e-l,n+s,e-i,n+c,e-i,n),t.closePath()}(e.x,e.y,n,i,o),zl.fillCanvas(t,a,e.x-n,e.y-i),zl._stroke(t,s,e.x-n,e.y-i)},rectangle:function(t,e,n,i,o){var{x:s,y:a}=e;t.beginPath(),t.rect(s,a,n.width,n.height),zl.fillCanvas(t,o,s,a),zl._stroke(t,i,s,a)},sector:function(t,e,n,i,o,s){var a=Tl;function l(t,e,n,i,l,h){var c=a*-h,u=a*-l;t.beginPath(),t.moveTo(e,n),t.arc(e,n,i,c,u),t.lineTo(e,n),zl.fillCanvas(t,s,e-i,n-i),zl._stroke(t,o,e-i,n-i)}l(t,e.x,e.y,n,i[0],i[1])},_isPattern:function(t){return!g(t)&&!("addColorStop"in t)},drawCross:function(t,e,n,i,o){t.canvas._drawn=!0,t.strokeStyle=o,t.lineWidth=i,t.beginPath(),t.moveTo(e-5,n),t.lineTo(e+5,n),t.moveTo(e,n-5),t.lineTo(e,n+5),t.stroke()},copy:function(t,e){var n=e||Pi("canvas");return n.width=t.width,n.height=t.height,n.getContext("2d").drawImage(t,0,0),n},pixelRect:function(t,e,n,i){var o=t.globalAlpha,s=!1;if(t.lineWidth>0&&n>0)s=!0,n<1&&(t.globalAlpha*=n);else{if(!(i>0))return;i<1&&(t.globalAlpha*=i)}t.canvas._drawn=!0,s?t.strokeRect(e[0],e[1],1,1):t.fillRect(e[0],e[1],1,1),t.globalAlpha!==o&&(t.globalAlpha=o)}};function Gl(t,e,n,i){var o=e.x,s=e.y,a=n.x,l=n.y,h=i,c=function(t,e){return t<=e},u=function(t,e){return t>=e},f=function(t,e){return Math.min(t,e)},g=function(t,e){return Math.max(t,e)},A={thereYet:u,cap:f},m={thereYet:u,cap:f};s-l>0&&(m.thereYet=c,m.cap=g),o-a>0&&(A.thereYet=c,A.cap=g),t.moveTo(o,s);for(var w,T,M=o,C=s,P=0,I=!0;!A.thereYet(M,a)||!m.thereYet(C,l);)w=Math.atan2(l-s,a-o),T=h[P],M=A.cap(a,M+Math.cos(w)*T),C=m.cap(l,C+Math.sin(w)*T),I?t.lineTo(M,C):t.moveTo(M,C),P=(P+1)%h.length,I=!I}var jl="data:image/";function Vl(t){return t.substring(0,jl.length)===jl?t:rn(t)}function Wl(t,e){t.filter=e.filter,t.fillStyle=e.fillStyle,t.globalAlpha=e.globalAlpha,t.lineCap=e.lineCap,t.lineDashOffset=e.lineDashOffset,t.lineJoin=e.lineJoin,t.lineWidth=e.lineWidth,t.shadowBlur=e.shadowBlur,t.shadowColor=e.shadowColor,t.shadowOffsetX=e.shadowOffsetX,t.shadowOffsetY=e.shadowOffsetY,t.strokeStyle=e.strokeStyle,t.lineColorIn=e.lineColorIn}function Zl(t,e){e&&t.setLineDash&&Array.isArray(e)&&t.setLineDash(e)}function ql(t){return"Z__"+t}function Xl(t){return function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n.on=function(t,e,n){if(!t)return this;if(!g(t))return this._switch("on",t,e);if(!e)return this;this._eventMap||(this._eventMap={});var i,o=t.toLowerCase().split(" ");n||(n=this);var a,l=c(e._id);e._id=we();for(var h=0,u=o.length;h<u;h++){var f=ql(i=o[h]);if(e[f]&&(e[f]._id=e._id),(a=this._eventMap[i])||(this._eventMap[i]=a=[]),l){var A=a.length;if(A>0)for(var m=0;m<A;m++)if(e===a[m].handler&&a[m].context===n)return s.isTest||console.warn(this,"find '"+t+"' handler:",e," The old listener function will be removed"),this;a.push({handler:e,context:n})}else a.push({handler:e,context:n})}return this},n.addEventListener=function(...t){return this.on.call(this,...t)},n.once=function(t,e,n){if(!g(t)){var i={};for(var o in t)t.hasOwnProperty(o)&&(i[o]=this._wrapOnceHandler(o,t[o],e));return this._switch("on",i)}for(var s=t.split(" "),a=0,l=s.length;a<l;a++)this.on(s[a],this._wrapOnceHandler(s[a],e,n));return this},n.off=function(t,e,n){if(!this._eventMap||!t)return this;if(!g(t))return this._switch("off",t,e);if(!e)return this;if(!c(e._id))return this;var i,o,s,a=t.split(" ");n||(n=this);for(var l=0,h=a.length;l<h;l++)if(s=ql(i=a[l].toLowerCase()),o=this._eventMap[i]){for(var u=o.length-1;u>=0;u--){var f=o[u];e!==f.handler&&e!==f.handler[s]||f.context!==n||(delete f.handler[s],o.splice(u,1))}o.length||delete this._eventMap[i]}return this},n.removeEventListener=function(...t){return this.off.call(this,...t)},n.listens=function(t,e,n){if(!this._eventMap||!g(t))return 0;var i=this._eventMap[t.toLowerCase()];if(!i||!i.length)return 0;if(!e)return i.length;for(var o=0,s=i.length;o<s;o++)if(e===i[o].handler&&(h(n)||i[o].context===n))return 1;return 0},n.getListeningEvents=function(){return this._eventMap?Object.keys(this._eventMap):[]},n.copyEventListeners=function(t){var e,n=t._eventMap;if(!n)return this;for(var i in n)for(var o=0,s=(e=n[i]).length;o<s;o++)this.on(i,e[o].handler,e[o].context);return this},n.fire=function(t,e){return this._eventParent?this._eventParent.fire.call(this._eventParent,t,e):this._fire.call(this,t,e)},n._wrapOnceHandler=function(t,e,n){var i=ql(t),o=!1,s=function t(...a){o||(delete s[i],o=!0,n?e.call(n,...a):e.call(this,...a),t._called=!0)};return s[i]=e,s},n._switch=function(t,e,n){for(var i in e)e.hasOwnProperty(i)&&this[t](i,e[i],n);return this},n._clearListeners=function(t){this._eventMap&&g(t)&&(this._eventMap[t.toLowerCase()]&&(this._eventMap[t]=null))},n._clearAllListeners=function(){this._eventMap=null},n._setEventParent=function(t){return this._eventParent=t,this},n._setEventTarget=function(t){return this._eventTarget=t,this},n._fire=function(t,e){if(!this._eventMap)return this;t=t.toLowerCase();var n=this._eventMap[t];if(!n)return this;e||(e={type:t,target:this._eventTarget||this}),e.type=t,e.target=this._eventTarget||this;for(var i,o,s=n.slice(0),a=0,h=s.length;a<h;a++){if(s[a])s[a].handler._called||(i=s[a].context,!0,o=l({},e),!1===(i?s[a].handler.call(i,o):s[a].handler(o))&&e.domEvent&&zi(e.domEvent))}var c=this._eventMap[t];if(c){for(var u=[],f=0,g=c.length;f<g;f++){c[f].handler._called||u.push(c[f])}this._eventMap[t]=u}return this},e}(t)}var Jl=function(t){function e(e){var n;return(n=t.call(this)||this)._enabled=!1,n.target=e,n}he(e,t);var n=e.prototype;return n.enable=function(){return this._enabled||(this._enabled=!0,this.addHooks()),this},n.disable=function(){return this._enabled?(this._enabled=!1,this.removeHooks(),this):this},n.enabled=function(){return!!this._enabled},n.remove=function(){this.disable(),delete this.target,delete this.dom},e}(Xl((function(){}))),Ql=function(){function t(t){if(!this||!this._setOptions)throw new Error('Class instance is being created without "new" operator.');this._setOptions(t),this.callInitHooks(),this._isUpdatingOptions=!1}var e=t.prototype;return e.proxyOptions=function(){var t=this;return Gt.proxy?(this.options=new Proxy(this.options,{set:function(e,n,i){if(e[n]===i)return!0;if(e[n]=i,t._isUpdatingOptions)return!0;var o={};return o[n]=i,t.config(o),!0}}),this):this},e.callInitHooks=function(){var t=Object.getPrototypeOf(this);return this._visitInitHooks(t),this},e._setOptions=function(t){if(this.hasOwnProperty("options")&&!h(this.options)||(this.options=this.options?Object.create(this.options):{}),!t)return this;for(var e in t)this.options[e]=t[e];return this},e.setOptions=function(t){return console.warn("setOptions(options) It is a private method and deprecated, please use _setOptions(options) instead. If you want to update options, please use config(options) instead."),this._setOptions(t)},e.config=function(t,e){if(this._isUpdatingOptions=!0,!t){var n={};for(var i in this.options)this.options.hasOwnProperty(i)&&(n[i]=this.options[i]);return this._isUpdatingOptions=!1,n}if(2===arguments.length&&"string"==typeof t){var o={};o[t]=e,t=o}for(var s in t)this.options[s]=t[s],this[s]&&this[s]instanceof Jl&&(t[s]?this[s].enable():this[s].disable());return this.onConfig(t),this._isUpdatingOptions=!1,this},e.onConfig=function(t){},e._visitInitHooks=function(t){if(!this._initHooksCalled){var e=Object.getPrototypeOf(t);e._visitInitHooks&&e._visitInitHooks.call(this,e),this._initHooksCalled=!0;var n=t._initHooks;if(n&&n!==e._initHooks)for(var i=0;i<n.length;i++)n[i].call(this)}},t.addInitHook=function(t,...e){var n="function"==typeof t?t:function(){this[t].call(this,...e)},i=this.prototype,o=Object.getPrototypeOf(i);return i._initHooks&&i._initHooks!==o._initHooks||(i._initHooks=[]),i._initHooks.push(n),this},t.include=function(...t){for(var e=0;e<t.length;e++)l(this.prototype,t[e]);return this},t.mergeOptions=function(t){var e=this.prototype,n=Object.getPrototypeOf(e);return e.options&&e.options!==n.options||(e.options=e.options?Object.create(e.options):{}),l(e.options,t),this},t}(),Yl=function(t){function e(){return t.apply(this,arguments)||this}return he(e,t),e}(Xl((function(){}))),Kl=new Yl,$l="dprchange",th="docvisibilitychange",eh="dragstart",nh="dragend";if("undefined"!=typeof window&&window.matchMedia)for(var ih=1;ih<500;ih++){var rh=(.01*ih).toFixed(2),oh=window.matchMedia("screen and (resolution: "+rh+"dppx)");oh&&(oh.addEventListener?oh.addEventListener("change",Gt.checkDevicePixelRatio):oh.addListener&&oh.addListener(Gt.checkDevicePixelRatio))}if(Gt.devicePixelRatio){var sh=Gt.devicePixelRatio;Object.defineProperty(Gt,"devicePixelRatio",{get:function(){return sh},set:function(t){t!==sh&&(sh=t,Gt.monitorDPRChange&&Kl.fire($l,{devicePixelRatio:t}))}})}Gt.webgl&&"undefined"!=typeof document&&(Ri(document,"visibilitychange",(function(){Kl.fire(th,{visibilityState:document.visibilityState})})),Ri(document,"dragstart",(function(){Kl.fire(eh)})),Ri(document,"dragend",(function(){Kl.fire(nh)})));var ah={};function lh(t){return function(t){function e(){return t.apply(this,arguments)||this}return he(e,t),e.registerJSONType=function(t){t&&(ah[t]?console.error(t+" has register. please use Different name for:",this):ah[t]=this)},e.getJSONClass=function(t){return t?ah[t]:null},e.prototype.getJSONType=function(){if(void 0===this._jsonType){var t=Object.getPrototypeOf(this).constructor;for(var e in ah)if(ah[e]===t){this._jsonType=e;break}}if(!this._jsonType)throw new Error("Found an unregistered Layer/Geometry class!");return this._jsonType},e}(t)}function hh(t){return function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n.addHandler=function(t,e){if(!e)return this;if(this._handlers||(this._handlers=[]),this[t])return this[t].enable(),this;var n=this[t]=new e(this);return this._handlers.push(n),this.options[t]&&n.enable(),this},n.removeHandler=function(t){if(!t)return this;var e=this[t];if(e){var n=this._handlers.indexOf(e);n>=0&&this._handlers.splice(n,1),this[t].remove(),delete this[t]}return this},n._clearHandlers=function(){for(var t=0,e=this._handlers.length;t<e;t++)this._handlers[t].remove();this._handlers=[]},e}(t)}var ch="touchstart mousedown",uh={mousedown:"mousemove",touchstart:"touchmove",pointerdown:"touchmove",MSPointerDown:"touchmove"},fh={mousedown:"mouseup",touchstart:"touchend",pointerdown:"touchend",MSPointerDown:"touchend"},dh=function(t){function e(e,n={}){var i;return(i=t.call(this,null)||this).dom=e,i.options=n,i}he(e,t);var n=e.prototype;return n.addHooks=function(){},n.removeHooks=function(){},n.enable=function(){return this.dom?(this._onMouseDown=function(t){return this.onMouseDown(t)},or(this.dom,ch,this._onMouseDown,this),this):this},n.disable=function(){return this.dom?(this._offEvents(),sr(this.dom,ch,this._onMouseDown),delete this._onMouseDown,this):this},n.onMouseDown=function(t){if(this.options.rightclick||2!==t.button){var e=t;if(!(e.touches&&e.touches.length>1||this.options.cancelOn&&!0===this.options.cancelOn(t))){var n=this.dom;n.setCapture?n.setCapture():window.captureEvents&&window.captureEvents(),n.ondragstart=function(){return!1},delete this.moved;var i=e.touches?e.touches[0]:t;this.startPos=new _e(i.clientX,i.clientY),sr(document,uh[t.type],this.onMouseMove),sr(document,fh[t.type],this.onMouseUp),or(document,uh[t.type],this.onMouseMove,this),or(document,fh[t.type],this.onMouseUp,this),this.options.ignoreMouseleave||(sr(this.dom,"mouseleave",this.onMouseUp),or(this.dom,"mouseleave",this.onMouseUp,this)),this.fire("mousedown",{domEvent:t,mousePos:new _e(i.clientX,i.clientY)})}}},n.onMouseMove=function(t){var e=t;if(e.touches&&e.touches.length>1)this.moved&&(this.interupted=!0,this.onMouseUp(t));else{var n=e.touches?e.touches[0]:t,i=new _e(n.clientX,n.clientY).sub(this.startPos);(i.x||i.y)&&(this.moved?this.fire("dragging",{domEvent:t,mousePos:new _e(n.clientX,n.clientY)}):(this.fire("dragstart",{domEvent:t,mousePos:this.startPos.copy()}),this.moved=!0))}},n.onMouseUp=function(t){var e=t.changedTouches?t.changedTouches[0]:t;this._offEvents();var n={domEvent:t};c(e.clientX)&&(n.mousePos=new _e(parseInt(e.clientX+"",0),parseInt(e.clientY+"",0))),this.moved&&(n.interupted=this.interupted,this.fire("dragend",n),delete this.interupted,delete this.moved),this.fire("mouseup",n)},n._offEvents=function(){var t=this.dom;if(sr(t,"mouseleave",this.onMouseUp),"undefined"!=typeof document&&"undefined"!=typeof window){for(var e in uh)sr(document,uh[e],this.onMouseMove),sr(document,fh[e],this.onMouseUp);t.releaseCapture?t.releaseCapture():window.captureEvents&&window.captureEvents()}},e}(Jl),gh=function(t){function e(){return t.apply(this,arguments)||this}he(e,t),e.toNumberArrays=function(t){return Array.isArray(t)?Fe(t,(function(t){return t.toArray()})):t.toArray()},e.toCoordinates=function(t){if(c(t[0])&&c(t[1]))return new e(t);if(t instanceof e)return t;for(var n=[],i=0,o=t.length;i<o;i++){var s=t[i];Array.isArray(s)?c(s[0])?n.push(new e(s)):n.push(e.toCoordinates(s)):n.push(s instanceof e?s:new e(s))}return n};var n=e.prototype;return n.closeTo=function(t,e){return e||(e=0),this.x>=t.x-e&&this.x<=t.x+e&&this.y>=t.y-e&&this.y<=t.y+e},n.abs=function(){return new e(Math.abs(this.x),Math.abs(this.y))},n.round=function(){return new e(Math.round(this.x),Math.round(this.y))},n.ceil=function(){return new e(Math.ceil(this.x),Math.ceil(this.y))},n.floor=function(){return new e(Math.floor(this.x),Math.floor(this.y))},n.copy=function(){return new e(this.x,this.y,this.z)},n.toFixed=function(t){return new e(this.x.toFixed(t),this.y.toFixed(t),c(this.z)?this.z.toFixed(t):void 0)},n.add=function(t,n,i){var o,s,a=this.z;return h(t.x)?h(t[0])?(o=this.x+t,s=this.y+n,h(i)||(a=(this.z||0)+i)):(o=this.x+t[0],s=this.y+t[1],h(t[2])||(a=(this.z||0)+t[2])):(o=this.x+t.x,s=this.y+t.y,h(t.z)||(a=(this.z||0)+t.z)),new e(o,s,a)},n.sub=function(t,n,i){var o,s,a=this.z;return h(t.x)?h(t[0])?(o=this.x-t,s=this.y-n,h(i)||(a=(this.z||0)-i)):(o=this.x-t[0],s=this.y-t[1],h(t[2])||(a=(this.z||0)-t[2])):(o=this.x-t.x,s=this.y-t.y,h(t.z)||(a=(this.z||0)-t.z)),new e(o,s,a)},n.multi=function(t){return new e(this.x*t,this.y*t,h(this.z)?this.z:this.z*t)},n.equals=function(t){return t instanceof this.constructor&&(this.x===t.x&&this.y===t.y&&this.z===t.z)},e}(ye),ph=function(){function t(t,e){this.type=t,this.properties=e}return t.createProj4=function(e){return new t("proj4",{proj:e})},t.fromProjectionCode=function(e){return e&&t[e=e.toUpperCase().replace(":","")]||null},t}();ph.WGS84=ph.createProj4("+proj=longlat +datum=WGS84 +no_defs"),ph.EPSG3857=ph.createProj4("+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs"),ph.IDENTITY=ph.createProj4("+proj=identity +no_defs"),ph.CGCS2000=ph.createProj4("+proj=longlat +datum=CGCS2000"),ph.EPSG4490=ph.CGCS2000,ph.BD09LL=ph.createProj4("+proj=longlat +datum=BD09"),ph.GCJ02=ph.createProj4("+proj=longlat +datum=GCJ02");var Ah,mh=new _e(0,0),yh=new gh(0,0),_h=new gh(0,0),vh=new gh(0,0),xh=new gh(0,0),bh=new gh(0,0),wh=new gh(0,0),Th=new gh(0,0),Mh=new gh(0,0),Ch=[],Sh=[],Ph=function(){function t(...t){this._clazz=gh;var e=t.length,n=e>0?t[e-1]:null;n&&n.unproject&&(this.projection=t[e-1]),this._dirty=!0,this.antiMeridian=!1,this._initialize(t[0],t[1],t[2],t[3])}var e=t.prototype;return e._initialize=function(t,e,n,i){if(this.xmin=null,this.xmax=null,this.ymin=null,this.ymax=null,!h(t)){var o=this.projection;if(c(t)&&c(e)&&c(n)&&c(i))o?this.set(t,e,n,i):this.set(Math.min(t,n),Math.min(e,i),Math.max(t,n),Math.max(e,i));else if(Array.isArray(t))o?this.set(t[0],t[1],t[2],t[3]):this.set(Math.min(t[0],t[2]),Math.min(t[1],t[3]),Math.max(t[0],t[2]),Math.max(t[1],t[3]));else if(c(t.x)&&c(e.x)&&c(t.y)&&c(e.y)){var s=t,a=e;o?this.set(s.x,s.y,a.x,a.y):(s.x>a.x?(this.xmin=a.x,this.xmax=s.x):(this.xmin=s.x,this.xmax=a.x),s.y>a.y?(this.ymin=a.y,this.ymax=s.y):(this.ymin=s.y,this.ymax=a.y))}else c(t.xmin)&&c(t.xmax)&&c(t.ymin)&&c(t.ymax)&&this.set(t.xmin,t.ymin,t.xmax,t.ymax)}},e._add=function(t){return this._dirty=!0,h(t.x)?h(t.xmin)?h(t[0])||(this.xmin+=t[0],this.ymin+=t[1],this.xmax+=t[0],this.ymax+=t[1]):(this.xmin+=t.xmin,this.ymin+=t.ymin,this.xmax+=t.xmax,this.ymax+=t.ymax):(this.xmin+=t.x,this.ymin+=t.y,this.xmax+=t.x,this.ymax+=t.y),this},e.add=function(t){return new this.constructor(this.xmin,this.ymin,this.xmax,this.ymax,this.projection)._add(t)},e._scale=function(t){return this._dirty=!0,this.xmin*=t,this.ymin*=t,this.xmax*=t,this.ymax*=t,this},e._sub=function(t){return this._dirty=!0,h(t.x)?h(t.xmin)?h(t[0])||(this.xmin-=t[0],this.ymin-=t[1],this.xmax-=t[0],this.ymax-=t[1]):(this.xmin-=t.xmin,this.ymin-=t.ymin,this.xmax-=t.xmax,this.ymax-=t.ymax):(this.xmin-=t.x,this.ymin-=t.y,this.xmax-=t.x,this.ymax-=t.y),this},e._substract=function(t){return this._sub(t)},e.sub=function(t){return new this.constructor(this.xmin,this.ymin,this.xmax,this.ymax,this.projection)._sub(t)},e.substract=function(t){return this.sub(t)},e.round=function(){return new this.constructor(Math.round(this.xmin),Math.round(this.ymin),Math.round(this.xmax),Math.round(this.ymax),this.projection)},e._round=function(){return this._dirty=!0,this.xmin=Math.round(this.xmin),this.ymin=Math.round(this.ymin),this.xmax=Math.round(this.xmax),this.ymax=Math.round(this.ymax),this},e.getMin=function(t){return t?(t.set(this.xmin,this.ymin),t):new this._clazz(this.xmin,this.ymin)},e.getMax=function(t){return t?(t.set(this.xmax,this.ymax),t):new this._clazz(this.xmax,this.ymax)},e.getCenter=function(t){var e=(this.xmin+this.xmax)/2,n=(this.ymin+this.ymax)/2;return t?(t.set(e,n),t):new this._clazz(e,n)},e.isValid=function(){return!(h(this.xmin)||h(this.ymin)||h(this.xmax)||h(this.ymax))},e.equals=function(t){return this.xmin===t.xmin&&this.xmax===t.xmax&&this.ymin===t.ymin&&this.ymax===t.ymax},e.intersects=function(t){this._project(this),this._project(t);var e=Math.max(this.pxmin,t.pxmin),n=Math.max(this.pymin,t.pymin),i=Math.min(this.pxmax,t.pxmax),o=Math.min(this.pymax,t.pymax);return!(e>i||n>o)},e.within=function(t){return this._project(this),this._project(t),this.pxmin>=t.pxmin&&this.pxmax<=t.pxmax&&this.pymin>=t.pymin&&this.pymax<=t.pymax},e.contains=function(t){if(!t)return!1;this._project(this);var e=this.projection;if(e){var n=yh;Array.isArray(t)?(n.x=t[0],n.y=t[1],t=e.project(n,n)):void 0!==t.x?(n.x=t.x,n.y=t.y,t=e.project(n,n)):void 0!==t.xmin&&this._project(t)}return(t.x||t.pxmin||0)>=this.pxmin&&(t.x||t.pxmax||0)<=this.pxmax&&(t.y||t.pymin||0)>=this.pymin&&(t.y||t.pymax||0)<=this.pymax},e.getWidth=function(){return Math.abs(this.xmax-this.xmin)},e.getHeight=function(){return Math.abs(this.ymax-this.ymin)},e.getSize=function(){return new qn(this.getWidth(),this.getHeight())},e.set=function(t,e,n,i){return this.xmin=t,this.ymin=e,this.xmax=n,this.ymax=i,this._dirty=!0,this},e.__combine=function(t){var e,n,i,o;void 0!==t.x&&(Ah.xmin=Ah.xmax=t.x,Ah.ymin=Ah.ymax=t.y,Ah._dirty=!0,t=Ah),this._project(t),this._project(this),c(this.pxmin)?(e=Math.min(this.pxmin,t.pxmin),n=Math.min(this.pymin,t.pymin),i=Math.max(this.pxmax,t.pxmax),o=Math.max(this.pymax,t.pymax)):(e=t.pxmin,n=t.pymin,i=t.pxmax,o=t.pymax);var s=this.projection;if(s){_h.set(e,n),vh.set(i,o);var a=s.unproject(_h,_h),l=s.unproject(vh,vh);e=a.x,n=a.y,i=l.x,o=l.y}return Sh[0]=e,Sh[1]=n,Sh[2]=i,Sh[3]=o,Sh},e._combine=function(t){if(!t||t.isValid&&!t.isValid())return this;var e=this.__combine(t);return this.set(e[0],e[1],e[2],e[3]),this._dirty=!0,this},e.combine=function(t){if(!t||t.isValid&&!t.isValid())return this;var e=this.__combine(t);return new this.constructor(e[0],e[1],e[2],e[3],this.projection)},e.intersection=function(t){if(!this.intersects(t))return null;xh.x=Math.max(this.pxmin,t.pxmin),xh.y=Math.max(this.pymin,t.pymin),bh.x=Math.min(this.pxmax,t.pxmax),bh.y=Math.min(this.pymax,t.pymax);var e=xh,n=bh,i=this.projection;return i&&(e=i.unproject(e,e),n=i.unproject(n,n)),new this.constructor(e,n,i)},e.expand=function(t){var e,n;return c(t)?e=n=t:(e=t.width||t.x||t[0]||0,n=t.height||t.y||t[1]||0),new this.constructor(this.xmin-e,this.ymin-n,this.xmax+e,this.ymax+n,this.projection)},e._expand=function(t){var e,n;return c(t)?e=n=t:(e=t.width||t.x||t[0]||0,n=t.height||t.y||t[1]||0),this.xmin-=e,this.ymin-=n,this.xmax+=e,this.ymax+=n,this._dirty=!0,this},e.toJSON=function(){return{xmin:this.xmin,ymin:this.ymin,xmax:this.xmax,ymax:this.ymax}},e.toArray=function(t){var e=this.xmin,n=this.ymin,i=this.xmax,o=this.ymax;return t?(t[0].x=e,t[0].y=o,t[1].x=i,t[1].y=o,t[2].x=i,t[2].y=n,t[3].x=e,t[3].y=n,t[4].x=e,t[4].y=o,t):[new this._clazz([e,o]),new this._clazz([i,o]),new this._clazz([i,n]),new this._clazz([e,n]),new this._clazz([e,o])]},e.toString=function(){return this.xmin+","+this.ymin+","+this.xmax+","+this.ymax},e.copy=function(){return new this.constructor(this.xmin,this.ymin,this.xmax,this.ymax,this.projection)},e.convertTo=function(t,e){if(!this.isValid())return null;var n,i=e||new this.constructor;return e&&i.set(null,null,null,null),this._clazz===gh?n=wh:this._clazz===_e&&(n=mh),n.x=this.xmin,n.y=this.ymax,i._combine(t(n)),n.x=this.xmax,i._combine(t(n)),n.y=this.ymin,i._combine(t(n)),n.x=this.xmin,i._combine(t(n)),i},e._project=function(t){if(t&&t.isValid()){var e=this.projection;if(e){if(t._dirty){Th.set(t.xmin,t.ymin),Mh.set(t.xmax,t.ymax),Ch[0]=Th,Ch[1]=Mh;var n=e.projectCoords(Ch,this.antiMeridian),i=n[0],o=n[1];t.pxmin=Math.min(i.x,o.x),t.pymin=Math.min(i.y,o.y),t.pxmax=Math.max(i.x,o.x),t.pymax=Math.max(i.y,o.y)}delete t._dirty}else t.pxmin=t.xmin,t.pxmax=t.xmax,t.pymin=t.ymin,t.pymax=t.ymax}else t&&(t.pxmin=t.pxmax=t.pymin=t.pymax=null)},t}();Ah=new Ph(0,0,0,0);var Ih,Oh=function(t){function e(...e){var n;return(n=t.call(this,...e)||this)._clazz=_e,n}return he(e,t),e}(Ph),Eh=function(){function t(t){this.matrix=t}var e=t.prototype;return e.transform=function(t,e,n){var i=this.matrix[0]*(t.x-this.matrix[2])/e,o=-this.matrix[1]*(t.y-this.matrix[3])/e;return n?(n.x=i,n.y=o,n):new _e(i,o)},e.untransform=function(t,e,n){var i=t.x*e/this.matrix[0]+this.matrix[2],o=t.y*e/-this.matrix[1]+this.matrix[3];return n?(n.x=i,n.y=o,n):new gh(i,o)},t}(),kh={code:"",is:function(t){if(this.code===t)return!0;if(!this.aliases)return!1;for(var e=0;e<this.aliases.length;e++)if(this.aliases[e]===t)return!0;return!1},project:function(t){return t},unproject:function(t){return t},projectCoords:function(t,e){var n=this;if(!t)return[];if(!Array.isArray(t))return this.project(t);if(0===t.length)return[];if(!this.isSphere())return Fe(t,this.project,this);if(Array.isArray(t[0]))return t.map((function(t){return n.projectCoords(t,e)}));for(var i,o,s,a,l,h=e,c=this.getCircum(),u=this.getSphereExtent().sy,f=t[0],g=[this.project(f)],A=1,m=t.length;A<m;A++){s=(o=t[A]).x-f.x,a=o.y-f.y,l=this.project(o);var w=!1;Math.abs(s)>180&&h&&(o.x=s<0?360-Math.abs(o.x):-180-(180-Math.abs(o.x)),w=!0),Math.abs(a)>90&&h&&(void 0===i&&(i=o.y<f.y),i&&(l._add(0,-c.y*Ge(a)*u),o._add(0,-180*Ge(a)))),w&&(l=this.project(o)),f=o,g.push(l)}return g},unprojectCoords:function(t){return t?Array.isArray(t)?Fe(t,this.unproject,this):this.unproject(t):[]},isSphere:function(){return!!this.sphere},isOutSphere:function(t){return!!this.isSphere()&&!this.getSphereExtent().contains(t)},wrapCoord:function(t){if(!this.isSphere())return t;var e=this.getSphereExtent(),n=new gh(t);return e.contains(n)||(n.x=We(t.x,e.xmin,e.xmax),n.y=We(t.y,e.ymin,e.ymax)),n},getCircum:function(){if(!this.circum&&this.isSphere()){var t=this.getSphereExtent();this.circum={x:t.getWidth(),y:t.getHeight()}}return this.circum},getSphereExtent:function(){if(!this.extent&&this.isSphere()){var t=this.project(new gh(180,90)),e=this.project(new gh(-180,-90));this.extent=new Ph(e,t,this),this.extent.sx=t.x>e.x?1:-1,this.extent.sy=t.y>e.y?1:-1}return this.extent}},Rh={measureLength:function(t,e){if(!Array.isArray(t))return this.measureLenBetween(t,e);for(var n=0,i=0,o=t.length;i<o-1;i++)n+=this.measureLenBetween(t[i],t[i+1]);return n}},Lh={measure:"IDENTITY",measureLenBetween:function(t,e,n=!1){if(!t||!e)return 0;try{var i=Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2));if(n)return i;var o=(t.z||0)-(e.z||0);return 0===o?i:Math.sqrt(i*i+o*o)}catch(t){return 0}},measureArea:function(t){if(!Array.isArray(t))return 0;for(var e=0,n=0,i=t.length;n<i;n++){var o=t[n],s=null;e+=o.x*(s=n===i-1?t[0]:t[n+1]).y-o.y*s.x}return Math.abs(e/2)},locate:function(t,e,n,i){return(i=i||new gh(0,0)).set(t.x,t.y),this._locate(i,e,n)},_locate:function(t,e,n){return t?(e||(e=0),n||(n=0),e||n?(t.x=t.x+e,t.y=t.y+n,t):t):null},rotate:function(t,e,n){return t=new gh(t.x,t.y),this._rotate(t,e,n)},_rotate:(Ih=new _e(0,0),function(t,e,n){return Ih.x=t.x-e.x,Ih.y=t.y-e.y,Ih._rotate(n*Math.PI/180),t.x=e.x+Ih.x,t.y=e.y+Ih.y,t})},Dh=l(Lh,Rh),Fh=function(){function t(t){this.radius=t}var e=t.prototype;return e.measureLenBetween=function(t,e,n=!1){if(!t||!e)return 0;var i=M(t.y),o=M(e.y),s=i-o,a=M(t.x)-M(e.x);i=2*Math.asin(Math.sqrt(Math.pow(Math.sin(s/2),2)+Math.cos(i)*Math.cos(o)*Math.pow(Math.sin(a/2),2)));i*=this.radius;if(n)return i;var l=(t.z||0)-(e.z||0);return 0===l?i:Math.sqrt(i*i+l*l)},e.measureArea=function(t){var e,n=M(this.radius),i=0,o=t,s=o.length;if(s<3)return 0;for(e=0;e<s-1;e++){var a=o[e],l=o[e+1];i+=a.x*n*Math.cos(M(a.y))*l.y*n-l.x*n*Math.cos(M(l.y))*a.y*n}var h=o[e],c=o[0];return i+=h.x*n*Math.cos(M(h.y))*c.y*n-c.x*n*Math.cos(M(c.y))*h.y*n,.5*Math.abs(i)},e.locate=function(t,e,n,i){return(i=i||new gh(0,0)).set(t.x,t.y),this._locate(i,e,n)},e._locate=function(t,e,n){if(!t)return null;if(e||(e=0),n||(n=0),!e&&!n)return t;var i,o,s=M(t.y);if(0!==n){var a=Math.abs(n);o=We(180*(s+=2*Math.sin(a/(2*this.radius))*(n>0?1:-1))/Math.PI,-90,90)}else o=t.y;if(0!==e){var l=Math.abs(e),h=M(t.x);i=We(180*(h+=2*Math.sqrt(Math.pow(Math.sin(l/(2*this.radius)),2)/Math.pow(Math.cos(s),2))*(e>0?1:-1))/Math.PI,-180,180)}else i=t.x;return t.x=i,t.y=o,t},e.rotate=function(t,e,n){var i=new gh(t);return this._rotate(i,e,n)},e._rotate=function(t,e,n){var i=function(t,e,n={}){var i;i=n.final?Nh(e,t):Nh(t,e);return i>180?-(360-i):i}(e,t),o=i-n,s=this.measureLenBetween(e,t,!0);return t.x=e.x,t.y=e.y,function(t,e,n,i){var o=e/i,s=t.x*Math.PI/180,a=M(t.y),l=M(n),h=o*Math.cos(l),c=a+h;Math.abs(c)>Math.PI/2&&(c=c>0?Math.PI-c:-Math.PI-c);var u=Math.log(Math.tan(c/2+Math.PI/4)/Math.tan(a/2+Math.PI/4)),f=Math.abs(u)>1e-11?h/u:Math.cos(a),g=o*Math.sin(l)/f;return t.x=(180*(s+g)/Math.PI+540)%360-180,t.y=180*c/Math.PI,t}(t,s,o,this.radius)},t}();function Nh(t,e){var n=M(t.y),i=M(e.y),o=M(e.x-t.x);o>Math.PI&&(o-=2*Math.PI),o<-Math.PI&&(o+=2*Math.PI);var s=Math.log(Math.tan(i/2+Math.PI/4)/Math.tan(n/2+Math.PI/4));return(C(Math.atan2(o,s))+360)%360}var Hh={measure:"EPSG:4326",sphere:new Fh(6378137),measureLenBetween:function(t,e){return this.sphere.measureLenBetween(t,e)},measureArea:function(t){return this.sphere.measureArea.call(this.sphere,t)},_locate:function(t,e,n){return this.sphere._locate.call(this.sphere,t,e,n)},locate:function(t,e,n,i){return this.sphere.locate.call(this.sphere,t,e,n,i)},_rotate:function(t,e,n){return this.sphere._rotate.call(this.sphere,t,e,n)},rotate:function(t,e,n){return this.sphere.rotate.call(this.sphere,t,e,n)}},Bh=l(Hh,Rh),zh={measure:"BAIDU",sphere:new Fh(6370996.81),measureLenBetween:function(t,e){return this.sphere.measureLenBetween.call(this.sphere,t,e)},measureArea:function(t){return this.sphere.measureArea.call(this.sphere,t)},_locate:function(t,e,n){return this.sphere._locate.call(this.sphere,t,e,n)},locate:function(t,e,n,i){return this.sphere.locate.call(this.sphere,t,e,n,i)},_rotate:function(t,e,n){return this.sphere._rotate.call(this.sphere,t,e,n)},rotate:function(t,e,n){return this.sphere.rotate.call(this.sphere,t,e,n)}},Gh=l(zh,Rh),jh=Bh,Uh={};function Vh(t){Uh[t.measure]=t}Vh(Dh),Vh(Bh),Vh(Gh);var Wh={getInstance:function(t){if(!t)return jh;for(var e in Uh)if(w(Uh,e)){var n=Uh[e].measure;if(!n)continue;if(t.toLowerCase()===n.toLowerCase())return Uh[e]}return null}},Zh=Object.freeze({__proto__:null,BaiduSphere:Gh,DEFAULT:jh,Identity:Dh,Measurer:Wh,WGS84Sphere:Bh}),qh={code:"EPSG:3857",rad:Math.PI/180,metersPerDegree:6378137*Math.PI/180,maxLatitude:85.0511287798,project:function(t,e){var n=this.rad,i=this.metersPerDegree,o=this.maxLatitude,s=t.x,a=Math.max(Math.min(o,t.y),-o),l=s*i,h=(0===a?0:Math.log(Math.tan((90+a)*n/2))/n)*i,c=t.z;return e?(e.x=l,e.y=h,e.z=c,e):new gh(l,h,c)},unproject:function(t,e){var n,i=this.rad,o=this.metersPerDegree,s=t.x/o,a=t.y;0===a?n=0:(n=a/o,n=(2*Math.atan(Math.exp(n*i))-Math.PI/2)/i),Math.abs(Math.abs(s)-180)<1e-7&&(s=180*Ge(s)),Math.abs(Math.abs(n)-this.maxLatitude)<1e-7&&(n=Ge(n)*this.maxLatitude);var l=s,h=n,c=t.z;return e?(e.x=l,e.y=h,e.z=c,e):new gh(l,h,c)}},Xh=l({},kh,qh,Bh),Jh={code:"EPSG:4326",aliases:["EPSG:4490"],project:function(t,e){return e?(e.x=t.x,e.y=t.y,e.z=t.z,e):new gh(t)},unproject:function(t,e){return e?(e.x=t.x,e.y=t.y,e.z=t.z,e):new gh(t)}},Qh=l({},kh,Jh,Bh),Yh=Math.abs,Kh=Math.sin,$h=Math.cos,tc=Math.tan,ec=Math.atan,nc=Math.atan2,ic=Math.sqrt,rc=Math.log,oc=Math.hypot,sc=Math.sinh,ac=Math.cosh,lc=1/0;function hc(t){var e,n,i,o,s,a,l=[],h=[],c=[],u=[];function f(t,e){for(var n,i=2*$h(2*e),o=t.length-1,s=t[o],a=0;--o>=0;)n=i*s-a+t[o],a=s,s=n;return e+n*Kh(2*e)}function g(t,e,n){for(var i,o,s=Kh(e),a=$h(e),l=sc(n),h=ac(n),c=2*a*h,u=-2*s*l,f=t.length-1,g=t[f],A=0,m=0,w=0;--f>=0;)i=m,o=A,g=c*(m=g)-i-u*(A=w)+t[f],w=u*m-o+c*A;return[(c=s*h)*g-(u=a*l)*w,c*w+u*g]}s=o=(i=t.es/(1+ic(1-t.es)))/(2-i),l[0]=o*(2+o*(-2/3+o*(o*(116/45+o*(26/45+o*(-2854/675)))-2))),h[0]=o*(o*(2/3+o*(4/3+o*(-82/45+o*(32/45+o*(4642/4725)))))-2),l[1]=(s*=o)*(7/3+o*(o*(-227/45+o*(2704/315+o*(2323/945)))-1.6)),h[1]=s*(5/3+o*(-16/15+o*(-13/9+o*(904/315+o*(-1522/945))))),l[2]=(s*=o)*(56/15+o*(-136/35+o*(-1262/105+o*(73814/2835)))),h[2]=s*(-26/15+o*(34/21+o*(1.6+o*(-12686/2835)))),l[3]=(s*=o)*(4279/630+o*(-332/35+o*(-399572/14175))),h[3]=s*(1237/630+o*(o*(-24832/14175)-2.4)),l[4]=(s*=o)*(4174/315+o*(-144838/6237)),h[4]=s*(-734/315+o*(109598/31185)),l[5]=(s*=o)*(601676/22275),h[5]=s*(444337/155925),e=t.k0/(1+o)*(1+(s=o*o)*(1/4+s*(1/64+s/256))),c[0]=o*(o*(2/3+o*(-37/96+o*(1/360+o*(81/512+o*(-96199/604800)))))-.5),u[0]=o*(.5+o*(-2/3+o*(5/16+o*(41/180+o*(-127/288+o*(7891/37800)))))),c[1]=s*(-1/48+o*(-1/15+o*(437/1440+o*(-46/105+o*(1118711/3870720))))),u[1]=s*(13/48+o*(o*(557/1440+o*(281/630+o*(-1983433/1935360)))-.6)),c[2]=(s*=o)*(-17/480+o*(37/840+o*(209/4480+o*(-5569/90720)))),u[2]=s*(61/240+o*(-103/140+o*(15061/26880+o*(167603/181440)))),c[3]=(s*=o)*(-4397/161280+o*(11/504+o*(830251/7257600))),u[3]=s*(49561/161280+o*(-179/168+o*(6601661/7257600))),c[4]=(s*=o)*(-4583/161280+o*(108847/3991680)),u[4]=s*(34729/80640+o*(-3418889/1995840)),c[5]=(s*=o)*(-20648693/638668800),u[5]=.6650675310896665*s,a=f(h,t.phi0),n=-e*(a+function(t,e){var n,i=2*$h(e),o=t.length-1,s=t[o],a=0;for(;--o>=0;)n=i*s-a+t[o],a=s,s=n;return Kh(e)*n}(u,2*a)),t.fwd=function(t,i){var o,s,a,l,c,A=t.phi,m=t.lam;A=f(h,A),o=Kh(A),s=$h(A),l=Kh(m),a=$h(m),A=nc(o,a*s),m=nc(l*s,oc(o,s*a)),m=function(t){var e=Yh(t);return e=function(t){var e=1+t,n=e-1;return 0===n?t:t*rc(e)/n}(e*(1+e/(oc(1,e)+1))),t<0?-e:e}(tc(m)),c=g(u,2*A,2*m),A+=c[0],m+=c[1],Yh(m)<=2.623395162778?(i.y=e*A+n,i.x=e*m):i.x=i.y=lc},t.inv=function(t,i){var o,s,a,h,u,A=t.y,m=t.x;A=(A-n)/e,m/=e,Yh(m)<=2.623395162778?(A+=(u=g(c,2*A,2*m))[0],m=ec(sc(m+=u[1])),o=Kh(A),s=$h(A),h=Kh(m),a=$h(m),m=nc(h,a*s),A=nc(o*a,oc(h,a*s)),i.phi=f(l,A),i.lam=m):i.phi=i.lam=lc}}var cc=57.29577951308232,uc=.017453292519943295,fc=["Traverse_Mercator"],dc={code:"EPSG:9807",aliases:fc,centralMeridian:0,create:function(t){var e={a:6378137,es:.0066943799901413165,x0:h(t.falseEasting)?5e5:t.falseEasting,y0:h(t.falseNorthing)?0:t.falseNorthing,k0:t.scaleFactor||.9996,lam0:(t.centralMeridian||0)*uc,phi0:(t.latitudeOfOrigin||0)*uc,originLam0:t.startLongtitude||0,originPhi0:t.startLatitude||0};hc(e);var n={lam:0,phi:0},i={},o=0,s=0;(e.originLam0||e.originPhi0)&&(n.lam=e.originLam0*uc-e.lam0,n.phi=e.originPhi0*uc,e.fwd(n,i),o=e.a*i.x+e.x0,s=e.a*i.y+e.y0);var a={code:"EPSG:9807",aliases:fc,centralMeridian:t.centralMeridian,project:function(t,a){n.lam=t.x*uc-e.lam0,n.phi=t.y*uc,e.fwd(n,i);var l=e.a*i.x+e.x0-o,h=e.a*i.y+e.y0-s,c=t.z;return a?(a.x=l,a.y=h,a.z=c,a):new gh(l,h,c)},unproject:function(t,a){i.x=(t.x-e.x0+o)/e.a,i.y=(t.y-e.y0+s)/e.a,e.inv(i,n);var l=(n.lam+e.lam0)*cc,h=n.phi*cc,c=t.z;return a?(a.x=l,a.y=h,a.z=c,a):new gh(l,h,c)}};return l({},kh,a,Bh)}},gc=l({},kh,dc),pc={code:"utm",aliases:[],create:function(t){var e={},n=parseInt(t.zone);if(e.falseNorthing=t.south?1e7:0,e.falseEasting=5e5,!(n>0&&n<=60))throw new Error("zone must be > 0 and <= 60.");return n--,e.centralMeridian=6*(n+.5)-180,e.scaleFactor=.9996,gc.create(e)}},Ac=l({},gc,pc),mc={EARTHRADIUS:6370996.81,MCBAND:[12890594.86,8362377.87,5591021,3481989.83,1678043.12,0],LLBAND:[75,60,45,30,15,0],MC2LL:[[1.410526172116255e-8,898305509648872e-20,-1.9939833816331,200.9824383106796,-187.2403703815547,91.6087516669843,-23.38765649603339,2.57121317296198,-.03801003308653,17337981.2],[-7.435856389565537e-9,8983055097726239e-21,-.78625201886289,96.32687599759846,-1.85204757529826,-59.36935905485877,47.40033549296737,-16.50741931063887,2.28786674699375,10260144.86],[-3.030883460898826e-8,898305509983578e-20,.30071316287616,59.74293618442277,7.357984074871,-25.38371002664745,13.45380521110908,-3.29883767235584,.32710905363475,6856817.37],[-1.981981304930552e-8,8983055099779535e-21,.03278182852591,40.31678527705744,.65659298677277,-4.44255534477492,.85341911805263,.12923347998204,-.04625736007561,4482777.06],[3.09191371068437e-9,8983055096812155e-21,6995724062e-14,23.10934304144901,-.00023663490511,-.6321817810242,-.00663494467273,.03430082397953,-.00466043876332,2555164.4],[2.890871144776878e-9,8983055095805407e-21,-3.068298e-8,7.47137025468032,-353937994e-14,-.02145144861037,-1234426596e-14,.00010322952773,-323890364e-14,826088.5]],LL2MC:[[-.0015702102444,111320.7020616939,0x60e374c3105a3,-0x24bb4115e2e164,0x5cc55543bb0ae8,-0x7ce070193f3784,0x5e7ca61ddf8150,-0x261a578d8b24d0,0x665d60f3742ca,82.5],[.0008277824516172526,111320.7020463578,647795574.6671607,-4082003173.641316,10774905663.51142,-15171875531.51559,12053065338.62167,-5124939663.577472,913311935.9512032,67.5],[.00337398766765,111320.7020202162,4481351.045890365,-23393751.19931662,79682215.47186455,-115964993.2797253,97236711.15602145,-43661946.33752821,8477230.501135234,52.5],[.00220636496208,111320.7020209128,51751.86112841131,3796837.749470245,992013.7397791013,-1221952.21711287,1340652.697009075,-620943.6990984312,144416.9293806241,37.5],[-.0003441963504368392,111320.7020576856,278.2353980772752,2485758.690035394,6070.750963243378,54821.18345352118,9540.606633304236,-2710.55326746645,1405.483844121726,22.5],[-.0003218135878613132,111320.7020701615,.00369383431289,823725.6402795718,.46104986909093,2351.343141331292,1.58060784298199,8.77738589078284,.37238884252424,7.45]],convertMC2LL:function(t,e){for(var n,i=0,o=this.MCBAND.length;i<o;i++)if(Math.abs(t.y)>=this.MCBAND[i]){n=this.MC2LL[i];break}return this.convertor(t,n,e)},convertLL2MC:function(t,e){var n,i,o;t.x=this.getLoop(t.x,-180,180),t.y=this.getRange(t.y,-74,74);var s=new gh(t.x,t.y);for(i=0,o=this.LLBAND.length;i<o;i++)if(s.y>=this.LLBAND[i]){n=this.LL2MC[i];break}if(!n)for(i=this.LLBAND.length-1;i>=0;i--)if(s.y<=-this.LLBAND[i]){n=this.LL2MC[i];break}return this.convertor(t,n,e)},convertor:function(t,e,n){if(!t||!e)return null;var i=e[0]+e[1]*Math.abs(t.x),o=Math.abs(t.y)/e[9],s=e[2]+e[3]*o+e[4]*o*o+e[5]*o*o*o+e[6]*o*o*o*o+e[7]*o*o*o*o*o+e[8]*o*o*o*o*o*o;i*=t.x<0?-1:1,s*=t.y<0?-1:1;var a=t.z;return n?(n.x=i,n.y=s,n.z=a,n):new gh(i,s,a)},toRadians:function(t){return Math.PI*t/180},toDegrees:function(t){return 180*t/Math.PI},getRange:function(t,e,n){return null!=e&&(t=Math.max(t,e)),null!=n&&(t=Math.min(t,n)),t},getLoop:function(t,e,n){if(t===1/0)return n;if(t===-1/0)return e;for(;t>n;)t-=n-e;for(;t<e;)t+=n-e;return t}},yc=l({},kh,{code:"BAIDU",project:function(t,e){return this.convertLL2MC(t,e)},unproject:function(t,e){return this.convertMC2LL(t,e)}},Gh,mc),_c=l({},kh,{code:"IDENTITY",project:function(t,e){return e?(e.x=t.x,e.y=t.y,e.z=t.z,e):t.copy()},unproject:function(t,e){return e?(e.x=t.x,e.y=t.y,e.z=t.z,e):t.copy()}},Dh),vc=Xh,xc=Object.freeze({__proto__:null,BAIDU:yc,Common:kh,DEFAULT:vc,EPSG3857:Xh,EPSG4326:Qh,EPSG9807:gc,IDENTITY:_c,UTM:Ac});function bc(t){return function(t){function e(){return t.apply(this,arguments)||this}return he(e,t),e.registerRenderer=function(t,e){var n=this.prototype,i=Object.getPrototypeOf(n);return n._rendererClasses&&n._rendererClasses!==i._rendererClasses||(n._rendererClasses=n._rendererClasses?Object.create(n._rendererClasses):{}),n._rendererClasses[t.toLowerCase()]=e,this},e.getRendererClass=function(t){var e=this.prototype;return e._rendererClasses?e._rendererClasses[t.toLowerCase()]:null},e}(t)}var wc={markerWidth:10,markerHeight:10,markerLineWidth:1},Tc=new _e(0,0);function Mc(t,e,n,i,o,s){var a=o.x+s.x,l=o.y+s.y;Tc.x=a,Tc.y=l;var h=function(t){if(!t)return 0;var{x:e,y:n}=t;if(0===e&&0===n)return 0;if(0===e||!e){if(n<0)return-Math.PI/2;if(n>0)return Math.PI/2}var i=n/e;return n<0&&e<0?Math.atan(i)-Math.PI:n>0&&e<0?Math.atan(i)+Math.PI:Math.atan(i)}(Tc),c=Math.sqrt(a*a+l*l),u=0,f=0;u+=Math.cos(e+h)*c,f+=Math.sin(e+h)*c;var[g,A,m,w]=function(t,e,n){var i=Math.PI/2+n,o=Math.PI/4+n,s=n,a=e,l=Math.sqrt(t*t+e*e),h=t,c=Math.cos(i)*a,u=Math.sin(i)*a,f=Math.cos(o)*l,g=Math.sin(o)*l,A=Math.cos(s)*h,m=Math.sin(s)*h,w=Math.min(c,f,A,0),T=Math.min(u,g,m,0);return[w,T,Math.max(c,f,A,0)-w,Math.max(u,g,m,0)-T]}(n,i,e);f+=A;var T=(u+=g)+Math.max(n,m),M=f+Math.max(i,w);return t.set(u,f,T,M),t}var Cc=new _e(0,0);function Sc(t,e,n,i,o,s,a){var l=Cc.set(e,n);if(i)return Mc(t,i,s,a,l,o);var h=t.set(l.x,l.y,l.x+s,l.y+a);return h._add(o),i&&function(t,e){var{xmin:n,ymin:i,xmax:o,ymax:s}=t;Dc.set(n,i,o,s),Dc.convertTo((function(t){return t._rotate(e)}),t)}(h,i),h}var Pc=[];function Ic(t,e,n){if((n=n||Lc(Pc,e))&&(0===n[0]||0===n[1]))return Xc(t),t;var i=Rc(e,n[0],n[1]);return Sc(t,e.markerDx||0,e.markerDy||0,Fc(e),i,n[0],n[1])}function Oc(t){return"rectangle"===t||"roundrectangle"===t?"right":"middle"}function Ec(t){return"bar"===t||"pie"===t||"pin"===t?"top":"rectangle"===t||"roundrectangle"===t?"bottom":"middle"}var kc=new qn(0,0);function Rc(t,e,n){var i=2*(t.shadowBlur||0)+.5;kc.width=e,kc.height=n;var o=t.markerType,s=gi(kc,t.markerHorizontalAlignment||Oc(o),t.markerVerticalAlignment||Ec(o));return s.x!==-e/2&&(s.x-=Ge(s.x+e/2)*i),s.y!==-n/2&&(s.y-=Ge(s.y+n/2)*i),s}function Lc(t,e){var n=He(e.markerWidth,wc.markerWidth),i=He(e.markerHeight,wc.markerHeight);if(0===n||0===i)return t[0]=0,t[1]=0,t;var o=He(e.markerLineWidth,wc.markerLineWidth),s=2*((e.shadowBlur||0)+Math.max(Math.abs(e.shadowOffsetX||0)+Math.abs(e.shadowOffsetY||0))),a=Math.round(n+o+s+1),l=Math.round(i+o+s+1);return t[0]=a,t[1]=l,t}var Dc=new Oh;function Fc(t,e="markerRotation"){var n=t[e];return c(n)?-n*Math.PI/180:0}function Nc(t,e,n){var i=n?n.getImage(e.markerFile):null,o=e.markerWidth||(i?i.width:0),s=e.markerHeight||(i?i.height:0);if(kc.width=o,kc.height=s,0===e.markerWidth||0===e.markerHeight)return Xc(t),t;var a=gi(kc,e.markerHorizontalAlignment||"middle",e.markerVerticalAlignment||"top");return Sc(t,e.markerDx||0,e.markerDy||0,Fc(e),a,o,s)}function Hc(t,e,n){var i=n.size;if(i&&(0===i.width||0===i.height))return Xc(t),t;var o=gi(i,e.textHorizontalAlignment,e.textVerticalAlignment),s=e.textHaloRadius||0,a=Sc(t,e.textDx||0,e.textDy||0,Fc(e,"textRotation"),o,i.width,i.height);return a.xmin-=s,a.xmax+=s,a.ymin-=s,a.ymax+=s,a}var Bc=new Oh;function zc(t,e,n,i){var o=t||new Oh;if(Array.isArray(e)){for(var s=e,a=0;a<s.length;a++)zc(o,s[a],n,i[a]);return o}return Gc(e)&&o._combine(Hc(Bc,e,i)),jc(e)&&o._combine(Nc(Bc,e,n)),Uc(e)&&o._combine(Ic(Bc,e)),Vc(e)&&o._combine(Nc(Bc,e)),o}function Gc(t){return!!t&&!h(t.textName)}function jc(t){return!!t&&!h(t.markerFile)}function Uc(t){return!!t&&!(!h(t.markerFile)||h(t.markerType)||"path"===t.markerType)}function Vc(t){return!!t&&!(!h(t.markerFile)||"path"!==t.markerType)}var Wc,Zc=["markerWidth","markerHeight","markerHorizontalAlignment","markerVerticalAlignment","markerDx","markerDy","markerRotation","textName","textSize","textDx","textDy","textVerticalAlignment","textHorizontalAlignment","textRotation","textWrapWidth"],qc=["textName","markerType","markerFile","textHaloRadius","shadowBlur","shadowOffsetX","shadowOffsetY","textWrapWidth"];function Xc(t){t&&(t.xmin=1/0,t.ymin=1/0,t.xmax=-1/0,t.ymax=-1/0)}function Jc(t,e,n,i){for(var o,s=[],a=0,l=0,h=t.length;l<h-1;l++)(o=Qc(t[l],t[l+1],e,l,n,i))&&(s[a]=s[a]||[],s[a].push({point:o[0],index:l}),o[1]===t[l+1]&&l!==h-2||(s[a].push({point:o[1],index:l+1}),a++));return s}function Qc(t,e,n,i,o,s){var a,l,h,c=i?Wc:$c(t,n),u=$c(e,n);for(Wc=u;;){if(!(c|u))return[t,e];if(c&u)return!1;if(s)return[t,e];h=$c(l=Kc(t,e,a=c||u,n,o),n),a===c?(t=l,c=h):(e=l,u=h)}}function Yc(t,e,n){var i,o,s,a,l,h,c,u,f,g=[1,4,2,8];for(o=0,c=t.length;o<c;o++)t[o]._code=$c(t[o],e);for(a=0;a<4;a++){for(u=g[a],i=[],o=0,s=(c=t.length)-1;o<c;s=o++)h=t[s],(l=t[o])._code&u?h._code&u||((f=Kc(h,l,u,e,n))._code=$c(f,e),i.push(f)):(h._code&u&&((f=Kc(h,l,u,e,n))._code=$c(f,e),i.push(f)),i.push(l));t=i}return t}function Kc(t,e,n,i,o){var s,a,l=e.x-t.x,h=e.y-t.y,c=i.getMin(),u=i.getMax();8&n?(s=t.x+l*(u.y-t.y)/h,a=u.y):4&n?(s=t.x+l*(c.y-t.y)/h,a=c.y):2&n?(s=u.x,a=t.y+h*(u.x-t.x)/l):1&n&&(s=c.x,a=t.y+h*(c.x-t.x)/l);var f=new _e(s,a);return o&&f._round(),f}function $c(t,e){var n=0;return t.x<e.getMin().x?n|=1:t.x>e.getMax().x&&(n|=2),t.y<e.getMin().y?n|=4:t.y>e.getMax().y&&(n|=8),n}function tu(t,e,n,i){t=new _e(t);var o,s,a,l=Math.abs(n.x-e.x),h=Math.abs(n.y-e.y),c=Math.sqrt(Math.abs(l*l-h*h));return l>=h?(o=new _e(e.x-c,e.y),s=new _e(e.x+c,e.y),a=2*l):(o=new _e(e.x,e.y-c),s=new _e(e.x,e.y+c),a=2*h),t.distanceTo(o)+t.distanceTo(s)<=a+2*i}function eu(t){if(!t)return[0,0];var e=1/0,n=-1/0;if(c(t))return[e=n=t,n];var i=function(t){for(var i=0,o=t.length;i<o;i++){var s=t[i];e=Math.min(e,s),n=Math.max(n,s)}};if(!Array.isArray(t[0]))return i(t),[e,n];for(var o=0,s=t.length;o<s;o++){i(t[o])}return[e,n]}var nu=function(){function t(){this.bbox=ws()}var e=t.prototype;return e._setBBOX=function(t,e,n,i,o){return t.isHitTesting||Is(this.bbox,e,n,i,o),this},e._bufferBBOX=function(t,e){return t.isHitTesting||Es(this.bbox,e),this},e.getMap=function(){return this.geometry.getMap()},e.getPainter=function(){return this.painter},e.isDynamicSize=function(){return!1},e.isVisible=function(){if(!this.style)return!0;var t=this.style.visible;return!1!==t&&0!==t&&!(this.style.opacity<=0)},t.testColor=function(t){return!(!t||!g(t))&&Vn.indexOf(t)>=0},t}(),iu=function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n._prepareContext=function(t){if(Kr(this.symbol.opacity)?this._opacityFn||(this._opacityFn=to(this.symbol.opacity)):delete this._opacityFn,c(this.symbol.opacity))t.globalAlpha!==this.symbol.opacity&&(t.globalAlpha=this.symbol.opacity);else if(this._opacityFn){var e=this.getMap();t.globalAlpha=this._opacityFn(e.getZoom())}else 1!==t.globalAlpha&&(t.globalAlpha=1)},n.prepareCanvas=function(t,e,n){t.setLineDash&&Je(e.lineDasharray)&&t.setLineDash(e.lineDasharray);var i=this.getPainter().isHitTesting();zl.prepareCanvas(t,e,n,i)},n.remove=function(){},n.setZIndex=function(){},n.show=function(){},n.hide=function(){},n._defineStyle=function(t){return this.symbol&&(t.visible=this.symbol.visible,t.opacity=this.symbol.opacity),So(t,this.geometry)},e}(nu);function ru(t,e,n,i,o){var s,a=ou(n),l=n,h=l.markerType.toLowerCase(),c=su(h,l.markerWidth,l.markerHeight),u=a.lineOpacity,f=a.polygonOpacity;Ho(a.polygonFill)&&(Ho(a.polygonFill)&&(s||(s=function(t,e,n){var i=new Oh;return i._combine(t),i.xmin+=-e/2,i.ymin+=-n/2,i.xmax+=e/2,i.ymax+=n/2,i}(e,l.markerWidth,l.markerHeight)),a.polygonGradientExtent=s));zl.prepareCanvas(t,a,i);var g=l.markerWidth,A=l.markerHeight,m=l.markerLineWidth||0,w=m/2;if("ellipse"===h)zl.ellipse(t,e,g/2,A/2,A/2,u,f);else if("cross"===h||"x"===h){for(var T=c.length-1;T>=0;T--)c[T]._add(e);zl.path(t,c.slice(0,2),u),zl.path(t,c.slice(2,4),u)}else if("diamond"===h||"bar"===h||"square"===h||"rectangle"===h||"triangle"===h||"roundrectangle"===h){"bar"===h?e=e.add(0,-w):"rectangle"!==h&&"roundrectangle"!==h||(e=e.add(w,w));for(var M=c.length-1;M>=0;M--)c[M]._add(e);"roundrectangle"===h?zl.roundRect(t,c,u,f):zl.polygon(t,c,u,f)}else if("pin"===h){e=e.add(0,-w);for(var C=c.length-1;C>=0;C--)c[C]._add(e);var P=t.lineCap;t.lineCap="round",zl.bezierCurveAndFill(t,c,u,f),t.lineCap=P}else{if("pie"!==h)throw new Error("unsupported markerType: "+h);e=e.add(0,-w);var I=180*Math.atan(g/2/A)/Math.PI,O=t.lineCap;t.lineCap="round",zl.sector(t,e,A,[90-I,90+I],u,f),t.lineCap=O}if(o){var{x:E,y:D}=e;o[0]=E-g/2-m,o[1]=D-A/2-m,o[2]=E+g/2+m,o[3]=D+A/2+m}return t.canvas}function ou(t){var e={lineColor:t.markerLineColor,linePatternFile:t.markerLinePatternFile,lineWidth:t.markerLineWidth,lineOpacity:t.markerLineOpacity,lineDasharray:t.markerLineDasharray,lineCap:"butt",lineJoin:"round",polygonFill:t.markerFill,polygonPatternFile:t.markerFillPatternFile,polygonOpacity:t.markerFillOpacity};return 0===e.lineWidth&&(e.lineOpacity=0),e}function su(t,e,n){var i,o,s,a,l=n/2,h=e/2;if("triangle"===t)return[i=new _e(0,0-l),o=new _e(0-h,0+l),s=new _e(0+h,0+l)];if("cross"===t)return[i=new _e(0-h,0),o=new _e(0+h,0),s=new _e(0,0-l),a=new _e(0,0+l)];if("diamond"===t)return[i=new _e(0-h,0),o=new _e(0,0-l),s=new _e(0+h,0),a=new _e(0,0+l)];if("square"===t)return[i=new _e(0-h,0+l),o=new _e(0+h,0+l),s=new _e(0+h,0-l),a=new _e(0-h,0-l)];if("rectangle"===t||"roundrectangle"===t)return o=(i=new _e(0,0)).add(e,0),s=i.add(e,n),a=i.add(0,n),[i,o,s,a];if("x"===t)return[i=new _e(0-h,0+l),o=new _e(0+h,0-l),s=new _e(0+h,0+l),a=new _e(0-h,0-l)];if("bar"===t)return[i=new _e(0-h,0-n),o=new _e(0+h,0-n),s=new _e(0+h,0),a=new _e(0-h,0)];if("pin"===t||"pie"===t){var c=n*Math.atan(h/l);return[i=new _e(0,0),o=new _e(0-c,0-n),s=new _e(0+c,0-n),a=new _e(0,0)]}return[]}var au=new _e(0,0),lu=new _e(0,0),hu=new _e(0,0),cu=new _e(0,0),uu=function(t){function e(e,n,i){var o;return(o=t.call(this)||this).symbol=e,o.geometry=n,o.painter=i,o.rotations=[],o}he(e,t);var n=e.prototype;return n.get2DExtent=function(){for(var t=this.getMap(),e=t.getGLRes(),n=new Oh,i=this._getRenderPoints()[0],o=i.length-1;o>=0;o--)i[o]&&n._combine(t._pointAtResToPoint(i[o],e));return n},n.isDynamicSize=function(){var t=this.symbol;return Kr(t.markerWidth)||Kr(t.markerHeight)||Kr(t.textSize)},n._rotateExtent=function(t,e){return t.convertTo((function(t){return t._rotate(e)}))},n._getRenderPoints=function(){var t=this.getPainter().isSpriting()?"center":this.getPlacement();return this.getPainter().getRenderPoints(t)},n._getRenderContainerPoints=function(t){var e=this.getPainter();if(e.isSpriting())return this._getRenderPoints()[0];var n,i=this.geometry,o=this.getDxDy();if(i._cPoint&&!t){var s=t?hu:cu;s.set(i._cPoint.x,i._cPoint.y),s._sub(e.containerOffset);var a=o.x,l=o.y;(a||l)&&s._add(a||0,l||0),n=[s]}else{var h=this._getRenderPoints()[0];n=this.painter._pointContainerPoints(h,o.x,o.y,t,!0,this.getPlacement())}if(!n||!Array.isArray(n[0]))return n;for(var c=[],u=0,f=n.length;u<f;u++)for(var g=0,A=n[u].length;g<A;g++)c.push(n[u][g]);return c},n.getPlacement=function(){return this.symbol.markerPlacement},n.getRotation=function(){return Fc(this.style)},n.getDxDy=function(){var t=this.style;return new _e(t.markerDx,t.markerDy)},n._getRotationAt=function(t){var e=this.getRotation();e||(e=0);var n=this._getRenderPoints()[1];if(!n||!n[t])return e;var i=this.getMap(),o=n[t][0],s=n[t][1];if(!o||!s)return e;if(i.isTransforming()){var a=i.getGLRes();return o=i._pointAtResToContainerPoint(n[t][0],a,0,au),s=i._pointAtResToContainerPoint(n[t][1],a,0,lu),e+yn(o.x,o.y,s.x,s.y)}return e+-yn(o.x,o.y,s.x,s.y)},n._rotate=function(t,e,n){if(n){var i=this.getDxDy(),o=e.sub(i);return t.save(),t.translate(o.x,o.y),t.rotate(n),i}return null},e}(iu),fu=function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n.getPlacement=function(){return"point"},n.getDxDy=function(){return new _e(0,0)},n.symbolize=function(t){var e=this.geometry,n=e.getLayer();if(e.options.debug||!n||n.options.debug){var i=this.getMap();if(i&&!i.isZooming()){var o=n.options.debugOutline;t.strokeStyle=o,t.fillStyle=o,t.lineWidth=1,t.font="18px  serif";var s=e.getContainerExtent().toArray();zl.polygon(t,[s],1,0);for(var a=this._getRenderContainerPoints(),l=this.geometry.getId(),c=su("cross",10,10),u=0;u<a.length;u++){var f=a[u];h(l)||zl.fillText(t,l,f.add(8,-4),o);for(var g=[],A=0;A<c.length;A++)g.push(c[A].add(f));zl.path(t,g.slice(0,2),1),zl.path(t,g.slice(2,4),1)}}}},e}(uu),du=new qn(1,1),gu=new Oh,pu=function(t){function e(e,n,i){var o;return(o=t.call(this,e,n,i)||this).style=o._defineStyle(o.translate()),o}he(e,t),e.test=function(t){return jc(t)};var n=e.prototype;return n.symbolize=function(t,e){if(this.isVisible()){var n=this.style;if(this.painter.isHitTesting()||0!==n.markerWidth&&0!==n.markerHeight&&0!==n.markerOpacity){var i=this._getRenderContainerPoints();if(Je(i))if(n.markerFile||this._url){var o=this._getImage(e);if(o){this._prepareContext(t);var s,a=n.markerWidth,l=n.markerHeight;if(!c(a)||!c(l)){l=o.height,n.markerWidth=a=o.width,n.markerHeight=l;var h=n.markerFile;e.isResourceLoaded(h)||e.addResource(h,o);var u=this.getPainter();u.isSpriting()||u.removeCache()}"path"!==this.symbol.markerType&&c(n.markerOpacity)&&n.markerOpacity<1&&(s=t.globalAlpha,t.globalAlpha*=n.markerOpacity),du.width=a,du.height=l;var f=gi(du,n.markerHorizontalAlignment,n.markerVerticalAlignment);this.rotations=[];for(var g=0,A=i.length;g<A;g++){var m=i[g],w=this._rotate(t,m,this._getRotationAt(g)),T=void 0;if(w){var M=m.sub(w);m=w;var C=this._getRotationAt(g);(T=Mc(gu,C,a,l,m,f))._add(M),this.rotations.push(C)}var P=m.x+f.x,I=m.y+f.y;zl.image(t,o,P,I,a,l),w&&t.restore(),w?this._setBBOX(t,T.xmin,T.ymin,T.xmax,T.ymax):this._setBBOX(t,P,I,P+a,I+l)}void 0!==s&&(t.globalAlpha=s)}else"undefined"!=typeof console&&console.warn("no img found for "+(this.style.markerFile||this._url[0]))}else console.warn("not find icon url:",n)}}},n._getImage=function(t){return function(t,e){return t&&t.getImage(e)||null}(t,this.style.markerFile)},n.getFixedExtent=function(t){return this._fixedExtent=this._fixedExtent||new Oh,Nc(this._fixedExtent,this.style,t)},n.translate=function(){var t=this.symbol;return{markerFile:t.markerFile,markerOpacity:He(t.markerOpacity,1),markerWidth:He(t.markerWidth,null),markerHeight:He(t.markerHeight,null),markerRotation:He(t.markerRotation,0),markerDx:He(t.markerDx,0),markerDy:He(t.markerDy,0),markerHorizontalAlignment:He(t.markerHorizontalAlignment,"middle"),markerVerticalAlignment:He(t.markerVerticalAlignment,"top")}},e}(uu);let Au;const mu={width:100,height:10};let yu=!1;try{const t=new OffscreenCanvas(1,1);t.getContext("2d").fillText("hello",0,0),yu=!0}catch(t){yu=!1}let _u=class ColorIn{constructor(t,e={}){if(!Array.isArray(t))return void console.error("colors is not array");if(t.length<2)return void console.error("colors.length should >1");this.colors=t;let n=1/0,i=-1/0;for(let e=0,o=t.length;e<o;e++){const o=t[e][0];n=Math.min(o,n),i=Math.max(o,i)}this.min=n,this.max=i,this.valueOffset=this.max-this.min,this.options=Object.assign({},mu,e),this._initImgData()}getImageData(){return this.imgData}_initImgData(){const t=function(){if(!Au){const{width:t,height:e}=mu;yu?Au=new OffscreenCanvas(t,e):(Au=document.createElement("canvas"),Au.width=t,Au.height=e)}return Au}(),{width:e,height:n}=this.options;t.width=e,t.height=n;const i=t.getContext("2d");i.clearRect(0,0,t.width,t.height);const o=i.createLinearGradient(0,0,t.width,0),{colors:s,valueOffset:a}=this;for(let t=0,e=s.length;t<e;t++){const[e,n]=s[t];o.addColorStop((e-this.min)/a,n)}i.fillStyle=o,i.fillRect(0,0,t.width,t.height),this.imgData=i.getImageData(0,0,t.width,t.height)}getColor(t){t=Math.max(this.min,t),t=Math.min(t,this.max);let e=Math.round((t-this.min)/this.valueOffset*this.imgData.width);e=Math.min(e,this.imgData.width-1);const n=4*e;return[this.imgData.data[n],this.imgData.data[n+1],this.imgData.data[n+2],this.imgData.data[n+3]]}};var vu=new gh(0,0),xu=new gh(0,0),bu=function(t){function e(e,n,i){var o;return(o=t.call(this)||this).symbol=e,o.geometry=n,o.painter=i,n.isPoint?ne(o):(o.style=o._defineStyle(o.translate()),o)}he(e,t),e.test=function(t,e){if(!t)return!1;if(e&&e.isPoint)return!1;for(var n in t){var i=n.slice(0,4);if("line"===i||"poly"===i)return!0}return!1};var n=e.prototype;return n.symbolize=function(t,e){if(this.isVisible()){var n=this.style;if(0!==n.polygonOpacity||0!==n.lineOpacity||this.painter.isHitTesting()){var i=this._getPaintParams();if(i){this._prepareContext(t);var o=Ho(n.lineColor)||n.lineGradientProperty,s="Polygon"===this.geometry.getJSONType()||"LineString"===this.geometry.type;!o||!n.lineColor.places&&s||(n.lineGradientExtent=this.geometry.getContainerExtent()._expand(n.lineWidth)),Ho(n.polygonFill)&&(n.polygonGradientExtent=this.geometry.getContainerExtent());var a=this.geometry.getLayer().options.geometryEventTolerance||0,l=this.geometry._hitTestTolerance()+a,h=i[0];if("Polygon"===this.geometry.getJSONType()&&h.length>0&&Array.isArray(h[0][0])||"LineString"===this.geometry.type&&h.length>0&&Array.isArray(h[0]))for(var c=0;c<h.length;c++){this.prepareCanvas(t,n,e),o&&s&&!n.lineColor.places&&this._createGradient(t,h[c],n.lineColor);var u=[t,h[c]];i.length>1&&u.push(...i.slice(1)),u.push(n.lineOpacity,n.polygonOpacity,n.lineDasharray),o&&u.push(this._lineColorIn);var f=this.geometry._paintOn(...u);this._setBBOX(t,f),this._bufferBBOX(t,l)}else{this.prepareCanvas(t,n,e),o&&s&&!n.lineColor.places&&this._createGradient(t,h,n.lineColor);var g=[t];g.push(...i),g.push(n.lineOpacity,n.polygonOpacity,n.lineDasharray),o&&g.push(this._lineColorIn);var A=this.geometry._paintOn(...g);this._setBBOX(t,A),this._bufferBBOX(t,l)}t.setLineDash&&Array.isArray(n.lineDasharray)&&t.setLineDash([]),this._tempRenderPoints=h}}}},n.get2DExtent=function(){var t=this.getMap(),e=this.geometry._getPrjExtent();if(!e)return null;this._extMin&&this._extMax||(this._extMin=new gh(0,0),this._extMax=new gh(0,0)),this._extMin.x=e.xmin,this._extMin.y=e.ymin,this._extMax.x=e.xmax,this._extMax.y=e.ymax;var n=t._prjToPoint(this._extMin,void 0,vu),i=t._prjToPoint(this._extMax,void 0,xu);return this._pxExtent?this._pxExtent.set(Math.min(n.x,i.x),Math.min(n.y,i.y),Math.max(n.x,i.x),Math.max(n.y,i.y)):this._pxExtent=new Oh(n,i),this._pxExtent},n.getFixedExtent=function(){var t=this.style.lineWidth/2;return new Oh(-t,-t,t,t)},n._getPaintParams=function(){return this.getPainter().getPaintParams(this.style.lineDx,this.style.lineDy)},n.translate=function(){var t=this.symbol,e={lineColor:He(t.lineColor,"#000"),lineWidth:He(t.lineWidth,2),lineOpacity:He(t.lineOpacity,1),lineDasharray:He(t.lineDasharray,[]),lineCap:He(t.lineCap,"butt"),lineJoin:He(t.lineJoin,"miter"),linePatternFile:He(t.linePatternFile,null),lineDx:He(t.lineDx,0),lineDy:He(t.lineDy,0),polygonFill:He(t.polygonFill,null),polygonOpacity:He(t.polygonOpacity,1),polygonPatternFile:He(t.polygonPatternFile,null),polygonPatternDx:He(t.polygonPatternDx,0),polygonPatternDy:He(t.polygonPatternDy,0),linePatternDx:He(t.linePatternDx,0),linePatternDy:He(t.linePatternDy,0),lineGradientProperty:He(t.lineGradientProperty,null)};return 0===e.lineWidth&&(e.lineOpacity=0),"LineString"!==this.geometry.type||e.polygonFill||(e.polygonFill=e.lineColor),e},n._createGradient=function(t,e,n){if(Array.isArray(e)&&e.length){var[i,o]=function(t){var e,n=!0;Array.isArray(t[0])?(e=t[0],n=!1):e=t;var i=e.length;if(n)return[e[0],e[i-1]];for(var o,s=e[0],a=0,l=1;l<i;l++){var h=e[l],c=s.distanceTo(h);c>a&&(a=c,o=h)}return[s,o]}(e);if(i&&o){var s;if(n.colorStops&&(s=n.colorStops),!s)s=(this.geometry.properties||{})[(this.style||{}).lineGradientProperty];if(s&&Array.isArray(s)&&!(s.length<2)){if(!Array.isArray(s[0])){for(var a=[],l=[],h=0,c=0,u=s.length;c<u;c+=2)l[0]=s[c],l[1]=s[c+1],a[h]=l,h++,l=[];s=a}var f=t.createLinearGradient(i.x,i.y,o.x,o.y);s.forEach((function(t){f.addColorStop(...t)})),t.strokeStyle=f;var g=JSON.stringify(s);if(g!==this._lineColorStopsKey){this._lineColorStopsKey=g;var A=s.map((function(t){return[parseFloat(t[0]),t[1]]}));this._lineColorIn=new _u(A,{height:1,width:100})}}}else console.error("unable create canvas LinearGradient,error data:",e)}},e}(iu);var wu=new Oh;var Tu,Mu=function(t){function e(e,n,i){var o,s=(o=t.call(this,e,n,i)||this).translate();return o._dynamic=$r(s),o.style=o._defineStyle(s),0===o.style.textWrapWidth?ne(o):(o.strokeAndFill=o._defineStyle(o.translateLineAndFill(o.style)),o)}he(e,t),e.test=function(t){return Gc(t)};var n=e.prototype;return n.isAlongLine=function(){var t=this.getPlacement(),e=this.style.textSpacing;return"line"===t&&c(e)&&e>0},n.symbolize=function(t,e){if(this.isVisible()){var n=this.style;if(this.painter.isHitTesting()||0!==n.textSize&&(n.textOpacity||n.textHaloRadius&&n.textHaloOpacity)&&0!==n.textWrapWidth){var i=this.strokeAndFill,o=fi(this.style.textName,this.geometry.getProperties());this._dynamic&&delete this._textDesc;var s=this._textDesc=this._textDesc||di(o,this.style);this._prepareContext(t),this.prepareCanvas(t,i,e),this._textFont||(this._textFont=yi(n)),zl.prepareCanvasFont(t,n,this._dynamic?null:this._textFont);var a=n.textHaloRadius||0;if(this.rotations=[],this.isAlongLine()){var l=this.getPainter().getPathTempRenderPoints();if(!l)return;if(l=function(t,e){var{width:n,height:i}=e,o=n+0,s=i+0;wu.xmin=-0,wu.ymin=-0,wu.xmax=o,wu.ymax=s,Array.isArray(t[0])||(t=[t]);var a=[];return t.forEach((function(t){for(var e=!1,n=0,i=t.length;n<i;n++){var{x:l,y:h}=t[n];if(l<-0||l>o||h<-0||h>s){e=!0;break}}e?Jc(t,wu,!1,!1).forEach((function(t){for(var e=[],n=0,i=t.length;n<i;n++)e[n]=t[n].point;a.push(e)})):a.push(t)})),a}(l,this.getMap().getSize()),l){var h=this.geometry.getLayer(),c=zl.textAlongLine(t,o,l,n,s,h.options.collision?h.getCollisionIndex():null);c&&(this._setBBOX(t,c),this._bufferBBOX(t,a))}}else{var u=this._getRenderContainerPoints();if(!Je(u))return;for(var f=0,g=u.length;f<g;f++){var A=u[f],m=this._rotate(t,A,this._getRotationAt(f)),w=void 0;if(m){var T=A.sub(m);A=m;var M=this._getRotationAt(f),{width:C,height:P}=s.size||{width:0,height:0},I=gi(s.size,n.textHorizontalAlignment,n.textVerticalAlignment);(w=Mc(wu,M,C,P,A,I))._add(T),this.rotations.push(M)}var O=zl.text(t,o,A,n,s);m?(this._setBBOX(t,w.xmin,w.ymin,w.xmax,w.ymax),t.restore()):this._setBBOX(t,O),this._bufferBBOX(t,a)}}}}},n.getPlacement=function(){return this.symbol.textPlacement},n.getRotation=function(){var t=this.style.textRotation;return c(t)?-t*Math.PI/180:null},n.getDxDy=function(){var t=this.style;return new _e(t.textDx,t.textDy)},n.getFixedExtent=function(){var t=this.geometry.getTextDesc();return Array.isArray(t)&&(t=t[this._index]),this._fixedExtent=this._fixedExtent||new Oh,t?Hc(this._fixedExtent,this.style,t):this._fixedExtent},n.translate=function(){var t=this.symbol,e={textName:t.textName,textFaceName:He(t.textFaceName,"monospace"),textWeight:He(t.textWeight,"normal"),textStyle:He(t.textStyle,"normal"),textSize:He(t.textSize,Wn),textFont:He(t.textFont,null),textFill:He(t.textFill,"#000"),textOpacity:He(t.textOpacity,1),textHaloFill:He(t.textHaloFill,"#ffffff"),textHaloRadius:He(t.textHaloRadius,0),textHaloOpacity:He(t.textHaloOpacity,1),textWrapWidth:He(t.textWrapWidth,null),textWrapCharacter:He(t.textWrapCharacter,"\n"),textLineSpacing:He(t.textLineSpacing,0),textDx:He(t.textDx,0),textDy:He(t.textDy,0),textHorizontalAlignment:He(t.textHorizontalAlignment,"middle"),textVerticalAlignment:He(t.textVerticalAlignment,"middle"),textAlign:He(t.textAlign,"center"),textRotation:He(t.textRotation,0),textMaxWidth:He(t.textMaxWidth,0),textMaxHeight:He(t.textMaxHeight,0),textSpacing:He(t.textSpacing,0),textAlongDebug:He(t.textAlongDebug,!1)};return e.textMaxWidth>0&&(!e.textWrapWidth||e.textWrapWidth>e.textMaxWidth)&&(e.textWrapWidth||(e.textMaxHeight=1),e.textWrapWidth=e.textMaxWidth),e},n.translateLineAndFill=function(t){return{lineColor:t.textHaloRadius?t.textHaloFill:t.textFill,lineWidth:t.textHaloRadius,lineOpacity:t.textOpacity,lineDasharray:null,lineCap:"butt",lineJoin:"round",polygonFill:t.textFill,polygonOpacity:t.textOpacity}},e}(uu),Cu=[0,0],Su=new Oh,Pu=new _e(0,0),Iu=ws(),Ou=function(t){function e(e,n,i){var o,s=(o=t.call(this,e,n,i)||this).translate();return o._dynamic=$r(s),o.style=o._defineStyle(s),o.strokeAndFill=o._defineStyle(ou(o.style)),o.padding=0,o}he(e,t),e.test=function(t){return Uc(t)};var n=e.prototype;return n.symbolize=function(t,e){if(this.isVisible()){var n=this.style;if(this.painter.isHitTesting()||0!==n.markerWidth&&0!==n.markerHeight&&(0!==n.polygonOpacity||0!==n.lineOpacity)){var i=this._getRenderContainerPoints();Je(i)&&(this._prepareContext(t),this.getPainter().isSpriting()||this.geometry.getLayer().getMask()===this.geometry||this._dynamic||!1===this.geometry.getLayer().options.cacheVectorOnCanvas?this._drawMarkersWithDynamic(t,i,e):this._drawMarkersWithCache(t,i,e))}}},n._drawMarkersWithDynamic=function(t,e,n){for(var i=e.length-1;i>=0;i--){var o=e[i],s=Lc(Cu,this.style),[a,l]=s,h=this._rotate(t,o,this._getRotationAt(i));this.rotations=[];var c=void 0;if(h){var u=o.sub(h);o=h;var f=this._getRotationAt(i);(c=Mc(Su,f,a,l,o,Pu))._add(u),this.rotations.push(f)}var g=this._drawVectorMarker(t,o,n);if(h)t.restore(),this._setBBOX(t,c.xmin,c.ymin,c.xmax,c.ymax);else if(g)this._setBBOX(t,g[0],g[1],g[2],g[3]);else{var{x:A,y:m}=o;this._setBBOX(t,A,m,A+a,m+l)}}},n._drawMarkersWithCache=function(t,e,n){var i=this._stampSymbol(),o=n.getImage(i);o||(o=this._createMarkerImage(t,n),n.addResource([i,o.width,o.height],o));for(var s=Rc(this.style,o.width,o.height),a=e.length-1;a>=0;a--){var l=e[a],h=this._rotate(t,l,this._getRotationAt(a));this.rotations=[];var c=void 0;if(h){var u=l.sub(h);l=h;var f=this._getRotationAt(a);(c=Mc(Su,f,o.width,o.height,l,s))._add(u),this.rotations.push(f)}var g=l.x+s.x,A=l.y+s.y;zl.image(t,o,g,A),h?(t.restore(),this._setBBOX(t,c.xmin,c.ymin,c.xmax,c.ymax)):this._setBBOX(t,g,A,g+o.width,A+o.height)}},n._createMarkerImage=function(t,e){var n=t.canvas.constructor,i=Lc(Cu,this.style),o=zl.createCanvas(i[0],i[1],n),s=this._getCacheImageAnchor(i[0],i[1]),a=o.getContext("2d");return this._drawVectorMarker(a,s,e),o},n._stampSymbol=function(){return this._stamp||(this._stamp=vi([this.style.markerType,Ho(this.style.markerFill)?Bo(this.style.markerFill):this.style.markerFill,this.style.markerFillOpacity,this.style.markerFillPatternFile,Ho(this.style.markerLineColor)?Bo(this.style.markerLineColor):this.style.markerLineColor,this.style.markerLineWidth,this.style.markerLineOpacity,this.style.markerLineDasharray?this.style.markerLineDasharray.join(","):"",this.style.markerLinePatternFile,this.style.markerWidth,this.style.markerHeight,this.style.markerHorizontalAlignment,this.style.markerVerticalAlignment].join("_"))),this._stamp},n._getCacheImageAnchor=function(t,e){var n=2*(this.symbol.shadowBlur||0)+this.padding,i=this.style.markerType;return"bar"===i||"pie"===i||"pin"===i?new _e(t/2,e-n):"rectangle"===i||"roundrectangle"===i?new _e(n,n):new _e(t/2,e/2)},n._getGraidentExtent=function(t){var e=new Oh,n=this.getDxDy(),i=this.getFixedExtent();if(Array.isArray(t))for(var o=t.length-1;o>=0;o--)e._combine(t[o]);else e._combine(t);return e.xmin+=i.xmin-n.x,e.ymin+=i.ymin-n.y,e.xmax+=i.xmax-n.x,e.ymax+=i.ymax-n.y,e},n._drawVectorMarker=function(t,e,n){return Ss(Iu),ru(t,e,this.style,n,Iu),Iu},n.getFixedExtent=function(){return this._fixedExtent=this._fixedExtent||new Oh,Ic(this._fixedExtent,this.style,null)},n.translate=function(){var t=this.symbol,e={markerType:He(t.markerType,"ellipse"),markerFill:He(t.markerFill,"#00f"),markerFillOpacity:He(t.markerFillOpacity,1),markerFillPatternFile:He(t.markerFillPatternFile,null),markerLineColor:He(t.markerLineColor,"#000"),markerLineWidth:He(t.markerLineWidth,wc.markerLineWidth),markerLineOpacity:He(t.markerLineOpacity,1),markerLineDasharray:He(t.markerLineDasharray,[]),markerLinePatternFile:He(t.markerLinePatternFile,null),markerDx:He(t.markerDx,0),markerDy:He(t.markerDy,0),markerWidth:He(t.markerWidth,wc.markerWidth),markerHeight:He(t.markerHeight,wc.markerHeight),markerRotation:He(t.markerRotation,0),shadowBlur:He(t.shadowBlur,0),shadowOffsetX:He(t.shadowOffsetX,0),shadowOffsetY:He(t.shadowOffsetY,0)},n=e.markerType,i=Oc(n),o=Ec(n);return e.markerHorizontalAlignment=He(t.markerHorizontalAlignment,i),e.markerVerticalAlignment=He(t.markerVerticalAlignment,o),c(t.markerOpacity)&&(c(t.markerFillOpacity)&&(e.markerFillOpacity*=t.markerOpacity),c(t.markerLineOpacity)&&(e.markerLineOpacity*=t.markerOpacity)),e},e}(uu),Eu=function(t){function e(e,n,i){var o;h(e.markerWidth)&&(e.markerWidth=80),h(e.markerHeight)&&(e.markerHeight=80),e=l({},e,(o=t.call(this,e,n,i)||this).translate());var s=o.style=o._defineStyle(e);return o._url=Gt.gecko?[Oo(s,s.markerWidth,s.markerHeight),s.markerWidth,s.markerHeight]:[Oo(s),s.markerWidth,s.markerHeight],o}he(e,t),e.test=function(t){return Vc(t)};var n=e.prototype;return n._prepareContext=function(){},n._getImage=function(t){var e=this;if(t&&t.isResourceLoaded(this._url))return t.getImage(this._url);var n=this.painter,i=new Image;return i.onload=function(){var t=n.getLayer()&&n.getLayer().getRenderer();t&&t.setToRedraw()},i.onerror=function(n){n&&"undefined"!=typeof console&&console.warn(n),t.markErrorResource(e._url)},i.src=this._url[0],t&&t.addResource(this._url,i),i},e}(pu),ku={lineWidth:1,polygonFill:"#fff",polygonOpacity:.5},Ru=function(t){function e(e,n,i){var o;return(o=t.call(this,e,n,i)||this).style=n.getLayer().options.drawAltitude,o.style&&f(o.style)||(o.style={lineWidth:2}),o.style.lineWidth||(o.style.lineWidth=0),o.dxdy=o._defineStyle({dx:e.textDx||e.markerDx,dy:e.textDy||e.markerDy}),o}he(e,t),e.test=function(t,e){if(!e.getLayer())return!1;var n=e.getJSONType();return"Marker"===n||"LineString"===n};var n=e.prototype;return n.symbolize=function(t){if(this.geometry.getLayer().options.drawAltitude&&this.geometry.hasAltitude()){var e=this._getStyle();if(this._prepareContext(t),"LineString"===this.geometry.type){var n=this._getPaintParams(e.lineDx,e.lineDy);if(!n)return;var i=this.getPainter().getPaintParams(e.lineDx,e.lineDy,!0,!0,"_groundpt")[0];this._drawLineAltitude(t,n[0],i)}else{var o=this._getRenderContainerPoints(),s=this._getRenderContainerPoints(!0);if(!o||0===o.length)return;this._drawMarkerAltitude(t,o[0],s[0])}}},n.getDxDy=function(){var t=this.dxdy;return new _e(t.dx||0,t.dy||0)},n.get2DExtent=function(){return"LineString"===this.geometry.type?bu.prototype.get2DExtent.apply(this):t.prototype.get2DExtent.call(this)},n.getPlacement=function(){return"point"},n._getPaintParams=function(t,e){return this.getPainter().getPaintParams(t||0,e||0,null,!0,"_altpt")},n._drawMarkerAltitude=function(t,e,n){var i=this._getStyle();this.prepareCanvas(t,i),zl.path(t,[e,n],i.lineOpacity,null,i.lineDasharray)},n._drawLineAltitude=function(t,e,n){var i=this._getStyle();if(e.length>0&&Array.isArray(e[0]))for(var o=0;o<e.length;o++)this._drawLine(t,e[o],n[o]);else this._drawLine(t,e,n);t.setLineDash&&Array.isArray(i.lineDasharray)&&t.setLineDash([])},n._drawLine=function(t,e,n){var i=this._getStyle();this.prepareCanvas(t,i);for(var o=0,s=e.length-1;o<s;o++)zl.polygon(t,[e[o],e[o+1],n[o+1],n[o]],i.lineOpacity,i.polygonOpacity,i.lineDasharray)},n._getStyle=function(){var t=this.geometry.getLayer(),e=t.options.drawAltitude;if(Array.isArray(e)){var n=(t.getGeometries()||[]).indexOf(this.geometry);n>=0&&(e=e[n]||ku)}return f(e)||(e=ku),e.lineWidth||(e.lineWidth=0,e.lineOpacity=0),e},e}(uu),Lu=Object.freeze({__proto__:null,CanvasSymbolizer:iu,DebugSymbolizer:fu,DrawAltitudeSymbolizer:Ru,ImageMarkerSymbolizer:pu,PointSymbolizer:uu,StrokeAndFillSymbolizer:bu,Symbolizer:nu,TextMarkerSymbolizer:Mu,VectorMarkerSymbolizer:Ou,VectorPathMarkerSymbolizer:Eu}),Du=[Ru,bu,pu,Eu,Ou,Mu],Fu=new _e(0,0),Nu=new Oh,Hu=new Oh,Bu=new Oh,zu=new Oh,Gu=new Oh,ju={code:void 0},Uu={minx:1/0,miny:1/0,maxx:-1/0,maxy:-1/0},Vu=[],Wu=function(t){function e(e){var n;return(n=t.call(this)||this).geometry=e,n.symbolizers=n._createSymbolizers(),n._altAtGL=n._getGeometryAltitude(),n.bbox=ws(),n._drawTime=0,n}he(e,t);var n=e.prototype;return n._setDrawTime=function(t){return this._drawTime=t,this},n.getRenderBBOX=function(){var t=this.getLayer();if(t&&t._drawTime!==this._drawTime)return null;Ss(this.bbox);for(var e=!1,n=this.symbolizers.length-1;n>=0;n--){var i=this.symbolizers[n];if(!(i instanceof Ru||i instanceof fu)){var o=i.bbox;if(!Os(o)){e=!0;break}Is(this.bbox,o)}}return e?null:Os(this.bbox)?this.bbox:null},n.getMap=function(){return this.geometry.getMap()},n.getLayer=function(){return this.geometry&&this.geometry.getLayer()},n._createSymbolizers=function(){var t=this.getSymbol(),e=[],n=Du,i=t;Array.isArray(t)||(i=[t]);for(var o=i.length-1;o>=0;o--)for(var s=i[o],a=n.length-1;a>=0;a--)if(n[a].test(s,this.geometry)){var l=new n[a](s,this.geometry,this);l._index=o,e.push(l),l instanceof uu&&(this._hasPoint=!0)}if(!e.length&&console){var h=this.geometry.getId();console.warn("invalid symbol for geometry("+(this.geometry?this.geometry.getType()+(h?":"+h:""):"")+") to draw : "+JSON.stringify(t))}return this._debugSymbolizer=new fu(t,this.geometry,this),e},n.hasPoint=function(){return!!this._hasPoint},n.getRenderPoints=function(t){return this._verifyProjection(),this._renderPoints||(this._renderPoints={}),t||(t="center"),this._renderPoints[t]||(this._renderPoints[t]=this.geometry._getRenderPoints(t)),this._renderPoints[t]},n.getPaintParams=function(t,e,n,i,o="_pt"){var s,a,l,h,u,f=this.getLayer()._getRenderer().mapStateCache,g=this.getMap();f&&!this._hitPoint?(s=f.resolution,a=f.pitch,l=f.bearing,h=f.glScale,u=f.containerExtent):(s=g.getResolution(),a=g.getPitch(),l=g.getBearing(),h=g.getGLScale(),u=g.getContainerExtent());var A=this.geometry,m=s,w=0!==a,T=0!==l,M=this._cachedParams,C=A._paintAsPath&&A._paintAsPath();if(C&&this._unsimpledParams&&m<=this._unsimpledParams._res)M=this._unsimpledParams;else if(!M||M._res!==s||this._pitched!==w&&A._redrawWhenPitch()||this._rotated!==T&&A._redrawWhenRotate()){if(!(M=A._getPaintParams()))return null;M._res=m,!A._simplified&&C&&(this._unsimpledParams||(this._unsimpledParams=M),m>this._unsimpledParams._res&&(this._unsimpledParams._res=m)),this._cachedParams=M}if(!M)return null;this._pitched=w,this._rotated=T;var P=h,I=[],O=this._pointContainerPoints(M[0],t,e,n,i||this._hitPoint&&!u.contains(this._hitPoint),null,o);if(!O)return null;I.push(O);for(var E=1,D=M.length;E<D;E++)c(M[E])||M[E]instanceof qn?c(M[E])?I.push(M[E]/P):I.push(M[E].multi(1/P)):I.push(M[E]);return I},n._pointContainerPoints=function(t,e,n,i,o,s,a="_pt"){if(this._aboveCamera())return null;var l,h,u,f=this.getLayer()._getRenderer(),g=f.mapStateCache,A=this.getMap(),m=this.geometry,w=this.containerOffset;g?(l=g.glRes,h=g.containerExtent):(l=A.getGLRes(),h=A.getContainerExtent());var T=this.getLayer().options.roundPoint,M=1/0,C=1/0,P=-1/0,I=-1/0,O=!o,E=f.layer.options.clipBBoxBufferSize||3,D=this.symbolizers,N=m.options.enableClip;function H(t=[],i=[]){for(var o=Pn(t,a),s=0,c=(o=A._pointsAtResToContainerPoints(t,l,i,o)).length;s<c;s++){var u=o[s];u._sub(w),(e||n)&&u._add(e||0,n||0),T&&(u.x=Math.ceil(u.x),u.y=Math.ceil(u.y)),M=Math.min(u.x,M),C=Math.min(u.y,C),P=Math.max(u.x,P),I=Math.max(u.y,I)}if(N&&O&&Xo(D)){if(Gu.ymin=h.ymin,Gu.ymin<E&&(Gu.ymin=h.ymin-E),Gu.xmin=h.xmin-E,Gu.xmax=h.xmax+E,Gu.ymax=h.ymax+E,m.getShell&&m.getHoles)return Yc(o,Gu);var f=Jc(o,Gu,!1);if(f.length){var g=[];return f.forEach((function(t){for(var e=0,n=t.length;e<n;e++)g.push(t[e].point)})),g}}return o}var U=this.getAltitude();if(Array.isArray(t)){var W;!o&&this.geometry.options.enableClip?(W=this._clip(t,U)).inView&&(O=!1):W={points:t,altitude:U};var q=W.points;U=W.altitude,i&&(U=0);var X=U;u=[];for(var J=[],Q=c(U),Y=0,K=q.length;Y<K;Y++){var $=q[Y];if(Array.isArray($)){if(Q){var tt=H($,U);u.push(tt);continue}for(var et=[],nt=0,it=$.length;nt<it;nt++)Array.isArray(U)&&(X=U[Y]?U[Y][nt]:0),et.push(X);var rt=H($,et);u.push(rt)}else Array.isArray(U)&&(X="vertex-last"===s?U[U.length-1-Y]:"line"===s?(U[Y]+U[Y+1])/2:U[Y]),J.push(X)}J.length&&(u=H(q,J))}else t instanceof _e&&(i&&(U=0),u=A._pointAtResToContainerPoint(t,l,U)._sub(w),(e||n)&&u._add(e,n));return Uu.minx=M,Uu.miny=C,Uu.maxx=P,Uu.maxy=I,this._containerBbox=Uu,u},n._clip=function(t,e){if(c(e)&&0!==e)return{points:t,altitude:e};if(Array.isArray(e)){for(var n=!1,i=0,o=e.length;i<o;i++)if(0!==e[i]){n=!0;break}if(n)return{points:t,altitude:e}}var s=this.getMap(),a=this.geometry,l=this.getSymbol().lineWidth;c(l)||(l=4);var h,u,f,g=this.getLayer()._getRenderer().mapStateCache;g?(h=g._2DExtent,u=g.glExtent,f=g.pitch):(h=s.get2DExtent(),u=s.get2DExtentAtRes(s.getGLRes()),f=s.getPitch());var A=h._expand(l);if(f>0&&e){var m=s.cameraLookAt,w=s.cameraPosition;Fu.set(w[0],w[1]),A=A._combine(Fu._add(Ge(m[0]-w[0]),Ge(m[1]-w[1])))}var T=t;if(this.get2DExtent(null,zu).within(A))return{points:T,altitude:e,inView:!0};var M=u._expand(l*s.getGLScale());Bu.xmin=M.xmin,Bu.xmax=M.xmax,Bu.ymin=M.ymin,Bu.ymax=M.ymax;var C=a.options.smoothness;if(a.getShell&&this.geometry.getHoles&&!C){var{xmin:P,ymin:I,xmax:O,ymax:E}=M,D=Math.abs(O-P),N=Math.abs(E-I),H=Math.sqrt(D*D+N*N),U=(H-D)/2,W=(H-N)/2;if(Bu.xmin=M.xmin-U,Bu.xmax=M.xmax+U,Bu.ymin=M.ymin-W,Bu.ymax=M.ymax+W,Array.isArray(t[0])){T=[];for(var q=0;q<t.length;q++){var X=Yc(t[q],Bu);X.length&&T.push(X)}}else T=Yc(t,Bu)}else if("LineString"===a.getJSONType()&&!C){if(Array.isArray(t[0])){T=[];for(var J=0;J<t.length;J++)ke(T,Jc(t[J],Bu,!1,!!C))}else T=Jc(t,Bu,!1,!!C);return this._interpolateSegAlt(T,t,e)}return{points:T,altitude:e}},n._interpolateSegAlt=function(t,e,n){if(!Array.isArray(n)){var i=function(t){return t.point};return{points:t.map((function(t){return Array.isArray(t)?t.map(i):t.point})),altitude:n}}var o=Zu(t,e,n);n=[];var s=o.map((function(t){if(Array.isArray(t)){var e=[],i=t.map((function(t){return e.push(t.altitude),t.point}));return n.push(e),i}return n.push(t.altitude),t.point}));return{points:s,altitude:n}},n.getSymbol=function(){return this.geometry._getInternalSymbol()},n._resetSymbolizersBBOX=function(){for(var t=this.symbolizers.length-1;t>=0;t--){Ss(this.symbolizers[t].bbox)}return this},n.paint=function(t,e,n){if(this.symbolizers){var i=this.getLayer(),o=i._getRenderer();if(o&&(o.context||e)){var s=o.mapStateCache||{offset:void 0};if((this.geometry._isCheck||!t||t.intersects(this.get2DExtent(o.resources,Nu)))&&!this._aboveCamera()){if(this.containerOffset=n||s.offset,!this.containerOffset){var a=this.getMap();this.containerOffset=a._pointToContainerPoint(o.middleWest)._add(0,-a.height/2)}this._beforePaint();var l=e||o.context;l.isHitTesting||this._resetSymbolizersBBOX(),Vu[0]=l,Vu[1]=o.resources;for(var h=this.symbolizers.length-1;h>=0;h--)(l.shadowBlur||this.symbolizers[h].symbol.shadowBlur)&&this._prepareShadow(l,this.symbolizers[h].symbol),this.symbolizers[h].symbolize(...Vu);this._afterPaint(),this._painted=!0,(this.geometry.options.debug||i.options.debug)&&this._debugSymbolizer.symbolize(l)}}}},n.getSprite=function(t,e){if(!this.geometry.isPoint)return null;if(this._spriting=!0,!this._sprite&&this.symbolizers.length>0){var n=new Oh;this.symbolizers.forEach((function(e){var i=e.getFixedExtent(t);n._combine(i)}));var i,o=n.getMin().multi(-1),s=e||(this.getMap()?this.getMap().CanvasClass:null),a=zl.createCanvas(n.getWidth(),n.getHeight(),s);this._renderPoints&&(i=this._renderPoints);for(var l=a.getContext("2d"),h=[l,t],c=this.symbolizers.length-1;c>=0;c--){var u=this.symbolizers[c].getDxDy();this._renderPoints={center:[[o.add(u)]]},this._prepareShadow(l,this.symbolizers[c].symbol),this.symbolizers[c].symbolize(...h)}i&&(this._renderPoints=i),this._sprite={canvas:a,offset:n.getCenter()}}return this._spriting=!1,this._sprite},n.isSpriting=function(){return!!this._spriting},n.hitTest=function(t,e){if((!e||e<.5)&&(e=.5),this._hitPoint=t.sub(e,e),!Tu){var n=this.getMap()?this.getMap().CanvasClass:null;Tu=zl.createCanvas(1,1,n)}zl.setHitTesting(!0),Tu.width=Tu.height=2*e;var i=zl.getCanvas2DContext(Tu);i.isHitTesting=!0;try{this.paint(null,i,this._hitPoint)}finally{zl.setHitTesting(!1)}delete this._hitPoint;try{for(var o=i.getImageData(0,0,Tu.width,Tu.height).data,s=3,a=o.length;s<a;s+=4)if(o[s]>0)return!0}catch(t){console.error(t)}return!1},n.isHitTesting=function(){return!!this._hitPoint},n._prepareShadow=function(t,e){e.shadowBlur?(t.shadowBlur=this.isHitTesting()?0:e.shadowBlur,t.shadowColor=e.shadowColor||"#000",t.shadowOffsetX=e.shadowOffsetX||0,t.shadowOffsetY=e.shadowOffsetY||0):t.shadowBlur&&(t.shadowBlur=null,t.shadowColor=null,t.shadowOffsetX=null,t.shadowOffsetY=null)},n._eachSymbolizer=function(t,e){if(this.symbolizers){e||(e=this);for(var n=this.symbolizers.length-1;n>=0;n--)t.apply(e,[this.symbolizers[n]])}},n.get2DExtent=function(t,e){this._verifyProjection();var n=this.getMap();t=t||this.getLayer()._getRenderer().resources;var i=n.getZoom(),o=this._isDynamicSize();if(this._extent2D&&this._extent2D._zoom===i&&this._fixedExtent||(this._extent2D&&this._extent2D._zoom!==i&&delete this._extent2D,this.symbolizers&&(this._extent2D||(this._extent2D=this._computeExtent2D(new Oh),this._extent2D._zoom=i),this._fixedExtent||(this._fixedExtent=this._computeFixedExtent(t,new Oh)))),!this._extent2D)return o&&delete this._fixedExtent,null;var{xmin:s,ymin:a,xmax:l,ymax:h}=this._fixedExtent;return o&&delete this._fixedExtent,Hu.set(s,-h,l,-a),e?(e.set(this._extent2D.xmin,this._extent2D.ymin,this._extent2D.xmax,this._extent2D.ymax),e._add(Hu),e):this._extent2D.add(Hu)},n._computeExtent2D=function(t){for(var e=this.symbolizers.length-1;e>=0;e--){t._combine(this.symbolizers[e].get2DExtent())}return t},n._computeFixedExtent=function(t,e){for(var n=this.symbolizers.length-1;n>=0;n--){var i=this.symbolizers[n];i.getFixedExtent&&e._combine(i.getFixedExtent(t))}return e},n._isDynamicSize=function(){for(var t=this.symbolizers.length-1;t>=0;t--){if(this.symbolizers[t].isDynamicSize())return!0}return!1},n._aboveCamera=function(){var t=this.getMinAltitude(),e=this.getMap(),n=e.getGLRes();t=e.altitudeToPoint(t,n)*Ge(t);var i=e.getFrustumAltitude();return t&&i&&i<t},n.getFixedExtent=function(){var t=this.getMap().getZoom();return this._isDynamicSize()?this._computeFixedExtent(null,new Oh):(this._extent2D&&this._extent2D._zoom===t||this.get2DExtent(null,Hu),this._fixedExtent)},n.setZIndex=function(t){this._eachSymbolizer((function(e){e.setZIndex(t)}))},n.show=function(){this._painted?(this.removeCache(),this._eachSymbolizer((function(t){t.show()}))):this.getLayer().isCanvasRender()||this.paint()},n.hide=function(){this._eachSymbolizer((function(t){t.hide()}))},n.repaint=function(){this._altAtGL=this._getGeometryAltitude(),this.removeCache();var t=this.getLayer();if(t){var e=t.getRenderer();e&&e.setToRedraw()&&e.setToRedraw()}},n.refreshSymbol=function(){this.removeCache(),this._removeSymbolizers(),this.symbolizers=this._createSymbolizers()},n.remove=function(){this.removeCache(),this._removeSymbolizers()},n._removeSymbolizers=function(){this._eachSymbolizer((function(t){delete t.painter,t.remove()})),delete this.symbolizers},n.removeCache=function(){delete this._renderPoints,delete this._paintParams,delete this._sprite,delete this._extent2D,delete this._fixedExtent,delete this._cachedParams,delete this._unsimpledParams},n.getAltitude=function(){return this.geometry._getAltitude()!==this._propAlt&&(this._altAtGL=this._getGeometryAltitude()),this._altAtGL?this._altAtGL:0},n.getMinAltitude=function(){return this.minAltitude?this.minAltitude:0},n.getMaxAltitude=function(){return this.maxAltitude?this.maxAltitude:0},n._getGeometryAltitude=function(){if(!this.getMap())return 0;var t=this.geometry._getAltitude();this._propAlt=t;var[e,n]=eu(t);return this.minAltitude=e,this.maxAltitude=n,t&&this.geometry.getCenter()?t:0},n._verifyProjection=function(){var t=this.geometry._getProjection()||ju;this._projCode&&this._projCode!==t.code&&this.removeCache(),this._projCode=t.code},n._beforePaint=function(){},n._afterPaint=function(){},n.getPathTempRenderPoints=function(){for(var t=0,e=(this.symbolizers||[]).length;t<e;t++){var n=this.symbolizers[t];if(n instanceof bu&&n._tempRenderPoints)return n._tempRenderPoints}},e}(Ql);function Zu(t,e,n){if(!Array.isArray(n))return t;for(var i=[],o=0,s=t.length;o<s;o++)if(Array.isArray(t[o]))i.push(Zu(t[o],e,n));else{var a=t[o];if(a.point.equals(e[a.index]))a.altitude=n[a.index],i.push(a);else{var l=void 0,h=void 0;0===a.index?(l=a.index,h=a.index+1):(l=a.index-1,h=a.index);var c=a.point.distanceTo(e[h]),u=c/(c+e[l].distanceTo(a.point)),f=Ue(n[l],n[h],1-u);a.altitude=f,i.push(a)}}return i}var qu=new Oh,Xu=function(t){function e(e,n){var i;return(i=t.call(this)||this).geometry=e,i.isMask=n,i.bbox=ws(),i._drawTime=0,i}he(e,t);var n=e.prototype;return n._setDrawTime=function(t){return this._drawTime=t,this._eachPainter((function(e){e._setDrawTime(t)})),this},n.getRenderBBOX=function(){var t=this,e=this.getLayer();if(e&&e._drawTime!==this._drawTime)return null;Ss(this.bbox);var n=!1;return this._eachPainter((function(e){var i=e.getRenderBBOX();Os(i)?Is(t.bbox,i):n=!0})),n?null:Os(this.bbox)?this.bbox:null},n._eachPainter=function(t){for(var e,n=this.geometry.getGeometries(),i=0,o=n.length;i<o&&(!(e=this.isMask?n[i]._getMaskPainter():n[i]._getPainter())||!e||!1!==t.call(this,e));i++);},n.getLayer=function(){return this.geometry&&this.geometry.getLayer()},n.paint=function(t){this.geometry&&this._eachPainter((function(e){e.paint(t)}))},n.get2DExtent=function(t,e){e&&e.set(null,null,null,null);var n=e||new Oh;return this._eachPainter((function(e){n=n._combine(e.get2DExtent(t,qu))})),n},n.remove=function(){this._eachPainter((function(t){t.remove()}))},n.setZIndex=function(t){this._eachPainter((function(e){e.setZIndex(t)}))},n.show=function(){this._eachPainter((function(t){t.show()}))},n.hide=function(){this._eachPainter((function(t){t.hide()}))},n.repaint=function(){this._eachPainter((function(t){t.repaint()}))},n.refreshSymbol=function(){this._eachPainter((function(t){t.refreshSymbol()}))},n.hasPoint=function(){var t=!1;return this._eachPainter((function(e){return!e.hasPoint()||(t=!0,!1)})),t},n.getMinAltitude=function(){var t=!0,e=0;return this._eachPainter((function(n){var i=n.getMinAltitude();(t||i<e)&&(t=!1,e=i)})),e},n.getMaxAltitude=function(){var t=0;return this._eachPainter((function(e){var n=e.getMaxAltitude();n>t&&(t=n)})),t},e}(Ql);function Ju(t,e=[]){return e.forEach((function(e){var[n,i]=e;t=t.replace(n,i)})),t}function Qu(t){var{projection:e,isArcgis:n,isGeoServer:i,isSuperMap:o}=t,s=.0002645833333333333;return(n||i||o)&&(s=28e-5),e&&e.indexOf("4326")>-1&&(s=2.3767925226029154e-9,(n||o)&&(s=2.518101729011901e-9),i&&(s=2.51528279553466e-9)),s}var Yu="wmts";function Ku(t,e){var n=t.getElementsByTagName(e);return n&&n.length?n:t.getElementsByTagName(Yu+":"+e)}function $u(t,e){for(var n=0;n<t.length;n++){var i=t[n];if((i=i.getElementsByTagName("ows:Identifier")[0])&&i.textContent===e)return t[n]}return null}function tf(t,e={}){var n,i,o,s=Ku(t,"TileMatrix"),a=[],l=[],h=[],c=!1;if(!n){var u=t.getElementsByTagName("ows:SupportedCRS")[0];u&&(n=function(t){for(var e="",n=t.split(""),i=n.length-1;i>=0&&!isNaN(n[i]);i--)e=n[i]+e;return e}(n=(n=u.textContent).split("EPSG")[1]),n=function(t){var e=t.indexOf("EPSG")>-1?t:"EPSG:"+t;return Ju(e,[["4490","4326"],["102100","3857"],["900913","3857"]])}(n))}i||(i=t.getElementsByTagName("ows:Identifier")[0])&&(i=i.textContent),e.projection=n;for(var f=1/0,g=0;g<s.length;g++){var A=s[g],m=A.getElementsByTagName("ows:Identifier")[0].textContent;isNaN(parseInt(m))?(o=m.substr(0,m.lastIndexOf(":")),m=(m=m.split(":"))[m.length-1],m=parseInt(m),c=!0,e.isGeoServer=!0):m=parseInt(m),f=Math.min(f,m);var w=Ku(A,"ScaleDenominator")[0].textContent,T=Ku(A,"TopLeftCorner")[0].textContent,M=Ku(A,"TileWidth")[0].textContent,C=Ku(A,"TileHeight")[0].textContent;if(0===h.length&&h.push(parseInt(M),parseInt(C)),0===l.length){var[P,I]=T.split(" ").filter((function(t){return""!==t})).map((function(t){return parseFloat(t)}));P>0?l.push(1,-1,I,P):l.push(1,-1,P,I)}var O=Qu(e),E=parseFloat(w)*O;a.push(E)}if(f>0)for(var D=a[0],N=f-1;N>=0;N--)a.splice(0,0,D*=2);return{resolutions:a,tileSize:h,tileSystem:l,projection:n,TileMatrixSet:i,isGeoServer:c,levelStr:o}}var ef=function(t,e,n={jsonp:!0}){g(t)&&cr.get(t,(function(i,o){if(i)e(i);else{var s=function(t,e,n){["isArcgis","isSuperMap","isGeoServer"].every((function(t){return null==n[t]}))&&console.warn("Please specify the server type, such as isArcgis, isSuperMap, isGeoServer, Otherwise, the system will determine by itself"),null==n.isArcgis&&(n.isArcgis=["arcgis","geoscene"].some((function(e){return t.indexOf(e)>-1}))),null==n.isSuperMap&&(n.isSuperMap=t.indexOf("supermap")>-1);var i=(new DOMParser).parseFromString(t,"text/xml").querySelectorAll("Contents")[0];if(!i)return[];var o=Ku(i,"Layer");if(!o.length)return[];for(var s=[],a=0,l=i.childNodes.length;a<l;a++)"TileMatrixSet"===i.childNodes[a].localName&&s.push(i.childNodes[a]);if(!s.length)return[];for(var h=[],c=0,u=o.length;c<u;c++){var f=o[c],g=f.querySelectorAll("Style")[0];g&&(g=g.getElementsByTagName("ows:Identifier")[0])&&(g=g.textContent);var A=f.getElementsByTagName("ows:Identifier")[0];A&&(A=A.textContent);var m=Ku(f,"TileMatrixSetLink");if(0!==m.length)for(var w=0,T=m.length;w<T;w++){var M=m[w];(M=Ku(M,"TileMatrixSet")[0])&&(M=M.textContent);var C=$u(s,M);if(C){var P=f.querySelectorAll("ResourceURL")[0],I="";P&&(I=P.attributes.template.value);var{resolutions:O,tileSize:E,tileSystem:D,projection:N,TileMatrixSet:H,isGeoServer:U,levelStr:W}=tf(C,n);I.length||(I=e.substr(0,e.lastIndexOf("?")),I+="?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER={LAYER}&STYLE={Style}&TILEMATRIXSET={TileMatrixSet}&FORMAT={tiles}&TILEMATRIX={TileMatrix}&TILEROW={TileRow}&TILECOL={TileCol}");var q=Ju(I,[["{LAYER}",A],["{Layer}",A],["{layer}",A],["{STYLE}",g],["{Style}",g],["{style}",g],["{TileMatrixSet}",H],["{TileMatrix}",U?W+":{z}":"{z}"],["{TileRow}","{y}"],["{TileCol}","{x}"],["{tiles}",U?"image/png":"tiles"]]);h.push({tileSize:E,tileSystem:D,spatialReference:{resolutions:O,projection:N},urlTemplate:q,info:{layerName:A,TileMatrixSet:H,style:g,tileSize:E,tileSystem:D,resolutions:O,projection:N,urlTemplate:q}})}}}return h}(o,t,n);e(null,s)}}),n)};function nf(t){for(var e=t.tileInfo,n=[e.cols,e.rows],i=[],o=e.lods,s=0,a=o.length;s<a;s++)i.push(o[s].resolution);var l=t.fullExtent,h=e.origin,c=[1,-1,h.x,h.y];return delete l.spatialReference,{spatialReference:{resolutions:i,fullExtent:l},tileSystem:c,tileSize:n}}var rf;function of(){if(!rf){var t=Math.round(s.crsMaxNativeZoom||22);rf={"EPSG:3857":{projection:"EPSG:3857",resolutions:function(){for(var e=[],n=12756274*Math.PI,i=0;i<=t;i++)e[i]=n/(256*Math.pow(2,i));return e}(),fullExtent:{top:6378137*Math.PI,left:-6378137*Math.PI,bottom:-6378137*Math.PI,right:6378137*Math.PI}},"EPSG:4326":{projection:"EPSG:4326",fullExtent:{top:90,left:-180,bottom:-90,right:180},resolutions:function(){for(var e=[],n=0;n<=t;n++)e[n]=180/(128*Math.pow(2,n));return e}()},BAIDU:{projection:"baidu",resolutions:function(){for(var e=Math.pow(2,18),n=[],i=0;i<=t;i++)n[i]=e,e*=.5;return n}(),fullExtent:{top:33554432,left:-33554432,bottom:-33554432,right:33554432}},IDENTITY:{projection:"identity",resolutions:function(){for(var e=Math.pow(2,8),n=[],i=0;i<=t;i++)n[i]=e,e*=.5;return n}(),fullExtent:{top:2e5,left:-2e5,bottom:-2e5,right:2e5}},"PRESET-VT-3857":{projection:"EPSG:3857",resolutions:function(){for(var e=[],n=6378137*Math.PI,i=0;i<=t;i++)e[i]=n/(256*Math.pow(2,i));return e}(),fullExtent:{top:6378137*Math.PI,left:-6378137*Math.PI,bottom:-6378137*Math.PI,right:6378137*Math.PI}},"PRESET-VT-4326":{projection:"EPSG:4326",fullExtent:{top:90,left:-180,bottom:-90,right:180},resolutions:function(){for(var e=[],n=0;n<=t;n++)e[n]=45/(128*Math.pow(2,n));return e}()}},rf["EPSG:4490"]=rf["EPSG:4326"],rf["PRESET-3857-512"]=rf["PRESET-VT-3857"],rf["PRESET-4326-512"]=rf["PRESET-VT-4326"],rf["PRESET-4490-512"]=rf["PRESET-VT-4326"]}return rf}var sf=function(){function t(t={}){this.options=t,this._initSpatialRef()}t.registerPreset=function(t,e){t=t&&t.toUpperCase();var n=of();n[t]&&console.warn("Spatial reference "+t+" already registered."),n[t]=e},t.getPreset=function(t){return of()[t.toUpperCase()]},t.getAllPresets=function(){return Object.keys(of())},t.loadArcgis=function(t,e,n){return function(t,e,n={jsonp:!0}){if(g(t)&&"{"!==t.substring(0,1))cr.getJSON(t,(function(t,n){if(t)e(t);else{var i=nf(n);e(null,i)}}),n);else{g(t)&&(t=Ee(t));var i=nf(t);e(null,i)}}(t,e,n),this},t.loadWMTS=function(t,e,n){return ef(t,e,n),this},t.getProjectionInstance=function(t){var e;if(!t)return null;if((e=g(t)?{code:t}:t).project)return e.locate||(e=l({},e),l(e,Wh.getInstance("identity"===e.measure?"IDENTITY":"EPSG:4326"))),e;var n=(e.code+"").toLowerCase();for(var i in xc)if(w(xc,i)){var o=xc[i].aliases||[],s=xc[i].code;s&&o.push(s);for(var a=0;a<o.length;a++)if(o[a].toLowerCase()===n){if(xc[i].create){var h=xc[i].create(t);return h.code=o[a],h}if(xc[i].code===o[a])return xc[i];var c=l({},xc[i]);return c.code=o[a],c}}return null},t.equals=function(t,e){if(g(t)||g(e))return t===e;if(!t&&!e)return!0;if(!t||!e)return!1;if(t.projection!==e.projection)return!1;var n=t.fullExtent,i=e.fullExtent;if(n&&!i||!n&&i)return!1;if(n&&i&&(n.top!==i.top||n.bottom!==i.bottom||n.left!==i.left||n.right!==i.right))return!1;var o=t.resolutions,s=e.resolutions;if(o&&s){if(o.length!==s.length)return!1;for(var a=0;a<o.length;a++)if(o[a]!==s[a])return!1}else if(o||s)return!1;return!0};var e=t.prototype;return e._initSpatialRef=function(){var e;if(!(e=this.options.projection?t.getProjectionInstance(this.options.projection):vc))throw new Error("must provide a valid projection in map's spatial reference.");(e=l({},kh,e)).measureLength||l(e,jh),this._projection=e;var n,i=of(),o=this.options.resolutions;if(!o&&(e.code&&(n=i[e.code.toUpperCase()])&&(o=n.resolutions,this.isEPSG="IDENTITY"!==e.code),!o))throw new Error("must provide valid resolutions in map's spatial reference.");if(this._resolutions=o,this._pyramid=!0,this._pyramid)for(var s=0;s<o.length;s++)if(o[s]&&o[s-1]&&Math.round(o[s-1]/o[s]*1e4)/1e4!=2){this._pyramid=!1;break}var a=this.options.fullExtent;if(!a&&(e.code&&(n=i[e.code.toUpperCase()])&&(a=n.fullExtent),!a))throw new Error("must provide a valid fullExtent in map's spatial reference.");if(h(a.left)?(this._fullExtent=new Ph(a),a.left=a.xmin,a.right=a.xmax,a.top=a.ymax,a.bottom=a.ymin):this._fullExtent=new Ph(new gh(a.left,a.top),new gh(a.right,a.bottom)),h(a.top)||h(a.bottom)||h(a.left)||h(a.right))throw new Error("must provide valid top/bottom/left/right in fullExtent.");l(this._fullExtent,a),this._projection.fullExtent=a,this._transformation=new Eh([a.right>=a.left?1:-1,a.top>=a.bottom?-1:1,0,0])},e.getResolutions=function(){return this._resolutions||[]},e.getResolution=function(t){var e=0|t;e<0?e=0:e>this._resolutions.length-1&&(e=this._resolutions.length-1);var n=this._resolutions[e];return e!==t&&t>0&&e<this._resolutions.length-1?n+(this._resolutions[e+1]-n)*(t-e):n},e.getProjection=function(){return this._projection},e.getFullExtent=function(){return this._fullExtent},e.getTransformation=function(){return this._transformation},e.getMinZoom=function(){for(var t=0;t<this._resolutions.length;t++)if(!h(this._resolutions[t]))return t;return 0},e.getMaxZoom=function(){for(var t=this._resolutions.length-1;t>=0;t--)if(!h(this._resolutions[t]))return t;return this._resolutions.length-1},e.getZoomDirection=function(){return Ge(this._resolutions[this.getMinZoom()]-this._resolutions[this.getMaxZoom()])},e.toJSON=function(){return this.json||(this.json={resolutions:this._resolutions,fullExtent:{top:this._fullExtent.top,left:this._fullExtent.left,bottom:this._fullExtent.bottom,right:this._fullExtent.right},projection:this._projection.code}),this.json},e.isPyramid=function(){return this._pyramid},t}();var af=new _e(0,0),lf=new Oh,hf={};var cf=function(t){function e(e){var n,i=l({},e),o=i.symbol,s=i.properties,a=i.id;return delete i.symbol,delete i.id,delete i.properties,n=t.call(this,i)||this,o?n.setSymbol(o):n._genSizeSymbol(),s&&n.setProperties(s),h(a)||n.setId(a),e&&c(e.rotateAngle)&&(n._dirtyRotate=!0),n}he(e,t),e.fromJSON=function(t){return t};var n=e.prototype;return n.getFirstCoordinate=function(){if("GeometryCollection"===this.type){var t=this.getGeometries();return t.length?t[0].getFirstCoordinate():null}var e=this.getCoordinates();if(!Array.isArray(e))return e;do{e=e[0]}while(Array.isArray(e)&&e.length>0);return e},n.getLastCoordinate=function(){if("GeometryCollection"===this.type){var t=this.getGeometries();return t.length?t[t.length-1].getLastCoordinate():null}var e=this.getCoordinates();if(!Array.isArray(e))return e;do{e=e[e.length-1]}while(Array.isArray(e)&&e.length>0);return e},n.addTo=function(t,e){return t.addGeometry(this,e),this},n.getLayer=function(){return this._layer?this._layer:null},n.getMap=function(){return this._layer?this._layer.getMap():null},n.getId=function(){return this._id},n.setId=function(t){var e=this.getId();return this._id=t,this._fireEvent("idchange",{old:e,new:t}),this},n.getProperties=function(){return this.properties?this.properties:this._getParent()?this._getParent().getProperties():null},n.setProperties=function(t){var e=this.properties;return this.properties=f(t)?l({},t):t,(this.getGeometries?this.getGeometries():[]).forEach((function(e){var n=l(e.getProperties&&e.getProperties()||{},t||{});e.setProperties&&e.setProperties(n)})),this._clearAltitudeCache(),this._repaint(),this._fireEvent("propertieschange",{old:e,new:t}),this},n.getType=function(){return this.type},n.getSymbol=function(){var t=this._symbol;return t?Array.isArray(t)?jo(t):l({},t):null},n.setSymbol=function(t){return this._symbolUpdated=t,this._symbol=this._prepareSymbol(t),this.onSymbolChanged(),delete this._compiledSymbol,delete this._symbolHash,this},n.getSymbolHash=function(){return this._symbolHash||(this._symbolHash=zo(this._symbolUpdated)),this._symbolHash},n.updateSymbol=function(t){if(!t)return this;var e=this._getSymbol(),n=Array.isArray(t);if(e||(e=this._getInternalSymbol()||{}),!Array.isArray(e)&&n&&(t=t[0]||{}),Array.isArray(e)){if(!n)for(t=[t];t.length<e.length;)t.push({});for(var i=0;i<t.length;i++)Gc(t[i])&&delete this._textDesc,e[i]&&t[i]&&(e[i]=jo(e[i],t[i]))}else{if(Array.isArray(t))return console.error("Geometry's symbol is object but the update symbol is array."),console.error("Geometry's symbol and update symbol:",e,t),this;Gc(e)&&delete this._textDesc,e=jo(e||this._getInternalSymbol(),t)}return this._eventSymbolProperties=t,delete this._compiledSymbol,this.setSymbol(e)},n.getTextContent=function(){var t=this._getInternalSymbol();if(Array.isArray(t)){for(var e=[],n=!1,i=0;i<t.length;i++)e[i]=fi(t[i]&&t[i].textName,this.getProperties()),h(e[i])||(n=!0);return n?e:null}return fi(t&&t.textName,this.getProperties())},n.getTextDesc=function(){if(!this._textDesc){var t=this.getTextContent(),e=this._sizeSymbol,n=Array.isArray(t);this._textDesc=Array.isArray(e)?e.map((function(e,i){return di(n?t[i]:"",e)})):di(t,e)}return this._textDesc},n.getCenter=function(){return this._computeCenter(this._getMeasurer())},n.getExtent=function(){var t=this._getPrjExtent(),e=this._getProjection();if(t&&e){var n=e.unproject(new gh(t.xmin,t.ymin)),i=e.unproject(new gh(t.xmax,t.ymax));return new Ph(n,i,e)}return this._computeExtent(this._getMeasurer())},n.getContainerExtent=function(t){var e=this.get2DExtent();if(!e||!e.isValid())return null;var n=this.getMap(),i=n.getGLRes(),o=this.getMinAltitude(),s=e.convertTo((function(t){return n._pointAtResToContainerPoint(t,i,o,af)}),t),a=this.getMaxAltitude();if(a!==o){var l=e.convertTo((function(t){return n._pointAtResToContainerPoint(t,i,a,af)}),lf);s._combine(l)}var h=this.getLayer();if(h&&"LineString"===this.type&&a&&h.options.drawAltitude){var c=e.convertTo((function(t){return n._pointAtResToContainerPoint(t,i,0,af)}),lf);s._combine(c)}if(s){var u=this._getFixedExtent();(function(t){if(!t)return!1;var{xmin:e,ymin:n,xmax:i,ymax:o}=t;return i-e>0&&o-n>0})(u)&&s._add(u)}return this.options.smoothness&&s._expand(.15*s.getWidth()),s},n._getFixedExtent=function(){this._fixedExtent||(this._fixedExtent=new Oh);var t=this._sizeSymbol,e=(t&&t.lineWidth||1)/2;return this._fixedExtent.set(-e,-e,e,e),this._fixedExtent._add([t&&t.lineDx||0,0]),this._fixedExtent._add([0,t&&t.lineDy||0]),this._fixedExtent},n.get2DExtent=function(){var t=this.getMap();if(!t)return null;if(this._extent2d)return this._extent2d;var e=this._getPrjExtent();if(!e||!e.isValid())return null;var n=e.getMin(),i=e.getMax(),o=t.getGLRes();return t._prjToPointAtRes(n,o,n),t._prjToPointAtRes(i,o,i),this._extent2d=new Oh(n,i),this._extent2d.z=t.getZoom(),this._extent2d},n.getSize=function(){var t=this.getContainerExtent();return t?t.getSize():null},n.containsPoint=function(t,e){if(!this.getMap())throw new Error('The geometry is required to be added on a map to perform "containsPoint".');return t instanceof gh&&(t=this.getMap().coordToContainerPoint(t)),this._containsPoint(t,e)},n._containsPoint=function(t,e){var n=this._getPainter();return!!n&&(e=e||0,this._hitTestTolerance&&(e+=this._hitTestTolerance()),n.hitTest(t,e))},n.show=function(){if(this.options.visible=!0,this.getMap()){var t=this._getPainter();t&&t.show(),this._fireEvent("show")}return this},n.hide=function(){if(this.options.visible=!1,this.getMap()){this.onHide();var t=this._getPainter();t&&t.hide(),this._fireEvent("hide")}return this},n.isVisible=function(){if(!this.options.visible)return!1;var t=this._getInternalSymbol();if(!t)return!0;if(!this.symbolIsVisible())return!1;if(Array.isArray(t)){if(!t.length)return!0;for(var e=0,n=t.length;e<n;e++)if(h(t[e].opacity)||t[e].opacity>0)return!0;return!1}return h(t.opacity)||f(t.opacity)||c(t.opacity)&&t.opacity>0},n.symbolIsVisible=function(){var t=this._getCompiledSymbol();if(!t)return!0;Array.isArray(t)||(t=[t]);for(var e=0,n=t.length;e<n;e++){var i=t[e];if(i){var o=i.visible;if(!1!==o&&0!==o)return!0}}return!1},n.getZIndex=function(){return this.options.zIndex||0},n.setZIndex=function(t){var e=this.options.zIndex;return this.options.zIndex=t,this._fireEvent("zindexchange",{old:e,new:t}),this},n.setZIndexSilently=function(t){return this.options.zIndex=t,this},n.bringToFront=function(){var t=this.getLayer();if(!t||!t.getGeoMaxZIndex)return this;var e=t.getGeoMaxZIndex();return this.setZIndex(e+1),this},n.bringToBack=function(){var t=this.getLayer();if(!t||!t.getGeoMinZIndex)return this;var e=t.getGeoMinZIndex();return this.setZIndex(e-1),this},n.translate=function(t,e,n){if(h(t))return this;var i=new gh(t,e,n);if(0===i.x&&0===i.y&&(h(i.z)||0===i.z))return this;var o=this.getCoordinates();if(this._silence=!0,o)if(Array.isArray(o)){var s=Fe(o,(function(t){return t.add(i)}));this.setCoordinates(s)}else this.setCoordinates(o.add(i));return this._silence=!1,this._fireEvent("positionchange"),this},n._translateRotatePivot=function(t){if(!this._pivot||!t)return this;if(this.options.rotatePivot){var e=this.getCoordinates();if(!e)return this;t instanceof gh||(t=new gh(t));var n=t.sub(e);if(0===n.x&&0===n.y)return this;this._pivot._add(n),this.options.rotatePivot=this._pivot.toArray()}return this},n.flash=function(t,e,n,i){return Mn.call(this,t,e,n,i)},n.copy=function(){var t=this.toJSON(),n=e.fromJSON(t);return n.options.visible=!0,n},n.remove=function(){return this.getLayer()?(this._fireEvent("removestart"),this._unbind(),this._fireEvent("removeend"),this._fireEvent("remove"),this):this},n.toGeoJSONGeometry=function(){return this._exportGeoJSONGeometry()},n.toGeoJSON=function(t){t||(t={});var e={type:"Feature",geometry:null};if(h(t.geometry)||t.geometry){var n=this._exportGeoJSONGeometry();e.geometry=n}var i,o=this.getId();return h(o)||(e.id=o),(h(t.properties)||t.properties)&&(i=this._exportProperties()),e.properties=i,e},n.toJSON=function(t){t||(t={});var e=this._toJSON(t);return l(e,this._exportGraphicOptions(t)),e},n.getLength=function(){return this._computeGeodesicLength(this._getMeasurer())},n.getArea=function(){return this._computeGeodesicArea(this._getMeasurer())},n.rotate=function(t,e){if(!c(t))return console.error("angle:"+t+" is not number"),this;if(this._painter||(this._dirtyRotate=!0),"GeometryCollection"===this.type)return this.getGeometries().forEach((function(n){return n.rotate(t,e)})),this;e=e?new gh(e):this.getCenter(),this._angle=t,this._pivot=e;var n=this._getMeasurer(),i=this.getCoordinates();if(!Array.isArray(i)){if(e.x===i.x&&e.y===i.y||this.getShell)this.onPositionChanged();else{var o=n._rotate(i,e,t);this.setCoordinates(o)}return this.getShell&&(this.options.rotateAngle=t,this.options.rotatePivot=e.toArray()),this}return Fe(i,(function(i){return n._rotate(i,e,t)})),this.setCoordinates(i),this},n._rotatePrjCoordinates=function(t){if(!t||0===this._angle||!this._pivot)return t;var e=this._getProjection();if(!e)return t;var n,i,o=0,s=Array.isArray(t),a=s?t:[t],l=[];if(this.getRotateOffsetAngle){o=this.getRotateOffsetAngle();var h=a[a.length-1];n=h.x,i=h.y}else{var c=ws();Ps(a,c);var[u,f,g,A]=c;n=(u+g)/2,i=(f+A)/2}for(var m=0,w=a.length;m<w;m++){var T=a[m],{x:M,y:C}=T,P=M-n,I=C-i,O=Math.sqrt(P*P+I*I),E=(Af(n,i,M,C)-this._angle+o)/180*Math.PI,D=Math.cos(E)*O,N=Math.sin(E)*O,H=new gh(n+D,i+N);l.push(H)}for(var U=e.project(this._pivot),W=n-U.x,q=i-U.y,X=0,J=l.length;X<J;X++){var Q=l[X];Q.x-=W,Q.y-=q}return s?l:l[0]},n.isRotated=function(){return!(!c(this._angle)||!this._pivot)},n._getConnectPoints=function(){return[this.getCenter()]},n._initOptions=function(t){var e=l({},t),n=e.symbol,i=e.properties,o=e.id;delete e.symbol,delete e.id,delete e.properties,this._setOptions(e),n&&this.setSymbol(n),i&&this.setProperties(i),h(o)||this.setId(o)},n._bindLayer=function(t){if(t!==this.getLayer()){if(this.getLayer())throw new Error("Geometry cannot be added to two or more layers at the same time.");this._layer=t,this._clearCache(),this._bindInfoWindow(),this._bindMenu()}},n._prepareSymbol=function(t){if(Array.isArray(t)){for(var e=[],n=0;n<t.length;n++)e.push(Ro(this._checkAndCopySymbol(t[n])));return e}return t?Ro(t=this._checkAndCopySymbol(t)):null},n._checkAndCopySymbol=function(t){var e={};for(var n in t)e[n]=Gn[n]&&g(t[n])?+t[n]:t[n];return e},n._getSymbol=function(){return this._symbol},n._setExternSymbol=function(t){return this._eventSymbolProperties=t,this._symbol||delete this._textDesc,this._externSymbol=this._prepareSymbol(t),this.onSymbolChanged(),this},n._getInternalSymbol=function(){return this._symbol?this._symbol:this._externSymbol?this._externSymbol:this.options.symbol?this.options.symbol:null},n._getPrjExtent=function(){var t=this._getProjection();return this._verifyProjection(),!this._extent&&t&&(this._extent=this._computePrjExtent(t)),this._extent},n._unbind=function(){var t=this.getLayer();t&&(this._animPlayer&&this._animPlayer.finish(),this._unbindMenu(),this._unbindInfoWindow(),this.isEditing()&&this.endEdit(),this._removePainter(),this.onRemove&&this.onRemove(),t.onRemoveGeometry&&t.onRemoveGeometry(this),delete this._layer,delete this._internalId,delete this._extent)},n._getInternalId=function(){return this._internalId},n._setInternalId=function(t){this._internalId=t},n._getMeasurer=function(){return this._getProjection()?this._getProjection():sf.getProjectionInstance(this.options.defaultProjection)},n._getProjection=function(){var t=this.getMap();return t?t.getProjection():null},n._verifyProjection=function(){var t=this._getProjection();this._projCode&&t&&this._projCode!==t.code&&this._clearProjection(),this._projCode=t?t.code:this._projCode},n._getExternalResources=function(){return Eo(this._getInternalSymbol())},n._getPainter=function(){if(this._painter)return this._painter;var t=this.getLayer();if(!this._painter&&t)if(-1!==Nn.indexOf(this.type)){if(t.constructor.getCollectionPainterClass){var e=t.constructor.getCollectionPainterClass();e&&(this._painter=new e(this))}}else if(t.constructor.getPainterClass){var n=t.constructor.getPainterClass();n&&(this._painter=new n(this))}return this._painter},n._getMaskPainter=function(){return this._maskPainter||(this._maskPainter=this.getGeometries&&this.getGeometries()?new Xu(this,!0):new Wu(this)),this._maskPainter},n._removePainter=function(){this._painter&&this._painter.remove(),delete this._painter},n._paint=function(t){if(this.symbolIsVisible()&&this._painter){if(this._dirtyCoords){delete this._dirtyCoords;var e=this._getProjection();e&&(this._pcenter=e.project(this._coordinates),this._clearCache())}this._dirtyRotate&&c(this.options.rotateAngle)&&this.rotate(this.options.rotateAngle,this.options.rotatePivot),this._dirtyRotate=!1,this._painter.paint(t)}},n._clearCache=function(){delete this._extent,delete this._extent2d,this._clearAltitudeCache()},n._clearProjection=function(){delete this._extent,delete this._extent2d},n._repaint=function(){this._painter&&this._painter.repaint()},n.onHide=function(){this.closeMenu(),this.closeInfoWindow()},n.onShapeChanged=function(){this._clearCache(),this._repaint(),this._fireEvent("shapechange")},n.onPositionChanged=function(){this._clearCache(),this._repaint(),this._fireEvent("positionchange")},n.onSymbolChanged=function(){this._painter&&this._painter.refreshSymbol();var t={};this._eventSymbolProperties?(t.properties=JSON.parse(JSON.stringify(this._eventSymbolProperties)),delete this._eventSymbolProperties):delete this._textDesc,this._genSizeSymbol(),this._fireEvent("symbolchange",t)},n._genSizeSymbol=function(){var t=this._getInternalSymbol();if(t)if(Array.isArray(t)){this._sizeSymbol=[];for(var e=!1,n=0;n<t.length;n++){var i=this._sizeSymbol[n]=this._getSizeSymbol(t[n]);!e&&i&&i._dynamic&&(e=!0)}this._sizeSymbol._dynamic=e}else this._sizeSymbol=this._getSizeSymbol(t);else delete this._sizeSymbol},n._getSizeSymbol=function(t){var e=So({lineWidth:t.lineWidth,lineDx:t.lineDx,lineDy:t.lineDy},this);return(Kr(t.lineWidth)||Kr(t.lineDx)||Kr(t.lineDy))&&(e._dynamic=!0),e},n._getCompiledSymbol=function(){return this._compiledSymbol||(this._compiledSymbol=So(this._getInternalSymbol(),this)),this._compiledSymbol},n.onConfig=function(t){var e;t.properties&&(e=t.properties,delete t.properties);var n=!1;for(var i in t)if(t.hasOwnProperty(i)){var o=i.slice(0,5);if("arrow"===o||"smoot"===o){n=!0;break}}e?(this.setProperties(e),this._repaint()):n&&this._repaint()},n._setParent=function(t){t&&(this._parent=t)},n._getParent=function(){return this._parent},n._fireEvent=function(t,e){this._silence||(this.getLayer()&&this.getLayer()._onGeometryEvent&&(e||(e={}),e.type=t,e.target=this,this.getLayer()._onGeometryEvent(e)),this.fire(t,e))},n._toJSON=function(t){return{feature:this.toGeoJSON(t)}},n._recordVisible=function(){var t=this.options.visible;h(t)&&(t=!0),this._savedVisible=t},n._recoveryVisible=function(){delete this._savedVisible},n._exportGraphicOptions=function(t){var e={};return(h(t.options)||t.options)&&(e.options=this.config()),e.options&&this.isEditing&&this.isEditing()&&(e.options.visible=this._savedVisible),(h(t.symbol)||t.symbol)&&(e.symbol=this.getSymbol()),(h(t.infoWindow)||t.infoWindow)&&this._infoWinOptions&&(e.infoWindow=this._infoWinOptions),e},n._exportGeoJSONGeometry=function(){var t=this.getCoordinates(),e=gh.toNumberArrays(t);return{type:this.getType(),coordinates:e}},n._exportProperties=function(){var t=null,e=this.getProperties();return h(e)||(t=f(e)?l({},e):e),t},n._hitTestTolerance=function(){return 0},n._getAltitude=function(){var t=this.getLayer();if(!t)return 0;var e=t.options,n=t.getAltitude?t.getAltitude():0,i=e.enableAltitude;if(!i&&t.isVectorLayer)return n;var o=uf(t),s=(this.properties||hf)[o];if(h(s)){var a=ff(this,n,i);return h(a)?n:a}return Array.isArray(s)?s.map((function(t){return t+n})):s+n},n.getAltitude=function(){var t=uf(this.getLayer()),e=(this.properties||hf)[t];if(!h(e))return e;var n=ff(this,0,!1);return h(n)?0:n},n.hasAltitude=function(){return this._genMinMaxAlt(),!!this._minAlt||!!this._maxAlt},n.setAltitude=function(t){if(!c(t))return this;var e=this.getLayer(),n=uf(e),i=this.properties||hf,o=i[n];if(!h(o))if(Array.isArray(o))for(var s=0,a=o.length;s<a;s++)o[s]=t;else i[n]=t;var l=this.getCoordinates?this.getCoordinates():null;if(!l)return this;if(df(l,t),e){var u=e.getRenderer();u&&(u.gl||u.device)?this.setCoordinates(l):u&&this._repaint()}return this._clearAltitudeCache(),this.onPositionChanged(),this},n._genMinMaxAlt=function(){if(void 0===this._minAlt||void 0===this._maxAlt){var t=this._getAltitude(),[e,n]=eu(t);this._minAlt=e,this._maxAlt=n}},n.getMinAltitude=function(){return this._genMinMaxAlt(),this._minAlt},n.getMaxAltitude=function(){return this._genMinMaxAlt(),this._maxAlt},n._clearAltitudeCache=function(){return this._minAlt=void 0,this._maxAlt=void 0,this},n._getEditCenter=function(){var t=this.getCenter().copy();t.z=0;var e=this.getAltitude();if(c(e))return t.z=e,t;var n=0,i=0,o=function(t){for(var e=0,s=t.length;e<s;e++)Array.isArray(t[e])?o(t[e]):(i++,n+=t[e])};return Array.isArray(e)&&(o(e),t.z=n/i),t},e}(lh(Xl(hh(Ql))));function uf(t){var e="altitude";if(t){if(!t.isVectorLayer)return null;e=t.options.altitudeProperty}return e}function ff(t,e,n){var i=t.getCoordinates?t.getCoordinates():null;if(i){var o=[];if(gf(i,o),o.length)return pf(i,e,n)}return null}function df(t,e){if(Array.isArray(t))for(var n=0,i=t.length;n<i;n++)df(t[n],e);else t.z=e}function gf(t,e){if(!e.length)if(Array.isArray(t))for(var n=0,i=t.length;n<i;n++)gf(t[n],e);else c(t.z)&&e.push(t.z)}function pf(t,e,n){if(Array.isArray(t)){for(var i=[],o=0,s=t.length;o<s;o++)i.push(pf(t[o],e,n));return i}return c(t.z)?n?e+t.z:t.z:n?e:0}function Af(t,e,n,i){return t===n?i>e?-90:90:(n-=t,i=-(i-=e),Math.atan2(i,n)/Math.PI*180)}cf.mergeOptions({id:null,visible:!0,interactive:!0,editable:!0,cursor:null,antiMeridian:!1,defaultProjection:"EPSG:4326"});var mf="check_browser_max_fps";va(mf,(function(){return"function (exports) {\n    exports.initialize = function () {};\n    function now(){\n        return  new Date().getTime();\n    }\n    function checkFPS(cb) {\n        if (!requestAnimationFrame) {\n            cb(-1);\n            return;\n        }\n        const count = 100;\n        let idx = 0;\n        let id;\n        let startTime;\n        function loop() {\n            idx++;\n            if (idx === count) {\n                cancelAnimationFrame(id);\n                const endTime = now();\n                const timePerFPS = (endTime - startTime) / count;\n                const fps = Math.floor(1000 / timePerFPS);\n                cb(fps);\n            } else {\n                id = requestAnimationFrame(loop);\n            }\n        }\n        startTime = now();\n        id = requestAnimationFrame(loop);\n    }\n    //recive message\n    exports.onmessage = function (msg, postResponse) {\n        checkFPS((fps) => {\n            if (fps < -1) {\n                postResponse('check fps fail');\n            } else {\n                postResponse(null, { fps });\n            }\n        })\n    }\n}"}));var yf,_f=0,vf=[],xf=function(){function t(t){var e=this;Wa(),this._delayMessages=[],this.initializing=!1;var n=ma(t);pa&&!n&&(this.initializing=!0,console.log("Injecting codes in worker with worker key: :"+t),Ca(t,(function(){e.initializing=!1,e.created()}))),this.workerKey=t,this.workerPool=La(),this.currentActor=0,this.actorId=we(),this.workers=this.workerPool.acquire(this.actorId),this.callbacks={},this.callbackID=0,this.receiveFn=this.receive.bind(this),this.workers.forEach((function(t){t.addEventListener("message",e.receiveFn,!1)})),ya(t)}var e=t.prototype;return e.created=function(){var t=this;this._delayMessages.forEach((function(e){var{command:n,data:i,buffers:o,cb:s,workerId:a}=e;t[n](i,o,s,a)})),this._delayMessages=[]},e.isActive=function(){return!!this.workers},e.broadcast=function(t,e,n){var i=this;return this.initializing?(this._delayMessages.push({command:"broadcast",data:t,buffers:e,cb:n}),this):(function(t,e,n){t.length||n(null,[]);var i=t.length,o=new Array(t.length),s=null;t.forEach((function(t,a){e(t,(function(t,e){t&&(s=t),o[a]=e,0==--i&&n(s,o)}))}))}(this.workers,(function(n,o){i.send(t,e,o,n.id)}),n=n||function(){}),this)},e.send=function(t,e,n,i){if(this.initializing)return this._delayMessages.push({command:"send",data:t,buffers:e,cb:n,workerId:i}),this;var o=n?this.actorId+":"+this.callbackID++:null;return n&&(this.callbacks[o]=n),this.post({data:t,callback:String(o)},e,i),this},e.receive=function(t){var e=this,n=t.data,i=n.callback,o=this.callbacks[i];delete this.callbacks[i],"<request>"===n.type?this.actorId===n.actorId&&this[n.command](n.params,(function(t,i,o){var s={type:"<response>",callback:n.callback};t?s.error=t.message:s.data=i,e.post(s,o||vf,n.workerId)})):o&&n.error?o(n.error):o&&o(null,n.data)},e.remove=function(){var t=this;this.workers.forEach((function(e){e.removeEventListener("message",t.receiveFn,!1)})),delete this.receiveFn,delete this.workers,delete this.callbacks,delete this.workerPool},e.post=function(t,e,n){return("number"!=typeof n||isNaN(n))&&(n=this.currentActor=(this.currentActor+1)%this.workerPool.workerCount),t.workerId=n,t.workerKey=this.workerKey,t.actorId=this.actorId,this.workerPool.addMessage(n,t,e||vf),n},e.getDedicatedWorker=function(){return _f=(_f+1)%this.workerPool.workerCount},t}();var bf=function(t){function e(){return t.call(this,mf)||this}return he(e,t),e}(xf);var wf=!1;Za((function(){var t;wf||s.maxFPS<=0&&(wf=!0,t=function(t){c(t)&&t>0&&s.maxFPS<=0&&(s.maxFPS=t),wf=!1},yf||(yf=new bf),yf.send({},[],(function(e,n){e?(console.error(e),t()):t(n.fps)})))}));var Tf=[],Mf=function(t){function e(){return t.call(this,da)||this}return he(e,t),e.prototype.fetchImage=function(t,e){this.send({url:t},Tf,e)},e}(xf),Cf=function(t){function e(e){var n;return(n=t.call(this)||this).layer=e,n._painted=!1,n._drawTime=0,!Gt.decodeImageInWorker||Gt.safari||Gt.iosWeixin||(n._resWorkerConn=new Mf),n.setToRedraw(),n}he(e,t);var i=e.prototype;return i.render=function(t){this.prepareRender(),this.getMap()&&this.layer.isVisible()&&(this.resources||(this.resources=zs()),this.checkAndDraw(this._tryToDraw,t),this._frameTime=t)},i.getFrameTimestamp=function(){return this._frameTime||0},i.checkAndDraw=function(t,...e){var n=this;if(this._toRedraw=!1,this.checkResources){var i=this.checkResources();i.length>0?(this._loadingResource=!0,this.loadResources(i).then((function(){if(n._loadingResource=!1,n.layer){n.layer.fire("resourceload");var t=n.layer.getMap();n.setToRedraw(),t.getRenderer().callInNextFrame((function(){n.setToRedraw()}))}}))):t.call(this,...e)}else t.call(this,...e)},i.testIfNeedRedraw=function(){var t=this.getMap();return!this._loadingResource&&(!!this._toRedraw||!(t.isInteracting()&&!this.drawOnInteracting)&&!!this.needToRedraw())},i.needToRedraw=function(){var t=this.getMap();return!(!t.isInteracting()&&!t.getRenderer().isViewChanged())},i.onSkipDrawOnInteracting=function(){},i.isLoadingResource=function(){return this._loadingResource},i.isRenderComplete=function(){return!!this._renderComplete},i.mustRenderOnInteracting=function(){return!this._painted},i.setToRedraw=function(){return this._toRedraw=!0,this},i.remove=function(){this.onRemove(),delete this._loadingResource,delete this.middleWest,delete this.canvas,delete this.context,delete this.canvasExtent2D,delete this._extent2D,this.resources&&this.resources.remove(),delete this.resources,this._resWorkerConn&&(this._resWorkerConn.remove(),delete this._resWorkerConn),delete this.layer},i.onRemove=function(){},i.onAdd=function(){},i.getMap=function(){return this.layer?this.layer.getMap():null},i.getCanvasImage=function(){var t=this.getMap();if(this._renderZoom!==t.getZoom()||!this.canvas||!this._extent2D)return null;if(this.isBlank())return null;if(this.layer.isEmpty&&this.layer.isEmpty())return null;var e=t._pointToContainerPoint(this.middleWest)._add(0,-t.height/2);return{image:this.canvas,layer:this.layer,point:e}},i.clear=function(){},i.isBlank=function(){return!this._painted},i.show=function(){this.setToRedraw()},i.hide=function(){this.clear(),this.setToRedraw()},i.setZIndex=function(t){this.setToRedraw()},i.screenshotRenderResult=function(t,e,n,i){if(this.canvas){var o=zl.getTempCanvas();o.width=n,o.height=i;var s=zl.getCanvas2DContext(o);return s.clearRect(0,0,n,i),s.drawImage(this.canvas,t,e,n,i,0,0,n,i),s}console.warn("not find layer canvas for screenshotRenderResult,the layerId:",this.layer.getId())},i.hitDetect=function(t){if(!this.context||this.layer.isEmpty&&this.layer.isEmpty()||this.isBlank()||this._errorThrown||this.layer.isVisible&&!this.layer.isVisible())return!1;var e=this.getMap(),n=this.mapDPR||e.getDevicePixelRatio(),i=e.getSize();if(t.x<0||t.x>i.width*n||t.y<0||t.y>i.height*n)return!1;var o=Math.round(n*t.x),s=Math.round(n*t.y),a=this.getImageData&&this.getImageData();if(a)return a.data[s*a.width*4+4*o+3]>0;try{var l=this.screenshotRenderResult(o,s,2,2);if(l)if(l.getImageData(o,s,1,1).data[3]>0)return!0}catch(t){return this._errorThrown||(console&&console.warn("hit detect failed with tainted canvas, some geometries have external resources in another domain:\n",t),this._errorThrown=!0),!1}return!1},i.loadResources=function(t){this.resources||(this.resources=new Ns);var e=this.resources,n=[];if(Je(t))for(var i={},o=t.length-1;o>=0;o--){var s=t[o];if(s&&s.length){var a=s.join("-");if(!Fo(s[0])){if(i[a])continue;i[a]=1}e.isResourceLoaded(s,!0)||n.push(new Promise(this._promiseResource(s)))}}return Promise.all(n)},i.prepareRender=function(){delete this._renderComplete;var t=this.getMap();this._renderZoom=t.getZoom(),this.canvasExtent2D=this._extent2D=t.get2DExtent(),this.middleWest=t._containerPointToPoint(new _e(0,t.height/2))},i.prepareCanvas=function(){if(!this.context){var t=this.getMap();this.canvas=t.getRenderer().canvas,this.context=t.getRenderer().context,this.initContext()}this.prepareContext(),delete this._maskExtent;var e=this.layer.getMask();if(!e)return this.layer.fire("renderstart",{context:this.context}),null;var n=this._maskExtent=e._getMaskPainter().get2DExtent();return n&&this._extent2D&&n.intersects(this._extent2D),this.layer.fire("renderstart",{context:this.context}),n},i.initContext=function(){},i.prepareContext=function(){},i.clearContext=function(){},i.getViewExtent=function(){return{extent:this._extent2D,maskExtent:this._maskExtent,zoom:this._renderZoom,middleWest:this.middleWest}},i.completeRender=function(){this.getMap()&&(this._renderComplete=!0,this.layer.fire("renderend",{context:this.context}))},i.getEvents=function(){return{_zoomstart:this.onZoomStart,_zooming:this.onZooming,_zoomend:this.onZoomEnd,_resize:this.onResize,_movestart:this.onMoveStart,_moving:this.onMoving,_moveend:this.onMoveEnd,_dragrotatestart:this.onDragRotateStart,_dragrotating:this.onDragRotating,_dragrotateend:this.onDragRotateEnd,_spatialreferencechange:this.onSpatialReferenceChange}},i.onZoomStart=function(t){},i.onZoomEnd=function(t){this.setToRedraw()},i.onZooming=function(t){},i.onMoveStart=function(t){},i.onMoving=function(t){},i.onMoveEnd=function(t){this.setToRedraw()},i.onResize=function(t){delete this._extent2D,this.setToRedraw()},i.onDragRotateStart=function(t){},i.onDragRotating=function(t){},i.onDragRotateEnd=function(t){this.setToRedraw()},i.onSpatialReferenceChange=function(t){},i.getDrawTime=function(){return this._drawTime},i._tryToDraw=function(t){this._toRedraw=!1,!this.canvas&&this.layer.isEmpty&&this.layer.isEmpty()?this._renderComplete=!0:this._drawAndRecord(t)},i._drawAndRecord=function(t){var e=this.getMap();if(e){var n=this._painted;this._painted=!0;var i=a();this.mapDPR=e.getDevicePixelRatio(),this.draw(t),i=a()-i,this._drawTime=n?i:i/2,n&&this.layer&&this.layer.options.logDrawTime&&console.log(this.layer.getId(),"frameTimeStamp:",t,"drawTime:",this._drawTime)}},i._promiseResource=function(t){var e=this,i=this.layer,o=this.resources,s=i.options.crossOrigin,a=i.options.renderer||"";return function(l){if(o.isResourceLoaded(t,!0))l(t);else{var c=vr(t[0]);if(Fo(c))createImageBitmap(c).then((function(n){e._cacheResource(t,n),l(t)})).catch((function(e){console.error(e),l(t)}));else if(!ve(t[0])&&e._resWorkerConn&&("canvas"!==i.options.renderer||i.options.decodeImageInWorker))e._resWorkerConn.fetchImage(c,(function(n,i){if(n)return n&&"undefined"!=typeof console&&console.warn(n),void l(t);On(i,(function(n){e._cacheResource(t,n),l(t)}))}));else{var u=new Image;h(s)?"canvas"!==a&&(u.crossOrigin=""):u.crossOrigin=s,ve(t[0])&&!n&&(t[1]&&(t[1]*=2),t[2]&&(t[2]*=2)),u.onload=function(){e._cacheResource(t,u),l(t)},u.onabort=function(e){console&&console.warn("image loading aborted: "+t[0]),e&&console&&console.warn(e),l(t)},u.onerror=function(e){e&&"undefined"!=typeof console&&console.warn(e),o.markErrorResource(t),l(t)},xe(u,[c])}}}},i._cacheResource=function(t,e){if(this.layer&&this.resources){var n=t[1],i=t[2];if(this.layer.options.cacheSvgOnCanvas&&1===ve(t[0])&&(Gt.edge||Gt.ie)){h(n)&&(n=e.width||this.layer.options.defaultIconSize[0]),h(i)&&(i=e.height||this.layer.options.defaultIconSize[1]);var o=zl.createCanvas(n,i);zl.image(o.getContext("2d"),e,0,0,n,i),e=o}this.resources.addResource(t,e)}},e}(Ql);Gt.decodeImageInWorker&&va(da,(function(){return"\nfunction (exports) {\n    exports.onmessage = function (msg, postResponse) {\n        var url = msg.data.url;\n        var fetchOptions = msg.data.fetchOptions;\n        requestImageOffscreen(url, function (err, data) {\n            var buffers = [];\n            if (data && data.data) {\n                buffers.push(data.data);\n            }\n            postResponse(err, data, buffers);\n        }, fetchOptions);\n    };\n\n    function requestImageOffscreen(url, cb, fetchOptions) {\n        fetch(url, fetchOptions ? fetchOptions : {})\n            .then(response => response.arrayBuffer())\n            .then(arrayBuffer => {\n                const blob=new Blob([arrayBuffer]);\n                return createImageBitmap(blob);\n            })\n            .then(bitmap => {\n                cb(null, {data:bitmap});\n            }).catch(err => {\n                console.error('error when loading tile:', url);\n                console.error(err);\n                cb(err);\n            });\n    }\n}"}));var Sf={attribution:null,minZoom:null,maxZoom:null,visible:!0,opacity:1,globalCompositeOperation:null,renderer:"canvas",debugOutline:"#0f0",cssFilter:null,forceRenderOnMoving:!1,forceRenderOnZooming:!1,forceRenderOnRotating:!1,collision:!1,collisionScope:"layer",hitDetect:!Gt.mobile,maskClip:!0},Pf=function(t){function e(e,n){var i,o;return n&&(o=n.canvas,delete n.canvas),(i=t.call(this,n)||this)._canvas=o,i.setId(e),n&&(i.setZIndex(n.zIndex),n.mask&&i.setMask(cf.fromJSON(n.mask))),i.proxyOptions(),i}he(e,t);var n=e.prototype;return n.load=function(){if(!this.getMap())return this;if(this.onLoad()){this._initRenderer();var t=this.getZIndex();h(t)||this._renderer&&(this._renderer.setZIndex(t),this.isCanvasRender()||this._renderer.render()),this.onLoadEnd()}return this},n.getId=function(){return this._id},n.setId=function(t){var e=this._id;return h(t)||(t+=""),this._id=t,this.fire("idchange",{type:"idchange",target:this,old:e,new:t}),this},n.addTo=function(t){return t.addLayer(this),this},n.setZIndex=function(t){return this._zIndex=t,h(t)?delete this.options.zIndex:this.options.zIndex=t,this.map&&this.map._sortLayersByZIndex(),this._renderer&&this._renderer.setZIndex(t),this.fire("setzindex",{type:"setzindex",target:this,zIndex:t}),this},n.getZIndex=function(){return this._zIndex||0},n.getMinZoom=function(){var t=this.getMap(),e=this.options.minZoom;return t?Math.max(t.getMinZoom(),e||0):e},n.getMaxZoom=function(){var t=this.getMap(),e=this.options.maxZoom;return t?Math.min(t.getMaxZoom(),h(e)?1/0:e):e},n.getOpacity=function(){return this.options.opacity},n.setOpacity=function(t){return this.config("opacity",t),this.fire("setopacity",{type:"setopacity",target:this,opacity:t}),this},n.isCanvasRender=function(){var t=this._getRenderer();return t&&t instanceof Cf},n.getMap=function(){return this.map?this.map:null},n.getProjection=function(){var t=this.getMap();return t?t.getProjection():null},n.bringToFront=function(){var t=this._getLayerList();if(!t.length)return this;var e=t[t.length-1];if(1===t.length||e===this)return this;var n=e.getZIndex();return this.setZIndex(n+1),this},n.bringToBack=function(){var t=this._getLayerList();if(!t.length)return this;var e=t[0];if(1===t.length||e===this)return this;var n=e.getZIndex();return this.setZIndex(n-1),this},n.show=function(){var t=this;if(!this.options.visible){this.options.visible=!0;var e=this.getRenderer();e&&e.show();var n=this.getMap();e&&n&&n.getRenderer()?n.getRenderer().callInNextFrame((function(){n.getRenderer().callInNextFrame((function(){t.fire("show")}))})):this.fire("show")}return this},n.hide=function(){var t=this;if(this.options.visible){this.options.visible=!1;var e=this.getRenderer();e&&e.hide();var n=this.getMap();e&&n&&n.getRenderer()?n.getRenderer().callInNextFrame((function(){n.getRenderer().callInNextFrame((function(){t.fire("hide")}))})):this.fire("hide")}return this},n.isVisible=function(){var t=this.options.opacity;if(c(t)&&t<=0)return!1;var e=this.map;if(e){var n=e.getZoom(),i=this.options.minZoom,o=this.options.maxZoom;if(!h(o)&&o<n||!h(i)&&i>n)return!1}return h(this.options.visible)&&(this.options.visible=!0),this.options.visible},n.remove=function(){if(this.map){var t=this.map.getRenderer();this.map.removeLayer(this),t&&t.setToRedraw()}else this.fire("remove");return this},n.getMask=function(){return this._mask},n.setMask=function(t){if(!("Point"===t.type&&t._isVectorMarker()||"Polygon"===t.type||"MultiPolygon"===t.type))throw new Error("Mask for a layer must be a marker with vector marker symbol or a Polygon(MultiPolygon).");if(t._bindLayer(this),"Point"===t.type?t.updateSymbol({markerLineColor:"rgba(0, 0, 0, 0)",markerFillOpacity:0}):t.setSymbol({lineColor:"rgba(0, 0, 0, 0)",polygonOpacity:0}),this._mask=t,t&&t.toGeoJSON)try{this._maskGeoJSON=t.toGeoJSON()}catch(t){delete this._maskGeoJSON,console.error(t)}if(this.options.mask=t.toJSON(),!this.getMap()||this.getMap().isZooming())return this;var e=this._getRenderer();return e&&e.setToRedraw&&this._getRenderer().setToRedraw(),this},n.removeMask=function(){if(delete this._mask,delete this._maskGeoJSON,delete this.options.mask,!this.getMap()||this.getMap().isZooming())return this;var t=this._getRenderer();return t&&t.setToRedraw&&this._getRenderer().setToRedraw(),this},n.onLoad=function(){return!0},n.onLoadEnd=function(){},n.isLoaded=function(){return!!this._loaded},n.getCollisionIndex=function(){if("layer"===this.options.collisionScope)return this._collisionIndex||(this._collisionIndex=new yl),this._collisionIndex;var t=this.getMap();return t?t.getCollisionIndex():null},n.clearCollisionIndex=function(){return"layer"===this.options.collisionScope&&this._collisionIndex&&this._collisionIndex.clear(),this},n.getRenderer=function(){return this._getRenderer()},n.onConfig=function(t){if(t&&Object.keys&&Object.keys(t).length>0&&h(t.animation)){if(this._optionsHook&&A(this._optionsHook)&&this._optionsHook(t),this._silentConfig)return;var e=this.getRenderer();if(e&&e.setToRedraw&&e.setToRedraw(),"attribution"in t){var n=this.getMap();n&&n.attributionControl&&n.attributionControl._update&&n.attributionControl._update()}}},n.onAdd=function(){},n.onRendererCreate=function(){},n.onCanvasCreate=function(){},n.onRemove=function(){},n._bindMap=function(t,e){t&&(this.map=t,h(e)||this.setZIndex(e),this._switchEvents("on",this),this.onAdd(),this.fire("add"))},n._initRenderer=function(){var t=this.options.renderer;if(this.constructor.getRendererClass&&t){var e=this.constructor.getRendererClass(t);if(!e)throw new Error("Invalid renderer for Layer("+this.getId()+"):"+t);this._renderer=new e(this),this._renderer.layer=this,this._renderer.setZIndex(this.getZIndex()),this._switchEvents("on",this._renderer),this._renderer.onAdd&&this._renderer.onAdd(),this.onRendererCreate(),this.fire("renderercreate",{type:"renderercreate",target:this,renderer:this._renderer})}},n._doRemove=function(){this._loaded=!1,this._switchEvents("off",this),this.onRemove(),this._renderer&&(this._switchEvents("off",this._renderer),this._renderer.remove(),delete this._renderer),delete this.map,delete this._collisionIndex},n._switchEvents=function(t,e){e&&e.getEvents&&this.getMap()&&this.getMap()[t](e.getEvents(),e)},n._getRenderer=function(){return this._renderer},n._getLayerList=function(){if(!this.map)return[];var t=+!!this.map.getBaseLayer();return this.map.getLayers().slice(t)},n._getMask2DExtent=function(){if(!this._mask||!this.getMap())return null;var t=this._mask._getMaskPainter();return t?t.get2DExtent():null},n.toJSON=function(t){return{type:"Layer",id:this.getId(),options:t||this.config()}},e.fromJSON=function(t){if(!t)return null;var n=t.type,i=e.getJSONClass(n);if(!i||!i.fromJSON)throw new Error("unsupported layer type:"+n);return i.fromJSON(t)},n.identify=function(t,e){},n.identifyAtPoint=function(t,e){},e}(lh(Xl(bc(Ql))));Pf.mergeOptions(Sf);var If=Pf.prototype.fire;Pf.prototype.fire=function(t,e){return"layerload"===t&&(this._loaded=!0),this.map&&(e||(e={type:null,target:null}),e.type=t,e.target=this,this.map._onLayerEvent(e)),If.apply(this,arguments),["show","hide"].indexOf(t)>-1&&this.fire("visiblechange",Object.assign({},e,{visible:this.options.visible})),this};var Of=new gh(0,0),Ef=new _e(0,0),kf=["centerCross","fog","fogColor","debugSky"],Rf={maxVisualPitch:70,maxPitch:80,centerCross:!1,zoomInCenter:!1,zoomOrigin:null,zoomAnimation:!n,zoomAnimationDuration:330,panAnimation:!n,panAnimationDuration:600,rotateAnimation:!n,zoomable:!0,enableInfoWindow:!0,hitDetect:!Gt.mobile,hitDetectLimit:5,fpsOnInteracting:25,layerCanvasLimitOnInteracting:-1,maxZoom:null,minZoom:null,maxExtent:null,limitExtentOnMaxExtent:!1,fixCenterOnResize:!0,checkSize:!0,checkSizeInterval:1e3,renderer:["canvas","gl","gpu"],cascadePitches:[10,60],renderable:!0,clickTimeThreshold:280,stopRenderOnOffscreen:!0,preventWheelScroll:!0,preventTouch:!0,supportPluginEvent:!0,switchDragButton:!1,mousemoveThrottleTime:48,mousemoveThrottleEnable:!0,maxFPS:0,debug:!1,cameraFarUndergroundInMeter:2e3,onlyWebGL1:!1,forceRedrawPerFrame:!1,preserveDrawingBuffer:!0,extensions:[],optionalExtensions:["ANGLE_instanced_arrays","OES_element_index_uint","OES_standard_derivatives","OES_vertex_array_object","OES_texture_half_float","OES_texture_half_float_linear","OES_texture_float","OES_texture_float_linear","WEBGL_depth_texture","EXT_shader_texture_lod","EXT_frag_depth","EXT_texture_filter_anisotropic","WEBGL_compressed_texture_astc","WEBGL_compressed_texture_etc","WEBGL_compressed_texture_etc1","WEBGL_compressed_texture_pvrtc","WEBGL_compressed_texture_s3tc","WEBGL_compressed_texture_s3tc_srgb"]},Lf=function(t){function e(n,i){var o;if(!i)throw new Error("Invalid options when creating map.");if(!i.center)throw new Error("Invalid center when creating map.");var s=l({},i),a=s.zoom;delete s.zoom;var h=new gh(s.center);delete s.center;var c=s.baseLayer;delete s.baseLayer;var u=s.layers;return delete s.layers,(o=t.call(this,s)||this).VERSION=e.VERSION,Object.defineProperty(o,"id",{value:we(),writable:!1}),o._loaded=!1,o._initContainer(n),o._panels={},o._baseLayer=null,o._layers=[],o._zoomLevel=a,o._center=h,o.setSpatialReference(s.spatialReference||s.view),o._mapViewPoint=new _e(0,0),o._initRenderer(),o._updateMapSize(o._getContainerDomSize()),c&&o.setBaseLayer(c),u&&o.addLayer(u),o.setMaxExtent(s.maxExtent),o._Load(),o.proxyOptions(),o.isMap=!0,o}he(e,t),e.addOnLoadHook=function(t,...e){var n="function"==typeof t?t:function(){this[t].call(this,...e)};return this.prototype._onLoadHooks=this.prototype._onLoadHooks||[],this.prototype._onLoadHooks.push(n),this};var i=e.prototype;return i.isLoaded=function(){return!!this._loaded},i.getContainer=function(){return this._containerDOM},i.getSpatialReference=function(){return this._spatialReference},i.setSpatialReference=function(t){var e=this.options.spatialReference;return this._loaded&&sf.equals(e,t)||this._updateSpatialReference(t,e),this},i._updateSpatialReference=function(t,e){g(t)&&(t=sf.getPreset(t)),t=l({},t),this._center=this.getCenter(),this.options.spatialReference=t,this._spatialReference=new sf(t);var n=this._spatialReference.getProjection();return this.options.spatialReference&&A(this.options.spatialReference.projection)&&(this.options.spatialReference.projection=n.code),this._resetMapStatus(),gc.is(n.code)&&(this._originLng=n.centralMeridian,this._altitudeOriginDirty=!0),this._fireEvent("spatialreferencechange",{old:e,new:l({},this.options.spatialReference)}),this},i.onConfig=function(t){var e=t.spatialReference||t.view;if(h(e)||this._updateSpatialReference(e,null),"canvas"===this.options.renderer){for(var n=!1,i=0,o=kf.length;i<o;i++){if(!h(t[kf[i]])){n=!0;break}}if(!n)return this}var s=this.getRenderer();return s&&s.setToRedraw(),this},i.getProjection=function(){return this._spatialReference?this._spatialReference.getProjection():null},i.getFullExtent=function(){return this._spatialReference?this._spatialReference.getFullExtent():null},i.setCursor=function(t){return delete this._cursor,this._trySetCursor(t),this._cursor=t,this},i.resetCursor=function(){return this.setCursor(null)},i.getCenter=function(){if(!this._loaded||!this._prjCenter)return this._center;var t=this.getProjection().unproject(this._prjCenter);return t.x=Math.round(1e8*t.x)/1e8,t.y=Math.round(1e8*t.y)/1e8,this.centerAltitude&&(t.z=this.centerAltitude),t},i.setCenter=function(t,e){if(!t)return this;t=new gh(t),e&&(t=this._getCenterByPadding(t,this.getZoom(),e));var n=this.getProjection().project(t);return this._verifyExtent(n)||this.options.limitExtentOnMaxExtent?this._loaded?(this.onMoveStart(),this._setPrjCenter(n),this.onMoveEnd(this._parseEventFromCoord(this.getCenter())),this):(this._center=t,this):this},i.getSize=function(){return h(this.width)||h(this.height)?this._getContainerDomSize():new qn(this.width,this.height)},i.getContainerExtent=function(){var t=this.height,e=this.getPitch(),n=this.options.maxVisualPitch;return n&&e>n&&(t=this._getVisualHeight(n)),new Oh(0,this.height-t,this.width,this.height)},i._getVisualHeight=function(t){t=t||.01;var e=(90-this.getPitch())*Math.PI/180,n=this.getFov()*Math.PI/180;t*=Math.PI/180;var i=this.cameraCenterDistance/this.getGLScale(),o=Math.tan(n/2),s=i*o/(1/Math.tan(t)-o)/Math.sin(t),a=i*(Math.sin(e)*s/(i+Math.cos(e)*s));return this.height/2+a},i.getExtent=function(){return this.pointToExtent(this.get2DExtent())},i.getProjExtent=function(){var t=this.get2DExtent();return new Ph(this._pointToPrj(t.getMin()),this._pointToPrj(t.getMax()))},i.getPrjExtent=function(){return this.getProjExtent()},i.getMaxExtent=function(){return this.options.maxExtent?new Ph(this.options.maxExtent,this.getProjection()):null},i.setMaxExtent=function(t){if(t){var e=new Ph(t,this.getProjection());this.options.maxExtent=e;var n=this.getProjection();this._prjMaxExtent=e.convertTo((function(t){return n.project(t)})),this._verifyExtent(this._getPrjCenter())||(this._loaded?this._panTo(this._prjMaxExtent.getCenter()):this._center=n.unproject(this._prjMaxExtent.getCenter()))}else delete this.options.maxExtent,delete this._prjMaxExtent;return this},i.getZoom=function(){return this._zoomLevel},i.getZoomForScale=function(t,e,n){var i=this.getZoom();if(h(e)&&(e=i),1===t&&e===i)return i;var o=this._getResolution(e),s=this.getZoomFromRes(o/t);if(n)return s;var a=1e-6;return this.getSpatialReference().getZoomDirection()<0?Math.ceil(s-a):Math.floor(s+a)},i.getZoomFromRes=function(t){var e=this._getResolutions(),n=this._getResolution(this.getMinZoom()),i=this._getResolution(this.getMaxZoom());if(n<=i){if(t<=n)return this.getMinZoom();if(t>=i)return this.getMaxZoom()}else{if(t>=n)return this.getMinZoom();if(t<=i)return this.getMaxZoom()}for(var o=e.length,s=0;s<o-1;s++)if(e[s]){var a=e[s+1]-e[s],l=t-e[s];if(Ge(a)===Ge(l)&&Math.abs(a)>=Math.abs(l))return s+l/a}return o-1},i.setZoom=function(t,e={animation:!0}){return isNaN(t)||h(t)||(t=+t,this._loaded&&this.options.zoomAnimation&&e.animation?this._zoomAnimation(t):this._zoom(t)),this},i.getMaxZoom=function(){return h(this.options.maxZoom)?this.getMaxNativeZoom():this.options.maxZoom},i.setMaxZoom=function(t){var e=this.getMaxNativeZoom();return t>e&&(t=e),null!==t&&t<this._zoomLevel&&(this.setZoom(t),t=+t),this.options.maxZoom=t,this},i.getMinZoom=function(){return h(this.options.minZoom)?this._spatialReference.getMinZoom():this.options.minZoom},i.setMinZoom=function(t){if(null!==t){t=+t;var e=this._spatialReference.getMinZoom();t<e&&(t=e),t>this._zoomLevel&&this.setZoom(t)}return this.options.minZoom=t,this},i.getMaxNativeZoom=function(){var t=this.getSpatialReference();return t?t.getMaxZoom():null},i.getGLRes=function(){if(this._glRes)return this._glRes;var t=this.getSpatialReference().getFullExtent();return this._glRes=(t.right-t.left)/Math.pow(2,19),this._glRes},i.getGLScale=function(t){return h(t)&&(t=this.getZoom()),this._getResolution(t)/this.getGLRes()},i.zoomIn=function(){return this.setZoom(this.getZoom()+1)},i.zoomOut=function(){return this.setZoom(this.getZoom()-1)},i.isZooming=function(){return!!this._zooming},i.isInteracting=function(){return this.isZooming()||this.isMoving()||this.isRotating()},i.setCenterAndZoom=function(t,e){return h(e)||this._zoomLevel===e?this.setCenter(t):(this.setCenter(t),this.setZoom(e,{animation:!1})),this},i._getPaddingSize=function(t={}){return t.paddingLeft||t.paddingTop||t.paddingRight||t.paddingBottom?{width:(t.paddingLeft||0)+(t.paddingRight||0),height:(t.paddingTop||0)+(t.paddingBottom||0)}:null},i.getFitZoom=function(t,e,n){var i=this;if(!(t&&t instanceof Ph))return this._zoomLevel;if(t.xmin===t.xmax&&t.ymin===t.ymax)return this.getMaxZoom();var o=this.getSize(),s=this._getPaddingSize(n);if(s){var a={width:o.width-(s.width||0),height:o.height-(s.height||0)};o=new qn(a.width,a.height)}var l=t.convertTo((function(t){return i.coordToPoint(t)})),h=l.getWidth(),c=l.getHeight(),u=o.width/h,f=o.height/c,g=this.getSpatialReference().getZoomDirection()<0?Math.max(u,f):Math.min(u,f);return this.getZoomForScale(g,null,e)},i.getView=function(){return{center:this.getCenter().toArray(),zoom:this.getZoom(),pitch:this.getPitch(),bearing:this.getBearing()}},i._validateView=function(t){if(t&&f(t)){if(c(t.bearing)){var e=t.bearing;(e%=360)>180&&(e=-180+Math.abs(e-180)),e<-180&&(e=180-Math.abs(e+180)),t.bearing=e}c(t.pitch)&&(t.pitch=Math.max(0,t.pitch),t.pitch=Math.min(this.options.maxPitch,t.pitch));var n=this.getMaxZoom();c(t.zoom)&&(t.zoom=Math.max(0,t.zoom),t.zoom=Math.min(n,t.zoom))}},i.setView=function(t){return t?(this._validateView(t),t.center&&this.setCenter(t.center),null===t.zoom||isNaN(+t.zoom)||this.setZoom(+t.zoom,{animation:!1}),null===t.pitch||isNaN(+t.pitch)||this.setPitch(+t.pitch),null===t.bearing||isNaN(+t.bearing)||this.setBearing(+t.bearing),this):this},i.getResolution=function(t){return this._getResolution(t)},i.getScale=function(t){var e=h(t)?this.getZoom():t,n=this._getResolution(this.getMaxNativeZoom());return this._getResolution(e)/n},i._getCenterByPadding=function(t,e,n){var i=this.coordinateToPoint(t,e),{paddingLeft:o=0,paddingRight:s=0,paddingTop:a=0,paddingBottom:l=0}=n||{},h=0,c=0;(o||s)&&(h=(s-o)/2),(a||l)&&(c=(a-l)/2);var u=new _e({x:i.x+h,y:i.y+c});return this.pointToCoordinate(u,e)},i.fitExtent=function(t,e,n,i){var o=this;if(n=n||{},!t)return this;var s=new Ph(t),a=this.getFitZoom(s,n.isFraction||!1,n)+(e||0),l=s.convertTo((function(t){return o.coordToPoint(t)})),h=this.pointToCoord(l.getCenter());return this._getPaddingSize(n)&&(h=this._getCenterByPadding(h,a,n)),void 0===n.animation||n.animation?this._animateTo({center:h,zoom:a},{duration:n.duration||this.options.zoomAnimationDuration,easing:n.easing||"out"},i):this.setCenterAndZoom(h,a)},i.getBaseLayer=function(){return this._baseLayer},i.setBaseLayer=function(t){var e=!1;if(this._baseLayer&&(e=!0,this._fireEvent("baselayerchangestart"),this._baseLayer.remove()),!t)return delete this._baseLayer,this._fireEvent("baselayerchangeend"),this._fireEvent("setbaselayer"),this;return this._baseLayer=t,t._bindMap(this,-1),this._baseLayer.on("layerload",(function(){this._fireEvent("baselayerload"),e&&(e=!1,this._fireEvent("baselayerchangeend"))}),this),this._loaded&&this._baseLayer.load(),this._fireEvent("setbaselayer"),this},i.removeBaseLayer=function(){return this._baseLayer&&(this._baseLayer.remove(),delete this._baseLayer,this._fireEvent("baselayerremove")),this},i.getLayers=function(t){return this._getLayers((function(e){return!(e===this._baseLayer||e.getId().indexOf(Fn)>=0)&&(!t||t(e))}))},i.getLayer=function(t){if(!t)return null;var e=this._layerCache?this._layerCache[t]:null;if(e)return e;var n=this.getBaseLayer();return n&&n.getId()===t?n:null},i.addLayer=function(t,...e){if(!t)return this;Array.isArray(t)||(t=[t]),e&&e.length&&(t=t.concat(e)),this._layerCache||(this._layerCache={});for(var n=this._layers,i=0,o=t.length;i<o;i++){var s=t[i],a=s.getId();if(h(a))throw new Error("Invalid id for the layer: "+a);if(s.getMap()!==this){if(this._layerCache[a])throw new Error("Duplicate layer id in the map: "+a);this._layerCache[a]=s,s._bindMap(this),n.push(s),this._loaded&&s.load()}}return this._sortLayersByZIndex(),this._fireEvent("addlayer",{layers:t}),this},i.removeLayer=function(t){if(!t)return this;if(!Array.isArray(t))return this.removeLayer([t]);for(var e=[],n=0,i=t.length;n<i;n++){var o=t[n];if(o instanceof Pf||(o=this.getLayer(o)),o){var s=o.getMap();if(s&&s===this){e.push(o),this._removeLayer(o,this._layers),this._loaded&&o._doRemove();var a=o.getId();this._layerCache&&delete this._layerCache[a]}}}if(e.length>0){var l=this.getRenderer();l&&("canvas"===this.options.renderer?l.setLayerCanvasUpdated():l.setToRedraw()),this.once("frameend",(function(){e.forEach((function(t){t.fire("remove")}))}))}return this._fireEvent("removelayer",{layers:t}),this},i._findTerrainLayer=function(){if(Df(this._baseLayer))return this._baseLayer;for(var t=this._getLayers()||[],e=0;e<t.length;e++){var n=t[e];if(Df(n))return n}return null},i.sortLayers=function(t){if(!t||!Array.isArray(t))return this;for(var e=[],n=Number.MAX_VALUE,i=0,o=t.length;i<o;i++){var s=t[i];if(g(t[i])&&(s=this.getLayer(s)),!(s instanceof Pf&&s.getMap()&&s.getMap()===this))throw new Error("It must be a layer added to this map to order.");s.getZIndex()<n&&(n=s.getZIndex()),e.push(s)}for(var a=0,l=e.length;a<l;a++)e[a].setZIndex(n+a);return this},i.toDataURL=function(t){t||(t={});var e=t.mimeType;e||(e="image/png");var n=t.save,i=this._getRenderer();if(i&&i.toDataURL){var o=t.fileName;o||(o="export");var s=i.toDataURL(e,t.quality||.92);if(n&&s){var a;if("undefined"!=typeof Blob&&"undefined"!=typeof atob){var l=pn(s.replace(/^data:image\/(png|jpeg|jpg|webp);base64,/,""),e);a=URL.createObjectURL(l)}else a=s;var h=document.createElement("a");h.download=o,h.href=a,document.body.appendChild(h),h.click(),document.body.removeChild(h)}return s}return null},i.coordToPoint=function(t,e,n){return this.coordinateToPoint(t,e,n)},i.coordToPointAtRes=function(t,e,n){return this.coordinateToPointAtRes(t,e,n)},i.pointToCoord=function(t,e,n){return this.pointToCoordinate(t,e,n)},i.pointAtResToCoord=function(t,e,n){return this.pointAtResToCoordinate(t,e,n)},i.coordToViewPoint=function(t,e,n){return this.coordinateToViewPoint(t,e,n)},i.viewPointToCoord=function(t,e){return this.viewPointToCoordinate(t,e)},i.coordToContainerPoint=function(t,e,n){return this.coordinateToContainerPoint(t,e,n)},i.containerPointToCoord=function(t,e){return this.containerPointToCoordinate(t,e)},i.containerPointToViewPoint=function(t,e){return e?e.set(t.x,t.y):e=t.copy(),e._sub(this.getViewPoint())},i.viewPointToContainerPoint=function(t,e){return e?e.set(t.x,t.y):e=t.copy(),e._add(this.getViewPoint())},i.checkSize=function(t){var e=a()-this._initTime<1500&&0===this.width||0===this.height,n=this._getContainerDomSize(),i=this.height,o=this.width;if(!t&&n.width===o&&n.height===i)return this;Wi(this._containerDOM);var s=this.getCenter();if(this.options.fixCenterOnResize)this._updateMapSize(n);else{var l=this._getVisualHeight(this.getPitch()),h=new _e(0,this.height-l),c=this._containerPointToPrj(h);this._updateMapSize(n);var u=this._getVisualHeight(this.getPitch()),f=new _e(0,this.height-u);this._setPrjCoordAtContainerPoint(c,f),this._mapViewCoord=this._getPrjCenter()}return(e||(0===n.width||0===n.height||0===o||0===i))&&(this._eventSilence=!0,this.setCenter(s),delete this._eventSilence),this._fireEvent("resize"),this},i.locate=function(t,e,n){return this.getProjection()._locate(new gh(t),e,n)},i.getMainPanel=function(){var t=this._getRenderer();return t?t.getMainPanel():null},i.getPanels=function(){return this._panels},i.remove=function(){var t=this;if(this.isRemoved())return this;this._fireEvent("removestart"),[this._animPlayer,this._mapAnimPlayer].forEach((function(e){e&&e.finish&&t._stopAnim(e)})),this._removeDomEvents(),this._clearHandlers(),this.removeBaseLayer();for(var e=this.getLayers(),n=0;n<e.length;n++)e[n].remove();return this._getRenderer()&&this._getRenderer().remove(),this._containerDOM.childNodes&&this._containerDOM.childNodes.length>0&&Array.prototype.slice.call(this._containerDOM.childNodes,0).filter((function(t){return"ispace-wrapper"===t.className})).forEach((function(e){return t._containerDOM.removeChild(e)})),delete this._panels,delete this._containerDOM,delete this._renderer,this._fireEvent("removeend"),this._clearAllListeners(),this},i.isRemoved=function(){return!this._containerDOM},i.isMoving=function(){return!!this._moving},i.onMoveStart=function(t){this._mapAnimPlayer&&this._stopAnim(this._mapAnimPlayer);var e=this._getPrjCenter();this._originCenter&&!this._verifyExtent(e)||(this._originCenter=e),this._moving=!0,this._trySetCursor("move"),this._fireEvent("movestart",this._parseEvent(t?t.domEvent:null,"movestart"))},i.onMoving=function(t){this._fireEvent("moving",this._parseEvent(t?t.domEvent:null,"moving")),this._limitMaxExtent()},i.onMoveEnd=function(t){(this._moving=!1,this._suppressRecenter||this._recenterOnTerrain(),this._trySetCursor("default"),this._fireEvent("moveend",t&&t.domEvent?this._parseEvent(t.domEvent,"moveend"):t),this._verifyExtent(this._getPrjCenter())||!this._originCenter||this.options.limitExtentOnMaxExtent)||this._panTo(this._originCenter);this._limitMaxExtent()},i.onDragRotateStart=function(t){this._dragRotating=!0,this._fireEvent("dragrotatestart",this._parseEvent(t?t.domEvent:null,"dragrotatestart"))},i.onDragRotating=function(t){this._fireEvent("dragrotating",this._parseEvent(t?t.domEvent:null,"dragrotating"))},i.onDragRotateEnd=function(t){this._dragRotating=!1,this._fireEvent("dragrotateend",this._parseEvent(t?t.domEvent:null,"dragrotateend"))},i.isDragRotating=function(){return!!this._dragRotating},i.isOffscreen=function(t,e=0){var{width:n,height:i}=this,o=n+e,s=i+e,{xmin:a,ymin:l,xmax:h,ymax:c}=t;return Array.isArray(t)&&([a,l,h,c]=t),h<e||a>=o||c<e||l>s},i.getRenderer=function(){return this._getRenderer()},i.getDevicePixelRatio=function(){return this.options.devicePixelRatio||Gt.devicePixelRatio||1},i.setDevicePixelRatio=function(t){return c(t)&&t>0&&t!==this.options.devicePixelRatio&&(this.options.devicePixelRatio=t,this.checkSize(!0)),this},i._initContainer=function(t){if(g(t)){if(this._containerDOM=document.getElementById(t),!this._containerDOM)throw new Error("Invalid container when creating map: '"+t+"'")}else this._containerDOM=t,n&&(this.CanvasClass=this._containerDOM.constructor);if(this._containerDOM.childNodes&&this._containerDOM.childNodes.length>0&&"ispace-wrapper"===this._containerDOM.childNodes[0].className)throw new Error("Container is already loaded with another map instance, use map.remove() to clear it.")},i._trySetCursor=function(t){return this._cursor||this._priorityCursor||(t||(t="default"),this._setCursorToPanel(t)),this},i._setPriorityCursor=function(t){if(t)this._priorityCursor=t,this._setCursorToPanel(t);else{var e=!1;this._priorityCursor&&(e=!0),delete this._priorityCursor,e&&this.setCursor(this._cursor)}return this},i._setCursorToPanel=function(t){var e=this.getMainPanel();e&&e.style&&e.style.cursor!==t&&(e.style.cursor=t)},i._removeLayer=function(t,e){if(t&&e){var n=e.indexOf(t);n>-1&&e.splice(n,1)}},i._sortLayersByZIndex=function(){if(this._layers){for(var t=0,e=this._layers.length;t<e;t++){var n=this._layers[t];n._order=t,n.sortLayersByZIndex&&n.sortLayersByZIndex()}this._layers.sort((function(t,e){var n=t.getZIndex()-e.getZIndex();return 0===n?t._order-e._order:n}))}},i._fireEvent=function(t,e){if(!this._eventSilence){"_"!==t[0]&&this.fire("_"+t,e),this.fire(t,e)}},i._Load=function(){this._resetMapStatus(),this.options.pitch&&(this.setPitch(this.options.pitch),delete this.options.pitch),this.options.bearing&&(this.setBearing(this.options.bearing),delete this.options.bearing),delete this._glRes,this._loadAllLayers(),this._getRenderer().onLoad(),this._loaded=!0,this._callOnLoadHooks(),this._initTime=a()},i._initRenderer=function(){var t=this.options.renderer;Array.isArray(t)||(t=[t]);for(var n=0;n<t.length;n++){var i=e.getRendererClass(t[n]);if(i){this._renderer=new i(this),this._renderer.load();break}}},i._getRenderer=function(){return this._renderer},i._loadAllLayers=function(){this._baseLayer&&this._baseLayer.load(),this._eachLayer((function(t){t&&t.load()}),this.getLayers())},i._getLayers=function(t){for(var e=this._baseLayer?[this._baseLayer].concat(this._layers):this._layers,n=[],i=0;i<e.length;i++)t&&!t.call(this,e[i])||n.push(e[i]);return n},i._eachLayer=function(t,...e){if(!(arguments.length<2)){e&&!Array.isArray(e)&&(e=[e]);for(var n=[],i=0,o=e.length;i<o;i++)n=n.concat(e[i]);for(var s=0,a=n.length;s<a;s++)t.call(t,n[s])}},i._onLayerEvent=function(t){t&&"idchange"===t.type&&(delete this._layerCache[t.old],this._layerCache[t.new]=t.target)},i._resetMapStatus=function(){var t=this.getMaxZoom(),e=this.getMinZoom(),n=this._spatialReference.getMaxZoom(),i=this._spatialReference.getMinZoom();(h(t)||-1===t||t>n)&&this.setMaxZoom(n),(h(e)||-1===e||e<i)&&this.setMinZoom(i),(t=this.getMaxZoom())<(e=this.getMinZoom())&&this.setMaxZoom(e),(h(this._zoomLevel)||this._zoomLevel>t)&&(this._zoomLevel=t),this._zoomLevel<e&&(this._zoomLevel=e),delete this._prjCenter,delete this._glRes;var o=this.getProjection();this._prjCenter=o.project(this._center),this._prjCenter.z=this._center.z,this._calcMatrices();var s=this._getRenderer();s&&s.resetContainer()},i.setContainerDomRect=function(t){this._containerDomContentRect=t},i._getContainerDomSize=function(){if(!this._containerDOM)return null;var t,e,n=this._containerDOM;if(this._containerDomContentRect)return new qn(t=this._containerDomContentRect.width,e=this._containerDomContentRect.height);var i=n;if(h(i.width)||h(i.height)){if(h(n.clientWidth)||h(n.clientHeight))throw new Error("can not get size of container");t=parseInt(n.clientWidth+"",0),e=parseInt(n.clientHeight+"",0)}else{t=i.width,e=i.height;var o=this.getDevicePixelRatio();1!==o&&n.layer&&(t/=o,e/=o)}return new qn(t,e)},i._updateMapSize=function(t){this.width=t.width,this.height=t.height;var e=this._getRenderer();return e&&e.updateMapSize(t),this._calcMatrices(),this},i._getPrjCenter=function(){return this._prjCenter},i._setPrjCenter=function(t){this._prjCenter=t,this.isInteracting()&&!this.isMoving()&&(this._mapViewCoord=t),this._calcMatrices()},i._setPrjCoordAtContainerPoint=function(t,e){if(!this.centerAltitude&&e.x===this.width/2&&e.y===this.height/2)return this;var n=this._containerPointToPoint(e)._sub(this._prjToPoint(this._getPrjCenter())),i=this._pointToPrj(this._prjToPoint(t)._sub(n));return this._setPrjCenter(i),this},i._setPrjCoordAtOffsetToCenter=function(t,e){var n=this._pointToPrj(this._prjToPoint(t)._sub(e));return this._setPrjCenter(n),this},i._verifyExtent=function(t){if(!t)return!1;var e=this._prjMaxExtent;return!e||e.contains(t)},i._limitMaxExtent=function(){var t=this;if(this._limitMaxExtenting||!this.options.limitExtentOnMaxExtent)return this;var e=this._prjMaxExtent,n=this.getMaxExtent();if(!e||!n)return this;var i=e.toArray().map((function(e){return t.prjToContainerPoint(e)})),o=ws();Ps(i,o);var{width:s,height:a}=this.getSize(),l=[0,0,s,a];if(Rs(l,o))return this;if(Rs(o,l))return this;var h=0,c=0,u=0,f=0,g=0,A=0,m=Math.abs,[w,T,M,C]=o;if(w>0&&M>s&&(h=u=m(w)),w<0&&M<s&&(h=u=-m(w)),w<0&&M<s&&(h=f=-m(s-M)),w>0&&M>s&&(h=f=m(s-M)),T>0&&C>a&&(c=g=m(T)),T<0&&C<a&&(c=g=-m(T)),T<0&&C<a&&(c=A=-m(a-C)),T>0&&C>a&&(c=A=m(a-C)),0!==u&&0!==f&&(h=u,m(f)<m(u)&&(h=f)),0!==g&&0!==A&&(c=g,m(A)<m(g)&&(c=A)),0!==h||0!==c){var P=new _e(s/2+h,a/2+c),I=this.containerPointToCoord(P);this._limitMaxExtenting=!0,this.setCenter(I),this._limitMaxExtenting=!1}return this},i._offsetCenterByPixel=function(t){var e=Ef.set(this.width/2-t.x,this.height/2-t.y),n=this._containerPointToPrj(e,Of),i=Ef.set(this.width/2,this.height/2);this._setPrjCoordAtContainerPoint(n,i)},i.offsetPlatform=function(t){return t?(this._getRenderer().offsetPlatform(t),this._mapViewCoord=this._getPrjCenter(),this._mapViewPoint=this._mapViewPoint.add(t),this._mapViewPoint):this._mapViewPoint},i.getViewPoint=function(){var t=this.getViewPointFrameOffset(),e=this.offsetPlatform();return t&&(e=e.add(t)),e},i._resetMapViewPoint=function(){this._mapViewPoint=new _e(0,0),this._mapViewCoord=this._getPrjCenter()},i._getResolution=function(t){return void 0!==t&&t!==this._zoomLevel||void 0===this._mapRes?(h(t)&&(t=this._zoomLevel),this._spatialReference.getResolution(t)):this._mapRes},i._getResolutions=function(){return this._spatialReference.getResolutions()},i._prjToPoint=function(t,e,n){e=h(e)?this.getZoom():e;var i=this._getResolution(e);return this._prjToPointAtRes(t,i,n)},i._prjToPointAtRes=function(t,e,n){return this._spatialReference.getTransformation().transform(t,e,n)},i._prjsToPointsAtRes=function(t,e,n=[]){for(var i=this._spatialReference.getTransformation(),o=[],s=0,a=t.length;s<a;s++){var l=i.transform(t[s],e,n[s]);o.push(l)}return o},i._pointToPrj=function(t,e,n){e=h(e)?this.getZoom():e;var i=this._getResolution(e);return this._pointToPrjAtRes(t,i,n)},i._pointToPrjAtRes=function(t,e,n){return this._spatialReference.getTransformation().untransform(t,e,n)},i._pointToPoint=function(t,e,n){return h(e)?(n?(n.x=t.x,n.y=t.y):n=t.copy(),n):this._pointAtResToPoint(t,this._getResolution(e),n)},i._pointAtResToPoint=function(t,e,n){return n?(n.x=t.x,n.y=t.y):n=t.copy(),n._multi(e/this._getResolution())},i._pointToPointAtRes=function(t,e,n){return n?(n.x=t.x,n.y=t.y):n=t.copy(),n._multi(this._getResolution()/e)},i._containerPointToPrj=function(t,e){return this._pointToPrj(this._containerPointToPoint(t,void 0,e),void 0,e)},i._callOnLoadHooks=function(){var t=e.prototype;if(t._onLoadHooks)for(var n=0,i=t._onLoadHooks.length;n<i;n++)t._onLoadHooks[n].call(this)},i._fixPrjOnWorldWide=function(t){var e=this.getProjection();if(e&&e.fullExtent&&t){var{left:n,bottom:i,top:o,right:s}=e.fullExtent||{};c(n)&&(t.x=Math.max(n,t.x)),c(s)&&(t.x=Math.min(s,t.x)),c(i)&&(t.y=Math.max(i,t.y)),c(o)&&(t.y=Math.min(o,t.y))}return this},i.toJSON=function(t){t||(t={});var e={jsonVersion:this.JSON_VERSION,version:this.VERSION,extent:this.getExtent().toJSON()};e.options=this.config(),e.options.center=this.getCenter(),e.options.zoom=this.getZoom(),e.options.bearing=this.getBearing(),e.options.pitch=this.getPitch();var n=this.getBaseLayer();(h(t.baseLayer)||t.baseLayer)&&n&&(e.baseLayer=n.toJSON(t.baseLayer));var i={};t.clipExtent&&(i.clipExtent=!0===t.clipExtent?this.getExtent():t.clipExtent);var o=[];if(h(t.layers)||t.layers&&!Array.isArray(t.layers)){for(var s=this.getLayers(),a=0,c=s.length;a<c;a++)if(s[a].toJSON){var u=l({},f(t.layers)?t.layers:{},i);o.push(s[a].toJSON(u))}e.layers=o}else if(Je(t.layers)){for(var g=t.layers,A=0;A<g.length;A++){var m=g[A],w=this.getLayer(m.id);if(w.toJSON){var T=l({},m.options,i);o.push(w.toJSON(T))}}e.layers=o}else e.layers=[];return e},e.fromJSON=function(t,n,i){if(!t||!n)return null;i||(i={});var o=new e(t,n.options);if(h(i.baseLayer)||i.baseLayer){var s=Pf.fromJSON(n.baseLayer);s&&o.setBaseLayer(s)}if(h(i.layers)||i.layers){for(var a=[],l=n.layers,c=0;c<l.length;c++){var u=Pf.fromJSON(l[c]);a.push(u)}o.addLayer(a)}return o},e}(hh(Xl(bc(Ql))));function Df(t){return t&&t.queryTerrainAtPoint&&t.getTerrainLayer&&t.getTerrainLayer()}Lf.mergeOptions(Rf);var Ff=function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n.addHooks=function(){this.target&&this.target.on("_dblclick",this._onDoubleClick,this)},n.removeHooks=function(){this.target&&this.target.off("_dblclick",this._onDoubleClick,this)},n._onDoubleClick=function(t){var e=this.target;if(e.options.doubleClickZoom){var n=e.getZoom(),i=t.domEvent.shiftKey?Math.ceil(n)-1:Math.floor(n)+1;e._zoomAnimation(i,t.containerPoint)}},e}(Jl);Lf.mergeOptions({doubleClickZoom:!0}),Lf.addOnLoadHook("addHandler","doubleClickZoom",Ff);var Nf=function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n.addHooks=function(){var t=this.target;if(t){var e=t.getPanels().mapWrapper||t.getContainer();this._dragHandler=new dh(e,{cancelOn:this._cancelOn.bind(this),rightclick:!0}),this._dragHandler.on("mousedown",this._onMouseDown,this).on("dragstart",this._onDragStart,this).on("dragging",this._onDragging,this).on("dragend",this._onDragEnd,this).enable()}},n.removeHooks=function(){this._dragHandler.off("mousedown",this._onMouseDown,this).off("dragstart",this._onDragStart,this).off("dragging",this._onDragging,this).off("dragend",this._onDragEnd,this),this._dragHandler.remove(),delete this._dragHandler},n._cancelOn=function(t){return!(!this.target.isZooming()&&!this._ignore(t))},n._ignore=function(t){return!!t&&(t.domEvent&&(t=t.domEvent),this.target._ignoreEvent(t))},n._onMouseDown=function(t){delete this.startDragTime,delete this._mode;var e=this.target.options.switchDragButton;e&&"touchstart"===t.domEvent.type||t.domEvent.button===(e?0:2)||t.domEvent.ctrlKey?(this.target.options.dragRotate||this.target.options.dragPitch)&&(this._mode="rotatePitch"):this.target.options.dragPan&&(this._mode="move"),this.target._stopAnim(this.target._mapAnimPlayer),Hi(t.domEvent)},n._onDragStart=function(t){this.startDragTime=a(),"move"===this._mode?this._moveStart(t):"rotatePitch"===this._mode&&this._rotateStart(t)},n._onDragging=function(t){"move"===this._mode?this._moving(t):"rotatePitch"===this._mode&&this._rotating(t)},n._onDragEnd=function(t){"move"===this._mode?this._moveEnd(t):"rotatePitch"===this._mode&&this._rotateEnd(t),delete this.startDragTime,delete this.startBearing},n._start=function(t){this.preX=t.mousePos.x,this.preY=t.mousePos.y,this.startX=this.preX,this.startY=this.preY,this._startPrjCenter=this.target._getPrjCenter().copy()},n._moveStart=function(t){delete this.startContainerPoint,this._start(t);var e=this.target;e.onMoveStart(t);var n=Zi(e._getActualEvent(t.domEvent),e.getContainer());this.startPrjCoord=e.queryPrjCoordAtContainerPoint(n),e._isContainerPointOutOfMap(n)&&void 0===this.startPrjCoord.z&&(this.startContainerPoint=n)},n._moving=function(t){if(this.startDragTime){var e=this.target,n=Zi(e._getActualEvent(t.domEvent),e.getContainer());if(this.startContainerPoint){var i=n._sub(this.startContainerPoint);n.set(e.width/2+i.x,e.height/2+i.y)}var o=e._containerPointToPoint(n,void 0,void 0,this.startPrjCoord.z)._sub(e._prjToPoint(e._getPrjCenter()));e._setPrjCoordAtOffsetToCenter(this.startPrjCoord,o),e.onMoving(t)}},n._moveEnd=function(t){if(this.startDragTime){var e="touchend"===t.domEvent.type,n=this.target,i=a()-this.startDragTime,o=t.mousePos.x-this.startX,s=t.mousePos.y-this.startY,l=n._getPrjCenter(),h=l.sub(this._startPrjCenter);if(this._clear(),n.options.panAnimation&&!t.interupted&&n._verifyExtent(n._getPrjCenter())&&i<280&&Math.abs(s)+Math.abs(o)>5){i*=5;var c=l.add(h._multi(e?5:2.8));n._panTo(c,{duration:e?3*i:2*i,easing:n.options.dragPanEasing||"outExpo"})}else n.onMoveEnd(t)}},n._rotateStart=function(t){this._start(t),delete this._rotateMode,this.startBearing=this.target.getBearing(),this.target.onDragRotateStart(t),this._db=0},n._rotating=function(t){var e=this.target,n=t.mousePos.x,i=t.mousePos.y,o=e.getPitch(),s=e.getBearing(),a=Math.abs(n-this.preX),l=Math.abs(i-this.preY);if(this._rotateMode||(this._rotateMode=e.options.dragRotatePitch?"rotate_pitch":a>l?"rotate":a<l?"pitch":"rotate"),!("pitch"===this._rotateMode&&0===o&&l<10)){if(this._rotateMode.indexOf("rotate")>=0&&e.options.dragRotate){var h=.15,c=0;c=e.options.dragPitch||a>l?-.15*(this.preX-n):n>e.width/2?h*(this.preY-i):-.15*(this.preY-i);var u=e.getBearing()+c;this._db=this._db||0,this._db+=c,e._setBearing(u)}this._rotateMode.indexOf("pitch")>=0&&e.options.dragPitch&&e._setPitch(e.getPitch()+.15*(this.preY-i)),this.preX=n,this.preY=i,e.getBearing()===s&&e.getPitch()===o||e.onDragRotating(t)}},n._rotateEnd=function(t){var e=this.target,n=e.getBearing();this._clear();var i=a()-this.startDragTime;if(e.onDragRotateEnd(t),e.options.rotateAnimation&&Math.abs(n-this.startBearing)>20&&("rotate"===this._rotateMode||"rotate_pitch"===this._rotateMode)&&!t.interupted&&i<400){var o=e.getBearing();e._animateTo({bearing:o+this._db/1.5},{easing:"outQuint",duration:1600})}},n._clear=function(){delete this.startPrjCoord,delete this.preX,delete this.preY,delete this.startX,delete this.startY},e}(Jl);Lf.mergeOptions({draggable:!0,dragPan:!0,dragRotatePitch:!0,dragRotate:!0,dragPitch:!0}),Lf.addOnLoadHook("addHandler","draggable",Nf);var Hf="mousedown mouseup mousemove click dblclick contextmenu touchstart touchmove touchend mouseout",Bf={mousemove:["mousemove","mouseover","mouseout","mouseenter"],touchend:["touchend","click"]},zf=function(t){return t&&t.getLayer&&t.on&&t.fire},Gf=function(t,e,n){if(t._onEvent)return t._onEvent(e,n);var i=t.getLayer();return i&&i.fireGeoEvent?i.fireGeoEvent(t,e,n):null},jf=function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n.addHooks=function(){var t=this.target,e=t.getPanels().allLayers||t.getContainer();or(e,Hf,this._identifyGeometryEvents,this)},n.removeHooks=function(){var t=this.target,e=t.getPanels().allLayers||t.getContainer();sr(e,Hf,this._identifyGeometryEvents)},n._identifyGeometryEvents=function(t,e){var n=this.target;if(!n.isInteracting()&&!n._ignoreEvent(t)){var i=null,o=e||t.type;if(ar(o)&&!s.isTest&&n.options.mousemoveThrottleEnable&&lr(this,n.options.mousemoveThrottleTime))zi(t);else{var l="mousedown"===o||"touchstart"===o&&t.touches&&1===t.touches.length;if(l)this._mouseDownTime=a();else if(("click"===o||"touchend"===o)&&this._mouseDownTime){var h=this._mouseDownTime;if(delete this._mouseDownTime,a()-h>300){if("click"===o)return}else"touchend"===o&&(i="click")}var c=t.touches&&t.touches.length>0?t.touches[0]:t.changedTouches&&t.changedTouches.length>0?t.changedTouches[0]:t;if(c){var u=Zi(c,n.getContainer());"touchstart"===o&&n.options.preventTouch&&Hi(t);for(var f=null,g=this.target.getRenderer().getTopElements(),A=l&&2!==t.button,m=0;m<g.length;m++)if(g[m].hitTest(u)){var w=g[m].options.cursor;if(w&&(f=w),A||g[m].events&&g[m].events.indexOf(o)>=0){var T={target:n,type:o,domEvent:t,containerPoint:u};if(A)return n._setPriorityCursor(f),void g[m].mousedown(T);g[m].onEvent(T)}}var M=n._getLayers((function(t){return!(!t.identify||!t.options.geometryEvents)}));if(M.length){var C={includeInternals:!0,filter:function(e){if(e instanceof cf){var n=e._getEventTypeToFire(t);return"mousemove"===o?(!f&&e.options.cursor&&(f=e.options.cursor),!0):!(!e.listens(n)&&!e.listens(i))}return!!zf(e)},count:1,onlyVisible:n.options.onlyVisibleGeometryEvents,containerPoint:u,layers:M,eventTypes:Bf[o]||[o],domEvent:t},P=function(e){var s=this,a=!0,l=function(){return s._prevOverGeos&&s._prevOverGeos.geos||[]},h=function(e=[],n=[]){if(e&&e.length>0)for(var i=e.length-1;i>=0;i--){var o=e[i];zf(o)&&(-1===n.indexOf(o)&&(a=Gf(o,t,"mouseout")))}};if("mouseout"===o){var c=l();this._prevOverGeos={geos:[],geomap:{}},h(c,[])}else if("mousemove"===o){var u={};if(e.length>0)for(var g=e.length-1;g>=0;g--){var A=e[g];if(zf(A)){var m=(M=A)._getInternalId?M._getInternalId():M.getId?M.getId():null;u[m]=A,Gf(A,t),this._prevOverGeos&&this._prevOverGeos.geomap[m]||Gf(A,t,"mouseenter"),a=Gf(A,t,"mouseover")}}n._setPriorityCursor(f);var w=l();this._prevOverGeos={geos:e,geomap:u},h(w,e)}else{if(!e||!e.length)return;for(var T=e.length-1;T>=0;T--)if(zf(e[T])){a=Gf(e[T],t),i&&Gf(e[T],t,i);break}}var M;!1===a&&zi(t)}.bind(this);ar(o)?this._queryIdentifyTimeout=n.getRenderer().callInNextFrame((function(){n.isInteracting()||n.identifyAtPoint(C,P)})):n.identifyAtPoint(C,P)}}}}},e}(Jl);Lf.mergeOptions({geometryEvents:!0,onlyVisibleGeometryEvents:!0}),Lf.addOnLoadHook("addHandler","geometryEvents",jf);var Uf=4.000244140625,Vf=1/450,Wf=function(t){function e(e){var n;return(n=t.call(this,e)||this)._thisScrollZoom=n._scrollZoom.bind(n),n._thisCheckIfEndZoom=n._checkIfEndZoom.bind(n),n._wheelZoomRate=Vf,n._defaultZoomRate=.01,n._delta=0,n}he(e,t);var n=e.prototype;return n.addHooks=function(){Ri(this.target._containerDOM,"wheel",this._onWheelScroll,this)},n.removeHooks=function(){Di(this.target._containerDOM,"wheel",this._onWheelScroll)},n._currentZoomCanScroll=function(t){if(c(t)){var e=this.target,n=e.getZoom(),i=e.getMinZoom(),o=e.getMaxZoom();if(n===i&&t>0)return!1;if(n===o&&t<0)return!1}return!0},n._onWheelScroll=function(t){var e=this.target;if(e.options.preventWheelScroll&&(Hi(t),zi(t)),e._ignoreEvent(t)||!e.options.zoomable)return!1;var n=e.getContainer(),i=e._checkZoomOrigin(Zi(t,n));return e.options.seamlessZoom?(this._zooming||(this._trackPadSuspect=0,this._ensureTrackpad=!1),this._seamless(t,i)):this._interval(t,i)},n._seamless=function(t,e){var n=t.deltaMode===window.WheelEvent.DOM_DELTA_LINE?60*t.deltaY:t.deltaY;if(n%Uf!=0&&(this._ensureTrackpad||(Math.abs(n)<60?this._trackPadSuspect++:this._trackPadSuspect=0,this._trackPadSuspect>=2&&(this._ensureTrackpad=!0)),this._ensureTrackpad&&(n*=14)),t.shiftKey&&n&&(n/=4),this._lastWheelEvent=t,h(this._delta)&&(this._delta=0),this._delta-=n,this._currentZoomCanScroll(n)){if(!this._zooming&&this._delta){var i=this.target;this._zoomOrigin=e,i.onZoomStart(null,e)}this._start()}},n._start=function(){this._delta&&(this._zooming=!0,this._active||(this.target.getRenderer().callInNextFrame(this._thisScrollZoom),this._active=!0))},n._scrollZoom=function(){if(this._active=!1,this._delta){var t=Math.abs(this._delta)>Uf?this._wheelZoomRate:this._defaultZoomRate,e=2/(1+Math.exp(-Math.abs(this._delta*t)));this._delta<0&&0!==e&&(e=1/e);var n=this.target,i=n.getZoom(),o=n.getZoomForScale(e,i,!0);this._delta=0,n.onZooming(o,this._zoomOrigin),this._scrollTime=performance.now(),n.getRenderer().callInNextFrame(this._thisCheckIfEndZoom)}},n._checkIfEndZoom=function(){if(this._zooming){var t=this.target;performance.now()-this._scrollTime>210?(this._zooming=!1,t.onZoomEnd(t.getZoom(),this._zoomOrigin)):t.getRenderer().callInNextFrame(this._thisCheckIfEndZoom)}},n._interval=function(t,e){var n=this,i=this.target;if(this._zooming)return this._requesting++,!1;this._requesting=0;var o=(t.deltaY?-1*t.deltaY:t.wheelDelta?t.wheelDelta:t.detail)>0?1:-1;t.detail&&(o*=-1);var s=i.getZoom(),a=s+o;if((a=i._checkZoom(o>0?Math.ceil(a):Math.floor(a)))===s)return!1;this._zooming=!0,this._delta||(i.onZoomStart(null,e),this._origin=e,this._delta=o,this._startZoom=i.getZoom());return i._animateTo({zoom:a-1*this._delta/2,around:this._origin},{continueOnViewChanged:!0,easing:"linear",duration:90,wheelZoom:!0},(function(e){"finished"===e.state.playState?n._requesting<1||Math.abs(a-n._startZoom)>2||a===i.getMaxZoom()||a===i.getMinZoom()?(i._animateTo({zoom:a,around:n._origin},{continueOnViewChanged:!0,duration:100},(function(t){"running"!==t.state.playState&&(delete n._zooming,delete n._requesting)})),delete n._startZoom,delete n._origin,delete n._delta,n._requesting=0):h(n._requesting)||(delete n._zooming,n._onWheelScroll(t)):"running"!==e.state.playState&&(delete n._zooming,delete n._requesting)})),!1},e}(Jl);Lf.mergeOptions({scrollWheelZoom:!0,seamlessZoom:!0}),Lf.addOnLoadHook("addHandler","scrollWheelZoom",Wf);var Zf=function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n.addHooks=function(){Ri(this.target.getContainer(),"touchstart",this._onTouchStart,this)},n.removeHooks=function(){Di(this.target.getContainer(),"touchstart",this._onTouchStart)},n._onTouchStart=function(t){var e=this.target;if(t.touches&&!(t.touches.length<2)){var n=e.getContainer(),i=Zi(t.touches[0],n),o=Zi(t.touches[1],n);this.preY=i.y,this._startP1=i,this._startP2=o,this._startDist=i.distanceTo(o),this._startVector=i.sub(o),this._startZoom=e.getZoom(),this._startBearing=e.getBearing(),sr(document,"touchmove",this._onTouchMove),sr(document,"touchend",this._onTouchEnd),Ri(document,"touchmove",this._onTouchMove,this),Ri(document,"touchend",this._onTouchEnd,this),e.options.preventTouch&&Hi(t),e._fireEvent("touchactstart")}},n._onTouchMove=function(t){var e=this.target;if(t.touches&&!(t.touches.length<2)){var n=e.getContainer(),i=Zi(t.touches[0],n),o=Zi(t.touches[1],n),s=i.sub(this._startP1),a=o.sub(this._startP2),l=i.sub(o),h=i.distanceTo(o)/this._startDist,c=180*l.angleWith(this._startVector)/Math.PI,u=.4*((this.preY||i.y)-i.y);this.preY=i.y;var f={domEvent:t,mousePos:[i,o]};if(this.mode||(e.options.touchRotate&&Math.abs(c)>8?this.mode=e.options.touchZoomRotate?"rotate_zoom":"rotate":e.options.touchPitch&&s.y*a.y>0&&Math.abs(s.y)>10&&Math.abs(a.y)>10?this.mode="pitch":e.options.zoomable&&e.options.touchZoom&&Math.abs(1-h)>.15&&(this.mode=e.options.touchZoomRotate&&e.options.touchRotate?"rotate_zoom":"zoom"),this._startTouching(f)),"zoom"===this.mode||"rotate_zoom"===this.mode){this._scale=h;var g=e._getResolution(this._startZoom)/h,A=e.getZoomFromRes(g);e.onZooming(A,this._Origin)}"rotate"===this.mode||"rotate_zoom"===this.mode?(e._setBearing(this._startBearing+c),e.onDragRotating(f)):"pitch"===this.mode&&(e._setPitch(e.getPitch()+u),e.onDragRotating(f)),e._fireEvent("touchactinging")}},n._startTouching=function(t){var e=this.target;if("zoom"===this.mode||"rotate_zoom"===this.mode){var n=e.getSize();this._Origin=new _e(n.width/2,n.height/2),e.onZoomStart(null,this._Origin)}"rotate"!==this.mode&&"pitch"!==this.mode&&"rotate_zoom"!==this.mode||e.onDragRotateStart(t)},n._onTouchEnd=function(t){delete this.preY;var e=this.target;if(sr(document,"touchmove",this._onTouchMove),sr(document,"touchend",this._onTouchEnd),"zoom"===this.mode||"rotate_zoom"===this.mode){var n=this._scale,i=e._getResolution(this._startZoom)/n,o=e.getZoomFromRes(i);e.onZoomEnd(o,this._Origin)}"pitch"!==this.mode&&"rotate"!==this.mode&&"rotate_zoom"!==this.mode||e.onDragRotateEnd({domEvent:t}),delete this.mode,e._fireEvent("touchactend")},e}(Jl);Lf.mergeOptions({touchGesture:!0,touchZoom:!0,touchPitch:!0,touchRotate:!0,touchZoomRotate:!1}),Lf.addOnLoadHook("addHandler","touchGesture",Zf);var qf="__anim_player",Xf={outExpo:function(t){return 1===t?1:1-Math.pow(2,-10*t)},outQuint:function(t){return 1-Math.pow(1-t,5)},in:function(t){return Math.pow(t,2)},out:function(t){return 1-Xf.in(1-t)},inAndOut:function(t){return 3*t*t-2*t*t*t},linear:function(t){return t},upAndDown:function(t){return t<.5?Xf.inAndOut(2*t):1-Xf.inAndOut(2*(t-.5))}},Jf=re((function(t,e){this.state=t,this.styles=e}),[{key:"playState",get:function(){return this.state.playState}},{key:"symbol",get:function(){return this.styles.symbol}}]),Qf=function(){function t(t,e,n,i){this._animation=t,this.options=e,this._onFrame=n,this.playState="idle",this.ready=!0,this.finished=!1,this.target=i}var e=t.prototype;return e._prepare=function(){var t=this.options,e=t.speed||t.duration;g(e)&&((e=Yf.speed[e])||(e=+e)),e||(e=Yf.speed.normal),this.duration=e,this._framer=t.framer||Yf._requestAnimFrame.bind(Yf)},e.play=function(){if("idle"!==this.playState&&"paused"!==this.playState||this.target&&this.target[qf])return this;this.target&&(this.target[qf]=1),"idle"===this.playState&&(this.currentTime=0,this._prepare());var t=a();if(!this.startTime){var e=this.options;this.startTime=e.startTime?e.startTime:t}return this._playStartTime=Math.max(t,this.startTime),"paused"===this.playState&&(this._playStartTime-=this.currentTime),this.playState="running",this._run(),this},e.pause=function(){return"paused"===this.playState||(this.playState="paused",this._run()),this},e.cancel=function(){return"idle"===this.playState||(this.playState="idle",this.finished=!1,this._run()),this},e.finish=function(){return"finished"===this.playState||(this.playState="finished",this.finished=!0,this._run()),this},e.reverse=function(){},e._run=function(){var t=this,e=this._onFrame,n=a(),i=n-this._playStartTime;if(this.options.repeat&&i>=this.duration&&(this._playStartTime=n,i=0),"running"===this.playState){var o=this._animation(i,this.duration);this.playState=o.state.playState,"running"!==this.playState&&this.target&&delete this.target[qf],"idle"===this.playState?this.startTime>n&&setTimeout(this._run.bind(this),this.startTime-n):"running"===this.playState?this._framer((function(){"running"===t.playState&&(t.currentTime=i,e&&e(o),t._run())})):"finished"===this.playState&&(this.finished=!0,e&&e(o))}else if(this.target&&delete this.target[qf],e){"finished"===this.playState?i=this.duration:"idle"===this.playState&&(i=0);var s=this._animation(i,this.duration);s.state.playState=this.playState,e(s)}},t}(),Yf={speed:{slow:2e3,normal:1e3,fast:500},_resolveStyles:function(t){if(!t)return null;function e(t){if(!Array.isArray(t))return Yf._resolveStyles(t);for(var e=[],n=[],i=[],o=0;o<t.length;o++){var s=Yf._resolveStyles(t[o]);s&&(e.push(s[0]),n.push(s[1]),i.push(s[2]))}return e.length?[e,n,i]:null}function n(t){var e,n=t;Array.isArray(t)||(n=c(t)?[0,t]:t instanceof _e||t instanceof gh?[new(e=t.constructor)(0,0),t]:[t,t]);var i=n[0],o=n[1];return c(i)&&c(o)?i===o?null:[i,o-i,o]:Array.isArray(i)&&c(i[0])||i instanceof gh||i instanceof _e?(Array.isArray(i)?(i=new gh(i),o=new gh(o)):(i=new(e=i.constructor)(i),o=new e(o)),i.equals(o)?null:[i,o.sub(i),o]):[i,o,o]}var i,o={},s={},a={};for(var l in t)if(t.hasOwnProperty(l)){var u=t[l];if(!u)continue;if(Array.isArray(u)&&(h(u[0])||h(u[1])))continue;var f=void 0;i=u,(f=!Array.isArray(i)&&i.constructor===Object||Array.isArray(i)&&i[0].constructor===Object?e(u):n(u))&&(s[l]=f[0],o[l]=f[1],a[l]=f[2])}return[s,o,a]},framing:function(t,e){var n,i,o,s;e||(e={}),(n=A(e.easing)?e.easing:e.easing?Xf[e.easing]:Xf.linear)&&A(n)||(n=Xf.linear),(t=Yf._resolveStyles(t))&&(o=t[0],i=t[1],s=t[2]);var a=function(t,e,n){if(!e||!n)return null;var i={};for(var o in n)if(n.hasOwnProperty(o)){if(e[o]===s[o]){i[o]=e[o];continue}var l=e[o],h=n[o];if(c(h))i[o]=l+t*h;else if(Array.isArray(h)){for(var u=[],f=0;f<h.length;f++)u.push(a(t,l[f],h[f]));i[o]=u}else{i[o]=h.constructor===Object?a(t,l,h):l instanceof _e||l instanceof gh?l.add(h.multi(t)):h}}return i};return function(t,e){var l,h;if(t<0)l={playState:"idle",delta:0},h=o;else if(t<e){var c=n(t/e);l={playState:"running",delta:c},h=a(c,o,i)}else l={playState:"finished",delta:1},h=s;return l.startStyles=o,l.destStyles=s,l.progress=t,l.remainingMs=e-t,new Jf(l,h)}},_requestAnimFrame:function(t){this._frameQueue||(this._frameQueue=[]),this._frameQueue.push(t),this._a()},_a:function(){this._animationFrameId||(this._animationFrameId=Ae(Yf._frameFn))},_run:function(){if(this._frameQueue.length){var t=this._frameQueue;this._frameQueue=[];for(var e=0,n=t.length;e<n;e++)t[e]();this._frameQueue.length?this._animationFrameId=Ae(Yf._frameFn):delete this._animationFrameId}},animate:function(t,e,n,i){e||(e={});var o=Yf.framing(t,e);return new Qf(o,e,n,i)},_frameFn:function(){}};Yf._frameFn=Yf._run.bind(Yf);var Kf=Yf.animate,$f=Object.freeze({__proto__:null,Animation:Yf,Easing:Xf,Frame:Jf,Player:Qf,animate:Kf}),td={exports:{}};!function(t){!function(){function e(t,e,n){var i=e.x,o=e.y,s=n.x-i,a=n.y-o;if(0!==s||0!==a){var l=((t.x-i)*s+(t.y-o)*a)/(s*s+a*a);l>1?(i=n.x,o=n.y):l>0&&(i+=s*l,o+=a*l)}return(s=t.x-i)*s+(a=t.y-o)*a}function n(t,i,o,s,a){for(var l,h=s,c=i+1;c<o;c++){var u=e(t[c],t[i],t[o]);u>h&&(l=c,h=u)}h>s&&(l-i>1&&n(t,i,l,s,a),a.push(t[l]),o-l>1&&n(t,l,o,s,a))}function i(t,e){var i=t.length-1,o=[t[0]];return n(t,0,i,e,o),o.push(t[i]),o}function o(t,e,n){if(t.length<=2)return t;var o=void 0!==e?e*e:1;return t=n?t:function(t,e){for(var n,i,o,s,a,l=t[0],h=[l],c=1,u=t.length;c<u;c++)s=void 0,a=void 0,(s=(i=n=t[c]).x-(o=l).x)*s+(a=i.y-o.y)*a>e&&(h.push(n),l=n);return l!==n&&h.push(n),h}(t,o),t=i(t,o)}t.exports=o,t.exports.default=o}()}(td);var ed=cs(td.exports),nd="not find Geometry' Projection. please add Geometry to Layer and add Layer to Map",id=function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n.animateShow=function(t={},e){var n=this;this._showPlayer&&this._showPlayer.finish(),A(t)&&(e=t={});var i=this.getCoordinates();if(0!==i.length){this._animIdx=0,this._animLenSoFar=0,this.show();var o=!!this.getShell?this.getShell().concat(this.getShell()[0]):i,s=this._getProjection();if(s){var a=s.projectCoords(o,this.options.antiMeridian);this._prjAniShowCenter=this._getPrjExtent().getCenter(),this._aniShowCenter=s.unproject(this._prjAniShowCenter);var l=t.duration||1e3,h=t.easing||"out";this.setCoordinates([]);var c=0;a.length&&(a[0]._distance=0);for(var u=1;u<a.length;u++){var f=a[u].distanceTo(a[u-1]);a[u]._distance=f,c+=f}this._tempCoord=new gh(0,0),this._tempPrjCoord=new _e(0,0);var g=this._showPlayer=Yf.animate({t:l},{duration:l,easing:h},(function(t){if(n.getMap()){var s=n._drawAnimShowFrame(t.styles.t,l,c,o,a);"finished"===t.state.playState&&(delete n._showPlayer,delete n._aniShowCenter,delete n._prjAniShowCenter,delete n._animIdx,delete n._animLenSoFar,delete n._animTailRatio,delete n._tempCoord,delete n._tempPrjCoord,n.setCoordinates(i)),e&&e(t,s)}else if("finished"!==g.playState&&(g.finish(),e)){var h=n.getCoordinates();e(t,h[h.length-1])}}),this);return g.play(),g}console.error(nd)}},n._drawAnimShowFrame=function(t,e,n,i,o){if(0===t)return i[0];var s,a,l=t/e*n,h=0;for(s=this._animIdx+1,a=o.length;s<a&&!(this._animLenSoFar+(h=o[s]._distance)>l);s++)this._animLenSoFar+=h;if(this._animIdx=s-1,this._animIdx>=a-1)return this.setCoordinates(i),i[i.length-1];var c=this._animIdx,u=o[c],f=o[c+1],g=(l-this._animLenSoFar)/h;this._animTailRatio=g;var A=u.y+(f.y-u.y)*g;this._tempPrjCoord.x=u.x+(f.x-u.x)*g,this._tempPrjCoord.y=A;var m=this._tempPrjCoord,w=i[c],T=i[c+1],M=w.y+(T.y-w.y)*g,C=(w.z||0)+((T.z||0)-(w.z||0))*g;this._tempCoord.x=w.x+(T.x-w.x)*g,this._tempCoord.y=M,this._tempCoord.z=C;var P=this._tempCoord,I=!!this.getShell;if(!I&&this.options.smoothness>0){for(var O=[],E=[],D=0;D<=this._animIdx;D++)O.push(i[D]),E.push(o[D]);O.push(P,P),E.push(m,m),this.setCoordinates(O),this._setPrjCoordinates(E)}else{var N=i.slice(0,this._animIdx+1);N.push(P);var H=o.slice(0,this._animIdx+1);H.push(m),I?(this.setCoordinates([this._aniShowCenter].concat(N)),this._setPrjCoordinates([this._prjAniShowCenter].concat(H))):(this.setCoordinates(N),this._setPrjCoordinates(H))}return P},n._getCenterInExtent=function(t,e,n){var i=this.getExtent();if(!t.intersects(i))return null;var o=n(e,t);if(0===o.length)return null;var[s,a,l]=[0,0,0];o.forEach((function(t){Array.isArray(t)?t.forEach((function(t){t.point&&(t=t.point),s+=t.x,a+=t.y,l++})):(t.point&&(t=t.point),s+=t.x,a+=t.y,l++)}));var h=new gh(s,a)._multi(1/l);return h.count=l,h},n._getPath2DPoints=function(t,e,n){if(!Je(t))return[];var i=this.getMap(),o=!e&&this._shouldSimplify(),s=this.options.simplifyTolerance*i._getResolution(),a=Array.isArray(t[0]);if(delete this._simplified,o&&!a){var l=t.length;t=ed(t,s,!1),this._simplified=t.length<l}if(n||(n=i._getResolution()),Array.isArray(t)){var h=[],c="_glPt";if(!Array.isArray(t[0]))return h=Pn(t,c),i._prjsToPointsAtRes(t,n,h);for(var u=[],f=0,g=t.length;f<g;f++){var A=t[f];h=Pn(A,c);var m=i._prjsToPointsAtRes(A,n,h);u.push(m)}return u}return i._prjToPointAtRes(t,n)},n._shouldSimplify=function(){var t=this.getLayer();return t&&t.options.enableSimplify&&!t.options.enableAltitude&&this.options.enableSimplify&&!this._showPlayer},n._setPrjCoordinates=function(t){this._prjCoords=t,this.onShapeChanged()},n._getPrjCoordinates=function(){return this._verifyProjection(),!this._prjCoords&&this._getProjection()&&(this._prjCoords=this._projectCoords(this._coordinates)),this._prjCoords},n._updateCache=function(){this._clearCache(),this._getProjection()&&this._prjCoords&&(this._coordinates=this._unprojectCoords(this._getPrjCoordinates()))},n._clearProjection=function(){this._prjCoords=null,t.prototype._clearProjection.call(this)},n._projectCoords=function(t){var e=this._getProjection();return e?e.projectCoords(t,this.options.antiMeridian):[]},n._unprojectCoords=function(t){var e=this._getProjection();return e?e.unprojectCoords(t):[]},n._computeCenter=function(){var t=this._coordinates;if(!Je(t))return null;for(var e=0,n=0,i=0,o=t.length,s=0;s<o;s++)t[s]&&c(t[s].x)&&c(t[s].y)&&(e+=t[s].x,n+=t[s].y,i++);return new gh(e/i,n/i)},n._computeExtent=function(t){var e=this._coordinates;if(!Je(e))return null;var n=[e];return this.hasHoles&&this.hasHoles()&&n.push.call(n,...this.getHoles()),this._coords2Extent(n,this._getProjection())},n._computePrjExtent=function(t){var e=[this._getPrjCoordinates()];return this.hasHoles&&this.hasHoles()&&e.push.call(e,...this._getPrjHoles()),this._coords2Extent(e)},n._get2DLength=function(){for(var t=this._getPath2DPoints(this._getPrjCoordinates(),!0),e=0,n=1,i=t.length;n<i;n++)e+=t[n].distanceTo(t[n-1]);return e},n._hitTestTolerance=function(){var e,n=this._getInternalSymbol();if(Array.isArray(n)){e=0;for(var i=0;i<n.length;i++)c(n[i].lineWidth)&&n[i].lineWidth>e&&(e=n[i].lineWidth)}else e=n.lineWidth;return t.prototype._hitTestTolerance.call(this)+(c(e)?e/2:1.5)},n._coords2Extent=function(t,e){if(!t||0===t.length||Array.isArray(t[0])&&0===t[0].length)return null;for(var n=new Ph(e),i=0,o=t.length;i<o;i++)for(var s=0,a=t[i].length;s<a;s++)n._combine(t[i][s]);return n},e}(cf);id.mergeOptions({smoothness:!1,enableClip:!0,enableSimplify:!0,simplifyTolerance:2,symbol:{lineColor:"#000",lineWidth:2,lineOpacity:1,polygonFill:"#fff",polygonOpacity:1,opacity:1}});var rd="Polygon",od=function(t){function e(e,n){var i;return(i=t.call(this,n)||this).type="Polygon",e&&i.setCoordinates(e),i}he(e,t);var n=e.prototype;return n.getOutline=function(){return this._getPainter()?new e(this.getExtent().toArray(),{symbol:{lineWidth:1,lineColor:"6b707b"}}):null},n.setCoordinates=function(t){if(!t)return this._coordinates=null,this._holes=null,this._projectRings(),this;var e=gh.toCoordinates(t),n=e.length;if(Array.isArray(e[0]))if(this._coordinates=this._trimRing(e[0]),n>1){for(var i=[],o=1;o<n;o++)e[o]&&i.push(this._trimRing(e[o]));this._holes=i}else this._holes=null;else this._coordinates=this._trimRing(e);return this._projectRings(),this},n.getCoordinates=function(){if(!this._coordinates)return[];for(var t=this.getHoles(),e=[this._copyAndCloseRing(this._coordinates)],n=0,i=t.length;n<i;n++)e.push(this._copyAndCloseRing(t[n]));return e},n.getCenterInExtent=function(t){return this._getCenterInExtent(t,this.getShell(),Yc)},n.getShell=function(){return this._coordinates||[]},n.getHoles=function(){return this._holes||[]},n.hasHoles=function(){return this.getHoles().length>0},n._projectRings=function(){this.getMap()?(this._prjCoords=this._projectCoords(this._coordinates),this._prjHoles=this._projectCoords(this._holes),this.onShapeChanged()):this.onShapeChanged()},n._setPrjCoordinates=function(t){this._prjCoords=t,this.onShapeChanged()},n._cleanRing=function(t){for(var e=t.length-1;e>=0;e--)t[e]||t.splice(e,1)},n._checkRing=function(t){if(this._cleanRing(t),!t||!Je(t))return!1;var e=t[t.length-1],n=!0;return t[0].x===e.x&&t[0].y===e.y||(n=!1),n},n._trimRing=function(t){var e=this._checkRing(t);return Je(t)&&e&&t.splice(t.length-1,1),t},n._copyAndCloseRing=function(t){t=t.slice(0);var e=this._checkRing(t);return Je(t)&&!e?(t.push(t[0].copy()),t):t},n._getPrjShell=function(){return this.getJSONType()===rd?this._getPrjCoordinates():(this._verifyProjection(),this._getProjection()&&!this._prjShell&&(this._prjShell=this._projectCoords(this._getShell?this._getShell():this.getShell())),this._prjShell)},n._getPrjHoles=function(){var t=this._getProjection();return this._verifyProjection(),t&&!this._prjHoles&&(this._prjHoles=this._projectCoords(this.getHoles())),this._prjHoles},n._computeGeodesicLength=function(t){var e=this.getCoordinates();if(!Je(e))return 0;for(var n=0,i=0,o=e.length;i<o;i++)n+=t.measureLength(e[i]);return n},n._computeGeodesicArea=function(t){var e=this.getCoordinates();if(!Je(e))return 0;for(var n=t.measureArea(e[0]),i=1,o=e.length;i<o;i++)n-=t.measureArea(e[i]);return n},n._updateCache=function(){t.prototype._updateCache.call(this),this._prjHoles&&(this._holes=this._unprojectCoords(this._getPrjHoles()))},n._clearCache=function(){return delete this._prjShell,t.prototype._clearCache.call(this)},n._clearProjection=function(){this._prjHoles&&(this._prjHoles=null),this._prjShell&&(this._prjShell=null),t.prototype._clearProjection.call(this)},e}(id);function sd(t){return function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n.getCoordinates=function(){return this._coordinates},n.setCoordinates=function(t){var e=t instanceof gh?t:new gh(t);if(this._translateRotatePivot(e),this._coordinates=e,!this.getMap())return this._dirtyCoords=!0,this.onPositionChanged(),this;var n=this._getProjection();return this._setPrjCoordinates(n.project(this._coordinates)),this},n._getCenter2DPoint=function(t){var e=this.getMap();if(!e)return null;var n=this._getPrjCoordinates();return n?(t||(t=e._getResolution()),e._prjToPointAtRes(n,t)):null},n._getPrjCoordinates=function(){var t=this._getProjection();return this._verifyProjection(),!this._pcenter&&t&&this._coordinates&&(this._pcenter=t.project(this._coordinates)),this._pcenter},n._setPrjCoordinates=function(t){this._pcenter=t,this.onPositionChanged()},n._updateCache=function(){this._clearCache();var t=this._getProjection();this._pcenter&&t&&(this._coordinates=t.unproject(this._pcenter))},n._clearProjection=function(){this._pcenter=null,t.prototype._clearProjection.call(this)},n._computeCenter=function(){return this._coordinates?this._coordinates.copy():null},e}(t)}od.registerJSONType(rd);var ad=new Oh,ld=function(t){function e(e,n){var i;return(i=t.call(this,n)||this).type="Point",i.isPoint=!0,e&&i.setCoordinates(e),i}he(e,t);var n=e.prototype;return n.getOutline=function(){var t=this.getCoordinates(),n=this.getContainerExtent(),i=this.getMap().coordToContainerPoint(t);return new e(t,{symbol:{markerType:"square",markerWidth:n.getWidth(),markerHeight:n.getHeight(),markerLineWidth:1,markerLineColor:"6b707b",markerFill:"rgba(0, 0, 0, 0)",markerDx:n.xmin-(i.x-n.getWidth()/2),markerDy:n.ymin-(i.y-n.getHeight()/2)}})},n.setSymbol=function(e){return delete this._fixedExtent,t.prototype.setSymbol.call(this,e)},n._getSizeSymbol=function(t){for(var e,n={},i=!1,o=!1,s=0;s<Zc.length;s++){var a=t[Zc[s]];h(a)||(!i&&Kr(a)&&(i=!0,o=!0),n[Zc[s]]=a)}for(var l=0;l<qc.length;l++){var c=t[qc[l]];h(c)||(!i&&Kr(c)&&(i=!0),n[qc[l]]=c)}return i?(e=So(n,this),o&&(e._dynamic=!0)):e=n,e},n._setExternSymbol=function(e){return this._symbol||delete this._fixedExtent,t.prototype._setExternSymbol.call(this,e)},n._isDynamicSize=function(){return this._sizeSymbol&&this._sizeSymbol._dynamic},n._getFixedExtent=function(){if(this._fixedExtent&&!this._isDynamicSize())return this._fixedExtent;this._fixedExtent=this._fixedExtent||new Oh,this._fixedExtent.set(null,null,null,null);var t=this._sizeSymbol;if(!t)return this._fixedExtent;var e=this.getLayer()&&this.getLayer().getRenderer(),n=e&&e.resources,i=this.getTextDesc();if(Array.isArray(t)){ad.set(1/0,1/0,-1/0,-1/0);for(var o=0;o<t.length;o++)t[o]&&this._fixedExtent._combine(zc(ad,t[o],n,i&&i[o]))}else this._fixedExtent=zc(this._fixedExtent,t,n,i);return this._fixedExtent},n._isVectorMarker=function(){var t=this._getInternalSymbol();return!Array.isArray(t)&&Uc(t)},n._canEdit=function(){var t=this._getInternalSymbol();return!Array.isArray(t)&&(Uc(t)||Vc(t)||jc(t))},n._containsPoint=function(e,n){var i=this.getContainerExtent();return n&&(i=i.expand(n)),!!i.contains(e)&&(!this.options.hitTestForEvent||t.prototype._containsPoint.call(this,e,n))},n._computeExtent=function(){return hd.call(this,"getCenter")},n._computePrjExtent=function(){return hd.call(this,"_getPrjCoordinates")},n._computeGeodesicLength=function(){return 0},n._computeGeodesicArea=function(){return 0},n._getSprite=function(t,e){return this._getPainter()?this._getPainter().getSprite(t,e):new Wu(this).getSprite(t,e)},e}(sd(cf));function hd(t){var e=this[t]();return e?new Ph(e,e,this._getProjection()):null}ld.mergeOptions({symbol:{markerType:"path",markerPath:[{path:"M8 23l0 0 0 0 0 0 0 0 0 0c-4,-5 -8,-10 -8,-14 0,-5 4,-9 8,-9l0 0 0 0c4,0 8,4 8,9 0,4 -4,9 -8,14z M3,9 a5,5 0,1,0,0,-0.9Z",fill:"#DE3333"}],markerPathWidth:16,markerPathHeight:23,markerWidth:24,markerHeight:34},hitTestForEvent:!1,collision:!0}),ld.registerJSONType("Marker");var cd=function(t){function e(e,n){var i;return(i=t.call(this,n)||this).type="LineString",e&&i.setCoordinates(e),i}he(e,t);var n=e.prototype;return n.getOutline=function(){return od.prototype.getOutline.call(this)},n.setCoordinates=function(t){return t?(this._coordinates=gh.toCoordinates(t),this.getMap()?this._setPrjCoordinates(this._projectCoords(this._coordinates)):this.onShapeChanged(),this):(this._coordinates=null,this._setPrjCoordinates(null),this)},n.getCoordinates=function(){return this._coordinates||[]},n.getCenterInExtent=function(t){return this._getCenterInExtent(t,this.getCoordinates(),Jc)},n._computeGeodesicLength=function(t){return t.measureLength(this.getCoordinates())},n._computeGeodesicArea=function(){return 0},e}(id);cd.mergeOptions({arrowStyle:null,arrowPlacement:"vertex-last"}),cd.registerJSONType("LineString");var ud=new Oh,fd=function(t){function e(e,n){var i;return(i=t.call(this,n)||this).type="GeometryCollection",i._lastUndoEditIndex=0,i._lastRedoEditIndex=0,i.setGeometries(e),i}he(e,t);var n=e.prototype;return n.getContainerExtent=function(t){var e=t||new Oh;return this.forEach((function(t){e._combine(t.getContainerExtent(ud))})),e},n.setGeometries=function(t){for(var e=this._checkGeometries(t||[]),n=this._getSymbol(),i=this.config(),o=this.getProperties(),s=e.length-1;s>=0;s--)e[s]._initOptions(i),e[s]._setParent(this),e[s]._setEventParent(this),n&&e[s].setSymbol(n),o&&e[s].setProperties(o);return this._geometries=e,this.getLayer()&&(this._bindGeometriesToLayer(),this.onShapeChanged()),this},n.getGeometries=function(){return this._geometries||[]},n.forEach=function(t,e){for(var n=this.getGeometries(),i=0,o=n.length;i<o;i++)n[i]&&(e?t.call(e,n[i],i):t(n[i],i));return this},n.filter=function(t,n){if(!t)return new e;var i=[],o=A(t),s=o?t:so(t);return this.forEach((function(t){var e=o?t:xo(t);(n?s.call(n,e):s(e))&&i.push(t)}),this),new e(i)},n.translate=function(t){if(!t)return this;if(this.isEmpty())return this;var e=arguments;return this.forEach((function(t){t&&t.translate&&t.translate.apply(t,e)})),this},n.isEmpty=function(){return!Je(this.getGeometries())},n.remove=function(){return this.forEach((function(t){t._unbind()})),cf.prototype.remove.apply(this,arguments)},n.show=function(){return this.options.visible=!0,this.forEach((function(t){t.show()})),this},n.hide=function(){return this.options.visible=!1,this.forEach((function(t){t.hide()})),this},n.onConfig=function(t){this.forEach((function(e){e.config(t)}))},n.getSymbol=function(){var e=t.prototype.getSymbol.call(this);if(!e){var n=[],i=!1;this.forEach((function(t){t.getSymbol()&&!i&&(i=!0),n.push(t.getSymbol())})),i&&(e={children:n})}return e},n.setSymbol=function(t){var e=this;if(t&&t.children)this._symbol=null,this.forEach((function(n,i){n._eventSymbolProperties=e._eventSymbolProperties,n.setSymbol(t.children[i])}));else{var n=this._prepareSymbol(t);this._symbol=n,this.forEach((function(t){t._eventSymbolProperties=e._eventSymbolProperties,t.setSymbol(n)}))}return this.onSymbolChanged(),this},n._setExternSymbol=function(t){return t=this._prepareSymbol(t),this._externSymbol=t,this.forEach((function(e){e._setExternSymbol(t)})),this.onSymbolChanged(),this},n._bindLayer=function(){t.prototype._bindLayer.apply(this,arguments),this._bindGeometriesToLayer()},n._bindGeometriesToLayer=function(){var t=this.getLayer();this.forEach((function(e){e._bindLayer(t)}))},n._checkGeometries=function(t){for(var e=[],n=0,i=(t=Array.isArray(t)?t:[t]).length;n<i;n++){var o=t[n];o&&(this._checkGeo(o)?gd(o)?s.isTest||console.error(o," is GeometryCollection sub class,it Cannot be placed in GeometryCollection"):e.push(o):console.error("The geometry added to collection is invalid. Index: "+n))}return e},n._checkGeo=function(t){return t instanceof cf},n._updateCache=function(){this._clearCache(),this.isEmpty()||this.forEach((function(t){t&&t._updateCache&&t._updateCache()}))},n._removePainter=function(){this._painter&&this._painter.remove(),delete this._painter,this.forEach((function(t){t._removePainter()}))},n._computeCenter=function(t){if(!t||this.isEmpty())return null;for(var e=0,n=0,i=0,o=this.getGeometries(),s=0,a=o.length;s<a;s++)if(o[s]){var l=o[s]._computeCenter(t);l&&(e+=l.x,n+=l.y,i++)}return 0===i?null:new gh(e/i,n/i)},n._containsPoint=function(t,e){if(this.isEmpty())return!1;delete this._pickGeometryIndex;for(var n=this.getGeometries(),i=0,o=n.length;i<o;i++)if(n[i]._containsPoint(t,e))return this._pickGeometryIndex=i,!0;return!1},n._hitTestTolerance=function(){for(var t=this.getGeometries(),e=0,n=0,i=t.length;n<i;n++){var o=t[n]._hitTestTolerance();e=Math.max(e,o)}return e},n._computeExtent=function(t){return dd.call(this,t,"_computeExtent")},n._computePrjExtent=function(t){return dd.call(this,t,"_computePrjExtent")},n._computeGeodesicLength=function(t){if(!t||this.isEmpty())return 0;for(var e=this.getGeometries(),n=0,i=0,o=e.length;i<o;i++)e[i]&&(n+=e[i]._computeGeodesicLength(t));return n},n._computeGeodesicArea=function(t){if(!t||this.isEmpty())return 0;for(var e=this.getGeometries(),n=0,i=0,o=e.length;i<o;i++)e[i]&&(n+=e[i]._computeGeodesicArea(t));return n},n._exportGeoJSONGeometry=function(){var t=[];if(!this.isEmpty())for(var e=this.getGeometries(),n=0,i=e.length;n<i;n++)e[n]&&t.push(e[n]._exportGeoJSONGeometry());return{type:"GeometryCollection",geometries:t}},n._toJSON=function(t){t=l({},t);var e,n={type:"Feature",geometry:{type:"GeometryCollection",geometries:this.getGeometries().filter((function(t){return t&&t._toJSON})).map((function(t){var e=t._toJSON();return e.subType?e:t._exportGeoJSONGeometry()}))}},i=this.getId();return h(i)||(n.id=i),(h(t.properties)||t.properties)&&(e=this._exportProperties()),n.properties=e,t.feature=n,t},n._clearProjection=function(){if(!this.isEmpty())for(var t=this.getGeometries(),e=0,n=t.length;e<n;e++)t[e]&&t[e]._clearProjection()},n._getConnectPoints=function(){var t=this.getExtent();return[new gh(t.xmin,t.ymax),new gh(t.xmax,t.ymin),new gh(t.xmin,t.ymin),new gh(t.xmax,t.ymax)]},n._getExternalResources=function(){if(this.isEmpty())return[];for(var t,e,n=this.getGeometries(),i=[],o={},s=0,a=n.length;s<a;s++)if(n[s])for(var l=0,h=(t=Eo(n[s]._getInternalSymbol())).length;l<h;l++)o[e=t[l].join()]||(i.push(t[l]),o[e]=1);return i},n.startEdit=function(t){var e=this;if(this.isEmpty())return this;t||(t={}),t.symbol&&(this._originalSymbol=this.getSymbol(),this.setSymbol(t.symbol)),this._draggbleBeforeEdit=this.options.draggable,this.config("draggable",!1),this._recordVisible();for(var n=this.getGeometries(),i=0,o=n.length;i<o;i++)n[i].startEdit(t);this._editing=!0;var s=this.getLayer();return s&&"canvas"===s.options.renderer&&this.hide(),setTimeout((function(){e.fire("editstart")}),1),this},n.endEdit=function(){if(this.isEmpty())return this;this._recoveryVisible();for(var t=this.getGeometries(),e=0,n=t.length;e<n;e++)t[e].endEdit();return this._originalSymbol&&(this.setSymbol(this._originalSymbol),delete this._originalSymbol),this._editing=!1,this.show(),this.config("draggable",this._draggbleBeforeEdit),this.fire("editend"),this},n.isEditing=function(){return!!this._editing},n.undoEdit=function(){if(this.isEmpty())return this;this._recoveryVisible();for(var t=this.getGeometries(),e=this._lastUndoEditIndex;e<t.length;e++)if(!t[e].undoEditcheck()){t[e].undoEdit(),this._lastUndoEditIndex=e;break}return e===t.length&&(this._lastUndoEditIndex=0),this.fire("undoedit"),this},n.redoEdit=function(){if(this.isEmpty())return this;this._recoveryVisible();for(var t=this.getGeometries(),e=this._lastRedoEditIndex;e<t.length;e++)if(!t[e].redoEditcheck()){t[e].redoEdit(),this._lastRedoEditIndex=e;break}return e===t.length&&(this._lastRedoEditIndex=0),this.fire("redoedit"),this},n.undoEditcheck=function(){for(var t=this.getGeometries(),e=0;e<t.length;e++)if(!t[e].undoEditcheck())return!1;return!0},n.redoEditcheck=function(){for(var t=this.getGeometries(),e=0;e<t.length;e++)if(!t[e].redoEditcheck())return!1;return!0},e}(cf);function dd(t,e){if(this.isEmpty())return null;for(var n=new Ph,i=this.getGeometries(),o=0,s=i.length;o<s;o++)if(i[o]){var a=i[o][e](t);a&&n._combine(a)}return n}function gd(t){return t instanceof fd}fd.registerJSONType("GeometryCollection");var pd=function(t){function e(e,n,i,o){var s;return(s=t.call(this,null,o)||this).GeometryType=e,s.type=n,s._initData(i),s}he(e,t);var n=e.prototype;return n.getCoordinates=function(){for(var t=[],e=this.getGeometries(),n=0,i=e.length;n<i;n++){var o=e[n];t.push(o.getShell&&"Polygon"!==o.getJSONType()?[o.getShell()]:o.getCoordinates())}return t},n.setCoordinates=function(t){for(var e=[],n=0,i=(t=t||[]).length;n<i;n++){var o=new this.GeometryType(t[n],this.config());e.push(o)}return this.setGeometries(e),this},n._initData=function(t){(t=t||[]).length&&(t[0]instanceof this.GeometryType?this.setGeometries(t):this.setCoordinates(t))},n._checkGeo=function(t){return t instanceof this.GeometryType},n._exportGeoJSONGeometry=function(){var t=this.getCoordinates(),e=gh.toNumberArrays(t);return{type:this.getType(),coordinates:e}},n._toJSON=function(t){return{feature:this.toGeoJSON(t)}},e}(fd),Ad=function(t){function e(e,n){return t.call(this,ld,"MultiPoint",e,n)||this}return he(e,t),e.prototype.findClosest=function(t){if(!t)return null;var e=this.getCoordinates(),n=null,i=1/0;return e.forEach((function(e){var o=function(t,e){var n=e.x-t.x,i=e.y-t.y;return Math.sqrt(n*n+i*i)}(e,t);o<i&&(n=e,i=o)})),n},e}(pd);Ad.registerJSONType("MultiPoint");var md=function(t){function e(){return t.apply(this,arguments)||this}return he(e,t),e.prototype.getCenterInExtent=function(t){var e=this.getGeometries(),[n,i,o]=[0,0,0];return e.forEach((function(e){var s=e.getCenterInExtent(t);s&&(n+=s.x*s.count,i+=s.y*s.count,o+=s.count)})),0===o?null:new gh(n,i)._multi(1/o)},e}(pd),yd=function(t){function e(e,n){return t.call(this,cd,"MultiLineString",e,n)||this}return he(e,t),e}(md);yd.registerJSONType("MultiLineString");var _d=function(t){function e(e,n){return t.call(this,od,"MultiPolygon",e,n)||this}return he(e,t),e}(md);_d.registerJSONType("MultiPolygon");var vd,xd={Marker:ld,LineString:cd,Polygon:od,MultiPoint:Ad,MultiLineString:yd,MultiPolygon:_d},bd="geojson-fetch-worker-page-async",wd=function(t){function e(){return t.call(this,bd)||this}he(e,t);var n=e.prototype;return n._sendMsg=function(t,e,n){var i=this;this.send(t,[],(function(o,s){o?n(o):i._pageFeatures(t,s,e,n)}),t.workerId)},n._fetchGeoJSON=function(t,e,n=[],i){var o=l({},e);o.type="fetchdata",o.url=t,this._sendMsg(o,n,i)},n._pageFeatures=function(t,e,n,i){if(n.push(e),0!==e.length){var o=l({},t);o.type="pagefeatures",this._sendMsg(o,n,i)}else i(null,n)},e}(xf);va(bd,(function(){return"\nfunction (exports) {\n    const resultMap = {};\n\n    function handleResult(msg, postResponse) {\n        const data = msg.data || {};\n        const { taskId } = data;\n        const features = resultMap[taskId];\n        if (!features) {\n            postResponse('not find geojson dataset the taskId:' + taskId);\n            return;\n        }\n        if (features.length === 0) {\n            delete resultMap[taskId];\n            postResponse(null, []);\n            return;\n        }\n        const pageSize = data.pageSize || 2000;\n        const pageFeatures = features.slice(0, pageSize);\n        resultMap[taskId] = features.slice(pageSize, Infinity);\n        postResponse(null, pageFeatures);\n    }\n    //worker init\n    exports.initialize = function () {\n        // console.log(\"geojson fetch init\");\n    };\n    //recive message\n    exports.onmessage = function (msg, postResponse) {\n        const { taskId, type, url } = msg.data || {};\n        if (!taskId) {\n            postResponse('not find task id for get geojson dataset,taskId=' + taskId);\n            return;\n        }\n        if (type === 'fetchdata') {\n            if (!url) {\n                postResponse('url is null,url=' + url);\n                return;\n            }\n            fetch(url).then(res => res.json()).then(geojson => {\n                let features;\n                if (Array.isArray(geojson)) {\n                    features = geojson;\n                } else if (geojson.features) {\n                    features = geojson.features;\n                } else {\n                    features = [geojson];\n                }\n                resultMap[taskId] = features;\n                handleResult(msg, postResponse);\n            }).catch(errror => {\n                postResponse(errror.message);\n            });\n        } else if (type === 'pagefeatures') {\n            handleResult(msg, postResponse);\n        } else {\n            postResponse('not support task type:' + type);\n        }\n    };\n}"}));var Td={toGeometry:function(t,e,n){var i;if(g(t)&&(t=Ee(t)),Array.isArray(t)){i=[];for(var o=0,s=t.length;o<s;o++){var a=Td._convert(t[o],e);Array.isArray(a)?ke(i,a):i.push(a)}}else i=Td._convert(t,e);return n&&A(n)&&Array.isArray(i)?i.filter(n):i},toGeometryAsync:function(t,e,n,i){return g(t)&&(t=Ee(t)),new Promise((function(o){var s=[];if(t&&(Array.isArray(t)||Array.isArray(t.features))){var a=c(n)?Math.round(n):2e3,l=t.features||t,h=Math.ceil(l.length/a),u=1;Ha({count:h,run:function(){var t=l.slice((u-1)*a,u*a),n=Td.toGeometry(t,e,i);return u++,n}}).then((function(t){for(var e=0,n=t.length;e<n;e++){var i=t[e];i&&(Array.isArray(i)?ke(s,i):s.push(i))}o(s)}))}else{var f=Td.toGeometry(t,e);o(f)}}))},_convert:function(t,e){if(!t||h(t.type))return null;var n=t.type;if("Feature"===n){var i=Td._convert(t.geometry);return i?(i.setId(t.id),i.setProperties(t.properties),e&&e(i),i):null}if("FeatureCollection"===n){var o=t.features;return o?Td.toGeometry(o,e):null}if(["Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon"].indexOf(n)>=0){var s=new xd["Point"===n?"Marker":n](t.coordinates);return e&&e(s),s}if("GeometryCollection"===n){var a=t.geometries;if(!Je(a)){var l=new fd;return e&&e(l),l}for(var c=[],u=a.length,f=0;f<u;f++)c.push(a[f].subType?cf.getJSONClass(a[f].subType).fromJSON(a[f]):Td._convert(a[f]));var g=new fd(c);return e&&e(g),g}return null},_isGeoJSON:function(t){if(!t)return!1;if(t=t||{},Array.isArray(t)&&t.length)return Td.isGeoJSON(t[0]);var e=t.type;if(!e)return!1;if(-1===Hn.indexOf(e))return!1;var{features:n,geometries:i,geometry:o,coordinates:s}=t;if(s&&Array.isArray(s))return!0;if(Array.isArray(i))return!0;if(Array.isArray(n))return!0;if(o){var a=o.coordinates;if(a&&Array.isArray(a))return!0}return!1},fetch:function(t,e=2e3){return new Promise((function(n,i){if(t&&g(t)){var o=l({pageSize:2e3},{pageSize:e});t=En(t),vd||(vd=new wd);var s=vd.workers.length,a=Math.floor(Math.random()*s);a=Math.min(s-1,a),o.workerId=a,o.taskId=Me(),vd._fetchGeoJSON(t,o,[],(function(t,e){if(t)i(t);else{var o=[];e.forEach((function(t){for(var e=0,n=t.length;e<n;e++)o.push(t[e])})),n({type:"FeatureCollection",features:o})}}))}else i("url is error,It should be string")}))}},Md=function(t){function e(e,n,i){var o;return o=t.call(this,null,i)||this,e&&o.setCoordinates(e),o._radius=n,o}he(e,t),e.fromJSON=function(t){var n=t.feature,i=new e(t.coordinates,t.radius,t.options);return i.setProperties(n.properties),i};var n=e.prototype;return n.getRadius=function(){return this._radius},n.setRadius=function(t){return this._radius=t,this.onShapeChanged(),this},n.getShell=function(){for(var t,e,n,i=this._getMeasurer(),o=this.getCoordinates(),s=this.options.numberOfShellPoints,a=this.getRadius(),l=[],h=0,c=s-1;h<c;h++){t=360*h/c*Math.PI/180,e=a*Math.cos(t),n=a*Math.sin(t);var u=i.locate(o,e,n);u.z=o.z,l.push(u)}return l.push(l[0]),l},n.getHoles=function(){return[]},n.animateShow=function(){return this.show()},n._containsPoint=function(e,n){var i=this.getMap();if(i.getPitch())return t.prototype._containsPoint.call(this,e,n);var o=i._pointToContainerPoint(this._getCenter2DPoint()),s=this.getSize(),a=this._hitTestTolerance()+(n||0),l=o.add(s.width/2,s.height/2);return tu(e,o,l,a)},n._computePrjExtent=function(t){var e=this._getMinMax(t);if(!e)return null;var n=this._getPrjCoordinates(),i=e.map((function(e){return t.project(e)})),o=i[1].x-n.x,s=i[3].y-n.y;return new Ph(n.add(i[0].x-n.x,i[2].y-n.y),n.add(o,s))},n._computeExtent=function(t){var e=this._getMinMax(t);return e?new Ph(e[0].x,e[2].y,e[1].x,e[3].y,this._getProjection()):null},n._getMinMax=function(t){if(!t||!this._coordinates||h(this._radius))return null;var e=this._radius;return[t.locate(this._coordinates,-e,0),t.locate(this._coordinates,e,0),t.locate(this._coordinates,0,e),t.locate(this._coordinates,0,-e)]},n._computeGeodesicLength=function(){return h(this._radius)?0:2*Math.PI*this._radius},n._computeGeodesicArea=function(){return h(this._radius)?0:Math.PI*Math.pow(this._radius,2)},n._exportGeoJSONGeometry=function(){return{type:"Polygon",coordinates:gh.toNumberArrays([this.getShell()])}},n._toJSON=function(t){var e=this.getCenter(),n=l({},t);n.geometry=!1;var i=this.toGeoJSON(n);return i.geometry={type:"Polygon"},{feature:i,subType:"Circle",coordinates:e.toArray(),radius:this.getRadius()}},e}(sd(od));function Cd(t){return t*t*t*t}Md.mergeOptions({numberOfShellPoints:60}),Md.registerJSONType("Circle");var Sd=function(t){function e(e,n,i,o){var s;return s=t.call(this,null,o)||this,e&&s.setCoordinates(e),s.width=n,s.height=i,s}he(e,t),e.fromJSON=function(t){var n=t.feature,i=new e(t.coordinates,t.width,t.height,t.options);return i.setProperties(n.properties),i};var n=e.prototype;return n.getWidth=function(){return this.width},n.setWidth=function(t){return this.width=t,this.onShapeChanged(),this},n.getHeight=function(){return this.height},n.setHeight=function(t){return this.height=t,this.onShapeChanged(),this},n.getShell=function(){return this.isRotated()?this.getRotatedShell():this._getShell()},n._getShell=function(){var t,e,n,i,o=this._getMeasurer(),s=this.getCoordinates(),a=this.options.numberOfShellPoints-1,l=this.getWidth(),h=this.getHeight(),c=[],u=Math.pow(l/2,2)*Math.pow(h/2,2),f=Math.pow(l/2,2),g=Math.pow(h/2,2),A=[];if(Math.max(l/h,h/l)>2){var{fs:m,sum:w}=function(t){for(var e=[],n=[],i=0;i<t;i++)n.push(Cd(i/t));var o=n.map((function(t){return t})).reverse(),s=[];ke(s,n,o,n,o);for(var a=0,l=0,h=s.length;l<h;l+=4)e.push(s[l]),a+=s[l];return{fs:e,sum:a}}(a),T=360/w,M=0;h>l&&(M=90);for(var C=0,P=0,I=m.length;P<I;P++)A.push((C+=T*m[P])+M)}else for(var O=0;O<a;O++){A.push(360*O/a)}this.options.debug&&console.log(A);for(var E=0;E<A.length;E++){e=(t=A[E])*Math.PI/180,n=Math.sqrt(u/(f*Math.pow(Math.tan(e),2)+g)),i=Math.sqrt(u/(g*Math.pow(1/Math.tan(e),2)+f)),t>90&&t<270&&(n*=-1),t>180&&t<360&&(i*=-1);var D=o.locate(s,n,i);D.z=s.z,c.push(D)}return c.push(c[0].copy()),c},n._getPrjShell=function(){var e=t.prototype._getPrjShell.call(this);return this._rotatePrjCoordinates(e)},n.getHoles=function(){return[]},n.animateShow=function(){return this.show()},n._containsPoint=function(e,n){var i=this.getMap();if(i.isTransforming())return t.prototype._containsPoint.call(this,e,n);var o=i.getProjection(),s=this._hitTestTolerance()+(n||0),a=o.projectCoords([this._coordinates,i.locate(this._coordinates,this.getWidth()/2,this.getHeight()/2)],this.options.antiMeridian);return tu(e,i.prjToContainerPoint(a[0]),i.prjToContainerPoint(a[1]),s)},n._computePrjExtent=function(){return this.isRotated()?this._computeRotatedPrjExtent():Md.prototype._computePrjExtent.apply(this,arguments)},n._computeExtent=function(){return Md.prototype._computeExtent.apply(this,arguments)},n._getMinMax=function(t){if(!t||!this._coordinates||h(this.width)||h(this.height))return null;var e=this.getWidth(),n=this.getHeight();return[t.locate(this._coordinates,-e/2,0),t.locate(this._coordinates,e/2,0),t.locate(this._coordinates,0,-n/2),t.locate(this._coordinates,0,n/2)]},n._computeGeodesicLength=function(){return h(this.width)||h(this.height)?0:2*Math.PI*(this.width>this.height?this.width:this.height)/2-4*Math.abs(this.width-this.height)},n._computeGeodesicArea=function(){return h(this.width)||h(this.height)?0:Math.PI*this.width*this.height/4},n._exportGeoJSONGeometry=function(){return{type:"Polygon",coordinates:gh.toNumberArrays([this.getShell()])}},n._toJSON=function(t){var e=l({},t),n=this.getCenter();e.geometry=!1;var i=this.toGeoJSON(e);return i.geometry={type:"Polygon"},{feature:i,subType:"Ellipse",coordinates:n.toArray(),width:this.getWidth(),height:this.getHeight()}},e}(sd(od));Sd.mergeOptions({numberOfShellPoints:81}),Sd.registerJSONType("Ellipse");var Pd=function(t){function e(e,n,i,o){var s;return s=t.call(this,null,o)||this,e&&s.setCoordinates(e),s._width=n,s._height=i,s}he(e,t),e.fromJSON=function(t){var n=t.feature,i=new e(t.coordinates,t.width,t.height,t.options);return i.setProperties(n.properties),i};var n=e.prototype;return n.getCoordinates=function(){return this._coordinates},n.setCoordinates=function(t){var e=t instanceof gh?t:new gh(t);if(this._translateRotatePivot(e),this._coordinates=e,!this._coordinates||!this.getMap())return this.onPositionChanged(),this;var n=this._getProjection();return this._setPrjCoordinates(n.project(this._coordinates)),this},n.getWidth=function(){return this._width},n.setWidth=function(t){return this._width=t,this.onShapeChanged(),this},n.getHeight=function(){return this._height},n.setHeight=function(t){return this._height=t,this.onShapeChanged(),this},n.getShell=function(){return this.isRotated()?this.getRotatedShell():this._getShell()},n._getShell=function(){var t=this._getMeasurer(),e=this._coordinates,n=this.getMap(),i=1,o=-1;if(n){var s=n.getFullExtent();s.left>s.right&&(i=-1),s.bottom>s.top&&(o=1)}var a=[];a.push(e);var l=t.locate(e,i*this._width,0);l.z=e.z,a.push(l);var h=t.locate(e,i*this._width,o*this._height);h.z=e.z,a.push(h);var c=t.locate(e,0,o*this._height);return a.push(c),c.z=e.z,a.push(e),a},n.getHoles=function(){return[]},n.animateShow=function(){return this.show()},n._getPrjCoordinates=function(){var t=this._getProjection();return this._verifyProjection(),!this._pnw&&t&&this._coordinates&&(this._pnw=t.project(this._coordinates)),this._pnw},n._setPrjCoordinates=function(t){this._pnw=t,this.onPositionChanged()},n._getPrjShell=function(){var e=t.prototype._getPrjShell.call(this),n=this._getProjection();if(!n.isSphere())return this._rotatePrjCoordinates(e);for(var i=n.getSphereExtent(),o=i.sx,s=i.sy,a=this._getProjection().getCircum(),l=e[0],h=1,c=e.length;h<c;h++){var u=e[h],f=0,g=0;o*(l.x-u.x)>0&&(f=a.x*o),s*(l.y-u.y)<0&&(g=a.y*s),e[h]._add(f,g)}return this._rotatePrjCoordinates(e)},n._updateCache=function(){this._clearCache();var t=this._getProjection();this._pnw&&t&&(this._coordinates=t.unproject(this._pnw))},n._clearProjection=function(){this._pnw=null,t.prototype._clearProjection.call(this)},n._computeCenter=function(t){return t.locate(this._coordinates,this._width/2,-this._height/2)},n._containsPoint=function(e,n){var i=this.getMap();if(i.isTransforming())return t.prototype._containsPoint.call(this,e,n);var o=h(n)?this._hitTestTolerance():n,s=i._getResolution()*o,a=this._getPrjExtent().expand(s),l=i._containerPointToPrj(e);return a.contains(l)},n._computePrjExtent=function(t){if(this.isRotated())return this._computeRotatedPrjExtent();var e=this._getSouthEast(t);if(!e)return null;var n=t.projectCoords([new gh(this._coordinates.x,e.y),new gh(e.x,this._coordinates.y)],this.options.antiMeridian);return new Ph(n[0],n[1])},n._computeExtent=function(t){var e=this._getSouthEast(t);return e?new Ph(this._coordinates,e,this._getProjection()):null},n._getSouthEast=function(t){if(!t||!this._coordinates||h(this._width)||h(this._height))return null;var e=this.getWidth(),n=-this.getHeight();if(t.fullExtent){var i=t.fullExtent;e*=i.right>i.left?1:-1,n*=i.top>i.bottom?1:-1}var o=t.locate(this._coordinates,e,0),s=t.locate(this._coordinates,0,n);return o.y=s.y,o},n._computeGeodesicLength=function(){return h(this._width)||h(this._height)?0:2*(this._width+this._height)},n._computeGeodesicArea=function(){return h(this._width)||h(this._height)?0:this._width*this._height},n._exportGeoJSONGeometry=function(){return{type:"Polygon",coordinates:gh.toNumberArrays([this.getShell()])}},n._toJSON=function(t){var e=l({},t),n=this.getCoordinates();e.geometry=!1;var i=this.toGeoJSON(e);return i.geometry={type:"Polygon"},{feature:i,subType:"Rectangle",coordinates:n.toArray(),width:this.getWidth(),height:this.getHeight()}},e}(od);Pd.registerJSONType("Rectangle");var Id=function(t){function e(e,n,i,o,s){var a;return(a=t.call(this,e,n,s)||this).startAngle=i,a.endAngle=o,a}he(e,t),e.fromJSON=function(t){var n=t.feature,i=new e(t.coordinates,t.radius,t.startAngle,t.endAngle,t.options);return i.setProperties(n.properties),i};var n=e.prototype;return n.getStartAngle=function(){return this.startAngle},n.setStartAngle=function(t){return this.startAngle=t,this.onShapeChanged(),this},n.getEndAngle=function(){return this.endAngle},n.setEndAngle=function(t){return this.endAngle=t,this.onShapeChanged(),this},n._correctAngles=function(){var t=this.getStartAngle(),e=this.getEndAngle();if(e<t)return console.error("The ending angle should be greater than the starting angle ",t,e),[0,0];return e-t>360?(console.error("The difference between the end angle and the start angle is greater than 360 degrees ",t,e),[0,0]):(t<0&&(t+=360,e+=360),[t,e])},n.getShell=function(){return this.isRotated()?this.getRotatedShell():this._getShell()},n._getShell=function(){for(var t,e,n,[i,o]=this._correctAngles(),s=this._getMeasurer(),a=this.getCoordinates(),l=this.options.numberOfShellPoints-2,h=this.getRadius(),c=[a.copy()],u=o-i,f=0;f<l;f++){t=(u*f/(l-1)+i)*Math.PI/180,e=h*Math.cos(t),n=h*Math.sin(t);var g=s.locate(a,e,n);g.z=a.z,c.push(g)}return c.push(a.copy()),c},n.getRotateOffsetAngle=function(){return 90},n._getPrjShell=function(){var e=t.prototype._getPrjShell.call(this);return this._rotatePrjCoordinates(e)},n._computePrjExtent=function(){return this.isRotated()?this._computeRotatedPrjExtent():Md.prototype._computePrjExtent.apply(this,arguments)},n._containsPoint=function(e,n){var i=this.getMap();if(i.isTransforming())return t.prototype._containsPoint.call(this,e,n);var o=i._pointToContainerPoint(this._getCenter2DPoint()),s=this._hitTestTolerance()+(n||0),a=this.getSize(),l=o,h=e,c=Math.atan2(l.y-h.y,h.x-l.x),u=c<0?360*(c+2*Math.PI)/(2*Math.PI):360*c/(2*Math.PI),[f,g]=this._correctAngles(),A=f%360,m=g%360,w=!1;return w=A>m?!(u>m&&u<A):u>=A&&u<=m,h.distanceTo(l)<=a.width/2+s&&w},n._computeGeodesicLength=function(){if(h(this._radius))return 0;var[t,e]=this._correctAngles();return 2*Math.PI*this._radius*Math.abs(t-e)/360+2*this._radius},n._computeGeodesicArea=function(){if(h(this._radius))return 0;var[t,e]=this._correctAngles();return Math.PI*Math.pow(this._radius,2)*Math.abs(t-e)/360},n._toJSON=function(t){var e=l({},t),n=this.getCenter();e.geometry=!1;var i=this.toGeoJSON(e);return i.geometry={type:"Polygon"},{feature:i,subType:"Sector",coordinates:n.toArray(),radius:this.getRadius(),startAngle:this.getStartAngle(),endAngle:this.getEndAngle()}},e}(Md);Id.mergeOptions({numberOfShellPoints:60}),Id.registerJSONType("Sector");var Od=function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n._arc=function(t,e,n){var i=this.options.arcDegree;0===i&&(i=1);for(var o=i*Math.PI/180,s=1,a=e.length;s<a;s++)zl._arcBetween(t,e[s-1],e[s],o),zl._stroke(t,n)},n._quadraticCurve=function(t,e){if(e.length<=2)zl._path(t,e);else{var n,i;for(n=2,i=e.length;n<i;n+=2)t.quadraticCurveTo(e[n-1].x,e[n-1].y,e[n].x,e[n].y);if((n-=1)<i)for(;n<i;n++)t.lineTo(e[n].x,e[n].y)}},n._bezierCurve=function(t,e){if(e.length<=3)zl._path(t,e);else{var n,i;for(n=1,i=e.length;n+2<i;n+=3)t.bezierCurveTo(e[n].x,e[n].y,e[n+1].x,e[n+1].y,e[n+2].x,e[n+2].y);if(n<i)for(;n<i;n++)t.lineTo(e[n].x,e[n].y)}},n._getCurveArrowPoints=function(t,e,n,i,o,s){var a,l=e.length;for(a=s;a<l;a+=s){var h=this._getArrowShape(e[a-1],e[a],n,i,o);h&&t.push(h)}if((a-=s)<l-1)for(a+=1;a<l;a++){var c=this._getArrowShape(e[a-1],e[a],n,i,o);c&&t.push(c)}},e}(cd);Od.mergeOptions({enableSimplify:!1,enableClip:!1});var Ed=function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n._toJSON=function(t){return{feature:this.toGeoJSON(t),subType:"ArcCurve"}},n._paintOn=function(t,e,n){t.beginPath(),this._arc(t,e,n),zl._stroke(t,n),this._paintArrow(t,e,n)},e.fromJSON=function(t){var n=t.feature,i=new e(n.geometry.coordinates,t.options);return i.setProperties(n.properties),i},e}(Od);Ed.registerJSONType("ArcCurve"),Ed.mergeOptions({arcDegree:90});var kd=function(t){function e(){return t.apply(this,arguments)||this}he(e,t),e.fromJSON=function(t){var n=t.feature,i=new e(n.geometry.coordinates,t.options);return i.setProperties(n.properties),i};var n=e.prototype;return n._toJSON=function(t){return{feature:this.toGeoJSON(t),subType:"CubicBezierCurve"}},n._paintOn=function(t,e,n){t.beginPath(),t.moveTo(e[0].x,e[0].y),this._bezierCurve(t,e),zl._stroke(t,n),this._paintArrow(t,e,n)},n._getArrowPoints=function(t,e,n,i,o){return this._getCurveArrowPoints(t,e,n,i,o,3)},e}(Od);kd.registerJSONType("CubicBezierCurve");var Rd=function(t){function e(){return t.apply(this,arguments)||this}he(e,t),e.fromJSON=function(t){var n=t.feature,i=new e(n.geometry.coordinates,t.options);return i.setProperties(n.properties),i};var n=e.prototype;return n._toJSON=function(t){return{feature:this.toGeoJSON(t),subType:"QuadBezierCurve"}},n._paintOn=function(t,e,n){t.beginPath(),t.moveTo(e[0].x,e[0].y),this._quadraticCurve(t,e,n),zl._stroke(t,n),this._paintArrow(t,e,n)},n._getArrowPoints=function(t,e,n,i,o){return this._getCurveArrowPoints(t,e,n,i,o,2)},e}(Od);Rd.registerJSONType("QuadBezierCurve");var Ld={textFaceName:"monospace",textSize:12,textLineSpacing:8,textWrapCharacter:"\n",textHorizontalAlignment:"middle",textVerticalAlignment:"middle"},Dd={markerType:"square",markerLineColor:"#000",markerLineWidth:2,markerLineOpacity:1,markerFill:"#fff",markerOpacity:1},Fd=function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n.getContent=function(){return this._content},n.setContent=function(t){var e=this._content;return this._content=ei(t),this._refresh(),this._fireEvent("contentchange",{old:e,new:t}),this},n.onAdd=function(){this._refresh()},n.toJSON=function(){var e=t.prototype.toJSON.call(this);return delete e.symbol,e},n.setSymbol=function(e){if(this._refreshing||!e)return t.prototype.setSymbol.call(this,e);var n=this._parseSymbol(e);if(this.setTextStyle){var i=this.getTextStyle()||{};i.symbol=n[0],this.setTextStyle(i)}else this.setTextSymbol&&this.setTextSymbol(n[0]);if(this.setBoxStyle){var o=this.getBoxStyle()||{};o.symbol=n[1],this.setBoxStyle(o)}else this.setBoxSymbol&&this.setBoxSymbol(n[1]);return this},n._parseSymbol=function(t){var e={},n={};for(var i in t)w(t,i)&&(0===i.indexOf("text")?e[i]=t[i]:n[i]=t[i]);return[e,n]},n._getTextSize=function(t){return _i(this._content,t).size},n._getInternalSymbol=function(){return this._symbol},n._getDefaultTextSymbol=function(){return l({},Ld)},n._getDefaultBoxSymbol=function(){return l({},Dd)},n._getDefaultPadding=function(){return[12,8]},e}(ld),Nd=function(t){function e(e,n,i,o,s={}){var a;return(a=t.call(this,n,s)||this)._content=ei(e),a._width=h(i)?100:i,a._height=h(o)?40:o,s.boxSymbol&&a.setBoxSymbol(s.boxSymbol),s.textStyle&&a.setTextStyle(s.textStyle),a._refresh(),a}he(e,t);var n=e.prototype;return n.getWidth=function(){return this._width},n.setWidth=function(t){return this._width=t,this._refresh(),this},n.getHeight=function(){return this._height},n.setHeight=function(t){return this._height=t,this._refresh(),this},n.getBoxSymbol=function(){return l({},this.options.boxSymbol)},n.setBoxSymbol=function(t){return this.options.boxSymbol=t?l({},t):t,this.getSymbol()&&this._refresh(),this},n.getTextStyle=function(){return this.options.textStyle?l({},this.options.textStyle):null},n.setTextStyle=function(t){return this.options.textStyle=t?l({},t):t,this.getSymbol()&&this._refresh(),this},e.fromJSON=function(t){var n=t.feature,i=new e(t.content,n.geometry.coordinates,t.width,t.height,t.options);return i.setProperties(n.properties),i.setId(n.id),t.symbol&&i.setSymbol(t.symbol),i},n._toJSON=function(t){return{feature:this.toGeoJSON(t),width:this.getWidth(),height:this.getHeight(),subType:"TextBox",content:this._content}},n._refresh=function(){var t,e,n=this.getTextStyle()||{},i=n.padding||[12,8];if(Kr(this._width)){var o=(t=JSON.parse(JSON.stringify(this._width))).stops;if(o)for(var s=0;s<o.length;s++)o[s][1]=o[s][1]-2*i[0]}else t=this._width-2*i[0];if(Kr(this._height)){var a=(e=JSON.parse(JSON.stringify(this._height))).stops;if(a)for(var h=0;h<a.length;h++)a[h][1]=a[h][1]-2*i[1]}else e=this._height-2*i[1];var c=l({},n.symbol||this._getDefaultTextSymbol(),this.options.boxSymbol||this._getDefaultBoxSymbol(),{textName:this._content,markerWidth:this._width,markerHeight:this._height,textHorizontalAlignment:"middle",textVerticalAlignment:"middle",textMaxWidth:t,textMaxHeight:e});n.wrap&&!c.textWrapWidth&&(c.textWrapWidth=t);var u,f=n.horizontalAlignment;if(c.textDx=c.markerDx||0,Kr(this._width)){var g=(u=JSON.parse(JSON.stringify(this._width))).stops;if(g)for(var A=0;A<g.length;A++)g[A][1]=g[A][1]/2-i[0],"left"===f&&(g[A][1]*=-1)}else u=c.markerWidth/2-i[0],"left"===f&&(u*=-1);"left"===f?(c.textHorizontalAlignment="right",c.textDx=u):"right"===f&&(c.textHorizontalAlignment="left",c.textDx=u);var m,w=n.verticalAlignment;if(c.textDy=c.markerDy||0,Kr(this._height)){var T=(m=JSON.parse(JSON.stringify(this._height))).stops;if(T)for(var M=0;M<T.length;M++)T[M][1]=T[M][1]/2-i[1],"top"===w&&(T[M][1]*=-1)}else m=c.markerHeight/2-i[1],"top"===w&&(m*=-1);"top"===w?(c.textVerticalAlignment="bottom",c.textDy=m):"bottom"===w&&(c.textVerticalAlignment="top",c.textDy=m),this._refreshing=!0,this.updateSymbol(c),delete this._refreshing},n.startEdit=function(e){var n=this._getCompiledSymbol();if(Kr(this._width)){var i=n.markerWidth;this._oldWidth=this._width,this.setWidth(i)}if(Kr(this._height)){var o=n.markerHeight;this._oldHeight=this._height,this.setHeight(o)}return t.prototype.startEdit.call(this,e)},n.endEdit=function(){var e=this.getMap(),n=e&&e.getZoom();if(this._oldWidth){for(var i=this._width/to(this._oldWidth)(n),o=this._oldWidth.stops,s=0;s<o.length;s++)o[s][1]*=i;this.setWidth(this._oldWidth),delete this._oldWidth}if(this._oldHeight){for(var a=this._height/to(this._oldHeight)(n),l=this._oldHeight.stops,h=0;h<l.length;h++)l[h][1]*=a;this.setHeight(this._oldHeight),delete this._oldHeight}return t.prototype.endEdit.call(this)},e}(Fd);Nd.mergeOptions({textStyle:{wrap:!0,padding:[12,8],verticalAlignment:"middle",horizontalAlignment:"middle"},boxSymbol:null}),Nd.registerJSONType("TextBox");var Hd=function(t){function e(e,n,i={}){var o;return o=t.call(this,n,i)||this,i.textSymbol&&o.setTextSymbol(i.textSymbol),i.boxStyle&&o.setBoxStyle(i.boxStyle),o._content=ei(e),o._refresh(),o}he(e,t);var n=e.prototype;return n.getBoxStyle=function(){return this.options.boxStyle?l({},this.options.boxStyle):null},n.setBoxStyle=function(t){return this.options.boxStyle=t?l({},t):t,this._refresh(),this},n.getTextSymbol=function(){return l({},this._getDefaultTextSymbol(),this.options.textSymbol)},n.setTextSymbol=function(t){return this.options.textSymbol=t?l({},t):t,this._refresh(),this},e.fromJSON=function(t){var n=t.feature,i=new e(t.content,n.geometry.coordinates,t.options);return i.setProperties(n.properties),i.setId(n.id),t.symbol&&i.setSymbol(t.symbol),i},n._canEdit=function(){return!1},n._toJSON=function(t){return{feature:this.toGeoJSON(t),subType:"Label",content:this._content}},n._refresh=function(){var t=l({},this.getTextSymbol(),{textName:this._content}),e=this.getBoxStyle();if(e){l(t,e.symbol);var n=this._getBoxSize(t),i=n[1],o=e.padding||this._getDefaultPadding(),s=n[0];t.markerWidth=s.width,t.markerHeight=s.height;var a=t.textDx||0,h=t.textDy||0,c=gi(i,t.textHorizontalAlignment,t.textVerticalAlignment)._add(a,h),u=e.horizontalAlignment||"middle";t.markerDx=c.x,"left"===u?t.markerDx+=t.markerWidth/2-o[0]:"right"===u?t.markerDx-=t.markerWidth/2-i.width-o[0]:t.markerDx+=i.width/2;var f=e.verticalAlignment||"middle";t.markerDy=c.y,"top"===f?t.markerDy+=t.markerHeight/2-o[1]:"bottom"===f?t.markerDy-=t.markerHeight/2-i.height-o[1]:t.markerDy+=i.height/2}this._refreshing=!0,this.updateSymbol(t),delete this._refreshing},n._getBoxSize=function(t){t.markerType||(t.markerType="square");var e,n,i=this.getBoxStyle(),o=this._getTextSize(t),s=i.padding||this._getDefaultPadding();return e=o.width+2*s[0],n=o.height+2*s[1],i.minWidth&&(!e||e<i.minWidth)&&(e=i.minWidth),i.minHeight&&(!n||n<i.minHeight)&&(n=i.minHeight),[new qn(e,n),o]},e}(Fd);Hd.mergeOptions({boxStyle:null,textSymbol:null}),Hd.registerJSONType("Label");var Bd=function(t){return function(t){function e(...e){return t.call(this,...e)||this}he(e,t),e._hasConnectors=function(t){return!h(t.__connectors)&&t.__connectors.length>0},e._getConnectors=function(t){return t.__connectors};var n=e.prototype;return n.getConnectSource=function(){return this._connSource},n.setConnectSource=function(t){var e=this._connTarget;return this.onRemove(),this._connSource=t,this._connTarget=e,this.onAdd(),this},n.getConnectTarget=function(){return this._connTarget},n.setConnectTarget=function(t){var e=this._connSource;return this.onRemove(),this._connSource=e,this._connTarget=t,this._updateCoordinates(),this._registerEvents(),this},n._updateCoordinates=function(){var t=this.getMap();if(!t&&this._connSource&&(t=this._connSource.getMap()),!t&&this._connTarget&&(t=this._connTarget.getMap()),t&&this._connSource&&this._connTarget){for(var e,n,i=this._connSource._getConnectPoints(),o=this._connTarget._getConnectPoints(),s=0,a=this.getCoordinates(),l=0,h=i.length;l<h;l++)for(var c=i[l],u=0,f=o.length;u<f;u++){var g=o[u],A=t.computeLength(c,g);0===l&&0===u?(e=c,n=g,s=A):A<s&&(e=c,n=g)}Je(a)&&a[0].equals(e)&&a[1].equals(n)||this.setCoordinates([e,n])}},n.onAdd=function(){this._registerEvents(),this._updateCoordinates()},n.onRemove=function(){if(this._connSource&&(this._connSource.__connectors&&Le(this,this._connSource.__connectors),this._connSource.off("dragging positionchange",this._updateCoordinates,this).off("remove",this.onRemove,this),this._connSource.off("dragstart mousedown mouseover",this._showConnect,this),this._connSource.off("dragend mouseup mouseout",this.hide,this),this._connSource.off("show",this._showConnect,this).off("hide",this.hide,this),delete this._connSource),this._connTarget&&(Le(this,this._connTarget.__connectors),this._connTarget.off("dragging positionchange",this._updateCoordinates,this).off("remove",this.onRemove,this),this._connTarget.off("show",this._showConnect,this).off("hide",this.hide,this),delete this._connTarget),!(this._connSource instanceof cf&&this._connTarget instanceof cf)){var t=this.getMap();t&&t.off("movestart moving moveend zoomstart zooming zoomend rotate pitch fovchange spatialreferencechange",this._updateCoordinates,this)}},n._showConnect=function(){this._connSource&&this._connTarget&&this._connSource.isVisible()&&this._connTarget.isVisible()&&(this._updateCoordinates(),this.show())},n._registerEvents=function(){if(this._connSource&&this._connTarget){this._connSource.__connectors||(this._connSource.__connectors=[]),this._connTarget.__connectors||(this._connTarget.__connectors=[]),this._connSource.__connectors.push(this),this._connTarget.__connectors.push(this),this._connSource.on("dragging positionchange",this._updateCoordinates,this).on("remove",this.remove,this),this._connTarget.on("dragging positionchange",this._updateCoordinates,this).on("remove",this.remove,this),this._connSource.on("show",this._showConnect,this).on("hide",this.hide,this),this._connTarget.on("show",this._showConnect,this).on("hide",this.hide,this);var t=this.options.showOn;if(this.hide(),"moving"===t?(this._connSource.on("dragstart",this._showConnect,this).on("dragend",this.hide,this),this._connTarget.on("dragstart",this._showConnect,this).on("dragend",this.hide,this)):"click"===t?(this._connSource.on("mousedown",this._showConnect,this).on("mouseup",this.hide,this),this._connTarget.on("mousedown",this._showConnect,this).on("mouseup",this.hide,this)):"mouseover"===t?(this._connSource.on("mouseover",this._showConnect,this).on("mouseout",this.hide,this),this._connTarget.on("mouseover",this._showConnect,this).on("mouseout",this.hide,this)):this._showConnect(),!(this._connSource instanceof cf&&this._connTarget instanceof cf)){var e=this.getMap();e&&e.on("movestart moving moveend zoomstart zooming zoomend rotate pitch fovchange spatialreferencechange",this._updateCoordinates,this)}}},e}(t)},zd={showOn:"always"},Gd=function(t){function e(e,n,i){var o;return o=t.call(this,null,i)||this,1===arguments.length&&(i=e,e=null,n=null),o._connSource=e,o._connTarget=n,o}return he(e,t),e}(Bd(cd));Gd.mergeOptions(zd),Gd.registerJSONType("ConnectorLine");var jd=function(t){function e(e,n,i){var o;return o=t.call(this,null,i)||this,1===arguments.length&&(i=e,e=null,n=null),o._connSource=e,o._connTarget=n,o}return he(e,t),e}(Bd(Ed));function Ud(t){return t&&t instanceof cf}jd.mergeOptions(zd),jd.registerJSONType("ArcConnectorLine");var Vd=[],Wd=function(t){function e(e,n,i){var o;n&&!Ud(n)&&!Array.isArray(n)&&Hn.indexOf(n.type)<0&&(i=n,n=null),(o=t.call(this,e,i)||this)._maxZIndex=0,o._minZIndex=0,o._initCache(),n&&o.addGeometry(n);var s=o.options.style;return s&&o.setStyle(s),o}he(e,t);var n=e.prototype;return n.getAltitude=function(){return 0},n.getGeometryById=function(t){return h(t)||""===t?null:this._geoMap[t]?this._geoMap[t]:null},n.getGeometries=function(t,e){if(!t)return this._geoList.slice(0);for(var n,i=[],o=0,s=this._geoList.length;o<s;o++)n=this._geoList[o],(e?t.call(e,n):t(n))&&i.push(n);return i},n.getFirstGeometry=function(){return this._geoList.length?this._geoList[0]:null},n.getLastGeometry=function(){var t=this._geoList.length;return 0===t?null:this._geoList[t-1]},n.getCount=function(){return this._geoList.length},n.getExtent=function(){if(0===this.getCount())return null;var t=new Ph(this.getProjection());return this.forEach((function(e){t._combine(e.getExtent())})),t},n.forEach=function(t,e){for(var n=this._geoList.slice(0),i=0,o=n.length;i<o;i++)e?t.call(e,n[i],i):t(n[i],i);return this},n.filter=function(t,e){var n=[],i=A(t),o=i?t:so(t);return this.forEach((function(t){var s=i?t:xo(t);(e?o.call(e,s):o(s))&&n.push(t)}),this),n},n.isEmpty=function(){return!this._geoList.length},n.addGeometry=function(t,e){if(!t)return this;if("FeatureCollection"===t.type)return this.addGeometry(Td.toGeometry(t),e);if(!Array.isArray(t)){var n=arguments.length,i=arguments[n-1];return t=Array.prototype.slice.call(arguments,0,n-1),e=i,i&&f(i)&&("type"in i||Ud(i))&&(t.push(i),e=!1),this.addGeometry(t,e)}if(0===t.length)return this;var o;this._initCache(),e&&(o=new Ph),this._toSort=this._maxZIndex>0;for(var s=[],a=0,c=t.length;a<c;a++){var u=t[a];if(!u||!Td._isGeoJSON(u)&&!Ud(u))throw new Error("Invalid geometry to add to layer("+this.getId()+") at index:"+a);if(!u.getLayer||u.getLayer()!==this){if(!Ud(u)&&(u=cf.fromJSON(u),Array.isArray(u)))for(var g=0,m=u.length;g<m;g++)this._add(u[g],o,a),s.push(u[g]);if(!u)throw new Error("Invalid geometry to add to layer("+this.getId()+") at index:"+a);Array.isArray(u)||(this._add(u,o,a),s.push(u))}}var w=this.getMap();if(w&&(this._getRenderer().onGeometryAdd(s),o&&!h(o.xmin))){var T=o.getCenter(),M=w.getFitZoom(o);if(f(e)){var C=A(e.step)?e.step:function(){};w.animateTo({center:T,zoom:M},l({duration:w.options.zoomAnimationDuration,easing:"out"},e),C)}else!0===e&&w.setCenterAndZoom(T,M)}return this.fire("addgeo",{type:"addgeo",target:this,geometries:t}),this},n.getGeoMinZIndex=function(){return this._minZIndex},n.getGeoMaxZIndex=function(){return this._maxZIndex},n._add=function(t,e,n){this._toSort||(this._toSort=0!==t.getZIndex()),this._updateZIndex(t.getZIndex());var i=t.getId();if(!h(i)){if(!h(this._geoMap[i]))throw new Error("Duplicate geometry id in layer("+this.getId()+"):"+i+", at index:"+n);this._geoMap[i]=t}var o=we();t._setInternalId(o),this._geoList.push(t),this.onAddGeometry(t),t._bindLayer(this),t.onAdd&&t.onAdd(),e&&e._combine(t.getExtent()),t._fireEvent("add",{layer:this}),this._cookedStyles&&this._styleGeometry(t)},n.removeGeometry=function(t){if(!Array.isArray(t))return this.removeGeometry([t]);for(var e=t.length-1;e>=0;e--)t[e]instanceof cf||(t[e]=this.getGeometryById(t[e])),t[e]&&this===t[e].getLayer()&&t[e].remove();return this},n.clear=function(){this._clearing=!0,this.forEach((function(t){t.remove()})),this._geoMap={};var t=this._geoList;this._geoList=[];var e=this._getRenderer();return e&&(e.onGeometryRemove(t),e.clearImageData&&(e.clearImageData(),delete e._lastGeosToDraw)),this._clearing=!1,this.fire("clear"),this},n.onRemoveGeometry=function(t){if(t&&!this._clearing&&(this===t.getLayer()&&!h(t._getInternalId()))){var e=t.getId();h(e)||delete this._geoMap[e];var n=this._findInList(t);n>=0&&this._geoList.splice(n,1),this._getRenderer()&&this._getRenderer().onGeometryRemove([t])}},n.getStyle=function(){return this.options.style?this.options.style:null},n.setStyle=function(t){return this.options.style=t,t=Uo(t),this._cookedStyles=bo(t),this.forEach((function(t){this._styleGeometry(t)}),this),this.fire("setstyle",{type:"setstyle",target:this,style:t}),this},n._styleGeometry=function(t){if(!this._cookedStyles)return!1;for(var e=xo(t),n=0,i=this._cookedStyles.length;n<i;n++)if(!0===this._cookedStyles[n].filter(e))return t._setExternSymbol(this._cookedStyles[n].symbol),!0;return!1},n.removeStyle=function(){return this.options.style?(delete this.options.style,delete this._cookedStyles,this.forEach((function(t){t._setExternSymbol(null)}),this),this.fire("removestyle"),this):this},n.onAddGeometry=function(t){this.getStyle()&&this._styleGeometry(t)},n.hide=function(){for(var t=0,e=this._geoList.length;t<e;t++)this._geoList[t].onHide();return Pf.prototype.hide.call(this)},n._initCache=function(){this._geoList||(this._geoList=[],this._geoMap={})},n._updateZIndex=function(...t){this._maxZIndex=Math.max(this._maxZIndex,Math.max(...t)),this._minZIndex=Math.min(this._minZIndex,Math.min(...t))},n._sortGeometries=function(){var t=this;this._toSort&&(this._maxZIndex=0,this._minZIndex=0,this._geoList.sort((function(e,n){return t._updateZIndex(e.getZIndex(),n.getZIndex()),t._compare(e,n)})),this._toSort=!1)},n._compare=function(t,e){return t.getZIndex()===e.getZIndex()?t._getInternalId()-e._getInternalId():t.getZIndex()-e.getZIndex()},n._findInList=function(t){var e=this._geoList.length;if(0===e)return-1;this._sortGeometries();for(var n,i=0,o=e-1;i<=o;){if(n=Math.floor((i+o)/2),this._geoList[n]===t)return n;this._compare(this._geoList[n],t)>0?o=n-1:i=n+1}return-1},n.onGeometryEvent=function(t){return this._onGeometryEvent(t)},n._onGeometryEvent=function(t){if(t&&t.target){var e=t.type;"idchange"===e?this._onGeometryIdChange(t):"zindexchange"===e?this._onGeometryZIndexChange(t):"positionchange"===e?this._onGeometryPositionChange(t):"shapechange"===e?this._onGeometryShapeChange(t):"symbolchange"===e?this._onGeometrySymbolChange(t):"show"===e?this._onGeometryShow(t):"hide"===e?this._onGeometryHide(t):"propertieschange"===e&&this._onGeometryPropertiesChange(t)}},n._onGeometryIdChange=function(t){if(t.new!==t.old||!this._geoMap[t.old]||this._geoMap[t.old]!==t.target){if(!h(t.new)){if(this._geoMap[t.new])throw new Error("Duplicate geometry id in layer("+this.getId()+"):"+t.new);this._geoMap[t.new]=t.target}h(t.old)||t.new===t.old||delete this._geoMap[t.old]}},n._onGeometryZIndexChange=function(t){t.old!==t.new&&(this._updateZIndex(t.new),this._toSort=!0,this._getRenderer()&&this._getRenderer().onGeometryZIndexChange(t))},n._onGeometryPositionChange=function(t){this._getRenderer()&&this._getRenderer().onGeometryPositionChange(t)},n._onGeometryShapeChange=function(t){this._getRenderer()&&this._getRenderer().onGeometryShapeChange(t)},n._onGeometrySymbolChange=function(t){this._getRenderer()&&this._getRenderer().onGeometrySymbolChange(t)},n._onGeometryShow=function(t){this._getRenderer()&&this._getRenderer().onGeometryShow(t)},n._onGeometryHide=function(t){this._getRenderer()&&this._getRenderer().onGeometryHide(t)},n._onGeometryPropertiesChange=function(t){this._getRenderer()&&this._getRenderer().onGeometryPropertiesChange(t)},n._hasGeoListeners=function(t){if(!t)return!1;Array.isArray(t)||(Vd[0]=t,t=Vd);for(var e=this.getGeometries()||[],n=0,i=e.length;n<i;n++){var o=e[n];if(o){if(o.options.cursor)return!0;for(var s=0,a=t.length;s<a;s++){if(o.listens(t[s])>0)return!0}}}return!1},n._getRenderer=function(){return t.prototype._getRenderer.call(this)},e}(Pf);Wd.mergeOptions({drawImmediate:!1,geometryEvents:!0,geometryEventTolerance:1});var Zd=function(t){function e(n,i,o={}){var s;return i&&!Ud(i)&&!Array.isArray(i)&&Hn.indexOf(i.type)<0&&(o=i,i=null),s=t.call(this,n,o)||this,o.sceneConfig={depthFunc:s.options.depthFunc||"always"},s._markerLayer=new e.markerLayerClazz(n+"_marker",o),s._lineLayer=new e.lineLayerClazz(n+"_line",o),s._polygonLayer=new e.polygonLayerClazz(n+"_polygon",o),i&&s.addGeometry(i),s}he(e,t),e.setLayerClass=function(t,n,i){e.markerLayerClazz=t,e.lineLayerClazz=n,e.polygonLayerClazz=i};var n=e.prototype;return n.bringToFront=function(){return this._polygonLayer.bringToFront(),this._lineLayer.bringToFront(),this._markerLayer.bringToFront(),this},n.addGeometry=function(t){Array.isArray(t)||(t=[t]),ke(this._geoList,t);for(var e=0;e<t.length;e++)this._markerLayer.isVectorLayer||t[e]instanceof ld||t[e]instanceof Ad?this._markerLayer.addGeometry(t[e]):t[e]instanceof cd||t[e]instanceof yd?this._lineLayer.addGeometry(t[e]):(t[e]instanceof od||t[e]instanceof _d)&&this._polygonLayer.addGeometry(t[e])},n.removeGeometry=function(t){Array.isArray(t)||(t=[t]);for(var e=0;e<t.length;e++)this._geoList.splice(t[e],1),this._markerLayer.isVectorLayer||t[e]instanceof ld||t[e]instanceof Ad?this._markerLayer.removeGeometry(t[e]):t[e]instanceof cd||t[e]instanceof yd?this._lineLayer.removeGeometry(t[e]):(t[e]instanceof od||t[e]instanceof _d)&&this._polygonLayer.removeGeometry(t[e])},n._onRemoveDrawToolGeo=function(t){for(var e=t.geometries,n=0;n<e.length;n++)e[n]&&this._geoList.splice(e[n],1)},n.onRemove=function(){return this._geoList=[],this._markerLayer.off("removegeo",this._onRemoveDrawToolGeo,this),this._lineLayer.off("removegeo",this._onRemoveDrawToolGeo,this),this._polygonLayer.off("removegeo",this._onRemoveDrawToolGeo,this),this._markerLayer.remove(),this._lineLayer.remove(),this._polygonLayer.remove(),delete this._markerLayer,delete this._lineLayer,delete this._polygonLayer,t.prototype.onRemove.call(this)},n.onAdd=function(){var e=this.getMap();return this._polygonLayer.addTo(e),this._lineLayer.addTo(e),this._markerLayer.addTo(e),this._markerLayer.on("removegeo",this._onRemoveDrawToolGeo,this),this._lineLayer.on("removegeo",this._onRemoveDrawToolGeo,this),this._polygonLayer.on("removegeo",this._onRemoveDrawToolGeo,this),t.prototype.onAdd.call(this)},n.getRenderer=function(){return this._getRenderer()},n._getRenderer=function(){return this._markerLayer.getRenderer()},e}(Wd);Zd.mergeOptions({renderer:null});var qd="_map_tool",Xd=function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n.addTo=function(t){return t?(this._map=t,t[qd]&&t[qd].disable(),this.onAdd&&this.onAdd(),this.enable(),t[qd]=this,this._fireEvent("add"),this):this},n.getMap=function(){return this._map},n.enable=function(){return!this._map||this._enabled||(this._enabled=!0,this._switchEvents("off"),this._registerEvents(),this.onEnable&&this.onEnable(),this._fireEvent("enable")),this},n.disable=function(){return this._enabled&&this._map?(this._enabled=!1,this._switchEvents("off"),this.onDisable&&this.onDisable(),this._fireEvent("disable"),this):this},n.isEnabled=function(){return!!this._enabled},n.remove=function(){return this._map?(this.disable(),this._map&&(delete this._map[qd],delete this._map),this._fireEvent("remove"),this):this},n._registerEvents=function(){this._switchEvents("on")},n._switchEvents=function(t){var e=this.getEvents();e&&this._map[t](e,this)},n._fireEvent=function(t,e){e||(e={}),this.fire(t,e)},e}(Xl(Ql)),Jd={symbol:{lineColor:"#000",lineWidth:2,lineOpacity:1,polygonFill:"#fff",polygonOpacity:.3},doubleClickZoom:!1,mode:null,once:!1,autoPanAtEdge:!1,ignoreMouseleave:!0,blockGeometryEvents:!1,zIndex:Number.MAX_VALUE,enableAltitude:!0,interactive:!0,transformCoordinate:null},Qd={},Yd=function(t){function e(e){var n;return(n=t.call(this,e)||this)._checkMode(),n._events={click:n._clickHandler,"mousemove touchmove":n._mouseMoveHandler,dblclick:n._doubleClickHandler,"mousedown touchstart":n._mouseDownHandler,"mouseup touchend":n._mouseUpHandler,mousemove:n._mouseMoveHandler,mousedown:n._mouseDownHandler,mouseup:n._mouseUpHandler},n}he(e,t),e.registerMode=function(t,e){Qd[t.toLowerCase()]=e},e.getRegisterMode=function(t){return Qd[t.toLowerCase()]};var n=e.prototype;return n.getMode=function(){return this.options.mode?this.options.mode.toLowerCase():null},n.setMode=function(t){return this._geometry&&(this._geometry.remove(),delete this._geometry),this._clearStage(),this._switchEvents("off"),this.options.mode=t,this._checkMode(),this.isEnabled()&&(this._switchEvents("on"),this._restoreMapCfg(),this._saveMapCfg()),this},n.getSymbol=function(){var t=this.options.symbol;return jo(t||this.options.symbol)},n.setSymbol=function(t){return t?(this.options.symbol=t,this._geometry&&this._geometry.setSymbol(t),this):this},n.getCurrentGeometry=function(){return this._geometry},n.onAdd=function(){this._checkMode()},n.onEnable=function(){this._saveMapCfg(),this._drawToolLayer=this._getDrawLayer(),this._clearStage(),this._loadResources();var t=this.getMap();return this.options.autoPanAtEdge&&(this._mapAutoPanAtEdge=t.options.autoPanAtEdge,this._mapAutoPanAtEdge||t.config({autoPanAtEdge:!0})),this._geometryEvents=t.options.geometryEvents,this.options.blockGeometryEvents&&t.config("geometryEvents",!1),this},n.onDisable=function(){var t=this.getMap();return this._restoreMapCfg(),this.endDraw({ignoreEndEvent:!0}),this._map&&(t.removeLayer(this._getDrawLayer()),this.options.autoPanAtEdge&&(this._mapAutoPanAtEdge||t.config({autoPanAtEdge:!1}))),this.options.blockGeometryEvents&&t.config("geometryEvents",this._geometryEvents),this},n.undo=function(){var t=this._getRegisterMode();if(!this._shouldRecordHistory(t.action)||!this._historyPointer)return this;var e=this._clickCoords.slice(0,--this._historyPointer);return t.update(this.getMap().getProjection(),e,this._geometry),this},n.redo=function(){var t=this._getRegisterMode();if(!this._shouldRecordHistory(t.action)||h(this._historyPointer)||this._historyPointer===this._clickCoords.length)return this;var e=this._clickCoords.slice(0,++this._historyPointer);return t.update(this.getMap().getProjection(),e,this._geometry),this},n._shouldRecordHistory=function(t){return Array.isArray(t)&&"click"===t[0]&&"mousemove"===t[1]&&"dblclick"===t[2]},n._checkMode=function(){this._getRegisterMode()},n._saveMapCfg=function(){var t=this.getMap();this._mapDoubleClickZoom=t.options.doubleClickZoom,t.config({doubleClickZoom:this.options.doubleClickZoom});for(var e=this._getRegisterMode().action,n=!1,i=0;i<e.length;i++)if(e[i].indexOf("mousedown")>=0||e[i].indexOf("touchstart")>=0){n=!0;break}if(n){var o=this.getMap();this._mapDraggable=o.options.draggable,o.config({draggable:!1})}},n._restoreMapCfg=function(){var t=this.getMap();t.config({doubleClickZoom:this._mapDoubleClickZoom}),h(this._mapDraggable)||t.config("draggable",this._mapDraggable),delete this._mapDraggable,delete this._mapDoubleClickZoom},n._loadResources=function(){var t=Eo(this.getSymbol());t.length>0&&this._drawToolLayer.getRenderer().loadResources(t)},n._getProjection=function(){return this._map.getProjection()},n._getRegisterMode=function(){var t=this.getMode(),n=e.getRegisterMode(t);if(!n)throw new Error(t+" is not a valid mode of DrawTool.");return n},n.getEvents=function(){var t=this._getRegisterMode().action,e={};if(Array.isArray(t)){for(var n=0;n<t.length;n++)e[t[n]]=this._events[t[n]];return e}return null},n._mouseDownHandler=function(t){(null==t?void 0:t.coordinate)&&this._createGeometry(t)},n._mouseUpHandler=function(t){(null==t?void 0:t.coordinate)&&this.endDraw(t)},n._clickHandler=function(t){if(null==t?void 0:t.coordinate){if(!this.options.interactive)return this;t.enableAltitude=this.options.enableAltitude;var e=this.getMap(),n=this._getRegisterMode();if(this._clickCoords&&this._clickCoords.length){var i=this._clickCoords.length,o=e._pointToPrj(t.point2d);if(this._clickCoords[i-1].equals(o))return}if(this._geometry){var s=e._pointToPrj(t.point2d);h(this._historyPointer)||(this._clickCoords=this._clickCoords.slice(0,this._historyPointer));var a=this._geometry.snapTo;if(a&&A(a)){var l=this._getSnapResult(a,t.containerPoint);if(s=l.prjCoord,this._clickCoords=this._clickCoords.concat(l.effectedVertex),this._clickCoords[this._clickCoords.length-1].equals(s))return}if(this._clickCoords.push(s),this._historyPointer=this._clickCoords.length,t.drawTool=this,n.update(e.getProjection(),this._clickCoords,this._geometry,t),"point"===this.getMode())return void this.endDraw(t);this._fireEvent(this._clickCoords.length<=1?"drawstart":"drawvertex",t),n.clickLimit&&n.clickLimit===this._historyPointer&&this.endDraw(t)}else this._createGeometry(t)}},n._createGeometry=function(t){var e=this.getMode(),n=this.getMap(),i=this._getRegisterMode(),o=n._pointToPrj(t.point2d),s=this.getSymbol();if(!this._geometry){this._fireEvent("drawprepare",t),this._clickCoords=[o],t.drawTool=this,this._geometry=i.create(this.getMap().getProjection(),this._clickCoords,t),s&&"point"!==e?this._geometry.setSymbol(s):this.options.hasOwnProperty("symbol")&&this._geometry.setSymbol(this.options.symbol),this._addGeometryToStage(this._geometry),this._fireEvent("drawstart",t);var a=this._geometry.snapTo;if(a&&A(a)){var l=this._getSnapResult(a,t.containerPoint),h=this.getMap();if(h&&l)this._clickCoords=[l.prjCoord],i.update(h.getProjection(),this._clickCoords,this._geometry,t)}}"point"===e&&"mousemove"!==t.type&&this.endDraw(t)},n._mouseMoveHandler=function(t){if(null==t?void 0:t.coordinate){if(!this.options.interactive)return this;t.enableAltitude=this.options.enableAltitude;var e=this.getMap();if(e&&!e.isInteracting())if("point"!==this.getMode()||this._geometry){if(this._geometry){var n=this._getMouseContainerPoint(t);if(this._isValidContainerPoint(n)){var i=e._pointToPrj(t.point2d),o=[],s=this._geometry.snapTo;if(s&&A(s)){var a=this._getSnapResult(s,n);i=a.prjCoord,o=a.effectedVertex}var l=e.getProjection();t.drawTool=this;var h=this._getRegisterMode();if(this._shouldRecordHistory(h.action)){var c=this._clickCoords.slice(0,this._historyPointer);if(c&&c.length>0&&i.equals(c[c.length-1]))return;h.update(l,c.concat(o,[i]),this._geometry,t)}else h.update(l,i,this._geometry,t);this._fireEvent("mousemove",t)}}}else this._createGeometry(t)}},n._doubleClickHandler=function(t){if(null==t?void 0:t.coordinate){if(!this.options.interactive)return this;if(t.enableAltitude=this.options.enableAltitude,this._geometry){var e=this._getMouseContainerPoint(t);if(this._isValidContainerPoint(e)){var n=this._getRegisterMode(),i=this._clickCoords;if(i&&!(i.length<2)){var o=this.getMode();if(!(o&&o.indexOf("polygon")>-1&&i.length<3)){for(var s=this.getMap().getProjection(),a=[i[0]],l=1,h=i.length;l<h;l++)i[l].x===i[l-1].x&&i[l].y===i[l-1].y||a.push(i[l]);a.length<2||this._geometry&&this._geometry instanceof od&&a.length<3||(t.drawTool=this,n.update(s,a,this._geometry,t),this.endDraw(t))}}}}}},n._addGeometryToStage=function(t){this._getDrawLayer().addGeometry(t)},n.endDraw=function(t){if(!this._geometry||this._ending)return this;this._ending=!0;var e=this._geometry;return this._clearStage(),t=t||{},this._geometry=e,t.ignoreEndEvent||this._fireEvent("drawend",t),delete this._geometry,this.options.once&&this.disable(),delete this._ending,delete this._historyPointer,this._vertexes&&(this._vertexes=[]),this},n._clearStage=function(){this._getDrawLayer().clear(),delete this._geometry,delete this._clickCoords},n._getMouseContainerPoint=function(t){var e=this._getRegisterMode().action;return(e[0].indexOf("mousedown")>=0||e[0].indexOf("touchstart")>=0)&&zi(t.domEvent),t.containerPoint},n._isValidContainerPoint=function(t){var e=this._map.getSize();return!(t.x<0||t.y<0)&&!(t.x>e.width||t.y>e.height)},n._getSnapResult=function(t,e){var n=this.getMap(),i=[];if(this.options.edgeAutoComplete){i.push(n.prjToContainerPoint(this._clickCoords[(this._historyPointer||1)-1]));var o=this._clickCoords[(this._historyPointer||1)-2];o&&i.push(n.prjToContainerPoint(o))}var s=t(e,i),a=n._containerPointToPrj(e=(s.effectedVertex?s.point:s)||e);return s.effectedVertex&&(s.effectedVertex=s.effectedVertex.map((function(t){return n._containerPointToPrj(t)}))),{prjCoord:a,effectedVertex:s.effectedVertex||[]}},n._getDrawLayer=function(){var t=Fn+"drawtool",e=this._map.getLayer(t);return e||(e=new Zd(t,{enableSimplify:!1,enableAltitude:this.options.enableAltitude,zIndex:this.options.zIndex}),this._map.addLayer(e)),this._pushLayers(e),e},n._fireEvent=function(t,e){e||(e={}),e=l({},e),this._geometry&&(e.geometry=this._getRegisterMode().generate(this._geometry,{drawTool:this}),e.tempGeometry=this._geometry),Xd.prototype._fireEvent.call(this,t,e)},n._pushLayers=function(t){var e=this;return t?(Array.isArray(t)||(t=[t]),this._layers=this._layers||[],t.forEach((function(t){-1===e._layers.indexOf(t)&&e._layers.push(t)})),this):this},n._outLayers=function(t){var e=this;return t?(Array.isArray(t)||(t=[t]),this._layers=this._layers||[],t.forEach((function(t){for(var n=0,i=e._layers.length;n<i;n++)if(t===e._layers[n]){e._layers.splice(n,1);break}})),this):this},n.setLayerZIndex=function(t){return c(t)?(this.options.zIndex=t,this._layers=this._layers||[],this._layers.forEach((function(e){e&&e.setZIndex&&e.setZIndex(t)})),this):this},n.addCoordinate=function(t){if(!this.isEnabled())return this;var e=this.getMap();if(!e)return this;t=new gh(t);var n=e._parseEventFromCoord(t);return this._clickHandler(n),this},n.getTempGeometry=function(){return this._geometry},e}(Xd);Yd.mergeOptions(Jd);var Kd=function(t){function e(e){var n;return(n=t.call(this,e)||this).drawTool=new Yd({mode:"boxZoom",ignoreMouseleave:!1}),n}he(e,t);var n=e.prototype;return n.addHooks=function(){this.target.on("_mousedown",this._onMouseDown,this)},n.removeHooks=function(){this.target.off("_mousedown",this._onMouseDown,this),this.drawTool.isEnabled()&&this.drawTool.remove()},n._onMouseDown=function(t){this.target.options.boxZoom&&t.domEvent.shiftKey&&this.drawTool.setSymbol(this.target.options.boxZoomSymbol).on("drawend",this._boxZoom,this).addTo(this.target)},n._boxZoom=function(t){var e=this.target;this.drawTool.remove();var n=t.geometry,i=n.getCenter(),o=n.getSymbol(),s=new Ph(i,e.locateByPoint(i,o.markerWidth,o.markerHeight),e.getProjection()),a=e.getFitZoom(s);e._animateTo({center:s.getCenter(),zoom:a})},e}(Jl);Lf.mergeOptions({boxZoom:!0,boxZoomSymbol:{markerType:"rectangle",markerLineWidth:3,markerLineColor:"#1bbc9b",markerLineDasharray:[10,5],markerFillOpacity:.1,markerFill:"#1bbc9b",markerWidth:1,markerHeight:1}}),Lf.addOnLoadHook("addHandler","boxZoom",Kd);var $d=30,tg=function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n.addHooks=function(){this.target&&this.target.on("_mousemove",this._onMouseMove,this)},n.removeHooks=function(){this.target&&this.target.off("_mousemove",this._onMouseMove,this)},n._onMouseMove=function(t){var e=this.target;if(e.options.autoPanAtEdge){var{containerPoint:n}=t,i=e.getContainerExtent();if(i){var o,{x:s,y:a}=n,{xmax:l,ymax:h}=i;s<$d&&(o=[Math.abs(s-$d),0]),a<$d&&(o=[0,Math.abs(a-$d)]),s+$d>l&&(o=[-Math.abs(s+$d-l),0]),a+$d>h&&(o=[0,-Math.abs(a+$d-h)]),o&&e.panBy(o,{duration:1})}}},e}(Jl);function eg(t,e){var n=t.bearing,i=e.getBearing();return!(i>=0&&n>180)&&!(i<=0&&n<-180)}function ng(t,e){var n=t.bearing,i=e.getBearing();i>=0&&n<0&&(t.bearing=180-Math.abs(n)+180),i<=0&&n>0&&(t.bearing=-180-(180-Math.abs(n))),i>=0&&n>0&&(t.bearing=-180-(180-Math.abs(n))),i<=0&&n<0&&(t.bearing=180-Math.abs(n)+180)}function ig(t,e,n){return t*(1-n)+e*n}Lf.mergeOptions({autoPanAtEdge:!1}),Lf.addOnLoadHook("addHandler","autoPanAtEdge",tg),Lf.include({animateTo:function(t,e={},n){var i=this;(t=l({},this.getView(),t)).bearing=t.bearing%360,A(e)&&(n=e,e={}),e.counterclockwise&&ng(t,this),eg(t,this)&&this._validateView(t);var o=this.getProjection(),s=this.getView(),a={},c=!0;for(var u in t)if(w(t,u)&&!h(t[u])&&("prjCenter"===u||!h(s[u])))if(c=!1,"center"===u){var f=new gh(s[u]),g=new gh(t[u]);f.equals(g)||(a.center=[f,g])}else if("prjCenter"===u){var m=new gh(this._getPrjCenter()),T=new gh(t[u]);m.equals(T)||(a.prjCenter=[m,T])}else s[u]!==t[u]&&"around"!==u&&(a[u]=[s[u],t[u]]);if(c)return null;this._animPlayer&&(this._isInternalAnimation?"running"===this._animPlayer.playState&&(this._animPlayer.pause(),this._prevAnimPlayer=this._animPlayer):(delete this._prevAnimPlayer,this._stopAnim(this._animPlayer)));var M=t.around||null,C=this._getRenderer(),P=this._animPlayer=Yf.animate(a,{easing:e.easing||"out",duration:e.duration||this.options.zoomAnimationDuration,framer:function(t){C.callInNextFrame(t)},repeat:e.repeat},(function(t){if(i.isRemoved())P.finish();else{if("running"===P.playState){if(t.styles.center)i._setPrjCenter(o.project(t.styles.center)),i.onMoving(i._parseEventFromCoord(i.getCenter()));else if(t.styles.prjCenter){i._setPrjCenter(t.styles.prjCenter),i.onMoving(i._parseEventFromCoord(i.getCenter()))}h(t.styles.zoom)||i.onZooming(t.styles.zoom,M),h(t.styles.pitch)||i._setPitch(t.styles.pitch),h(t.styles.bearing)||i._setBearing(t.styles.bearing),i._fireEvent("animating")}else"paused"===P.playState&&P!==i._mapAnimPlayer||(P._interupted||(a.center?i._setPrjCenter(o.project(a.center[1])):a.prjCenter&&i._setPrjCenter(a.prjCenter[1]),h(a.pitch)||i._setPitch(a.pitch[1]),h(a.bearing)||i._setBearing(a.bearing[1])),i._endAnim(P,a,M,e));n&&n(t)}}),this);return this._startAnim(a,M),P},_animateTo:function(t,e={},n){return this._mapAnimPlayer&&this._stopAnim(this._mapAnimPlayer),this._isInternalAnimation=!0,this._mapAnimPlayer=this.animateTo(t,e,n),delete this._isInternalAnimation,this._mapAnimPlayer},flyTo:function(t,e={},n){var i=this;(t=l({},this.getView(),t)).bearing=t.bearing%360,e.counterclockwise&&ng(t,this),eg(t,this)&&this._validateView(t),this._animPlayer&&(this._isInternalAnimation?"running"===this._animPlayer.playState&&(this._animPlayer.pause(),this._prevAnimPlayer=this._animPlayer):(delete this._prevAnimPlayer,this._stopAnim(this._animPlayer))),A(e)&&(n=e,e={}),e=l({curve:1.42},e);var o=this;function s(t,e){return o.getResolution(e)/o.getResolution(t)}var a=t.around||new _e(this.width/2,this.height/2),h=this.getMinZoom(),c=this.getMaxZoom(),u=this.getProjection(),f=this.getView(),g=f.zoom,m=f.bearing,w=f.pitch,T="zoom"in t?qe(+t.zoom,h,c):g,M="bearing"in t?+t.bearing:m,C="pitch"in t?+t.pitch:w,P=u.project(t.center&&new gh(t.center)||this.getCenter()),I=s(T,g),O=u.project(this.getCenter()),E=P.sub(O),D=e.curve,N=Math.max(this.width,this.height),H=N/I,U=E.mag();if("minZoom"in e){var W=qe(Math.min(e.minZoom,g,T),h,c),q=N/s(W,g);D=Math.sqrt(q/U*2)}var X=D*D;function J(t){var e=(H*H-N*N+(t?-1:1)*X*X*U*U)/(2*(t?H:N)*X*U);return Math.log(Math.sqrt(e*e+1)-e)}function Q(t){return(Math.exp(t)-Math.exp(-t))/2}function Y(t){return(Math.exp(t)+Math.exp(-t))/2}var K=J(0),$=function(t){return Y(K)/Y(K+D*t)},tt=function(t){return N*((Y(K)*function(t){return Q(t)/Y(t)}(K+D*t)-Q(K))/X)/U},et=(J(1)-K)/D;if(Math.abs(U)<1e-6||!isFinite(et)){if(Math.abs(N-H)<1e-6)return this.animateTo(t,e,n);var nt=H<N?-1:1;et=Math.abs(Math.log(H/N))/D,tt=function(){return 0},$=function(t){return Math.exp(nt*D*t)}}var it=this._getRenderer(),rt=this._animPlayer=Yf.animate({k:[0,1]},{easing:e.easing||"out",duration:e.duration||8,framer:function(t){it.callInNextFrame(t)}},(function(o){if(i.isRemoved())rt.finish();else{var s=o.styles.k,l=s*et,h=1/$(l),c={};if(t.center){var u=1===s?P:O.add(E.multi(tt(l)));c.prjCenter=[P,u]}if(g!==T){var f=1===s?T:i.getZoomForScale(h,g,!0);c.zoom=[g,f]}if(w!==C){var A=ig(w,C,s);c.pitch=[C,A]}if(m!==M){var I=ig(m,M,s);c.bearing=[M,I]}if("running"===rt.playState){if(c.prjCenter)i._setPrjCenter(c.prjCenter[1]),i.onMoving(i._parseEventFromCoord(i.getCenter()));c.zoom&&i.onZooming(c.zoom[1],a),c.pitch&&i._setPitch(c.pitch[1]),c.bearing&&i._setBearing(c.bearing[1]),i._fireEvent("animating")}else"paused"===rt.playState&&rt!==i._mapAnimPlayer||(rt._interupted||(c.prjCenter&&i._setPrjCenter(c.prjCenter[1]),c.pitch&&i._setPitch(c.pitch[1]),c.bearing&&i._setBearing(c.bearing[1])),i._endAnim(rt,c,a,e));n&&n(o)}}),{});return this._startAnim({center:t.center,zoom:t.zoom!==g,pitch:C!==w,bearing:M!==m},a),this},isAnimating:function(){return!!this._animPlayer},isRotating:function(){return this.isDragRotating()||!!this._animRotating},_endAnim:function(t,e,n,i){delete this._animRotating;var o,s=t._interupted?"animateinterrupted":"animateend";if(t===this._animPlayer&&delete this._animPlayer,t===this._mapAnimPlayer&&delete this._mapAnimPlayer,e.center)o=t._interupted?this.getCenter():e.center[1],this.onMoveEnd(this._parseEventFromCoord(o));else if(e.prjCenter){var a;a=t._interupted?this._getPrjCenter():e.prjCenter[1];var l=this._parseEventFromCoord(this.getProjection().unproject(a));l.point2d=this._prjToPoint(a),this.onMoveEnd(l)}h(e.zoom)||(t._interupted?this.onZoomEnd(this.getZoom()):i.wheelZoom?this.onZooming(e.zoom[1],n):this.onZoomEnd(e.zoom[1])),s&&this._fireEvent(s),h(e.pitch)||this.getPitch()||this.getRenderer().setToRedraw(),i.wheelZoom||this._resumePrev(t)},_startAnim:function(t,e){this._animPlayer&&((t.center||t.prjCenter)&&this.onMoveStart(),t.zoom&&!this.isZooming()&&this.onZoomStart(t.zoom[1],e),(t.pitch||t.bearing)&&(this._animRotating=!0),this._fireEvent("animatestart"),this._animPlayer.play())},_stopAnim:function(t){t&&(delete this._animRotating,"finished"!==t.playState&&(t._interupted=!0,t.cancel()),t===this._animPlayer&&delete this._animPlayer,t===this._mapAnimPlayer&&delete this._mapAnimPlayer)},_resumePrev:function(t){if(this._prevAnimPlayer){var e=this._prevAnimPlayer;"paused"!==e.playState&&delete this._prevAnimPlayer,t!==e&&(this._animPlayer=e,e.play())}}});var rg=[60,120];function og(t){t.stopPropagation(),t.preventDefault()}var sg=["dragstart","dragenter","dragend","dragleave","dragover"].join(" ").toString(),ag="mousedown mouseup mouseover mouseout mouseenter mouseleave mousemove click dblclick contextmenu keypress touchstart touchmove touchend drop ";function lg(t,e,n){var i=e[0],o=e[1],s=e[2],a=1/(n[3]*i+n[7]*o+n[11]*s+n[15]);return t[0]=(n[0]*i+n[4]*o+n[8]*s+n[12])*a,t[1]=(n[1]*i+n[5]*o+n[9]*s+n[13])*a,t[2]=(n[2]*i+n[6]*o+n[10]*s+n[14])*a,t}Lf.include({_registerDomEvents:function(){var t=this._panels.mapWrapper||this._containerDOM;Ri(t,ag,this._handleDOMEvent,this),Ri(t,sg,og,this)},_removeDomEvents:function(){var t=this._panels.mapWrapper||this._containerDOM;Di(t,ag,this._handleDOMEvent),Di(t,sg,og)},_handleDOMEvent:function(t){if(t&&"drop"===t.type){t.stopPropagation(),t.preventDefault();var e=this._parseEvent(t,t.type);return e=l({},e,{dataTransfer:t.dataTransfer}),void this._fireEvent(t.type,e)}var n=this.options.clickTimeThreshold,i=t.type;if(!ar(i)||s.isTest||!this.options.mousemoveThrottleEnable||!lr(this,this.options.mousemoveThrottleTime)){var o="mousedown"===i||"touchstart"===i&&(!t.touches||1===t.touches.length);o&&(this._domMouseDownTime=a(),this._domMouseDownView=this.getView());var h="contextmenu"===i&&function(t){if(!t._domMouseDownView)return!0;var e=t.getView(),n=t._domMouseDownView;return e.bearing!==n.bearing||e.pitch!==n.pitch}(this);if("contextmenu"===i){Hi(t);var c=this._domMouseDownTime;a()-c<=n&&!h&&this._fireDOMEvent(this,t,"dom:"+t.type)}else this._fireDOMEvent(this,t,"dom:"+t.type);if(!this._ignoreEvent(t)){var u,f=!1;if(o)this._mouseDownTime=a();else if("click"===i||"touchend"===i||"contextmenu"===i){if(!this._mouseDownTime)return;var g=this._mouseDownTime;if(delete this._mouseDownTime,a()-g>n){if("click"===i||"contextmenu"===i)return}else if("contextmenu"===i){if(h)return}else"touchend"===i&&(f=!0)}f&&(this._clickTime&&a()-this._clickTime<=n?(delete this._clickTime,u="dblclick",this._fireDOMEvent(this,t,"dom:dblclick")):(this._clickTime=a(),u="click",this._fireDOMEvent(this,t,"dom:click"))),this._ignoreEvent(t)||(this._fireDOMEvent(this,t,i),u&&this._fireDOMEvent(this,t,u))}}},_ignoreEvent:function(t){if(!t||!this._panels.control)return!1;var e,n=t.srcElement||t.target;if(n)for(;n&&n!==this._containerDOM;){if(n.className&&n.className.indexOf&&(n.className.indexOf("ispace-control")>=0||n.className.indexOf("ispace-ui")>=0&&e&&!e.eventsPropagation))return!0;e=n,n=n.parentNode}return!1},_isEventOutMap:function(t){var e=Zi(this._getActualEvent(t),this._containerDOM);return this._isContainerPointOutOfMap(e)},_isContainerPointOutOfMap:function(){var t=[0,0,0],e=[0,0,0],n=new ua(t,e),i=[0,0,0];return function(o){var s=this.getPitch();if(s>rg[0]&&s<rg[1]){if(this.getContainerPointRay(t,e,o,0,.5),n.setFromTo(t,e),!n.intersectGround(i))return!0;if(n.distanceToGround()<=0)return!0}return!1}}(),_wrapTerrainData:function(t){this.options.queryTerrainInMapEvents&&t.containerPoint&&!t.terrain&&(t.terrain=this._queryTerrainInfo(t.containerPoint))},_parseEvent:function(t,e){if(!t)return null;var n={domEvent:t};if("keypress"!==e){var i=this._getActualEvent(t);if(i&&void 0!==i.clientX){var o=Zi(i,this._containerDOM);n=l(n,{containerPoint:o,viewPoint:this.containerPointToViewPoint(o)}),this._isContainerPointOutOfMap(o)||(n=l(n,{coordinate:this.containerPointToCoord(o),point2d:this._containerPointToPoint(o)}))}}return this._wrapTerrainData(n),n},_parseEventFromCoord:function(t){var e=this.coordToContainerPoint(t);return{coordinate:t,containerPoint:e,viewPoint:this.containerPointToViewPoint(e),point2d:this.coordToPoint(t)}},_getActualEvent:function(t){return t.touches&&t.touches.length>0?t.touches[0]:t.changedTouches&&t.changedTouches.length>0?t.changedTouches[0]:t},_fireDOMEvent:function(t,e,n){var i=this;if(!this.isRemoved()){var o=this._parseEvent(e,n);if(o.coordinate||"keypress"===n||-1!==n.indexOf("dom:")){this._wrapTerrainData(o);var s=function(){i._fireEvent(o.domEvent&&o.domEvent._cancelBubble?"_"+n:n,o)};ar(n)?this.options.mousemoveThrottleEnable?this.getRenderer().callInNextFrame((function(){s()})):s():this._fireEvent(n,o)}}},_getEventParams:function(t){var e=this,n={domEvent:t},i=t.touches&&t.touches.length>0?t.touches[0]:t.changedTouches&&t.changedTouches.length>0?t.changedTouches[0]:t;if(i){var o=Zi(i,e.getContainer());n.coordinate=e.containerPointToCoordinate(o),n.containerPoint=o,n.viewPoint=e.containerPointToViewPoint(o),n.point2d=e._containerPointToPoint(o)}return this._wrapTerrainData(n),n}}),Lf.addOnLoadHook("_registerDomEvents"),Lf.mergeOptions({queryTerrainInMapEvents:!0}),Lf.include({isFullScreen:function(){var t=document;return!!(t.webkitIsFullScreen||t.mozFullScreen||t.msFullscreenElement||t.fullscreenElement)},requestFullScreen:function(t){return this._fireEvent("fullscreenstart"),this._requestFullScreen(t||this._containerDOM),this._fireEvent("fullscreenend"),this},cancelFullScreen:function(){return this._cancelFullScreen(),this._fireEvent("cancelfullscreen"),this},_requestFullScreen:function(t){if(t.requestFullscreen)t.requestFullscreen();else if(t.mozRequestFullScreen)t.mozRequestFullScreen();else if(t.webkitRequestFullScreen)t.webkitRequestFullScreen();else if(t.msRequestFullScreen)t.msRequestFullScreen();else{var e="fullscreen=1,status=no,resizable=yes,top=0,left=0,scrollbars=no,titlebar=no,menubar=no,location=no,toolbar=no,z-look=yes,width="+(screen.availWidth-8)+",height="+(screen.availHeight-45);null!==window.open(location.href,"_blank",e)&&(window.opener=null,window.close())}},_cancelFullScreen:function(){var t=document;if(document.exitFullscreen)document.exitFullscreen();else if(t.mozCancelFullScreen)t.mozCancelFullScreen();else if(t.webkitCancelFullScreen)t.webkitCancelFullScreen();else{null!==window.open(location.href,"_blank","fullscreen=no,status=yes,resizable=yes,scrollbars=no,titlebar=no,menubar=yes,location=yes,toolbar=yes,z-look=yes")&&(window.opener=null,window.close())}}}),Lf.include({panTo:function(t,e={},n){if(!t)return this;if(A(e)&&(n=e,e={}),t=new gh(t),void 0===e.animation||e.animation){var i=this.getProjection().project(t);return this._panAnimation(i,e.duration,n)}return this.setCenter(t),this},_panTo:function(t,e={}){return void 0===e.animation||e.animation?this._panAnimation(t,e.duration):(this.onMoveStart(),this._setPrjCenter(t),this.onMoveEnd(this._parseEventFromCoord(this.getCenter())),this)},panBy:function(t,e={},n){if(!t)return this;if(A(e)&&(n=e,e={}),t=new _e(t),this.getContainerExtent().ymin>0&&t.y>30){var i=t.y;t.y=30,t.x=30*t.x/i,console.warn("offset is limited to panBy when pitch is above maxPitch")}if(void 0===e.animation||e.animation){t=t.multi(-1);var o=this._containerPointToPrj(new _e(this.width/2+t.x,this.height/2+t.y));this._panAnimation(o,e.duration,n)}else{this.onMoveStart(),this._offsetCenterByPixel(t);var s=this.containerPointToCoord(new _e(this.width/2,this.height/2));this.onMoveEnd(this._parseEventFromCoord(s))}return this},_panAnimation:function(t,e,n){return this._animateTo({prjCenter:t},{duration:e||this.options.panAnimationDuration},n)}}),Lf.include({computeLength:function(t,e){if(!this.getProjection())return null;var n=new gh(t),i=new gh(e);return n.equals(i)?0:this.getProjection().measureLength(n,i)},computeGeometryLength:function(t){return t._computeGeodesicLength(this.getProjection())},computeGeometryArea:function(t){return t._computeGeodesicArea(this.getProjection())},identify:function(t,e){var n=new gh((t=t||{}).coordinate);return this._identify(t,e,(function(e){return e.identify(n,t)}))},identifyAtPoint:function(t,e){var n=t.includeInternals,i=t.tolerance,o=new _e((t=t||{}).containerPoint),s=this.containerPointToCoord(o);return this._identify(t,e,(function(e){var o,a=t.containerPoint;if(n&&!h(e.options.geometryEventTolerance)&&(t.tolerance=t.tolerance||0,t.tolerance+=e.options.geometryEventTolerance),e._hasGeoListeners&&n&&t.eventTypes.indexOf("mousemove")>=0&&!e._hasGeoListeners(t.eventTypes))return[];(o=e.identifyAtPoint?e.identifyAtPoint(a,t):s&&e.identify?e.identify(s,t):[],n&&(h(i)?delete t.tolerance:t.tolerance=i),o&&o.length)||(e.fire("identifyempty",t),e.getLayers&&A(e.getLayers)&&(e.getLayers()||[]).filter((function(t){return t})).forEach((function(e){e.fire("identifyempty",t)})));return o}))},_identify:function(t,e,n){var i=t.layers;if(!Je(i))return this;for(var o=t.eventTypes,s=[],a=0,l=i.length;a<l;a++)g(i[a])?s.push(this.getLayer(i[a])):s.push(i[a]);o&&(s=s.filter((function(t){return!t._hasGeoListeners||t._hasGeoListeners(o)})));for(var c=[],u=s.length-1;u>=0&&!(t.count&&c.length>=t.count);u--){var f=s[u];if(f&&f.getMap()&&(t.includeInvisible||f.isVisible())&&(t.includeInternals||!(f.getId().indexOf(Fn)>=0))){var A=n(f),m=f.getId();if(A)if(Array.isArray(A)){for(var w=0;w<A.length;w++)A[w]&&!A[w].getLayer&&h(A[w].layer)&&(A[w].layer=m);ke(c,A)}else!A.getLayer&&h(A.layer)&&(A.layer=m),c.push(A)}}return e.call(this,c),this}}),Lf.include({_zoom:function(t,e){this.options.zoomable&&!this.isZooming()&&(e=this._checkZoomOrigin(e),t=this._checkZoom(t),this.onZoomStart(t,e),this._frameZoom=this.getZoom(),this.onZoomEnd(t,e))},_zoomAnimation:function(t,e,n){this.options.zoomable&&!this.isZooming()&&(t=this._checkZoom(t),this.getZoom()!==t&&(e=this._checkZoomOrigin(e),this._startZoomAnim(t,e,n)))},_checkZoomOrigin:function(t){return(!t||this.options.zoomInCenter||this._isContainerPointOutOfMap(t))&&(t=new _e(this.width/2,this.height/2)),this.options.zoomOrigin&&(t=new _e(this.options.zoomOrigin)),t},_startZoomAnim:function(t,e,n){h(n)&&(n=1);var i=this._getResolution(this._startZoomVal)/this._getResolution(t),o=this.options.zoomAnimationDuration*Math.abs(i-n)/Math.abs(i-1);this._frameZoom=this._startZoomVal,this._animateTo({zoom:t,around:e},{continueOnViewChanged:!0,duration:o})},onZoomStart:function(t,e){this.options.zoomable&&!this.isZooming()&&(this._mapAnimPlayer&&this._stopAnim(this._mapAnimPlayer),delete this.cameraZenithDistance,this._zooming=!0,this._startZoomVal=this.getZoom(),this._startZoomCoord=e&&this._containerPointToPrj(e),this._fireEvent("zoomstart",{from:this._startZoomVal,to:t}))},onZooming:function(t,e,n){if(this.options.zoomable&&this._frameZoom!==t){h(n)&&(n=1),this._zoomTo(t,e);var i=this.getResolution(t),o=this.getResolution(this._startZoomVal)/i/n,s=this._startZoomCoord&&this.prjToContainerPoint(this._startZoomCoord,this._startZoomVal),a=this.getViewPoint();if(!this.isRotating()&&s&&e&&!s.equals(e)&&1!==o){var l=this.getPitch(),c=s._sub(e)._multi(1/(1-o));l&&(c.y/=Math.cos(l*Math.PI/180)),e=e.add(c)}var u=e&&e.x||this.width/2,f=e&&e.y||this.height/2,g={view:[o,0,0,o,(u-a.x)*(1-o),(f-a.y)*(1-o)]},A=this.getDevicePixelRatio();g.container=[o,0,0,o,u*A*(1-o),f*A*(1-o)],this._fireEvent("zooming",{from:this._startZoomVal,to:t,origin:new _e(u,f),matrix:g}),this._frameZoom=t}},onZoomEnd:function(t,e){if(this.options.zoomable){var n=this._startZoomVal;this._zoomTo(t,e),this._zooming=!1,this._getRenderer().onZoomEnd(),this._suppressRecenter||this._recenterOnTerrain(),this._fireEvent("zoomend",{from:n,to:t}),this._verifyExtent(this._getPrjCenter())||this.options.limitExtentOnMaxExtent||this._panTo(this._prjMaxExtent.getCenter())}},_zoomTo:function(t,e){if(this._zoomLevel=t,this._calcMatrices(),e&&this._startZoomCoord){var n=this._containerPointToPoint(e)._sub(this._prjToPoint(this._getPrjCenter()));this._setPrjCoordAtOffsetToCenter(this._startZoomCoord,n)}},_checkZoom:function(t){var e=this.getMaxZoom(),n=this.getMinZoom();return t<n&&(t=n),t>e&&(t=e),t}});var hg,cg=Math.PI/180,ug=new gh(0,0),fg=new _e(0,0),dg=[0,-1,0],gg=[];function pg(){return as(new Array(16))}Lf.include({getFov:function(){return this._fov||(this._fov=.6435011087932844),this._fov/cg},setFov:function(t){if(this.isZooming())return this;if(t=Math.max(.01,Math.min(60,t)),this._fov===t)return this;var e=this.getFov();return this._fov=t*cg,this._calcMatrices(),this._renderLayers(),this._fireEvent("fovchange",{from:e,to:this.getFov()}),this},getBearing:function(){return this._angle?-this._angle/cg:0},setBearing:function(t){var e={bearing:t};return this._validateView(e),this._mapAnimPlayer&&this._stopAnim(this._mapAnimPlayer),this._setBearing(e.bearing)},_setBearing:function(t){if(Gt.ie9)throw new Error("map can't rotate in IE9.");var e=-We(t,-180,180)*cg;if(this._angle===e)return this;var n=this.getBearing();return this._fireEvent("rotatestart",{from:n,to:e}),this._angle=e,this._calcMatrices(),this._renderLayers(),this._fireEvent("rotate",{from:n,to:e}),this._fireEvent("rotateend",{from:n,to:e}),this},getPitch:function(){return this._pitch?this._pitch/Math.PI*180:0},setPitch:function(t){var e={pitch:t};return this._validateView(e),this._mapAnimPlayer&&this._stopAnim(this._mapAnimPlayer),this._setPitch(e.pitch)},_setPitch:function(t){if(Gt.ie9)throw new Error("map can't tilt in IE9.");var e=qe(t,0,this.options.maxPitch)*cg;if(this._pitch===e)return this;var n=this.getPitch();return this._fireEvent("pitchstart",{from:n,to:e}),this._pitch=e,this._calcMatrices(),this._renderLayers(),this._fireEvent("pitch",{from:n,to:e}),this._fireEvent("pitchend",{from:n,to:e}),this},setCameraMovements:function(t,e){var n=this;if(!Array.isArray(t)||!t.length)return this;if(t.forEach((function(t){n._validateView(t)})),this.setView({center:t[0].center,zoom:t[0].zoom,pitch:t[0].pitch,bearing:t[0].bearing}),1===t.length)return this;var i=1,o=function(s){if("finished"===s.state.playState){++i===t.length-1&&(o=null);var a=t[i];a.duration=a.timestamp-t[i-1].timestamp,e&&e.autoRotate&&(a.bearing=function(t,e){var n=M(t[0]),i=M(e[0]),o=M(t[1]),s=M(e[1]),a=Math.sin(i-n)*Math.cos(s),l=Math.cos(o)*Math.sin(s)-Math.sin(o)*Math.cos(s)*Math.cos(i-n);return C(Math.atan2(a,l))}(t[i-1].center,a.center)),n._setCameraMovement(a,o)}};2===t.length&&(o=null);var s=this.getBearing();this._setCameraMovement(Object.assign({bearing:s,duration:t[i].timestamp-t[i-1].timestamp},t[i]),o);return{play:function(){n._animPlayer.play()},pause:function(){n._animPlayer.pause()},cancel:function(){n._animPlayer.cancel()},finish:function(){n._animPlayer.finish()},reverse:function(){n._animPlayer.reverse()}}},_setCameraMovement:function(t,e){this.animateTo({zoom:t.zoom,center:t.center,pitch:t.pitch,bearing:t.bearing},{duration:t.duration,easing:"out"},e)},lookAt:function(t){var{coordinates:e,bearing:n,pitch:i,distance:o}=t;if(e=t.center||e,Array.isArray(e)&&(e=new gh(e)),!e.z&&!o)return this.setCenter(e);var s=this.getGLRes();n=h(n)?this.getBearing():n;var a=(i=h(i)?this.getPitch():i)*cg,l=n*cg;if(o){var c=o*Math.sin(a),u=Math.sin(a)*o,f=u*Math.sin(l),g=u*Math.cos(l);c*=this._meterToGLPoint,u=this.distanceToPointAtRes(f,g,s).mag(),o=Math.sqrt(u*u+c*c)}var A=this.coordToPointAtRes(e,s);A.z=0,e.z&&(A.z=e.z*this._meterToGLPoint);var m=o||this.cameraToGroundDistance||this.cameraToCenterDistance,w=Math.sin(a)*m,T=m*Math.cos(a),M=A.x-w*Math.sin(l),C=A.y-w*Math.cos(l),P=new _e([M,C,T+A.z]),I=this.pointAtResToCoord(P,s);return I.z=P.z/this._meterToGLPoint,this.setCameraOrientation({position:I.toArray(),bearing:n,pitch:i})},setCameraOrientation:function(t){var{position:e}=t;this._validateView(t);var{pitch:n,bearing:i}=t;n=n||0,i=i||0;var{zoom:o,cameraToGroundDistance:s}=this.getFitZoomForCamera(e,n),a=Math.sin(n*cg)*s,l=We(i,-180,180)*cg,h=this.getGLRes(),c=new gh(e[0],e[1]),u=this.coordToPointAtRes(c,h),f=new _e(0,0);f.x=u.x+a*Math.sin(l),f.y=u.y+a*Math.cos(l);var g=this._pointToPrjAtRes(f,this.getGLRes());return this._setPrjCenter(g),this.setView({bearing:i,pitch:n,zoom:o}),this},setCameraPosition:function(t){var e=this.getGLRes(),n=this.coordToPointAtRes(t,e);n.z=this.altitudeToPoint(t.z||0,e);var i=this.getCenter(),o=this.coordToPointAtRes(i,e);o.z=this.altitudeToPoint(i.z,e);var s=Ws([],n.toArray(),o.toArray());return Gs(this.cameraUp||[0,0,0],0,0,1),this._pitch=na(s,this.cameraUp),Gs(gg,s[0],s[1],0),this._angle=-na(gg,dg),this._zoomLevel=this.getFitZoomForCamera(t,this._pitch).zoom,this._calcMatrices(),this},getFitZoomForCamera:function(t,e){c(e)||(e=0);var n=Array.isArray(t)?t[2]||0:t.z||0,i=(this.centerAltitude||0)*this._meterToGLPoint,o=(n*this._meterToGLPoint-i)/Math.cos(e*cg);return{zoom:this.getFitZoomForAltitude(o+i),cameraToGroundDistance:o}},getFitZoomForAltitude:function(t){var e=t*this._getFovRatio()*2/(this.height||1)*this.getGLRes();return this.getZoomFromRes(e)},isTransforming:function(){return!!(this._pitch||this._angle||this._terrainLayer)},getFrustumAltitude:function(){return this._frustumAltitude},_calcFrustumAltitude:function(){var t=90-this.getPitch(),e=this.getFov()/2,n=this.cameraPosition?this.cameraPosition[2]:0;if(e<=t)return n;e=Math.PI*e/180;var i=new _e(this.cameraPosition).distanceTo(new _e(this.cameraLookAt)),o=n*Math.tan(2*e);return n+Math.tan(e)*(i+o)},_pointToContainerPoint:function(t,e,n=0,i){var o=this._getResolution(e);return this._pointAtResToContainerPoint(t,o,n,i)},_pointAtResToContainerPoint:function(t,e,n=0,i){i||(i=new _e(0,0)),t=this._pointAtResToPoint(t,e,i);var o,s=this.isTransforming();return s||n||(o=this._prjToPoint(this._getPrjCenter(),void 0,ug)),this._toContainerPoint(i,s,n,o),i},_pointsAtResToContainerPoints:function(t,e,n=[],i=[]){var o=this.getPitch(),s=this.getBearing(),a=e/this._getResolution();if(0===o&&0===s&&!function(t){if(c(t))return 0!==t;if(Array.isArray(t)&&t.length>0)for(var e=0,n=t.length;e<n;e++)if(c(t[e])&&0!==t[e])return!0;return!1}(n)){var{xmin:l,ymin:h,xmax:u,ymax:f}=this.get2DExtent();if(u>l&&f>h){for(var{width:g,height:A}=this.getSize(),m=(u-l)/g,w=(f-h)/A,T=0,M=t.length;T<M;T++)if(t[T]){var C=i[T];C.x=t[T].x,C.y=t[T].y,C._multi(a),C.x=(C.x-l)*m,C.y=A-(C.y-h)*w}else i[T]=null;return i}}for(var P=Array.isArray(n),I=this.isTransforming(),O=this._prjToPoint(this._getPrjCenter(),void 0,ug),E=0,D=t.length;E<D;E++)if(t[E]){var N=i[E];N.x=t[E].x,N.y=t[E].y,N._multi(a),this._toContainerPoint(N,I,P?n[E]||0:n,O)}else i[E]=null;return i},_toContainerPoint:function(){var t=[0,0,0];return function(e,n,i,o){var s=this.width/2,a=this.height/2;if(n||i){this._altitudeScale||(this._altitudeScale=this.altitudeToPoint(100,this.getGLRes())/100);var l=this._glScale;Gs(t,e.x*l,e.y*l,i*this._altitudeScale);var h=this._projIfBehindCamera(t,this.cameraPosition,this.cameraForward);lg(h,h,this.projViewMatrix),e.x=h[0]*s+s,e.y=-h[1]*a+a}else e._sub(o.x,o.y),e.set(e.x,-e.y),e._add(s,a)}}(),_projIfBehindCamera:function(){var t=new Array(3),e=new Array(3),n=new Array(3);return function(i,o,s){Ws(t,i,o);var a=Ks(s,t);return a<=0&&($s(e,s,1.01*a),Us(i,o,Ws(n,t,e))),i}}(),_containerPointToPoint:function(t,e,n,i){var o=this._getResolution(e);return this._containerPointToPointAtRes(t,o,n,i)},_containerPointToPointAtRes:function(){var t=[0,0,0],e=[0,0,0];return function(n,i,o,s){if(this.isTransforming()){this.getContainerPointRay(t,e,n);var a=t[0],l=e[0],h=t[1],c=e[1],u=t[2],f=e[2],g=s?this.altitudeToPoint(s,i)*this._glScale:0,A=u===f?g:(g-u)/(f-u),m=Ue(a,l,A),w=Ue(h,c,A);return o?(o.x=m,o.y=w):o=new _e(m,w),o._multi(1/this._glScale),this._getResolution()===i?o:this._pointToPointAtRes(o,i,o)}var T=this._prjToPointAtRes(this._getPrjCenter(),i,o),M=this._getResolution()/i;return T._add(M*(n.x-this.width/2),-(M*(n.y-this.height/2)))}}(),getContainerPointRay:function(){var t=[0,0,0],e=[0,0,0,1],n=[0,0,0,1];return function(i,o,s,a=0,l=1){var h=this.width/2||1,c=this.height/2||1;Gs(t,(s.x-h)/h,(c-s.y)/c,0),Gs(e,t[0],t[1],a),Gs(n,t[0],t[1],l),e[3]=n[3]=1,lg(i,e,this.projViewMatrixInverse),lg(o,n,this.projViewMatrixInverse)}}(),_calcMatrices:(hg=pg(),function(){delete this._mapRes,delete this._mapGlRes,delete this._mapExtent2D,delete this._mapGlExtent2D;var t=this.getSize(),e=t.width||1,n=t.height||1;this._glScale=this.getGLScale();var i=this._getCameraWorldMatrix(),o=this.getFov()*Math.PI/180,s=this._getCameraFar(o,this.getPitch());this.cameraFar=s,this.cameraNear=this.cameraCenterDistance/20;var a=this.projMatrix||pg();Yo(a,o,e/n,this.cameraNear,s),this.projMatrix=a,this.viewMatrix=os(this.viewMatrix||pg(),i),this.projViewMatrix=rs(this.projViewMatrix||pg(),a,this.viewMatrix),this._calcCascadeMatrixes(),this.projViewMatrixInverse=rs(this.projViewMatrixInverse||pg(),i,os(hg,a)),this.domCssMatrix=this._calcDomMatrix(),this._frustumAltitude=this._calcFrustumAltitude(),this._mapRes=this._getResolution(),this._mapGlRes=this.getGLRes(),this._mapExtent2D=this.get2DExtent(),this._mapGlExtent2D=this.get2DExtentAtRes(this._mapGlRes)}),_getCameraFar:function(t,e){var n=this.cameraCenterDistance=ea(this.cameraPosition,this.cameraLookAt),i=n/this._meterToGLPoint;e=(e=Math.min(e,85))*Math.PI/180;var o=i+this.options.cameraFarUndergroundInMeter/Math.cos(e);return Math.max(o*this._meterToGLPoint,5*n)},_calcCascadeMatrixes:function(){var t=pg();function e(e,n,i){var o=this.width,s=this.height,a=this.getFov()*Math.PI/180,l=this._getCameraFar(a,n),h=this.cameraCenterDistance;return l=h+(l-h)/Math.cos((90-n)*Math.PI/180)*Math.cos((90-e)*Math.PI/180),Yo(t,a,o/s,.1,l),rs(i,t,this.viewMatrix)}return function(){var t=this.getPitch(),n=this.options.cascadePitches[0],i=this.options.cascadePitches[1],o=this.cascadeFrustumMatrix0=this.cascadeFrustumMatrix0||pg(),s=this.cascadeFrustumMatrix1=this.cascadeFrustumMatrix1||pg();t>n?e.call(this,t,n,o):ls(this.cascadeFrustumMatrix0,this.projViewMatrix),t>i?e.call(this,t,i,s):ls(this.cascadeFrustumMatrix1,this.cascadeFrustumMatrix0)}}(),_calcDomMatrix:function(){var t=pg(),e=pg(),n=[1,-1,1],i=[0,0,0];return function(){var o=this.width||1,s=this.height||1,a=.5/Math.tan(this._fov/2)*s;return $o(t,this.projMatrix,n),Ko(t,t,Gs(i,0,0,-a)),this._pitch&&es(t,t,this._pitch),this._angle&&ns(t,t,this._angle),as(e),$o(e,e,Gs(i,o/2,-s/2,1)),rs(this.domCssMatrix||pg(),e,t)}}(),_getFovZ:function(t){var e=this.getGLScale(t),n=this._getFovRatio();return e*(this.height||1)/2/n},_getCameraWorldMatrix:function(){var t={};return function(){var e=this.getGLRes();this._meterToGLPoint||(this._meterToGLPoint=this.altitudeToPoint(100,e)/100);var n=this._prjToPointAtRes(this._prjCenter,e,fg),i=this.getCenter().z,o=(void 0!==i?i:this.centerAltitude||0)*this._meterToGLPoint;this.cameraLookAt=Gs(this.cameraLookAt||[0,0,0],n.x,n.y,o);var s=this.getPitch()*cg,a=this.getBearing()*cg,l=this._getFovZ(),h=(void 0===this.cameraZenithDistance?l:this.cameraZenithDistance)-o;this.cameraToGroundDistance=h;var c=h*Math.cos(s),u=Math.sin(s)*h,f=n.x-u*Math.sin(a),g=n.y-u*Math.cos(a);this.cameraPosition=Gs(this.cameraPosition||[0,0,0],f,g,c+o),this.cameraToCenterDistance=l,this.cameraUp=this.cameraUp||[0,0,0],this.cameraUp=this._getCameraUp(this.cameraUp,this.cameraLookAt,this.cameraPosition,s,a);var A=this.cameraWorldMatrix=this.cameraWorldMatrix||pg();!function(t,e,n,i){var o=[0,0,0],s=[0,0,0],a=[0,0,0];Ws(a,e,n),0===Qs(a)&&(a[2]=1),Ys(a,a),ta(o,i,a),0===Qs(a)&&(1===Math.abs(i[2])?a[0]+=1e-4:a[2]+=1e-4,Ys(a,a),ta(o,i,a)),Ys(o,o),ta(s,a,o),t[0]=o[0],t[4]=s[0],t[8]=a[0],t[1]=o[1],t[5]=s[1],t[9]=a[1],t[2]=o[2],t[6]=s[2],t[10]=a[2]}(A,this.cameraPosition,this.cameraLookAt,this.cameraUp);var m=this.cameraForward||[0,0,0];return Ws(m,this.cameraLookAt,this.cameraPosition),this.cameraForward=Ys(m,m),function(t,e){var n,i=e[0],o=e[4],s=e[8],a=e[1],l=e[5],h=e[9],c=e[2],u=e[6],f=e[10],g=i+l+f;g>0?(n=.5/Math.sqrt(g+1),t.w=.25/n,t.x=(u-h)*n,t.y=(s-c)*n,t.z=(a-o)*n):i>l&&i>f?(n=2*Math.sqrt(1+i-l-f),t.w=(u-h)/n,t.x=.25*n,t.y=(o+a)/n,t.z=(s+c)/n):l>f?(n=2*Math.sqrt(1+l-i-f),t.w=(s-c)/n,t.x=(o+a)/n,t.y=.25*n,t.z=(h+u)/n):(n=2*Math.sqrt(1+f-i-l),t.w=(a-o)/n,t.x=(s+c)/n,t.y=(h+u)/n,t.z=.25*n)}(t,A),function(t,e){var n=t,i=e.x,o=e.y,s=e.z,a=e.w,l=i+i,h=o+o,c=s+s,u=i*l,f=i*h,g=i*c,A=o*h,m=o*c,w=s*c,T=a*l,M=a*h,C=a*c;n[0]=1-(A+w),n[4]=f-C,n[8]=g+M,n[1]=f+C,n[5]=1-(u+w),n[9]=m-T,n[2]=g-M,n[6]=m+T,n[10]=1-(u+A),n[3]=0,n[7]=0,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1}(A,t),function(t,e){var n=t;n[12]=e[0],n[13]=e[1],n[14]=e[2]}(A,this.cameraPosition),A}}(),_getCameraUp:function(){var t=[0,0,0],e=[0,0,0],n=[0,0,0];return function(i,o,s,a,l){Gs(n,0,0,1),0===a?Gs(n,Math.sin(l),Math.cos(l),0):a===Math.PI&&Gs(n,-Math.sin(l),-Math.cos(l),0);var h=Ws(t,o,s);Ys(h,h);var c=ta(e,h,n);return ta(i,c,h)}}(),updateCenterAltitude:function(){this.getRenderer().setToRedraw(),!this.centerAltitude&&this._hasAltitudeLayer()&&(this.centerAltitude=0),this._recenterOnTerrain()},_recenterOnTerrain:function(){if(void 0!==this.centerAltitude){var t=this._queryTerrainByProjCoord(this._prjCenter);h(t)&&this._hasAltitudeLayer()&&(t=this.centerAltitude);var e=t>0&&t||0,n=this.getPitch()*cg,i=this.getBearing()*cg,o=(e-this.centerAltitude)*this._meterToGLPoint,s=this._getFovZ(),a=(void 0===this.cameraZenithDistance?s:this.cameraZenithDistance)-this.centerAltitude*this._meterToGLPoint-o/Math.cos(n),l=this.cameraPosition,c=Math.sin(n)*a,u=fg;u.x=l[0]+c*Math.sin(i),u.y=l[1]+c*Math.cos(i);var f=e*this._meterToGLPoint;this.cameraZenithDistance=(l[2]-f)/Math.cos(n)+f,this.centerAltitude=e;var g=this.pointAtResToCoordinate(u,this.getGLRes(),ug);this._eventSilence=!0,this._suppressRecenter=!0,this.setCenter(g),delete this._suppressRecenter,delete this._eventSilence,h(t)&&delete this.centerAltitude}},_queryTerrainByProjCoord:function(t){for(var e=this._getLayers(),n=0;n<e.length;n++)if(e[n].queryTerrainByProjCoord)return e[n].queryTerrainByProjCoord(t)[0];return 0},_hasAltitudeLayer:function(){for(var t=this._getLayers(),e=0;e<t.length;e++)if(t[e].getTerrainLayer&&t[e].getTerrainLayer())return!0;return!1},_queryTerrainInfo:function(t){if(t){var e=this._findTerrainLayer();if(!e)return null;var n=e.queryTerrainAtPoint(t);if(n)return{coordinate:n,altitude:n.z}}return null},_query3DTilesInfo:function(t){for(var e=this._getLayers()||[],n=0;n<e.length;n++){var i=e[n];if(t&&i&&i.query3DTilesAtPoint){var o=i.query3DTilesAtPoint(t);if(o)return{coordinate:o,altitude:o.z};break}}return null},queryPrjCoordAtContainerPoint:function(t){var e=this._query3DTilesInfo(t);if(e||(e=this._queryTerrainInfo(t)),e){var n=this.getProjection().project(e.coordinate);return n.z=e.altitude,n}return this._isContainerPointOutOfMap(t)&&(t=new _e(this.width/2,this.height/2)),this._containerPointToPrj(t)},_getFovRatio:function(){var t=this.getFov();return Math.tan(t/2*cg)},_renderLayers:function(){this.isInteracting()||this._getLayers().forEach((function(t){if(t){var e=t._getRenderer();e&&e.setToRedraw&&e.setToRedraw()}}))}}),Lf.include({_onViewChange:function(t){this._viewHistory||(this._viewHistory=[],this._viewHistoryPointer=0);for(var e=this._getCurrentView(),n=this._viewHistory.length-1;n>=0;n--)if(xn(t,this._viewHistory[n]))return this._viewHistoryPointer=n,void this._fireViewChange(e,t);this._viewHistoryPointer<this._viewHistory.length-1&&this._viewHistory.splice(this._viewHistoryPointer+1),this._viewHistory.push(t);var i=this.options.viewHistoryCount;i>0&&this._viewHistory.length>i&&this._viewHistory.splice(0,this._viewHistory.length-i),this._viewHistoryPointer=this._viewHistory.length-1,this._fireViewChange(e,t)},zoomToPreviousView:function(t={}){if(!this.hasPreviousView())return null;var e=this._viewHistory[--this._viewHistoryPointer];return this._zoomToView(e,t),e},hasPreviousView:function(){return!(!this._viewHistory||0===this._viewHistoryPointer)},zoomToNextView:function(t={}){if(!this.hasNextView())return null;var e=this._viewHistory[++this._viewHistoryPointer];return this._zoomToView(e,t),e},hasNextView:function(){return!(!this._viewHistory||this._viewHistoryPointer===this._viewHistory.length-1)},_zoomToView:function(t,e){var n=this,i=this.getView();e.animation?this._animateTo(t,{duration:e.duration},(function(e){"finished"===e.state.playState&&n._fireViewChange(i,t)})):(this.setView(t),this._fireViewChange(i,t))},getViewHistory:function(){return this._viewHistory},_fireViewChange:function(t,e){this._fireEvent("viewchange",{old:t,new:e}),this._insertUICollidesQueue()},_getCurrentView:function(){return this._viewHistory?this._viewHistory[this._viewHistoryPointer]:null}}),Lf.mergeOptions({viewHistory:!0,viewHistoryCount:10});var Ag=new yl;Lf.include({getCollisionIndex:function(){return this._collisionIndex||this.createCollisionIndex(),this._collisionIndex||this.createCollisionIndex()},createCollisionIndex:function(){return this.clearCollisionIndex(),this._collisionIndex=new yl,this._collisionIndex},clearCollisionIndex:function(){return this.collisionFrameTime=0,this._collisionIndex&&this._collisionIndex.clear(),this},_insertUICollidesQueue:function(){return this._uiCollidesQueue||(this._uiCollidesQueue=[]),this._uiCollidesQueue.push(1),this},uiCollides:function(){if(!this.uiList||0===this.uiList.length||!this._uiCollidesQueue||0===this._uiCollidesQueue.length)return this;var t=Ag;t.clear();for(var e=this.uiList,n=0,i=e.length;n<i;n++){var o=e[n],{collisionBufferSize:s,collision:a}=o.options;if(a){var l=o.getDOM();if(o.isVisible()&&l&&l.getBoundingClientRect){o.bbox||(o.bbox=[0,0,0,0]);var h=l.getBoundingClientRect(),{x:c,y:u}=h,{width:f,height:g}=h;if(0===f||0===g){var A=o.getSize();A&&(f=A.width,g=A.height)}var m=c+f+s,w=u-s,T=u+g+s;o.bbox[0]=c-s,o.bbox[1]=w,o.bbox[2]=m,o.bbox[3]=T,t.collides(o.bbox)?o._collidesEffect(!1):(t.insertBox(o.bbox),o._collidesEffect(!0))}}}return this._uiCollidesQueue=[],this},_addUI:function(t){return this.uiList||(this.uiList=[]),this.uiList.indexOf(t)>-1||(this.uiList.push(t),this.uiList=this.uiList.sort((function(t,e){return e.options.collisionWeight-t.options.collisionWeight}))),this},_removeUI:function(t){if(!this.uiList)return-1;var e=this.uiList.indexOf(t);return e<0||this.uiList.splice(e,1),e}});var mg,yg,_g=new gh(0,0);Lf.include({coordinateToPoint:function(t,e,n){var i=this._getResolution(e);return this.coordinateToPointAtRes(t,i,n)},coordinateToPointAtRes:function(){var t=new gh(0,0);return function(e,n,i){var o=this.getProjection().project(e,t);return this._prjToPointAtRes(o,n,i)}}(),pointToCoordinate:function(){var t=new gh(0,0);return function(e,n,i){var o=this._pointToPrj(e,n,t);return this.getProjection().unproject(o,i)}}(),pointAtResToCoordinate:function(){var t=new gh(0,0);return function(e,n,i){var o=this._pointToPrjAtRes(e,n,t);return this.getProjection().unproject(o,i)}}(),coordinateToViewPoint:function(){var t=new gh(0,0);return function(e,n,i){return this._prjToViewPoint(this.getProjection().project(e,t),n,i)}}(),viewPointToCoordinate:function(){var t=new gh(0,0);return function(e,n){return this.getProjection().unproject(this._viewPointToPrj(e,t),n)}}(),coordinateToContainerPoint:function(t,e,n){var i=this._getResolution(e);return this.coordinateToContainerPointAtRes(t,i,n)},coordinateToContainerPointAtRes:function(){var t=new gh(0,0);return function(e,n,i){var o=this.getProjection().project(e,t);return this._prjToContainerPointAtRes(o,n,i,o.z)}}(),coordinatesToContainerPoints:function(t,e){var n=this._getResolution(e);return this.coordinatesToContainerPointsAtRes(t,n)},coordinatesToContainerPointsAtRes:function(t,e){for(var n=[],i=this._spatialReference.getTransformation(),o=e/this._getResolution(),s=this.getProjection(),a=new gh(0,0),l=this.isTransforming(),h=this._prjToPoint(this._getPrjCenter(),void 0,_g),c=0,u=t.length;c<u;c++){var f=s.project(t[c],a),g=i.transform(f,e);g=g._multi(o),this._toContainerPoint(g,l,t[c].z,h),n.push(g)}return n},containerPointToCoordinate:function(){var t=new gh(0,0);return function(e,n){var i=this._containerPointToPrj(e,t);return this.getProjection().unproject(i,n)}}(),containerToExtent:function(){var t=new _e(0,0),e=new _e(0,0);return function(n){var i=new Oh(this._containerPointToPoint(n.getMin(t),void 0,t),this._containerPointToPoint(n.getMax(e),void 0,e));return this._pointToExtent(i)}}(),distanceToPixel:function(){var t=new _e(0,0),e=new _e(0,0);return function(n,i,o){var s=this.getProjection();if(!s)return null;var a=this.getScale()/this.getScale(o),l=this.getCenter(),h=s.locate(l,n,i),c=this.coordToContainerPoint(l,void 0,t),u=this.coordToContainerPoint(h,void 0,e);return u._sub(c)._multi(a)._abs(),new qn(u.x,u.y)}}(),distanceToPoint:function(t,e,n,i){var o=this._getResolution(n);return this.distanceToPointAtRes(t,e,o,i)},distanceToPointAtRes:function(){var t=new _e(0,0),e=new gh(0,0);return function(n,i,o,s,a){var l=this.getProjection();if(!l)return null;var h=s||this.getCenter(),c=l.locate(h,n,i,e),u=this.coordToPointAtRes(h,o,t),f=this.coordToPointAtRes(c,o,a);return f._sub(u)._abs(),f}}(),altitudeToPoint:(mg=new gh(0,40),yg=new _e(0,0),function(t=0,e,n){this._altitudeOriginDirty&&(mg.x=this._originLng,this._altitudeOriginDirty=!1);var i=this.distanceToPointAtRes(t,t,e,n||mg,yg),o=this.options.heightFactor;return o&&1!==o&&(i.x*=o,i.y*=o),i.x*Math.sign(t)}),pointAtResToAltitude:function(){var t=new gh(0,40);return function(e=0,n,i){return this.pointAtResToDistance(e,0,n,i||t)*Math.sign(e)}}(),pixelToDistance:function(){var t=new gh(0,0),e=new gh(0,0),n=new gh(0,0),i=new gh(0,0);return function(o,s){var a=this.getProjection();if(!a)return null;var l=this.getFullExtent(),h=l.top>l.bottom?-1:1,c=t.set(this.width/2,this.height/2),u=e.set(this.width/2+o,this.height/2+h*s),f=this.containerPointToCoord(c,n),g=this.containerPointToCoord(u,i);return a.measureLength(f,g)}}(),pointToDistance:function(t,e,n){var i=this.getResolution(n);return this.pointAtResToDistance(t,e,i)},pointAtResToDistance:function(){var t=new _e(0,0),e=new gh(0,0),n=new gh(0,0),i=new gh(0,0);return function(o,s,a,l){var h=this.getProjection();if(!h)return null;var c=l?h.project(l,e):this._getPrjCenter(),u=this._prjToPointAtRes(c,a,t);u._add(o,s);var f=this.pointAtResToCoord(u,a,n),g=l||h.unproject(c,i);return g.z=0,f.z=0,h.measureLength(g,f)}}(),locateByPoint:function(){var t=new _e(0,0);return function(e,n,i){var o=this.coordToContainerPoint(e,void 0,t);return this.containerPointToCoord(o._add(n,i))}}(),_get2DExtent:function(t,e){var n;if(void 0!==t&&t!==this._zoomLevel||!this._mapExtent2D||(n=this._mapExtent2D),n)return e?(e.set(n.xmin,n.ymin,n.xmax,n.ymax),e):n.copy();var i=this._getResolution(t);return this._get2DExtentAtRes(i,e)},get2DExtent:function(t,e){return this._get2DExtent(t,e)},_get2DExtentAtRes:function(){var t=new _e(0,0);return function(e,n){var i=this;return e===this._mapGlRes&&this._mapGlExtent2D?this._mapGlExtent2D:this.getContainerExtent().convertTo((function(n){return i._containerPointToPointAtRes(n,e,t)}),n)}}(),get2DExtentAtRes:function(t,e){return this._get2DExtentAtRes(t,e)},pointToExtent:function(t){return this._pointToExtent(t)},_pointToExtent:function(){var t=new gh(0,0),e=new gh(0,0);return function(n){var i=n.getMin(),o=n.getMax(),s=this.getFullExtent(),[a,l]=!s||s.left<=s.right?[i.x,o.x]:[o.x,i.x],[h,c]=!s||s.top>s.bottom?[o.y,i.y]:[i.y,o.y],u=i.set(a,c),f=o.set(l,h);return new Ph(this.pointToCoord(u,void 0,t),this.pointToCoord(f,void 0,e),this.getProjection())}}(),getViewPointFrameOffset:function(){var t=new _e(0,0);return function(){if(this.isZooming())return null;var e=this._getPrjCenter();return this._mapViewCoord&&!this._mapViewCoord.equals(e)?this._prjToContainerPoint(this._mapViewCoord)._sub(this._prjToContainerPoint(e,void 0,t)):null}}(),_viewPointToPrj:function(){var t=new _e(0,0);return function(e,n){return this._containerPointToPrj(this.viewPointToContainerPoint(e,t),n)}}(),viewPointToPrj:function(t,e){return this._viewPointToPrj(t,e)},_prjToContainerPoint:function(t,e,n,i){var o=this._getResolution(e);return this._prjToContainerPointAtRes(t,o,n,i)},prjToContainerPoint:function(t,e,n,i){return this._prjToContainerPoint(t,e,n,i)},_prjToContainerPointAtRes:function(){var t=new _e(0,0);return function(e,n,i,o){return this._pointAtResToContainerPoint(this._prjToPointAtRes(e,n,t),n,o||0,i)}}(),prjToContainerPointAtRes:function(t,e,n,i){return this.prjToContainerPointAtRes(t,e,n,i)},_prjToViewPoint:function(){var t=new _e(0,0);return function(e,n,i){var o=this._prjToContainerPoint(e,void 0,t,i);return this.containerPointToViewPoint(o,n)}}(),prjToViewPoint:function(t,e,n){return this._prjToViewPoint(t,e,n)},_viewPointToPoint:function(){var t=new _e(0,0);return function(e,n,i){return this._containerPointToPoint(this.viewPointToContainerPoint(e,t),n,i)}}(),viewPointToPoint:function(t,e,n){return this._viewPointToPoint(t,e,n)},_pointToViewPoint:function(){var t=new gh(0,0);return function(e,n,i){return this._prjToViewPoint(this._pointToPrj(e,n,t),i)}}(),pointToViewPoint:function(t,e,n){return this._pointToViewPoint(t,e,n)}});var vg={distancetool:{start:"",units:{mile:" ",feet:" ",kilometer:" ",meter:" "}},areatool:{units:{mile:" ",feet:" ",kilometer:" ",meter:" "}}},xg={distancetool:{start:"Inicio",units:{mile:" mi",feet:" ft",kilometer:" km",meter:" m"}},areatool:{units:{mile:" mi",feet:" ft",kilometer:" km",meter:" m"}}},bg={distancetool:{start:"Start",units:{mile:" mi",feet:" ft",kilometer:" km",meter:" m"}},areatool:{units:{mile:" mi",feet:" ft",kilometer:" km",meter:" m"}}},wg=function(t){function e(e){var n;return(n=t.call(this,"Translator: "+e)||this).name="TranslatorError",n}return he(e,t),e}(pe(Error)),Tg=function(t){function e(e){var n;return(n=t.call(this)||this).languages={"zh-CN":vg,"es-MX":xg,"en-US":bg},n.setLang(e||"zh-CN"),n}he(e,t);var n=e.prototype;return n.setLang=function(t){var e=this.languages[t];if(!e)throw new wg("Setted Lang does not exist");this.nodes=e},n._validateNestedProps=function(t){t.forEach((function(t){if(""===t)throw new wg('Any of sides of a dot "." cannot be empty')}))},n.translate=function(t=null){if(null==t)throw new wg("Missing parameter textNode");if("string"!=typeof t)throw new wg("Param passed has to be a String");if(!t.includes("."))return this.nodes[t];var e=t.split(".");if(e.length>3)throw new wg("Translate function can only access through 3 nested properties, trying to access -> "+e.length);this._validateNestedProps(e);try{var n=null;switch(e.length){case 2:n=this.nodes[e[0]][e[1]];break;case 3:n=this.nodes[e[0]][e[1]][e[2]]}return n}catch(t){throw new wg("Unable to find the text translated in lang json"+t.message)}},e}(Ql),Mg=function(t){function e(e){var n;return(n=t.call(this,e)||this).on("enable",n._afterEnable,n).on("disable",n._afterDisable,n),n._measureLayers=[],n.translator=new Tg(n.options.language),n}he(e,t);var n=e.prototype;return n.clear=function(){if(Je(this._measureLayers))for(var t=0;t<this._measureLayers.length;t++)this._measureLayers[t].remove();return delete this._lastMeasure,delete this._lastVertex,this._outLayers(this._measureLayers),this._measureLayers=[],this},n.getMeasureLayers=function(){return this._measureLayers},n.getLastMeasure=function(){return this._lastMeasure?this._lastMeasure:0},n.undo=function(){t.prototype.undo.call(this);var e=this._historyPointer;if(e!==this._vertexes.length)for(var n=e;n<this._vertexes.length;n++)this._vertexes[n].label&&this._vertexes[n].label.remove(),this._vertexes[n].marker.remove();return this},n.redo=function(){t.prototype.redo.call(this);var e=this._historyPointer-1;return this._vertexes[e]&&(this._vertexes[e].marker.getLayer()||(this._vertexes[e].label&&this._vertexes[e].label.addTo(this._measureMarkerLayer),this._vertexes[e].marker.addTo(this._measureMarkerLayer))),this},n._formatLabelContent=function(t){var e=this.options.formatLabelContent;return e&&A(e)?e.call(this,t)+"":null},n._measure=function(t){var e,n=this.getMap();t instanceof cf?e=n.computeGeometryLength(t):Array.isArray(t)&&(e=n.getProjection().measureLength(t)),this._lastMeasure=e;var i=this._formatLabelContent(e);if(i)return i;var o=[this.translator.translate("distancetool.units.meter"),this.translator.translate("distancetool.units.kilometer"),this.translator.translate("distancetool.units.feet"),this.translator.translate("distancetool.units.mile")],s="",a=this.options.decimalPlaces;return this.options.metric&&(s+=e<1e3?e.toFixed(a)+o[0]:(e/1e3).toFixed(a)+o[1]),this.options.imperial&&(s.length>0&&(s+="\n"),s+=(e*=3.2808399)<5280?e.toFixed(a)+o[2]:(e/5280).toFixed(a)+o[3]),s},n._registerMeasureEvents=function(){this.on("drawstart",this._msOnDrawStart,this).on("drawvertex",this._msOnDrawVertex,this).on("mousemove",this._msOnMouseMove,this).on("drawend",this._msOnDrawEnd,this)},n._afterEnable=function(){this._registerMeasureEvents()},n._afterDisable=function(){this.off("drawstart",this._msOnDrawStart,this).off("drawvertex",this._msOnDrawVertex,this).off("mousemove",this._msOnMouseMove,this).off("drawend",this._msOnDrawEnd,this)},n._msOnDrawStart=function(t){var e=this.getMap(),n=we(),i="distancetool_"+n,o="distancetool_markers_"+n,s=this.options.zIndex,a=this.options.enableAltitude;e.getLayer(i)?(this._measureLineLayer=e.getLayer(i),this._measureMarkerLayer=e.getLayer(o)):(this._measureLineLayer=new Zd(i,{zIndex:s,enableAltitude:a}).addTo(e),this._measureMarkerLayer=new Zd(o,{zIndex:s,enableAltitude:a}).addTo(e)),this._measureLayers.push(this._measureLineLayer),this._measureLayers.push(this._measureMarkerLayer),this._pushLayers([this._measureLineLayer,this._measureMarkerLayer]);var l=this._getFirstCoordinate()||t.coordinate,h=new ld(l.copy(),{symbol:this.options.vertexSymbol}),c=this.translator.translate("distancetool.start"),u=new Hd(c,l.copy(),this.options.labelOptions);this._lastVertex=u,this._addVertexMarker(h,u)},n._msOnMouseMove=function(t){var e=this._measure(this._msGetCoordsToMeasure(t));if(!this._tailMarker){var n=jo(this.options.vertexSymbol);n.markerWidth/=2,n.markerHeight/=2,this._tailMarker=new ld(t.coordinate,{symbol:n}).addTo(this._measureMarkerLayer),this._tailLabel=new Hd(e,t.coordinate,this.options.labelOptions).addTo(this._measureMarkerLayer)}var i=this._getLasttCoordinate()||t.coordinate;this._tailMarker.setCoordinates(i.copy()),this._tailLabel.setContent(e),this._tailLabel.setCoordinates(i.copy())},n._msGetCoordsToMeasure=function(t){return t.geometry.getCoordinates().concat([t.coordinate])},n._msOnDrawVertex=function(t){var e=this._getLasttCoordinate()||t.coordinate,n=t.geometry,i=new ld(e.copy(),{symbol:this.options.vertexSymbol}),o=this._measure(n),s=new Hd(o,e.copy(),this.options.labelOptions);this._addVertexMarker(i,s),this._lastVertex=s},n._addVertexMarker=function(t,e){this._vertexes||(this._vertexes=[]),void 0!==this._historyPointer&&this._vertexes.length>this._historyPointer-1&&(this._vertexes.length=this._historyPointer-1),this._vertexes.push({label:e,marker:t}),this._measureMarkerLayer.addGeometry(t),e&&this._measureMarkerLayer.addGeometry(e)},n._msOnDrawEnd=function(t){if(this._clearTailMarker(),t.geometry.getCoordinates().length<2)return this._lastMeasure=0,void this._clearMeasureLayers();var e=this._lastVertex.getSize();e||(e=new qn(10,10)),this._addClearMarker(this._lastVertex.getCoordinates(),this._lastVertex._getPrjCoordinates(),e.width);var n=t.geometry.copy();n.setCoordinates(t.geometry.getCoordinates()),n.addTo(this._measureLineLayer),this._lastMeasure=n.getLength()},n._addClearMarker=function(t,e,n){var i=this.options.clearButtonSymbol,o={markerDx:(i.markerDx||0)+n,textDx:(i.textDx||0)+n};Array.isArray(i)&&(o=i.map((function(t){return t?{markerDx:(t.markerDx||0)+n,textDx:(t.textDx||0)+n}:null}))),i=jo(i,o);var s=new ld(t,{symbol:i}),a=this._measureLineLayer,l=this._measureMarkerLayer;s.on("click",(function(){return a.remove(),l.remove(),!1}),this),s.addTo(this._measureMarkerLayer)},n._clearTailMarker=function(){this._tailMarker&&(this._tailMarker.remove(),delete this._tailMarker),this._tailLabel&&(this._tailLabel.remove(),delete this._tailLabel)},n._clearMeasureLayers=function(){this._measureLineLayer.remove(),this._measureMarkerLayer.remove()},n._getFirstCoordinate=function(){return this._geometry?(this._geometry.getCoordinates()||[])[0]:null},n._getLasttCoordinate=function(){if(!this._geometry)return null;var t=this._geometry.getCoordinates()||[];return t[t.length-1]},e}(Yd);Mg.mergeOptions({formatLabelContent:null,decimalPlaces:2,mode:"LineString",language:"zh-CN",metric:!0,imperial:!1,symbol:{lineColor:"#000",lineWidth:3,lineOpacity:1},vertexSymbol:{markerType:"ellipse",markerFill:"#fff",markerLineColor:"#000",markerLineWidth:3,markerWidth:11,markerHeight:11},labelOptions:{textSymbol:{textFaceName:"monospace",textLineSpacing:1,textHorizontalAlignment:"right",textDx:15},boxStyle:{padding:[6,2],symbol:{markerType:"square",markerFill:"#fff",markerFillOpacity:.9,markerLineColor:"#b4b3b3"}}},clearButtonSymbol:[{markerType:"square",markerFill:"#fff",markerLineColor:"#b4b3b3",markerLineWidth:2,markerWidth:15,markerHeight:15,markerDx:20},{markerType:"x",markerWidth:10,markerHeight:10,markerDx:20}]});var Cg=function(t){function e(e){var n;return(n=t.call(this,e)||this).translator=new Tg(n.options.language),n._measureLayers=[],n}he(e,t);var n=e.prototype;return n._measure=function(t){var e,n=this.getMap();t instanceof cf?e=n.computeGeometryArea(t):Array.isArray(t)&&(e=n.getProjection().measureArea(t)),this._lastMeasure=e;var i=this._formatLabelContent(e);if(i)return i;var o=[this.translator.translate("areatool.units.meter"),this.translator.translate("areatool.units.kilometer"),this.translator.translate("areatool.units.feet"),this.translator.translate("areatool.units.mile")],s="",a=this.options.decimalPlaces;if(this.options.metric&&(s+=e<1e6?e.toFixed(a)+o[0]:(e/1e6).toFixed(a)+o[1]),this.options.imperial){e*=Math.pow(3.2808399,2),s.length>0&&(s+="\n");var l=27878400;s+=e<l?e.toFixed(a)+o[2]:(e/l).toFixed(a)+o[3]}return s},n._msGetCoordsToMeasure=function(t){return t.geometry.getShell().concat([t.coordinate])},n._msOnDrawVertex=function(t){var e=this._getLasttCoordinate()||t.coordinate,n=new ld(e.copy(),{symbol:this.options.vertexSymbol});this._measure(t.geometry),this._lastVertex=n,this._addVertexMarker(n)},n._msOnDrawEnd=function(t){var e;this._clearTailMarker();var n=this.getMap();if(t.point2d)e=n._pointToPrj(t.point2d);else{var i=t.geometry._getPrjCoordinates()||[];e=(i=i.slice(0,i.length-1))[i.length-1]}if(t.geometry.getShell().length<3)return this._lastMeasure=0,void this._clearMeasureLayers();var o=this._measure(t.geometry),s=this._getLasttCoordinate(),a=new Hd(o,s.copy(),this.options.labelOptions).addTo(this._measureMarkerLayer).getSize();a||(a=new qn(10,10)),this._addClearMarker(s.copy(),e,a.width);var l=t.geometry.copy();l.setCoordinates(t.geometry.getCoordinates()),l.addTo(this._measureLineLayer),this._lastMeasure=l.getArea()},e}(Mg);function Sg(t,e,n){var i,o,s=Array.isArray(e);if(s||(e=[e]),n&&n.drawTool&&n.drawTool.options&&(o=n.drawTool.options.transformCoordinate),o&&A(o))i=e.map((function(e){return t.unproject(e)})),i=i.map((function(t){return o(t,n)||t}));else{if(!n||!n.target||!n.target._queryTerrainInfo)return i=e.map((function(e){return t.unproject(e)})),s?i:i[0];var a=n.target,l=n.enableAltitude;i=e.map((function(e){if(l){var n=a.prjToContainerPoint(e),i=a._queryTerrainInfo(n);if(i&&i.coordinate)return i.coordinate}return t.unproject(e)}))}return s?i:i[0]}Cg.mergeOptions({mode:"Polygon",symbol:{lineColor:"#000000",lineWidth:2,lineOpacity:1,lineDasharray:"",polygonFill:"#ffffff",polygonOpacity:.5},language:"zh-CN"});var Pg={create:function(t,e,n){var i=Sg(t,e[0],n);return new Md(i,0)},update:function(t,e,n,i){var o=n.getMap(),s=Sg(t,Array.isArray(e)?e[e.length-1]:e,i),a=o.computeLength(n.getCenter(),s);n.setRadius(a)},generate:function(t){return t}};Yd.registerMode("circle",l({clickLimit:2,action:["click","mousemove","click"]},Pg)),Yd.registerMode("freeHandCircle",l({action:["mousedown touchstart","mousemove touchmove","mouseup touchend"]},Pg));var Ig={create:function(t,e,n){var i=Sg(t,e[0],n);return new Sd(i,0,0)},update:function(t,e,n,i){var o=n.getMap(),s=n.getCenter(),a=Sg(t,Array.isArray(e)?e[e.length-1]:e,i),l=o.computeLength(s,new gh({x:a.x,y:s.y})),h=o.computeLength(s,new gh({x:s.x,y:a.y}));n.setWidth(2*l),n.setHeight(2*h)},generate:function(t){return t}};Yd.registerMode("ellipse",l({clickLimit:2,action:["click","mousemove","click"]},Ig)),Yd.registerMode("freeHandEllipse",l({action:["mousedown touchstart","mousemove touchmove","mouseup touchend"]},Ig));var Og={create:function(t,e){var n=new od([]);return n._firstClick=e[0],n},update:function(t,e,n,i){var o=n.getMap(),s=i.containerPoint,a=o.prjToContainerPoint(n._firstClick),l=[[a.x,a.y],[s.x,a.y],[s.x,s.y],[a.x,s.y]].map((function(t){return o._containerPointToPrj(new _e(t))})),h=Sg(t,l,i);n.setCoordinates(h)},generate:function(t){return t}};Yd.registerMode("rectangle",l({clickLimit:2,action:["click","mousemove","click"]},Og)),Yd.registerMode("freeHandRectangle",l({action:["mousedown touchstart","mousemove touchmove","mouseup touchend"]},Og)),Yd.registerMode("point",{clickLimit:1,action:["click","mousemove"],create:function(t,e,n){var i=Sg(t,e[0],n);return new ld(i)},generate:function(t){return t},update:function(t,e,n,i){if(Array.isArray(e)&&(e=e[e.length-1]),!e)return n;var o=Sg(t,e,i);return n.setCoordinates(o),n}});var Eg={create:function(t,e,n){var i=Sg(t,e,n),o=new cd(i);return o.setCoordinates(i),o},update:function(t,e,n,i){var o,s=n.getSymbol();Array.isArray(e)?o=e:(o=n._drawPrjs||[]).push(e),n._drawPrjs=o;var a=Sg(t,o,i);n.setCoordinates(a);var l=n.getLayer();if(l){var h=l.getGeometryById("polygon");if(!h&&o.length>=3){if(h=new od([a],{id:"polygon",zIndex:-1}),s){var c=jo(s,{lineOpacity:0});h.setSymbol(c)}h.addTo(l)}h&&h.setCoordinates([a])}},generate:function(t){var e=new od(t.getCoordinates(),{symbol:t.getSymbol(),properties:t.getProperties()});return e._projCode=t._projCode,e}};Yd.registerMode("polygon",l({action:["click","mousemove","dblclick"]},Eg)),Yd.registerMode("freeHandPolygon",l({action:["mousedown touchstart","mousemove touchmove","mouseup touchend"]},Eg));var kg={create:function(t,e,n){var i=Sg(t,e,n),o=new cd(i);return o.setCoordinates(i),o},update:function(t,e,n,i){var o;Array.isArray(e)?o=e:(o=n._drawPrjs||[]).push(e),n._drawPrjs=o;var s=Sg(t,o,i);n.setCoordinates(s)},generate:function(t){return t}};Yd.registerMode("linestring",l({action:["click","mousemove","dblclick"]},kg)),Yd.registerMode("freeHandLinestring",l({action:["mousedown touchstart","mousemove touchmove","mouseup touchend"]},kg)),Yd.registerMode("arccurve",{action:["click","mousemove","dblclick"],create:function(t,e){var n=e.map((function(e){return t.unproject(e)})),i=new Ed(n);return i._setPrjCoordinates(e),i},update:kg.update,generate:function(t){return t}}),Yd.registerMode("quadbeziercurve",{action:["click","mousemove","dblclick"],create:function(t,e){var n=e.map((function(e){return t.unproject(e)})),i=new Rd(n);return i._setPrjCoordinates(e),i},update:kg.update,generate:function(t){return t}}),Yd.registerMode("cubicbeziercurve",{action:["click","mousemove","dblclick"],create:function(t,e){var n=e.map((function(e){return t.unproject(e)})),i=new kd(n);return i._setPrjCoordinates(e),i},update:kg.update,generate:function(t){return t}}),Yd.registerMode("boxZoom",{action:["mousedown","mousemove","mouseup"],create:function(t,e){var n=t.unproject(e=e[0]),i=new ld(n);return i._firstClick=e,i},update:function(t,e,n,i){var o=n.getMap(),s=o.prjToContainerPoint(n._firstClick),a=i.containerPoint;e=o._containerPointToPrj(new gh(Math.min(s.x,a.x),Math.min(s.y,a.y)));var l=t.unproject(e);n.setCoordinates(l)._setPrjCoordinates(e),n.updateSymbol({markerWidth:Math.abs(s.x-a.x),markerHeight:Math.abs(s.y-a.y)})},generate:function(t){return t}});var Rg=function(t){function e(e){var n;return(n=t.call(this,e)||this).proxyOptions(),n}he(e,t);var n=e.prototype;return n._appendCustomClass=function(t){if(!t)return console.warn("dom is null:",t),this;if(this.options.cssName){var e=this.options.cssName;Array.isArray(e)||(e=[e]),e.forEach((function(e){t.classList.add(e)}))}return this},n.onAdd=function(){},n.onRemove=function(){},n.onDomRemove=function(){},n.getEvents=function(){return{}},n.getOwnerEvents=function(){return{}},n.buildOn=function(){return null},n.addTo=function(t){return this._owner=t,this._switchEvents("on"),this.onAdd&&this.onAdd(),this.fire("add"),this},n.getMap=function(){return this._owner?this._owner.getBaseLayer?this._owner:this._owner.getMap():null},n._collides=function(){var t=this.getMap();return t?(t._addUI(this),t._insertUICollidesQueue(),this):this},n._collidesEffect=function(t){var e=this.getDOM();if(!e)return this;if(e.style.visibility=t?"visible":"hidden",!e.classList||!e.classList.add)return this;if(!this.options.collisionFadeIn)return this;var n="mtk-ui-fadein",i=e.classList.contains(n);return t&&!i?e.classList.add(n):!t&&i&&e.classList.remove(n),this},n.show=function(t){var e=this,n=this.getMap();if(!n)return this;this.options.visible=!0,(t=t||this._coordinate||this._owner.getCenter())instanceof gh||(t=new gh(t));var i=this.isVisible();this._onlyUpdatePosition||this.fire("showstart");var o,s=this._getUIContainer();this._coordinate=t,this._onlyUpdatePosition||this._removePrevDOM(),this._mapEventsOn||this._switchMapEvents("on"),(o=this._onlyUpdatePosition?this.__uiDOM:this.__uiDOM=this.buildOn()).eventsPropagation=this.options.eventsPropagation,this._observerDomSize(o);var a=this.options.zIndex;if(!o)return this._onlyUpdatePosition||this.fire("showend"),this._collides(),this.setZIndex(a),this;this._onlyUpdatePosition||this._measureSize(o),this._singleton()&&(o._uiComponent=this,n[this._uiDomKey()]=o),this._setPosition(),o.style[Mi]=null,this._onlyUpdatePosition||s.appendChild(o);var l=this._getAnimation();if(i&&(l.ok=!1),l.ok&&(l.fade&&(o.style.opacity="0"),l.scale)){if(this.getTransformOrigin){var h=this.getTransformOrigin();o.style[Ti]=h}o.style[wi]=this._toCSSTranslate(this._pos)+" scale(0)"}this.isSupportZoomFilter()||(o.style.display=""),this.options.eventsToStop&&or(o,this.options.eventsToStop,zi);var c=l.transition;return l.ok&&c&&(c&&(o.style[Mi]=c),l.fade&&(o.style.opacity="1"),l.scale&&(o.style[wi]=this._toCSSTranslate(this._pos)+" scale(1)")),this._onlyUpdatePosition||this.fire("showend"),this._collides(),clearTimeout(this._autoPanId),this.options.autoPan&&(this._autoPanId=setTimeout((function(){e._autoPan()}),32)),this.setZIndex(a),this},n.hide=function(){var t=this;if(!this.getDOM())return this;this._onDomMouseout&&this._onDomMouseout(),this.options.visible=!1;var e=this._getAnimation(),n=this.getDOM();return this.options.animationOnHide||(e.ok=!1),e.ok?(n.style[Mi]=e.transition,setTimeout((function(){n.style.display="none",t.fire("hide")}),this.options.animationDuration)):(n.style.display="none",this.fire("hide")),e.fade&&(n.style.opacity="0"),e.scale&&(n.style[wi]=this._toCSSTranslate(this._pos)+" scale(0)"),this._switchMapEvents("off"),this._collides(),this},n.isVisible=function(){if(!this.options.visible)return!1;var t=this.getDOM();return this.getMap()&&t&&t.parentNode&&"none"!==t.style.display},n.remove=function(){if(delete this._mapEventsOn,!this._owner)return this;var t=this.getMap();return t&&t._removeUI(this),this.hide(),this._switchEvents("off"),this.onRemove&&this.onRemove(),!this._singleton()&&this.__uiDOM&&this._removePrevDOM(),delete this._owner,this.fire("remove"),this._collides(),this},n.getSize=function(){return this._domContentRect&&this._size&&(this._size.width=this._domContentRect.width,this._size.height=this._domContentRect.height),this._size?this._size.copy():null},n.getOwner=function(){return this._owner},n.getDOM=function(){return this.__uiDOM},n.setZIndex=function(t){if(!c(t))return this;var e=this.getDOM();return e?(e.style.zIndex=t+"",t!==this.options.zIndex&&(this.options.zIndex=t),this):this},n._roundPoint=function(t){return this.options.roundPoint&&(t=t._round()),t},n.getPosition=function(){if(!this.getMap())return null;var t=this._roundPoint(this._getViewPoint());if(this.getOffset){var e=this._roundPoint(this.getOffset());e&&t._add(e)}return t},n._getAnimation=function(){for(var t={fade:!1,scale:!1,ok:!1,transition:""},e=this.options.animation?this.options.animation.split(","):[],n=0;n<e.length;n++){var i=Yn(e[n]);"fade"===i?t.fade=!0:"scale"===i&&(t.scale=!0)}var o=null;return t.fade&&(o="opacity "+this.options.animationDuration+"ms"),t.scale&&(o=o?o+",":"",o+=wi+" "+this.options.animationDuration+"ms"),t.transition=o,t.ok=null!==o,t},n._getViewPoint=function(){var t=0,e=this._coordinate||{};if(c(e.z)?t=e.z:this._owner&&this._owner.getAltitude&&(c(t=this._owner.getAltitude()||0)||(t=0)),this._owner.getLayer){var n=this._owner.getLayer();n&&n.isVectorLayer&&(c(t=this._owner._getAltitude()||0)||(t=0))}var i=this._meterToPoint(this._coordinate,t);return this.getMap().coordToViewPoint(this._coordinate,void 0,i)._add(this.options.dx,this.options.dy)},n._meterToPoint=function(t,e){return e},n._autoPan=function(){var t=this.getMap(),e=this.getDOM();if(e&&t&&!t.isMoving()){var n=this._getViewPoint()._round(),i=t.width,o=t.height,s=t.getContainer();if(e&&s&&e.getBoundingClientRect){var a=s.getBoundingClientRect(),l=a.left,h=a.top,c=50,u=e.getBoundingClientRect(),f=0,g=0,{left:A,right:m,top:w,bottom:T}=u,{width:M,height:C}=u;if(A-=l,m-=l,w-=h,T-=h,M>0&&C>0){if(A<c&&(f=c-A),0===f&&m+c>i&&(f=-(m+c-i)),w<c&&(g=c-w),0===g&&T+c>o&&(g=-(T+c-o)),0!==f||0!==g)t.getPitch()>40&&0!==g&&this._coordinate?t.animateTo({center:this._coordinate},{duration:t.options.panAnimationDuration}):t.panBy([Math.ceil(f),Math.ceil(g)]);return}}var P=t.viewPointToContainerPoint(n),I=this.getOffset(),O=P.add(I),E=t.viewPointToPrj(n),D=parseInt(e.clientWidth+""),N=parseInt(e.clientHeight+""),H=0,U=0;if(O.x<0?H=50-O.x:O.x+D>i&&(H=-(O.x+D-i)-50),O.y-N<0?U=Math.abs(O.y-N)+50:O.y+N>o&&(U=o-(O.y+N)-50),D>=i&&(H=i/2-P.x),0!==U||0!==H){var W=P.add(H,U),q=t._containerPointToPoint(W)._sub(t._prjToPoint(t._getPrjCenter())),X=t._pointToPrj(t._prjToPoint(E).sub(q));t._panAnimation(X)}}},n._measureSize=function(t){var e=this._getUIContainer();t.style.position="absolute";var n=t.style.bottom?"bottom":"top";if(t.style.display="",e.appendChild(t),t.getBoundingClientRect){var i=t.getBoundingClientRect();this._size=new qn(i.width,i.height)}else this._size=new qn(t.clientWidth,t.clientHeight);return t.style.display="none",t.style.left="0px",t.style[n]="0px",this._size},n._removePrevDOM=function(){this.onDomRemove&&this.onDomRemove();var t=this.options.eventsToStop;if(this._singleton()){var e=this.getMap(),n=this._uiDomKey();if(e[n]){t&&sr(e[n],t,zi);var i=e[n]._uiComponent;i&&i!==this&&i.isVisible()&&i.fire("hide"),ki(e[n]),i&&!this.hideDom&&i._switchMapEvents("off"),delete e[n]}delete this.__uiDOM}else this.__uiDOM&&(t&&sr(this.__uiDOM,t,zi),ki(this.__uiDOM),delete this.__uiDOM);this._resizeObserver&&(this._resizeObserver.disconnect(),delete this._resizeObserver,delete this._domContentRect)},n._uiDomKey=function(){return"__ui_"+this._getClassName()},n._singleton=function(){return this.options.single},n._getUIContainer=function(){return this.getMap().getPanels().ui},n._getClassName=function(){return"UIComponent"},n._switchMapEvents=function(t){var e=this.getMap();if(e){this._mapEventsOn="on"===t;var n=this._getDefaultEvents();if(this.getEvents&&l(n,this.getEvents()),n)for(var i in n)n.hasOwnProperty(i)&&e[t](i,n[i],this)}},n._switchEvents=function(t){var e=this._getOwnerEvents();if(this._owner)for(var n in e)e.hasOwnProperty(n)&&this._owner[t](n,e[n],this)},n._getDefaultEvents=function(){return{"zooming rotate pitch":this.onEvent,zoomend:this.onZoomEnd,moving:this.onMoving,moveend:this.onMoving,resize:this.onResize}},n._getOwnerEvents=function(){var t={};return this._owner&&this._owner instanceof cf&&(t.positionchange=this.onGeometryPositionChange,t.symbolchange=this._updatePosition),this.getOwnerEvents&&l(t,this.getOwnerEvents()),t},n.onGeometryPositionChange=function(t){if(this._owner&&this.isVisible()){this._onlyUpdatePosition=!0;var e=t.target,n=e.getCenter();if(e._getAltitude){var i=e._getAltitude();c(i)&&(n.z=i)}this.show(n),this._onlyUpdatePosition=!1}},n.onMoving=function(){this.isVisible()&&this.getMap().isTransforming()&&this._updatePosition()},n.onEvent=function(){this.isVisible()&&this._updatePosition()},n.onZoomEnd=function(){this.isVisible()&&this._setPosition()},n.onResize=function(){this.isVisible()&&this._setPosition()},n.onDomSizeChange=function(){this.isVisible()&&(this._setPosition(),this._collides())},n._updatePosition=function(){return this.getMap()?(this.getMap()._getRenderer().callInNextFrame(this._setPosition.bind(this)),this):this},n._setPosition=function(){var t=this.getDOM();if(t){t.style[Mi]=null;var e=this.getPosition();this._pos=e,t.style[wi]=this._toCSSTranslate(e)+" scale(1)"}},n._toCSSTranslate=function(t){if(!t)return"";if(Gt.any3d){var e=this.getMap(),n=e?e.getBearing():0,i=e?e.getPitch():0,o="";return this.options.pitchWithMap&&i&&(o+=" rotateX("+Math.round(i)+"deg)"),this.options.rotateWithMap&&n&&(o+=" rotateZ("+Math.round(-n)+"deg)"),"translate3d("+Math.round(t.x)+"px,"+Math.round(t.y)+"px, 0px)"+o}return"translate("+Math.round(t.x)+"px,"+Math.round(t.y)+"px)"},n._observerDomSize=function(t){var e=this;return t&&Gt.resizeObserver&&!this._resizeObserver?(this._resizeObserver=new ResizeObserver((function(t){if(t.length){var n=t[0].borderBoxSize;e._domContentRect=n&&n.length?{width:n[0].inlineSize,height:n[0].blockSize}:t[0].contentRect}else delete e._domContentRect;e.onDomSizeChange&&e.onDomSizeChange()})),this._resizeObserver.observe(t),this):this},n.isSupportZoomFilter=function(){return!1},n.onConfig=function(){return this._updatePosition(),this},e.isSupport=function(t){return!!(t&&A(t.on)&&A(t.off)&&A(t.getCenter))},n._bindDomEvents=function(t,e){if(t){var n=this._getDomEvents()||{},i="on"===e?or:sr;for(var o in n)"on"===e&&sr(t,o,n[o]),i(t,o,n[o],this)}},n._getDomEvents=function(){return{mouseover:this._onDomMouseover,mouseout:this._onDomMouseout}},n._configMapPreventWheelScroll=function(t){var e=this.getMap();e&&(this.options.eventsPropagation||(e.options.preventWheelScroll=t))},n._onDomMouseover=function(){this._configMapPreventWheelScroll(!1),this.fire("mouseover")},n._onDomMouseout=function(){this._configMapPreventWheelScroll(!0),this.fire("mouseout")},e}(Xl(Ql));Rg.mergeOptions({eventsPropagation:!1,eventsToStop:null,dx:0,dy:0,autoPan:!1,autoPanDuration:600,single:!0,animation:"scale",animationOnHide:!1,animationDuration:500,pitchWithMap:!1,rotateWithMap:!1,visible:!0,roundPoint:!1,collision:!1,collisionBufferSize:2,collisionWeight:0,collisionFadeIn:!1,zIndex:0});var Lg="mousedown mouseup mouseenter mouseover mouseout mousemove click dblclick contextmenu keypress touchstart touchmove touchend",Dg=function(t){function e(e,n){var i;return(i=t.call(this,n)||this)._markerCoord=new gh(e),i}he(e,t);var n=e.prototype;return n._getClassName=function(){return"UIMarker"},n.setCoordinates=function(t){if(!t)return this;if(!(t instanceof gh))try{t=new gh(t)}catch(t){return console.error(t),this}return this._markerCoord=t,this.fire("positionchange"),this.isVisible()&&(this._onlyUpdatePosition=!0,this._coordinate=this._markerCoord,this._setPosition(),this._collides(),this._onlyUpdatePosition=!1),this},n.getCoordinates=function(){return this._markerCoord},n.getCenter=function(){return this.getCoordinates()},n.getAltitude=function(){var t=this.getCoordinates()||{};return c(t.z)?t.z:this.options.altitude||0},n.setAltitude=function(t){return c(t)&&this._markerCoord&&(this._markerCoord.z=t,this._updatePosition&&(this._updatePosition(),this._collides())),this},n.setContent=function(t){var e=this.options.content;return this.options.content=t,this.fire("contentchange",{old:e,new:t}),this.isVisible()&&this.show(),this},n.getContent=function(){return this.options.content},n.onAdd=function(){if(this._owner&&!this._owner.isMap){var t=this._owner;throw new Error("UIMarker Can only be added to the map, but owner is:"+t.getJSONType&&t.getJSONType())}return this.show(),this},n.show=function(){return t.prototype.show.call(this,this._markerCoord)},n.flash=function(t,e,n,i){return Mn.call(this,t,e,n,i)},n.buildOn=function(){var t,e=this.getDOM();this._bindDomEvents(e,"off");var n=this.options.content,i=g(n);return i||A(n)?(t=Pi("div"),i?t.innerHTML=this.options.content:n.bind(this)(t)):t=this.options.content,this.options.containerClass&&(t.className=this.options.containerClass),this._registerDOMEvents(t),this._bindDomEvents(t,"on"),this._appendCustomClass(t),t},n.getOffset=function(){var t=this.getSize(),e=-t.width/2,n=-t.height/2,{horizontalAlignment:i,verticalAlignment:o}=this.options;return"left"===i?e=-t.width:"right"===i&&(e=0),"top"===o?n=-t.height:"bottom"===o&&(n=0),new _e(e,n)},n.getTransformOrigin=function(){return"center center"},n.onDomRemove=function(){var t=this.getDOM();this._removeDOMEvents(t)},n.isDragging=function(){return!!this.draggable&&this.draggable.isDragging()},n._registerDOMEvents=function(t){or(t,Lg,this._onDomEvents,this)},n._onDomEvents=function(t,e){var n=this.getMap()._parseEvent(t,t.type);if("mousedown"===(e=e||t.type)&&(this._mousedownEvent=t),"mouseup"===e&&(this._mouseupEvent=t),("click"!==e||!this._mouseClickPositionIsChange())&&("touchstart"===e&&(this._touchstartTime=a()),this.fire(e,n),"touchend"===e&&Gt.touch)){var i=this.getMap().options.clickTimeThreshold||280;a()-this._touchstartTime<i&&this._onDomEvents(t,"click")}},n._removeDOMEvents=function(t){sr(t,Lg,this._onDomEvents)},n._mouseClickPositionIsChange=function(){var{x:t,y:e}=this._mousedownEvent||{},{x:n,y:i}=this._mouseupEvent||{};return t!==n||e!==i},n._getConnectPoints=function(){var t=this.getMap(),e=t.coordToContainerPoint(this.getCoordinates()),n=this.getSize(),i=n.width,o=n.height;return[t.containerPointToCoordinate(e.add(-i/2,0)),t.containerPointToCoordinate(e.add(i/2,0)),t.containerPointToCoordinate(e.add(0,o/2)),t.containerPointToCoordinate(e.add(0,-o/2))]},n._getViewPoint=function(){var t=0;if(this._owner){var e=this.getAltitude();e>0&&(t=this._meterToPoint(this._coordinate,e))}return this.getMap().coordToViewPoint(this._coordinate,void 0,t)._add(this.options.dx,this.options.dy)},n._getDefaultEvents=function(){return l({},t.prototype._getDefaultEvents.call(this),{"zooming zoomend":this.onZoomFilter})},n._setPosition=function(){this.onZoomFilter(),t.prototype._setPosition.call(this)},n.onZoomFilter=function(){var t=this.getDOM();t&&(this.isVisible()||"none"===t.style.display?this.isVisible()&&"none"===t.style.display&&(t.style.display=""):t.style.display="none")},n.isVisible=function(){var t=this.getMap();if(!t)return!1;if(!this.options.visible)return!1;var e=t.getZoom(),{minZoom:n,maxZoom:i}=this.options;return!(!h(n)&&e<n||!h(i)&&e>i)&&(this.getDOM()&&!0)},n.isSupportZoomFilter=function(){return!0},e}(hh(Rg));Dg.mergeOptions({containerClass:null,eventsPropagation:!0,draggable:!1,single:!1,content:null,altitude:0,minZoom:0,maxZoom:null,horizontalAlignment:"middle",verticalAlignment:"middle"});var Fg=Gt.touch?"touchstart mousedown":"mousedown",Ng=function(t){function e(e){return t.call(this,e)||this}he(e,t);var n=e.prototype;return n.addHooks=function(){this.target.on(Fg,this._startDrag,this)},n.removeHooks=function(){this.target.off(Fg,this._startDrag,this)},n._startDrag=function(t){var e=t.domEvent;e.touches&&e.touches.length>1||2===e.button||this.isDragging()||(this.target.on("click",this._endDrag,this),this._lastCoord=t.coordinate,this._lastPoint=t.containerPoint,this._prepareDragHandler(),this._dragHandler.onMouseDown(t.domEvent),this.target.fire("dragstart",t))},n._prepareDragHandler=function(){this._dragHandler=new dh(this.target.getDOM(),{cancelOn:this._cancelOn.bind(this),ignoreMouseleave:!0}),this._dragHandler.on("mousedown",this._onMouseDown,this),this._dragHandler.on("dragging",this._dragging,this),this._dragHandler.on("mouseup",this._endDrag,this),this._dragHandler.enable()},n._cancelOn=function(t){var e=(t.srcElement||t.target).tagName.toLowerCase();return"button"===e||"input"===e||"select"===e||"option"===e||"textarea"===e},n._onMouseDown=function(t){zi(t.domEvent)},n._dragging=function(t){var e=this.target,n=e.getMap()._parseEvent(t.domEvent),i=n.domEvent;if(!(i.touches&&i.touches.length>1))if(this._isDragging){var o=n.coordinate,s=n.containerPoint;this._lastCoord||(this._lastCoord=o),this._lastPoint||(this._lastPoint=s);var a=o.sub(this._lastCoord),l=s.sub(this._lastPoint);this._lastCoord=o,this._lastPoint=s,this.target.setCoordinates(this.target.getCoordinates().add(a)),n.coordOffset=a,n.pointOffset=l,e.fire("dragging",n)}else this._isDragging=!0},n._endDrag=function(t){var e=this.target,n=e.getMap();if(this._dragHandler&&(e.off("click",this._endDrag,this),this._dragHandler.disable(),delete this._dragHandler),delete this._lastCoord,delete this._lastPoint,this._isDragging=!1,n){var i=n._parseEvent(t.domEvent);e&&e._mouseClickPositionIsChange&&e._mouseClickPositionIsChange()&&e.fire("dragend",i)}},n.isDragging=function(){return!!this._isDragging},e}(Jl);Dg.addInitHook("addHandler","draggable",Ng);var Hg=/\{ *([\w_]+) *\}/g,Bg={containerClass:"ispace-msgBox",autoPan:!0,autoCloseOn:null,autoOpenOn:"click",width:"auto",minHeight:120,custom:!1,title:null,content:null,enableTemplate:!1},zg=new qn(0,0),Gg=function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n._getClassName=function(){return"InfoWindow"},n.addTo=function(e){return e instanceof cf&&(e.getInfoWindow()&&e.getInfoWindow()!==this&&e.removeInfoWindow(),e._infoWindow=this),t.prototype.addTo.call(this,e)},n.setContent=function(t){var e=this.options.content;return this.options.content=t,this.fire("contentchange",{old:e,new:t}),this.isVisible()&&this.show(this._coordinate),this},n.getContent=function(){return this.options.content},n.setTitle=function(t){var e=t;return this.options.title=t,this.fire("contentchange",{old:e,new:t}),this.isVisible()&&this.show(this._coordinate),this},n.getTitle=function(){return this.options.title},n.buildOn=function(){var t=this,e=A(this.options.content),n=g(this.options.content);if(this.options.custom){var i,o=this.getDOM();if(this._bindDomEvents(o,"off"),n||e){var s=Pi("div");n?(s.innerHTML=this.options.content,this._replaceTemplate(s)):this.options.content.bind(this)(s),i=s}else this._replaceTemplate(this.options.content),i=this.options.content;return this._bindDomEvents(i,"on"),this._appendCustomClass(i),i}this._bindDomEvents(this.getDOM(),"off");var a=Pi("div");this.options.containerClass&&(a.className=this.options.containerClass);var l=this._getWindowWidth();a.style.width=c(l)?l+"px":"auto",a.style.bottom="0px";var h='<em class="ispace-ico"></em>';this.options.title&&(h+="<h2>"+this.options.title+"</h2>"),a.innerHTML=h+='<a href="javascript:void(0);" class="ispace-close"></a><div class="ispace-msgContent"></div>',this._replaceTemplate(a);var u=a.querySelector(".ispace-msgContent");return n||e?n?u.innerHTML=this.options.content:this.options.content.bind(this)(u):u.appendChild(this.options.content),this._onCloseBtnClick=function(e){t.options.eventsPropagation||(Hi(e),zi(e)),t.hide()},Ri(a.querySelector(".ispace-close"),"click touchend",this._onCloseBtnClick),e||this._replaceTemplate(u),this._bindDomEvents(a,"on"),this._appendCustomClass(a),a},n._replaceTemplate=function(t){var e=this._owner;if(this.options.enableTemplate&&e&&e.getProperties&&t&&t.innerHTML){var n=e.getProperties()||{};if(f(n))t.innerHTML=t.innerHTML.replace(Hg,(function(t,e){return n[e]}))}return this},n.getTransformOrigin=function(){return this.getSize().width/2+"px bottom"},n.getOffset=function(){var t=this.getSize(),e=new _e(-t.width/2,0);this.options.custom?e._sub(0,t.height):e._sub(4,12);var n=this.getOwner();if(n instanceof ld||n instanceof Ad){var i,o;if(n instanceof ld)i=n._getPainter(),o=n.getSize();else{var s=n.getGeometries();if(!s||!s.length)return e;i=s[0]._getPainter(),o=s[0].getSize()}if(o||(o=zg),i){var a=i.getFixedExtent();e._add(a.xmax-o.width/2,a.ymin)}else e._add(0,-o.height)}return e},n.show=function(e){return this.getMap()&&this.getMap().options.enableInfoWindow?t.prototype.show.call(this,e):this},n.getEvents=function(){if(!this.options.autoCloseOn)return null;var t={};return t[this.options.autoCloseOn]=this.hide,t},n.getOwnerEvents=function(){var t=this.getOwner();if(!this.options.autoOpenOn||!t)return null;var e={};return e[this.options.autoOpenOn]=this._onAutoOpen,e},n.onRemove=function(){this._onDomMouseout(),this.onDomRemove()},n.onDomRemove=function(){this._onCloseBtnClick&&(Di(this.getDOM().childNodes[2],"click touchend",this._onCloseBtnClick),delete this._onCloseBtnClick)},n._onAutoOpen=function(t){var e=this,n=this.getOwner();setTimeout((function(){n instanceof ld||n instanceof Rg?e.show(n.getCoordinates()):n instanceof Ad?e.show(n.findClosest(t.coordinate)):n instanceof cd||n instanceof yd?(e.getMap().getScale()>=8&&(t.coordinate=e._rectifyMouseCoordinte(n,t.coordinate)),e.show(t.coordinate)):e.show(t.coordinate)}),1)},n._rectifyMouseCoordinte=function(t,e){var n=this;return t instanceof cd?this._rectifyLineStringMouseCoordinate(t,e).coordinate:t instanceof yd?t.getGeometries().map((function(t){return n._rectifyLineStringMouseCoordinate(t,e)})).sort((function(t,e){return t.dis-e.dis}))[0].coordinate:e},n._rectifyLineStringMouseCoordinate=function(t,e){for(var n=this.getMap(),i=t.getCoordinates()||[],o=n.getGLRes(),s=i.map((function(t){var e=n.coordToPointAtRes(t,o);return n._pointAtResToContainerPoint(e,o,t.z||0)})),a=n.coordToContainerPoint(e),l=1/0,h=-1,c=0,u=s.length;c<u;c++){var f=a.distanceTo(s[c]);f<l&&(l=f,h=c)}for(var g=[h-1,h,h+1].filter((function(t){return t>=0&&t<=s.length-1})),A=g.map((function(t){return s[t]})),m=[],{width:w,height:T}=n.getSize(),M=0,C=A.length-1;M<C;M++){var P=M,I=A[M],O=A[M+1];if(I.x===O.x)for(var E=Math.max(0,Math.min(I.y,O.y)),D=Math.min(T,Math.max(I.y,O.y)),N=E;N<=D;N++)m.push({point:new _e(I.x,N),coordinateIndex:P});else for(var H=(O.y-I.y)/(O.x-I.x),U=Math.max(0,Math.min(I.x,O.x)),W=Math.min(w,Math.max(I.x,O.x)),q=U;q<=W;q++){m.push({point:new _e(q,H*(q-I.x)+I.y),coordinateIndex:P})}}for(var X,J=1/0,Q=-1,Y=-1,K=0,$=m.length;K<$;K++){var{point:tt,coordinateIndex:et}=m[K],nt=a.distanceTo(tt);nt<J&&(J=nt,Q=K,Y=et,X=tt)}if(Q<0)return{dis:J,coordinate:e};var it=A[Y],rt=it.distanceTo(A[Y+1]),ot=X.distanceTo(it)/rt,st=g.map((function(t){return i[t]})),at=st[Y],ut=st[Y+1],ft=at.x,gt=at.y,vt=at.z||0;return{dis:J,coordinate:new gh(ft+(ut.x-ft)*ot,gt+(ut.y-gt)*ot,vt+((ut.z||0)-vt)*ot)}},n._getWindowWidth=function(){var t=this.options.width;return t||(t=Bg.width),t},e}(Rg);Gg.mergeOptions(Bg);var jg="remove hide shapechange positionchange dragend animatestart",Ug=function(t){function e(e,n={}){var i;return(i=t.call(this,n)||this)._content=e,i}he(e,t);var n=e.prototype;return n._getClassName=function(){return"ToolTip"},n.addTo=function(n){if(e.isSupport(n))return n.on("mousemove",this.onMouseMove,this),n.on("mouseout",this.onMouseOut,this),n.on(jg,this.hideDom,this),t.prototype.addTo.call(this,n);throw new Error("Invalid geometry or UIMarker the tooltip is added to.")},n.setStyle=function(t){return this.options.containerClass=t,this},n.getStyle=function(){return this.options.containerClass},n.getContent=function(){return this._content},n.buildOn=function(){var t=Pi("div"),e=this.options||{};e.height&&(t.style.height=e.height+"px"),e.width&&(t.style.width=e.width+"px");var n=e.containerClass||e.cssName;return!n&&e.height&&(t.style.lineHeight=e.height+"px"),A(this._content)?this._content.bind(this)(t):t.innerHTML='<div class="'+n+'">'+this._content+"</div>",this._appendCustomClass(t),t},n.onMouseOut=function(){clearTimeout(this._timeout),this.isVisible()&&this._removePrevDOM(),this._switchMapEvents("off")},n.onMouseMove=function(t){var e=this;clearTimeout(this._timeout);var n=this.getMap();if(n){var i=n.locateByPoint(t.coordinate,-5,25);0===this.options.showTimeout?this.show(i):this._timeout=setTimeout((function(){n&&e.show(i)}),this.options.showTimeout)}},n.onRemove=function(){clearTimeout(this._timeout),this._owner&&(this._owner.off("mousemove",this.onMouseMove,this),this._owner.off("mouseout",this.onMouseOut,this),this._owner.off(jg,this.hideDom,this))},n.hideDom=function(){this.hide()},n.onEvent=function(){return t.prototype.onEvent.call(this),this.hideDom(),this},n._getViewPoint=function(){return this.getMap().coordToViewPoint(this._coordinate,void 0,0)._add(this.options.dx,this.options.dy)},e}(Rg);Ug.mergeOptions({width:0,height:0,animation:"fade",containerClass:"ispace-tooltip",showTimeout:400});var Vg=function(t){function e(e){return t.call(this,e)||this}he(e,t);var n=e.prototype;return n._getClassName=function(){return"Menu"},n.addTo=function(t){return t._menu&&t._menu!==this&&t.removeMenu(),t._menu=this,this._owner=t,Rg.prototype.addTo.apply(this,[t])},n.setItems=function(t){return this.options.items=t,this},n.getItems=function(){return this.options.items||[]},n.buildOn=function(){var t;if(this.options.custom)if(g(this.options.items)){var e=Pi("div");e.innerHTML=this.options.items,this._appendCustomClass(e),t=e}else t=this.options.items;else{t=Pi("div"),this.options.containerClass&&Qi(t,this.options.containerClass),t.style.width=this._getMenuWidth()+"px";var n=this._createMenuItemDom();t.appendChild(n),or(t,"contextmenu",Hi),this._appendCustomClass(t)}return t&&(this._bindDomEvents(t,"off"),this._bindDomEvents(t,"on")),t},n.getOffset=function(){if(!this.getMap())return null;var t=this.getMap().getSize(),e=this.getMap().viewPointToContainerPoint(this._getViewPoint()),n=this.getSize(),i=0,o=0;return e.x+n.width>t.width&&(i=-n.width),e.y+n.height>t.height&&(o=-n.height),new _e(i,o)},n.getTransformOrigin=function(){var t=this.getOffset()._multi(-1);return t.x+"px "+t.y+"px"},n.getEvents=function(){return{"_zoomstart _zoomend _movestart _dblclick _click":this._removePrevDOM}},n._createMenuItemDom=function(){var t=this,e=this.getMap(),n=Pi("ul");Qi(n,"ispace-menu-items");var i,o,s=this.getItems();function a(n){return function(i){var o=e._parseEvent(i,"click");o.target=t,o.owner=t._owner,o.index=n,!1!==this._callback(o)&&(t.hide(),t._owner&&t._owner.fire("closemenu"))}}for(var l=0,h=s.length;l<h;l++){if("-"===(i=s[l])||"_"===i)Qi(o=Pi("li"),"ispace-menu-splitter");else{o=Pi("li");var c=i.item;A(c)&&(c=c({owner:this._owner,index:l})),o.innerHTML=c,o._callback=i.click,or(o,"click",a(l))}n.appendChild(o)}var u=this.options.maxHeight||0;return u>0&&qi(n,"max-height: "+u+"px; overflow-y: auto;"),n},n._getMenuWidth=function(){return this.options.width||160},e}(Rg);Vg.mergeOptions({containerClass:"ispace-menu",animation:null,animationDelay:10,animationOnHide:!1,autoPan:!1,width:160,maxHeight:0,custom:!1,items:[]});var Wg={setMenu:function(t){return this._menuOptions=t,this._menu?this._menu._setOptions(t):this.on("contextmenu",this._defaultOpenMenu,this),this},getMenu:function(){return this._menu},openMenu:function(t){var e=this instanceof Lf?this:this.getMap();return t||(t=this.getCenter()),this._menu?this._menu.show(t):this._menuOptions&&e&&(this._bindMenu(),this._menu.show(t)),this.fire("openmenu",{coordinate:t}),this},setMenuItems:function(t){return this._menuOptions||(this._menuOptions={}),Array.isArray(t)&&(this._menuOptions.custom=!1),this._menuOptions.items=t,this.setMenu(this._menuOptions),this},getMenuItems:function(){return this._menu?this._menu.getItems():this._menuOptions&&this._menuOptions.items||[]},closeMenu:function(){return this._menu&&this._menu.hide(),this.fire("closemenu",{}),this},removeMenu:function(){return this.off("contextmenu",this._defaultOpenMenu,this),this._unbindMenu(),delete this._menuOptions,this.fire("removemenu",{}),this},_bindMenu:function(){return this._menuOptions?(this._menu=new Vg(this._menuOptions),this._menu.addTo(this),this):this},_unbindMenu:function(){return this._menu&&(this.closeMenu(),this._menu.remove(),delete this._menu),this},_defaultOpenMenu:function(t){return this.openMenu(t.coordinate),!1}};Lf.include(Wg),cf.include(Wg);var Zg=Object.freeze({__proto__:null,InfoWindow:Gg,Menu:Vg,Menuable:Wg,ToolTip:Ug,UIComponent:Rg,UIMarker:Dg}),qg=function(t){function e(e){return e&&e.position&&!g(e.position)&&(e.position=l({},e.position)),t.call(this,e)||this}he(e,t);var n=e.prototype;return n._appendCustomClass=function(t){if(!t)return console.warn("dom is null:",t),this;if(this.options.cssName){var e=this.options.cssName;Array.isArray(e)||(e=[e]),e.forEach((function(e){t.classList.add(e)}))}return this},n.onAdd=function(){},n.onRemove=function(){},n.addTo=function(t){if(this.remove(),!t.options.control)return this;this._map=t;var e=t.getPanels().control;return this.__ctrlContainer=Pi("div"),qi(this.__ctrlContainer,"position:absolute;overflow:visible;"),this.update(),e.appendChild(this.__ctrlContainer),this.onAdd&&this.onAdd(),this.fire("add",{dom:e}),this},n.update=function(){return this.__ctrlContainer.innerHTML="",this._controlDom=this.buildOn(this.getMap()),this._controlDom&&(this._updatePosition(),this.__ctrlContainer.appendChild(this._controlDom)),this},n.getMap=function(){return this._map},n.getPosition=function(){return l({},this._parse(this.options.position))},n.setPosition=function(t){return this.options.position=g(t)?t:l({},t),this._updatePosition(),this},n.getContainerPoint=function(){var t,e,n=this.getPosition(),i=this.getMap().getSize();return h(n.left)?h(n.right)||(t=i.width-parseInt(n.right+"")):t=parseInt(n.left+""),h(n.top)?h(n.bottom)||(e=i.height-parseInt(n.bottom+"")):e=parseInt(n.top+""),new _e(t,e)},n.getContainer=function(){return this.__ctrlContainer},n.getDOM=function(){return this._controlDom},n.show=function(){return this.__ctrlContainer.style.display="",this},n.hide=function(){return this.__ctrlContainer.style.display="none",this},n.isVisible=function(){return this.__ctrlContainer&&""===this.__ctrlContainer.style.display},n.remove=function(){return this._map?(ki(this.__ctrlContainer),this.onRemove&&this.onRemove(),delete this._map,delete this.__ctrlContainer,delete this._controlDom,this.fire("remove"),this):this},n._parse=function(t){var n=t;return g(t)&&(n=e.positions[n]),n},n._updatePosition=function(){var t=this.getPosition();for(var e in t||(t={top:20,left:20}),this.__ctrlContainer&&Object.assign(this.__ctrlContainer.style,{top:null,bottom:null,right:null,left:null}),t)if(t.hasOwnProperty(e)){var n=t[e]||0;c(n)&&(n+="px"),this.__ctrlContainer.style[e]=n}this.fire("positionchange",{position:l({},t)})},n.onConfig=function(t){t&&"position"in t&&this._updatePosition()},e}(Xl(Ql));qg.positions={"top-left":{top:20,left:20},"top-right":{top:20,right:20},"bottom-left":{bottom:20,left:20},"bottom-right":{bottom:20,right:20}},Lf.mergeOptions({control:!0}),Lf.include({addControl:function(t){return this._containerDOM.getContext||t.addTo(this),this},removeControl:function(t){return t&&t.getMap()===this?(t.remove(),this):this}});var Xg="addlayer removelayer setbaselayer baselayerremove",Jg=function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n.buildOn=function(){return this._attributionContainer=Pi("div"),this._attributionContainer.className="ispace-attribution",this._appendCustomClass(this._attributionContainer),this._update(),this._attributionContainer},n.getContent=function(){return this.options.content},n.setContent=function(t){return this.options.content=t,this._update(),this},n.onAdd=function(){this.getMap().on(Xg,this._update,this)},n.onRemove=function(){this.getMap().off(Xg,this._update,this)},n._updateContent=function(){var t=this._attributionContainer,e=this.options.content||"";return t&&(t.innerHTML="",g(e)?t.innerHTML=e:e instanceof HTMLElement&&t.appendChild(t)),this},n._update=function(){if(this.options.custom)this._updateContent();else{var t=this.getMap();if(t){var e=t._getLayers((function(t){return!!t.options.attribution})).reverse().map((function(t){return t.options.attribution})),n=this.options.content+(e.length>0?" - "+e.join(", "):"");this._attributionContainer.innerHTML='<span style="padding:0px 4px">'+n+"</span>"}}},e}(qg);Jg.mergeOptions({position:{bottom:0,left:0},content:'<a href="http://ispace.org" target="_blank">ispace</a>',custom:!1}),Lf.mergeOptions({attribution:!0}),Lf.addOnLoadHook((function(){var t=this.options.attribution||this.options.attributionControl;t&&(this.attributionControl=new Jg(t),this.addControl(this.attributionControl))}));var Qg=function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n.buildOn=function(t){var e=this._getCompass();return this._appendCustomClass(e),this._compass=e,this._registerDomEvents(),t.on("resize moving moveend zooming zoomend rotate rotateend dragrotating dragrotateend viewchange",this._rotateCompass,this),e},n.onAdd=function(){this._rotateCompass()},n._getCompass=function(){return Pi("div","ispace-compass")},n._registerDomEvents=function(){or(this._compass,"click",this._resetView,this)},n._rotateCompass=function(){var t=this.getMap().getBearing().toFixed(1),e=parseFloat(t);e<=180&&(e*=-1),e!==this._bearing&&(this._bearing=e,qi(this._compass,"transform: rotate("+this._bearing+"deg);"))},n.onRemove=function(){this.getMap().off("resize moving moveend zooming zoomend rotate rotateend dragrotating dragrotateend viewchange",this._rotateCompass,this),delete this._compass,delete this._bearing},n._resetView=function(){this.getMap().animateTo({bearing:0})},e}(qg);Qg.mergeOptions({position:{top:120,left:20}}),Lf.mergeOptions({compassControl:!1}),Lf.addOnLoadHook((function(){this.options.compassControl&&(this.compassControl=new Qg(this.options.compassControl),this.addControl(this.compassControl))}));var Yg=function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n.buildOn=function(){var t=this.container=Pi("div",this.options.containerClass),e=this.panel=Pi("div","panel"),n=this.button=Pi("button");return t.appendChild(n),t.appendChild(e),this._appendCustomClass(t),t},n.onAdd=function(){or(this.button,"mouseover",this._show,this),or(this.panel,"mouseleave",this._hide,this)},n.onRemove=function(){this.panel&&(sr(this.button,"mouseover",this._show),sr(this.panel,"mouseleave",this._hide),ki(this.panel),ki(this.button),delete this.panel,delete this.button,delete this.container)},n._show=function(){Ji(this.container,"shown")||(Qi(this.container,"shown"),this._createPanel())},n._hide=function(t){this.panel.contains(t.toElement||t.relatedTarget)||Yi(this.container,this.options.containerClass)},n._createPanel=function(){this.panel.innerHTML="";var t=Pi("ul");this.panel.appendChild(t),this._renderLayers(this.getMap(),t)},n._renderLayers=function(t,e){var n=this,i=t.getBaseLayer(),o=t.getLayers(),s=o.length;if(i){var a=i.layers||[i],l=Pi("li","group"),h=Pi("ul"),c=Pi("label");c.innerHTML=this.options.baseTitle,l.appendChild(c);for(var u=0,f=a.length;u<f;u++){this._isExcluded(a[u])&&(h.appendChild(this._renderLayer(a[u],!0)),l.appendChild(h),e.appendChild(l))}}if(s){var g=Pi("li","group"),A=Pi("ul"),m=Pi("label"),w=Pi("input");w.type="checkbox",w.checked=!0,m.innerHTML=this.options.overlayTitle,g.appendChild(w),g.appendChild(m);for(var T=function(t){var e=t.target.checked,n=t.target.parentNode;if(n){var i=n.getElementsByTagName("ul")[0];if(i){var o=function(t){var n=t._layer;n&&n[e?"show":"hide"]()},s=function(t){var n=t._layer,i=t.childNodes[0];i&&(i.checked=e),n&&n[e?"show":"hide"]()};o(n),i.childNodes.forEach((function(t){s(t);var e=t.getElementsByTagName("ul")[0];e&&(o(t),e.childNodes.forEach((function(t){s(t)})))}))}}},M=function(){var t=o[C];if(n._isExcluded(t)){if(t.getLayers){var e=Pi("li","group"),i=Pi("ul"),s=Pi("label"),a=Pi("input");s.innerHTML=t.getId(),a.type="checkbox",a.checked=t.isVisible(),a.onchange=T,e.appendChild(a),e.appendChild(s),e.appendChild(i),e._layer=t,A.appendChild(e),(t.getLayers()||[]).forEach((function(t){i.appendChild(n._renderLayer(t,!1,a.checked))}))}else A.appendChild(n._renderLayer(t));t&&!t.isVisible()&&(w.checked=!1)}},C=0;C<s;C++)M();g.appendChild(A),e.appendChild(g),w.onchange=T}},n._isExcluded=function(t){var e=t.getId(),n=this.options.excludeLayers;return!(n.length&&n.indexOf(e)>=0)},n._renderLayer=function(t,e,n=!0){var i=this,o=Pi("li","layer"),s=Pi("label"),a=Pi("input"),l=this.getMap(),h=t.options.visible;t.options.visible=!0;var c=t.isVisible();t.options.visible=h,o.className="layer";var u=a;return e?(u.type="radio",u.name="base"):u.type="checkbox",u.checked=h&&c,n||(u.checked=!1),c||u.setAttribute("disabled","disabled"),u.onchange=function(e){if("radio"===e.target.type){var n=l.getBaseLayer(),o=n.layers;if(o)for(var s=0,a=o.length;s<a;s++){var h=o[s];h[h===t?"show":"hide"]()}else n.isVisible()||n.show();l._fireEvent("setbaselayer")}else t[e.target.checked?"show":"hide"]();i.fire("layerchange",{target:t})},o.appendChild(a),s.innerHTML=t.getId(),o.appendChild(s),o._layer=t,o},e}(qg);Yg.mergeOptions({position:"top-right",baseTitle:"Base Layers",overlayTitle:"Layers",excludeLayers:[],containerClass:"ispace-layer-switcher"}),Lf.mergeOptions({layerSwitcherControl:!1}),Lf.addOnLoadHook((function(){this.options.layerSwitcherControl&&(this.layerSwitcherControl=new Yg(this.options.layerSwitcherControl),this.addControl(this.layerSwitcherControl))}));var Kg=function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n.buildOn=function(){var t=this.options.size;this.options.maximize||(t=[0,0]);var e=Pi("div");this._appendCustomClass(e);var n=this.mapContainer=Pi("div");n.style.width=t[0]+"px",n.style.height=t[1]+"px",n.className=this.options.containerClass;var i=this.button=Pi("div");return i.className=this.options.buttonClass,e.appendChild(n),e.appendChild(i),e},n.onAdd=function(){this.options.maximize&&this._createOverview(),this.getMap().on("resize moving zooming rotate dragrotating viewchange",this._update,this).on("setbaselayer",this._updateBaseLayer,this).on("spatialreferencechange",this._updateSpatialReference,this),or(this.button,"click",this._onButtonClick,this),this._updateButtonText()},n.onRemove=function(){this.getMap().off("resize moving zooming rotate dragrotating viewchange",this._update,this).off("setbaselayer",this._updateBaseLayer,this).off("spatialreferencechange",this._updateSpatialReference,this),this._overview&&(this._overview.remove(),delete this._overview,delete this._perspective),sr(this.button,"click",this._onButtonClick)},n.maxmize=function(){var t=this.options.size,e=this.mapContainer;return e.style.width=t[0]+"px",e.style.height=t[1]+"px",this._createOverview(),this},n.minimize=function(){this._overview&&this._overview.remove(),delete this._overview,delete this._perspective;var t=this.mapContainer;return t.style.width="0px",t.style.height="0px",this},n.getOverviewMap=function(){return this._overview},n._onButtonClick=function(){this._overview?this.minimize():this.maxmize(),this._updateButtonText()},n._updateButtonText=function(){this.button.innerHTML=this._overview?"-":"+"},n._createOverview=function(){var t=this.getMap(),e=this.mapContainer,n=t.config();l(n,{center:t.getCenter(),zoom:this._getOverviewZoom(),zoomAnimationDuration:150,pitch:0,bearing:0,scrollWheelZoom:!1,checkSize:!1,doubleClickZoom:!1,touchZoom:!1,control:!1,draggable:!1,maxExtent:null}),this._overview=new Lf(e,n),this._updateBaseLayer(),this._perspective=new od(this._getPerspectiveCoords(),{draggable:!0,cursor:"move",symbol:this.options.symbol}).on("dragend",this._onDragEnd,this),new Zd("perspective_layer",this._perspective).addTo(this._overview),this.fire("load")},n._getOverviewZoom=function(){var t=this.getMap(),e=t.getZoom(),n=t.getMinZoom(),i=this.options.level;if(i>0){for(var o=i;o>0;o--)if(e-o>=n)return e-o}else for(var s=i;s<0;s++)if(e-s>=n)return e-s;return e},n._onDragEnd=function(){var t=this._perspective.getCenter();this._overview.setCenter(t),this.getMap().panTo(t)},n._getPerspectiveCoords=function(){var t=this.getMap(),e=t.getProjection();return t.getContainerExtent().toArray().map((function(n){if(e){var i=t._containerPointToPrj(n);return t._fixPrjOnWorldWide(i),e.unproject(i)}return t.containerPointToCoordinate(n)}))},n._update=function(){if(this._overview){Wi(this._overview.getContainer());var t=this._getPerspectiveCoords();this._perspective.setCoordinates(t),this._overview.setCenterAndZoom(this.getMap().getCenter(),this._getOverviewZoom())}},n._updateSpatialReference=function(){if(this._overview){var t=this.getMap();this._overview.setSpatialReference(t.options.spatialReference)}},n._updateBaseLayer=function(){if(this._overview){var t=this.getMap().getBaseLayer();if(t){var e=t.layers,n=0;if(e)for(var i=0,o=e.length;i<o;i++){if(e[i].isVisible()){n=i;break}}var s=t.toJSON(),a=null;e?(a=s.layers[n].options).visible=!0:a=s.options,this._overview.setMinZoom(a.minZoom||null).setMaxZoom(a.maxZoom||null),delete a.minZoom,delete a.maxZoom,delete s.options.canvas,s.options.visible=!0,s.options.renderer="canvas";var l=Pf.fromJSON(s);for(var h in t)A(t[h])&&t.hasOwnProperty(h)&&t[h]!==t.constructor.prototype[h]&&(l[h]=t[h]);this._overview.setBaseLayer(l)}else this._overview.setBaseLayer(null)}},e}(qg);Kg.mergeOptions({level:4,position:{right:1,bottom:1},size:[300,200],maximize:!0,symbol:{lineWidth:3,lineColor:"#1bbc9b",polygonFill:"#1bbc9b",polygonOpacity:.4},containerClass:"ispace-overview",buttonClass:"ispace-overview-button"}),Lf.mergeOptions({overviewControl:!1}),Lf.addOnLoadHook((function(){this.options.overviewControl&&(this.overviewControl=new Kg(this.options.overviewControl),this.addControl(this.overviewControl))}));var $g=function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n.buildOn=function(){var t,e=this;if(this.options.custom)g(this.options.content)?((t=Pi("div")).innerHTML=this.options.content,this._appendCustomClass(t)):t=this.options.content;else{if(t=Pi("div","ispace-panel"),this._appendCustomClass(t),this.options.closeButton){var n=Pi("a","ispace-close");n.innerText="",n.href="javascript:;",n.onclick=function(){t.style.display="none",e.fire("close")},t.appendChild(n)}var i=Pi("div","ispace-panel-content");g(this.options.content)?i.innerHTML=this.options.content:i.appendChild(this.options.content),t.appendChild(i)}return this.draggable=new dh(t,{cancelOn:this._cancelOn.bind(this),ignoreMouseleave:!0}),this.draggable.on("dragstart",this._onDragStart,this).on("dragging",this._onDragging,this).on("dragend",this._onDragEnd,this),this.options.draggable&&this.draggable.enable(),t},n.update=function(){return this.draggable&&(this.draggable.disable(),delete this.draggable),qg.prototype.update.call(this)},n.setContent=function(t){var e=this.options.content;return this.options.content=t,this.fire("contentchange",{old:e,new:t}),this.isVisible()&&this.update(),this},n.getContent=function(){return this.options.content},n._cancelOn=function(t){var e=(t.srcElement||t.target).tagName.toLowerCase();return"button"===e||"input"===e||"select"===e||"option"===e||"textarea"===e},n._onDragStart=function(t){this._startPos=t.mousePos,this._startPosition=l({},this.getPosition()),this.fire("dragstart",t)},n._onDragging=function(t){var e=t.mousePos.sub(this._startPos),n=this._startPosition,i=this.getPosition();h(i.top)||(i.top=parseInt(n.top)+e.y),h(i.bottom)||(i.bottom=parseInt(n.bottom)-e.y),h(i.left)||(i.left=parseInt(n.left)+e.x),h(i.right)||(i.right=parseInt(n.right)-e.x),this.setPosition(i),this.fire("dragging",t)},n._onDragEnd=function(t){delete this._startPos,delete this._startPosition,this.fire("dragend",t)},n._getConnectPoints=function(){var t=this.getMap(),e=this.getContainerPoint(),n=this.getDOM(),i=parseInt(n.clientWidth+""),o=parseInt(n.clientHeight+"");return[t.containerPointToCoordinate(e.add(i/2,0)),t.containerPointToCoordinate(e.add(i,o/2)),t.containerPointToCoordinate(e.add(i/2,o)),t.containerPointToCoordinate(e.add(0,o/2))]},e}(qg);$g.mergeOptions({position:"top-right",draggable:!0,custom:!1,content:"",closeButton:!0});var tp=function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n.buildOn=function(){var t=this._getReset();return this._appendCustomClass(t),this._reset=t,this._registerDomEvents(),t},n.onAdd=function(){this._view=this.options.view?this.options.view:this.getMap().getView()},n.setView=function(t){this._view=t},n._getReset=function(){return Pi("div","ispace-reset")},n._registerDomEvents=function(){or(this._reset,"click",this._resetView,this)},n.onRemove=function(){delete this._reset,delete this._view},n._resetView=function(){this.getMap().setView(this._view)},e}(qg);tp.mergeOptions({position:{top:156,left:20},view:null}),Lf.mergeOptions({resetControl:!1}),Lf.addOnLoadHook((function(){this.options.resetControl&&(this.resetControl=new tp(this.options.resetControl),this.addControl(this.resetControl))}));var ep="zoomend moving moveend",np=function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n.buildOn=function(t){return this._map=t,this._scaleContainer=Pi("div",this.options.containerClass),this._addScales(),t.on(ep,this._update,this),this._map.isLoaded()&&this._update(),this._appendCustomClass(this._scaleContainer),this._scaleContainer},n.onRemove=function(){this.getMap().off(ep,this._update,this)},n._addScales=function(){var t="border: 2px solid #000000;border-top: none;line-height: 1.1;padding: 0px;color: #000000;font-size: 11px;text-align:center;white-space: nowrap;overflow: hidden;-moz-box-sizing: content-box;box-sizing: content-box;background: #fff; background: rgba(255, 255, 255, 0);";this.options.metric&&(this._mScale=Ii("div",this.options.containerClass?null:t,this._scaleContainer)),this.options.imperial&&(this._iScale=Ii("div",this.options.containerClass?null:t,this._scaleContainer))},n._update=function(){var t=this._map.pixelToDistance(this.options.maxWidth,0);this._updateScales(t)},n._updateScales=function(t){this.options.metric&&t&&this._updateMetric(t),this.options.imperial&&t&&this._updateImperial(t)},n._updateMetric=function(t){var e=this._getRoundNum(t);this._updateScale(this._mScale,e<1e3?e+" m":e/1e3+" km",e/t)},n._updateImperial=function(t){var e,n,i,o=3.2808399*t;o>5280?(n=this._getRoundNum(e=o/5280),this._updateScale(this._iScale,n+" mile",n/e)):(i=this._getRoundNum(o),this._updateScale(this._iScale,i+" feet",i/o))},n._updateScale=function(t,e,n){t.style.width=Math.round(this.options.maxWidth*n)+"px",t.innerHTML=e},n._getRoundNum=function(t){var e=Math.pow(10,(Math.floor(t)+"").length-1),n=t/e;return e*(n=n>=10?10:n>=5?5:n>=3?3:n>=2?2:1)},e}(qg);np.mergeOptions({position:"bottom-left",maxWidth:100,metric:!0,imperial:!1,containerClass:null}),Lf.mergeOptions({scaleControl:!1}),Lf.addOnLoadHook((function(){this.options.scaleControl&&(this.scaleControl=new np(this.options.scaleControl),this.addControl(this.scaleControl))}));var ip=function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n.buildOn=function(t){this._map=t;var e=Pi("div"),n=Pi("ul","ispace-toolbar-hx");e.appendChild(n),Qi(e,this.options.vertical?"ispace-toolbar-vertical":"ispace-toolbar-horizonal");var i=this;function o(t,e,n,o){var s=i._getItems()[e];return function(i){return zi(i),t({target:s,index:e,childIndex:n,dom:o})}}var s=this.options.items;if(Je(s))for(var a=0,l=s.length;a<l;a++){var h=s[a],c=Pi("li");if(28!==this.options.height&&(c.style.lineHeight=this.options.height+"px"),c.style.height=this.options.height+"px",c.style.cursor="pointer",tr(h.item)){c.style.textAlign="center";var u=er("div",h.item);c.innerHTML='<div style="margin-top:'+(this.options.height-u.height)/2+'px;">'+h.item+"</div>"}else c.innerHTML=h.item;if(h.click&&or(c,"click",o(h.click,a,null,c)),Je(h.children)){var f=this._createDropMenu(a);c.appendChild(f),c._menu=f,or(c,"mouseover",(function(){this._menu.style.display=""})),or(c,"mouseout",(function(){this._menu.style.display="none"}))}n.appendChild(c)}return this._appendCustomClass(e),e},n._createDropMenu=function(t){var e=this;function n(t,n,i){var o=e._getItems()[n].children[i];return function(e){return zi(e),t({target:o,index:n,childIndex:i})}}var i=Pi("div","ispace-dropMenu"),o=this._getItems(),s=o.length,a=Pi("ul"),l=o[t].children;t===s-1&&l&&(i.style.cssText="right: 0px;",a.style.cssText="right: 0px;position: absolute;",this.options.reverseMenu&&(a.style.bottom="0")),i.appendChild(Pi("em","ispace-ico"));for(var h=0,c=0,u=l.length;c<u;c++){var f=li(l[c].item,"12px");f.width>h&&(h=f.width)}for(var g=0,A=l.length;g<A;g++){var m=l[g],w=Pi("li");w.innerHTML='<a href="javascript:;">'+m.item+"</a>",w.style.cursor="pointer",w.style.width=h+24+"px",or(w.childNodes[0],"click",n(m.click,t,g)),a.appendChild(w)}if(this.options.vertical){var T=h<95?95:h;this.options.reverseMenu?i.style.right=-(T+20+2)+"px":i.style.left=-(T+20+2)+"px"}else this.options.reverseMenu?i.style.bottom="28px":i.style.top="29px";return i.appendChild(a),i.style.display="none",i},n._getItems=function(){return this.options.items||[]},e}(qg);ip.mergeOptions({height:28,vertical:!1,position:"top-right",reverseMenu:!1,items:[]});var rp=function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n.buildOn=function(t){var e=this.options,n=Pi("div","ispace-zoom");if(this._appendCustomClass(n),e.zoomLevel){var i=Pi("span","ispace-zoom-zoomlevel"),o=Pi("span","ispace-zoom-zoomlevel-text");i.appendChild(o),n.appendChild(i),this._levelDOM=o}var s=Pi("div","ispace-zoom-slider"),a=Pi("a","ispace-zoom-zoomin");a.href="javascript:;",s.appendChild(a),this._zoomInButton=a;var l=Pi("a","ispace-zoom-zoomout");return l.href="javascript:;",s.appendChild(l),this._zoomOutButton=l,n.appendChild(s),t.on("_zoomend _zooming _zoomstart _spatialreferencechange",this._update,this),this._update(),this._registerDomEvents(),n},n.onRemove=function(){this.getMap().off("_zoomend _zooming _zoomstart _spatialreferencechange",this._update,this)},n._update=function(){this._updateText()},n._updateText=function(){if(this._levelDOM){var t=this.getMap().getZoom();u(t)||(t=Math.floor(10*t)/10),this._levelDOM.innerHTML=t+""}},n._registerDomEvents=function(){this._zoomInButton&&or(this._zoomInButton,"click",this._onZoomInClick,this),this._zoomOutButton&&or(this._zoomOutButton,"click",this._onZoomOutClick,this)},n._onZoomInClick=function(t){Hi(t),this.getMap().zoomIn()},n._onZoomOutClick=function(t){Hi(t),this.getMap().zoomOut()},e}(qg);rp.mergeOptions({position:"top-left",zoomLevel:!0,seamless:!1}),Lf.mergeOptions({zoomControl:!1}),Lf.addOnLoadHook((function(){this.options.zoomControl&&(this.zoomControl=new rp(this.options.zoomControl),this.addControl(this.zoomControl))}));var op=Object.freeze({__proto__:null,Attribution:Jg,Compass:Qg,Control:qg,LayerSwitcher:Yg,Overview:Kg,Panel:$g,Reset:tp,Scale:np,Toolbar:ip,Zoom:rp}),sp=function(){function t(t,e,n,i){Array.isArray(t)?(this.scale={x:t[0],y:t[1]},this.origin={x:t[2],y:t[3]}):(this.scale={x:t,y:e},this.origin={x:n,y:i})}return t.getDefault=function(t){var e=t.code.toLowerCase();return"baidu"===e?"baidu":e==="EPSG:4326".toLowerCase()||e==="EPSG:4490".toLowerCase()?"tms-global-geodetic":"identity"===e?[1,-1,0,0]:"web-mercator"},t}(),ap=6378137*Math.PI;l(sp,{"web-mercator":new sp([1,-1,-ap,ap]),"tms-global-mercator":new sp([1,1,-ap,-ap]),"tms-global-geodetic":new sp([1,1,-180,-90]),baidu:new sp([1,1,0,0])});for(var lp=function(){function t(t,e,n,i){this.map=t,this.tileSize=i,this.fullExtent=n,this.prepareTileInfo(e,n),this._xScale=n.right>=n.left?1:-1,this._yScale=n.top>=n.bottom?1:-1;var o=t.getGLRes();this._pointOrigin=t._prjToPointAtRes(new _e(this.tileSystem.origin),o),this._glRes=o}var e=t.prototype;return e.prepareTileInfo=function(t,e){if(g(t)?t=sp[t.toLowerCase()]:Array.isArray(t)&&(t=new sp(t)),!t)throw new Error("Invalid TileSystem");this.tileSystem=t,this.transformation=new Eh([e.right>e.left?1:-1,e.top>e.bottom?-1:1,t.origin.x,t.origin.y])},e._getTileNum=function(t,e){var n=this.tileSystem,i=this.tileSize,o=Math.floor(1e-7*n.scale.x+t.x/(i.width*e)),s=Math.ceil(1e-7*n.scale.y+t.y/(i.height*e));return{x:n.scale.x*o,y:n.scale.y*s}},e.getTileIndex=function(t,e,n){var i=this.tileSystem,o=this.transformation.transform(t,1),s=this._getTileNum(o,e);return i.scale.x<0&&(s.x-=1),i.scale.y>0&&(s.y-=1),this.getNeighorTileIndex(s.x,s.y,0,0,e,n)},e.getNeighorTileIndex=function(t,e,n,i,o,s){var a=this.tileSystem,l=t+a.scale.x*n,h=e-a.scale.y*i,c=!1,u=l,f=h,g=this._getTileFullIndex(o);return s&&(!0!==s&&"x"!==s||(g.xmax===g.xmin?l=g.xmin:l<g.xmin?(l=g.xmax-(g.xmin-l)%(g.xmax-g.xmin))===g.xmax&&(l=g.xmin):l>=g.xmax&&(l=g.xmin+(l-g.xmin)%(g.xmax-g.xmin))),!0!==s&&"y"!==s||(g.ymax===g.ymin?h=g.ymin:h>=g.ymax?h=g.ymin+(h-g.ymin)%(g.ymax-g.ymin):h<g.ymin&&(h=g.ymax-(g.ymin-h)%(g.ymax-g.ymin))===g.ymax&&(h=g.ymin))),(l<g.xmin||l>g.xmax||h>g.ymax||h<g.ymin)&&(c=!0),{x:l,y:h,idx:u,idy:f,out:c}},e._getTileFullIndex=function(t){if(this._tileFullIndex||(this._tileFullIndex={}),this._tileFullIndex[t])return this._tileFullIndex[t];var e=this.fullExtent,n=this.transformation,i=this._getTileNum(n.transform(new gh(e.left,e.top),1),t),o=this._getTileNum(n.transform(new gh(e.right,e.bottom),1),t),s=this.tileSystem;return s.scale.x<0&&(i.x-=1,o.x-=1),s.scale.y>0&&(i.y-=1,o.y-=1),this._tileFullIndex[t]=new Ph(i,o,null),this._tileFullIndex[t]},e.getTilePrjNW=function(t,e,n,i){var o=this.tileSystem,s=this.tileSize,a=o.origin.y+this._yScale*o.scale.y*(e+(1===o.scale.y?1:0))*n*s.height,l=o.origin.x+this._xScale*o.scale.x*(t+(1===o.scale.x?0:1))*n*s.width;return i?(i.set(l,a),i):new gh(l,a)},e.getTilePointNW=function(t,e,n,i){var o=this._glRes/n,s=this.tileSystem,a=this.tileSize,l=this._pointOrigin.y*o+this._yScale*s.scale.y*(e+(1===s.scale.y?1:0))*a.height,h=this._pointOrigin.x*o+this._xScale*s.scale.x*(t+(1===s.scale.x?0:1))*a.width;return i?(i.set(h,l),i):new _e(h,l)},e.getTilePrjSE=function(t,e,n,i){var o=this.tileSystem,s=this.tileSize,a=o.origin.y+this._yScale*o.scale.y*(e+(1===o.scale.y?0:1))*n*s.height,l=o.origin.x+this._xScale*o.scale.x*(t+(1===o.scale.x?1:0))*n*s.width;return i?(i.set(l,a),i):new gh(l,a)},e.getTilePointSE=function(t,e,n,i){var o=this._glRes/n,s=this.tileSystem,a=this.tileSize,l=this._pointOrigin.y*o+this._yScale*s.scale.y*(e+(1===s.scale.y?0:1))*a.height,h=this._pointOrigin.x*o+this._xScale*s.scale.x*(t+(1===s.scale.x?1:0))*a.width;return i?(i.set(h,l),i):new _e(h,l)},e.getTilePrjExtent=function(t,e,n){var i=this.getTilePrjNW(t,e,n),o=this.getTilePrjSE(t,e,n);return new Ph(i,o)},t}(),hp=[],cp=0
/*!
  * Contains code from THREE.js
  * MIT License
  * https://github.com/mrdoob/three.js
  */;cp<6;cp++)hp[cp]=[];var up=[];function fp(t,e,n){!function(t){var e=t,n=e[0],i=e[1],o=e[2],s=e[3],a=e[4],l=e[5],h=e[6],c=e[7],u=e[8],f=e[9],g=e[10],A=e[11],m=e[12],w=e[13],T=e[14],M=e[15];gp(hp[0],s-n,c-a,A-u,M-m),gp(hp[1],s+n,c+a,A+u,M+m),gp(hp[2],s+i,c+l,A+f,M+w),gp(hp[3],s-i,c-l,A-f,M-w),gp(hp[4],s-o,c-h,A-g,M-T),gp(hp[5],s+o,c+h,A+g,M+T)}(t);for(var i=0;i<6;i++){var o=hp[i];if(up[0]=o[0]>0?e[1][0]:e[0][0],up[1]=o[1]>0?e[1][1]:e[0][1],up[2]=o[2]>0?e[1][2]:e[0][2],pp(o,up)<0)return!1}return!0}var dp=1/6;function gp(t,e,n,i,o){return t[0]=e*dp,t[1]=n*dp,t[2]=i*dp,t[3]=o*dp,t}function pp(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]}var Ap,mp=new _e(0,0),yp="undefined"!=typeof Set,_p=function(){function t(){this._table=yp?new Set:{}}var e=t.prototype;return e.add=function(t){yp?this._table.add(t):this._table[t]=!0},e.has=function(t){return yp?this._table.has(t):this._table[t]},e.reset=function(){yp?this._table.clear():this._table={}},t}(),vp={urlTemplate:null,subdomains:null,errorUrl:null,repeatWorld:!0,background:!0,loadingLimitOnInteracting:3,loadingLimit:0,placeholder:!1,crossOrigin:null,tileSize:[256,256],offset:[0,0],tileSystem:null,fadeAnimation:!n,fadeDuration:1e3/60*10,debug:!1,spatialReference:null,maxCacheSize:256,renderer:Gt.webgl?"gl":"canvas",clipByPitch:!0,maxAvailableZoom:null,cascadeTiles:!0,zoomOffset:0,pyramidMode:1,decodeImageInWorker:!1,tileLimitPerFrame:0,tileStackStartDepth:7,tileStackDepth:6,awareOfTerrain:!0,bufferPixel:.5,mipmapTexture:!0,depthMask:!0,currentTilesFirst:!0,forceRenderOnMoving:!0,tileErrorScale:1},xp=/\{ *([\w_]+) *\}/g,bp=new _e(0,0),wp=new _e(0,0),Tp=new _e(0,0),Mp=new _e(0,0),Cp=new _e(0,0),Sp=new _e(0,0),Pp=[[0,0,0],[0,0,0]],Ip=[0,0,0],Op=[0,0,0],Ep=[0,0,0],kp=function(t){function e(e,n){return t.call(this,e,n)||this}he(e,t),e.fromJSON=function(t){return t&&"TileLayer"===t.type?new e(t.id,t.options):null};var n=e.prototype;return n.forceReload=function(){return this.fire("forcereloadstart"),this.clear(),this._renderer&&this._renderer.setToRedraw(),this.fire("forcereloadend"),this},n.getTileSize=function(t){if(this._tileSize)return this._tileSize;var e=this.options.tileSize;return c(e)&&(e=[e,e]),this._tileSize=new qn(e),this._tileSize},n.getTiles=function(t,e){var n,i=this;if(this._coordCache={},n=this._isPyramidMode()?this._getPyramidTiles(t,e):this._getCascadeTiles(t,e),!this._maskGeoJSON)return n;var o=0;return(n.tileGrids||[]).forEach((function(t){t.tiles=(t.tiles||[]).filter((function(t){return i._tileInMask(t)})),o+=t.tiles.length;var e=t.tiles.map((function(t){return t.parent}));t.parents=(t.parents||[]).filter((function(t){return e.indexOf(t.id)>-1}))})),n.count=o,n},n._isPyramidMode=function(){var t=this._spatialRef||this.getSpatialReference();return!this._disablePyramid&&!this._hasOwnSR&&this.options.pyramidMode&&t&&t.isPyramid()},n._getTileFullExtent=function(){if(this._tileFullExtent)return this._tileFullExtent;var t=this.getSpatialReference(),e=t.getFullExtent(),n=t.getResolution(0),i=this.getMap();return this._tileFullExtent=e.convertTo((function(t){return i._prjToPointAtRes(t,n,mp)})),this._tileFullExtent},n._getRootNodes=function(t){var e=this.getMap();if(this._rootNodes){var{tiles:n,mapWidth:i,mapHeight:o}=this._rootNodes;if(e.width!==i||e.height!==o){for(var s=this._getRootError(),a=0;a<n.length;a++)n[a].error=s;this._rootNodes.mapWidth=e.width,this._rootNodes.mapHeight=e.height}for(var l=0;l<n.length;l++)n[l].offset[0]=t[0],n[l].offset[1]=t[1];return this._rootNodes}var h=this._spatialRef||this.getSpatialReference(),c=h.getResolution(0),u=this._getTileConfig(),f=h.getFullExtent(),{origin:g,scale:A}=u.tileSystem,m=u.getTilePrjExtent(0,0,c),w=m.getWidth(),T=m.getHeight(),M=1e-5,C=Math.abs((g.x-f.left)/w);C=Math.ceil(C-M);var P=Math.abs((f.right-g.x)/w);P=Math.ceil(P-M);var I=Math.ceil(Math.abs(f.top-g.y)/T);I=Math.ceil(I-M);var O=Math.ceil(Math.abs(f.bottom-g.y)/T);if((P+C)*((O=Math.ceil(O-M))+I)>32)return{status:0,error:"Too many root nodes"};for(var E=this._getRootError(),D=[],N=-C;N<P;N++)for(var H=-I;H<O;H++){var U=A.y<0?H:-(H+1);D.push(this.createTileNode(N,U,0,N,U,c,E))}return this._rootNodes={status:1,tiles:D,mapWidth:e.width,mapHeight:e.height},this._getRootNodes(t)},n.createTileNode=function(t,e,n,i,o,s,a,l,h,c){var u=this.map,f=this.options.zoomOffset;h||(h=this._getTileConfig().getTilePrjExtent(t,e,s).convertTo((function(t){return u._prjToPointAtRes(t,s,mp)})));var g=this._getTileOffset(n),A=this.getTileUrl(t,e,n+f);return{parent:l,layer:this.getId(),x:t,y:e,z:n,idx:i,idy:o,res:s,extent2d:h,id:c||this._getTileId(t,e,n),url:vr(A),offset:g,error:a,children:[]}},n._getRootError=function(){var t=this.getMap(),e=M(t.getFov()),n=t.width/t.height,i=t.cameraPosition[2],o=i*Math.tan(.5*e),s=o*n,a=Math.sqrt(i*i+o*o+s*s);return t._getFovZ(0)*(a/i)*(this._spatialRef||this.getSpatialReference()).getResolution(0)/t.getResolution(0)},n._getPyramidTiles=function(t,e){var n=this.map;isNaN(+t)&&(t=this._getTileZoom(n.getZoom()));var i,o=this._spatialRef||this.getSpatialReference(),s=Math.min(t,this.getMaxZoom(),this.getMaxAvailableZoom()||1/0),a=n.projViewMatrix,l=this._getTileFullExtent(),h=this._getTileOffset(0);if(this.options.repeatWorld){var c=n.getContainerExtent(),u=this._convertToExtent2d(c),f=o.getResolution(0)/n.getResolution();if(u.within(l.copy()._scale(f))){var g=this._getRootNodes(h);if(1!==g.status)return console.warn(g.error),this._disablePyramid=!0,this.getTiles(t,e);i=[...g.tiles]}else{var A=n.getPitch(),m=n.options.cascadePitches[1],w=Math.floor(n._getVisualHeight(m)),T=A<=m?c:new Oh(0,n.height-w,n.width,n.height);this._visitedTiles=new _p;var M=this._getTiles(0-this.options.zoomOffset,T,2,e&&e.getRenderer(),!0),C=this._getRootError()*Math.pow(2,this.options.zoomOffset);M.tiles.forEach((function(t){t.error=C})),i=M.tiles}}else{var P=this._getRootNodes(h);if(1!==P.status)return console.warn(P.error),this._disablePyramid=!0,this.getTiles(t,e);i=[...P.tiles]}for(var I=n.getGLRes(),O={0:h},E=new Oh,D=[],N=[],H=e&&e.getRenderer();i.length>0;){var U=i.pop();U.z!==s?(O[U.z+1]||(O[U.z+1]=this._getTileOffset(U.z+1)),this._splitNode(U,a,i,D,N,t,E,s,O[U.z+1],H,I)):(E._combine(U.extent2d),D.push(U))}return N.sort(Rp),this._debugTile(D,"_getPyramidTiles"),{tileGrids:[{extent:E,count:D.length,tiles:D,parents:N,offset:[0,0],zoom:t}],count:D.length}},n.isParentTile=function(t,e,n){var i=Math.max(this.getMinZoom(),t-this.options.tileStackStartDepth);return n.z>=i&&n.z<i+this.options.tileStackDepth&&n.z<e},n._splitNode=function(t,e,n,i,o,s,a,l,h,c,u){var f=t.z+1,g=this._spatialRef||this.getSpatialReference(),{idx:A,idy:m}=t,w=c||this.getRenderer(),T=!1,M=[],C=g.getResolution(f)/u;this.tileInfoCache||(this.tileInfoCache=new Xa(4*this.options.maxCacheSize));for(var P=0;P<4;P++){var I=P%2,O=P>>1;t.children||(t.children=[]);var E=t.children[P];if(!E)E=this._getTileId((A<<1)+I,(m<<1)+O,f),t.children[P]=E;var D=w.isTileCachedOrLoading(E),N=D&&D.info;N||(N=this.tileInfoCache.get(E))||(N=this._createChildNode(t,I,O,h,E)),N.error=t.error/2,N.offset[0]=h[0],N.offset[1]=h[1];var H=this._isTileVisible(N,e,C,l,h);if(H===Ap.VISIBLE)T=!0;else{if(H===Ap.OUT_OF_FRUSTUM)continue;if(H===Ap.SCREEN_ERROR_TOO_SMALL&&f!==l)return i.push(t),void a._combine(t.extent2d)}M.push(N)}f===l?T?ke(n,M):(i.push(t),a._combine(t.extent2d)):ke(n,M),this.isParentTile(s,l,t)&&o.push(t)},n._createChildNode=function(t,e,n,i,o){var s,{x:a,y:l,idx:h,idy:c,extent2d:u}=t,f=t.z+1,g=(a<<1)+e,A=(l<<1)+n,m=(h<<1)+e,w=(c<<1)+n,T=u.getWidth()/2*2,M=u.getHeight()/2*2,C=2*u.xmin,P=2*u.ymax,I=2*u.ymin,O=this._getTileConfig().tileSystem.scale.y;if(o=o||this._getTileId(m,w,f),O<0){var E=C+e*T,D=P-n*M;s=new Oh(E,D-M,E+T,D)}else{var N=C+e*T,H=I+n*M;s=new Oh(N,H,N+T,H+M)}var U=this.createTileNode(g,A,f,m,w,t.res/2,t.error/2,t.id,s,o);return this.tileInfoCache.add(o,U),U},n._isTileVisible=function(t,e,n,i,o){if(0===t.z)return Ap.VISIBLE;if(!this._isTileInFrustum(t,e,n,o))return Ap.OUT_OF_FRUSTUM;var s=this.options.maxError;return h(s)&&(s=1),this._getScreenSpaceError(t,n,i,o)>=s?Ap.VISIBLE:Ap.SCREEN_ERROR_TOO_SMALL},n._isTileInFrustum=function(t,e,n,i){if(!this._zScale){var o=this.getMap(),s=o.getGLRes();this._zScale=o.altitudeToPoint(100,s)/100}var a=this.getRenderer(),{xmin:l,ymin:h,xmax:c,ymax:u}=t.extent2d;if(t.offset&&0!==t.offset[0]&&0!==t.offset[1]&&!A(this.options.offset)){var[f,g]=t.offset;l+=f,c+=f,h+=g,u+=g}return Pp[0][0]=(l-i[0])*n,Pp[0][1]=(h-i[1])*n,Pp[0][2]=(t.minAltitude||a&&a.avgMinAltitude||0)*this._zScale,Pp[1][0]=(c-i[0])*n,Pp[1][1]=(u-i[1])*n,Pp[1][2]=(t.maxAltitude||a&&a.avgMaxAltitude||0)*this._zScale,fp(e,Pp)},n._getScreenSpaceError=function(t,e,n,i){var o=t.error,s=this.map,{xmin:a,ymin:l,xmax:h,ymax:c}=t.extent2d;Ip[0]=(a-i[0])*e,Ip[1]=(l-i[1])*e,Op[0]=(h-i[0])*e,Op[1]=(c-i[1])*e;var u=function(t,e,n){var i=Math.max(t[0]-n[0],0,n[0]-e[0]),o=Math.max(t[1]-n[1],0,n[1]-e[1]),s=Math.max(t[2]-n[2],0,n[2]-e[2]);return Math.sqrt(i*i+o*o+s*s)}(Ip,Op,s.cameraPosition),f=Math.max(Math.abs(u),1e-7),g=Math.abs(t.z-n),A=o*(s.height<1e3||g<=1?1:g<=2?.7:.605)/f*this.options.tileErrorScale;return s.getPitch()<=60?1.45*A:A},n._getCascadeTiles=function(t,e){var n=this.getMap(),i=n.getPitch(),o=e&&e.getRenderer(),s=n.getContainerExtent(),a=[],l=0,c=this.getMinZoom(),u=n.options.cascadePitches[0],f=n.options.cascadePitches[1],g=Math.floor(n._getVisualHeight(f)),A=h(t)?this._getTileZoom(n.getZoom()):t;if(this._visitedTiles=new _p,!h(t)||!this.options.cascadeTiles||i<=u||!h(c)&&A<=c){var m=i<=f?s:new Oh(0,n.height-g,n.width,n.height),w=this._getTiles(A,m,2,o);return w&&(l+=w.tiles.length,a.push(w)),{tileGrids:a,count:l}}var T=Math.floor(n._getVisualHeight(u)),M=new Oh(0,n.height-T,n.width,n.height),C=this._getTiles(A,M,0,o);l+=C?C.tiles.length:0,a.push(C);var P,I,O=M.ymin,E=n.getSpatialReference().getZoomDirection(),D=E;if(i>f){A-D<=c&&(D=0);var N=new Oh(0,n.height-g,n.width,O);l+=(P=this._getTiles(A-D,N,1,o))?P.tiles.length:0,O=N.ymin,D+=4*E,a.push(P)}if(A-D>=c){var H=new Oh(0,s.ymin,n.width,O);l+=(I=this._getTiles(A-D,H,2,o))?I.tiles.length:0,a.push(I)}return P&&I&&(a[1]=I,a[2]=P),{tileGrids:a,count:l}},n.getTileUrl=function(t,e,n){var i=this.options.urlTemplate,o="",s=this.options.subdomains;if(s&&Je(s)){var a=(t+e)%s.length;a<0&&(a=0),o=s[a]}if(A(i))return i(t,e,n,o);var h={x:t,y:e,z:n,s:o};return this.options.token&&(h.token=this.options.token),this.options.customTags&&l(h,this.options.customTags),i.replace(xp,(function(t,e){var n=h[e];if(void 0===n)throw new Error("No value provided for variable "+t);return"function"==typeof n&&(n=n(h)),n}))},n.clear=function(){return this._renderer&&this._renderer.clear(),this.tileInfoCache&&this.tileInfoCache.reset(),this.fire("clear"),this},n.toJSON=function(){return{type:this.getJSONType(),id:this.getId(),options:this.config()}},n.getSpatialReference=function(){var t=this.getMap();if(t&&(!this.options.spatialReference||sf.equals(this.options.spatialReference,t.options.spatialReference)))return t.getSpatialReference();if(this._sr)return this._sr;var e=this.options.spatialReference;if(g(e)&&!(e=sf.getPreset(e)))throw new Error("Unsupported spatial reference: "+this.options.spatialReference+", possible values: "+sf.getAllPresets().join());return this._sr=new sf(e),this._srMinZoom=this._sr.getMinZoom(),this._srMaxZoom=this._sr.getMaxZoom(),this._hasOwnSR=this._sr.toJSON().projection!==t.getSpatialReference().toJSON().projection,this._sr},n.getMinZoom=function(){var t=this.options.minZoom||0;return(this._spatialRef||this.getSpatialReference())!==this.getMap().getSpatialReference()?Math.max(t,this._srMinZoom):t},n.getMaxZoom=function(){return(this._spatialRef||this.getSpatialReference())!==this.getMap().getSpatialReference()?Math.min(t.prototype.getMaxZoom.call(this),this._srMaxZoom):t.prototype.getMaxZoom.call(this)},n._getTileZoom=function(t){if(!this._hasOwnSR){var e=this.getMap().getResolution(t),n=this.getSpatialReference().getResolution(t);t+=Math.log(n/e)*Math.LOG2E}var i=this.getMaxAvailableZoom();return!h(i)&&t>i&&(t=i),u(t)||(t=Math.round(t)),t=Math.max(0,t)},n.getMaxAvailableZoom=function(){var t=this._spatialRef||this.getSpatialReference();return this.options.maxAvailableZoom||t&&t.getMaxZoom()},n._getTiles=function(t,e,n,i,o){var s=this.getMap(),a=t,l=s.projViewMatrix,c=s.getResolution(t)/s.getResolution(t-1)==.5;n<2&&(0===n&&c&&(a-=1),l=0===n?s.cascadeFrustumMatrix0:1===n?s.cascadeFrustumMatrix1:s.projViewMatrix);var u=a+this.options.zoomOffset,f=this._getTileOffset(a),g=f[0]||f[1],A={zoom:a,extent:null,offset:f,tiles:[]};if(u<0)return A;if(!(s&&this.isVisible()&&s.width&&s.height))return A;if(!o){var m=this.getMinZoom(),w=this.getMaxZoom();if(!h(m)&&a<m||!h(w)&&a>w)return A}var T=this._getTileConfig();if(!T)return A;var M,C={zoom:f},P=(this._spatialRef||this.getSpatialReference()).getResolution(a);M=this._hasOwnSR?s.getGLScale(a):P/s.getGLRes();var I=!this._hasOwnSR&&this.options.repeatWorld,O=this._convertToExtent2d(e),E=this._getMask2DExtent();if(E){var D=E.intersection(O);if(!D)return A;e=D.convertTo((function(t){return s._pointToContainerPoint(t,void 0,0,mp)}))}var N,H=s._containerPointToPrj(e.getCenter(),bp),U=s._prjToPoint(H,a,wp);N=this._project(g?s._pointToPrj(U._add(f),a,wp):H,wp);var W=s.getGLScale()/s.getGLScale(a);Tp.x=O.xmin*W,Tp.y=O.ymax*W,Mp.x=O.xmax*W,Mp.y=O.ymin*W;for(var q=this._project(s._pointToPrj(Tp._add(f),a,Tp),Tp),X=this._project(s._pointToPrj(Mp._add(f),a,Mp),Mp),J=T.getTileIndex(N,P,I),Q=T.getTileIndex(q,P,I),Y=T.getTileIndex(X,P,I),K=Math.ceil(Math.abs(J.idy-Q.idy)),$=Math.ceil(Math.abs(J.idx-Q.idx)),tt=Math.ceil(Math.abs(J.idy-Y.idy)),et=Math.ceil(Math.abs(J.idx-Y.idx)),nt=(K+tt+1)*($+et+1),it=this.getTileSize(),rt=this.getRenderer()||i,ot=this._getTileConfig().tileSystem.scale,st=[],at=new Oh,ut=new _e(0,0),ft=-K;ft<=tt;ft++)for(var gt=-$,vt=-1/0,xt=!1;gt>=vt&&gt<=et;){var bt=T.getNeighorTileIndex(J.idx,J.idy,gt,ft,P,I);vt===-1/0?gt++:gt--;var Ct=this._getTileId(bt.idx,bt.idy,a);if(!(bt.out||this._visitedTiles&&this._visitedTiles.has(Ct))){var Ot=rt&&rt.isTileCachedOrLoading(Ct);Ot&&(Ot=Ot.info);var Gt=void 0;if(Ot){var{extent2d:$t}=Ot;ut.set($t.xmin,$t.ymax),Gt=ut}else if(this._hasOwnSR){var ne=T.getTilePrjNW(bt.x,bt.y,P);Gt=s._prjToPoint(this._unproject(ne,Mp),a)}else Gt=T.getTilePointNW(bt.x,bt.y,P);var re=void 0,oe=void 0;if(this._hasOwnSR){var ae=void 0;if(this._hasOwnSR){var he=T.getTilePrjSE(bt.x,bt.y,P);ae=s._prjToPoint(this._unproject(he,Mp),a,Mp)}else ae=T.getTilePointSE(bt.x,bt.y,P);re=Math.ceil(Math.abs(ae.x-Gt.x)),oe=Math.ceil(Math.abs(ae.y-Gt.y))}else re=it.width,oe=it.height;var ce=ot.x*(bt.idx-bt.x)*re,ue=ot.y*(bt.idy-bt.y)*oe;Ot||!ce&&!ue||Gt._add(ce,ue);var fe=Ot&&Ot.extent2d||new Oh(Gt.x,Gt.y-oe,Gt.x+re,Gt.y);if(nt<=4||xt||this._isTileInExtent(l,fe,f,M)){var ge=this._hasOwnSR?s._getResolution(a):P;this._visitedTiles&&0===n&&this._visitedTiles.add(Ct),c&&0===n?(this._splitTiles(l,st,rt,bt,a+1,ge,fe,ce,ue,C),at._combine(fe)):(Ot?(Ot.offset[0]=f[0],Ot.offset[1]=f[1]):Ot=this.createTileNode(bt.x,bt.y,a,bt.idx,bt.idy,ge,0,null,fe,Ct),st.push(Ot),at._combine(fe)),vt===-1/0?(vt=gt,gt=et):xt||(xt=!0)}}}if(st.length){var pe=s._containerPointToPoint(e.getCenter(),a,mp)._add(f),Ae=new _e(0,0),me=new _e(0,0);st.sort((function(t,e){return Ae.set((t.extent2d.xmin+t.extent2d.xmax)/2,(t.extent2d.ymin+t.extent2d.ymax)/2),me.set((e.extent2d.xmin+e.extent2d.xmax)/2,(e.extent2d.ymin+e.extent2d.ymax)/2),Ae.distanceTo(pe)-me.distanceTo(pe)}))}return{offset:f,zoom:t,extent:at,tiles:st}},n._convertToExtent2d=function(t){var e=this,n=this.getMap();return t.convertTo((function(t){if(t.y>0&&t.y<n.height){var i=(0===t.x?0:1)+t.y;e._coordCache[i]||(e._coordCache[i]=n._containerPointToPoint(t)),e._coordCache[i]}return n._containerPointToPoint(t,void 0,mp)}))},n._splitTiles=function(t,e,n,i,o,s,a,l,h,c){var u=this._getTileConfig().tileSystem.scale.y,f=this.getMap().getGLScale(o),g=Cp.set(2*a.xmin,u<0?2*a.ymax:2*a.ymin),A=a.getWidth(),m=a.getHeight(),w=2*i.idx,T=2*i.idy,M=2*i.x,C=2*i.y,P=this._checkAndAddTile(t,n,w,T,M,C,o,s,0,0,A,m,g,f,c);P&&e.push(P),(P=this._checkAndAddTile(t,n,w,T,M,C,o,s,0,1,A,m,g,f,c))&&e.push(P),(P=this._checkAndAddTile(t,n,w,T,M,C,o,s,1,0,A,m,g,f,c))&&e.push(P),(P=this._checkAndAddTile(t,n,w,T,M,C,o,s,1,1,A,m,g,f,c))&&e.push(P)},n._checkAndAddTile=function(t,e,n,i,o,s,a,l,h,c,u,f,g,A,m){var w=this._getTileId(n+h,i+c,a);if(this._visitedTiles&&this._visitedTiles.has(w))return null;var T=m[a];T||(T=m[a]=this._getTileOffset(a));var M=this._getTileConfig().tileSystem.scale.y,C=new Oh(g.x+h*u,g.y+M*c*f,g.x+(h+1)*u,g.y+M*(c+1)*f);if(!this._isSplittedTileInExtent(t,C,T,A))return null;var P=l/2,I=e&&e.isTileCachedOrLoading(w);return I?I.info:this.createTileNode(o+h,s+c,a,n+h,n+s,P,0,null,C,w)},n._getTileOffset=function(...t){var e=this.options.offset;return e?(A(e)&&(e=e.call(this,...t)),c(e)&&(e=[e,e]),e||[0,0]):[0,0]},n.getTileId=function(t,e,n,i){return this._getTileId(t,e,n,i)},n._getTileId=function(t,e,n,i){return(i||this.getId())+"_"+t+"_"+e+"_"+n},n._project=function(t,e){if(this._hasOwnSR){var n=this.getMap().getProjection();return(this._spatialRef||this.getSpatialReference()).getProjection().project(n.unproject(t,e),e)}return t},n._unproject=function(t,e){if(this._hasOwnSR){var n=this.getMap(),i=this._spatialRef||this.getSpatialReference(),o=n.getProjection(),s=i.getProjection();return o.project(s.unproject(t,e),e)}return t},n._initTileConfig=function(){var t=this.getMap(),e=this.getTileSize(),n=this.getSpatialReference(),i=n.getProjection(),o=n.getFullExtent();this._defaultTileConfig=new lp(t,sp.getDefault(i),o,e),this.options.hasOwnProperty("tileSystem")&&(this._tileConfig=new lp(t,this.options.tileSystem,o,e)),delete this._rootNodes,delete this._tileFullExtent,delete this._disablePyramid},n._getTileConfig=function(){return this._defaultTileConfig||this._initTileConfig(),this._tileConfig||this._defaultTileConfig},n._bindMap=function(e){return this._onSpatialReferenceChange(),t.prototype._bindMap.apply(this,arguments)},n._isTileInExtent=function(t,e,n,i){var o,s=this.getMap();if(t!==s.projViewMatrix){var a=e.getCenter(Sp)._sub(n[0],n[1])._multi(i);Gs(Ep,a.x,a.y,0);var l=function(t,e,n){var i=e[0],o=e[1],s=e[2],a=n[3]*i+n[7]*o+n[11]*s+n[15];return t[0]=(n[0]*i+n[4]*o+n[8]*s+n[12])/(a=a||1),t[1]=(n[1]*i+n[5]*o+n[9]*s+n[13])/a,t[2]=(n[2]*i+n[6]*o+n[10]*s+n[14])/a,t}(Ep,Ep,s.projViewMatrix);o=l[1]<0?s.projViewMatrix:t}else o=s.projViewMatrix;return Pp[0][0]=(e.xmin-n[0])*i,Pp[0][1]=(e.ymin-n[1])*i,Pp[1][0]=(e.xmax-n[0])*i,Pp[1][1]=(e.ymax-n[1])*i,fp(o,Pp)},n._isSplittedTileInExtent=function(t,e,n,i){var o=this.getMap();return Pp[0][0]=(e.xmin-n[0])*i,Pp[0][1]=(e.ymin-n[1])*i,Pp[1][0]=(e.xmax-n[0])*i,Pp[1][1]=(e.ymax-n[1])*i,fp(o.projViewMatrix,Pp)},n.getEvents=function(){return{spatialreferencechange:this._onSpatialReferenceChange}},n._onSpatialReferenceChange=function(){delete this._tileConfig,delete this._defaultTileConfig,delete this._sr,delete this._srMinZoom,delete this._hasOwnSR,delete this._rootNodes,this.tileInfoCache&&this.tileInfoCache.reset();var t=this.getRenderer();t&&t.clear()},n.getPolygonOffsetCount=function(){return 2},n.getPolygonOffset=function(){return this._polygonOffset||0},n.setPolygonOffset=function(t){return this._polygonOffset=t,this},n.getRenderer=function(){return t.prototype.getRenderer.call(this)},n._getTileBBox=function(t){var e=this.getMap();if(e){var n=t.extent2d,i=t.offset||[0,0];if(n){var o=t.res,[s,a]=i,{xmin:l,ymin:h,xmax:c,ymax:u}=n;c-=s,u-=a;var f=new _e(l-=s,h-=a),g=new _e(c,u),A=e.pointAtResToCoordinate(f,o,bp),m=e.pointAtResToCoordinate(g,o,wp);return[A.x,A.y,m.x,m.y]}}},n._tileInMask=function(t){var e=this.getMask();if(!e)return!0;var n=e.type;if(!n||-1===n.indexOf("Polygon"))return!0;var i=this._maskGeoJSON;if(!i||!i.geometry)return!0;var{coordinates:o,type:s}=i.geometry;if(!o||!s)return!0;if(-1===s.indexOf("Polygon"))return!0;if(!i.bbox){var a=e.getExtent();if(!a)return!0;i.bbox=[a.xmin,a.ymin,a.xmax,a.ymax]}var l=this._getTileBBox(t);return!l||Ls(l,this._maskGeoJSON)},n._debugTile=function(t,e,n){if(this.options.debugTile){if(Array.isArray(t)){for(var i=0;i<t.length;i++)t[i]&&this._debugTile(t[i],e+" at "+i,n);return}if(!t)return;var{x:o,y:s,z:a}=this.options.debugTile;t.x===o&&t.y===s&&t.z===a&&console.log("Debug Tile Found in TileLayer."+e+":",t)}},e}(Pf);function Rp(t,e){return t.z-e.z}kp.registerJSONType("TileLayer"),kp.mergeOptions(vp),function(t){t[t.OUT_OF_FRUSTUM=0]="OUT_OF_FRUSTUM",t[t.SCREEN_ERROR_TOO_SMALL=1]="SCREEN_ERROR_TOO_SMALL",t[t.VISIBLE=2]="VISIBLE"}(Ap||(Ap={}));var Lp=new qn(256,256),Dp="show hide remove setzindex forcereloadstart";function Fp(t){return Array.isArray(t)||(t=[t]),t}var Np=function(t){function e(e,n,i){var o;return(o=t.call(this,e,i)||this).layers=n||[],o._checkChildren(),o.layerMap={},o._groupChildren=[],o}he(e,t),e.fromJSON=function(t){if(!t||"GroupTileLayer"!==t.type)return null;var n=t.layers.map((function(t){return Pf.fromJSON(t)}));return new e(t.id,n,t.options)};var n=e.prototype;return n.getLayers=function(){return this.layers},n.addLayer=function(t=[]){var e=this;t=Fp(t);var n=this.layers.length;return t.forEach((function(t){t instanceof kp&&(-1!==e.layers.indexOf(t)||e.layerMap[t.getId()]||e.layers.push(t))})),n!==this.layers.length&&(this._sortLayers(),this._refresh(),this._renderLayers()),this},n.removeLayer=function(t=[]){var e=this;t=Fp(t);var n=this.layers.length;return t.forEach((function(t){if(t instanceof kp||(t=e.layerMap[t]),t instanceof kp){var n=e.layers.indexOf(t);n>=0&&(e.layers.splice(n,1),t._doRemove(),t.off(Dp,e._onLayerShowHide,e))}})),n!==this.layers.length&&(this._refresh(),this._renderLayers()),this},n.clearLayers=function(){var t=this;return this.layers.forEach((function(e){e._doRemove(),e.off(Dp,t._onLayerShowHide,t)})),this.layers=[],this._refresh(),this._renderLayers(),this},n.toJSON=function(){return{type:this.getJSONType(),id:this.getId(),layers:this.layers.map((function(t){return t.toJSON()})),options:this.config()}},n.getTileSize=function(t){var e=this.getLayer(t);return e?e.getTileSize():Lp},n.getTiles=function(t,e){for(var n=this.layers,i=[],o=0,s=0,a=n.length;s<a;s++){var l=n[s];if(l&&l.options.visible&&l.isVisible()&&l.getMap()){var h=l.getTiles(t,e||this);h&&0!==h.count&&(o+=h.count,ke(i,h.tileGrids))}}return{count:o,tileGrids:i}},n.onAdd=function(){this._sortLayers(),this._refresh(),t.prototype.onAdd.call(this)},n.onRemove=function(){var e=this;this.layers.forEach((function(t){t._doRemove(),t.off(Dp,e._onLayerShowHide,e)})),this.layerMap={},this._groupChildren=[],t.prototype.onRemove.call(this)},n.getLayer=function(t){return this.getChildLayer(t)},n.getChildLayer=function(t){var e=this.layerMap[t];if(e)return e;for(var n=0;n<this._groupChildren.length;n++){var i=this._groupChildren[n].getChildLayer(t);if(i)return i}return null},n._removeChildTileCache=function(t){if(!t)return this;var e,n=this.getRenderer();if(!n)return this;var i=t.getId(),o=function(){return e&&e.info&&e.info.layer===i};n.tileCache&&n.tileCache.keys().forEach((function(t){e=n.tileCache.get(t),o()&&n.tileCache.remove(t)}));var s=n.tilesInView||{};for(var a in s)e=s[a],o()&&delete s[a];var l=n.tilesLoading||{};for(var h in l)e=l[h],o()&&n.abortTileLoading(e.image,e.info);return this},n._onLayerShowHide=function(t){var{type:e,target:n}=t||{};"remove"===e&&n?(this.layers.splice(this.layers.indexOf(n),1),n._doRemove(),n.off(Dp,this._onLayerShowHide,this),this._refresh()):"setzindex"===e?this._sortLayers():"forcereloadstart"===e&&this._removeChildTileCache(n),this._renderLayers()},n._renderLayers=function(){var t=this.getRenderer();return t&&t.setToRedraw(),this},n._refresh=function(){var t=this,e=this.getMap();return this._groupChildren=[],this.layerMap={},this.layers.forEach((function(n){t.layerMap[n.getId()]=n,n.getChildLayer&&t._groupChildren.push(n),n.getMap()||n._bindMap(e),n.off(Dp,t._onLayerShowHide,t),n.on(Dp,t._onLayerShowHide,t)})),this},n.isVisible=function(){if(!t.prototype.isVisible.call(this))return!1;for(var e=this.layers,n=0,i=e.length;n<i;n++)if(e[n].isVisible())return!0;return!1},n._checkChildren=function(){var t=this,e={};this.layers.forEach((function(n){var i=n.getId();if(e[i])throw new Error("Duplicate child layer id ("+i+") in the GroupTileLayer ("+t.getId()+")");e[i]=1}))},n._sortLayers=function(){this.layers.sort((function(t,e){return t.options.zIndex-e.options.zIndex}))},e}(kp);Np.registerJSONType("GroupTileLayer"),Np.mergeOptions({urlTemplate:"",maxCacheSize:1024});var Hp,Bp={urlTemplate:"",crs:null,uppercase:!1,detectRetina:!1},zp={service:"WMS",request:"GetMap",layers:"",styles:"",format:"image/jpeg",transparent:!1,version:"1.1.1"},Gp=function(t){function e(e,n){var i;return i=t.call(this,e)||this,Hp||(Hp=l({},i.options)),i.wmsParams=l({},zp),i._setOptions(n),i.setZIndex(n.zIndex),Gt.proxy||i._optionsHook(n),i}he(e,t);var n=e.prototype;return n._optionsHook=function(t={}){for(var e in t)"tileSize"===e&&(this._tileSize=null),e in Hp||(this.wmsParams[e]=t[e]);var n=this.getTileSize();return this.wmsParams.width=n.width,this.wmsParams.height=n.height,this._wmsVersion=parseFloat(this.wmsParams.version),this},n.onAdd=function(){var e=this.getMap().getDevicePixelRatio(),n=Bp.detectRetina?e:1;this.wmsParams.width*=n,this.wmsParams.height*=n;var i=this.options.crs||this.getMap().getProjection().code;this.wmsParams[this._wmsVersion>=1.3?"crs":"srs"]=i,t.prototype.onAdd.call(this)},n.getTileUrl=function(e,n,i){var o=this.getSpatialReference().getResolution(i),s=this._getTileConfig().getTilePrjExtent(e,n,o),a=s.getMax(),l=s.getMin(),h=(this._wmsVersion>=1.3&&("EPSG:4326"===this.wmsParams.crs||"EPSG:4490"===this.wmsParams.crs)?[l.y,l.x,a.y,a.x]:[l.x,l.y,a.x,a.y]).join(","),c=t.prototype.getTileUrl.call(this,e,n,i);return c+function(t,e,n){var i=[];for(var o in t)i.push(encodeURIComponent(n?o.toUpperCase():o)+"="+encodeURIComponent(t[o]));return(e&&-1!==e.indexOf("?")?"&":"?")+i.join("&")}(this.wmsParams,c,this.options.uppercase)+(this.options.uppercase?"&BBOX=":"&bbox=")+h},n.toJSON=function(){return{type:"WMSTileLayer",id:this.getId(),options:this.config()}},e.fromJSON=function(t){return t&&"WMSTileLayer"===t.type?new e(t.id,t.options):null},e}(kp);Gp.registerJSONType("WMSTileLayer"),Gp.mergeOptions(Bp);var jp=function(t){function e(e,n){var i;return(i=t.call(this,e,n)||this).options.hasOwnProperty("forceRenderOnMoving")||(i.options.forceRenderOnMoving=!1),i}he(e,t);var n=e.prototype;return n.drawTile=function(){},n.toJSON=function(){return{type:"CanvasTileLayer",id:this.getId(),options:this.config()}},e.fromJSON=function(t){return t&&"CanvasTileLayer"===t.type?new e(t.id,t.options):null},e}(kp);function Up(t,e,n){var i=t.createShader(e);if(t.shaderSource(i,n),t.compileShader(i),!t.getShaderParameter(i,t.COMPILE_STATUS)){var o=t.getShaderInfoLog(i);throw t.deleteShader(i),new Error("Failed to compile shader: "+o)}return i}function Vp(t,e,n){var i=Up(t,t.VERTEX_SHADER,e),o=Up(t,t.FRAGMENT_SHADER,n);if(!i||!o)return null;var s=t.createProgram();return s?(t.attachShader(s,i),t.attachShader(s,o),t.linkProgram(s),{program:s,vertexShader:i,fragmentShader:o}):null}function Wp(t,e,n){if(Array.isArray(n[0])){for(var i=Float32Array.BYTES_PER_ELEMENT,o=0,s=0;s<n.length;s++)o+=n[s][1]||0;for(var a=0,l=0;l<n.length;l++){var h=t.getAttribLocation(e,n[l][0]);if(h<0)throw new Error("Failed to get the storage location of "+n[l][0]);t.vertexAttribPointer(h,n[l][1],t[n[l][2]||"FLOAT"],!1,i*o,i*a),a+=n[l][1]||0,t.enableVertexAttribArray(h)}}else{var c=t.getAttribLocation(e,n[0]);t.vertexAttribPointer(c,n[1],t[n[2]||"FLOAT"],!1,0,0),t.enableVertexAttribArray(c)}}jp.registerJSONType("CanvasTileLayer");var Zp={never:512,"<":513,"=":514,"<=":515,">":516,"!=":517,">=":518,always:519};var qp=[1,1,1,1],Xp=new Float32Array(8),Jp=new Int16Array(8),Qp="\n        attribute vec2 a_position;\n\n        attribute vec2 a_texCoord;\n\n        uniform mat4 u_matrix;\n\n        varying vec2 v_texCoord;\n\n        void main() {\n            gl_Position = u_matrix * vec4(a_position, 0., 1.);\n\n            v_texCoord = a_texCoord;\n        }\n    ",Yp="\n        precision mediump float;\n\n        uniform sampler2D u_image;\n\n        uniform float u_opacity;\n        uniform float u_debug_line;\n        uniform vec4 u_base_color;\n        uniform float u_alpha_test;\n        varying vec2 v_texCoord;\n\n        void main() {\n            if (u_debug_line == 1.) {\n                gl_FragColor = vec4(0., 1., 0., 1.);\n            } else {\n                gl_FragColor = texture2D(u_image, v_texCoord) * u_opacity;\n            }\n            gl_FragColor *= u_base_color;\n            if (gl_FragColor.a < u_alpha_test) {\n                discard;\n            }\n        }\n    ",Kp=["",0],$p=[0,0,0],tA=new Array(16),eA=new _e(20,20),nA=function(t){var e=function(t){function e(){var e;return(e=t.apply(this,arguments)||this)._layerAlt=0,e._layerAltitude=0,e}he(e,t);var i=e.prototype;return i.drawGLImage=function(t,e,n,i,o,s,a,l,u,f){this.gl.program!==this.program&&this.useProgram(this.program);var g=this.gl;if(this.loadTexture(t,l),this.canvas.gl&&this.canvas.gl.wrap){var A=this.layer&&this.layer.options.opacity;h(A)&&(A=1),a*=A}$p[0]=e||0,$p[1]=n||0,$p[2]=0;var m=this.layer,w=this.getMap();if(m){var{altitude:T}=m.options,M=c(T);if(M||(this._layerAlt=0),this._layerAltitude!==T&&M){var C=w.altitudeToPoint(T,w.getGLRes());this._layerAltitude=T,this._layerAlt=C}}$p[2]=this._layerAlt||0;var P=as(tA);Ko(P,P,$p),$o(P,P,[s,s,1]),rs(P,w.projViewMatrix,P),g.uniformMatrix4fv(this.program.u_matrix,!1,P),g.uniform1f(this.program.u_opacity,a),g.uniform1f(this.program.u_debug_line,0),g.uniform4fv(this.program.u_base_color,f||qp),g.uniform1f(this.program.u_alpha_test,this.layer.options.alphaTest||0);var{glBuffer:I}=t;!I||I.width===i&&I.height===o||(this.saveImageBuffer(I),delete t.glBuffer),t.glBuffer?g.bindBuffer(g.ARRAY_BUFFER,I):t.glBuffer=this.bufferTileData(0,0,i,o),Kp[0]="a_position",Kp[1]=2,Kp[2]=t.glBuffer.type,this.enableVertexAttrib(Kp),g.bindBuffer(g.ARRAY_BUFFER,this.texBuffer),Kp[0]="a_texCoord",Kp[1]=2,Kp[2]="UNSIGNED_BYTE",this.enableVertexAttrib(Kp),g.drawArrays(g.TRIANGLE_STRIP,0,4),u&&this.drawDebug(P,0,0,i,o,u)},i.drawDebug=function(t,e,n,i,o,s){var a=this.gl;a.disable(a.DEPTH_TEST),a.bindBuffer(a.ARRAY_BUFFER,this._debugBuffer),this.enableVertexAttrib(["a_position",2,"FLOAT"]),a.bufferData(a.ARRAY_BUFFER,new Float32Array([e,n,e+i,n,e+i,n-o,e,n-o,e,n]),a.DYNAMIC_DRAW),a.uniformMatrix4fv(this.program.u_matrix,!1,t),a.uniform1f(this.program.u_opacity,1),a.uniform1f(this.program.u_debug_line,1),a.uniform4fv(this.program.u_base_color,qp),a.uniform1f(this.program.u_alpha_test,this.layer.options.alphaTest||0),a.drawArrays(a.LINE_STRIP,0,5);var l=this._debugInfoCanvas;if(!l){var h=this.mapDPR||this.getMap().getDevicePixelRatio()>1?2:1;(l=this._debugInfoCanvas=document.createElement("canvas")).width=256*h,l.height=32*h;var c=l.getContext("2d");c.font="20px monospace",c.scale(h,h)}var u=l.getContext("2d");u.clearRect(0,0,l.width,l.height),zl.fillText(u,s,eA,this.layer.options.debugOutline),this.loadTexture(l),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,l);var f=e+(i=256),g=n-o+32,A=n-o;a.bufferData(a.ARRAY_BUFFER,this.set8(e,g,e,A,f,g,f,A),a.DYNAMIC_DRAW),a.uniform1f(this.program.u_debug_line,0),a.bindBuffer(a.ARRAY_BUFFER,this.texBuffer),this.enableVertexAttrib(["a_texCoord",2,"UNSIGNED_BYTE"]),a.drawArrays(a.TRIANGLE_STRIP,0,4),a.enable(a.DEPTH_TEST)},i.bufferTileData=function(t,e,n,i,o){var s,a=t,l=t+n,h=e,c=e-i;s=u(a)&&u(l)&&u(h)&&u(c)?this.set8Int(a,h,a,c,l,h,l,c):this.set8(a,h,a,c,l,h,l,c);var f=this.loadImageBuffer(s,o);return f.width=n,f.height=i,f.type=s instanceof Int16Array?"SHORT":"FLOAT",f},i.createCanvas2=function(){this.canvas2=zl.createCanvas(this.canvas.width,this.canvas.height)},i.createGLContext=function(){this.gl=this.canvas.gl&&this.canvas.gl.wrap?this.canvas.gl.wrap():function(t,e){for(var n={alpha:!0,stencil:!0,preserveDrawingBuffer:!0,antialias:!1},i=["webgl","experimental-webgl"],o=null,s=0;s<i.length;++s){try{o=t.getContext(i[s],e||n)}catch(t){}if(o)break}return o}(this.canvas2||this.canvas,this.layer.options.glOptions);var t=this.gl;t.clearColor(0,0,0,0),t.enable(t.DEPTH_TEST),t.enable(t.STENCIL_TEST),t.enable(t.BLEND),t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA),this.program=this.createProgram(Qp,this.layer.options.fragmentShader||Yp),this._debugBuffer=this.createBuffer(),this.useProgram(this.program),this.texBuffer=this.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.texBuffer),this.enableVertexAttrib(["a_texCoord",2,"UNSIGNED_BYTE"]),t.bufferData(t.ARRAY_BUFFER,new Uint8Array([0,0,0,1,1,0,1,1]),t.STATIC_DRAW),this.enableSampler("u_image"),t.activeTexture(t.TEXTURE0),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0)},i.resizeGLCanvas=function(){this.gl&&this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.canvas2&&(this.canvas2.width===this.canvas.width&&this.canvas2.height===this.canvas.height||(this.canvas2.width=this.canvas.width,this.canvas2.height=this.canvas.height))},i.clearGLCanvas=function(){this.gl&&(this.gl.clearStencil(255),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.STENCIL_BUFFER_BIT)),this.gl.wrap||this.gl.clear(this.gl.DEPTH_BUFFER_BIT)},i.disposeImage=function(t){t&&(t.texture&&this.saveTexture(t.texture),t.glBuffer&&this.saveImageBuffer(t.glBuffer),delete t.texture,delete t.glBuffer)},i._createTexture=function(t){var e=this.gl,n=this.getTexture()||e.createTexture();e.bindTexture(e.TEXTURE_2D,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);var i=this.layer.options.mipmapTexture;return!i||iA(t.width)&&iA(t.height)||(t=function(t){if(iA(t.width)&&iA(t.height))return t;var e=t.width,n=t.height;iA(e)||(e=rA(e));iA(n)||(n=rA(n));var i=document.createElement("canvas");i.width=e,i.height=n;var o=i.getContext("2d");return o.imageSmoothingEnabled=!1,o.drawImage(t,0,0,e,n),i}(t)),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),i&&e.generateMipmap(e.TEXTURE_2D),n},i.getTexture=function(){this._textures||(this._textures=[]);var t=this._textures;return t&&t.length>0?t.pop():null},i.saveTexture=function(t){this._textures.push(t)},i.loadTexture=function(t,e=!1){var n=this.gl,i=t.texture;if(i||(i=this._createTexture(t),t.texture=i),n.bindTexture(n.TEXTURE_2D,i),this.layer.options.mipmapTexture){var o=this.getMap(),s=this.mapDPR||o.getDevicePixelRatio();o.isMoving()&&o.getRenderer().isViewChanged()?n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR_MIPMAP_LINEAR):n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,1!==s||e?n.LINEAR:n.NEAREST)}return i},i.getImageBuffer=function(){this._imageBuffers||(this._imageBuffers=[]);var t=this._imageBuffers;return t&&t.length>0?t.pop():null},i.saveImageBuffer=function(t){this._imageBuffers||(this._imageBuffers=[]),this._imageBuffers.push(t)},i.loadImageBuffer=function(t,e){var n=this.gl,i=e||this.createImageBuffer();return n.bindBuffer(n.ARRAY_BUFFER,i),n.bufferData(n.ARRAY_BUFFER,t,n.STATIC_DRAW),i},i.createImageBuffer=function(){return this.getImageBuffer()||this.createBuffer()},i.removeGLCanvas=function(){var t=this.gl;if(t){if(this._debugBuffer&&(t.deleteBuffer(this._debugBuffer),delete this._debugBuffer),this._buffers&&(this._buffers.forEach((function(e){t.deleteBuffer(e)})),delete this._buffers),this._textures&&(this._textures.forEach((function(e){return t.deleteTexture(e)})),delete this._textures),this._debugInfoCanvas){var e=this._debugInfoCanvas.texture;e&&t.deleteTexture(e),delete this._debugInfoCanvas.texture,delete this._debugInfoCanvas}var n=t.program;t.deleteShader(n.fragmentShader),t.deleteShader(n.vertexShader),t.deleteProgram(n),delete this.gl,delete this.canvas2}},i.createBuffer=function(){var t=this.gl.createBuffer();if(!t)throw new Error("Failed to create the buffer object");return this._buffers||(this._buffers=[]),this._buffers.push(t),t},i.enableVertexAttrib=function(t){Wp(this.gl,this.gl.program,t)},i.createProgram=function(t,e){for(var n=this.gl,{program:i,vertexShader:o,fragmentShader:s}=Vp(n,t,e),a=n.getProgramParameter(i,35718),l=[],h=0;h<a;++h){var c=n.getActiveUniform(i,h);l.push(c.name)}return i.vertexShader=o,i.fragmentShader=s,this._initUniforms(i,l),i},i.useProgram=function(t){var e=this.gl;return e.useProgram(t),e.program=t,this},i.enableSampler=function(t,e){var n=this.gl,i=this._getUniform(n.program,t);return e||(e=0),n.uniform1i(i,e),i},i._initUniforms=function(t,e){for(var i=0;i<e.length;i++){var o=e[i],s=e[i],a=o.indexOf("[");a>=0&&(o=o.substring(0,a),n||(s=s.substring(0,a))),t[o]=this._getUniform(t,s)}},i._getUniform=function(t,e){var n=this.gl.getUniformLocation(t,e);if(!n)throw new Error("Failed to get the storage location of "+e);return n},i.set8=function(t,e,n,i,o,s,a,l){var h=Xp;return h[0]=t,h[1]=e,h[2]=n,h[3]=i,h[4]=o,h[5]=s,h[6]=a,h[7]=l,h},i.set8Int=function(t,e,n,i,o,s,a,l){var h=Jp;return h[0]=t,h[1]=e,h[2]=n,h[3]=i,h[4]=o,h[5]=s,h[6]=a,h[7]=l,h},e}(t);return e};function iA(t){return!(t&t-1)&&0!==t}function rA(t){return Math.pow(2,Math.ceil(Math.log(t)/Math.LN2))}var oA=function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n.needToRedraw=function(){var t=this.getMap();return!(!t.isInteracting()&&!t.getRenderer().isViewChanged())&&!(!t.getPitch()&&t.isMoving()&&!t.isZooming()&&!t.isRotating()&&!this.layer.options.forceRenderOnMoving)},n.setCanvasUpdated=function(){return this._canvasUpdated=!0,this},n.isCanvasUpdated=function(){return!!this._canvasUpdated},n.getCanvasImage=function(){var t=this.getMap();if(this._canvasUpdated=!1,this._renderZoom!==t.getZoom()||!this.canvas||!this._extent2D)return null;if(this.isBlank())return null;if(this.layer.isEmpty&&this.layer.isEmpty())return null;var e=t._pointToContainerPoint(this.middleWest)._add(0,-t.height/2);return{image:this.canvas,layer:this.layer,point:e}},n.clear=function(){this.clearCanvas()},n.createCanvas=function(){if(!this.canvas){var t=this.getMap(),e=t.getSize(),n=t.getDevicePixelRatio(),i=Math.round(n*e.width),o=Math.round(n*e.height);if(this.layer._canvas){var s=this.layer._canvas;s.width=i,s.height=o,s.style&&(s.style.width=e.width+"px",s.style.height=e.height+"px"),this.canvas=this.layer._canvas}else this.canvas=zl.createCanvas(i,o,t.CanvasClass);this.onCanvasCreate()}},n.onCanvasCreate=function(){},n._canvasContextScale=function(t,e){return t.scale(e,e),t.dpr=e,this},n.createContext=function(){if(!(this.gl&&this.gl.canvas===this.canvas||this.context)&&(this.context=zl.getCanvas2DPerformanceContext(this.canvas),this.context)){this.context.dpr=1,this.layer.options.globalCompositeOperation&&(this.context.globalCompositeOperation=this.layer.options.globalCompositeOperation);var t=this.getMap().getDevicePixelRatio();1!==t&&this._canvasContextScale(this.context,t)}},n.resetCanvasTransform=function(){if(this.context){var t=this.getMap().getDevicePixelRatio();this.context.setTransform(t,0,0,t,0,0)}},n.resizeCanvas=function(t){var e=this.canvas;if(e){var n=this.getMap(),i=t||n.getSize(),o=n.getDevicePixelRatio(),{width:s,height:a,cssWidth:l,cssHeight:h}=Dn(i,o);!this.layer._canvas||e.style.width===l&&e.style.height===h||(e.style.width=l,e.style.height=h),e.width===s&&e.height===a||(e.height=a,e.width=s,this.context&&(this.context.dpr=1),1!==o&&this.context&&this._canvasContextScale(this.context,o))}},n.clearCanvas=function(){if(this.context){var t=this.getMap();if(t){var e=1/(this.mapDPR||t.getDevicePixelRatio()),n=this.canvas.height*e;zl.clearRect(this.context,0,0,Math.max(this.canvas.width*e,this.canvas.width),Math.max(n,this.canvas.height))}}},n.prepareCanvas=function(){this.canvas?(this.resetCanvasTransform(),this.clearCanvas(),this.resizeCanvas()):(this.createCanvas(),this.createContext(),this.layer.onCanvasCreate(),this.layer.fire("canvascreate",{context:this.context,gl:this.gl})),delete this._maskExtent;var t=this.layer.getMask();if(!t)return this.layer.fire("renderstart",{context:this.context,gl:this.gl}),null;var e=this._maskExtent=t._getMaskPainter().get2DExtent();return e&&this._extent2D&&e.intersects(this._extent2D),this.layer.fire("renderstart",{context:this.context,gl:this.gl}),e},n.clipCanvas=function(t){var e=this.layer.getMask();if(!e)return!1;if(!this.layer.options.maskClip)return!1;var n=this.middleWest,i=this.getMap();this.middleWest=i._containerPointToPoint(new _e(0,i.height/2));var o=t.globalAlpha;t.save();var s=this.mapDPR||i.getDevicePixelRatio();if(1!==s&&(t.save(),this._canvasContextScale(t,s)),e.getGeometries){t.isMultiClip=!0;var a=e.getGeometries()||[];t.beginPath(),a.forEach((function(e){e._getMaskPainter().paint(null,t)})),t.stroke(),t.isMultiClip=!1}else{t.isClip=!0,t.beginPath(),e._getMaskPainter().paint(null,t),t.isClip=!1}1!==s&&t.restore();try{t.clip("evenodd")}catch(t){console.error(t)}return this.middleWest=n,t.globalAlpha=o,!0},n.completeRender=function(){this.getMap()&&(this._renderComplete=!0,this.layer.fire("renderend",{context:this.context,gl:this.gl}),this.setCanvasUpdated())},n.onResize=function(t){delete this._extent2D,this.resizeCanvas(),this.setToRedraw()},e}(Cf),sA={renderer:Gt.webgl?"gl":"canvas",crossOrigin:null,alphaTest:!1,depthMask:!0,depthFunc:"<="},aA=new _e(0,0),lA=function(t){function e(e,n,i){var o;return!n||Array.isArray(n)||n.url||(i=n,n=null),(o=t.call(this,e,i)||this)._images=n,o}he(e,t);var n=e.prototype;return n.onAdd=function(){this._prepareImages(this._images)},n.setImages=function(t){return this._images=t,this._prepareImages(t),this},n.getImages=function(){return this._images},n._prepareImages=function(t){t=t||[],Array.isArray(t)||(t=[t]);var e=this.getMap(),n=e.getGLRes();this._imageData=t.map((function(t){var i=new Ph(t.extent);return l({},t,{extent:i,extent2d:i.convertTo((function(t){return e.coordToPointAtRes(t,n)}))})})),this._images=t;var i=this.getRenderer();i&&i.refreshImages()},n.getRenderer=function(){return t.prototype.getRenderer.call(this)},e}(Pf);lA.mergeOptions(sA);var hA,cA=[],uA=function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n.isDrawable=function(){return!this.getMap().getPitch()||(console&&console.warn("ImageLayer with canvas renderer can't be pitched, use gl renderer ('renderer' : 'gl') instead."),!1)},n.checkResources=function(){var t=this;if(this._imageLoaded)return cA;var e=this.layer._imageData.map((function(t){return[t.url,null,null]}));if(this.resources){var n=[],i=zs();e.forEach((function(e){if(t.resources.isResourceLoaded(e)){var o=t.resources.getImage(e);i.addResource(e,o)}else n.push(e)})),this.resources.forEach((function(e,n){i.isResourceLoaded(e)||t.retireImage(n.image)})),this.resources=i,e=n}return this._imageLoaded=!0,e},n.retireImage=function(t){t.close&&t.close()},n.refreshImages=function(){this._imageLoaded=!1,this.setToRedraw()},n.draw=function(t,e){this.isDrawable()&&(this.prepareCanvas(),this._painted=!1,this._drawImages(t,e),this.completeRender())},n._drawImages=function(t,e){var n=this.layer._imageData,i=this.getMap(),o=i.get2DExtentAtRes(i.getGLRes());if(n&&n.length)for(var s=0;s<n.length;s++){var a=n[s].extent2d,l=this.resources&&this.resources.getImage(n[s].url);if(l&&o.intersects(a)){this._painted=!0;var h=n[s].opacity;c(h)||(h=1),this._drawImage(l,a,h)}}},n._drawImage=function(t,e,n){var i=0,o=this.context;n<1&&(i=o.globalAlpha,o.globalAlpha=n);var s=this.getMap(),a=aA.set(e.xmin,e.ymax),l=s._pointAtResToContainerPoint(a,s.getGLRes()),h=l.x,c=l.y,u=s.getBearing();u&&(o.save(),o.translate(h,c),u&&o.rotate(-u*Math.PI/180),h=c=0);var f=s.getGLScale();o.drawImage(t,h,c,e.getWidth()/f,e.getHeight()/f),u&&o.restore(),i&&(o.globalAlpha=i)},n.drawOnInteracting=function(t,e,n){this.draw()},e}(oA),fA=function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n.drawOnInteracting=function(t,e,n){this.draw(e,n)},n._prepareGLContext=function(){var t=this.gl;t&&(t.disable(t.STENCIL_TEST),t.disable(t.POLYGON_OFFSET_FILL),t.enable(t.DEPTH_TEST),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.depthFunc(function(t){return Zp[t]}(this.layer.options.depthFunc)),t.depthMask(!!this.layer.options.depthMask))},n._drawImages=function(e,n){var i=this.gl;if(n&&n.renderTarget){var o=n.renderTarget.fbo;if(o){var s=n.renderTarget.getFramebuffer(o);i.bindFramebuffer(i.FRAMEBUFFER,s)}}(this._prepareGLContext(),t.prototype._drawImages.call(this),n&&n.renderTarget)&&(n.renderTarget.fbo&&i.bindFramebuffer(i.FRAMEBUFFER,null))},n.isDrawable=function(){return!0},n._drawImage=function(t,e,n){var i=e.getWidth();this.drawGLImage(t,e.xmin,e.ymax,i,e.getHeight(),1,n,t.width!==i)},n.createContext=function(){this.createGLContext()},n.resizeCanvas=function(e){this.canvas&&(t.prototype.resizeCanvas.call(this,e),this.resizeGLCanvas())},n.clearCanvas=function(){this.canvas&&(t.prototype.clearCanvas.call(this),this.clearGLCanvas())},n.retireImage=function(t){t.close&&t.close(),this.disposeImage(t)},n.onRemove=function(){this.removeGLCanvas(),t.prototype.onRemove.call(this)},e}(nA(uA));lA.registerRenderer("canvas",uA),lA.registerRenderer("gl",fA),function(t){t[t.never=0]="never",t[t["<"]=1]="<",t[t["="]=2]="=",t[t["<="]=3]="<=",t[t[" >"]=4]=" >",t[t["!="]=5]="!=",t[t[">="]=6]=">=",t[t.always=7]="always"}(hA||(hA={}));var dA=new Oh,gA={debug:!1,enableSimplify:!0,defaultIconSize:[20,20],cacheVectorOnCanvas:!0,cacheSvgOnCanvas:Gt.gecko,enableAltitude:!0,altitudeProperty:"altitude",drawAltitude:!1,sortByDistanceToCamera:!1,roundPoint:!1,altitude:0,clipBBoxBufferSize:3,collision:!1,collisionBufferSize:2,collisionDelay:250,collisionScope:"layer",progressiveRender:!1,progressiveRenderCount:1e3,progressiveRenderDebug:!1},pA=function(t){function e(e,n,i){var o;return(o=t.call(this,e,n,i)||this).isVectorLayer=!0,o}he(e,t);var n=e.prototype;return n.onConfig=function(e){if(t.prototype.onConfig.call(this,e),!h(e.enableAltitude))for(var n=this.getGeometries()||[],i=0,o=n.length;i<o;i++){var s=n[i];s&&(s._clearAltitudeCache(),s.fire("positionchange"))}if(e.enableAltitude||e.drawAltitude||e.altitudeProperty){var a=this.getRenderer();a&&a.setToRedraw&&a.setToRedraw()}},n.identify=function(t,e){e=e||{};var n=this.getRenderer();t instanceof gh||(t=new gh(t));var i=this.getMap().coordToContainerPoint(t);return e.onlyVisible&&n&&n.identifyAtPoint?n.identifyAtPoint(i,e):this._hitGeos(this._geoList,i,e)},n.identifyAtPoint=function(t,e){e=e||{};var n=this.getRenderer();return t instanceof _e||(t=new _e(t)),e.onlyVisible&&n&&n.identifyAtPoint?n.identifyAtPoint(t,e):this._hitGeos(this._geoList,t,e)},n._hitGeos=function(t,e,n={}){if(!t||!t.length)return[];for(var i=[],o=0,s=0,a=t.length;s<a;s++){var l=t[s];l.isPoint&&!0===l._collided||(i[o]=l,o++)}t=i;var h=n.filter,u=[],f=n.tolerance,g=this.getMap(),A=this.getRenderer(),m=A&&A.getImageData&&A.getImageData();if(m){var w=0,T=A.maxTolerance;if(c(T))w=T;else for(var M=t.length-1;M>=0;M--){var C=t[M]._hitTestTolerance()+(f||0);C>w&&(w=C)}var P=g.getDevicePixelRatio();m.r=P;for(var I=!1,O=e.x-w,E=e.y-w,D=-w;D<=w;D++){for(var N=-w;N<=w;N++){var H=Math.round((O+D)*P),U=Math.round((E+N)*P);if(m.data[U*m.width*4+4*H+3]>0){I=!0;break}}if(I)break}if(!I)return u}for(var W=n.onlyVisible,q=t.length-1;q>=0;q--){var X=t[q];if(X&&X.options.interactive&&(W||X.isVisible())){var J=X._getPainter();if(J){var Q=J.getRenderBBOX&&J.getRenderBBOX();if(Q){var{x:Y,y:K}=e;if(Y<Q[0]||K<Q[1]||Y>Q[2]||K>Q[3])continue}if(!(X instanceof cd&&(X._getArrowStyle()||X instanceof Od))){var $=X.getContainerExtent(dA);if(f&&($=$._expand(f)),!$||!$.contains(e))continue}if(X._containsPoint(e,f)&&(!h||h(X))&&(u.push(X),n.count&&u.length>=n.count))break}}}return u},n.getAltitude=function(){return this.options.altitude||0},n.toJSON=function(t){t||(t={clipExtent:null,geometries:null});var e={type:this.getJSONType(),id:this.getId(),options:this.config()};if(h(t.geometries)||t.geometries){var n;if(t.clipExtent){var i=this.getMap(),o=i?i.getProjection():null;n=new Ph(t.clipExtent,o)}for(var s=[],a=this.getGeometries(),l=0,c=a.length;l<c;l++){var u=a[l],f=u.getExtent();if(f&&(!n||n.intersects(f))){var g=u.toJSON(t.geometries);s.push(g)}}e.geometries=s}return e},n.getRenderer=function(){return t.prototype.getRenderer.call(this)},e.fromJSON=function(t){if(!t||"VectorLayer"!==t.type)return null;for(var n=new e(t.id,t.options),i=t.geometries,o=[],s=0;s<i.length;s++){var a=cf.fromJSON(i[s]);a&&o.push(a)}return n.addGeometry(o),n},e.getPainterClass=function(){return Wu},e.getCollectionPainterClass=function(){return Xu},e}(Wd);pA.mergeOptions(gA),pA.registerJSONType("VectorLayer"),Zd.setLayerClass(pA,pA,pA);var AA=function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n.getPrepareParams=function(){return[]},n.getDrawParams=function(){return[]},n.onCanvasCreate=function(){this.canvas&&this.layer.options.doubleBuffer&&(this.buffer=zl.createCanvas(this.canvas.width,this.canvas.height,this.getMap().CanvasClass))},n.needToRedraw=function(){return!!this.layer.options.animation||!(this.getMap().isInteracting()&&!this.layer.drawOnInteracting)&&t.prototype.needToRedraw.call(this)},n.draw=function(...t){this.prepareCanvas(),this.prepareDrawContext(),this._drawLayer(...t)},n.drawOnInteracting=function(...t){this._drawLayerOnInteracting(...t)},n.getCanvasImage=function(){var e=t.prototype.getCanvasImage.call(this);if(e&&e.image&&this.layer.options.doubleBuffer){var n=e.image;this.buffer.width===n.width&&this.buffer.height===n.height||(this.buffer.width=n.width,this.buffer.height=n.height);var i=this.buffer.getContext("2d"),o=this.layer.doubleBuffer(i,this.context);(void 0===o||o)&&(zl.image(i,n,0,0),e.image=this.buffer)}return e},n.remove=function(){return delete this._drawContext,t.prototype.remove.call(this)},n.onZoomStart=function(e){this.layer.onZoomStart(e),t.prototype.onZoomStart.call(this,e)},n.onZooming=function(e){this.layer.onZooming(e),t.prototype.onZooming.call(this,e)},n.onZoomEnd=function(e){this.layer.onZoomEnd(e),t.prototype.onZoomEnd.call(this,e)},n.onMoveStart=function(e){this.layer.onMoveStart(e),t.prototype.onMoveStart.call(this,e)},n.onMoving=function(e){this.layer.onMoving(e),t.prototype.onMoving.call(this,e)},n.onMoveEnd=function(e){this.layer.onMoveEnd(e),t.prototype.onMoveEnd.call(this,e)},n.onResize=function(e){this.layer.onResize(e),t.prototype.onResize.call(this,e)},n.prepareDrawContext=function(){if(!this._predrawed){var t=mA(this.getPrepareParams());this._drawContext=this.layer.prepareToDraw(this.context,...t),this._drawContext||(this._drawContext=[]),Array.isArray(this._drawContext)||(this._drawContext=[this._drawContext]),this._predrawed=!0}},n._prepareDrawParams=function(){if(!this.getMap())return null;var t=this.getViewExtent();return t.maskExtent&&!t.extent.intersects(t.maskExtent)?(this.completeRender(),null):[...[this.context,t],...mA(this.getDrawParams()),...this._drawContext]},n._drawLayer=function(...t){var e=this._prepareDrawParams();e&&(this.layer.draw.apply(this.layer,e.concat(t)),this.completeRender())},n._drawLayerOnInteracting=function(...t){if(this.layer.drawOnInteracting){var e=this._prepareDrawParams();e&&(this.layer.drawOnInteracting(...e,...t),this.completeRender())}},e}(oA);function mA(t){return t||(t=[]),Array.isArray(t)||(t=[t]),t}var yA=function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n.isCanvasRender=function(){return!0},n.prepareToDraw=function(){},n.draw=function(...t){},n.redraw=function(){return this._getRenderer()&&this._getRenderer().setToRedraw(),this},n.play=function(){return this.config("animation",!0),this},n.pause=function(){return this.config("animation",!1),this},n.isPlaying=function(){return this.options.animation},n.clearCanvas=function(){return this._getRenderer()&&this._getRenderer().clearCanvas(),this},n.requestMapToRender=function(){var t=this._getRenderer();return t&&t.requestMapToRender&&t.requestMapToRender(),this},n.completeRender=function(){return this._getRenderer()&&this._getRenderer().completeRender(),this},n.onCanvasCreate=function(){return this},n.onZoomStart=function(){},n.onZooming=function(){},n.onZoomEnd=function(){},n.onMoveStart=function(){},n.onMoving=function(){},n.onMoveEnd=function(){},n.onResize=function(){},n.doubleBuffer=function(t){return t.clearRect(0,0,t.canvas.width,t.canvas.height),this},n._getRenderer=function(){return t.prototype._getRenderer.call(this)},e}(Pf);yA.mergeOptions({doubleBuffer:!1,animation:!1}),yA.registerRenderer("canvas",AA);var _A=new _e(0,0),vA=function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n.getParticles=function(t){},n.draw=function(t,e){var n=this.getParticles(a());if(n&&0!==n.length){var i=this.getMap(),o=e.extent;e.maskExtent&&(o=e.extent.intersection(e.maskExtent)),o=o.convertTo((function(t){return i._pointToContainerPoint(t,void 0,0,_A)}));for(var s=2*Math.PI,l=0,h=n.length;l<h;l++){var c=n[l].point;if(o.contains(c)){var u=n[l].color||this.options.lineColor||"#fff",f=n[l].r;t.fillStyle!==u&&(t.fillStyle=u),f<=2?t.fillRect(c.x-f/2,c.y-f/2,f,f):(t.beginPath(),t.arc(c.x,c.y,f/2,0,s),t.fill())}}this._fillCanvas(t)}else{this._getRenderer()&&(this._getRenderer()._shouldClear=!0)}},n._fillCanvas=function(t){var e=t.globalCompositeOperation;t.globalCompositeOperation="destination-out",t.fillStyle="rgba(0, 0, 0, "+1/(this.options.trail||30)+")",t.fillRect(0,0,t.canvas.width,t.canvas.height),t.globalCompositeOperation=e},e}(yA);vA.mergeOptions({animation:!0}),vA.registerRenderer("canvas",function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n.draw=function(){this.canvas&&this.layer.options.animation&&!this._shouldClear||(this.prepareCanvas(),this._shouldClear=!1),this.prepareDrawContext(),this._drawLayer()},n.drawOnInteracting=function(){this.draw(),this._shouldClear=!1},n.onSkipDrawOnInteracting=function(){this._shouldClear=!0},e}(AA));var xA,bA,wA=zs(),TA=function(t){function e(e,n,i){var o;(o=t.call(this,i||{})||this).target=e,e.once("remove",o.delete,o);var s=o.options.symbol,a=s.markerLineWidth||1;return o.w=s.markerWidth+a,o.h=s.markerHeight+a,o.opacity=h(s.opacity)?1:s.opacity,o.map=n,o.events=i.events,o._fetchImage(),o.addTo(n),o}he(e,t);var n=e.prototype;return n.getCursor=function(){return this.options.cursor||"default"},n._fetchImage=function(){var t=this.map,e=this.options.symbol,{markerFile:n}=e;this.url=n||zo(e);var i=wA.getImage(this.url);if(!i){var o=this.w,s=this.h;if(n)(i=new Image).onload=function(){var e=t.getRenderer();e&&e.setToRedraw()},i.src=this.url;else{var a=document.createElement("canvas");a.width=o,a.height=s,i=ru(a.getContext("2d"),{x:o/2,y:s/2},e,wA)}wA.addResource([this.url,o,s],i)}wA.login(this.url),this._img=i},n.setContainerPoint=function(t){this._point=t,this._point._sub(this.w/2,this.h/2)},n.getContainerPoint=function(){return this._point.add(this.w/2,this.h/2)},n.offset=function(t){this._point._add(t)},n.render=function(t){if(!this._img)return!1;var e=this.options.symbol,n=e.markerDx||0,i=e.markerDy||0,o=this.map,{x:s,y:a}=this._point,l=this.w,h=this.h;if(s+l>0&&s<o.width&&a+h>0&&a<o.height){var c=o.getDevicePixelRatio();return t.globalAlpha=this.opacity,t.drawImage(this._img,Math.round((s+n)*c),Math.round((a+i)*c),Math.round(l*c),Math.round(h*c)),!0}return!1},n.delete=function(){if(this.map){var t=this.map.getRenderer();t&&t.removeTopElement(this)}wA.logout(this.url),this._dragger&&(this._dragger.disable(),delete this._dragger),delete this.map},n.hitTest=function(t){var e=this.options.symbol,n=this._point.x+(e.markerDx||0),i=this._point.y+(e.markerDy||0);return t.x>=n&&t.x<=n+this.w&&t.y>=i&&t.y<=i+this.h},n.addTo=function(t){this.map=t,t.getRenderer().addTopElement(this)},n.onEvent=function(t){this.fire(t.type,t)},n.mousedown=function(t){var e=this.options.cursor;e&&t.target.setCursor(e),this.onDragstart(t)},n.onDragstart=function(t){var{containerPoint:e,target:n}=t,i=n.getPanels().mapWrapper||n.getContainer(),o=this._dragger=new dh(i);o.on("dragging",this.onDragging,this).on("mouseup",this.onDragend,this).enable(),o.onMouseDown(t.domEvent),xA=e.x,bA=e.y,this.fire("dragstart",{containerPoint:e})},n.onDragging=function(t){if(this._dragger){var e=this.map,n=Zi(t.domEvent,e.getContainer()),i={x:n.x-xA,y:n.y-bA},o=e.containerPointToCoord(new _e(xA,bA)),s=e.containerPointToCoord(n);xA=n.x,bA=n.y,this.offset(i),this.fire("dragging",{containerPoint:n,coordOffset:s._sub(o)})}},n.onDragend=function(t){if(this._dragger){var e=this.map;e.resetCursor();var n=Zi(t.domEvent,e.getContainer());this.offset({x:n.x-xA,y:n.y-bA}),this._dragger.disable(),delete this._dragger,this.fire("dragend",{containerPoint:n})}},n.needCollision=function(){var{target:t}=this;return!this.options.ignoreCollision&&(t&&t.options&&t.options.collision)},n.getRenderBBOX=function(t){var{target:e,map:n}=this;if(!e||!e.options||!n)return null;var i=this.options.symbol,o=i.markerDx||0,s=i.markerDy||0,{x:a,y:l}=this._point,h=this.w,c=this.h;t=t||n.getDevicePixelRatio(),this.bbox=this.bbox||ws();var u=Math.round((a+o)*t),f=Math.round((l+s)*t),g=Math.round(h*t),A=Math.round(c*t);this.bbox[0]=u,this.bbox[1]=f,this.bbox[2]=u+g,this.bbox[3]=f+A;var{options:m}=e;return Es(this.bbox,m.collisionBufferSize||0),this.bbox},n.setZIndex=function(t){this.options.zIndex=t},e}(Xl(Ql)),MA=function(){function t(t,e,n){this.target=t,t.once("remove",this.delete,this),this.map=e,this.options=n||{},this.addTo(e)}var e=t.prototype;return e.setPoints=function(t){this.points=t;var e=t.map((function(t){return t.x})),n=t.map((function(t){return t.y}));this.xmin=Math.min(...e),this.xmax=Math.max(...e),this.ymin=Math.min(...n),this.ymax=Math.max(...n)},e.hitTest=function(){return!1},e.render=function(t){var e=this.map;if(!(this.xmax<=0||this.xmin>=e.width||this.ymax<=0||this.ymin>=e.height)){var n=e.getDevicePixelRatio();t.lineWidth=1,t.strokeStyle="#000",t.globalAlpha=1,t.beginPath();var i=this.points;t.moveTo(s(i[0].x),s(i[0].y));for(var o=1;o<this.points.length;o++)t.lineTo(s(i[o].x),s(i[o].y));t.closePath(),t.stroke()}function s(t){return Math.round(t)*n+.5}},e.addTo=function(t){this.map=t,t.getRenderer().addTopElement(this)},e.delete=function(){if(this.map){var t=this.map.getRenderer();t&&t.removeTopElement(this)}},t}(),CA=Fn+"_edit_stage_";function SA(t,e){return{markerType:t,markerFill:"#fff",markerLineColor:"#000",markerLineWidth:2,markerWidth:10,markerHeight:10,opacity:e}}function PA(t,e){var n=t.getGLRes(),i=t.coordToPointAtRes(e,n);return t._pointAtResToContainerPoint(i,n,e.z||0)}function OA(t,e,n){var i=t.getMap();if(!e||0===e.z)return i.containerPointToCoord(n);var o=e.z,s=i.getGLRes(),a=i.coordToPointAtRes(e,s),l=i._pointAtResToContainerPoint(a,s,0),h=i._pointAtResToContainerPoint(a,s,o).sub(l),c=n.sub(h),u=i.containerPointToCoord(c);return u.z=0,!t.getGeometries&&t.isPoint&&(u.z=o),u}function EA(t){var e=this.target,n=this.paramOptions;return e._updating=!0,n.onDown&&(n.onDown.call(e,t.containerPoint,t),e._geometry.fire("handledragstart")),!1}function kA(t){var e=this.target,n=this.paramOptions;return e._hideContext(),n.onMove&&(n.onMove.call(e,t),e._geometry.fire("handledragging")),!1}function RA(t){var e=this.target,n=this.paramOptions;return n.onUp&&(n.onUp.call(e,t),e._geometry.fire("handledragend")),e._updating=!1,!1}var LA={fixAspectRatio:!1,symbol:null,removeVertexOn:"contextmenu",centerHandleSymbol:SA("ellipse",1),vertexHandleSymbol:SA("square",1),newVertexHandleSymbol:SA("square",.4),collision:!1,collisionBufferSize:0,vertexZIndex:0,newVertexZIndex:0,shadowDraggable:!1},DA=function(t){function e(e,n){var i;return(i=t.call(this,n)||this)._geometry=e,i._geometry?i:ne(i)}he(e,t);var n=e.prototype;return n.getMap=function(){return this._geometry.getMap()},n.prepare=function(){var t=this.getMap();t&&(t.on("drawtopstart",this._refresh,this),this.options.symbol&&(this._originalSymbol=this._geometry.getSymbol(),this._geometry.setSymbol(this.options.symbol)),this._prepareEditStageLayer())},n._prepareEditStageLayer=function(){var t=this._geometry.getLayer();if("canvas"===t.options.renderer){var e=this.getMap(),n=we(),i=CA+n+"_shadow";if(this._shadowLayer=e.getLayer(i),!this._shadowLayer)this._shadowLayer=new(0,t.constructor)(i),e.addLayer(this._shadowLayer)}},n.start=function(){if(this._geometry&&this._geometry.getMap()&&!this._geometry.editing){this.editing=!0,this.prepare();var t,e=this._geometry,n="canvas"===this._geometry.getLayer().options.renderer;this._geometryDraggble=e.options.draggable,n?(e.config("draggable",!1),(t=e.copy()).setSymbol(e._getInternalSymbol()),t.copyEventListeners(e),e._getParent()&&t.copyEventListeners(e._getParent()),t._setEventTarget(e),t.setId(null).config({draggable:this.options.shadowDraggable}),this._shadow=t,e.hide()):e instanceof ld&&e.config("draggable",!0),this._switchGeometryEvents("on"),(e instanceof ld||e instanceof Md||e instanceof Pd||e instanceof Sd)&&this._createOrRefreshOutline(),this._shadowLayer&&this._shadowLayer.bringToFront().addGeometry(t),e instanceof ld?t&&(t.config("draggable",!0),t.on("dragend",this._onMarkerDragEnd,this)):this._createCenterHandle(),e instanceof ld&&!1!==this.options.resize?this.createMarkerEditor():e instanceof Md?this.createCircleEditor():e instanceof Pd||e instanceof Sd?this.createEllipseOrRectEditor():e instanceof Id||(e instanceof od||e instanceof cd)&&this.createPolygonEditor()}},n.stop=function(){delete this._history,delete this._historyPointer,delete this._editOutline,this._switchGeometryEvents("off"),this.getMap()?(this._geometry.config("draggable",this._geometryDraggble),this._shadow&&(delete this._shadow,delete this._geometryDraggble,this._geometry.show()),this._shadowLayer&&(this._shadowLayer.remove(),delete this._shadowLayer),this._refreshHooks=[],this.options.symbol&&(this._geometry.setSymbol(this._originalSymbol),delete this._originalSymbol),this.editing=!1,this.fire("remove")):this.fire("remove")},n.isEditing=function(){return!h(this.editing)&&this.editing},n._getGeometryEvents=function(){return{symbolchange:this._onGeoSymbolChange,dragstart:this._onDragStart,dragend:this._onDragEnd,"positionchange shapechange":this._exeAndReset}},n._switchGeometryEvents=function(t){if(this._geometry){var e=this._getGeometryEvents();for(var n in e)this._geometry[t](n,e[n],this)}},n._onGeoSymbolChange=function(t){this._shadow&&this._shadow.setSymbol(t.target._getInternalSymbol())},n._onMarkerDragEnd=function(){this._update("setCoordinates",this._shadow.getCoordinates().toArray())},n._createOrRefreshOutline=function(){var t=this._geometry,e=this._editOutline;e||(this._editOutline=new MA(this,this.getMap()),this._addRefreshHook(this._createOrRefreshOutline));var n=this._editOutline.points;if(t instanceof ld)this._editOutline.setPoints(t.getContainerExtent().toArray(n));else{var i=t.getShell(),o=t._getEditCenter(),s=ws();Ps(i,s);var a=new Ph(s[0],s[1],s[2],s[3]),l=this.getMap(),h=a.toArray().map((function(t){return t.z=o.z,PA(l,t)}));this._editOutline.setPoints(h)}return e},n._createCenterHandle=function(){var t,e=this,n=this.getMap(),i=this.options.centerHandleSymbol,o=PA(n,this._geometry._getEditCenter()),s=this.createHandle(o,{ignoreCollision:!0,symbol:i,cursor:"move",onDown:function(){if(e._shadow){var n=Go((t=e._shadow.copy())._getInternalSymbol(),.5);t.setSymbol(n).addTo(e._geometry.getLayer())}},onMove:function(n){var i=n.coordOffset;t?t.translate(i):e._geometry.translate(i)},onUp:function(){if(t){var n=t.getFirstCoordinate(),i=e._geometry.getFirstCoordinate(),o=n.sub(i);e._update("translate",o),t.remove()}}});this._addRefreshHook((function(){var t=e._geometry._getEditCenter();s.setContainerPoint(PA(n,t))}))},n._createHandleInstance=function(t,e){e=e||{};var n=this.getMap(),i=no(e.symbol,(function(){return[n.getZoom(),{"{bearing}":n.getBearing(),"{pitch}":n.getPitch(),"{zoom}":n.getZoom()}]})),o=new TA(this,n,{symbol:i,cursor:e.cursor,events:this.options.removeVertexOn,ignoreCollision:e.ignoreCollision});return o.setContainerPoint(t),o},n.createHandle=function(t,e){e||(e={});var n=this._createHandleInstance(t,e);return n.paramOptions=e,n.on("dragstart",EA),n.on("dragging",kA),n.on("dragend",RA),e.onRefresh&&(n.refresh=e.onRefresh),n},n._createResizeHandles=function(t,e,n){var i=this,o=["nw-resize","n-resize","ne-resize","w-resize","e-resize","sw-resize","s-resize","se-resize"],s=[null,"y",null,"x","x",null,"y",null],a=this._geometry,l=a instanceof ld,h=[];t||(t=[]);var c=this,u=[],f={},g=this.getMap(),A=this.options.vertexHandleSymbol,m=function(){for(var m=function(){if(l){var t=a.getContainerExtent();return[new _e(t.xmin,t.ymin),new _e((t.xmax+t.xmin)/2,t.ymin),new _e(t.xmax,t.ymin),new _e(t.xmin,(t.ymin+t.ymax)/2),new _e(t.xmax,(t.ymin+t.ymax)/2),new _e(t.xmin,t.ymax),new _e((t.xmax+t.xmin)/2,t.ymax),new _e(t.xmax,t.ymax)]}var e=a.getShell(),n=a._getEditCenter(),i=ws();Ps(e,i);var o=new Ph(i[0],i[1],i[2],i[3]);return(h=[new gh(o.xmin,o.ymax),new gh((o.xmax+o.xmin)/2,o.ymax),new gh(o.xmax,o.ymax),new gh(o.xmin,(o.ymax+o.ymin)/2),new gh(o.xmax,(o.ymax+o.ymin)/2),new gh(o.xmin,o.ymin),new gh((o.xmax+o.xmin)/2,o.ymin),new gh(o.xmax,o.ymin)]).map((function(t){return t.z=n.z,PA(g,t)}))}(),w=function(l){if(Array.isArray(t)&&t.some((function(t){return t===l})))return 1;var g,w=m[l],T=h[l];if(u.length<m.length-t.length){var M=i.createHandle(w,{symbol:A,cursor:o[l],axis:s[l],onMove:(g=l,function(t){c._updating=!0,e(t.containerPoint,g),a.fire("resizing")}),onUp:function(){c._updating=!1,n()}});f[l]=u.length,u.push(M),M.coord=T}else u[f[l]].coord=T,u[f[l]].setContainerPoint(w)},T=0;T<m.length;T++)w(T)};return m(),this._addRefreshHook(m),u},n.createMarkerEditor=function(){var t=this,e=this._shadow||this._geometry,n=this.getMap();if(e._canEdit()){this._history||this._recordHistory(m());var i=e._getInternalSymbol(),o=new _e(0,0);c(i.markerDx)&&(o.x=i.markerDx),c(i.markerDy)&&(o.y=i.markerDy);var s=null,a="middle",l="middle";if(Ou.test(i)){var h=i.markerType;"pin"===h||"pie"===h||"bar"===h?(s=[5,6,7],a="bottom"):"rectangle"===h&&(s=[0,1,2,3,5],a="top",l="left")}else(pu.test(i)||Eu.test(i))&&(a="bottom",s=[5,6,7]);var u,f=[2,1,2,0,0,2,1,2];if(this.options.fixAspectRatio){var g=e.getSize();u=g.width/g.height}var A=this._createResizeHandles(s,(function(i,h){if(s&&s.indexOf(h)>=0){var c=n.containerPointToCoordinate(i.sub(o)),g=e.getCoordinates();c.x=g.x,e.setCoordinates(c),t._updateCoordFromShadow(!0),i=A[A.length-1-h].getContainerPoint()}var m=PA(n,e._getEditCenter()).add(o),w=e._getInternalSymbol(),T=i.sub(m);"bottom"===a&&i.y>m.y&&(T.y=0);var M="middle"===a?2:1,C="left"===l?1:2,P=Math.abs(T.x)*C,I=Math.abs(T.y)*M;u&&(I=(P=Math.max(P,I*u))/u);var O=f[h];e instanceof Nd?((u||0===O||2===O)&&(e.setWidth(P),e!==t._geometry&&t._geometry.setWidth(P)),(u||1===O||2===O)&&(e.setHeight(I),e!==t._geometry&&t._geometry.setHeight(I))):((u||0===O||2===O)&&(w.markerWidth=Math.min(P,t._geometry.options.maxMarkerWidth||1/0)),(u||1===O||2===O)&&(w.markerHeight=Math.min(I,t._geometry.options.maxMarkerHeight||1/0)),e.setSymbol(w),e!==t._geometry&&t._geometry.setSymbol(w))}),(function(){t._update(m())}))}else console&&console.warn("A marker can't be resized with symbol:",e.getSymbol());function m(){var t=[["setCoordinates",e.getCoordinates().toArray()]];return e instanceof Nd?(t.push(["setWidth",e.getWidth()]),t.push(["setHeight",e.getHeight()])):t.push(["setSymbol",e.getSymbol()]),t}},n.createCircleEditor=function(){var t=this,e=this._shadow||this._geometry,n=this.getMap();this._history||this._recordHistory([["setCoordinates",e.getCoordinates().toArray()],["setRadius",e.getRadius()]]),this._createResizeHandles(null,(function(i){var o=e.getCenter(),s=OA(e,o,i),a=new cd([[o.x,o.y],[s.x,o.y]]),l=new cd([[o.x,o.y],[o.x,s.y]]),h=Math.max(n.computeGeometryLength(a),n.computeGeometryLength(l));e.setRadius(h),e!==t._geometry&&t._geometry.setRadius(h)}),(function(){t._update("setRadius",e.getRadius())}))},n.createEllipseOrRectEditor=function(){var t=this,e=[2,1,2,0,0,2,1,2],n=this._shadow||this._geometry;this._history||this._recordHistory(l());var i,o=this.getMap(),s=this._geometry instanceof Pd;this.options.fixAspectRatio&&(i=n.getWidth()/n.getHeight());var a=this._createResizeHandles(null,(function(l,h){var c,u,f,g=s?1:2,A=a[h].getContainerPoint(),m=e[h];if(s){var w=a[7-h],T=w.getContainerPoint(),M=(c=A.sub(T)).abs();u=o.pixelToDistance(M.x,0),f=o.pixelToDistance(0,M.y);var C=n.getSize(),P=n.getCoordinates(),I=n.getWidth(),O=n.getHeight(),E=w.coord,D=OA(n,P,l),N=new cd([[E.x,E.y],[D.x,E.y]]),H=new cd([[E.x,E.y],[E.x,D.y]]);if(u=o.computeGeometryLength(N),f=o.computeGeometryLength(H),0===m)if(i&&(M.y=M.x/i,C.height=Math.abs(M.y),f=u/i),A.y=T.y-C.height/2,D.y=P.y,4===h)D.x=Math.min(D.x,P.x);else{var U=o.locate(P,I,0);D.x=o.locate(new gh(U.x,D.y),-u,0).x}else if(1===m)i&&(M.x=M.y*i,C.width=Math.abs(M.x),u=f*i),A.x=T.x-C.width/2,D.x=P.x,D.y=Math.max(D.y,E.y);else{if(i&&(u>f*i?(f=u/i,A.y=T.y+M.x*Ge(c.y)/i):(u=f*i,A.x=T.x+M.y*Ge(c.x)*i)),0===h||5===h){var W=o.locate(P,I,0===h?0:-O);D.x=o.locate(new gh(W.x,D.y),-u,0).x}else D.x=Math.min(D.x,E.x);D.y=Math.max(D.y,E.y)}D.z=P.z,n.setCoordinates(D),t._updateCoordFromShadow(!0)}else{var q=n.getCenter(),X=OA(n,q,l),J=new cd([[q.x,q.y],[X.x,q.y]]),Q=new cd([[q.x,q.y],[q.x,X.y]]);u=o.computeGeometryLength(J),f=o.computeGeometryLength(Q),i&&(f=(u=Math.max(u,f*i))/i)}(i||0===m||2===m)&&(n.setWidth(u*g),n!==t._geometry&&t._geometry.setWidth(u*g)),(i||1===m||2===m)&&(n.setHeight(f*g),n!==t._geometry&&t._geometry.setHeight(f*g))}),(function(){t._update(l())}));function l(){return[["setCoordinates",n.getCoordinates().toArray()],["setWidth",n.getWidth()],["setHeight",n.getHeight()]]}},n.createPolygonEditor=function(){var t=this.getMap(),e=this._shadow||this._geometry,n=this;this._history||this._recordHistory("setCoordinates",gh.toNumberArrays(e.getCoordinates()));var i=e instanceof od?3:2,o="ispace--editor-vertex-index",{vertexZIndex:s,newVertexZIndex:a}=this.options,l={0:[]},h={0:[]};function u(t,n){if(e instanceof od){var i=e.getCoordinates();i[n]=t,e.setCoordinates(i)}else e.setCoordinates(t)}function f(t=0){if(e instanceof od){var n=e.getCoordinates()[t]||[];return n.slice(0,n.length-1)}return e.getCoordinates()}function g(){for(var t in l){for(var e=l[t].length-1;e>=0;e--)l[t][e][o]=e;for(var i=h[t].length-1;i>=0;i--)h[t][i][o]=i}n._updateCoordFromShadow()}function m(s){n._updating=!0;var a=s.target,A=a[o],m=c(a._ringIndex)?a._ringIndex:0,w=f(m);if(w.length<=i)console.warn(" Geometry."+e.type+" Require at least "+i+" vertices,Geometry: ",e);else{if(w.splice(A,1),u(w,m),0===A)h[m][0].delete(),h[m].splice(0,1);else if(A===l[m].length-1){var T=h[m].length;h[m][T-1].delete(),h[m].splice(T-1,1)}else h[m][A-1].delete(),h[m].splice(A-1,1),h[m][A-1].delete(),h[m].splice(A-1,1),h[m].splice(A-1,0,I.call(n,A-1,m));if(l[m].splice(A,1)[0].delete(),m>0){var M=e.getCoordinates(),C=M[m];C&&Array.isArray(C)&&C.length>1&&e!==this._geometry&&e.setCoordinates(M)}g(),n._updating=!1,n._geometry.fire("handleremove",Object.assign({},s,{coordinate:t.containerPointToCoordinate(s.containerPoint),vertex:s.target}))}}function w(t,i,o=0){var s=n._geometry.snapTo;s&&A(s)&&(t=n._geometry.snapTo(t)||t);var a,l=f(o),c=t.sub(M()),u=OA(n._geometry,l[i],c),g=l[i];g.x=u.x,g.y=u.y,e.setCoordinates(e.getCoordinates()),n._updateCoordFromShadow(!0),a=0===i?h[o].length-1:i-1,h[o][i]&&h[o][i].refresh(),h[o][a]&&h[o][a].refresh()}var T=new _e(0,0);function M(){var t=e._getCompiledSymbol();return T.x=t.lineDx||0,T.y=t.lineDy||0,T}function C(e,i=0,a){var l=(a||f(i))[e],h=PA(t,l)._add(M()),c=n.createHandle(h,{symbol:n.options.vertexHandleSymbol,cursor:"pointer",axis:null,onMove:function(){w(c.getContainerPoint(),c[o],i)},onRefresh:function(e,n){if(l=(n||f(i))[c[o]]){var s=PA(t,l);c.setContainerPoint(s._add(M()))}},onUp:function(){n._updateCoordFromShadow()},onDown:function(t,e){}});return c[o]=e,c._ringIndex=i,c.on(n.options.removeVertexOn,m),c.setZIndex(s),c}var P=!1;function I(e,i=0,s){var c=s||f(i),A=c[e].add(e+1>=c.length?c[0]:c[e+1]).multi(.5),m=n.createHandle(A,{symbol:n.options.newVertexHandleSymbol,cursor:"pointer",axis:null,onDown:function(t,e){if(!e||!e.domEvent||2!==e.domEvent.button){var s=f(i),a=m[o],l=s[a].add(s[a+1]||s[0]).multi(.5);s.splice(a+1,0,l),u(s,i),m.opacity=1,h[i].splice(a,0,I.call(n,a,i),I.call(n,a+1,i)),P=!0}},onMove:function(){w(m.getContainerPoint(),m[o]+1,i)},onUp:function(t){if(t&&t.domEvent&&2===t.domEvent.button)P=!1;else{var e=m[o];Le(m,h[i]),m.delete(),l[i].splice(e,0,C.call(n,e,i)),g(),n._updateCoordFromShadow(),P=!1}},onRefresh:function(e,n){c=n||f(e);var i,s=m[o];if(i=s===c.length-1?0:s+1,c[s]&&c[i]){var a=c[s].add(c[i]).multi(.5),l=PA(t,a);m.setContainerPoint(l._add(M()))}}});return m[o]=e,m.setZIndex(a),m}if(e instanceof od)for(var O=e.getHoles().length+1,E=0;E<O;E++){l[E]=[],h[E]=[];for(var D=f(E),N=0,H=D.length;N<H;N++)l[E].push(C.call(this,N,E,D)),N<H-1&&h[E].push(I.call(this,N,E,D));h[E].push(I.call(this,D.length-1,E,D))}else{for(var U=f(0),W=0,q=U.length;W<q;W++)l[0].push(C.call(this,W,0,U)),W<q-1&&h[0].push(I.call(this,W,0,U));h[0].length&&2===e.getCoordinates().length&&(h[0][0].options.symbol.markerDx=12)}var X=t.getRenderer();X&&X.sortTopElements(),this._addRefreshHook((function(){if(!P){for(var t in h)for(var n=f(t),i=h[t].length-1;i>=0;i--)h[t][i].refresh(t,n);for(var o in h[0].length&&e instanceof cd&&(2===e.getCoordinates().length?h[0][0].options.symbol.markerDx=12:e.getCoordinates().length>2&&(h[0][0].options.symbol.markerDx=0)),l)for(var s=f(o),a=l[o].length-1;a>=0;a--)l[o][a].refresh(o,s)}}))},n._refresh=function(){if(this._refreshHooks)for(var t=this._refreshHooks.length-1;t>=0;t--)this._refreshHooks[t].call(this)},n._hideContext=function(){this._geometry&&(this._geometry.closeMenu(),this._geometry.closeInfoWindow())},n._addRefreshHook=function(t){t&&(this._refreshHooks||(this._refreshHooks=[]),this._refreshHooks.push(t))},n._update=function(t,...e){this._exeHistory([t,e]),this._recordHistory(t,...e)},n._updateCoordFromShadow=function(t){var e=(this._shadow||this._geometry).getCoordinates(),n=this._geometry,i=this._updating;this._updating=!0,n.setCoordinates(e),t||this._recordHistory("setCoordinates",gh.toNumberArrays(n.getCoordinates())),this._updating=i},n._recordHistory=function(t,...e){if(this._history||(this._history=[],this._historyPointer=0),this._history.length){var n=this._history[this._history.length-1];if(n[0]===t&&JSON.stringify(n[1])===JSON.stringify(e))return}this._historyPointer<this._history.length-1&&this._history.splice(this._historyPointer+1),this._history.push([t,e]),this._historyPointer=this._history.length-1,this._geometry.fire("editrecord")},n.cancel=function(){return this._history&&0!==this._historyPointer?(this._historyPointer=0,this._exeAndReset(this._history[0]),this):this},n.undo=function(){if(this._isundoEdit())return this;var t=this._history[--this._historyPointer];return this._exeAndReset(t),this},n.redo=function(){if(this._isRedoEdit())return this;var t=this._history[++this._historyPointer];return this._exeAndReset(t),this},n._exeAndReset=function(t){if(!this._updating){this._exeHistory(t);var e=this._history,n=this._historyPointer;this.stop(),this._history=e,this._historyPointer=n,this.start()}},n._onDragStart=function(){this._updating=!0},n._onDragEnd=function(){this._updating=!1},n._exeHistory=function(t){if(Array.isArray(t)){var e=this._updating;this._updating=!0;var n=this._shadow||this._geometry,i=this._geometry;Array.isArray(t[0])?t[0].forEach((function(t){var e=t[0],o=t.slice(1);n[e].call(n,...o),n!==i&&i[e].call(i,...o)})):(n[t[0]].call(n,...t[1]),n!==i&&i[t[0]].call(i,...t[1])),this._updating=e}},n._isRedoEdit=function(){return!this._history||this._historyPointer===this._history.length-1},n._isundoEdit=function(){return!this._history||0===this._historyPointer},e}(Xl(Ql));DA.mergeOptions(LA),Fd.include({startEditText:function(){return this.getMap()?(this._recordVisible(),this.hide(),this.endEditText(),this._prepareEditor(),this._fireEvent("edittextstart"),this):this},endEditText:function(){if(this._textEditor){var t=this._textEditor.innerHTML;t=t.replace(/<p>/gi,"").replace(/<\/p>/gi,"<br/>"),this._textEditor.innerHTML=t;var e=this._textEditor.innerText.replace(/[\r\n]+$/gi,"");this.setContent(e),sr(this._textEditor,"mousedown dblclick",zi),this.getMap().off("mousedown",this.endEditText,this),this._editUIMarker.remove(),delete this._editUIMarker,this._textEditor.onkeyup=null,delete this._textEditor,this._recoveryVisible(),this.show(),this._fireEvent("edittextend")}return this},isEditingText:function(){return!!this._textEditor},getTextEditor:function(){return this._editUIMarker},_prepareEditor:function(){var t=this.getMap(),e=this._createEditor();this._textEditor=e,t.on("mousedown",this.endEditText,this);var n=this._getEditorOffset();this._editUIMarker=new Dg(this.getCoordinates(),{animation:null,content:e,dx:n.dx,dy:n.dy}).addTo(t),this._setCursorToLast(this._textEditor)},_getEditorOffset:function(){var t=this._getInternalSymbol()||{},e=0,n=0,i=t.textHorizontalAlignment;return"middle"===i||h(i)?(e=(t.textDx||0)-2,n=(t.textDy||0)-2):(e=(t.markerDx||0)-2,n=(t.markerDy||0)-2),{dx:e,dy:n}},_createEditor:function(){var t=this.getContent(),e=this.getSize(),n=this._getInternalSymbol()||{},i=e.width,o=n.textFill||"#000000",s=n.textSize||12,a=e.height,l=n.markerLineColor||"#000",h=n.markerFill||"#3398CC",c=n.textLineSpacing||0,u=Pi("div");return u.contentEditable=!0,u.style.cssText="background:"+h+"; border:1px solid "+l+";\n            color:"+o+";font-size:"+s+"px;width:"+(i-2)+"px;height:"+(a-2)+"px;margin: auto;\n            line-height:"+(s+c)+"px;outline: 0; padding:0; margin:0;word-wrap: break-word;\n            overflow: hidden;-webkit-user-modify: read-write-plaintext-only;",u.innerText=t,or(u,"mousedown dblclick",zi),u.onkeyup=function(t){13===t.keyCode&&(u.style.height=parseInt(u.style.height||0)+s/2+"px")},u},_setCursorToLast:function(t){var e;window.getSelection?(t.focus(),(e=window.getSelection()).selectAllChildren(t),e.collapseToEnd()):document.selection&&((e=document.selection.createRange()).moveToElementText(t),e.collapse(!1),e.select())}}),cf.include({animate:function(t,e,n){var i=this;this._animPlayer&&this._animPlayer.finish(),A(e)&&(n=e),e||(e={});var o,s=this.getMap(),a=this._getProjection(),l=this._prepareAnimationStyles(t),h=e.focus;if(delete this._animationStarted,s){var c=s._getRenderer();e.framer=function(t){c.callInNextFrame(t)}}if(a||!h){var u=Yf.animate(l,e,(function(t){if(s&&s.isRemoved())u.finish();else{s&&!i._animationStarted&&h&&s.onMoveStart();var e=t.styles;for(var l in e)if("symbol"!==l&&"translate"!==l&&e.hasOwnProperty(l)){var c="set"+l[0].toUpperCase()+l.slice(1);i[c](e[l])}var f=e.translate;if(f){var g=f;o&&(g=f.sub(o)),o=f,i.translate(g)}var A=e.symbol;if(A){var m=i.getSymbol()||{};i.setSymbol(jo(m,A))}if(s&&h){var w=a.project(i.getCenter());s._setPrjCenter(w);var T=s._parseEventFromCoord(a.unproject(w));"running"!==u.playState?s.onMoveEnd(T):s.onMoving(T)}i._fireAnimateEvent(u.playState),n&&n(t)}}),this);return this._animPlayer=u,this._animPlayer.play()}console.error(nd)},_prepareAnimationStyles:function(t){var e=this._getInternalSymbol(),n={};for(var i in t)if(t.hasOwnProperty(i)){var o=t[i];if("translate"!==i&&"symbol"!==i){var s=this["get"+i[0].toUpperCase()+i.substring(1)]();n[i]=[s,o]}else if("symbol"===i){var a=void 0;if(Array.isArray(t.symbol)){if(!Array.isArray(e))throw new Error("geometry'symbol isn't a composite symbol, while the symbol in styles is.");a=[];for(var l=t.symbol,h=0;h<l.length;h++)if(l[h]){var c={};for(var u in l[h])l[h].hasOwnProperty(u)&&(c[u]=[e[h][u],l[h][u]]);a.push(c)}else a.push(null)}else{if(Array.isArray(e))throw new Error("geometry'symbol is a composite symbol, while the symbol in styles isn't.");for(var f in a={},o)o.hasOwnProperty(f)&&(a[f]=[e[f],o[f]])}n.symbol=a}else"translate"===i&&(n.translate=new gh(o))}return n},_fireAnimateEvent:function(t){"finished"===t?(delete this._animationStarted,this._fireEvent("animateend")):"running"===t&&(this._animationStarted?this._fireEvent("animating"):(this._fireEvent("animatestart"),this._animationStarted=!0))}});var FA=Fn+"_drag_stage",NA=Gt.touch?"touchstart mousedown":"mousedown";function HA(t,e,n){var i=t._getEditCenter(),o=t.getMap();if(!i||0===i.z)return n||o.containerPointToCoord(e);var s=i.z,a=o.getGLRes(),l=o.coordToPointAtRes(i,a),h=o._pointAtResToContainerPoint(l,a,0),c=o._pointAtResToContainerPoint(l,a,s).sub(h),u=e.sub(c),f=o.containerPointToCoord(u);return f.z=0,!t.getGeometries&&t.isPoint&&(f.z=s),f}var BA=function(t){function e(e){return t.call(this,e)||this}he(e,t);var n=e.prototype;return n.addHooks=function(){this.target.on(NA,this._startDrag,this)},n.removeHooks=function(){this._endDrag(),this.target.off(NA,this._startDrag,this),delete this.container},n._prepareDragHandler=function(){this._dragHandler=new dh(this.container),this._dragHandler.on("dragging",this._dragging,this).on("mouseup",this._endDrag,this).enable()},n._prepareShadow=function(){var t=this,e=this.target;if("canvas"===e.getLayer().options.renderer&&e.options.dragShadow){this._prepareDragStageLayer(),this._shadow&&this._shadow.remove();var n=this._shadow=e.copy();if(n.getGeometries){var i=n.getGeometries(),o=e.getGeometries();i.forEach((function(e,n){t._updateShadowSymbol(e,o[n])}))}else this._updateShadowSymbol(n,e);n.setId(null),this._prepareShadowConnectors()}},n._updateShadowSymbol=function(t,e){if(t.setSymbol(e._getInternalSymbol()),e.options.dragShadow){var n=Go(t._getInternalSymbol(),.5);t.setSymbol(n)}},n._prepareShadowConnectors=function(){var t=this.target,e=this._shadow,n=this._dragStageLayer._getRenderer().resources,i=[];if(Gd._hasConnectors(t))for(var o=Gd._getConnectors(t),s=0,a=o.length;s<a;s++){var l=o[s],h=l.config(),c=l._getInternalSymbol();h.symbol=Go(c,.5);var u=void 0;u=l.getConnectSource()===t?new l.constructor(e,l.getConnectTarget(),h):new l.constructor(l.getConnectSource(),e,h),i.push(u),l.getLayer()&&l.getLayer()._getRenderer()&&n.merge(l.getLayer()._getRenderer().resources)}this._shadowConnectors=i,i.push(e),this._dragStageLayer.bringToFront().addGeometry(i)},n._onTargetUpdated=function(){this._shadow&&this._shadow.setSymbol(this.target._getSymbol())},n._prepareDragStageLayer=function(){var t=this.target.getMap(),e=this.target.getLayer(),n=t.getLayer(FA);n&&n.remove(),this._dragStageLayer=new(0,e.constructor)(FA,{enableAltitude:e.options.enableAltitude,altitudeProperty:e.options.altitudeProperty}),t.addLayer(this._dragStageLayer);var i=zs();i.merge(e._getRenderer().resources),this._dragStageLayer._getRenderer().resources=i},n._startDrag=function(t){var e=this.target.getMap();if(e&&(!this.target._getParent()&&!this.isDragging())){var n=t.domEvent;if(!(n.touches&&n.touches.length>1||2===n.button)){this.container=e.getPanels().mapWrapper||e.getContainer(),this.target.on("click",this._endDrag,this);var i=this._correctCoord(t.coordinate);this._lastCoord=HA(this.target,t.containerPoint,i),this._lastPoint=t.containerPoint,this._prepareDragHandler(),this._dragHandler.onMouseDown(t.domEvent),or(this.container,"mouseleave",this._endDrag,this),this._startParam=t,this._moved=!1}}},n._dragging=function(t){var e=this.target,n=e.getMap();if(!n._isEventOutMap(t.domEvent)){var i=n._parseEvent(t.domEvent),o=i.domEvent;if(!(o.touches&&o.touches.length>1||n._isContainerPointOutOfMap(i.containerPoint))){if(!this._moved)return this._moved=!0,e.on("symbolchange",this._onTargetUpdated,this),this._isDragging=!0,this._prepareShadow(),this._shadow&&(e.options.dragShadow||e.hide(),this._shadow._fireEvent("dragstart",i)),this.target._fireEvent("dragstart",this._startParam||i),void delete this._startParam;var s=this._shadow||e,a=s.options.dragOnAxis,l=s.options.dragOnScreenAxis,h=i.containerPoint,c=i.coordinate;this._lastPoint=this._lastPoint||h,this._lastCoord=this._lastCoord||c,l?("x"===a?h.y=this._lastPoint.y:"y"===a&&(h.x=this._lastPoint.x),c=n.containerPointToCoord(h)):c=this._correctCoord(c),c=HA(e,i.containerPoint,c);var u=h.sub(this._lastPoint),f=c.sub(this._lastCoord);l||("x"===a?u.y=f.y=0:"y"===a&&(u.x=f.x=0)),this._lastPoint=h,this._lastCoord=c;var g=!s.getGeometries&&s.isPoint;g?s.setCoordinates(c):s.translate(f),s===e||e.options.dragShadow||(g?e.setCoordinates(c):e.translate(f)),i.coordOffset=f,i.pointOffset=u,s._fireEvent("dragging",i),s!==e&&e._fireEvent("dragging",i)}}},n._endDrag=function(t){if(this._dragHandler&&(this._dragHandler.disable(),delete this._dragHandler),this.container&&sr(this.container,"mouseleave",this._endDrag),this.target){var e=this.target;e.off("click",this._endDrag,this),e.off("symbolchange",this._onTargetUpdated,this),delete this._lastCoord,delete this._lastPoint,this._isDragging=!1;var n=e.getMap();if(this.enabled()&&n){var i=n._parseEvent(t?t.domEvent:null);this._updateTargetAndRemoveShadow(i),this._moved&&e._fireEvent("dragend",i)}}},n.isDragging=function(){return!!this._isDragging},n._updateTargetAndRemoveShadow=function(t){if(this._shadow){var e=this.target,n=e.getMap();e.options.dragShadow||e.show();var i=this._shadow;if(i){if(e.options.dragShadow){var o=i.getFirstCoordinate(),s=e.getFirstCoordinate(),a=o.sub(s);e.translate(a)}i._fireEvent("dragend",t),i.remove(),delete this._shadow}this._shadowConnectors&&(n.getLayer(FA).removeGeometry(this._shadowConnectors),delete this._shadowConnectors),this._dragStageLayer&&(this._dragStageLayer._getRenderer().resources=zs(),this._dragStageLayer.remove())}},n._correctCoord=function(t){var e=this.target.getMap();if(!e.getPitch())return t;var n=this.target;if(!n.getMinAltitude())return t;var i=(n.getMinAltitude()+n.getMaxAltitude())/2;return e.locateByPoint(t,0,-i)},e}(Jl);cf.mergeOptions({draggable:!1,dragShadow:!0,dragOnAxis:null,dragOnScreenAxis:!1}),cf.addInitHook("addHandler","draggable",BA),cf.include({isDragging:function(){return this._getParent()?this._getParent().isDragging():!!this.draggable&&this.draggable.isDragging()}}),cf.include({startEdit:function(t){var e=this.getMap();return e&&this.options.editable?(this._editor&&this.endEdit(),this._recordVisible(),this._editor=new DA(this,t),this._editor.start(),this._getParent()||this.fire("editstart"),e.getRenderer().setToRedraw(),this):this},endEdit:function(){if(this._editor){this._editor.stop(),delete this._editor,this._recoveryVisible(),this._getParent()||this.fire("editend");var t=this.getMap();t&&t.getRenderer().setToRedraw()}return this},redoEdit:function(){return this.isEditing()?(this._editor.redo(),this._getParent()||this.fire("redoedit"),this):this},undoEdit:function(){return this.isEditing()?(this._editor.undo(),this._getParent()||this.fire("undoedit"),this):this},cancelEdit:function(){return this.isEditing()?(this._recoveryVisible(),this._editor.cancel(),this._getParent()||this.fire("canceledit"),this):this},isEditing:function(){return!!this._editor&&this._editor.isEditing()},undoEditcheck:function(){if(this.isEditing())return this._editor._isundoEdit()},redoEditcheck:function(){if(this.isEditing())return this._editor._isRedoEdit()}}),cf.include({_onEvent:function(t,e){var n=this.getMap();if(n){var i=e||this._getEventTypeToFire(t);"contextmenu"===i&&this.listens("contextmenu")&&(zi(t),Hi(t));var o=n._getEventParams(t);c(this._pickGeometryIndex)&&(o.pickGeometryIndex=this._pickGeometryIndex),this._fireEvent(i,o)}},_getEventTypeToFire:function(t){return t.type}}),cf.include({setInfoWindow:function(t){return this.removeInfoWindow(),t instanceof Gg?(this._infoWindow=t,this._infoWinOptions=l({},this._infoWindow.options),this._infoWindow.addTo(this),this):(this._infoWinOptions=l({},t),this._infoWindow?this._infoWindow._setOptions(t):this.getMap()&&this._bindInfoWindow(),this)},getInfoWindow:function(){return this._infoWindow?this._infoWindow:null},openInfoWindow:function(t){return this.getMap()?(t||(t=this.getCenter()),this._infoWindow?this._infoWindow.show(t):this._infoWinOptions&&this.getMap()&&(this._bindInfoWindow(),this._infoWindow.show(t)),this):this},closeInfoWindow:function(){return this._infoWindow&&this._infoWindow.hide(),this},removeInfoWindow:function(){return this._unbindInfoWindow(),delete this._infoWinOptions,delete this._infoWindow,this},_bindInfoWindow:function(){var t=this._infoWinOptions;return t?(this._infoWindow=new Gg(t),this._infoWindow.addTo(this),this):this},_unbindInfoWindow:function(){return this._infoWindow&&(this.closeInfoWindow(),this._infoWindow.remove(),delete this._infoWindow),this}}),cf.fromJSON=function(t){if(Array.isArray(t)){for(var e=[],n=0,i=t.length;n<i;n++){var o=cf.fromJSON(t[n]);Array.isArray(t)?e=e.concat(o):e.push(o)}return e}return t&&!t.feature?Td.toGeometry(t):(t.subType?(s=cf.getJSONClass(t.subType).fromJSON(t),h(t.feature.id)||s.setId(t.feature.id)):(s=Td.toGeometry(t.feature),t.options&&s.config(t.options)),t.symbol&&s.setSymbol(t.symbol),t.infoWindow&&s.setInfoWindow(t.infoWindow),s);var s};var zA=new _e(0,0),GA=new _e(0,0),jA=[],UA=function(t){function e(){return t.call(this,da)||this}he(e,t);var n=e.prototype;return n.checkUrl=function(t){return t&&g(t)?En(t):t},n.fetchImage=function(t,e,n,i){t=this.checkUrl(t),this.send({url:t,fetchOptions:i},jA,n,e)},e}(xf),VA=function(t){var e=function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n.init=function(){var t=this;this.tilesInView={},this.tilesLoading={},this._parentTiles=[],this._childTiles=[],this._tileQueue=[],this._tileQueueIds=new Set;var e=this.layer.getTileSize().width;this.tileCache=new Xa(this.layer.options.maxCacheSize*e/512*e/512,(function(e){t.deleteTile(e)})),Gt.decodeImageInWorker&&this.layer.options.decodeImageInWorker&&("gl"===this.layer.options.renderer||!Gt.safari&&!Gt.iosWeixin)&&(this._tileImageWorkerConn=new UA),this._compareTiles=ZA.bind(this)},n.getCurrentTileZoom=function(){return this._tileZoom},n.draw=function(t,e){var n=this.getMap();if(!this.isDrawable||this.isDrawable()){var i=this.prepareCanvas();if(!i||i.intersects(this.canvasExtent2D)){var o;this._renderTimestamp!==t&&(this._consumeTileQueue(),this._computeAvgTileAltitude(),this._renderTimestamp=t);var s=!1,a=this._frameTiles;if(a&&t===a.timestamp){if(a.empty)return;o=a}else{if(!(o=this._getTilesInCurrentFrame()))return this._frameTiles={empty:!0,timestamp:t},void this.completeRender();s=!0,this._frameTiles=o,this._frameTiles.timestamp=t,o.loadingCount&&this.loadTileQueue(o.tileQueue)}var{tiles:l,childTiles:h,parentTiles:c,placeholders:u,loading:f,loadingCount:g,missedTiles:A,incompleteTiles:m}=o;this._drawTiles(l,c,h,u,e,A,m),g||f||(n.isAnimating()||!this._parentTiles.length&&!this._childTiles.length||(this._parentTiles=[],this._childTiles=[],this.setToRedraw()),this.completeRender()),s&&this.retireTiles()}else this.completeRender()}},n.getTileGridsInCurrentFrame=function(){return this._frameTileGrids},n.getCurrentTimestamp=function(){return this._renderTimestamp||0},n._getTilesInCurrentFrame=function(){var t=this.getMap();this.map=t;var e=this.layer;e._spatialRef=e.getSpatialReference();var n=e._isPyramidMode()&&e.options.terrainTileMode,i=e.getTiles();if(this._frameTileGrids=i,!(i=i.tileGrids)||!i.length)return e._spatialRef=null,this.map=null,null;var o=i.reduce((function(t,e){return t+(e&&e.tiles&&e.tiles.length||0)}),0);o>=this.tileCache.max/2&&this.tileCache.setMaxSize(2*o+1);var s=0,a=!1,l={},h=[],c=[],u={},f=[],g={},A=[],m={},w={},T=this.markTiles(),M=this._getLoadLimit(),C=i.length,P=void 0===this._tileZoom&&e.options.currentTilesFirst&&!this._terrainHelper;this._tileZoom=i[0].zoom;var I=null,O=null;n&&(I=[],O=new Map);for(var E=0;E<C;E++){var D=i[E],N=D.tiles,H=D.parents||jA,U=H.length,W=P?N:Re(H,N),q=void 0;W.length&&(q=this._generatePlaceHolder(W[0].res));for(var X=0,J=W.length;X<J;X++){var Q=W[X];e._debugTile(Q,"_getTilesInCurrentFrame");var Y=Q.id,K=!P&&X<U,$=!1,tt=h.length;if(this._isLoadingTile(Y))$=a=!0,this.markCurrent(this.tilesLoading[Y],!0);else{var et=this.getCachedTile(Q,K);if(et)K||(et.image&&this.isTileFadingIn(et.image)&&($=a=!0,this.setToRedraw()),this.isTileComplete(et)?h.push(et):($=!0,n&&O.set(Y,et)));else{$=a=!0;var nt=M&&s+T[0]>M;if(!this._tileQueueIds.has(Q.id)&&!nt&&(!t.isInteracting()||t.isMoving()||t.isRotating()))s++,w[Y]=Q}}if(n&&!K&&(h.length===tt?I.push(Q):l[Q.id]=1),!n&&!K&&$&&!l[Y]){l[Y]=1,q&&!m[Y]&&(Q.cache=!1,A.push({image:q,info:Q}),m[Y]=1);var it=this._findChildTiles(Q);if(it.length&&it.forEach((function(t){g[t.info.id]||(f.push(t),g[t.info.id]=1)})),!it.length||4!==it.length){var rt=this._findParentTile(Q);if(rt){var ot=rt.info.id;void 0===u[ot]&&(u[ot]=c.length,c.push(rt))}}}}}var st=[];if(n)for(var at=0;at<I.length;at++){var ut=I[at].info?I[at].info:I[at];if(ut.parent&&!l[ut.id]){var{tiles:ft,missedTiles:gt}=this._findChildTiles(ut);ft.length?(ke(h,ft),ke(st,gt)):O.has(ut.id)?(h.push(O.get(ut.id)),O.delete(ut.id)):(l[ut.id]=1,st.push(ut))}}return this.tileCache.shrink(),e._spatialRef=null,this.map=null,{childTiles:f,missedTiles:st,parentTiles:c,tiles:h,incompleteTiles:O&&Array.from(O.values()),placeholders:A,loading:a,loadingCount:s,tileQueue:w}},n.removeTileCache=function(t){delete this.tilesInView[t],this.tileCache.remove(t)},n.isTileCachedOrLoading=function(t){return this.tileCache.get(t)||this.tilesInView[t]||this.tilesLoading[t]},n.isTileCached=function(t){return!(!this.tileCache.get(t)&&!this.tilesInView[t])},n.isTileFadingIn=function(t){return this.getTileFadingOpacity(t)<1},n._drawTiles=function(t,e,n,i,o,s,a){e.length&&(e.sort(this._compareTiles),this._parentTiles=e),n.length&&(this._childTiles=n,this._childTiles.sort(this._compareTiles));var l=!0;this.layer.constructor!==kp&&this.layer.constructor!==Gp||(this._renderTimestamp===this.canvas._parentTileTimestamp?l=!1:this.canvas._parentTileTimestamp=this._renderTimestamp);var h={tiles:t,parentTiles:this._parentTiles,childTiles:this._childTiles,parentContext:o};if(this.onDrawTileStart(h,o),l&&1===this.layer.options.opacity){this.layer._silentConfig=!0;var c=this.layer.options.fadeAnimation;this.layer.options.fadeAnimation=!1,this._drawChildTiles(n,o),this._drawParentTiles(this._parentTiles,o),this.layer.options.fadeAnimation=c,this.layer._silentConfig=!1}this.drawingCurrentTiles=!0,t.sort(this._compareTiles);for(var u=0,f=t.length;u<f;u++)this._drawTileAndCache(t[u],o);if(delete this.drawingCurrentTiles,l&&this.layer.options.opacity<1){this.layer._silentConfig=!0;var g=this.layer.options.fadeAnimation;this.layer.options.fadeAnimation=!1,this._drawChildTiles(n,o),this._drawParentTiles(this._parentTiles,o),this.layer.options.fadeAnimation=g,this.layer._silentConfig=!1}this.onDrawTileEnd(h,o)},n._drawChildTiles=function(t,e){var n=this;this.drawingChildTiles=!0,t.forEach((function(t){return n._drawTile(t.info,t.image,e)})),delete this.drawingChildTiles},n._drawParentTiles=function(t,e){var n=this;this.drawingParentTiles=!0,t.forEach((function(t){return n._drawTile(t.info,t.image,e)})),delete this.drawingParentTiles},n.onDrawTileStart=function(t,e){},n.onDrawTileEnd=function(t,e){},n._drawTile=function(t,e,n){e&&this.drawTile(t,e,n)},n.drawTile=function(t,e,n){},n._drawTileAndCache=function(t,e){this.isValidCachedTile(t)&&(this.tilesInView[t.info.id]=t),this._drawTile(t.info,t.image,e)},n.drawOnInteracting=function(t,e,n){this.draw(e,n)},n.checkIfNeedRedraw=function(){return!!this._tileQueue.length},n.hitDetect=function(){return!1},n._getLoadLimit=function(){return(this.map||this.getMap()).isInteracting()?this.layer.options.loadingLimitOnInteracting:this.layer.options.loadingLimit||0},n._isLoadingTile=function(t){return!!this.tilesLoading[t]},n.loadTileQueue=function(t){for(var e in t)if(t.hasOwnProperty(e)){var n=t[e],i=this.loadTile(n);void 0===i.loadTime&&(this.tilesLoading[n.id]={image:i,current:!0,info:n})}},n.loadTile=function(t){var e=this,n={};if(this.loadTileBitmap&&A(this.loadTileBitmap)){this.loadTileBitmap(t.url,t,(function(n){e.onTileLoad(n,t)}),(function(n,i){e.onTileError(i,t,n)}))}else if(this._tileImageWorkerConn&&this.loadTileImage===this.constructor.prototype.loadTileImage)this._fetchImage(n,t);else{var i=this.layer.getTileSize(t.layer);(n=new Image).width=i.width,n.height=i.height,n.onload=this.onTileLoad.bind(this,n,t),n.onerror=this.onTileError.bind(this,n,t),this.loadTileImage(n,t.url,t)}return n},n._fetchImage=function(t,e){var n=this;if(t instanceof Image)t.src=e.url;else{var{x:i,y:o}=e,s=Math.abs(i+o)%this._tileImageWorkerConn.workers.length;this._tileImageWorkerConn.fetchImage(e.url,s,(function(i,o){i?n.onTileError(t,e,i):On(o,(function(t){n.onTileLoad(t,e)}))}),this.layer.options.fetchOptions||{referrer:document.location.href,headers:{accept:"image/webp,image/apng,image/svg+xml,image/*,*/*;q=0.8"}})}},n.loadTileImage=function(t,e,n){var i=this.layer.options.crossOrigin;return h(i)||(t.crossOrigin=i),xe(t,[e])},n.abortTileLoading=function(t,e){(e&&void 0!==e.id&&this.removeTileLoading(e),t)&&(t instanceof Image&&(t.onload=WA,t.onerror=WA,t.src=vn),this.loadTileBitmap&&A(this.loadTileBitmap)&&this.loadTileBitmap(e.url,e,(function(){}),{command:"abortTile"}))},n.onTileLoad=function(t,e){this.removeTileLoading(e),this._tileQueue.push({tileInfo:e,tileData:t}),this._tileQueueIds.add(e.id),this.setToRedraw()},n.removeTileLoading=function(t){delete this.tilesLoading[t.id],this.setToRedraw()},n._consumeTileQueue=function(){for(var t=0,e=this.layer.options.tileLimitPerFrame,n=this._tileQueue;n.length&&(e<=0||t<e);){var{tileData:i,tileInfo:o}=n.shift();this._tileQueueIds.has(o.id)&&(this._tileQueueIds.delete(o.id),this.checkTileInQueue(i,o)&&(this.consumeTile(i,o),t++))}},n._computeAvgTileAltitude=function(){var t=0,e=0,n=0;for(var i in this.tilesInView){var o=this.tilesInView[i]&&this.tilesInView[i].info;o&&(t+=o.minAltitude||0,e+=o.maxAltitude||0,n++)}this.avgMinAltitude=t/n,this.avgMaxAltitude=e/n},n.checkTileInQueue=function(t,e){return!0},n.consumeTile=function(t,e){if(this.layer&&this.tilesInView){var n={tile:e,tileImage:t};this.resetTileLoadTime(t=n.tileImage),this.removeTileLoading(e),this._addTileToCache(e,t),this.layer.fire("tileload",n),this.setToRedraw()}},n.resetTileLoadTime=function(t){0!==t.loadTime&&(t.loadTime=a())},n.onTileError=function(t,e,n){if(this.layer){var i=this.layer.options.reloadErrorTileFunction;if(i)i.call(this,this.layer,this,e,t);else{var o=this.layer.options.errorUrl,s=!(t instanceof Image);if(o){if(t instanceof Image&&t.src!==o)return t.src=o,void this.removeTileLoading(e);(t=new Image).src=o}this.abortTileLoading(t,e),t.loadTime=0,s&&(t.fetchErrorTime=a()),this.removeTileLoading(e),this._addTileToCache(e,t),this.setToRedraw(),this.layer.fire("tileerror",{tile:e})}}},n.getDebugInfo=function(t){var e=t.split("_"),n=e.length;return e[n-3]+"/"+e[n-2]+"/"+e[n-1]},n.findChildTiles=function(t){return this._findChildTiles(t)},n._findChildTiles=function(t){var e=this._getLayerOfTile(t.layer),n=e._isPyramidMode(),i=e&&e.options.terrainTileMode&&n;if(!e||!e.options.background&&!i||t.z>this.layer.getMaxZoom())return jA;var o=this.map||this.getMap(),s=[];if(n){if(!i){for(var a=2*t.x,l=2*t.y,h=t.z+1,c=[],u=0;u<2;u++)for(var f=0;f<2;f++)c.push(a+u,l+f,h);for(;c.length;){var g=c.pop(),A=c.pop(),m=c.pop(),w=e._getTileId(m,A,g,t.layer),T=g+1<=t.z+2,M=this.tileCache.getAndRemove(w);if(M){if(this.isValidCachedTile(M))s.push(M),this.tileCache.add(w,M);else if(T)for(var C=0;C<2;C++)for(var P=0;P<2;P++)c.push(2*m+C,2*A+P,g+1)}else if(T)for(var I=0;I<2;I++)for(var O=0;O<2;O++)c.push(2*m+I,2*A+O,g+1)}return s}var E;i&&(E=[]);for(var D=2*t.x,N=2*t.y,H=t.z+1,U=[],W=0;W<2;W++)for(var q=0;q<2;q++){var X=e._getTileId(D+W,N+q,H,t.layer),J=this.tileCache.getAndRemove(X);J&&this.isValidCachedTile(J)?(s.push(J),this.tileCache.add(X,J),U.push(null)):U.push(X)}if(s.length<4)for(var Q=0,Y=0;Y<2;Y++)for(var K=0;K<2;K++){var $=U[Q++];if($){for(var tt=D+Y,et=N+K,nt=H,it=s.length,rt=[],ot=0;ot<2;ot++)for(var st=0;st<2;st++){var at=e._getTileId(2*tt+ot,2*et+st,nt+1,t.layer),ut=this.tileCache.getAndRemove(at);ut&&this.isValidCachedTile(ut)?(s.push(ut),this.tileCache.add(at,ut),rt.push(null)):rt.push(at)}if(i&&s.length-it<4){var ft=e.tileInfoCache.get($)||e._createChildNode(t,Y,K,[0,0],$);if(s.length-it==0)E.push(ft);else for(var gt=0,vt=0;vt<2;vt++)for(var xt=0;xt<2;xt++){var bt=rt[gt++];if(bt){var Ct=this.layer.tileInfoCache.get(bt)||e._createChildNode(ft,vt,xt,[0,0],bt);E.push(Ct)}}}}}return i?{tiles:s,missedTiles:E}:s}for(var Ot=t.res,Gt=t.extent2d.getMin(),$t=t.extent2d.getMax(),ne=e._project(o._pointToPrjAtRes(Gt,Ot,zA),zA),re=e._project(o._pointToPrjAtRes($t,Ot,GA),GA),oe=1;oe<1;oe++)this._findChildTilesAt(s,ne,re,e,t.z+oe);return s},n._findChildTilesAt=function(t,e,n,i,o){var s=i._spatialRef||i.getSpatialReference(),a=i.getId(),l=s.getResolution(o);if(l)for(var h,c,u=i._getTileConfig(),f=u.getTileIndex(e,l),g=u.getTileIndex(n,l),A=Math.min(f.idx,g.idx),m=Math.max(f.idx,g.idx),w=Math.min(f.idy,g.idy),T=Math.max(f.idy,g.idy),M=A;M<m;M++)for(var C=w;C<T;C++)h=i._getTileId(M,C,o,a),(c=this.tileCache.getAndRemove(h))&&this.isValidCachedTile(c)&&(t.push(c),this.tileCache.add(h,c))},n.findParentTile=function(t,e){return this._findParentTile(t,e)},n._findParentTile=function(t,e){var n=this.map||this.getMap(),i=this._getLayerOfTile(t.layer);if(!i||!i.options.background&&!i.options.terrainTileMode)return null;var o=i.getMinZoom(),s=e||t.z-o;if(i._isPyramidMode()){for(var a=t.z-s,l=t.z-1;l>=a;l--){var h=Math.pow(2,t.z-l),c=Math.floor(t.x/h),u=Math.floor(t.y/h),f=void 0;f=l===t.z-1?t.parent:i._getTileId(c,u,l,t.layer);var g=this.tileCache.getAndRemove(f);if(g&&this.isValidCachedTile(g))return this.tileCache.add(f,g),g}return null}for(var A=i.getSpatialReference(),m=A.getZoomDirection(),w=t.res,T=t.extent2d.getCenter(),M=i._project(n._pointToPrjAtRes(T,w)),C=1;C<=s;C++){var P=t.z-m*C,I=A.getResolution(P);if(I){var O=i._getTileConfig().getTileIndex(M,I),E=i._getTileId(O.x,O.y,P,t.layer),D=this.tileCache.getAndRemove(E);if(D)return this.tileCache.add(E,D),D}}return null},n.isValidCachedTile=function(t){return!!t.image},n.isTileComplete=function(t){return!0},n._getLayerOfTile=function(t){return this.layer.getChildLayer?this.layer.getChildLayer(t):this.layer},n.getCachedTile=function(t,e){var n=t.id,i=this.tilesInView,o=this.tileCache.getAndRemove(n);if(o){e||(i[n]=o);var s=this.tilesLoading;if(s&&s[n]){this.markCurrent(s[n],!1);var{image:a,info:l}=s[n];this.abortTileLoading(a,l),delete s[n]}}else o=i[n];return o&&(o.current=!0,this.isValidCachedTile(o)&&this.tileCache.add(n,o)),o},n._addTileToCache=function(t,e){this.isValidCachedTile({info:t,image:e})&&this.tileCache.add(t.id,{image:e,info:t})},n.getTileOpacity=function(t,e){var n=this.getTileFadingOpacity(t);if(this.layer.getChildLayer){var i=this.layer.getLayer(e.layer);i&&(n*=i.options.opacity)}return n},n.getTileFadingOpacity=function(t){return this.layer.options.fadeAnimation&&t.loadTime?Math.min(1,(a()-t.loadTime)/this.layer.options.fadeDuration):1},n.clearTileCaches=function(){this.retireTiles(!0),this.tileCache.reset(),this.tilesInView={},this.tilesLoading={},this._tileQueue=[],this._tileQueueIds.clear(),this._parentTiles=[],this._childTiles=[]},n.removeTileCaches=function(){delete this.tileCache,delete this._tilePlaceHolder,delete this._tileZoom},n.markCurrent=function(t,e){t.current=e},n.markTiles=function(){var t=0,e=0;if(this.tilesLoading)for(var n in this.tilesLoading)this.markCurrent(this.tilesLoading[n],!1),t++;if(this.tilesInView)for(var i in this.tilesInView)this.markCurrent(this.tilesInView[i],!1),e++;return[t,e]},n.retireTiles=function(t){for(var e in this.tilesLoading){var n=this.tilesLoading[e];!t&&n.current||(n.image&&this.abortTileLoading(n.image,n.info),this.deleteTile(n),this.removeTileLoading(n.info))}for(var i in this.tilesInView){var o=this.tilesInView[i];o.current||(delete this.tilesInView[i],this.tileCache.has(i)||this.deleteTile(o))}},n.deleteTile=function(t){if(t&&t.image){var e=t.info.id;this._tileQueueIds.has(e)&&this._tileQueueIds.delete(e),t.image.close&&t.image.close(),t.image instanceof Image&&(t.image.onload=null,t.image.onerror=null);var n=this.layer;n&&n.fire("tiledelete",{tile:t.info,tileImage:t.image})}},n._generatePlaceHolder=function(t){var e=this.map||this.getMap(),n=this.layer.options.placeholder;if(!n||e.getPitch())return null;var i=this.layer.getTileSize(),o=t/e._getResolution(),s=this._tilePlaceHolder=this._tilePlaceHolder||zl.createCanvas(1,1,e.CanvasClass);return s.width=i.width*o,s.height=i.height*o,A(n)?n(s):function(t){var e=t.getContext("2d"),n=t.width,i=t.height,o=n/16,s=i/16;e.beginPath();for(var a=0;a<16;a++)e.moveTo(0,a*s),e.lineTo(n,a*s),e.moveTo(a*o,0),e.lineTo(a*o,i);e.strokeStyle="rgba(180, 180, 180, 0.1)",e.lineWidth=1,e.stroke(),e.beginPath();for(var l=[[0,0],[n,0],[0,i],[n,i],[0,0],[0,i],[n,0],[n,i],[0,i/2],[n,i/2],[n/2,0],[n/2,i]],h=1;h<l.length;h+=2)e.moveTo(l[h-1][0],l[h-1][1]),e.lineTo(l[h][0],l[h][1]);e.lineWidth=4,e.stroke()}(s),s},n.setTerrainHelper=function(t){this._terrainHelper=t},n._validateTileImage=function(t){if(t)return!t.fetchErrorTime},e}(t);return e};function WA(){return!1}function ZA(t,e){return Math.abs(this._tileZoom-t.info.z)-Math.abs(this._tileZoom-e.info.z)}var qA=new _e(0,0),XA=new _e(0,0),JA=function(t){function e(e){var n;return(n=t.call(this,e)||this).init(),n}he(e,t);var n=e.prototype;return n._drawTiles=function(t,e,n,i,o,s,a){var l=this;e.length&&(e.sort(this._compareTiles),this._parentTiles=e),n.length&&(this._childTiles=n,this._childTiles.sort(this._compareTiles));var h=!0;this.layer.constructor!==kp&&this.layer.constructor!==Gp||(this._renderTimestamp===this.canvas._parentTileTimestamp?h=!1:this.canvas._parentTileTimestamp=this._renderTimestamp);var c="gl"===this.layer.options.renderer&&(!this.isGL||this.isGL()),u={tiles:t,parentTiles:this._parentTiles,childTiles:this._childTiles,parentContext:o};if(this.onDrawTileStart(u,o),h&&1===this.layer.options.opacity){this.layer._silentConfig=!0;var f=this.layer.options.fadeAnimation;this.layer.options.fadeAnimation=!1,c?(this._drawChildTiles(n,o),this._drawParentTiles(this._parentTiles,o)):(this._drawParentTiles(this._parentTiles,o),this._drawChildTiles(n,o)),this.layer.options.fadeAnimation=f,this.layer._silentConfig=!1}this.drawingCurrentTiles=!0,t.sort(this._compareTiles);for(var g=0,A=t.length;g<A;g++)this._drawTileAndCache(t[g],o);if(delete this.drawingCurrentTiles,h&&this.layer.options.opacity<1){this.layer._silentConfig=!0;var m=this.layer.options.fadeAnimation;this.layer.options.fadeAnimation=!1,c?(this._drawChildTiles(n,o),this._drawParentTiles(this._parentTiles,o)):(this._drawParentTiles(this._parentTiles,o),this._drawChildTiles(n,o)),this.layer.options.fadeAnimation=m,this.layer._silentConfig=!1}i.forEach((function(t){return l._drawTile(t.info,t.image,o)})),this.onDrawTileEnd(u,o)},n.needToRedraw=function(){var e=this.getMap();return!!this.checkIfNeedRedraw()||(e.getPitch()?t.prototype.needToRedraw.call(this):!(!e.isRotating()&&!e.isZooming())||(e.isMoving()?!!this.layer.options.forceRenderOnMoving:t.prototype.needToRedraw.call(this)))},n.isDrawable=function(){return!this.getMap().getPitch()||(console&&console.warn("TileLayer with canvas renderer can't be pitched, use gl renderer ('renderer' : 'gl') instead."),this.clear(),!1)},n.clipCanvas=function(e){return t.prototype.clipCanvas.call(this,e)},n.clear=function(){this.clearTileCaches(),t.prototype.clear.call(this)},n.onRemove=function(){this.clear(),this.removeTileCaches(),t.prototype.onRemove.call(this)},n.drawTile=function(t,e,n){if(this._validateTileImage(e)){var i=this.getMap();if(i){var{extent2d:o,offset:s}=t,a=qA.set(o.xmin-s[0],o.ymax-s[1]),l=t.z,h=t.id,c=i.getZoom(),u=this.context,f=i._pointAtResToContainerPoint(a,t.res,0,XA),g=i.getBearing(),A=g||c!==l,m=this.getTileOpacity(e,t),w=u.globalAlpha;m<1&&(u.globalAlpha=m),A||f._round();var T=f.x,M=f.y,C=t.extent2d.xmax-t.extent2d.xmin,P=t.extent2d.ymax-t.extent2d.ymin,I=this.layer,O=I?I.options.bufferPixel:0;if(A){u.save(),u.translate(T,M),g&&u.rotate(-g*Math.PI/180),C+=O,P+=O;var E=i._getResolution();if(E!==t.res){var D=t.res/E;u.scale(D,D)}T=M=0}if(zl.image(u,e,T,M,C,P),this.layer.options.debug){var N=this.layer.options.debugOutline;u.save(),u.strokeStyle=N,u.fillStyle=N,u.font="20px monospace";var H=new _e(T,M);zl.rectangle(u,H,{width:C,height:P},1,0),zl.fillText(u,this.getDebugInfo(h),H._add(32,P-14),N),zl.drawCross(u,T+C/2,M+P/2,2,N),u.restore()}A&&u.restore(),u.globalAlpha!==w&&(u.globalAlpha=w),this.setCanvasUpdated()}}},e}(VA(oA));kp.registerRenderer("canvas",JA);var QA=new _e(0,0),YA={properties:{}},KA=function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n.isDrawable=function(){return!0},n.needToRedraw=function(){var e=this.getMap();return!(!this.isGL()||e.getPitch()||!e.isZooming()||e.isMoving()||e.isRotating())||t.prototype.needToRedraw.call(this)},n.onDrawTileStart=function(t,e){var n=this.gl;if(n.enable(n.DEPTH_TEST),n.depthFunc(n.LEQUAL),n.enable(n.POLYGON_OFFSET_FILL),n.enable(n.STENCIL_TEST),n.stencilOp(n.KEEP,n.KEEP,n.REPLACE),n.depthMask(!!this.layer.options.depthMask),e&&e.renderTarget){var i=e.renderTarget.fbo;if(i){var o=e.renderTarget.getFramebuffer(i);n.bindFramebuffer(n.FRAMEBUFFER,o)}}},n.onDrawTileEnd=function(t,e){var n=this.gl;e&&e.renderTarget&&(e.renderTarget.fbo&&n.bindFramebuffer(n.FRAMEBUFFER,null))},n.drawTile=function(e,n,i){if(this._validateTileImage(n)&&(!i||!i.sceneFilter||i.sceneFilter(YA))){var o=this.getMap();if(e&&o&&n){var s=e._glScale=e._glScale||e.res/o.getGLRes(),a=e.extent2d.xmax-e.extent2d.xmin,l=e.extent2d.ymax-e.extent2d.ymin;if(!1!==e.cache&&this._bindGLBuffer(n,a,l),this.isGL()){var{extent2d:h,offset:c}=e,u=QA.set(h.xmin-c[0],e.extent2d.ymax-c[1]),f=u.x*s,g=u.y*s,A=this.getTileOpacity(n,e),m=null;this.layer.options.debug&&(m=this.getDebugInfo(e.id));var w=this.gl;w.stencilFunc(w.LEQUAL,Math.abs(this.getCurrentTileZoom()-e.z),255);var T=this.layer.getPolygonOffset(),M=this.drawingCurrentTiles?T:T+1;w.polygonOffset(M,M),this.drawGLImage(n,f,g,a,l,s,A,o._getResolution()!==e.res,m),this.getTileFadingOpacity(n)<1?this.setToRedraw():this.setCanvasUpdated()}else t.prototype.drawTile.call(this,e,n)}}},n._bindGLBuffer=function(t,e,n){t.glBuffer||(t.glBuffer=this.bufferTileData(0,0,e,n))},n.loadTileImage=function(t,e){var n=this.layer.options.crossOrigin;t.crossOrigin=null!==n?n:"",t.src=e},n.onCanvasCreate=function(){this.canvas.gl&&this.canvas.gl.wrap||this.createCanvas2()},n.createContext=function(){t.prototype.createContext.call(this),this.createGLContext()},n.resizeCanvas=function(e){this.canvas&&(t.prototype.resizeCanvas.call(this,e),this.resizeGLCanvas())},n.clearCanvas=function(){this.canvas&&(t.prototype.clearCanvas.call(this),this.clearGLCanvas())},n.getCanvasImage=function(){if(!this.isGL()||!this.canvas2)return t.prototype.getCanvasImage.call(this);var e=t.prototype.getCanvasImage.call(this);return e&&(e.image=this.canvas2),e},n.isGL=function(){return!0},n.deleteTile=function(e){t.prototype.deleteTile.call(this,e),e&&e.image&&this.disposeImage(e.image),delete e.image},n.onRemove=function(){t.prototype.onRemove.call(this),this.removeGLCanvas()},e}(nA(JA));function $A(t){var e=this,n=this.layer.getTileSize(),i=this.canvas.constructor,o=this.getMap(),s=o.getDevicePixelRatio(),a=zl.createCanvas(n.width*s,n.height*s,i);a.layer=this.layer;var l=new _e(t.extent2d.xmin,t.extent2d.ymax),h=new Ph(o.pointToCoordinate(l),o.pointToCoordinate(l.add(n.width,n.height)),o.getProjection());return this.layer.drawTile(a,{url:t.url,point:l,center:o.pointToCoordinate(l.add(n.width/2,n.height/2)),extent:h,z:t.z,x:t.x,y:t.y},(function(n){n?e.onTileError(a,t):e.onTileLoad(a,t)})),a}kp.registerRenderer("gl",KA);var tm=function(t){function e(){return t.apply(this,arguments)||this}return he(e,t),e.prototype.loadTile=function(...t){return $A.apply(this,t)},e}(JA),em=function(t){function e(){return t.apply(this,arguments)||this}return he(e,t),e.prototype.loadTile=function(...t){return $A.apply(this,t)},e}(KA);jp.registerRenderer("canvas",tm),jp.registerRenderer("gl",em);var nm="undefined"!=typeof Int8Array?new Int8Array([-1,1,0,-1,-1,0,1,1,0,1,-1,0]):[],im=function(){function t(t,e,n){this.gl=t,this.quadVertices=e||nm,this.attributes=["a_position",3,rm(e)],this.debug=n}var e=t.prototype;return e.start=function(){var t=this.gl;t.enable(t.STENCIL_TEST),t.stencilMask(255),t.stencilOp(t.KEEP,t.REPLACE,t.REPLACE),t.depthMask(!1),this._save(),this.buffer||(this._createBuffer(),this._createProgram()),t.useProgram(this.program),t.bindBuffer(t.ARRAY_BUFFER,this.buffer),Wp(t,this.program,this.attributes),this.transformLoc||(this.transformLoc=t.getUniformLocation(this.program,"transform")),this.colorLoc||(this.colorLoc=t.getUniformLocation(this.program,"color")),this.debug||t.colorMask(!1,!1,!1,!1)},e.end=function(){var t=this.gl;t.depthMask(!0),this._restore(),this.debug||t.colorMask(!0,!0,!0,!0)},e.draw=function(t){var e=this.gl;e.uniformMatrix4fv(this.transformLoc,!1,t),e.uniform3fv(this.colorLoc,[Math.random(),Math.random(),Math.random()]),e.drawArrays(e.TRIANGLE_STRIP,0,4)},e.remove=function(){var t=this.gl;return this.buffer&&t.deleteBuffer(this.buffer),this.program&&(t.deleteShader(this.program.fragmentShader),t.deleteShader(this.program.vertexShader),t.deleteProgram(this.program)),delete this.transformLoc,delete this.gl,this},e.stencilMask=function(t){return this.gl.stencilMask(t),this},e.stencilFunc=function(t,e,n){return this.ref=e,this.gl.stencilFunc(t,e,n),this},e.stencilOp=function(t,e,n){return this.gl.stencilOp(t,e,n),this},e.resetFunc=function(){return this.ref=1,this.gl.stencilFunc(this.gl.ALWAYS,1,255),this},e._save=function(){this._savedProgram=this.gl.program},e._restore=function(){var t=this.gl;t.program=this._savedProgram,t.program&&t.useProgram(t.program)},e._createBuffer=function(){var t=this.gl;if(this.buffer=t.createBuffer(),!this.buffer)throw new Error("Failed to create the buffer object");t.bindBuffer(t.ARRAY_BUFFER,this.buffer),t.bufferData(t.ARRAY_BUFFER,this.quadVertices,t.STATIC_DRAW)},e._createProgram=function(){var{program:t,vertexShader:e,fragmentShader:n}=Vp(this.gl,"\n    attribute vec3 a_position;\n    uniform mat4 transform;\n\n    void main()\n    {\n        gl_Position = transform * vec4(a_position, 1.0);\n    }\n","\n    precision mediump float;\n    uniform vec3 color;\n    void main()\n    {\n        gl_FragColor = vec4(color, 1.0);\n    }\n");t.vertexShader=e,t.fragmentShader=n,this.program=t},t}();function rm(t){return t instanceof Float32Array?"FLOAT":t instanceof Int16Array?"SHORT":t instanceof Uint16Array?"UNSIGNED_SHORT":t instanceof Int8Array?"BYTE":t instanceof Uint8Array||t instanceof Uint8ClampedArray?"UNSIGNED_BYTE":"FLOAT"}var om=function(t){var e=function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n.checkResources=function(){var t=this._geosToCheck||[];if(!this._resourceChecked&&this.layer._geoList&&ke(t,this.layer._geoList),!Je(t))return[];for(var e=[],n={},i=t.length-1;i>=0;i--){var o=t[i]._getExternalResources();if(o.length)if(this.resources)for(var s=0;s<o.length;s++){var a=o[s][0];this.resources.isResourceLoaded(o[s])||n[a]||(e.push(o[s]),n[a]=1)}else e.push(...o)}return this._resourceChecked=!0,delete this._geosToCheck,e},n._addGeoToCheckRes=function(t){t&&(Array.isArray(t)||(t=[t]),this._geosToCheck||(this._geosToCheck=[]),ke(this._geosToCheck,t))},n.onGeometryAdd=function(t){this._addGeoToCheckRes(t),lm(this)},n.onGeometryRemove=function(t){this.layer.fire("removegeo",{type:"removegeo",target:this,geometries:t}),lm(this)},n.onGeometrySymbolChange=function(t){this._addGeoToCheckRes(t.target),lm(this)},n.onGeometryShapeChange=function(t){lm(this)},n.onGeometryPositionChange=function(t){lm(this)},n.onGeometryZIndexChange=function(t){lm(this)},n.onGeometryShow=function(t){lm(this)},n.onGeometryHide=function(t){lm(this)},n.onGeometryPropertiesChange=function(t){lm(this)},e}(t);return e},sm=function(t){function e(){return t.apply(this,arguments)||this}return he(e,t),e.prototype.render=function(...e){return this.layer._sortGeometries(),t.prototype.render.apply(this,e)},e}(om(oA)),am=function(t){function e(){return t.apply(this,arguments)||this}return he(e,t),e.prototype.render=function(...e){return this.layer._sortGeometries(),t.prototype.render.apply(this,e)},e}(om(Cf));function lm(t){t instanceof sm&&t.layer.options.drawImmediate&&t.render(),t.setToRedraw()}var hm=new Oh,cm=[],um=new Oh;function fm(t){if(!t)return null;var e=t.getContext("2d");return e.clearRect(0,0,t.width,t.height),e}function dm(t){return t&&t.options.progressiveRender&&t.options.progressiveRenderDebug}var gm=function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n.setToRedraw=function(){return t.prototype.setToRedraw.call(this),this._resetProgressiveRender(),this},n._geoIsCollision=function(t,e){if(!t)return!1;if(!t.options.collision)return!1;if(t.isPoint&&t.getContainerExtent){t.bbox||(t.bbox=[0,0,0,0]);var n=this.layer.options.collisionBufferSize,i=t.getContainerExtent();if(!i)return!1;if(t.bbox[0]=i.xmin-n,t.bbox[1]=i.ymin-n,t.bbox[2]=i.xmax+n,t.bbox[3]=i.ymax+n,e.collides(t.bbox))return t._collided=!0,!0;e.insertBox(t.bbox)}return!1},n.getImageData=function(){if(!this._lastRenderTime||a()-this._lastRenderTime<32)return null;if(!this.context||!this.context.canvas)return null;if(!this._imageData){var{width:t,height:e}=this.context.canvas;try{var n=this.screenshotRenderResult(0,0,t,e);n&&(this._imageData=n.getImageData(0,0,t,e))}catch(t){console.warn("hit detect failed with tainted canvas, some geometries have external resources in another domain:\n",t)}}return this._imageData},n.clearImageData=function(){this._imageData=null,delete this._imageData,this._lastRenderTime=a()},n.checkResources=function(...e){var n=this,i=t.prototype.checkResources.apply(this,e),o=this.layer.getStyle();return o&&(Array.isArray(o)||(o=[o]),o.forEach((function(t){for(var e=Eo(t.symbol,!0),o=0,s=e.length;o<s;o++)n.resources.isResourceLoaded(e[o])||i.push(e[o])}))),i},n.needToRedraw=function(){if(this.isProgressiveRender()&&!this.renderEnd)return!0;var e=this.getMap();return!(!e.isInteracting()||!this.layer.options.enableAltitude)||!(e.isZooming()&&!e.isRotating()&&!e.getPitch()&&!this._hasPoint&&this.layer.constructor===pA)&&t.prototype.needToRedraw.call(this)},n.draw=function(){if(this.getMap()){if(!this.layer.isVisible()||this.layer.isEmpty())return this.clearCanvas(),void this.completeRender();this.prepareCanvas(),this.drawGeos(),this.completeRender()}},n.isBlank=function(){return!!this.context&&(!this.isProgressiveRender()&&!this.context.canvas._drawn)},n.drawOnInteracting=function(){if(this._geosToDraw){this._updateMapStateCache(),this._updateDisplayExtent();var t=this.getMap(),e=this.layer.getCount(),n=this.mapStateCache.resolution;(t.isZooming()&&t.options.seamlessZoom&&void 0!==this._drawnRes&&n>1.5*this._drawnRes&&this._geosToDraw.length<e||t.isMoving()||t.isInteracting())&&(this.prepareToDraw(),this._batchConversionMarkers(this.mapStateCache.glRes),this._onlyHasPoint||this._checkGeos(),this._drawnRes=n),this._sortByDistanceToCamera(t.cameraPosition);var{collision:i,collisionDelay:o}=this.layer.options;if(i){var s=a();this._lastCollisionTime||(this._lastCollisionTime=s),s-this._lastCollisionTime<=o?this._geosToDraw=this._lastGeosToDraw||this._geosToDraw:(this._collidesGeos(),this._lastCollisionTime=s)}for(var l=0,h=this._geosToDraw.length;l<h;l++){var c=this._geosToDraw[l];c._isCheck||c.isVisible()?(c._paint(this._displayExtent),this._geosToDraw[l]._cPoint=void 0,this._geosToDraw[l]._inCurrentView=void 0):(delete c._cPoint,delete c._inCurrentView)}this.clearImageData(),this._lastGeosToDraw=this._geosToDraw,dm(this.layer)&&console.log("progressiveRender on drawOnInteracting page:",this.page)}},n.show=function(...e){this.layer.forEach((function(t){t._repaint()})),t.prototype.show.apply(this,e)},n.forEachGeo=function(t,e){this.layer.forEach(t,e)},n._checkGeos=function(){for(var t=this._getCurrentNeedRenderGeos(),e=0,n=t.length;e<n;e++)this.checkGeo(t[e]);return this},n.drawGeos=function(){this._drawSnapshot(),this._updateMapStateCache(),this._drawnRes=this.mapStateCache.resolution,this._updateDisplayExtent(),this.prepareToDraw(),this._batchConversionMarkers(this.mapStateCache.glRes),this._onlyHasPoint||this._checkGeos(),this._sortByDistanceToCamera(this.getMap().cameraPosition),this._collidesGeos();for(var t=0,e=this._geosToDraw.length;t<e;t++)this._geosToDraw[t]._paint(),this._geosToDraw[t]._cPoint=void 0,this._geosToDraw[t]._inCurrentView=void 0;this.clearImageData(),this._lastGeosToDraw=this._geosToDraw,dm(this.layer)&&console.log("progressiveRender drawGeos page:",this.page),this._snapshot(),this._setDrawGeosDrawTime()},n.prepareToDraw=function(){return this.layer._drawTime=a(),this._hasPoint=!1,this._geosToDraw=[],this},n._setDrawGeosDrawTime=function(){for(var t=a(),e=this.layer._drawTime,n=this.getGeoPainterList(),i=0,o=n.length;i<o;i++){var s=n[i];s&&s._setDrawTime&&s._setDrawTime(e)}return dm(this.layer)&&console.log("_setDrawGeosDrawTime time:",a()-t+"ms"),this},n.checkGeo=function(t){if(t.isPoint&&void 0!==this._onlyHasPoint)(t._inCurrentView||t.hasAltitude())&&(this._hasPoint=!0,t._isCheck=!0,this._geosToDraw.push(t));else if(t._isCheck=!1,t&&t.isVisible()&&t.getMap()&&t.getLayer()&&t.getLayer().isCanvasRender()){var e=t._getPainter(),n=!0;if(t._inCurrentView||!h(t.options.arcDegree)||t.hasAltitude())n=!0;else if(!1===t._inCurrentView)n=!1;else{var i=e.get2DExtent(this.resources,hm);i&&i.intersects(this._displayExtent)||(n=!1)}n&&(e.hasPoint()&&(this._hasPoint=!0),t._isCheck=!0,this._geosToDraw.push(t))}},n._collidesGeos=function(){var t=this._geosToDraw;if(!this.layer.options.collision){for(var e=0,n=t.length;e<n;e++){var i=t[e];i.isPoint&&(i._collided=!1)}return this}var o=this.layer.options.collisionScope,s=this.layer.getCollisionIndex();"layer"===o&&s.clear(),this._geosToDraw=[];for(var a=0,l=t.length;a<l;a++){var h=t[a];h.isPoint&&(h._collided=!1,this._geoIsCollision(h,s))?h._collided=!0:this._geosToDraw.push(t[a])}return this},n.onZoomEnd=function(...e){delete this.canvasExtent2D,t.prototype.onZoomEnd.apply(this,e)},n.onRemove=function(){this.forEachGeo((function(t){t.onHide()})),delete this._geosToDraw,delete this.snapshotCanvas,delete this.pageGeos,delete this.geoPainterList},n.onGeometryPropertiesChange=function(e){e&&this.layer._styleGeometry(e.target),t.prototype.onGeometryPropertiesChange.call(this,e)},n._updateDisplayExtent=function(){var t=this.canvasExtent2D;if(this._maskExtent){if(!this._maskExtent.intersects(t))return void this.completeRender();t=t.intersection(this._maskExtent)}this._displayExtent=t},n.identifyAtPoint=function(t,e={}){var n=this.getGeosForIdentify();return n?this.layer._hitGeos(n,t,e):[]},n._updateMapStateCache=function(){var t=this.getMap(),e=t._pointToContainerPoint(this.middleWest)._add(0,-t.height/2),n=t.getResolution(),i=t.getPitch(),o=t.getBearing(),s=t.getGLScale(),a=t.getGLRes(),l=t.getContainerExtent(),h=t.get2DExtent(),c=t.get2DExtentAtRes(a);return this.mapStateCache={resolution:n,pitch:i,bearing:o,glScale:s,glRes:a,_2DExtent:h,glExtent:c,containerExtent:l,offset:e},this},n._batchConversionMarkers=function(t){if(this._onlyHasPoint=void 0,!this._constructorIsThis())return[];var e=[],n=[],i=[],o={},s=this.layer,a=s.options,l=s.getAltitude?s.getAltitude():0,h=s.isCanvasRender();this._onlyHasPoint=!0;for(var c=0,u=this._getCurrentNeedRenderGeos(),f=0,g=u.length;f<g;f++){var A=u[f];if(A.isPoint){var m=A._painter;m||(m=A._getPainter());var w=m.getRenderPoints("center")[0][0],T=a.enableAltitude?A._getAltitude():l;void 0===o[T]&&(o[T]=m.getAltitude()),e[c]=w,i[c]=o[T],n[c]=A,c++}else this._onlyHasPoint=!1}if(0===c)return[];var M=this.getMap(),C=Pn(e,"_pt");C=M._pointsAtResToContainerPoints(e,t,i,C);for(var P=M.getContainerExtent(),{xmax:I,ymax:O,xmin:E,ymin:D}=P,N={},H=0,U=n.length;H<U;H++){var W=n[H];if(W._cPoint=C[H],W._cPoint){var{x:q,y:X}=C[H];if(W._inCurrentView=q>=E&&X>=D&&q<=I&&X<=O||W.hasAltitude(),!W._inCurrentView){var J=W.getSymbolHash(),Q=void 0;Q=J?N[J]=N[J]||W._painter.getFixedExtent():W._painter.getFixedExtent(),um.set(Q.xmin,Q.ymin,Q.xmax,Q.ymax),um._add(C[H]),W._inCurrentView=um.intersects(P)}W._inCurrentView&&(W.isVisible()&&h||(W._inCurrentView=!1),this._onlyHasPoint&&W._inCurrentView&&(this._hasPoint=!0,W._isCheck=!0,this._geosToDraw.push(W)))}else W._inCurrentView=!1}return C},n._sortByDistanceToCamera=function(t){if(this.layer.options.sortByDistanceToCamera&&this._geosToDraw.length){var e=this.getMap(),n=e.distanceToPoint(1e3,0,e.getGLScale()).x/1e3,i="center";this._geosToDraw.sort((function(e,o){if(!e.isPoint||!o.isPoint)return 0;var s=e._painter,a=o._painter;if(!s||!a)return 0;var l=s.getRenderPoints(i)[0][0],h=a.getRenderPoints(i)[0][0],c=s.getAltitude()*n,u=a.getAltitude()*n;Gs(cm,l.x,l.y,c);var f=ea(cm,t);return Gs(cm,h.x,h.y,u),ea(cm,t)-f}))}},n._constructorIsThis=function(){return this.constructor===e},n.isProgressiveRender=function(){var t=this.layer;if(!t)return!1;var{progressiveRender:e,collision:n}=t.options||{};return!n&&e},n.getGeosForIdentify=function(){return this.isProgressiveRender()?this.pageGeos||[]:this._geosToDraw||[]},n.getGeoPainterList=function(){if(!this.isProgressiveRender()){for(var t=[],e=this._geosToDraw||[],n=0,i=e.length;n<i;n++)t.push(e[n]._painter);return t}return this.geoPainterList||[]},n._checkSnapshotCanvas=function(){if(!this.isProgressiveRender())return delete this.snapshotCanvas,null;var t=this.canvas;if(!t)return delete this.snapshotCanvas,null;this.snapshotCanvas||(this.snapshotCanvas=zl.createCanvas(1,1));var e=this.snapshotCanvas,{width:n,height:i,style:o}=t;return e.width===n&&e.height===i||(e.width=n,e.height=i),e.style.width===o.width&&e.style.height===o.height||(e.style.width=o.width,e.style.height=o.height),e},n._getCurrentNeedRenderGeos=function(){var t=this.layer._geoList||[];if(!this.isProgressiveRender())return t;var e=this.layer,{progressiveRenderCount:n}=e.options,i=this.page;return t.slice((i-1)*n,i*n)},n._resetProgressiveRender=function(){dm(this.layer)&&console.log("progressiveRender resetProgressiveRender"),this.renderEnd=!1,this.page=1,this.pageGeos=[],this.geoPainterList=[],this.maxTolerance=0,this._clearSnapshotCanvas()},n._clearSnapshotCanvas=function(){var t=this._checkSnapshotCanvas();t&&fm(t)},n._snapshot=function(){for(var t=this.isProgressiveRender(),e=this._geosToDraw||[],n=0,i=e.length;n<i;n++){var o=e[n],s=o._hitTestTolerance()||0;if(this.maxTolerance=Math.max(this.maxTolerance,s),t)this.pageGeos.push(o),this.geoPainterList.push(o._painter)}if(!t)return this;var l=a(),h=this._checkSnapshotCanvas();h&&this.canvas&&fm(h).drawImage(this.canvas,0,0);var c=this.layer,{progressiveRenderCount:u}=c.options,f=Math.ceil((c._geoList||[]).length/u);return this.renderEnd=this.page>=f,this.renderEnd&&this._setDrawGeosDrawTime(),dm(this.layer)&&console.log("snapshot time:",a()-l+"ms"),this.renderEnd||this.page++,this},n._drawSnapshot=function(){if(!this.isProgressiveRender())return this;var{snapshotCanvas:t,context:e}=this;if(!t||!e)return this;var n=this.getMap();if(!n)return this;var i=this.mapDPR||n.getDevicePixelRatio()||1;return this._canvasContextScale(e,1/i),e.drawImage(t,0,0),this._canvasContextScale(e,i),this},e}(sm);pA.registerRenderer("canvas",gm);var pm=function(t){function e(e){var n;return(n=t.call(this)||this).map=e,n._handlerQueue=[],n._thisDocVisibilitychange=n._onDocVisibilitychange.bind(n),n._thisDocDragStart=n._onDocDragStart.bind(n),n._thisDocDragEnd=n._onDocDragEnd.bind(n),n._thisDocDPRChange=n._onDocDPRChange.bind(n),n}he(e,t);var n=e.prototype;return n._getAllLayerToRender=function(){return this.map._getLayers()},n.setToRedraw=function(){for(var t=this._getAllLayerToRender(),e=0,n=t.length;e<n;e++){var i=t[e].getRenderer();i&&i.canvas&&i.setToRedraw&&i.setToRedraw()}},n.callInNextFrame=function(t){this._handlerQueue.push(t)},n.executeFrameCallbacks=function(){var t=this._handlerQueue;this._handlerQueue=[];for(var e=0,n=t.length;e<n;e++)t[e]()},n.offsetPlatform=function(t,e){if(!this.map.getPanels().front)return this;if(!e&&0===t.x&&0===t.y)return this;var n=this.map.getPanels(),i=this._frontCount=n.back.layerDOM.childElementCount,o=this._backCount=n.front.layerDOM.childElementCount,s=this._uiCount=n.front.uiDOM.childElementCount;if(i||o||s){var a=this.map.offsetPlatform();a=t?a.add(t)._round():a.round(),o&&Ui(n.back,a),(i||s)&&Ui(n.front,a)}return this},n.domChanged=function(){var t=this.map.getPanels();return!!t.front&&(void 0===this._frontCount||this._frontCount!==t.back.layerDOM.childElementCount||(void 0===this._backCount||this._backCount!==t.front.layerDOM.childElementCount||(void 0===this._uiCount||this._uiCount!==t.front.uiDOM.childElementCount)))},n.resetContainer=function(){if(this.map&&(this.map._resetMapViewPoint(),this.map.getPanels().front)){var t=new _e(0,0);Ui(this.map.getPanels().back,t),Ui(this.map.getPanels().front,t)}},n.onZoomEnd=function(){this.resetContainer()},n._onDocVisibilitychange=function(){"visible"===document.visibilityState&&this.setToRedraw()},n._getWrapPanel=function(){if(!this.map)return null;var t=this.map.getPanels();return t&&t.mapWrapper},n._onDocDragStart=function(){var t=this._getWrapPanel();t&&(t.style.overflow="visible")},n._onDocDragEnd=function(){var t=this._getWrapPanel();t&&(t.style.overflow="hidden")},n._onDocDPRChange=function(){var t=this.map;t&&t.options&&!t.options.devicePixelRatio&&t.checkSize&&t.getRenderer&&(t.getRenderer()&&t.checkSize(!0))},n._containerIsOffscreen=function(){var t=this.map.getContainer();return!t||!t.style||"none"===t.style.display||Math.min(t.clientWidth,t.clientHeight)<=0},e}(Ql);function Am(t,e,n,i){return new(n||(n=Promise))((function(e,o){function s(t){try{l(i.next(t))}catch(t){o(t)}}function a(t){try{l(i.throw(t))}catch(t){o(t)}}function l(t){var i;t.done?e(t.value):(i=t.value,i instanceof n?i:new n((function(t){t(i)}))).then(s,a)}l((i=i.apply(t,[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;var mm=new yl,ym=function(t){function e(e){var n;return(n=t.call(this,e)||this).ready=!1,n._containerIsCanvas=!!e.getContainer().getContext,n._registerEvents(),n._loopTime=0,n._resizeEventList=[],n._resizeTime=-1/0,n._frameCycleRenderCount=0,n}he(e,t);var i=e.prototype;return i.load=function(){this.initContainer()},i.renderFrame=function(t){var e=this.map;if(!e||!e.options.renderable)return!1;if(this._handleResizeEventList(t),e.options.stopRenderOnOffscreen&&this._containerIsOffscreen())return!1;this._updateDomPosition(t),delete this._isViewChanged,e._fireEvent("framestart"),this.updateMapDOM(),e.clearCollisionIndex();var n=this._getAllLayerToRender();return this.drawLayers(n,t)&&this.drawTops(),e._fireEvent("frameend"),this._recordView(),this._mapview=this._getMapView(),delete this._spatialRefChanged,this._fireLayerLoadEvents(n),this.executeFrameCallbacks(),e.uiCollides(),!0},i.getFrameTimestamp=function(){return this._frameTimestamp||0},i.updateMapDOM=function(){var t=this.map;if(!t.isZooming()){var e=t.getViewPointFrameOffset();e?t.offsetPlatform(e):this.domChanged()&&this.offsetPlatform(null,!0)}},i.checkIfNeedToRedrawLayers=function(t){if(this.isSpatialReferenceChanged())return!0;for(var e=0,n=t.length;e<n;e++)if(this._checkLayerRedraw(t[e]))return!0;return!1},i.drawLayers=function(t,e){if(!this.checkIfNeedToRedrawLayers(t)&&!this.map.options.forceRedrawPerFrame)return!1;this.clearCanvas();for(var n=this.map.isInteracting(),i=t.length,o=0;o<i;o++){var s=t[o];if(s.isVisible()){var a=s.isCanvasRender(),l=s._getRenderer();l&&(a&&this.clearLayerCanvasContext(s),n&&a?this._drawCanvasLayerOnInteracting(s,0,0,e):n&&l.drawOnInteracting?(l.prepareRender&&l.prepareRender(),l.checkAndDraw?l.checkAndDraw(l.drawOnInteracting,this._eventParam,e):l.drawOnInteracting(this._eventParam,e)):l.render(e))}}return!0},i._checkLayerRedraw=function(t){if(this.isSpatialReferenceChanged())return!0;var e=this.map,n=t._getRenderer();return!!n&&(t.isCanvasRender()?n.testIfNeedRedraw():!(!n.needToRedraw||!n.needToRedraw())||(e.isInteracting()||this.isViewChanged()))},i._drawCanvasLayerOnInteracting=function(t,e,n,i){var o=t._getRenderer();if(o.mustRenderOnInteracting&&o.mustRenderOnInteracting())o.render(i);else if(o.drawOnInteracting){o.prepareRender();var s=o.prepareCanvas();return o.checkAndDraw?o.checkAndDraw(o.drawOnInteracting,this._eventParam,i):o.drawOnInteracting(this._eventParam,i),s}return null},i._fireLayerLoadEvents=function(t){for(var e=t.length-1;e>=0;e--){var n=t[e],i=n._getRenderer();i&&i.isRenderComplete()&&n.fire("layerload")}},i.updateMapSize=function(t){if(t&&!this._containerIsCanvas){var e=t.width+"px",n=t.height+"px",i=this.map.getPanels();i.mapWrapper.style.width=e,i.mapWrapper.style.height=n,this._updateCanvasSize()}},i.getMainPanel=function(){return this.map?this._containerIsCanvas?this.map.getContainer():this.map.getPanels()?this.map.getPanels().mapWrapper:null:null},i.toDataURL=function(t,e){return this.canvas?this.canvas.toDataURL(t,e):null},i.remove=function(){Gt.webgl&&"undefined"!=typeof document&&(Kl.off($l,this._thisDocDPRChange,this),Kl.off(th,this._thisDocVisibilitychange,this),Kl.off(eh,this._thisDocDragStart,this),Kl.off(nh,this._thisDocDragEnd,this)),this._resizeInterval&&clearInterval(this._resizeInterval),this._resizeObserver&&this._resizeObserver.disconnect(),delete this.canvas,delete this.map,delete this._spatialRefChanged,this._cancelFrameLoop()},i.hitDetect=function(t){var e=this.map;if(e&&e.options.hitDetect&&!e.isInteracting()){var n=e._getLayers(),i="default",o=e.options.hitDetectLimit||0,s=0;t&&t._round&&t._round();for(var a=n.length-1;a>=0;a--){var l=n[a];if(!(!l.options.hitDetect||l.isEmpty&&l.isEmpty())&&l.options.geometryEvents){var h=l._getRenderer();if(h&&h.hitDetect&&(!h.isBlank||!h.isBlank())){if("default"!==l.options.cursor&&h.hitDetect(t)){i=l.options.cursor||"pointer";break}if(s++,o>0&&s>o)break}}}e._trySetCursor(i)}},i.initContainer=function(){var t=this.map.getPanels();function e(e,n,i,o){var s=Pi("div",n);return i&&(s.style.cssText=i),t[e]=s,o||Gi(s),s}var n=this.map.getContainer();if(this._containerIsCanvas)this.createCanvas();else{n.innerHTML="";var i="position:absolute;top:0px;left:0px;",o=e("mapWrapper","ispace-wrapper","position:absolute;overflow:hidden;",!0),s=e("allLayers","ispace-all-layers",i+"padding:0px;margin:0px;z-index:0;overflow:visible;",!0),a=e("backStatic","ispace-back-static",i+"z-index:0;",!0),l=e("back","ispace-back",i+"z-index:1;"),h=e("backLayer","ispace-back-layer",i),c=e("canvasContainer","ispace-canvas-layer",i+"border:none;z-index:2;"),u=e("frontStatic","ispace-front-static",i+"z-index:3;",!0),f=e("front","ispace-front",i+"z-index:4;",!0),g=e("frontLayer","ispace-front-layer",i+"z-index:0;"),A=e("ui","ispace-ui",i+"border:none;z-index:1;",!0),m=e("control","ispace-control","z-index:1",!0);n.appendChild(o),s.appendChild(a),l.appendChild(h),l.layerDOM=h,s.appendChild(l),s.appendChild(c),f.appendChild(g),f.layerDOM=g,f.uiDOM=A,s.appendChild(u),s.appendChild(f),f.appendChild(A),o.appendChild(s),o.appendChild(m),this.createCanvas(),this.resetContainer();var w=this.map._getContainerDomSize();this.updateMapSize(w)}},i.isViewChanged=function(){if(void 0!==this._isViewChanged)return this._isViewChanged;var t=this._mapview,e=this._getMapView();return this._isViewChanged=!t||!xn(t,e),this._isViewChanged},i._recordView=function(){var t=this.map;!t._onViewChange||t.isInteracting()||t.isAnimating()||xn(t.getView(),t._getCurrentView())||t._onViewChange(t.getView())},i.isSpatialReferenceChanged=function(){return this._spatialRefChanged},i._getMapView=function(){var t=this.map,e=t._getPrjCenter();return{x:e.x,y:e.y,zoom:t.getZoom(),pitch:t.getPitch(),bearing:t.getBearing(),width:t.width,height:t.height}},i._lockFrameRenderEnable=function(){var{maxFPS:t}=this.map.options||{};if(t<=0||s.maxFPS<=t)return!0;var e=Math.ceil(s.maxFPS/t);return this._frameCycleRenderCount>=e},i.onLoad=function(){this._frameLoop(0)},i._frameLoop=function(t){this.map?(this._bindFrameLoop||(this._bindFrameLoop=this._frameLoop.bind(this)),this.ready?(this._frameCycleRenderCount++,this._lockFrameRenderEnable()?(this._frameTimestamp=t=t||0,this._resizeCount=0,this.renderFrame(t),this._frameCycleRenderCount=0):this.map.options.debug&&console.log("skip framing, frameCycleRenderCount:",this._frameCycleRenderCount),this._animationFrame=Ae(this._bindFrameLoop)):this._animationFrame=Ae(this._bindFrameLoop)):this._cancelFrameLoop()},i._cancelFrameLoop=function(){delete this._bindFrameLoop,this._animationFrame&&me(this._animationFrame)},i._updateCanvasSize=function(){if(this.canvas&&!this._containerIsCanvas){var t=this.map,e=t.getSize(),n=this.canvas,i=t.getDevicePixelRatio(),{width:o,height:s,cssWidth:a,cssHeight:l}=Dn(e,i);!n.style||n.style.width===a&&n.style.height===l||(n.style.width=a,n.style.height=l),o===n.width&&s===n.height||(n.width=o,n.height=s);var h=this.topLayer;!h||o===h.width&&s===h.height||(h.width=o,h.height=s,h.style.width=a,h.style.height=l)}},i.createCanvas=function(){var t=this;this._containerIsCanvas?this.canvas=this.map.getContainer():(this.canvas=Pi("canvas"),this.map.getPanels().canvasContainer.appendChild(this.canvas),this._updateCanvasSize());this.createContext().then((function(){t.ready=!0}))},i.createContext=function(){return Am(this,0,void 0,ue().mark((function t(){return ue().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)})))},i.clearLayerCanvasContext=function(t){},i.clearCanvas=function(){},i.createTopCanvas=function(){this.topLayer=Pi("canvas"),this.map.getPanels().canvasContainer.insertBefore(this.topLayer,this.canvas),this.topCtx=this.topLayer.getContext("2d")},i.removeTopCanvas=function(){ki(this.topLayer),delete this.topLayer,delete this.topCtx},i._updateDomPosition=function(t){return void 0===this._checkPositionTime&&(this._checkPositionTime=0),Math.abs(t-this._checkPositionTime)>=500&&(Wi(this.map.getContainer()),this._checkPositionTime=t),this},i._handleResizeEventList=function(t){if(!this._resizeEventList)return this;var e=this._resizeEventList.length;return 0===e||this._resizeTime&&t-this._resizeTime<60||(this.map.setContainerDomRect(this._resizeEventList[e-1].contentRect),this._resizeEventList=[],this._checkSize(),this._resizeCount=this._resizeCount||0,this.renderFrame((this._frameTimestamp||0)+ ++this._resizeCount/100),this._resizeTime=t),this},i._checkSize=function(){this.map&&this.map.checkSize()},i._setCheckSizeInterval=function(t){var e=this;Gt.resizeObserver?(this._resizeObserver&&this._resizeObserver.disconnect(),this.map&&(this._resizeObserver=new ResizeObserver((function(t){!e.map||e.map.isRemoved()?e._resizeObserver.disconnect():t.length&&(e._resizeEventList=e._resizeEventList||[],e._resizeEventList.push(t[0]))})),this._resizeObserver.observe(this.map.getContainer()))):(clearInterval(this._resizeInterval),this._checkSizeInterval=t,this._resizeInterval=setInterval((function(){!e.map||e.map.isRemoved()?clearInterval(e._resizeInterval):e._checkSize()}),this._checkSizeInterval))},i._registerEvents=function(){var t=this,e=this.map;e.options.checkSize&&!n&&"undefined"!=typeof window&&this._setCheckSizeInterval(e.options.checkSizeInterval),Gt.mobile||e.on("_mousemove",this._onMapMouseMove,this),e.on("_dragrotatestart _dragrotating _dragrotateend _movestart _moving _moveend _zoomstart",(function(e){t._eventParam=e})),e.on("_zooming",(function(n){e.getPitch()||(t._zoomMatrix=n.matrix.container),t._eventParam=n})),e.on("_zoomend",(function(e){t._eventParam=e,delete t._zoomMatrix})),e.on("_spatialreferencechange",(function(){t._spatialRefChanged=!0})),Gt.webgl&&"undefined"!=typeof document&&(Kl.on($l,this._thisDocDPRChange,this),Kl.on(th,this._thisDocVisibilitychange,this),Kl.on(eh,this._thisDocDragStart,this),Kl.on(nh,this._thisDocDragEnd,this))},i._onMapMouseMove=function(t){var e=this,n=this.map;!n.isInteracting()&&n.options.hitDetect&&(this._hitDetectFrame&&me(this._hitDetectFrame),this._hitDetectFrame=Ae((function(){e.hitDetect(t.containerPoint)})))},i._getCanvasLayers=function(){return this.map._getLayers((function(t){return t.isCanvasRender()}))},i.addTopElement=function(t){this._tops||(this._tops=[]),this._tops.push(t)},i.removeTopElement=function(t){if(this._tops){var e=this._tops.indexOf(t);e>=0&&this._tops.splice(e,1)}},i.getTopElements=function(){return this._tops||[]},i.sortTopElements=function(){this._tops=this._tops.sort((function(t,e){return((e.options||{}).zIndex||0)-((t.options||{}).zIndex||0)}))},i.drawTops=function(){this.getTopElements().length?(this.topCtx||this.createTopCanvas(),this.drawTopElements()):this.topCtx&&this.removeTopCanvas()},i.drawTopElements=function(){var t=this.getTopElements();this.topCtx.clearRect(0,0,this.topLayer.width,this.topLayer.height);var e=mm;e.clear(),this.map.fire("drawtopstart"),this.map.fire("drawtops");for(var n=!1,i=this.map.getDevicePixelRatio(),o=[],s=0;s<t.length;s++){var a=t[s];if(a.needCollision&&a.needCollision()){var l=a.getRenderBBOX(i);if(l){if(e.collides(l)){var h=a.target&&a.target._geometry;h&&-1===o.indexOf(h)&&(o.push(h),h.fire("handlecollision"));continue}e.insertBox(l)}}a.render(this.topCtx)&&(n=!0)}n&&this.context.drawImage(this.topLayer,0,0),this.map.fire("drawtopsend")},e}(pm),_m=function(t){function e(){return t.apply(this,arguments)||this}he(e,t);var n=e.prototype;return n.renderFrame=function(t){var e=this.map;if(!e||!e.options.renderable)return!1;if(this._handleResizeEventList(t),e.options.stopRenderOnOffscreen&&this._containerIsOffscreen())return!0;this._updateDomPosition(t),delete this._isViewChanged,e._fireEvent("framestart"),this.updateMapDOM(),e.clearCollisionIndex();var n=this._getAllLayerToRender();return this.drawLayers(n,t),this.drawLayerCanvas(n)&&(this.drawTops(),this._drawCenterCross(),e.options.debugSky&&this._debugSky()),this._needClear=!1,e._fireEvent("frameend"),this._recordView(),this._mapview=this._getMapView(),delete this._spatialRefChanged,this._fireLayerLoadEvents(),this.executeFrameCallbacks(),this._canvasUpdated=!1,e.uiCollides(),!0},n._needRedrawAllLayers=function(t){var e=this;if(this.isSpatialReferenceChanged())return!0;var n=[];t.forEach((function(t){if(t&&(t._toRedraw=e._checkLayerRedraw(t))){n.push(t);var i=t.getLayers&&t.getLayers();i&&Array.isArray(i)&&ke(n,i)}}));for(var i=0,o=n.length;i<o;i++){var s=n[i],a=s&&s.options;if(a&&a.collision&&"map"===a.collisionScope)return!0}return!1},n.drawLayers=function(t,e){for(var n=this._needRedrawAllLayers(t),i=this.map,o=i.isInteracting(),s=[],a=[],l=i.options.fpsOnInteracting||0,h=0===l?0:1e3/l,c=this.map.options.layerCanvasLimitOnInteracting,u=t.length,f=i.getBaseLayer(),g=0,A=0;A<u;A++){var m=t[A];if(m.isVisible()){var w=m.isCanvasRender();w&&s.push(m.getId());var T=m._getRenderer();if(T){var M=n||m._toRedraw;w&&T.isCanvasUpdated()&&(M||a.push(m.getId()),this.setLayerCanvasUpdated());var C=T.__zoomTransformMatrix;if(delete T.__zoomTransformMatrix,M){if(o&&w){if(c>0&&u-1-A>c&&m!==f){m._getRenderer().clearCanvas();continue}g+=this._drawCanvasLayerOnInteracting(m,g,h,e)}else o&&T.drawOnInteracting?(T.prepareRender&&T.prepareRender(),T.checkAndDraw?T.checkAndDraw(T.drawOnInteracting,this._eventParam,e):T.drawOnInteracting(this._eventParam,e)):(T.render(e),w&&C&&T.isLoadingResource()&&(T.__zoomTransformMatrix=C));w&&(a.push(m.getId()),this.setLayerCanvasUpdated())}else w&&o&&(i.isZooming()&&!i.getPitch()?(T.prepareRender(),T.__zoomTransformMatrix=this._zoomMatrix):(i.getPitch()||i.isRotating())&&T.clearCanvas())}}}var P=this._canvasIds||[],I=this._updatedIds||[];if(this._canvasIds=s,this._updatedIds=a,!this.isLayerCanvasUpdated()){var O="---";P.join(O)===s.join(O)&&I.join(O)===a.join(O)||this.setLayerCanvasUpdated()}return!0},n._drawCanvasLayerOnInteracting=function(t,e,n,i){var o=this.map,s=t._getRenderer(),a=s.getDrawTime(),l=0===n||n>0&&e+a<=n;if(s.mustRenderOnInteracting&&s.mustRenderOnInteracting())s.render(i);else{if(s.drawOnInteracting&&(t===o.getBaseLayer()||l||o.isZooming()&&t.options.forceRenderOnZooming||o.isMoving()&&t.options.forceRenderOnMoving||o.isRotating()&&t.options.forceRenderOnRotating))return s.prepareRender(),s.prepareCanvas(),s.checkAndDraw?s.checkAndDraw(s.drawOnInteracting,this._eventParam,i):s.drawOnInteracting(this._eventParam,i),a;!o.isZooming()||o.getPitch()||o.isRotating()?(o.getPitch()||o.isRotating())&&s.clearCanvas():(s.prepareRender(),s.__zoomTransformMatrix=this._zoomMatrix)}return s.drawOnInteracting&&!l&&s.onSkipDrawOnInteracting(this._eventParam,i),0},n._fireLayerLoadEvents=function(){if(this._updatedIds&&this._updatedIds.length>0){var t=this.map;this._updatedIds.reverse().forEach((function(e){var n=t.getLayer(e);if(n){var i=n._getRenderer();i&&i.isRenderComplete()&&n.fire("layerload")}}))}},n.isLayerCanvasUpdated=function(){return this._canvasUpdated},n.setLayerCanvasUpdated=function(){this._canvasUpdated=!0},n.drawLayerCanvas=function(t){var e=this.map;if(!e)return!1;if(!this.isLayerCanvasUpdated()&&!this.isViewChanged()&&!1===this._needClear)return!1;this.canvas||this.createCanvas(),e._fireEvent("renderstart",{context:this.context}),this._updateCanvasSize()||this.clearCanvas();for(var n,i=e.isInteracting(),o=e.options.layerCanvasLimitOnInteracting,s=t.length,a=[],l=0;l<s;l++){if(t[l].isVisible()&&t[l].isCanvasRender())if(t[l]._getRenderer()){var h=this._getLayerImage(t[l]);h&&h.image&&(t[l]===e.getBaseLayer()?n=[t[l],h]:a.push([t[l],h]))}}var c=this.canvas.width,u=this.canvas.height;n&&(this._drawLayerCanvasImage(n[0],n[1],c,u),this._drawFog()),s=a.length;for(var f=i&&o>=0&&s>o?s-o:0;f<s;f++)this._drawLayerCanvasImage(a[f][0],a[f][1],c,u);return e._fireEvent("renderend",{context:this.context}),!0},n.setToRedraw=function(){var t=this._getAllLayerToRender();this._needClear=!0;for(var e=0,n=t.length;e<n;e++){var i=t[e].getRenderer();i&&i.canvas&&i.setToRedraw&&i.setToRedraw()}},n.remove=function(){delete this.context,t.prototype.remove.call(this)},n.hitDetect=function(t){var e=this.map;if(e&&e.options.hitDetect&&!e.isInteracting()){var n=e._getLayers(),i="default",o=e.options.hitDetectLimit||0,s=0;t&&t._round&&t._round();for(var a=n.length-1;a>=0;a--){var l=n[a];if(!(!l.options.hitDetect||l.isEmpty&&l.isEmpty())&&l.options.geometryEvents){var h=l._getRenderer();if(h&&h.hitDetect&&(!h.isBlank||!h.isBlank())){if("default"!==l.options.cursor&&h.hitDetect(t)){i=l.options.cursor||"pointer";break}if(s++,o>0&&s>o)break}}}e._trySetCursor(i)}},n._getLayerImage=function(t){var e=t._getRenderer();return e.getCanvasImage?e.getCanvasImage():null},n._drawLayerCanvasImage=function(t,e,n,i){var o=this.context,s=e.point.round(),a=this.map.getDevicePixelRatio();1!==a&&s._multi(a);var l=e.image,h=l.width,u=l.height;if(!(s.x+h<=0||s.y+u<=0)){var f=t.options.opacity;if(c(f)||(f=1),!(f<=0)){var g=e.opacity;if(c(g)||(g=1),!(g<=0)){var A=o.globalAlpha;f<1&&(o.globalAlpha*=f),g<1&&(o.globalAlpha*=g),t.options.cssFilter&&(o.filter=t.options.cssFilter);var m=t.getRenderer(),w=m.__zoomTransformMatrix,T=m.clipCanvas(this.context);w&&(o.save(),o.setTransform(...w)),o.drawImage(l,0,0,h,u,s.x,s.y,n,i),w&&o.restore(),T&&o.restore(),"none"!==o.filter&&(o.filter="none"),o.globalAlpha=A}}}},n._drawCenterCross=function(){var t=this.map.options.centerCross;if(t){var e=this.context,n=new _e(this.canvas.width/2,this.canvas.height/2);A(t)?t(e,n):zl.drawCross(this.context,n.x,n.y,2,"#f00")}},n._drawContainerExtent=function(){var{cascadePitches:t}=this.map.options,e=this.map.height-this.map._getVisualHeight(t[0]),n=this.map.height-this.map._getVisualHeight(t[1]),i=this.map.getContainerExtent(),o=this.context;o.beginPath(),o.moveTo(0,i.ymin),o.lineTo(i.xmax,i.ymin),o.stroke(),o.beginPath(),o.moveTo(0,e),o.lineTo(i.xmax,e),o.stroke(),o.beginPath(),o.moveTo(0,n),o.lineTo(i.xmax,n),o.stroke()},n._drawFog=function(){var t=this.map;if(!(t.getPitch()<=t.options.maxVisualPitch)&&t.options.fog){var e=t.getDevicePixelRatio(),n=this.context,i=t.getContainerExtent(),o=(t.height-t._getVisualHeight(75))*e;o<0&&(o=0);var s=i.ymin*e,a=Math.ceil(s-o),l=t.options.fogColor.join(),h=n.createLinearGradient(0,o,0,s+30),c=1-30/(a+30);h.addColorStop(0,"rgba("+l+", 0)"),h.addColorStop(.3,"rgba("+l+", 0.3)"),h.addColorStop(c,"rgba("+l+", 1)"),h.addColorStop(1,"rgba("+l+", 0)"),n.beginPath(),n.fillStyle=h,n.fillRect(0,o,Math.ceil(i.getWidth())*e,Math.ceil(a+30))}},n._debugSky=function(){var t=this.map;if(!t)return this;var e=t.getContainerExtent().ymin;if(e<=0)return this;var n=this.context;return n.strokeStyle="red",n.strokeRect(0,0,t.width,e),this},n.clearCanvas=function(){this.canvas&&zl.clearRect(this.context,0,0,this.canvas.width,this.canvas.height)},n._updateCanvasSize=function(){if(!this.canvas||this._containerIsCanvas)return!1;var t=this.map,e=t.getSize(),n=this.canvas,i=t.getDevicePixelRatio(),{width:o,height:s,cssWidth:a,cssHeight:l}=Dn(e,i);return!n.style||n.style.width===a&&n.style.height===l||(n.style.width=a,n.style.height=l),(o!==n.width||s!==n.height)&&(n.height=s,n.width=o,this.topLayer.width=n.width,this.topLayer.height=n.height,!0)},n.createCanvas=function(){this.topLayer=Pi("canvas"),this.topCtx=this.topLayer.getContext("2d"),this._containerIsCanvas?this.canvas=this.map.getContainer():(this.canvas=Pi("canvas"),this._updateCanvasSize(),this.map.getPanels().canvasContainer.appendChild(this.canvas)),this.context=this.canvas.getContext("2d"),this.ready=!0},n.drawTops=function(){t.prototype.drawTopElements.call(this)},e}(ym);Lf.registerRenderer("canvas",_m),Lf.mergeOptions({fog:!1,fogColor:[233,233,233]});var vm=Object.freeze({__proto__:null,CanvasLayerRenderer:AA,CanvasRenderer:oA,CanvasTileLayerCanvasRenderer:tm,CanvasTileLayerGLRenderer:em,ImageGLRenderable:nA,ImageLayerCanvasRenderer:uA,ImageLayerGLRenderer:fA,LayerAbstractRenderer:Cf,MapAbstractRenderer:ym,MapCanvasRenderer:_m,MapRenderer:pm,OverlayLayerCanvasRenderer:sm,OverlayLayerGLRenderer:am,QuadStencil:im,Renderable:bc,ResourceCache:Ns,TileLayerCanvasRenderer:JA,TileLayerGLRenderer:KA,TileLayerRendererable:VA,VectorLayerCanvasRenderer:gm}),xm={_getRenderPoints:function(){return[[this._getCenter2DPoint(this.getMap().getGLRes())],null]}};ld.include(xm),Sd.include(xm),Md.include(xm),Id.include(xm),Pd.include({_getRenderPoints:function(t){var e=this.getMap(),n=e.getGLRes();if("vertex"===t){for(var i=this._trimRing(this.getShell()),o=[],s=0,a=i.length;s<a;s++)o.push(e.coordToPointAtRes(i[s],n));return[o,null]}return[[e.coordToPointAtRes(this.getCenter(),n)],null]}});var bm={_getRenderPoints:function(t){var e,n=this.getMap(),i=n.getGLRes(),o=null;if("point"===t)(e=this._getPath2DPoints(this._getPrjCoordinates(),!1,i))&&e.length>0&&Array.isArray(e[0])&&(e=e[0].concat(e[1]));else if("vertex"===t)if(o=[],(e=this._getPath2DPoints(this._getPrjCoordinates(),!1,i))&&e.length>0&&Array.isArray(e[0])){for(var s=0,a=e.length;s<a;s++)for(var l=0,h=e[s].length;l<h;l++)o.push(0===l?[e[s][l],e[s][l+1]]:[e[s][l-1],e[s][l]]);e=e[0].concat(e[1])}else for(var c=0,u=e.length;c<u;c++)o.push(0===c?[e[c],e[c+1]]:[e[c-1],e[c]]);else if("line"===t){e=[],o=[];var f=this._getPath2DPoints(this._getPrjCoordinates(),!1,i);if(f.length>0&&Array.isArray(f[0]))for(var g,A=1,m=f.length;A<m;A++){g=f[A],this instanceof od&&g.length>0&&!g[0].equals(g[g.length-1])&&g.push(g[0]);for(var w=1,T=g.length;w<T;w++)e.push(g[w].add(g[w-1])._multi(.5)),o.push([g[w-1],g[w]])}else{this instanceof od&&f.length>0&&!f[0].equals(f[f.length-1])&&f.push(f[0]);for(var M=1,C=f.length;M<C;M++)e.push(f[M].add(f[M-1])._multi(.5)),o.push([f[M-1],f[M]])}}else if("vertex-first"===t){var P=this._getPrjCoordinates(),I=P.length,O=I?n._prjToPointAtRes(P[0],i):null;e=I?[O]:[],o=I?[[O,P[1]?n._prjToPointAtRes(P[1],i):O]]:[]}else if("vertex-last"===t){var E=this._getPrjCoordinates(),D=E.length,N=D?n._prjToPointAtRes(E[D-1],i):null;e=D?[N]:[];var H=D>1?D-2:D-1;o=D?[[E[H]?n._prjToPointAtRes(E[H],i):N,N]]:[]}else if("vertex-firstlast"===t){e=[],o=[];var U=this._getPrjCoordinates(),W=U.length;if(W){var q=n._prjToPointAtRes(U[0],i);if(e=[q],W>1){o=[[q,n._prjToPointAtRes(U[1],i)]];var X=n._prjToPointAtRes(U[W-1],i);e.push(X),o.push([n._prjToPointAtRes(U[W>1?W-2:W-1],i),X])}}}else{var J=this.getCenter();if(J){var Q=this._getProjection().project(J);e=[n._prjToPointAtRes(Q,i)]}else e=[]}return[e,o]}};cd.include(bm),od.include(bm);var wm={within:!1,center:[0,0]};function Tm(t){if(t&&t._containerBbox){wm.within=!1;var{minx:e,miny:n,maxx:i,maxy:o}=t._containerBbox,s=Math.abs(i-e),a=Math.abs(o-n);s<=1&&a<=1&&(wm.within=!0,wm.center[0]=(e+i)/2,wm.center[1]=(n+o)/2),delete t._containerBbox}else wm.within=!1;return wm}function Mm(){var t=this._getPrjShell(),e=ws();Ps(t,e);var[n,i,o,s]=e;return new Ph(n,i,o,s)}function Cm(){var t=this._getPrjShell();if(!t||!Array.isArray(t))return[];var e=this._getProjection(),n=this.getCoordinates()||{};return t.map((function(t){var i=e.unproject(t);return i.z=n.z||0,i}))}cf.include({_redrawWhenPitch:function(){return!1},_redrawWhenRotate:function(){return!1},_getRenderBBOX:function(t,e){return t.isHitTesting?null:(Ss(Cs),Ps(e,Cs),Cs)}});var Sm={_redrawWhenPitch:function(){return!0},_redrawWhenRotate:function(){return this instanceof Sd||this instanceof Id},_computeRotatedPrjExtent:Mm,getRotatedShell:Cm,_paintAsPath:function(){if(this.isRotated())return!0;var t=this.getMap();return this._getAltitude()>0||t.getPitch()||this instanceof Sd&&t.getBearing()},_getPaintParams:function(){var t=this.getMap();if(this._paintAsPath())return od.prototype._getPaintParams.call(this,!0);var e=this._getPrjCoordinates(),n=t._prjToPointAtRes(e,t.getGLRes());return[n,...this._getRenderSize(n)]},_paintOn:function(...t){return this._paintAsPath()?zl.polygon(...t):zl.ellipse(...t)},_getRenderSize:function(t){var e=this.getMap(),n=e.getGLRes(),i=this._getPrjExtent(),o=e._prjToPointAtRes(i.getMin(),n),s=e._prjToPointAtRes(i.getMax(),n);return[Math.abs(s.x-o.x)/2,Math.abs(s.y-t.y),Math.abs(t.y-o.y)]}};Sd.include(Sm),Md.include(Sm),Pd.include({_getPaintParams:function(){var t=this.getMap(),e=this._getPrjShell();return[this._getPath2DPoints(e,!1,t.getGLRes())]},_paintOn:zl.polygon,_computeRotatedPrjExtent:Mm,getRotatedShell:Cm});var Pm={_redrawWhenPitch:function(){return!0},_getPaintParams:function(){if(this._paintAsPath())return od.prototype._getPaintParams.call(this,!0);var t=this.getMap(),e=t._prjToPointAtRes(this._getPrjCoordinates(),t.getGLRes()),n=this._getRenderSize(e),[i,o]=this._correctAngles();return[e,n[0],[i,o]]},_paintOn:function(...t){if(this._paintAsPath())return zl.polygon(...t);var e=this.getMap().getBearing();return e&&(t[3]=t[3].slice(0),t[3][0]+=e,t[3][1]+=e),zl.sector(...t)}};Id.include(Sm,Pm),id.include({_paintAsPath:function(){return!0}});var Im={arrowStyles:{classic:[3,4]},_getArrowShape:function(t,e,n,i,o){if(!t||!e||t.equals(e))return null;o||(o=0);var s,a=n*i[1]+o,l=n*i[0]/2+o;(s=e.sub(e.nextCtrlPoint||e.prevCtrlPoint?new _e(e.prevCtrlPoint?e.prevCtrlPoint:e.nextCtrlPoint):t))._unit();var h=e.sub(s.multi(a));s._perp();var c=h.add(s.multi(l));return s._multi(-1),[c,e,h.add(s.multi(l)),c]},_getPaintParams:function(){var t=this._getPrjCoordinates();return[this._getPath2DPoints(t,!1,this.getMap().getGLRes())]},_paintOn:function(t,e,n,i,o,s){var a=Tm(this._painter);return a.within?zl.pixelRect(t,a.center,n,i):this.options.smoothness?zl.paintSmoothLine(t,e,n,this.options.smoothness,!1,this._animIdx,this._animTailRatio):(t.lineColorIn=s,zl.path(t,e,n,null,o)),this._paintArrow(t,e,n),this._getRenderBBOX(t,e)},_getArrowPlacement:function(){return this.options.arrowPlacement},_getArrowStyle:function(){var t=this.options.arrowStyle;return t?Array.isArray(t)?t:this.arrowStyles[t]:null},_getArrows:function(t,e,n){var i=this,o=this._getArrowStyle();if(!o||t.length<2)return[];for(var s,a,l=t.length>0&&Array.isArray(t[0])?t:[t],h=this._getArrowPlacement(),c=[],u=function(){if(s&&a){var t=i._getArrowShape(s,a,e,o,n);t&&c.push(t)}},f=l.length-1;f>=0;f--){var g=l[f],A=g.length,m=g[0],w=g[A-1];"vertex-first"===h?(s=m.arrowNextPoint||g[1],a=m):"vertex-last"===h&&(s=w.arrowPrePoint||g[A-2],a=w),u(),"vertex-firstlast"===h&&(s=m.arrowNextPoint||g[1],a=m,u(),s=w.arrowPrePoint||g[A-2],a=w,u()),"point"===h&&this._getArrowPoints(c,g,e,o,n)}return c},_getArrowPoints:function(t,e,n,i,o){for(var s=0,a=e.length-1;s<a;s++){var l=e[s+1],h=this._getArrowShape(l.arrowPrePoint||e[s],l,n,i,o);h&&t.push(h)}},_paintArrow:function(t,e,n){var i=this._getInternalSymbol().lineWidth;(!c(i)||i<3)&&(i=3);var o=this._getArrows(e,i);if(o.length){t.setLineDash&&t.setLineDash([]);for(var s=o.length-1;s>=0;s--)t.fillStyle=t.strokeStyle,zl.polygon(t,o[s],n,n)}}};cd.include(Im);var Om={_getPaintParams:function(t){var e=this.getMap().getGLRes(),n=this._getPrjShell(),i=this._getPath2DPoints(n,t,e),o=i.length>0&&Array.isArray(i[0]);o&&(i=[[i[0]],[i[1]]]);var s=this._getPrjHoles(),a=[];if(s&&s.length>0){for(var l=this._simplified,h=0;h<s.length;h++){var c=this._getPath2DPoints(s[h],t,e);Array.isArray(c)&&o?Array.isArray(c[0])?(i[0].push(c[0]),i[1].push(c[1])):i[0].push(c):a.push(c)}l&&(this._simplified=l)}return o||ke(i=[i],a),[i]},_paintOn:function(t,e,n,i,o,s){var a=Tm(this._painter);return a.within?zl.pixelRect(t,a.center,n,i):(t.lineColorIn=s,zl.polygon(t,e,n,i,o,this.options.smoothness)),this._getRenderBBOX(t,e)}};od.include(Om),Lf.VERSION=e;var Em={Actor:xf};o(e);"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function km(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Rm={exports:{}};!function(t,e){t.exports=function(){function t(t,e){this.id=Ct++,this.type=t,this.data=e}function e(t){if(0===t.length)return[];var n=t.charAt(0),i=t.charAt(t.length-1);if(1<t.length&&n===i&&('"'===n||"'"===n))return['"'+t.substr(1,t.length-2).replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'];if(n=/\[(false|true|null|\d+|'[^']*'|"[^"]*")\]/.exec(t))return e(t.substr(0,n.index)).concat(e(n[1])).concat(e(t.substr(n.index+n[0].length)));if(1===(n=t.split(".")).length)return['"'+t.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'];for(t=[],i=0;i<n.length;++i)t=t.concat(e(n[i]));return t}function n(t){return"["+e(t).join("][")+"]"}function i(e,n){return"function"==typeof e?new t(0,e):"number"==typeof e||"boolean"==typeof e?new t(5,e):Array.isArray(e)?new t(6,e.map((function(t,e){return i(t)}))):e instanceof t?e:void 0}function o(){var t={"":0},e=[""];return{id:function(n){var i=t[n];return i||(i=t[n]=e.length,e.push(n),i)},str:function(t){return e[t]}}}function s(t,e,n){function i(){var e=window.innerWidth,i=window.innerHeight;t!==document.body&&(e=(i=t.getBoundingClientRect()).right-i.left,i=i.bottom-i.top),s.width=n*e,s.height=n*i,bt(s.style,{width:e+"px",height:i+"px"})}var o,s=document.createElement("canvas");return bt(s.style,{border:0,margin:0,padding:0,top:0,left:0}),t.appendChild(s),t===document.body&&(s.style.position="absolute",bt(t.style,{margin:0,padding:0})),t!==document.body&&"function"==typeof ResizeObserver?(o=new ResizeObserver((function(){setTimeout(i)}))).observe(t):window.addEventListener("resize",i,!1),i(),{canvas:s,onDestroy:function(){o?o.disconnect():window.removeEventListener("resize",i),t.removeChild(s)}}}function a(t,e){function n(n){try{return t.getContext(n,e)}catch(t){return null}}return n("webgl")||n("experimental-webgl")||n("webgl-experimental")}function l(t){return"string"==typeof t?t.split():t}function h(t){return"string"==typeof t?document.querySelector(t):t}function c(t){var e,n,i,o,c=t||{};t={};var u=[],f=[],g="undefined"==typeof window?1:window.devicePixelRatio,A=!1,m=function(t){},w=function(){};if("string"==typeof c?e=document.querySelector(c):"object"==typeof c&&("string"==typeof c.nodeName&&"function"==typeof c.appendChild&&"function"==typeof c.getBoundingClientRect?e=c:"function"==typeof c.drawArrays||"function"==typeof c.drawElements?i=(o=c).canvas:("gl"in c?o=c.gl:"canvas"in c?i=h(c.canvas):"container"in c&&(n=h(c.container)),"attributes"in c&&(t=c.attributes),"extensions"in c&&(u=l(c.extensions)),"optionalExtensions"in c&&(f=l(c.optionalExtensions)),"onDone"in c&&(m=c.onDone),"profile"in c&&(A=!!c.profile),"pixelRatio"in c&&(g=+c.pixelRatio))),e&&("canvas"===e.nodeName.toLowerCase()?i=e:n=e),!o){if(!i){if(!(e=s(n||document.body,m,g)))return null;i=e.canvas,w=e.onDestroy}void 0===t.premultipliedAlpha&&(t.premultipliedAlpha=!0),o=a(i,t)}return o?{gl:o,canvas:i,container:n,extensions:u,optionalExtensions:f,pixelRatio:g,profile:A,onDone:m,onDestroy:w}:(w(),m("webgl not supported, try upgrading your browser or graphics drivers http://get.webgl.org"),null)}function u(t,e){function n(e){var n;e=e.toLowerCase();try{n=i[e]=t.getExtension(e)}catch(t){}return!!n}for(var i={},o=0;o<e.extensions.length;++o){var s=e.extensions[o];if(!n(s))return e.onDestroy(),e.onDone('"'+s+'" extension is not supported by the current WebGL context, try upgrading your system or a different browser'),null}return e.optionalExtensions.forEach(n),{extensions:i,restore:function(){Object.keys(i).forEach((function(t){if(i[t]&&!n(t))throw Error("(regl): error restoring extension "+t)}))}}}function f(t,e){for(var n=Array(t),i=0;i<t;++i)n[i]=e(i);return n}function g(t){var e,n;return e=(65535<t)<<4,e|=n=(255<(t>>>=e))<<3,(e|=n=(15<(t>>>=n))<<2)|(n=(3<(t>>>=n))<<1)|t>>>n>>1}function A(){function t(t){t:{for(var e=16;268435456>=e;e*=16)if(t<=e){t=e;break t}t=0}return 0<(e=n[g(t)>>2]).length?e.pop():new ArrayBuffer(t)}function e(t){n[g(t.byteLength)>>2].push(t)}var n=f(8,(function(){return[]}));return{alloc:t,free:e,allocType:function(e,n){var i=null;switch(e){case 5120:i=new Int8Array(t(n),0,n);break;case 5121:i=new Uint8Array(t(n),0,n);break;case 5122:i=new Int16Array(t(2*n),0,n);break;case 5123:i=new Uint16Array(t(2*n),0,n);break;case 5124:i=new Int32Array(t(4*n),0,n);break;case 5125:i=new Uint32Array(t(4*n),0,n);break;case 5126:i=new Float32Array(t(4*n),0,n);break;default:return null}return i.length!==n?i.subarray(0,n):i},freeType:function(t){e(t.buffer)}}}function m(t){return!!t&&"object"==typeof t&&Array.isArray(t.shape)&&Array.isArray(t.stride)&&"number"==typeof t.offset&&t.shape.length===t.stride.length&&(Array.isArray(t.data)||oe(t.data))}function w(t,e,n,i,o,s){for(var a=0;a<e;++a)for(var l=t[a],h=0;h<n;++h)for(var c=l[h],u=0;u<i;++u)o[s++]=c[u]}function T(t,e,n,i,o){for(var s=1,a=n+1;a<e.length;++a)s*=e[a];var l=e[n];if(4==e.length-n){var h=e[n+1],c=e[n+2];for(e=e[n+3],a=0;a<l;++a)w(t[a],h,c,e,i,o),o+=s}else for(a=0;a<l;++a)T(t[a],e,n+1,i,o),o+=s}function M(t){return 0|ce[Object.prototype.toString.call(t)]}function C(t,e){for(var n=0;n<e.length;++n)t[n]=e[n]}function P(t,e,n,i,o,s,a){for(var l=0,h=0;h<n;++h)for(var c=0;c<i;++c)t[l++]=e[o*h+s*c+a]}function I(t,e,n,i){function o(e){this.id=h++,this.buffer=t.createBuffer(),this.type=e,this.usage=35044,this.byteLength=0,this.dimension=1,this.dtype=5121,this.persistentData=null,n.profile&&(this.stats={size:0})}function s(e,n,i){e.byteLength=n.byteLength,t.bufferData(e.type,n,i)}function a(t,e,n,i,o,a){if(t.usage=n,Array.isArray(e)){if(t.dtype=i||5126,0<e.length)if(Array.isArray(e[0])){o=pe(e);for(var l=i=1;l<o.length;++l)i*=o[l];t.dimension=i,s(t,e=ge(e,o,t.dtype),n),a?t.persistentData=e:ne.freeType(e)}else"number"==typeof e[0]?(t.dimension=o,C(o=ne.allocType(t.dtype,e.length),e),s(t,o,n),a?t.persistentData=o:ne.freeType(o)):oe(e[0])&&(t.dimension=e[0].length,t.dtype=i||M(e[0])||5126,s(t,e=ge(e,[e.length,e[0].length],t.dtype),n),a?t.persistentData=e:ne.freeType(e))}else if(oe(e))t.dtype=i||M(e),t.dimension=o,s(t,e,n),a&&(t.persistentData=new Uint8Array(new Uint8Array(e.buffer)));else if(m(e)){var h=e.stride,c=(l=e.offset,0),u=0,f=0,g=0;1===(o=e.shape).length?(c=o[0],u=1,f=h[0],g=0):2===o.length&&(c=o[0],u=o[1],f=h[0],g=h[1]),t.dtype=i||M(e.data)||5126,t.dimension=u,P(o=ne.allocType(t.dtype,c*u),e.data,c,u,f,g,l),s(t,o,n),a?t.persistentData=o:ne.freeType(o)}else e instanceof ArrayBuffer&&(t.dtype=5121,t.dimension=o,s(t,e,n),a&&(t.persistentData=new Uint8Array(new Uint8Array(e))))}function l(n){e.bufferCount--,i(n),t.deleteBuffer(n.buffer),n.buffer=null,delete c[n.id]}var h=0,c={};o.prototype.bind=function(){t.bindBuffer(this.type,this.buffer)},o.prototype.destroy=function(){l(this)};var u=[];return n.profile&&(e.getTotalBufferSize=function(){var t=0;return Object.keys(c).forEach((function(e){t+=c[e].stats.size})),t}),{create:function(i,s,h,u){function f(e){var i=35044,o=null,s=0,l=0,h=g&&g.dimension||1;return Array.isArray(e)||oe(e)||m(e)||e instanceof ArrayBuffer?o=e:"number"==typeof e?s=0|e:e&&("data"in e&&(o=e.data),"usage"in e&&(i=fe[e.usage]),"type"in e&&(l=ue[e.type]),"dimension"in e&&(h=0|e.dimension),"length"in e&&(s=0|e.length)),g.bind(),o?a(g,o,i,l,h,u):(s&&t.bufferData(g.type,s,i),g.dtype=l||5121,g.usage=i,g.dimension=h,g.byteLength=s),n.profile&&(g.stats.size=g.byteLength*Ae[g.dtype]),f}e.bufferCount++;var g=new o(s);return c[g.id]=g,h||f(i),f._reglType="buffer",f._buffer=g,f.subdata=function(e,n){var i,o=0|(n||0);if(g.bind(),oe(e)||e instanceof ArrayBuffer)t.bufferSubData(g.type,o,e);else if(Array.isArray(e)){if(0<e.length)if("number"==typeof e[0]){var s=ne.allocType(g.dtype,e.length);C(s,e),t.bufferSubData(g.type,o,s),ne.freeType(s)}else(Array.isArray(e[0])||oe(e[0]))&&(i=pe(e),s=ge(e,i,g.dtype),t.bufferSubData(g.type,o,s),ne.freeType(s))}else if(m(e)){var a=e.stride,l=s=0,h=0,c=0;1===(i=e.shape).length?(s=i[0],l=1,h=a[0],c=0):2===i.length&&(s=i[0],l=i[1],h=a[0],c=a[1]),i=Array.isArray(e.data)?g.dtype:M(e.data),P(i=ne.allocType(i,s*l),e.data,s,l,h,c,e.offset),t.bufferSubData(g.type,o,i),ne.freeType(i)}return f},n.profile&&(f.stats=g.stats),f.destroy=function(){l(g)},f},createStream:function(t,e){var n=u.pop();return n||(n=new o(t)),n.bind(),a(n,e,35040,0,1,!1),n},destroyStream:function(t){u.push(t)},clear:function(){ae(c).forEach(l),u.forEach(l)},getBuffer:function(t){return t&&t._buffer instanceof o?t._buffer:null},restore:function(){ae(c).forEach((function(e){e.buffer=t.createBuffer(),t.bindBuffer(e.type,e.buffer),t.bufferData(e.type,e.persistentData||e.byteLength,e.usage)}))},_initBuffer:a}}function O(t,e,n,i){function o(t){this.id=h++,l[this.id]=this,this.buffer=t,this.primType=4,this.type=this.vertCount=0}function s(i,o,s,a,l,h,c){var u;if(i.buffer.bind(),o?((u=c)||oe(o)&&(!m(o)||oe(o.data))||(u=e.oes_element_index_uint?5125:5123),n._initBuffer(i.buffer,o,s,u,3)):(t.bufferData(34963,h,s),i.buffer.dtype=u||5121,i.buffer.usage=s,i.buffer.dimension=3,i.buffer.byteLength=h),u=c,!c){switch(i.buffer.dtype){case 5121:case 5120:u=5121;break;case 5123:case 5122:u=5123;break;case 5125:case 5124:u=5125}i.buffer.dtype=u}i.type=u,0>(o=l)&&(o=i.buffer.byteLength,5123===u?o>>=1:5125===u&&(o>>=2)),i.vertCount=o,o=a,0>a&&(o=4,1===(a=i.buffer.dimension)&&(o=0),2===a&&(o=1),3===a&&(o=4)),i.primType=o}function a(t){i.elementsCount--,delete l[t.id],t.buffer.destroy(),t.buffer=null}var l={},h=0,c={uint8:5121,uint16:5123};e.oes_element_index_uint&&(c.uint32=5125),o.prototype.bind=function(){this.buffer.bind()};var u=[];return{create:function(t,e){function l(t){if(t)if("number"==typeof t)h(t),u.primType=4,u.vertCount=0|t,u.type=5121;else{var e=null,n=35044,i=-1,o=-1,a=0,f=0;Array.isArray(t)||oe(t)||m(t)?e=t:("data"in t&&(e=t.data),"usage"in t&&(n=fe[t.usage]),"primitive"in t&&(i=me[t.primitive]),"count"in t&&(o=0|t.count),"type"in t&&(f=c[t.type]),"length"in t?a=0|t.length:(a=o,5123===f||5122===f?a*=2:5125!==f&&5124!==f||(a*=4))),s(u,e,n,i,o,a,f)}else h(),u.primType=4,u.vertCount=0,u.type=5121;return l}var h=n.create(null,34963,!0),u=new o(h._buffer);return i.elementsCount++,l(t),l._reglType="elements",l._elements=u,l.subdata=function(t,e){return h.subdata(t,e),l},l.destroy=function(){a(u)},l},createStream:function(t){var e=u.pop();return e||(e=new o(n.create(null,34963,!0,!1)._buffer)),s(e,t,35040,-1,-1,0,0),e},destroyStream:function(t){u.push(t)},getElements:function(t){return"function"==typeof t&&t._elements instanceof o?t._elements:null},clear:function(){ae(l).forEach(a)}}}function E(t){for(var e=ne.allocType(5123,t.length),n=0;n<t.length;++n)if(isNaN(t[n]))e[n]=65535;else if(1/0===t[n])e[n]=31744;else if(-1/0===t[n])e[n]=64512;else{ye[0]=t[n];var i=(s=_e[0])>>>31<<15,o=(s<<1>>>24)-127,s=s>>13&1023;e[n]=-24>o?i:-14>o?i+(s+1024>>-14-o):15<o?i+31744:i+(o+15<<10)+s}return e}function D(t){return Array.isArray(t)||oe(t)}function N(t){return"[object "+t+"]"}function H(t){return Array.isArray(t)&&(0===t.length||"number"==typeof t[0])}function U(t){return!(!Array.isArray(t)||0===t.length||!D(t[0]))}function W(t){return Object.prototype.toString.call(t)}function q(t){if(!t)return!1;var e=W(t);return 0<=Fe.indexOf(e)||H(t)||U(t)||m(t)}function X(t,e){36193===t.type?(t.data=E(e),ne.freeType(e)):t.data=e}function J(t,e,n,i,o,s){if(t=void 0!==Ge[t]?Ge[t]:be[t]*He[e],s&&(t*=6),o){for(i=0;1<=n;)i+=t*n*n,n/=2;return i}return t*n*i}function Q(t,e,n,i,o,s,a){function l(){this.format=this.internalformat=6408,this.type=5121,this.flipY=this.premultiplyAlpha=this.compressed=!1,this.unpackAlignment=1,this.colorSpace=37444,this.channels=this.height=this.width=0}function h(t,e){t.internalformat=e.internalformat,t.format=e.format,t.type=e.type,t.compressed=e.compressed,t.premultiplyAlpha=e.premultiplyAlpha,t.flipY=e.flipY,t.unpackAlignment=e.unpackAlignment,t.colorSpace=e.colorSpace,t.width=e.width,t.height=e.height,t.channels=e.channels}function c(t,e){if("object"==typeof e&&e){"premultiplyAlpha"in e&&(t.premultiplyAlpha=e.premultiplyAlpha),"flipY"in e&&(t.flipY=e.flipY),"alignment"in e&&(t.unpackAlignment=e.alignment),"colorSpace"in e&&(t.colorSpace=at[e.colorSpace]),"type"in e&&(t.type=ut[e.type]);var n=t.width,i=t.height,o=t.channels,s=!1;"shape"in e?(n=e.shape[0],i=e.shape[1],3===e.shape.length&&(o=e.shape[2],s=!0)):("radius"in e&&(n=i=e.radius),"width"in e&&(n=e.width),"height"in e&&(i=e.height),"channels"in e&&(o=e.channels,s=!0)),t.width=0|n,t.height=0|i,t.channels=0|o,n=!1,"format"in e&&(i=t.internalformat=ft[n=e.format],t.format=ue[i],n in ut&&!("type"in e)&&(t.type=ut[n]),n in gt&&(t.compressed=!0),n=!0),!s&&n?t.channels=be[t.format]:s&&!n&&t.channels!==xe[t.format]&&(t.format=t.internalformat=xe[t.channels])}}function u(e){t.pixelStorei(37440,e.flipY),t.pixelStorei(37441,e.premultiplyAlpha),t.pixelStorei(37443,e.colorSpace),t.pixelStorei(3317,e.unpackAlignment)}function f(){l.call(this),this.yOffset=this.xOffset=0,this.data=null,this.needsFree=!1,this.element=null,this.needsCopy=!1}function g(t,e){var n=null;if(q(e)?n=e:e&&(c(t,e),"x"in e&&(t.xOffset=0|e.x),"y"in e&&(t.yOffset=0|e.y),q(e.data)&&(n=e.data)),e.copy){var i=o.viewportWidth,s=o.viewportHeight;t.width=t.width||i-t.xOffset,t.height=t.height||s-t.yOffset,t.needsCopy=!0}else if(n){if(oe(n))t.channels=t.channels||4,t.data=n,"type"in e||5121!==t.type||(t.type=0|ce[Object.prototype.toString.call(n)]);else if(H(n)){switch(t.channels=t.channels||4,s=(i=n).length,t.type){case 5121:case 5123:case 5125:case 5126:(s=ne.allocType(t.type,s)).set(i),t.data=s;break;case 36193:t.data=E(i)}t.alignment=1,t.needsFree=!0}else if(m(n)){i=n.data,Array.isArray(i)||5121!==t.type||(t.type=0|ce[Object.prototype.toString.call(i)]);var a,l,h,u,f=n.stride;3===(s=n.shape).length?(h=s[2],u=f[2]):u=h=1,a=s[0],l=s[1],s=f[0],f=f[1],t.alignment=1,t.width=a,t.height=l,t.channels=h,t.format=t.internalformat=xe[h],t.needsFree=!0,a=u,n=n.offset;for(var g=ne.allocType(36193===t.type?5126:t.type,(h=t.width)*(u=t.height)*(l=t.channels)),A=0,w=0;w<u;++w)for(var T=0;T<h;++T)for(var M=0;M<l;++M)g[A++]=i[s*T+f*w+a*M+n];X(t,g)}else if(W(n)===we||W(n)===Me||W(n)===Ee)t.element=W(n)===we||W(n)===Me?n:n.canvas,t.width=t.element.width,t.height=t.element.height,t.channels=4;else if(W(n)===ke)t.element=n,t.width=n.width,t.height=n.height,t.channels=4;else if(W(n)===Re)t.element=n,t.width=n.naturalWidth,t.height=n.naturalHeight,t.channels=4;else if(W(n)===Le)t.element=n,t.width=n.videoWidth,t.height=n.videoHeight,t.channels=4;else if(U(n)){for(i=t.width||n[0].length,s=t.height||n.length,f=t.channels,f=D(n[0][0])?f||n[0][0].length:f||1,a=he.shape(n),h=1,u=0;u<a.length;++u)h*=a[u];h=ne.allocType(36193===t.type?5126:t.type,h),he.flatten(n,a,"",h),X(t,h),t.alignment=1,t.width=i,t.height=s,t.channels=f,t.format=t.internalformat=xe[f],t.needsFree=!0}}else t.width=t.width||1,t.height=t.height||1,t.channels=t.channels||4}function A(e,n,o,s,a){var l=e.element,h=e.data,c=e.internalformat,f=e.format,g=e.type,A=e.width,m=e.height;u(e),l?t.texSubImage2D(n,a,o,s,f,g,l):e.compressed?t.compressedTexSubImage2D(n,a,o,s,c,A,m,h):e.needsCopy?(i(),t.copyTexSubImage2D(n,a,o,s,e.xOffset,e.yOffset,A,m)):t.texSubImage2D(n,a,o,s,A,m,f,g,h)}function w(){return fe.pop()||new f}function T(t){t.needsFree&&ne.freeType(t.data),f.call(t),fe.push(t)}function M(){l.call(this),this.genMipmaps=!1,this.mipmapHint=4352,this.mipmask=0,this.images=Array(16)}function C(t,e,n){var i=t.images[0]=w();t.mipmask=1,i.width=t.width=e,i.height=t.height=n,i.channels=t.channels=4}function P(t,e){var n=null;if(q(e))h(n=t.images[0]=w(),t),g(n,e),t.mipmask=1;else if(c(t,e),Array.isArray(e.mipmap))for(var i=e.mipmap,o=0;o<i.length;++o)h(n=t.images[o]=w(),t),n.width>>=o,n.height>>=o,g(n,i[o]),t.mipmask|=1<<o;else h(n=t.images[0]=w(),t),g(n,e),t.mipmask=1;h(t,t.images[0])}function I(e,n){for(var o=e.images,s=0;s<o.length&&o[s];++s){var a=o[s],l=n,h=s,c=a.element,f=a.data,g=a.internalformat,A=a.format,m=a.type,w=a.width,T=a.height;u(a),c?t.texImage2D(l,h,A,A,m,c):a.compressed?t.compressedTexImage2D(l,h,g,Math.max(1,w),Math.max(1,T),0,f):a.needsCopy?(i(),t.copyTexImage2D(l,h,A,a.xOffset,a.yOffset,w,T,0)):t.texImage2D(l,h,A,w,T,0,A,m,f||null)}}function O(){var t=ge.pop()||new M;l.call(t);for(var e=t.mipmask=0;16>e;++e)t.images[e]=null;return t}function N(t){for(var e=t.images,n=0;n<e.length;++n)e[n]&&T(e[n]),e[n]=null;ge.push(t)}function Q(){this.magFilter=this.minFilter=9728,this.wrapT=this.wrapS=33071,this.anisotropic=1,this.genMipmaps=!1,this.mipmapHint=4352}function Y(t,e){"min"in e&&(t.minFilter=st[e.min],0<=ve.indexOf(t.minFilter)&&!("faces"in e)&&(t.genMipmaps=!0)),"mag"in e&&(t.magFilter=ot[e.mag]);var n=t.wrapS,i=t.wrapT;if("wrap"in e){var o=e.wrap;"string"==typeof o?n=i=rt[o]:Array.isArray(o)&&(n=rt[o[0]],i=rt[o[1]])}else"wrapS"in e&&(n=rt[e.wrapS]),"wrapT"in e&&(i=rt[e.wrapT]);if(t.wrapS=n,t.wrapT=i,"anisotropic"in e&&(t.anisotropic=e.anisotropic),"mipmap"in e){switch(n=!1,typeof e.mipmap){case"string":t.mipmapHint=it[e.mipmap],n=t.genMipmaps=!0;break;case"boolean":n=t.genMipmaps=e.mipmap;break;case"object":t.genMipmaps=!1,n=!0}!n||"min"in e||(t.minFilter=9984)}}function K(n,i){t.texParameteri(i,10241,n.minFilter),t.texParameteri(i,10240,n.magFilter),t.texParameteri(i,10242,n.wrapS),t.texParameteri(i,10243,n.wrapT),e.ext_texture_filter_anisotropic&&t.texParameteri(i,34046,n.anisotropic),n.genMipmaps&&(t.hint(33170,n.mipmapHint),t.generateMipmap(i))}function $(e){l.call(this),this.mipmask=0,this.internalformat=6408,this.id=pe++,this.refCount=1,this.target=e,this.texture=t.createTexture(),this.unit=-1,this.bindCount=0,this.texInfo=new Q,a.profile&&(this.stats={size:0})}function tt(e){t.activeTexture(33984),t.bindTexture(e.target,e.texture)}function et(){var e=ye[0];e?t.bindTexture(e.target,e.texture):t.bindTexture(3553,null)}function nt(e){var n=e.texture,i=e.unit,o=e.target;0<=i&&(t.activeTexture(33984+i),t.bindTexture(o,null),ye[i]=null),t.deleteTexture(n),e.texture=null,e.params=null,e.pixels=null,e.refCount=0,delete Ae[e.id],s.textureCount--}var it={"don't care":4352,"dont care":4352,nice:4354,fast:4353},rt={repeat:10497,clamp:33071,mirror:33648},ot={nearest:9728,linear:9729},st=bt({mipmap:9987,"nearest mipmap nearest":9984,"linear mipmap nearest":9985,"nearest mipmap linear":9986,"linear mipmap linear":9987},ot),at={none:0,browser:37444},ut={uint8:5121,rgba4:32819,rgb565:33635,"rgb5 a1":32820},ft={alpha:6406,luminance:6409,"luminance alpha":6410,rgb:6407,rgba:6408,rgba4:32854,"rgb5 a1":32855,rgb565:36194},gt={};e.ext_srgb&&(ft.srgb=35904,ft.srgba=35906),e.oes_texture_float&&(ut.float32=ut.float=5126),e.oes_texture_half_float&&(ut.float16=ut["half float"]=36193),e.webgl_depth_texture&&(bt(ft,{depth:6402,"depth stencil":34041}),bt(ut,{uint16:5123,uint32:5125,"depth stencil":34042})),e.webgl_compressed_texture_s3tc&&bt(gt,{"rgb s3tc dxt1":33776,"rgba s3tc dxt1":33777,"rgba s3tc dxt3":33778,"rgba s3tc dxt5":33779}),e.webgl_compressed_texture_atc&&bt(gt,{"rgb atc":35986,"rgba atc explicit alpha":35987,"rgba atc interpolated alpha":34798}),e.webgl_compressed_texture_pvrtc&&bt(gt,{"rgb pvrtc 4bppv1":35840,"rgb pvrtc 2bppv1":35841,"rgba pvrtc 4bppv1":35842,"rgba pvrtc 2bppv1":35843}),e.webgl_compressed_texture_etc1&&(gt["rgb etc1"]=36196);var vt=Array.prototype.slice.call(t.getParameter(34467));Object.keys(gt).forEach((function(t){var e=gt[t];0<=vt.indexOf(e)&&(ft[t]=e)}));var xt=Object.keys(ft);n.textureFormats=xt;var Ct=[];Object.keys(ft).forEach((function(t){Ct[ft[t]]=t}));var Ot=[];Object.keys(ut).forEach((function(t){Ot[ut[t]]=t}));var Gt=[];Object.keys(ot).forEach((function(t){Gt[ot[t]]=t}));var $t=[];Object.keys(st).forEach((function(t){$t[st[t]]=t}));var re=[];Object.keys(rt).forEach((function(t){re[rt[t]]=t}));var ue=xt.reduce((function(t,n){var i=ft[n];return t[i]=6409===i||6406===i||6409===i||6410===i||6402===i||34041===i||e.ext_srgb&&(35904===i||35906===i)?i:32855===i||0<=n.indexOf("rgba")?6408:6407,t}),{}),fe=[],ge=[],pe=0,Ae={},me=n.maxTextureUnits,ye=Array(me).map((function(){return null}));return bt($.prototype,{bind:function(){this.bindCount+=1;var e=this.unit;if(0>e){for(var n=0;n<me;++n){var i=ye[n];if(i){if(0<i.bindCount)continue;i.unit=-1}ye[n]=this,e=n;break}a.profile&&s.maxTextureUnits<e+1&&(s.maxTextureUnits=e+1),this.unit=e,t.activeTexture(33984+e),t.bindTexture(this.target,this.texture)}return e},unbind:function(){--this.bindCount},decRef:function(){0>=--this.refCount&&nt(this)}}),a.profile&&(s.getTotalTextureSize=function(){var t=0;return Object.keys(Ae).forEach((function(e){t+=Ae[e].stats.size})),t}),{create2D:function(e,n){function i(e,n){var s=o.texInfo;Q.call(s),s.version=t instanceof WebGL2RenderingContext?2:1;var l=O();return"number"==typeof e?C(l,0|e,"number"==typeof n?0|n:0|e):e?(Y(s,e),P(l,e)):C(l,1,1),s.genMipmaps&&(l.mipmask=(Math.max(l.width,l.height)<<1)-1),o.mipmask=l.mipmask,h(o,l),o.internalformat=l.internalformat,i.width=l.width,i.height=l.height,tt(o),I(l,3553),K(s,3553),et(),N(l),a.profile&&(o.stats.size=J(o.internalformat,o.type,l.width,l.height,s.genMipmaps,!1)),i.format=Ct[o.internalformat],i.type=Ot[o.type],i.mag=Gt[s.magFilter],i.min=$t[s.minFilter],i.wrapS=re[s.wrapS],i.wrapT=re[s.wrapT],i}var o=new $(3553);return Ae[o.id]=o,s.textureCount++,i(e,n),i.subimage=function(t,e,n,s){e|=0,n|=0,s|=0;var a=w();return h(a,o),a.width=0,a.height=0,g(a,t),a.width=a.width||(o.width>>s)-e,a.height=a.height||(o.height>>s)-n,tt(o),A(a,3553,e,n,s),et(),T(a),i},i.resize=function(e,n){var s=0|e,l=0|n||s;if(s===o.width&&l===o.height)return i;i.width=o.width=s,i.height=o.height=l,tt(o);for(var h=0;o.mipmask>>h;++h){var c=s>>h,u=l>>h;if(!c||!u)break;t.texImage2D(3553,h,o.format,c,u,0,o.format,o.type,null)}return et(),a.profile&&(o.stats.size=J(o.internalformat,o.type,s,l,!1,!1)),i},i._reglType="texture2d",i._texture=o,a.profile&&(i.stats=o.stats),i.destroy=function(){o.decRef()},i},createCube:function(e,n,i,o,l,u){function f(t,e,n,i,o,s){var l,u=m.texInfo;for(Q.call(u),l=0;6>l;++l)M[l]=O();if("number"!=typeof t&&t){if("object"==typeof t)if(e)P(M[0],t),P(M[1],e),P(M[2],n),P(M[3],i),P(M[4],o),P(M[5],s);else if(Y(u,t),c(m,t),"faces"in t)for(t=t.faces,l=0;6>l;++l)h(M[l],m),P(M[l],t[l]);else for(l=0;6>l;++l)P(M[l],t)}else for(t=0|t||1,l=0;6>l;++l)C(M[l],t,t);for(h(m,M[0]),m.mipmask=u.genMipmaps?(Math.max(M[0].width,M[0].height)<<1)-1:M[0].mipmask,m.internalformat=M[0].internalformat,f.width=M[0].width,f.height=M[0].height,tt(m),l=0;6>l;++l)I(M[l],34069+l);for(K(u,34067),et(),a.profile&&(m.stats.size=J(m.internalformat,m.type,f.width,f.height,u.genMipmaps,!0)),f.format=Ct[m.internalformat],f.type=Ot[m.type],f.mag=Gt[u.magFilter],f.min=$t[u.minFilter],f.wrapS=re[u.wrapS],f.wrapT=re[u.wrapT],l=0;6>l;++l)N(M[l]);return f}var m=new $(34067);Ae[m.id]=m,s.cubeCount++;var M=Array(6);return f(e,n,i,o,l,u),f.subimage=function(t,e,n,i,o){n|=0,i|=0,o|=0;var s=w();return h(s,m),s.width=0,s.height=0,g(s,e),s.width=s.width||(m.width>>o)-n,s.height=s.height||(m.height>>o)-i,tt(m),A(s,34069+t,n,i,o),et(),T(s),f},f.resize=function(e){if((e|=0)!==m.width){f.width=m.width=e,f.height=m.height=e,tt(m);for(var n=0;6>n;++n)for(var i=0;m.mipmask>>i;++i)t.texImage2D(34069+n,i,m.format,e>>i,e>>i,0,m.format,m.type,null);return et(),a.profile&&(m.stats.size=J(m.internalformat,m.type,f.width,f.height,!1,!0)),f}},f._reglType="textureCube",f._texture=m,a.profile&&(f.stats=m.stats),f.destroy=function(){m.decRef()},f},clear:function(){for(var e=0;e<me;++e)t.activeTexture(33984+e),t.bindTexture(3553,null),ye[e]=null;ae(Ae).forEach(nt),s.cubeCount=0,s.textureCount=0},getTexture:function(t){return null},restore:function(){for(var e=0;e<me;++e){var n=ye[e];n&&(n.bindCount=0,n.unit=-1,ye[e]=null)}ae(Ae).forEach((function(e){e.texture=t.createTexture(),t.bindTexture(e.target,e.texture);for(var n=0;32>n;++n)if(e.mipmask&1<<n)if(3553===e.target)t.texImage2D(3553,n,e.internalformat,e.width>>n,e.height>>n,0,e.internalformat,e.type,null);else for(var i=0;6>i;++i)t.texImage2D(34069+i,n,e.internalformat,e.width>>n,e.height>>n,0,e.internalformat,e.type,null);K(e.texInfo,e.target)}))},refresh:function(){for(var e=0;e<me;++e){var n=ye[e];n&&(n.bindCount=0,n.unit=-1,ye[e]=null),t.activeTexture(33984+e),t.bindTexture(3553,null),t.bindTexture(34067,null)}}}}function Y(t,e,n,i,o,s){function a(t,e,n){this.target=t,this.texture=e,this.renderbuffer=n;var i=t=0;e?(t=e.width,i=e.height):n&&(t=n.width,i=n.height),this.width=t,this.height=i}function l(t){t&&(t.texture&&t.texture._texture.decRef(),t.renderbuffer&&t.renderbuffer._renderbuffer.decRef())}function h(t,e,n){t&&(t.texture?t.texture._texture.refCount+=1:t.renderbuffer._renderbuffer.refCount+=1)}function c(e,n){n&&(n.texture?t.framebufferTexture2D(36160,e,n.target,n.texture._texture.texture,0):t.framebufferRenderbuffer(36160,e,36161,n.renderbuffer._renderbuffer.renderbuffer))}function u(t){var e=3553,n=null,i=null,o=t;return"object"==typeof t&&(o=t.data,"target"in t&&(e=0|t.target)),"texture2d"===(t=o._reglType)||"textureCube"===t?n=o:"renderbuffer"===t&&(i=o,e=36161),new a(e,n,i)}function f(t,e,n,s,l){return n?((t=i.create2D({width:t,height:e,format:s,type:l}))._texture.refCount=0,new a(3553,t,null)):((t=o.create({width:t,height:e,format:s}))._renderbuffer.refCount=0,new a(36161,null,t))}function g(t){return t&&(t.texture||t.renderbuffer)}function A(t,e,n){t&&(t.texture?t.texture.resize(e,n):t.renderbuffer&&t.renderbuffer.resize(e,n),t.width=e,t.height=n)}function m(){this.id=D++,N[this.id]=this,this.framebuffer=t.createFramebuffer(),this.height=this.width=0,this.colorAttachments=[],this.depthStencilAttachment=this.stencilAttachment=this.depthAttachment=null}function w(t){t.colorAttachments.forEach(l),l(t.depthAttachment),l(t.stencilAttachment),l(t.depthStencilAttachment)}function T(e){t.deleteFramebuffer(e.framebuffer),e.framebuffer=null,s.framebufferCount--,delete N[e.id]}function M(e,i){var o;t.bindFramebuffer(36160,e.framebuffer);var s=e.colorAttachments;for(o=0;o<s.length;++o)c(36064+o,s[o]);for(o=s.length;o<n.maxColorAttachments;++o)t.framebufferTexture2D(36160,36064+o,3553,null,0);t.framebufferTexture2D(36160,33306,3553,null,0),t.framebufferTexture2D(36160,36096,3553,null,0),t.framebufferTexture2D(36160,36128,3553,null,0),c(36096,e.depthAttachment),c(36128,e.stencilAttachment),c(33306,e.depthStencilAttachment),i||(t.checkFramebufferStatus(36160),t.isContextLost()),t.bindFramebuffer(36160,P.next?P.next.framebuffer:null),P.cur=P.next,i||t.getError()}function C(e,n){function i(t,e){var n,s=0,a=0,l=!0,c=!0;n=null;var A=!0,m="rgba",T="uint8",C=1,P=null,E=null,D=null,N=!1;if("number"==typeof t)s=0|t,a=0|e||s;else if(t){var H=t;"shape"in H?(s=(a=H.shape)[0],a=a[1]):("radius"in H&&(s=a=H.radius),"width"in H&&(s=H.width),"height"in H&&(a=H.height)),("color"in H||"colors"in H)&&(n=H.color||H.colors),n||("colorCount"in H&&(C=0|H.colorCount),"colorTexture"in H&&(A=!!H.colorTexture,m="rgba4"),"colorType"in H&&(T=H.colorType,!A)&&("half float"===T||"float16"===T?m="rgba16f":"float"!==T&&"float32"!==T||(m="rgba32f")),"colorFormat"in H&&(0<=I.indexOf(m=H.colorFormat)?A=!0:0<=O.indexOf(m)&&(A=!1))),("depthTexture"in H||"depthStencilTexture"in H)&&(N=!(!H.depthTexture&&!H.depthStencilTexture)),"depth"in H&&("boolean"==typeof H.depth?l=H.depth:(P=H.depth,c=!1)),"stencil"in H&&("boolean"==typeof H.stencil?c=H.stencil:(E=H.stencil,l=!1)),"depthStencil"in H&&("boolean"==typeof H.depthStencil?l=c=H.depthStencil:(D=H.depthStencil,c=l=!1))}else s=a=1;var U=null,W=null,q=null,X=null;if(Array.isArray(n))U=n.map(u);else if(n)U=[u(n)];else for(U=Array(C),n=0;n<C;++n)U[n]=f(s,a,A,m,T);for(s=s||U[0].width,a=a||U[0].height,P?W=u(P):l&&!c&&(W=f(s,a,N,"depth","uint32")),E?q=u(E):c&&!l&&(q=f(s,a,!1,"stencil","uint8")),D?X=u(D):!P&&!E&&c&&l&&(X=f(s,a,N,"depth stencil","depth stencil")),l=null,n=0;n<U.length;++n)h(U[n]),U[n]&&U[n].texture&&(c=qe[U[n].texture._texture.format]*Je[U[n].texture._texture.type],null===l&&(l=c));return h(W),h(q),h(X),w(o),o.width=s,o.height=a,o.colorAttachments=U,o.depthAttachment=W,o.stencilAttachment=q,o.depthStencilAttachment=X,i.color=U.map(g),i.depth=g(W),i.stencil=g(q),i.depthStencil=g(X),i.width=o.width,i.height=o.height,M(o,H&&H.ignoreStatusCheck),i}var o=new m;return s.framebufferCount++,i(e,n),bt(i,{resize:function(t,e){var n=Math.max(0|t,1),s=Math.max(0|e||n,1);if(n===o.width&&s===o.height)return i;for(var a=o.colorAttachments,l=0;l<a.length;++l)A(a[l],n,s);return A(o.depthAttachment,n,s),A(o.stencilAttachment,n,s),A(o.depthStencilAttachment,n,s),o.width=i.width=n,o.height=i.height=s,M(o),i},blit:function(e,n,i){t.bindFramebuffer(36008,e._framebuffer.framebuffer),t.bindFramebuffer(36009,o.framebuffer),n||(n=16384),t.blitFramebuffer(0,0,e.width,e.height,0,0,o.width,o.height,n,"linear"===i?9729:9728),t.bindFramebuffer(36008,null),t.bindFramebuffer(36009,null)},_reglType:"framebuffer",_framebuffer:o,destroy:function(){T(o),w(o)},use:function(t){P.setFBO({framebuffer:i},t)}})}var P={cur:null,next:null,dirty:!1,setFBO:null},I=["rgba"],O=["rgba4","rgb565","rgb5 a1"];e.ext_srgb&&O.push("srgba"),e.ext_color_buffer_half_float&&O.push("rgba16f","rgb16f"),e.webgl_color_buffer_float&&O.push("rgba32f");var E=["uint8"];e.oes_texture_half_float&&E.push("half float","float16"),e.oes_texture_float&&E.push("float","float32");var D=0,N={};return bt(P,{getFramebuffer:function(t){return"function"==typeof t&&"framebuffer"===t._reglType&&(t=t._framebuffer)instanceof m?t:null},create:C,createCube:function(t){function e(t){var o,s={color:null},a=0,l=null;o="rgba";var h="uint8",c=1;if("number"==typeof t?a=0|t:t?("shape"in t?a=t.shape[0]:("radius"in t&&(a=0|t.radius),"width"in t?a=0|t.width:"height"in t&&(a=0|t.height)),("color"in t||"colors"in t)&&(l=t.color||t.colors),l||("colorCount"in t&&(c=0|t.colorCount),"colorType"in t&&(h=t.colorType),"colorFormat"in t&&(o=t.colorFormat)),"depth"in t&&(s.depth=t.depth),"stencil"in t&&(s.stencil=t.stencil),"depthStencil"in t&&(s.depthStencil=t.depthStencil)):a=1,l)if(Array.isArray(l))for(t=[],o=0;o<l.length;++o)t[o]=l[o];else t=[l];else for(t=Array(c),l={radius:a,format:o,type:h},o=0;o<c;++o)t[o]=i.createCube(l);for(s.color=Array(t.length),o=0;o<t.length;++o)c=t[o],a=a||c.width,s.color[o]={target:34069,data:t[o]};for(o=0;6>o;++o){for(c=0;c<t.length;++c)s.color[c].target=34069+o;0<o&&(s.depth=n[0].depth,s.stencil=n[0].stencil,s.depthStencil=n[0].depthStencil),n[o]?n[o](s):n[o]=C(s)}return bt(e,{width:a,height:a,color:t})}var n=Array(6);return e(t),bt(e,{faces:n,resize:function(t){var i=0|t;if(i===e.width)return e;var o=e.color;for(t=0;t<o.length;++t)o[t].resize(i);for(t=0;6>t;++t)n[t].resize(i);return e.width=e.height=i,e},_reglType:"framebufferCube",destroy:function(){n.forEach((function(t){t.destroy()}))}})},clear:function(){ae(N).forEach(T)},restore:function(){P.cur=null,P.next=null,P.dirty=!0,ae(N).forEach((function(e){e.framebuffer=t.createFramebuffer(),M(e)}))}})}function K(){this.w=this.z=this.y=this.x=this.state=0,this.buffer=null,this.size=0,this.normalized=!1,this.type=5126,this.divisor=this.stride=this.offset=0}function $(t,e,n,i,o,s,a){function l(t){if(t!==M.currentVAO){var n=e.oes_vertex_array_object;n.bindVertexArrayOES(t?t.vao:null),M.currentVAO=t}}function h(n){if(n!==M.currentVAO){if(n)n.bindAttrs();else{for(var i=e.angle_instanced_arrays,o=0;o<A.length;++o){var s=A[o];s.buffer?(t.enableVertexAttribArray(o),s.buffer.bind(),t.vertexAttribPointer(o,s.size,s.type,s.normalized,s.stride,s.offfset),i&&s.divisor&&i.vertexAttribDivisorANGLE(o,s.divisor)):(t.disableVertexAttribArray(o),t.vertexAttrib4f(o,s.x,s.y,s.z,s.w))}t.bindBuffer(34963,a.elements?a.elements.buffer.buffer:null)}M.currentVAO=n}}function c(){ae(T).forEach((function(t){t.destroy()}))}function u(){this.id=++w,this.attributes=[],this.elements=null,this.ownsElements=!1,this.offset=this.count=0,this.instances=-1,this.primitive=4;var t=e.oes_vertex_array_object;this.vao=t?t.createVertexArrayOES():null,T[this.id]=this,this.buffers=[]}function f(){e.oes_vertex_array_object&&ae(T).forEach((function(t){t.refresh()}))}var g=n.maxAttributes,A=Array(g);for(n=0;n<g;++n)A[n]=new K;var w=0,T={},M={Record:K,scope:{},state:A,currentVAO:null,targetVAO:null,restore:e.oes_vertex_array_object?f:function(){},createVAO:function(t){function e(t){var i;Array.isArray(t)?(i=t,n.elements&&n.ownsElements&&n.elements.destroy(),n.elements=null,n.ownsElements=!1,n.offset=0,n.count=0,n.instances=-1,n.primitive=4):(t.elements?(i=t.elements,n.ownsElements?("function"==typeof i&&"elements"===i._reglType?n.elements.destroy():n.elements(i),n.ownsElements=!1):s.getElements(t.elements)?(n.elements=t.elements,n.ownsElements=!1):(n.elements=s.create(t.elements),n.ownsElements=!0)):(n.elements=null,n.ownsElements=!1),i=t.attributes,n.offset=0,n.count=-1,n.instances=-1,n.primitive=4,n.elements&&(n.count=n.elements._elements.vertCount,n.primitive=n.elements._elements.primType),"offset"in t&&(n.offset=0|t.offset),"count"in t&&(n.count=0|t.count),"instances"in t&&(n.instances=0|t.instances),"primitive"in t&&(n.primitive=me[t.primitive])),t={};var a=n.attributes;a.length=i.length;for(var l=0;l<i.length;++l){var h,c=i[l],u=a[l]=new K,f=c.data||c;Array.isArray(f)||oe(f)||m(f)?(n.buffers[l]&&(h=n.buffers[l],oe(f)&&h._buffer.byteLength>=f.byteLength?h.subdata(f):(h.destroy(),n.buffers[l]=null)),n.buffers[l]||(h=n.buffers[l]=o.create(c,34962,!1,!0)),u.buffer=o.getBuffer(h),u.size=0|u.buffer.dimension,u.normalized=!1,u.type=u.buffer.dtype,u.offset=0,u.stride=0,u.divisor=0,u.state=1,t[l]=1):o.getBuffer(c)?(u.buffer=o.getBuffer(c),u.size=0|u.buffer.dimension,u.normalized=!1,u.type=u.buffer.dtype,u.offset=0,u.stride=0,u.divisor=0,u.state=1):o.getBuffer(c.buffer)?(u.buffer=o.getBuffer(c.buffer),u.size=0|(+c.size||u.buffer.dimension),u.normalized=!!c.normalized||!1,u.type="type"in c?ue[c.type]:u.buffer.dtype,u.offset=0|(c.offset||0),u.stride=0|(c.stride||0),u.divisor=0|(c.divisor||0),u.state=1):"x"in c&&(u.x=+c.x||0,u.y=+c.y||0,u.z=+c.z||0,u.w=+c.w||0,u.state=2)}for(h=0;h<n.buffers.length;++h)!t[h]&&n.buffers[h]&&(n.buffers[h].destroy(),n.buffers[h]=null);return n.refresh(),e}var n=new u;return i.vaoCount+=1,e.destroy=function(){for(var t=0;t<n.buffers.length;++t)n.buffers[t]&&n.buffers[t].destroy();n.buffers.length=0,n.ownsElements&&(n.elements.destroy(),n.elements=null,n.ownsElements=!1),n.destroy()},e._vao=n,e._reglType="vao",e(t)},getVAO:function(t){return"function"==typeof t&&t._vao?t._vao:null},destroyBuffer:function(e){for(var n=0;n<A.length;++n){var i=A[n];i.buffer===e&&(t.disableVertexAttribArray(n),i.buffer=null)}},setVAO:e.oes_vertex_array_object?l:h,clear:e.oes_vertex_array_object?c:function(){}};return u.prototype.bindAttrs=function(){for(var n=e.angle_instanced_arrays,i=this.attributes,o=0;o<i.length;++o){var a=i[o];a.buffer?(t.enableVertexAttribArray(o),t.bindBuffer(34962,a.buffer.buffer),t.vertexAttribPointer(o,a.size,a.type,a.normalized,a.stride,a.offset),n&&a.divisor&&n.vertexAttribDivisorANGLE(o,a.divisor)):(t.disableVertexAttribArray(o),t.vertexAttrib4f(o,a.x,a.y,a.z,a.w))}for(n=i.length;n<g;++n)t.disableVertexAttribArray(n);(n=s.getElements(this.elements))?t.bindBuffer(34963,n.buffer.buffer):t.bindBuffer(34963,null)},u.prototype.refresh=function(){var t=e.oes_vertex_array_object;t&&(t.bindVertexArrayOES(this.vao),this.bindAttrs(),M.currentVAO=null,t.bindVertexArrayOES(null))},u.prototype.destroy=function(){if(this.vao){var t=e.oes_vertex_array_object;this===M.currentVAO&&(M.currentVAO=null,t.bindVertexArrayOES(null)),t.deleteVertexArrayOES(this.vao),this.vao=null}this.ownsElements&&(this.elements.destroy(),this.elements=null,this.ownsElements=!1),T[this.id]&&(delete T[this.id],--i.vaoCount)},M}function tt(t,e,n,i){function o(t,e,n,i){this.name=t,this.id=e,this.location=n,this.info=i}function s(t,e){for(var n=0;n<t.length;++n)if(t[n].id===e.id)return void(t[n].location=e.location);t.push(e)}function a(n,i,o){if(!(a=(o=35632===n?c:u)[i])){var s=e.str(i),a=t.createShader(n);t.shaderSource(a,s),t.compileShader(a),o[i]=a}return a}function l(t,e){this.id=A++,this.fragId=t,this.vertId=e,this.program=null,this.uniforms=[],this.attributes=[],this.refCount=1,i.profile&&(this.stats={uniformsCount:0,attributesCount:0})}function h(n,l,h){var c;c=a(35632,n.fragId);var u=a(35633,n.vertId);if(l=n.program=t.createProgram(),t.attachShader(l,c),t.attachShader(l,u),h)for(c=0;c<h.length;++c)t.bindAttribLocation(l,(u=h[c])[0],u[1]);t.linkProgram(l),u=t.getProgramParameter(l,35718),i.profile&&(n.stats.uniformsCount=u);var f=n.uniforms;for(c=0;c<u;++c)if(h=t.getActiveUniform(l,c)){if(1<h.size)for(var g=0;g<h.size;++g){var A=h.name.replace("[0]","["+g+"]");s(f,new o(A,e.id(A),t.getUniformLocation(l,A),h))}g=h.name,1<h.size&&(g=g.replace("[0]","")),s(f,new o(g,e.id(g),t.getUniformLocation(l,g),h))}for(u=t.getProgramParameter(l,35721),i.profile&&(n.stats.attributesCount=u),n=n.attributes,c=0;c<u;++c)(h=t.getActiveAttrib(l,c))&&s(n,new o(h.name,e.id(h.name),t.getAttribLocation(l,h.name),h))}var c={},u={},f={},g=[],A=0;return i.profile&&(n.getMaxUniformsCount=function(){var t=0;return g.forEach((function(e){e.stats.uniformsCount>t&&(t=e.stats.uniformsCount)})),t},n.getMaxAttributesCount=function(){var t=0;return g.forEach((function(e){e.stats.attributesCount>t&&(t=e.stats.attributesCount)})),t}),{clear:function(){var e=t.deleteShader.bind(t);ae(c).forEach(e),c={},ae(u).forEach(e),u={},g.forEach((function(e){t.deleteProgram(e.program)})),g.length=0,f={},n.shaderCount=0},program:function(e,i,o,s){var a=f[i];a||(a=f[i]={});var A=a[e];if(A&&(A.refCount++,!s))return A;var m=new l(i,e);return n.shaderCount++,h(m,o,s),A||(a[e]=m),g.push(m),bt(m,{destroy:function(){if(m.refCount--,0>=m.refCount){t.deleteProgram(m.program);var e=g.indexOf(m);g.splice(e,1),n.shaderCount--}0>=a[m.vertId].refCount&&(t.deleteShader(u[m.vertId]),delete u[m.vertId],delete f[m.fragId][m.vertId]),Object.keys(f[m.fragId]).length||(t.deleteShader(c[m.fragId]),delete c[m.fragId],delete f[m.fragId])}})},restore:function(){c={},u={};for(var t=0;t<g.length;++t)h(g[t],null,g[t].attributes.map((function(t){return[t.location,t.name]})))},shader:a,frag:-1,vert:-1}}function et(t,e,n,i,o,s,a){function l(o){var s;s=null===e.next?5121:e.next.colorAttachments[0].texture._texture.type;var a=0,l=0,h=i.framebufferWidth,c=i.framebufferHeight,u=null;return oe(o)?u=o:o&&(a=0|o.x,l=0|o.y,h=0|(o.width||i.framebufferWidth-a),c=0|(o.height||i.framebufferHeight-l),u=o.data||null),n(),o=h*c*4,u||(5121===s?u=new Uint8Array(o):5126===s&&(u=u||new Float32Array(o))),t.pixelStorei(3333,4),t.readPixels(a,l,h,c,6408,s,u),u}function h(t){var n;return e.setFBO({framebuffer:t.framebuffer},(function(){n=l(t)})),n}return function(t){return t&&"framebuffer"in t?h(t):l(t)}}function nt(t){return Array.prototype.slice.call(t)}function it(t){return nt(t).join("")}function rt(){function t(){var t=[],e=[];return bt((function(){t.push.apply(t,nt(arguments))}),{def:function(){var i="v"+n++;return e.push(i),0<arguments.length&&(t.push(i,"="),t.push.apply(t,nt(arguments)),t.push(";")),i},toString:function(){return it([0<e.length?"var "+e.join(",")+";":"",it(t)])}})}function e(){function e(t,e){i(t,e,"=",n.def(t,e),";")}var n=t(),i=t(),o=n.toString,s=i.toString;return bt((function(){n.apply(n,nt(arguments))}),{def:n.def,entry:n,exit:i,save:e,set:function(t,i,o){e(t,i),n(t,i,"=",o,";")},toString:function(){return o()+s()}})}var n=0,i=[],o=[],s=t(),a={};return{global:s,link:function(t){for(var e=0;e<o.length;++e)if(o[e]===t)return i[e];return e="g"+n++,i.push(e),o.push(t),e},block:t,proc:function(t,n){function i(){var t="a"+o.length;return o.push(t),t}var o=[];n=n||0;for(var s=0;s<n;++s)i();var l=(s=e()).toString;return a[t]=bt(s,{arg:i,toString:function(){return it(["function(",o.join(),"){",l(),"}"])}})},scope:e,cond:function(){var t=it(arguments),n=e(),i=e(),o=n.toString,s=i.toString;return bt(n,{then:function(){return n.apply(n,nt(arguments)),this},else:function(){return i.apply(i,nt(arguments)),this},toString:function(){var e=s();return e&&(e="else{"+e+"}"),it(["if(",t,"){",o(),"}",e])}})},compile:function(){var t=['"use strict";',s,"return {"];Object.keys(a).forEach((function(e){t.push('"',e,'":',a[e].toString(),",")})),t.push("}");var e=it(t).replace(/;/g,";\n").replace(/}/g,"}\n").replace(/{/g,"{\n");return Function.apply(null,i.concat(e)).apply(null,o)}}}function ot(t){return Array.isArray(t)||oe(t)||m(t)}function st(t){return t.sort((function(t,e){return"viewport"===t?-1:"viewport"===e?1:t<e?-1:1}))}function at(t,e,n,i){this.thisDep=t,this.contextDep=e,this.propDep=n,this.append=i}function ut(t){return t&&!(t.thisDep||t.contextDep||t.propDep)}function ft(t){return new at(!1,!1,!1,t)}function gt(t,e){var n=t.type;if(0===n)return new at(!0,1<=(n=t.data.length),2<=n,e);if(4===n)return new at((n=t.data).thisDep,n.contextDep,n.propDep,e);if(5===n)return new at(!1,!1,!1,e);if(6===n){for(var i=n=!1,o=!1,s=0;s<t.data.length;++s){var a=t.data[s];1===a.type?o=!0:2===a.type?i=!0:3===a.type?n=!0:0===a.type?(n=!0,1<=(a=a.data)&&(i=!0),2<=a&&(o=!0)):4===a.type&&(n=n||a.data.thisDep,i=i||a.data.contextDep,o=o||a.data.propDep)}return new at(n,i,o,e)}return new at(3===n,2===n,1===n,e)}function vt(t,e,n,i,o,s,a,l,h,c,u,g,A,m,w){function T(t){return t.replace(".","_")}function M(t,e,n){var i=T(t);xe.push(t),ve[i]=_e[i]=!!n,be[i]=e}function C(t,e,n){var i=T(t);xe.push(t),Array.isArray(n)?(_e[i]=n.slice(),ve[i]=n.slice()):_e[i]=ve[i]=n,we[i]=e}function P(){var t=rt(),n=t.link,i=t.global;t.id=ke++,t.batchId="0";var o=n(Me),s=t.shared={props:"a0"};Object.keys(Me).forEach((function(t){s[t]=i.def(o,".",t)}));var a=t.next={},l=t.current={};Object.keys(we).forEach((function(t){Array.isArray(_e[t])&&(a[t]=i.def(s.next,".",t),l[t]=i.def(s.current,".",t))}));var h=t.constants={};Object.keys(Ee).forEach((function(t){h[t]=i.def(JSON.stringify(Ee[t]))})),t.invoke=function(e,i){switch(i.type){case 0:var o=["this",s.context,s.props,t.batchId];return e.def(n(i.data),".call(",o.slice(0,Math.max(i.data.length+1,4)),")");case 1:return e.def(s.props,i.data);case 2:return e.def(s.context,i.data);case 3:return e.def("this",i.data);case 4:return i.data.append(t,e),i.data.ref;case 5:return i.data.toString();case 6:return i.data.map((function(n){return t.invoke(e,n)}))}},t.attribCache={};var u={};return t.scopeAttrib=function(t){if((t=e.id(t))in u)return u[t];var i=c.scope[t];return i||(i=c.scope[t]=new fe),u[t]=n(i)},t}function I(t){var e,n=t.static;if(t=t.dynamic,"profile"in n){var i=!!n.profile;(e=ft((function(t,e){return i}))).enable=i}else if("profile"in t){var o=t.profile;e=gt(o,(function(t,e){return t.invoke(e,o)}))}return e}function O(t,e){var n=t.static,i=t.dynamic;if("framebuffer"in n){var o=n.framebuffer;return o?(o=l.getFramebuffer(o),ft((function(t,e){var n=t.link(o),i=t.shared;return e.set(i.framebuffer,".next",n),e.set(i=i.context,".framebufferWidth",n+".width"),e.set(i,".framebufferHeight",n+".height"),n}))):ft((function(t,e){var n=t.shared;return e.set(n.framebuffer,".next","null"),e.set(n=n.context,".framebufferWidth",n+".drawingBufferWidth"),e.set(n,".framebufferHeight",n+".drawingBufferHeight"),"null"}))}if("framebuffer"in i){var s=i.framebuffer;return gt(s,(function(t,e){var n=t.invoke(e,s),i=t.shared,o=i.framebuffer;return n=e.def(o,".getFramebuffer(",n,")"),e.set(o,".next",n),e.set(i=i.context,".framebufferWidth",n+"?"+n+".width:"+i+".drawingBufferWidth"),e.set(i,".framebufferHeight",n+"?"+n+".height:"+i+".drawingBufferHeight"),n}))}return null}function E(t,e,n){function i(t){if(t in o){var n=o[t];t=!0;var i,a,l=0|n.x,h=0|n.y;return"width"in n?i=0|n.width:t=!1,"height"in n?a=0|n.height:t=!1,new at(!t&&e&&e.thisDep,!t&&e&&e.contextDep,!t&&e&&e.propDep,(function(t,e){var o=t.shared.context,s=i;"width"in n||(s=e.def(o,".","framebufferWidth","-",l));var c=a;return"height"in n||(c=e.def(o,".","framebufferHeight","-",h)),[l,h,s,c]}))}if(t in s){var c=s[t];return t=gt(c,(function(t,e){var n=t.invoke(e,c),i=t.shared.context,o=e.def(n,".x|0"),s=e.def(n,".y|0");return[o,s,e.def('"width" in ',n,"?",n,".width|0:","(",i,".","framebufferWidth","-",o,")"),n=e.def('"height" in ',n,"?",n,".height|0:","(",i,".","framebufferHeight","-",s,")")]})),e&&(t.thisDep=t.thisDep||e.thisDep,t.contextDep=t.contextDep||e.contextDep,t.propDep=t.propDep||e.propDep),t}return e?new at(e.thisDep,e.contextDep,e.propDep,(function(t,e){var n=t.shared.context;return[0,0,e.def(n,".","framebufferWidth"),e.def(n,".","framebufferHeight")]})):null}var o=t.static,s=t.dynamic;if(t=i("viewport")){var a=t;t=new at(t.thisDep,t.contextDep,t.propDep,(function(t,e){var n=a.append(t,e),i=t.shared.context;return e.set(i,".viewportWidth",n[2]),e.set(i,".viewportHeight",n[3]),n}))}return{viewport:t,scissor_box:i("scissor.box")}}function N(t,e){if("string"==typeof(n=t.static).frag&&"string"==typeof n.vert){if(0<Object.keys(e.dynamic).length)return null;var n=e.static,i=Object.keys(n);if(0<i.length&&"number"==typeof n[i[0]]){for(var o=[],s=0;s<i.length;++s)o.push([0|n[i[s]],i[s]]);return o}}return null}function H(t,n,i){function o(t){if(t in s){var n=e.id(s[t]);return(t=ft((function(){return n}))).id=n,t}if(t in a){var i=a[t];return gt(i,(function(t,e){var n=t.invoke(e,i);return e.def(t.shared.strings,".id(",n,")")}))}return null}var s=t.static,a=t.dynamic,l=o("frag"),h=o("vert"),c=null;return ut(l)&&ut(h)?(c=u.program(h.id,l.id,null,i),t=ft((function(t,e){return t.link(c)}))):t=new at(l&&l.thisDep||h&&h.thisDep,l&&l.contextDep||h&&h.contextDep,l&&l.propDep||h&&h.propDep,(function(t,e){var n,i,o=t.shared.shader;return n=l?l.append(t,e):e.def(o,".","frag"),i=h?h.append(t,e):e.def(o,".","vert"),e.def(o+".program("+i+","+n+")")})),{frag:l,vert:h,progVar:t,program:c}}function U(t,e){function n(t,e){if(t in i){var n=0|i[t];return e?a.offset=n:a.instances=n,ft((function(t,i){return e&&(t.OFFSET=n),n}))}if(t in o){var s=o[t];return gt(s,(function(t,n){var i=t.invoke(n,s);return e&&(t.OFFSET=i),i}))}if(e){if(u)return ft((function(t,e){return t.OFFSET=0}));if(l)return new at(h.thisDep,h.contextDep,h.propDep,(function(t,e){return e.def(t.shared.vao+".currentVAO?"+t.shared.vao+".currentVAO.offset:0")}))}else if(l)return new at(h.thisDep,h.contextDep,h.propDep,(function(t,e){return e.def(t.shared.vao+".currentVAO?"+t.shared.vao+".currentVAO.instances:-1")}));return null}var i=t.static,o=t.dynamic,a={},l=!1,h=function(){if("vao"in i){var t=i.vao;return null!==t&&null===c.getVAO(t)&&(t=c.createVAO(t)),l=!0,a.vao=t,ft((function(e){var n=c.getVAO(t);return n?e.link(n):"null"}))}if("vao"in o){l=!0;var e=o.vao;return gt(e,(function(t,n){var i=t.invoke(n,e);return n.def(t.shared.vao+".getVAO("+i+")")}))}return null}(),u=!1,f=function(){if("elements"in i){if(a.elements=e=i.elements,ot(e)){var t=a.elements=s.create(e,!0),e=s.getElements(t);u=!0}else e&&(e=s.getElements(e),u=!0);return t=ft((function(t,n){if(e){var i=t.link(e);return t.ELEMENTS=i}return t.ELEMENTS=null})),t.value=e,t}if("elements"in o){u=!0;var n=o.elements;return gt(n,(function(t,e){var i=(o=t.shared).isBufferArgs,o=o.elements,s=t.invoke(e,n),a=e.def("null");return i=e.def(i,"(",s,")"),s=t.cond(i).then(a,"=",o,".createStream(",s,");").else(a,"=",o,".getElements(",s,");"),e.entry(s),e.exit(t.cond(i).then(o,".destroyStream(",a,");")),t.ELEMENTS=a}))}return l?new at(h.thisDep,h.contextDep,h.propDep,(function(t,e){return e.def(t.shared.vao+".currentVAO?"+t.shared.elements+".getElements("+t.shared.vao+".currentVAO.elements):null")})):null}(),g=n("offset",!0),A=function(){if("primitive"in i){var t=i.primitive;return a.primitive=t,ft((function(e,n){return me[t]}))}if("primitive"in o){var e=o.primitive;return gt(e,(function(t,n){var i=t.constants.primTypes,o=t.invoke(n,e);return n.def(i,"[",o,"]")}))}return u?ut(f)?ft(f.value?function(t,e){return e.def(t.ELEMENTS,".primType")}:function(){return 4}):new at(f.thisDep,f.contextDep,f.propDep,(function(t,e){var n=t.ELEMENTS;return e.def(n,"?",n,".primType:",4)})):l?new at(h.thisDep,h.contextDep,h.propDep,(function(t,e){return e.def(t.shared.vao+".currentVAO?"+t.shared.vao+".currentVAO.primitive:4")})):null}(),m=function(){if("count"in i){var t=0|i.count;return a.count=t,ft((function(){return t}))}if("count"in o){var e=o.count;return gt(e,(function(t,n){return t.invoke(n,e)}))}return u?ut(f)?f?g?new at(g.thisDep,g.contextDep,g.propDep,(function(t,e){return e.def(t.ELEMENTS,".vertCount-",t.OFFSET)})):ft((function(t,e){return e.def(t.ELEMENTS,".vertCount")})):ft((function(){return-1})):new at(f.thisDep||g.thisDep,f.contextDep||g.contextDep,f.propDep||g.propDep,(function(t,e){var n=t.ELEMENTS;return t.OFFSET?e.def(n,"?",n,".vertCount-",t.OFFSET,":-1"):e.def(n,"?",n,".vertCount:-1")})):l?new at(h.thisDep,h.contextDep,h.propDep,(function(t,e){return e.def(t.shared.vao,".currentVAO?",t.shared.vao,".currentVAO.count:-1")})):null}(),w=n("instances",!1);return{elements:f,primitive:A,count:m,instances:w,offset:g,vao:h,vaoActive:l,elementsActive:u,static:a}}function W(t,e){var n=t.static,i=t.dynamic,o={};return xe.forEach((function(t){function e(e,a){if(t in n){var l=e(n[t]);o[s]=ft((function(){return l}))}else if(t in i){var h=i[t];o[s]=gt(h,(function(t,e){return a(t,e,t.invoke(e,h))}))}}var s=T(t);switch(t){case"cull.enable":case"blend.enable":case"dither":case"stencil.enable":case"depth.enable":case"scissor.enable":case"polygonOffset.enable":case"sample.alpha":case"sample.enable":case"depth.mask":case"lineWidth":return e((function(t){return t}),(function(t,e,n){return n}));case"depth.func":return e((function(t){return tn[t]}),(function(t,e,n){return e.def(t.constants.compareFuncs,"[",n,"]")}));case"depth.range":return e((function(t){return t}),(function(t,e,n){return[e.def("+",n,"[0]"),e=e.def("+",n,"[1]")]}));case"blend.func":return e((function(t){return[Ke["srcRGB"in t?t.srcRGB:t.src],Ke["dstRGB"in t?t.dstRGB:t.dst],Ke["srcAlpha"in t?t.srcAlpha:t.src],Ke["dstAlpha"in t?t.dstAlpha:t.dst]]}),(function(t,e,n){function i(t,i){return e.def('"',t,i,'" in ',n,"?",n,".",t,i,":",n,".",t)}t=t.constants.blendFuncs;var o=i("src","RGB"),s=i("dst","RGB"),a=(o=e.def(t,"[",o,"]"),e.def(t,"[",i("src","Alpha"),"]"));return[o,s=e.def(t,"[",s,"]"),a,t=e.def(t,"[",i("dst","Alpha"),"]")]}));case"blend.equation":return e((function(t){return"string"==typeof t?[ge[t],ge[t]]:"object"==typeof t?[ge[t.rgb],ge[t.alpha]]:void 0}),(function(t,e,n){var i=t.constants.blendEquations,o=e.def(),s=e.def();return(t=t.cond("typeof ",n,'==="string"')).then(o,"=",s,"=",i,"[",n,"];"),t.else(o,"=",i,"[",n,".rgb];",s,"=",i,"[",n,".alpha];"),e(t),[o,s]}));case"blend.color":return e((function(t){return f(4,(function(e){return+t[e]}))}),(function(t,e,n){return f(4,(function(t){return e.def("+",n,"[",t,"]")}))}));case"stencil.mask":return e((function(t){return 0|t}),(function(t,e,n){return e.def(n,"|0")}));case"stencil.func":return e((function(t){return[tn[t.cmp||"keep"],t.ref||0,"mask"in t?t.mask:-1]}),(function(t,e,n){return[t=e.def('"cmp" in ',n,"?",t.constants.compareFuncs,"[",n,".cmp]",":",7680),e.def(n,".ref|0"),e=e.def('"mask" in ',n,"?",n,".mask|0:-1")]}));case"stencil.opFront":case"stencil.opBack":return e((function(e){return["stencil.opBack"===t?1029:1028,nn[e.fail||"keep"],nn[e.zfail||"keep"],nn[e.zpass||"keep"]]}),(function(e,n,i){function o(t){return n.def('"',t,'" in ',i,"?",s,"[",i,".",t,"]:",7680)}var s=e.constants.stencilOps;return["stencil.opBack"===t?1029:1028,o("fail"),o("zfail"),o("zpass")]}));case"polygonOffset.offset":return e((function(t){return[0|t.factor,0|t.units]}),(function(t,e,n){return[e.def(n,".factor|0"),e=e.def(n,".units|0")]}));case"cull.face":return e((function(t){var e=0;return"front"===t?e=1028:"back"===t&&(e=1029),e}),(function(t,e,n){return e.def(n,'==="front"?',1028,":",1029)}));case"frontFace":return e((function(t){return rn[t]}),(function(t,e,n){return e.def(n+'==="cw"?2304:2305')}));case"colorMask":return e((function(t){return t.map((function(t){return!!t}))}),(function(t,e,n){return f(4,(function(t){return"!!"+n+"["+t+"]"}))}));case"sample.coverage":return e((function(t){return["value"in t?t.value:1,!!t.invert]}),(function(t,e,n){return[e.def('"value" in ',n,"?+",n,".value:1"),e=e.def("!!",n,".invert")]}))}})),o}function q(t,e){var n=t.static,i=t.dynamic,o={};return Object.keys(n).forEach((function(t){var e,i=n[t];if("number"==typeof i||"boolean"==typeof i)e=ft((function(){return i}));else if("function"==typeof i){var s=i._reglType;"texture2d"===s||"textureCube"===s?e=ft((function(t){return t.link(i)})):"framebuffer"!==s&&"framebufferCube"!==s||(e=ft((function(t){return t.link(i.color[0])})))}else D(i)&&(e=ft((function(t){return t.global.def("[",f(i.length,(function(t){return i[t]})),"]")})));e.value=i,o[t]=e})),Object.keys(i).forEach((function(t){var e=i[t];o[t]=gt(e,(function(t,n){return t.invoke(n,e)}))})),o}function X(t,n){var i=t.static,s=t.dynamic,a={};return Object.keys(i).forEach((function(t){var n=i[t],s=e.id(t),l=new fe;if(ot(n))l.state=1,l.buffer=o.getBuffer(o.create(n,34962,!1,!0)),l.type=0;else if(c=o.getBuffer(n))l.state=1,l.buffer=c,l.type=0;else if("constant"in n){var h=n.constant;l.buffer="null",l.state=2,"number"==typeof h?l.x=h:Qe.forEach((function(t,e){e<h.length&&(l[t]=h[e])}))}else{var c=ot(n.buffer)?o.getBuffer(o.create(n.buffer,34962,!1,!0)):o.getBuffer(n.buffer),u=0|n.offset,f=0|n.stride,g=0|n.size,A=!!n.normalized,m=0;"type"in n&&(m=ue[n.type]),n=0|n.divisor,l.buffer=c,l.state=1,l.size=g,l.normalized=A,l.type=m||c.dtype,l.offset=u,l.stride=f,l.divisor=n}a[t]=ft((function(t,e){var n=t.attribCache;if(s in n)return n[s];var i={isStream:!1};return Object.keys(l).forEach((function(t){i[t]=l[t]})),l.buffer&&(i.buffer=t.link(l.buffer),i.type=i.type||i.buffer+".dtype"),n[s]=i}))})),Object.keys(s).forEach((function(t){var e=s[t];a[t]=gt(e,(function(t,n){function i(t){n(h[t],"=",o,".",t,"|0;")}var o=t.invoke(n,e),s=t.constants,a=(l=t.shared).isBufferArgs,l=l.buffer,h={isStream:n.def(!1)},c=new fe;c.state=1,Object.keys(c).forEach((function(t){h[t]=n.def(""+c[t])}));var u=h.buffer,f=h.type;return n("if(",a,"(",o,")){",h.isStream,"=true;",u,"=",l,".createStream(",34962,",",o,");",f,"=",u,".dtype;","}else{",u,"=",l,".getBuffer(",o,");","if(",u,"){",f,"=",u,".dtype;",'}else if("constant" in ',o,"){",h.state,"=",2,";","if(typeof "+o+'.constant === "number"){',h[Qe[0]],"=",o,".constant;",Qe.slice(1).map((function(t){return h[t]})).join("="),"=0;","}else{",Qe.map((function(t,e){return h[t]+"="+o+".constant.length>"+e+"?"+o+".constant["+e+"]:0;"})).join(""),"}}else{","if(",a,"(",o,".buffer)){",u,"=",l,".createStream(",34962,",",o,".buffer);","}else{",u,"=",l,".getBuffer(",o,".buffer);","}",f,'="type" in ',o,"?",s.glTypes,"[",o,".type]:",u,".dtype;",h.normalized,"=!!",o,".normalized;"),i("size"),i("offset"),i("stride"),i("divisor"),n("}}"),n.exit("if(",h.isStream,"){",l,".destroyStream(",u,");","}"),h}))})),a}function J(t){var e=t.static,n=t.dynamic,i={};return Object.keys(e).forEach((function(t){var n=e[t];i[t]=ft((function(t,e){return"number"==typeof n||"boolean"==typeof n?""+n:t.link(n)}))})),Object.keys(n).forEach((function(t){var e=n[t];i[t]=gt(e,(function(t,n){return t.invoke(n,e)}))})),i}function Q(t,e,i,o,s){function a(t){var e=h[t];e&&(f[t]=e)}var l=N(t,e),h=E(t,A=O(t)),u=U(t),f=W(t),g=H(t,s,l);a("viewport"),a(T("scissor.box"));var A,m=0<Object.keys(f).length;if((A={framebuffer:A,draw:u,shader:g,state:f,dirty:m,scopeVAO:null,drawVAO:null,useVAO:!1,attributes:{}}).profile=I(t),A.uniforms=q(i),A.drawVAO=A.scopeVAO=u.vao,!A.drawVAO&&g.program&&!l&&n.angle_instanced_arrays&&u.static.elements){var w=!0;if(t=g.program.attributes.map((function(t){return t=e.static[t],w=w&&!!t,t})),w&&0<t.length){var M=c.getVAO(c.createVAO({attributes:t,elements:u.static.elements}));A.drawVAO=new at(null,null,null,(function(t,e){return t.link(M)})),A.useVAO=!0}}return l?A.useVAO=!0:A.attributes=X(e),A.context=J(o),A}function Y(t,e,n){var i=t.shared.context,o=t.scope();Object.keys(n).forEach((function(s){e.save(i,"."+s);var a=n[s].append(t,e);Array.isArray(a)?o(i,".",s,"=[",a.join(),"];"):o(i,".",s,"=",a,";")})),e(o)}function K(t,e,n,i){var o,s=(l=t.shared).gl,a=l.framebuffer;Ae&&(o=e.def(l.extensions,".webgl_draw_buffers"));var l=(h=t.constants).drawBuffer,h=h.backBuffer;t=n?n.append(t,e):e.def(a,".next"),i||e("if(",t,"!==",a,".cur){"),e("if(",t,"){",s,".bindFramebuffer(",36160,",",t,".framebuffer);"),Ae&&e(o,".drawBuffersWEBGL(",l,"[",t,".colorAttachments.length]);"),e("}else{",s,".bindFramebuffer(",36160,",null);"),Ae&&e(o,".drawBuffersWEBGL(",h,");"),e("}",a,".cur=",t,";"),i||e("}")}function $(t,e,n){var i=t.shared,o=i.gl,s=t.current,a=t.next,l=i.current,h=i.next,c=t.cond(l,".dirty");xe.forEach((function(e){var i,u;if(!((e=T(e))in n.state))if(e in a){i=a[e],u=s[e];var g=f(_e[e].length,(function(t){return c.def(i,"[",t,"]")}));c(t.cond(g.map((function(t,e){return t+"!=="+u+"["+e+"]"})).join("||")).then(o,".",we[e],"(",g,");",g.map((function(t,e){return u+"["+e+"]="+t})).join(";"),";"))}else i=c.def(h,".",e),g=t.cond(i,"!==",l,".",e),c(g),e in be?g(t.cond(i).then(o,".enable(",be[e],");").else(o,".disable(",be[e],");"),l,".",e,"=",i,";"):g(o,".",we[e],"(",i,");",l,".",e,"=",i,";")})),0===Object.keys(n.state).length&&c(l,".dirty=false;"),e(c)}function tt(t,e,n,i){var o=t.shared,s=t.current,a=o.current,l=o.gl;st(Object.keys(n)).forEach((function(o){var h=n[o];if(!i||i(h)){var c=h.append(t,e);if(be[o]){var u=be[o];ut(h)?e(l,c?".enable(":".disable(",u,");"):e(t.cond(c).then(l,".enable(",u,");").else(l,".disable(",u,");")),e(a,".",o,"=",c,";")}else if(D(c)){var f=s[o];e(l,".",we[o],"(",c,");",c.map((function(t,e){return f+"["+e+"]="+t})).join(";"),";")}else e(l,".",we[o],"(",c,");",a,".",o,"=",c,";")}}))}function et(t,e){pe&&(t.instancing=e.def(t.shared.extensions,".angle_instanced_arrays"))}function nt(t,e,n,i,o){function s(){return"undefined"==typeof performance?"Date.now()":"performance.now()"}function a(t){t(c=e.def(),"=",s(),";"),"string"==typeof o?t(g,".count+=",o,";"):t(g,".count++;"),m&&(i?t(u=e.def(),"=",w,".getNumPendingQueries();"):t(w,".beginQuery(",g,");"))}function l(t){t(g,".cpuTime+=",s(),"-",c,";"),m&&(i?t(w,".pushScopeStats(",u,",",w,".getNumPendingQueries(),",g,");"):t(w,".endQuery();"))}function h(t){var n=e.def(A,".profile");e(A,".profile=",t,";"),e.exit(A,".profile=",n,";")}var c,u,f=t.shared,g=t.stats,A=f.current,w=f.timer;if(n=n.profile){if(ut(n))return void(n.enable?(a(e),l(e.exit),h("true")):h("false"));h(n=n.append(t,e))}else n=e.def(A,".profile");a(f=t.block()),e("if(",n,"){",f,"}"),l(t=t.block()),e.exit("if(",n,"){",t,"}")}function it(t,e,n,i,o){function s(t){switch(t){case 35664:case 35667:case 35671:return 2;case 35665:case 35668:case 35672:return 3;case 35666:case 35669:case 35673:return 4;default:return 1}}function a(n,i,o){function s(){e(h,".enableVertexAttribArray(",c,");");var n,s=o.type;n=o.size?e.def(o.size,"||",i):i,e(h,".bindBuffer(",34962,",",f,".buffer);",h,".vertexAttribPointer(",[c,n,s,o.normalized,o.stride,o.offset],");",u,".type=",s,";",u,".size=",n,";",A.map((function(t){return u+"."+t+"="+o[t]+";"})).join("")),pe&&e("if(",u,".divisor!==",s=o.divisor,"){",t.instancing,".vertexAttribDivisorANGLE(",[c,s],");",u,".divisor=",s,";}")}function a(){e("if(",u,".buffer){",h,".disableVertexAttribArray(",c,");",u,".buffer=null;","}if(",Qe.map((function(t,e){return u+"."+t+"!=="+g[e]})).join("||"),"){",h,".vertexAttrib4f(",c,",",g,");",Qe.map((function(t,e){return u+"."+t+"="+g[e]+";"})).join(""),"}")}var h=l.gl,c=e.def(n,".location"),u=e.def(l.attributes,"[",c,"]"),f=o.buffer,g=[o.x,o.y,o.z,o.w],A=["buffer","normalized","offset","stride"];1===(n=o.state)?s():2===n?a():(e("if(",n,"===",1,"){"),s(),e("}else{"),a(),e("}"))}var l=t.shared;i.forEach((function(i){var l,h=i.name,c=n.attributes[h];if(c){if(!o(c))return;l=c.append(t,e)}else{if(!o(on))return;var u=t.scopeAttrib(h);l={},Object.keys(new fe).forEach((function(t){l[t]=e.def(u,".",t)}))}a(t.link(i),s(i.info.type),l)}))}function vt(t,n,i,o,s,a){for(var l,h=t.shared,c=h.gl,u={},g=0;g<o.length;++g){var A=(C=o[g]).name,m=C.info.type,w=i.uniforms[A];if(1<(O=C.info.size)){if(!w)continue;var T=A.replace("[0]","");if(u[T])continue;u[T]=1}var M,C=t.link(C)+".location";if(w){if(!s(w))continue;if(ut(w)){if(A=w.value,35678===m||35680===m)n(c,".uniform1i(",C,",",(m=t.link(A._texture||A.color[0]._texture))+".bind());"),n.exit(m,".unbind();");else if(35674===m||35675===m||35676===m)O=t.global.def("new Float32Array(["+Array.prototype.slice.call(A)+"])"),A=2,35675===m?A=3:35676===m&&(A=4),n(c,".uniformMatrix",A,"fv(",C,",false,",O,");");else{switch(m){case 5126:l="1f";break;case 35664:l="2f";break;case 35665:l="3f";break;case 35666:l="4f";break;case 35670:case 5124:l="1i";break;case 35671:case 35667:l="2i";break;case 35672:case 35668:l="3i";break;case 35673:case 35669:l="4i"}1<O?(l+="v",A=t.global.def("["+Array.prototype.slice.call(A)+"]")):A=D(A)?Array.prototype.slice.call(A):A,n(c,".uniform",l,"(",C,",",A,");")}continue}M=w.append(t,n)}else{if(!s(on))continue;M=n.def(h.uniforms,"[",e.id(A),"]")}switch(35678===m?n("if(",M,"&&",M,'._reglType==="framebuffer"){',M,"=",M,".color[0];","}"):35680===m&&n("if(",M,"&&",M,'._reglType==="framebufferCube"){',M,"=",M,".color[0];","}"),A=1,m){case 35678:case 35680:m=n.def(M,"._texture"),n(c,".uniform1i(",C,",",m,".bind());"),n.exit(m,".unbind();");continue;case 5124:case 35670:l="1i";break;case 35667:case 35671:l="2i",A=2;break;case 35668:case 35672:l="3i",A=3;break;case 35669:case 35673:l="4i",A=4;break;case 5126:l="1f";break;case 35664:l="2f",A=2;break;case 35665:l="3f",A=3;break;case 35666:l="4f",A=4;break;case 35674:l="Matrix2fv";break;case 35675:l="Matrix3fv";break;case 35676:l="Matrix4fv"}if(-1===l.indexOf("Matrix")&&1<O&&(l+="v",A=1),"M"===l.charAt(0)){n(c,".uniform",l,"(",C,","),C=Math.pow(m-35674+2,2);var P=t.global.def("new Float32Array(",C,")");Array.isArray(M)?n("false,(",f(C,(function(t){return P+"["+t+"]="+M[t]})),",",P,")"):n("false,(Array.isArray(",M,")||",M," instanceof Float32Array)?",M,":(",f(C,(function(t){return P+"["+t+"]="+M+"["+t+"]"})),",",P,")"),n(");")}else{if(1<A){m=[];for(var I=[],O=0;O<A;++O)Array.isArray(M)?I.push(M[O]):I.push(n.def(M+"["+O+"]")),a&&m.push(n.def());a&&n("if(!",t.batchId,"||",m.map((function(t,e){return t+"!=="+I[e]})).join("||"),"){",m.map((function(t,e){return t+"="+I[e]+";"})).join("")),n(c,".uniform",l,"(",C,",",I.join(","),");")}else a&&(m=n.def(),n("if(!",t.batchId,"||",m,"!==",M,"){",m,"=",M,";")),n(c,".uniform",l,"(",C,",",M,");");a&&n("}")}}}function xt(t,e,n,i){function o(o){var s=g[o];return s?s.append(t,s.contextDep&&i.contextDynamic||s.propDep?n:e):e.def(f,".",o)}function s(){function t(){n(h,".drawElementsInstancedANGLE(",[m,T,M,w+"<<(("+M+"-5121)>>1)",l],");")}function e(){n(h,".drawArraysInstancedANGLE(",[m,w,T,l],");")}A&&"null"!==A?C?t():(n("if(",A,"){"),t(),n("}else{"),e(),n("}")):e()}function a(){function t(){n(u+".drawElements("+[m,T,M,w+"<<(("+M+"-5121)>>1)"]+");")}function e(){n(u+".drawArrays("+[m,w,T]+");")}A&&"null"!==A?C?t():(n("if(",A,"){"),t(),n("}else{"),e(),n("}")):e()}var l,h,c=t.shared,u=c.gl,f=c.draw,g=i.draw,A=function(){var o=g.elements,s=e;return o?((o.contextDep&&i.contextDynamic||o.propDep)&&(s=n),o=o.append(t,s),g.elementsActive&&s("if("+o+")"+u+".bindBuffer(34963,"+o+".buffer.buffer);")):(o=s.def(),s(o,"=",f,".","elements",";","if(",o,"){",u,".bindBuffer(",34963,",",o,".buffer.buffer);}","else if(",c.vao,".currentVAO){",o,"=",t.shared.elements+".getElements("+c.vao,".currentVAO.elements);",ye?"":"if("+o+")"+u+".bindBuffer(34963,"+o+".buffer.buffer);","}")),o}(),m=o("primitive"),w=o("offset"),T=function(){var o=g.count,s=e;return o?((o.contextDep&&i.contextDynamic||o.propDep)&&(s=n),o=o.append(t,s)):o=s.def(f,".","count"),o}();if("number"==typeof T){if(0===T)return}else n("if(",T,"){"),n.exit("}");pe&&(l=o("instances"),h=t.instancing);var M=A+".type",C=g.elements&&ut(g.elements)&&!g.vaoActive;pe&&("number"!=typeof l||0<=l)?"string"==typeof l?(n("if(",l,">0){"),s(),n("}else if(",l,"<0){"),a(),n("}")):s():a()}function Ct(t,e,n,i,o){return o=(e=P()).proc("body",o),pe&&(e.instancing=o.def(e.shared.extensions,".angle_instanced_arrays")),t(e,o,n,i),e.compile().body}function Gt(t,e,n,i){et(t,e),n.useVAO?n.drawVAO?e(t.shared.vao,".setVAO(",n.drawVAO.append(t,e),");"):e(t.shared.vao,".setVAO(",t.shared.vao,".targetVAO);"):(e(t.shared.vao,".setVAO(null);"),it(t,e,n,i.attributes,(function(){return!0}))),vt(t,e,n,i.uniforms,(function(){return!0}),!1),xt(t,e,e,n)}function $t(t,e){var n=t.proc("draw",1);et(t,n),Y(t,n,e.context),K(t,n,e.framebuffer),$(t,n,e),tt(t,n,e.state),nt(t,n,e,!1,!0);var i=e.shader.progVar.append(t,n);if(n(t.shared.gl,".useProgram(",i,".program);"),e.shader.program)Gt(t,n,e,e.shader.program);else{n(t.shared.vao,".setVAO(null);");var o=t.global.def("{}"),s=n.def(i,".id"),a=n.def(o,"[",s,"]");n(t.cond(a).then(a,".call(this,a0);").else(a,"=",o,"[",s,"]=",t.link((function(n){return Ct(Gt,t,e,n,1)})),"(",i,");",a,".call(this,a0);"))}0<Object.keys(e.state).length&&n(t.shared.current,".dirty=true;"),t.shared.vao&&n(t.shared.vao,".setVAO(null);")}function ne(t,e,n,i){function o(){return!0}t.batchId="a1",et(t,e),it(t,e,n,i.attributes,o),vt(t,e,n,i.uniforms,o,!1),xt(t,e,e,n)}function re(t,e,n,i){function o(t){return t.contextDep&&a||t.propDep}function s(t){return!o(t)}et(t,e);var a=n.contextDep,l=e.def(),h=e.def();t.shared.props=h,t.batchId=l;var c=t.scope(),u=t.scope();e(c.entry,"for(",l,"=0;",l,"<","a1",";++",l,"){",h,"=","a0","[",l,"];",u,"}",c.exit),n.needsContext&&Y(t,u,n.context),n.needsFramebuffer&&K(t,u,n.framebuffer),tt(t,u,n.state,o),n.profile&&o(n.profile)&&nt(t,u,n,!1,!0),i?(n.useVAO?n.drawVAO?o(n.drawVAO)?u(t.shared.vao,".setVAO(",n.drawVAO.append(t,u),");"):c(t.shared.vao,".setVAO(",n.drawVAO.append(t,c),");"):c(t.shared.vao,".setVAO(",t.shared.vao,".targetVAO);"):(c(t.shared.vao,".setVAO(null);"),it(t,c,n,i.attributes,s),it(t,u,n,i.attributes,o)),vt(t,c,n,i.uniforms,s,!1),vt(t,u,n,i.uniforms,o,!0),xt(t,c,u,n)):(e=t.global.def("{}"),i=n.shader.progVar.append(t,u),h=u.def(i,".id"),c=u.def(e,"[",h,"]"),u(t.shared.gl,".useProgram(",i,".program);","if(!",c,"){",c,"=",e,"[",h,"]=",t.link((function(e){return Ct(ne,t,n,e,2)})),"(",i,");}",c,".call(this,a0[",l,"],",l,");"))}function oe(t,e){function n(t){return t.contextDep&&o||t.propDep}var i=t.proc("batch",2);t.batchId="0",et(t,i);var o=!1,s=!0;Object.keys(e.context).forEach((function(t){o=o||e.context[t].propDep})),o||(Y(t,i,e.context),s=!1);var a=!1;if((l=e.framebuffer)?(l.propDep?o=a=!0:l.contextDep&&o&&(a=!0),a||K(t,i,l)):K(t,i,null),e.state.viewport&&e.state.viewport.propDep&&(o=!0),$(t,i,e),tt(t,i,e.state,(function(t){return!n(t)})),e.profile&&n(e.profile)||nt(t,i,e,!1,"a1"),e.contextDep=o,e.needsContext=s,e.needsFramebuffer=a,(s=e.shader.progVar).contextDep&&o||s.propDep)re(t,i,e,null);else if(s=s.append(t,i),i(t.shared.gl,".useProgram(",s,".program);"),e.shader.program)re(t,i,e,e.shader.program);else{i(t.shared.vao,".setVAO(null);");var l=t.global.def("{}"),h=(a=i.def(s,".id"),i.def(l,"[",a,"]"));i(t.cond(h).then(h,".call(this,a0,a1);").else(h,"=",l,"[",a,"]=",t.link((function(n){return Ct(re,t,e,n,2)})),"(",s,");",h,".call(this,a0,a1);"))}0<Object.keys(e.state).length&&i(t.shared.current,".dirty=true;"),t.shared.vao&&i(t.shared.vao,".setVAO(null);")}function ae(t,n){function i(e){var i=n.shader[e];i&&o.set(s.shader,"."+e,i.append(t,o))}var o=t.proc("scope",3);t.batchId="a2";var s=t.shared,a=s.current;Y(t,o,n.context),n.framebuffer&&n.framebuffer.append(t,o),st(Object.keys(n.state)).forEach((function(e){var i=n.state[e].append(t,o);D(i)?i.forEach((function(n,i){o.set(t.next[e],"["+i+"]",n)})):o.set(s.next,"."+e,i)})),nt(t,o,n,!0,!0),["elements","offset","count","instances","primitive"].forEach((function(e){var i=n.draw[e];i&&o.set(s.draw,"."+e,""+i.append(t,o))})),Object.keys(n.uniforms).forEach((function(i){var a=n.uniforms[i].append(t,o);Array.isArray(a)&&(a="["+a.join()+"]"),o.set(s.uniforms,"["+e.id(i)+"]",a)})),Object.keys(n.attributes).forEach((function(e){var i=n.attributes[e].append(t,o),s=t.scopeAttrib(e);Object.keys(new fe).forEach((function(t){o.set(s,"."+t,i[t])}))})),n.scopeVAO&&o.set(s.vao,".targetVAO",n.scopeVAO.append(t,o)),i("vert"),i("frag"),0<Object.keys(n.state).length&&(o(a,".dirty=true;"),o.exit(a,".dirty=true;")),o("a1(",t.shared.context,",a0,",t.batchId,");")}function he(t){if("object"==typeof t&&!D(t)){for(var e=Object.keys(t),n=0;n<e.length;++n)if(Ot.isDynamic(t[e[n]]))return!0;return!1}}function ce(t,e,n){function i(t,e){a.forEach((function(n){var i=o[n];Ot.isDynamic(i)&&(i=t.invoke(e,i),e(u,".",n,"=",i,";"))}))}var o=e.static[n];if(o&&he(o)){var s=t.global,a=Object.keys(o),l=!1,h=!1,c=!1,u=t.global.def("{}");a.forEach((function(e){var n=o[e];if(Ot.isDynamic(n))"function"==typeof n&&(n=o[e]=Ot.unbox(n)),e=gt(n,null),l=l||e.thisDep,c=c||e.propDep,h=h||e.contextDep;else{switch(s(u,".",e,"="),typeof n){case"number":s(n);break;case"string":s('"',n,'"');break;case"object":Array.isArray(n)&&s("[",n.join(),"]");break;default:s(t.link(n))}s(";")}})),e.dynamic[n]=new Ot.DynamicVariable(4,{thisDep:l,contextDep:h,propDep:c,ref:u,append:i}),delete e.static[n]}}var fe=c.Record,ge={add:32774,subtract:32778,"reverse subtract":32779};n.ext_blend_minmax&&(ge.min=32775,ge.max=32776);var pe=n.angle_instanced_arrays,Ae=n.webgl_draw_buffers,ye=n.oes_vertex_array_object,_e={dirty:!0,profile:w.profile},ve={},xe=[],be={},we={};M("dither",3024),M("blend.enable",3042),C("blend.color","blendColor",[0,0,0,0]),C("blend.equation","blendEquationSeparate",[32774,32774]),C("blend.func","blendFuncSeparate",[1,0,1,0]),M("depth.enable",2929,!0),C("depth.func","depthFunc",513),C("depth.range","depthRange",[0,1]),C("depth.mask","depthMask",!0),C("colorMask","colorMask",[!0,!0,!0,!0]),M("cull.enable",2884),C("cull.face","cullFace",1029),C("frontFace","frontFace",2305),C("lineWidth","lineWidth",1),M("polygonOffset.enable",32823),C("polygonOffset.offset","polygonOffset",[0,0]),M("sample.alpha",32926),M("sample.enable",32928),C("sample.coverage","sampleCoverage",[1,!1]),M("stencil.enable",2960),C("stencil.mask","stencilMask",-1),C("stencil.func","stencilFunc",[519,0,-1]),C("stencil.opFront","stencilOpSeparate",[1028,7680,7680,7680]),C("stencil.opBack","stencilOpSeparate",[1029,7680,7680,7680]),M("scissor.enable",3089),C("scissor.box","scissor",[0,0,t.drawingBufferWidth,t.drawingBufferHeight]),C("viewport","viewport",[0,0,t.drawingBufferWidth,t.drawingBufferHeight]);var Me={gl:t,context:A,strings:e,next:ve,current:_e,draw:g,elements:s,buffer:o,shader:u,attributes:c.state,vao:c,uniforms:h,framebuffer:l,extensions:n,timer:m,isBufferArgs:ot},Ee={primTypes:me,compareFuncs:tn,blendFuncs:Ke,blendEquations:ge,stencilOps:nn,glTypes:ue,orientationType:rn};Ae&&(Ee.backBuffer=[1029],Ee.drawBuffer=f(i.maxDrawbuffers,(function(t){return 0===t?[0]:f(t,(function(t){return 36064+t}))})));var ke=0;return{next:ve,current:_e,procs:function(){var t=P(),e=t.proc("poll"),o=t.proc("refresh"),s=t.block();e(s),o(s);var a,l=t.shared,h=l.gl,c=l.next,u=l.current;s(u,".dirty=false;"),K(t,e),K(t,o,null,!0),pe&&(a=t.link(pe)),n.oes_vertex_array_object&&o(t.link(n.oes_vertex_array_object),".bindVertexArrayOES(null);");for(var g=0;g<i.maxAttributes;++g){var A=o.def(l.attributes,"[",g,"]"),m=t.cond(A,".buffer");m.then(h,".enableVertexAttribArray(",g,");",h,".bindBuffer(",34962,",",A,".buffer.buffer);",h,".vertexAttribPointer(",g,",",A,".size,",A,".type,",A,".normalized,",A,".stride,",A,".offset);").else(h,".disableVertexAttribArray(",g,");",h,".vertexAttrib4f(",g,",",A,".x,",A,".y,",A,".z,",A,".w);",A,".buffer=null;"),o(m),pe&&o(a,".vertexAttribDivisorANGLE(",g,",",A,".divisor);")}return o(t.shared.vao,".currentVAO=null;",t.shared.vao,".setVAO(",t.shared.vao,".targetVAO);"),Object.keys(be).forEach((function(n){var i=be[n],a=s.def(c,".",n),l=t.block();l("if(",a,"){",h,".enable(",i,")}else{",h,".disable(",i,")}",u,".",n,"=",a,";"),o(l),e("if(",a,"!==",u,".",n,"){",l,"}")})),Object.keys(we).forEach((function(n){var i,a,l=we[n],g=_e[n],A=t.block();A(h,".",l,"("),D(g)?(l=g.length,i=t.global.def(c,".",n),a=t.global.def(u,".",n),A(f(l,(function(t){return i+"["+t+"]"})),");",f(l,(function(t){return a+"["+t+"]="+i+"["+t+"];"})).join("")),e("if(",f(l,(function(t){return i+"["+t+"]!=="+a+"["+t+"]"})).join("||"),"){",A,"}")):(i=s.def(c,".",n),a=s.def(u,".",n),A(i,");",u,".",n,"=",i,";"),e("if(",i,"!==",a,"){",A,"}")),o(A)})),t.compile()}(),compile:function(t,e,n,i,o){var s=P();s.stats=s.link(o),Object.keys(e.static).forEach((function(t){ce(s,e,t)})),Ye.forEach((function(e){ce(s,t,e)}));var a=Q(t,e,n,i,s);return $t(s,a),ae(s,a),oe(s,a),bt(s.compile(),{destroy:function(){a.shader.program.destroy()}})}}}function xt(t,e){for(var n=0;n<t.length;++n)if(t[n]===e)return n;return-1}var bt=function(t,e){for(var n=Object.keys(e),i=0;i<n.length;++i)t[n[i]]=e[n[i]];return t},Ct=0,Ot={DynamicVariable:t,define:function(e,i){return new t(e,n(i+""))},isDynamic:function(e){return"function"==typeof e&&!e._reglType||e instanceof t},unbox:i,accessor:n},Gt={next:"function"==typeof requestAnimationFrame?function(t){return requestAnimationFrame(t)}:function(t){return setTimeout(t,16)},cancel:"function"==typeof cancelAnimationFrame?function(t){return cancelAnimationFrame(t)}:clearTimeout},$t="undefined"!=typeof performance&&performance.now?function(){return performance.now()}:function(){return+new Date},ne=A();ne.zero=A();var re=function(t,e){var n=1;e.ext_texture_filter_anisotropic&&(n=t.getParameter(34047));var i=1,o=1;e.webgl_draw_buffers&&(i=t.getParameter(34852),o=t.getParameter(36063));var s=!!e.oes_texture_float;if(s){s=t.createTexture(),t.bindTexture(3553,s),t.texImage2D(3553,0,6408,1,1,0,6408,5126,null);var a=t.createFramebuffer();if(t.bindFramebuffer(36160,a),t.framebufferTexture2D(36160,36064,3553,s,0),t.bindTexture(3553,null),36053!==t.checkFramebufferStatus(36160))s=!1;else{t.viewport(0,0,1,1),t.clearColor(1,0,0,1),t.clear(16384);var l=ne.allocType(5126,4);t.readPixels(0,0,1,1,6408,5126,l),t.getError()?s=!1:(t.deleteFramebuffer(a),t.deleteTexture(s),s=1===l[0]),ne.freeType(l)}}return l=!0,"undefined"!=typeof navigator&&(/MSIE/.test(navigator.userAgent)||/Trident\//.test(navigator.appVersion)||/Edge/.test(navigator.userAgent))||(l=t.createTexture(),a=ne.allocType(5121,36),t.activeTexture(33984),t.bindTexture(34067,l),t.texImage2D(34069,0,6408,3,3,0,6408,5121,a),ne.freeType(a),t.bindTexture(34067,null),t.deleteTexture(l),l=!t.getError()),{colorBits:[t.getParameter(3410),t.getParameter(3411),t.getParameter(3412),t.getParameter(3413)],depthBits:t.getParameter(3414),stencilBits:t.getParameter(3415),subpixelBits:t.getParameter(3408),extensions:Object.keys(e).filter((function(t){return!!e[t]})),maxAnisotropic:n,maxDrawbuffers:i,maxColorAttachments:o,pointSizeDims:t.getParameter(33901),lineWidthDims:t.getParameter(33902),maxViewportDims:t.getParameter(3386),maxCombinedTextureUnits:t.getParameter(35661),maxCubeMapSize:t.getParameter(34076),maxRenderbufferSize:t.getParameter(34024),maxTextureUnits:t.getParameter(34930),maxTextureSize:t.getParameter(3379),maxAttributes:t.getParameter(34921),maxVertexUniforms:t.getParameter(36347),maxVertexTextureUnits:t.getParameter(35660),maxVaryingVectors:t.getParameter(36348),maxFragmentUniforms:t.getParameter(36349),glsl:t.getParameter(35724),renderer:t.getParameter(7937),vendor:t.getParameter(7936),version:t.getParameter(7938),readFloat:s,npotTextureCube:l}},oe=function(t){return t instanceof Uint8Array||t instanceof Uint16Array||t instanceof Uint32Array||t instanceof Int8Array||t instanceof Int16Array||t instanceof Int32Array||t instanceof Float32Array||t instanceof Float64Array||t instanceof Uint8ClampedArray},ae=function(t){return Object.keys(t).map((function(e){return t[e]}))},he={shape:function(t){for(var e=[];t.length;t=t[0])e.push(t.length);return e},flatten:function(t,e,n,i){var o=1;if(e.length)for(var s=0;s<e.length;++s)o*=e[s];else o=0;switch(n=i||ne.allocType(n,o),e.length){case 0:break;case 1:for(i=e[0],e=0;e<i;++e)n[e]=t[e];break;case 2:for(i=e[0],e=e[1],s=o=0;s<i;++s)for(var a=t[s],l=0;l<e;++l)n[o++]=a[l];break;case 3:w(t,e[0],e[1],e[2],n,0);break;default:T(t,e,0,n,0)}return n}},ce={"[object Int8Array]":5120,"[object Int16Array]":5122,"[object Int32Array]":5124,"[object Uint8Array]":5121,"[object Uint8ClampedArray]":5121,"[object Uint16Array]":5123,"[object Uint32Array]":5125,"[object Float32Array]":5126,"[object Float64Array]":5121,"[object ArrayBuffer]":5121},ue={int8:5120,int16:5122,int32:5124,uint8:5121,uint16:5123,uint32:5125,float:5126,float32:5126},fe={dynamic:35048,stream:35040,static:35044},ge=he.flatten,pe=he.shape,Ae=[];Ae[5120]=1,Ae[5122]=2,Ae[5124]=4,Ae[5121]=1,Ae[5123]=2,Ae[5125]=4,Ae[5126]=4;var me={points:0,point:0,lines:1,line:1,triangles:4,triangle:4,"line loop":2,"line strip":3,"triangle strip":5,"triangle fan":6},ye=new Float32Array(1),_e=new Uint32Array(ye.buffer),ve=[9984,9986,9985,9987],xe=[0,6409,6410,6407,6408],be={};be[6409]=be[6406]=be[6402]=1,be[34041]=be[6410]=2,be[6407]=be[35904]=3,be[6408]=be[35906]=4;var we=N("HTMLCanvasElement"),Me=N("OffscreenCanvas"),Ee=N("CanvasRenderingContext2D"),ke=N("ImageBitmap"),Re=N("HTMLImageElement"),Le=N("HTMLVideoElement"),Fe=Object.keys(ce).concat([we,Me,Ee,ke,Re,Le]),He=[];He[5121]=1,He[5126]=4,He[36193]=2,He[5123]=2,He[5125]=4;var Ge=[];Ge[32854]=2,Ge[32855]=2,Ge[36194]=2,Ge[34041]=4,Ge[33776]=.5,Ge[33777]=.5,Ge[33778]=1,Ge[33779]=1,Ge[35986]=.5,Ge[35987]=1,Ge[34798]=1,Ge[35840]=.5,Ge[35841]=.25,Ge[35842]=.5,Ge[35843]=.25,Ge[36196]=.5;var Ue=[];Ue[32854]=2,Ue[32855]=2,Ue[36194]=2,Ue[33189]=2,Ue[36168]=1,Ue[34041]=4,Ue[35056]=4,Ue[35907]=4,Ue[34836]=16,Ue[34842]=8,Ue[34843]=6;var We=function(t,e,n,i,o){function s(t){this.id=c++,this.refCount=1,this.renderbuffer=t,this.format=32854,this.height=this.width=0,o.profile&&(this.stats={size:0})}function a(e){var n=e.renderbuffer;t.bindRenderbuffer(36161,null),t.deleteRenderbuffer(n),e.renderbuffer=null,e.refCount=0,delete u[e.id],i.renderbufferCount--}var l={rgba4:32854,rgba8:32856,rgb565:36194,"rgb5 a1":32855,depth:33189,stencil:36168,"depth stencil":34041,"depth24 stencil8":35056};e.ext_srgb&&(l.srgba=35907),e.ext_color_buffer_half_float&&(l.rgba16f=34842,l.rgb16f=34843),e.webgl_color_buffer_float&&(l.rgba32f=34836);var h=[];Object.keys(l).forEach((function(t){h[l[t]]=t}));var c=0,u={};return s.prototype.decRef=function(){0>=--this.refCount&&a(this)},o.profile&&(i.getTotalRenderbufferSize=function(){var t=0;return Object.keys(u).forEach((function(e){t+=u[e].stats.size})),t}),{create:function(e,n){function a(e,n){var i=0,s=0,u=32854,f=0;if("object"==typeof e&&e?("shape"in e?(i=0|(s=e.shape)[0],s=0|s[1]):("radius"in e&&(i=s=0|e.radius),"width"in e&&(i=0|e.width),"height"in e&&(s=0|e.height)),"format"in e&&(u=l[e.format]),"samples"in e&&(f=e.samples)):"number"==typeof e?(i=0|e,s="number"==typeof n?0|n:i):e||(i=s=1),i!==c.width||s!==c.height||u!==c.format)return a.width=c.width=i,a.height=c.height=s,a.samples=f,c.format=u,c.samples=f,t.bindRenderbuffer(36161,c.renderbuffer),f&&t.renderbufferStorageMultisample?t.renderbufferStorageMultisample(36161,f,u,i,s):t.renderbufferStorage(36161,u,i,s),o.profile&&(c.stats.size=Ue[c.format]*c.width*c.height),a.format=h[c.format],a}var c=new s(t.createRenderbuffer());return u[c.id]=c,i.renderbufferCount++,a(e,n),a.resize=function(e,n){var i=0|e,s=0|n||i;if(i===c.width&&s===c.height)return a;a.width=c.width=i,a.height=c.height=s;var l=a.samples;return t.bindRenderbuffer(36161,c.renderbuffer),l&&t.renderbufferStorageMultisample?t.renderbufferStorageMultisample(36161,l,c.format,i,s):t.renderbufferStorage(36161,c.format,i,s),o.profile&&(c.stats.size=Ue[c.format]*c.width*c.height),a},a._reglType="renderbuffer",a._renderbuffer=c,o.profile&&(a.stats=c.stats),a.destroy=function(){c.decRef()},a},clear:function(){ae(u).forEach(a)},restore:function(){ae(u).forEach((function(e){e.renderbuffer=t.createRenderbuffer(),t.bindRenderbuffer(36161,e.renderbuffer),e.samples&&t.renderbufferStorageMultisample?t.renderbufferStorageMultisample(36161,e.samples,e.format,e.width,e.height):t.renderbufferStorage(36161,e.format,e.width,e.height)})),t.bindRenderbuffer(36161,null)}}},qe=[];qe[6408]=4,qe[6407]=3;var Je=[];Je[5121]=1,Je[5126]=4,Je[36193]=2;var Qe=["x","y","z","w"],Ye="blend.func blend.equation stencil.func stencil.opFront stencil.opBack sample.coverage viewport scissor.box polygonOffset.offset".split(" "),Ke={0:0,1:1,zero:0,one:1,"src color":768,"one minus src color":769,"src alpha":770,"one minus src alpha":771,"dst color":774,"one minus dst color":775,"dst alpha":772,"one minus dst alpha":773,"constant color":32769,"one minus constant color":32770,"constant alpha":32771,"one minus constant alpha":32772,"src alpha saturate":776},tn={never:512,less:513,"<":513,equal:514,"=":514,"==":514,"===":514,lequal:515,"<=":515,greater:516,">":516,notequal:517,"!=":517,"!==":517,gequal:518,">=":518,always:519},nn={0:0,zero:0,keep:7680,replace:7681,increment:7682,decrement:7683,"increment wrap":34055,"decrement wrap":34056,invert:5386},rn={cw:2304,ccw:2305},on=new at(!1,!1,!1,(function(){})),un=function(t,e){function n(){this.endQueryIndex=this.startQueryIndex=-1,this.sum=0,this.stats=null}function i(t,e,i){var o=a.pop()||new n;o.startQueryIndex=t,o.endQueryIndex=e,o.sum=0,o.stats=i,l.push(o)}if(!e.ext_disjoint_timer_query)return null;var o=[],s=[],a=[],l=[],h=[],c=[];return{beginQuery:function(t){var n=o.pop()||e.ext_disjoint_timer_query.createQueryEXT();e.ext_disjoint_timer_query.beginQueryEXT(35007,n),s.push(n),i(s.length-1,s.length,t)},endQuery:function(){e.ext_disjoint_timer_query.endQueryEXT(35007)},pushScopeStats:i,update:function(){var t,n;if(0!==(t=s.length)){c.length=Math.max(c.length,t+1),h.length=Math.max(h.length,t+1),h[0]=0;var i=c[0]=0;for(n=t=0;n<s.length;++n)e.ext_disjoint_timer_query.getQueryObjectEXT(u=s[n],34919)?(i+=e.ext_disjoint_timer_query.getQueryObjectEXT(u,34918),o.push(u)):s[t++]=u,h[n+1]=i,c[n+1]=t;for(s.length=t,n=t=0;n<l.length;++n){var u,f=(i=l[n]).startQueryIndex;i.sum+=h[u=i.endQueryIndex]-h[f],(u=c[u])===(f=c[f])?(i.stats.gpuTime+=i.sum/1e6,a.push(i)):(i.startQueryIndex=f,i.endQueryIndex=u,l[t++]=i)}l.length=t}},getNumPendingQueries:function(){return s.length},clear:function(){o.push.apply(o,s);for(var t=0;t<o.length;t++)e.ext_disjoint_timer_query.deleteQueryEXT(o[t]);s.length=0,o.length=0},restore:function(){s.length=0,o.length=0}}};return function(t){function e(){if(0===gt.length)N&&N.update(),ae=null;else{ae=Gt.next(e),A();for(var t=gt.length-1;0<=t;--t){var n=gt[t];n&&n(W,null,0)}T.flush(),N&&N.update()}}function n(){!ae&&0<gt.length&&(ae=Gt.next(e))}function i(){ae&&(Gt.cancel(e),ae=null)}function s(t){t.preventDefault(),i(),Ct.forEach((function(t){t()}))}function a(t){T.getError(),C.restore(),it.restore(),J.restore(),rt.restore(),ot.restore(),st.restore(),nt.restore(),N&&N.restore(),at.procs.refresh(),n(),ne.forEach((function(t){t()}))}function l(t){function e(t,e){var n={},i={};return Object.keys(t).forEach((function(o){var s=t[o];if(Ot.isDynamic(s))i[o]=Ot.unbox(s,o);else{if(e&&Array.isArray(s))for(var a=0;a<s.length;++a)if(Ot.isDynamic(s[a]))return void(i[o]=Ot.unbox(s,o));n[o]=s}})),{dynamic:i,static:n}}function n(t){for(;f.length<t;)f.push(null);return f}var i=e(t.context||{},!0),o=e(t.uniforms||{},!0),s=e(t.attributes||{},!1);t=e(function(t){function e(t){if(t in n){var e=n[t];delete n[t],Object.keys(e).forEach((function(i){n[t+"."+i]=e[i]}))}}var n=bt({},t);return delete n.uniforms,delete n.attributes,delete n.context,delete n.vao,"stencil"in n&&n.stencil.op&&(n.stencil.opBack=n.stencil.opFront=n.stencil.op,delete n.stencil.op),e("blend"),e("depth"),e("cull"),e("stencil"),e("polygonOffset"),e("scissor"),e("sample"),"vao"in t&&(n.vao=t.vao),n}(t),!1);var a={gpuTime:0,cpuTime:0,count:0},l=at.compile(t,s,o,i,a),h=l.draw,c=l.batch,u=l.scope,f=[];return bt((function(t,e){var i;if("function"==typeof t)return u.call(this,null,t,0);if("function"==typeof e)if("number"==typeof t)for(i=0;i<t;++i)u.call(this,null,e,i);else{if(!Array.isArray(t))return u.call(this,t,e,0);for(i=0;i<t.length;++i)u.call(this,t[i],e,i)}else if("number"==typeof t){if(0<t)return c.call(this,n(0|t),0|t)}else{if(!Array.isArray(t))return h.call(this,t);if(t.length)return c.call(this,t,t.length)}}),{stats:a,destroy:function(){l.destroy()}})}function h(t,e){var n=0;at.procs.poll();var i=e.color;i&&(T.clearColor(+i[0]||0,+i[1]||0,+i[2]||0,+i[3]||0),n|=16384),"depth"in e&&(T.clearDepth(+e.depth),n|=256),"stencil"in e&&(T.clearStencil(0|e.stencil),n|=1024),T.clear(n)}function f(t){return gt.push(t),n(),{cancel:function(){function e(){var t=xt(gt,e);gt[t]=gt[gt.length-1],--gt.length,0>=gt.length&&i()}var n=xt(gt,t);gt[n]=e}}}function g(){var t=ut.viewport,e=ut.scissor_box;t[0]=t[1]=e[0]=e[1]=0,W.viewportWidth=W.framebufferWidth=W.drawingBufferWidth=t[2]=e[2]=T.drawingBufferWidth,W.viewportHeight=W.framebufferHeight=W.drawingBufferHeight=t[3]=e[3]=T.drawingBufferHeight}function A(){W.tick+=1,W.time=w(),g(),at.procs.poll()}function m(){rt.refresh(),g(),at.procs.refresh(),N&&N.update()}function w(){return($t()-H)/1e3}if(!(t=c(t)))return null;var T=t.gl,M=T.getContextAttributes();T.isContextLost();var C=u(T,t);if(!C)return null;var P=o(),E={vaoCount:0,bufferCount:0,elementsCount:0,framebufferCount:0,shaderCount:0,textureCount:0,cubeCount:0,renderbufferCount:0,maxTextureUnits:0},D=C.extensions,N=un(T,D),H=$t(),U=T.drawingBufferHeight,W={tick:0,time:0,viewportWidth:q=T.drawingBufferWidth,viewportHeight:U,framebufferWidth:q,framebufferHeight:U,drawingBufferWidth:q,drawingBufferHeight:U,pixelRatio:t.pixelRatio},q={elements:null,primitive:4,count:-1,offset:0,instances:-1},X=re(T,D),J=I(T,E,t,(function(t){return nt.destroyBuffer(t)})),K=O(T,D,J,E),nt=$(T,D,X,E,J,K,q),it=tt(T,P,E,t),rt=Q(T,D,X,(function(){at.procs.poll()}),W,E,t),ot=We(T,D,X,E,t),st=Y(T,D,X,rt,ot,E),at=vt(T,P,D,X,J,K,rt,st,{},nt,it,q,W,N,t),ut=(P=et(T,st,at.procs.poll,W),at.next),ft=T.canvas,gt=[],Ct=[],ne=[],oe=[t.onDestroy],ae=null;ft&&(ft.addEventListener("webglcontextlost",s,!1),ft.addEventListener("webglcontextrestored",a,!1));var he=st.setFBO=l({framebuffer:Ot.define.call(null,1,"framebuffer")});return m(),M=bt(l,{clear:function(t){if("framebuffer"in t)if(t.framebuffer&&"framebufferCube"===t.framebuffer_reglType)for(var e=0;6>e;++e)he(bt({framebuffer:t.framebuffer.faces[e]},t),h);else he(t,h);else h(null,t)},prop:Ot.define.bind(null,1),context:Ot.define.bind(null,2),this:Ot.define.bind(null,3),draw:l({}),buffer:function(t){return J.create(t,34962,!1,!1)},elements:function(t){return K.create(t,!1)},texture:rt.create2D,cube:rt.createCube,renderbuffer:ot.create,framebuffer:st.create,framebufferCube:st.createCube,vao:nt.createVAO,attributes:M,frame:f,on:function(t,e){var n;switch(t){case"frame":return f(e);case"lost":n=Ct;break;case"restore":n=ne;break;case"destroy":n=oe}return n.push(e),{cancel:function(){for(var t=0;t<n.length;++t)if(n[t]===e){n[t]=n[n.length-1],n.pop();break}}}},limits:X,hasExtension:function(t){return 0<=X.extensions.indexOf(t.toLowerCase())},read:P,destroy:function(){gt.length=0,i(),ft&&(ft.removeEventListener("webglcontextlost",s),ft.removeEventListener("webglcontextrestored",a)),it.clear(),st.clear(),ot.clear(),nt.clear(),rt.clear(),K.clear(),J.clear(),N&&N.clear(),oe.forEach((function(t){t()}))},_gl:T,_refresh:m,poll:function(){A(),N&&N.update()},now:w,stats:E,blit:st.blit}),t.onDone(null,M),M}}()}(Rm);var Lm=Rm.exports,Dm=km(Lm),Fm=1e-6,Nm="undefined"!=typeof Float32Array?Float32Array:Array,Hm=Math.random;var Bm=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var zm=Object.freeze({__proto__:null,get ARRAY_TYPE(){return Nm},EPSILON:Fm,RANDOM:Hm,equals:function(t,e){return Math.abs(t-e)<=Fm*Math.max(1,Math.abs(t),Math.abs(e))},setMatrixArrayType:function(t){Nm=t},toRadian:function(t){return t*Bm}});function Gm(t,e,n,i,o){return t[0]=e,t[1]=n,t[2]=i,t[3]=o,t}function jm(t,e,n){var i=e[0],o=e[1],s=e[2],a=e[3],l=n[0],h=n[1],c=n[2],u=n[3];return t[0]=i*l+s*h,t[1]=o*l+a*h,t[2]=i*c+s*u,t[3]=o*c+a*u,t}function Um(t,e){var n=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=n,t[2]=-n,t[3]=i,t}function Vm(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t}var Wm=Object.freeze({__proto__:null,LDU:function(t,e,n,i){return t[2]=i[2]/i[0],n[0]=i[0],n[1]=i[1],n[3]=i[3]-t[2]*n[1],[t,e,n]},add:function(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t},adjoint:function(t,e){var n=e[0];return t[0]=e[3],t[1]=-e[1],t[2]=-e[2],t[3]=n,t},clone:function(t){var e=new Nm(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},create:function(){var t=new Nm(4);return Nm!=Float32Array&&(t[1]=0,t[2]=0),t[0]=1,t[3]=1,t},determinant:function(t){return t[0]*t[3]-t[2]*t[1]},equals:function(t,e){var n=t[0],i=t[1],o=t[2],s=t[3],a=e[0],l=e[1],h=e[2],c=e[3];return Math.abs(n-a)<=Fm*Math.max(1,Math.abs(n),Math.abs(a))&&Math.abs(i-l)<=Fm*Math.max(1,Math.abs(i),Math.abs(l))&&Math.abs(o-h)<=Fm*Math.max(1,Math.abs(o),Math.abs(h))&&Math.abs(s-c)<=Fm*Math.max(1,Math.abs(s),Math.abs(c))},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]},frob:function(t){return Math.hypot(t[0],t[1],t[2],t[3])},fromRotation:Um,fromScaling:function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t},fromValues:function(t,e,n,i){var o=new Nm(4);return o[0]=t,o[1]=e,o[2]=n,o[3]=i,o},identity:function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t},invert:function(t,e){var n=e[0],i=e[1],o=e[2],s=e[3],a=n*s-o*i;return a?(t[0]=s*(a=1/a),t[1]=-i*a,t[2]=-o*a,t[3]=n*a,t):null},mul:jm,multiply:jm,multiplyScalar:function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t},multiplyScalarAndAdd:function(t,e,n,i){return t[0]=e[0]+n[0]*i,t[1]=e[1]+n[1]*i,t[2]=e[2]+n[2]*i,t[3]=e[3]+n[3]*i,t},rotate:function(t,e,n){var i=e[0],o=e[1],s=e[2],a=e[3],l=Math.sin(n),h=Math.cos(n);return t[0]=i*h+s*l,t[1]=o*h+a*l,t[2]=i*-l+s*h,t[3]=o*-l+a*h,t},scale:function(t,e,n){var i=e[1],o=e[2],s=e[3],a=n[0],l=n[1];return t[0]=e[0]*a,t[1]=i*a,t[2]=o*l,t[3]=s*l,t},set:Gm,str:function(t){return"mat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},sub:Vm,subtract:Vm,transpose:function(t,e){if(t===e){var n=e[1];t[1]=e[2],t[2]=n}else t[0]=e[0],t[1]=e[2],t[2]=e[1],t[3]=e[3];return t}});function Zm(t,e,n){var i=e[0],o=e[1],s=e[2],a=e[3],l=e[4],h=e[5],c=n[0],u=n[1],f=n[2],g=n[3],A=n[4],m=n[5];return t[0]=i*c+s*u,t[1]=o*c+a*u,t[2]=i*f+s*g,t[3]=o*f+a*g,t[4]=i*A+s*m+l,t[5]=o*A+a*m+h,t}function qm(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t[4]=e[4]-n[4],t[5]=e[5]-n[5],t}var Xm=Object.freeze({__proto__:null,add:function(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t[4]=e[4]+n[4],t[5]=e[5]+n[5],t},clone:function(t){var e=new Nm(6);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t},create:function(){var t=new Nm(6);return Nm!=Float32Array&&(t[1]=0,t[2]=0,t[4]=0,t[5]=0),t[0]=1,t[3]=1,t},determinant:function(t){return t[0]*t[3]-t[1]*t[2]},equals:function(t,e){var n=t[0],i=t[1],o=t[2],s=t[3],a=t[4],l=t[5],h=e[0],c=e[1],u=e[2],f=e[3],g=e[4],A=e[5];return Math.abs(n-h)<=Fm*Math.max(1,Math.abs(n),Math.abs(h))&&Math.abs(i-c)<=Fm*Math.max(1,Math.abs(i),Math.abs(c))&&Math.abs(o-u)<=Fm*Math.max(1,Math.abs(o),Math.abs(u))&&Math.abs(s-f)<=Fm*Math.max(1,Math.abs(s),Math.abs(f))&&Math.abs(a-g)<=Fm*Math.max(1,Math.abs(a),Math.abs(g))&&Math.abs(l-A)<=Fm*Math.max(1,Math.abs(l),Math.abs(A))},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]},frob:function(t){return Math.hypot(t[0],t[1],t[2],t[3],t[4],t[5],1)},fromRotation:function(t,e){var n=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=n,t[2]=-n,t[3]=i,t[4]=0,t[5]=0,t},fromScaling:function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t[4]=0,t[5]=0,t},fromTranslation:function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=e[0],t[5]=e[1],t},fromValues:function(t,e,n,i,o,s){var a=new Nm(6);return a[0]=t,a[1]=e,a[2]=n,a[3]=i,a[4]=o,a[5]=s,a},identity:function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t},invert:function(t,e){var n=e[0],i=e[1],o=e[2],s=e[3],a=e[4],l=e[5],h=n*s-i*o;return h?(t[0]=s*(h=1/h),t[1]=-i*h,t[2]=-o*h,t[3]=n*h,t[4]=(o*l-s*a)*h,t[5]=(i*a-n*l)*h,t):null},mul:Zm,multiply:Zm,multiplyScalar:function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*n,t[5]=e[5]*n,t},multiplyScalarAndAdd:function(t,e,n,i){return t[0]=e[0]+n[0]*i,t[1]=e[1]+n[1]*i,t[2]=e[2]+n[2]*i,t[3]=e[3]+n[3]*i,t[4]=e[4]+n[4]*i,t[5]=e[5]+n[5]*i,t},rotate:function(t,e,n){var i=e[0],o=e[1],s=e[2],a=e[3],l=e[4],h=e[5],c=Math.sin(n),u=Math.cos(n);return t[0]=i*u+s*c,t[1]=o*u+a*c,t[2]=i*-c+s*u,t[3]=o*-c+a*u,t[4]=l,t[5]=h,t},scale:function(t,e,n){var i=e[1],o=e[2],s=e[3],a=e[4],l=e[5],h=n[0],c=n[1];return t[0]=e[0]*h,t[1]=i*h,t[2]=o*c,t[3]=s*c,t[4]=a,t[5]=l,t},set:function(t,e,n,i,o,s,a){return t[0]=e,t[1]=n,t[2]=i,t[3]=o,t[4]=s,t[5]=a,t},str:function(t){return"mat2d("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+")"},sub:qm,subtract:qm,translate:function(t,e,n){var i=e[0],o=e[1],s=e[2],a=e[3],l=e[4],h=e[5],c=n[0],u=n[1];return t[0]=i,t[1]=o,t[2]=s,t[3]=a,t[4]=i*c+s*u+l,t[5]=o*c+a*u+h,t}});function Jm(){var t=new Nm(9);return Nm!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[5]=0,t[6]=0,t[7]=0),t[0]=1,t[4]=1,t[8]=1,t}function Qm(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t}function Ym(t,e,n,i,o,s,a,l,h,c){return t[0]=e,t[1]=n,t[2]=i,t[3]=o,t[4]=s,t[5]=a,t[6]=l,t[7]=h,t[8]=c,t}function Km(t,e){if(t===e){var n=e[1],i=e[2],o=e[5];t[1]=e[3],t[2]=e[6],t[3]=n,t[5]=e[7],t[6]=i,t[7]=o}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t}function $m(t,e){var n=e[0],i=e[1],o=e[2],s=e[3],a=e[4],l=e[5],h=e[6],c=e[7],u=e[8],f=u*a-l*c,g=-u*s+l*h,A=c*s-a*h,m=n*f+i*g+o*A;return m?(t[0]=f*(m=1/m),t[1]=(-u*i+o*c)*m,t[2]=(l*i-o*a)*m,t[3]=g*m,t[4]=(u*n-o*h)*m,t[5]=(-l*n+o*s)*m,t[6]=A*m,t[7]=(-c*n+i*h)*m,t[8]=(a*n-i*s)*m,t):null}function ty(t,e,n){var i=e[0],o=e[1],s=e[2],a=e[3],l=e[4],h=e[5],c=e[6],u=e[7],f=e[8],g=n[0],A=n[1],m=n[2],w=n[3],T=n[4],M=n[5],C=n[6],P=n[7],I=n[8];return t[0]=g*i+A*a+m*c,t[1]=g*o+A*l+m*u,t[2]=g*s+A*h+m*f,t[3]=w*i+T*a+M*c,t[4]=w*o+T*l+M*u,t[5]=w*s+T*h+M*f,t[6]=C*i+P*a+I*c,t[7]=C*o+P*l+I*u,t[8]=C*s+P*h+I*f,t}function ey(t,e){var n=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=n,t[2]=0,t[3]=-n,t[4]=i,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function ny(t,e){var n=e[0],i=e[1],o=e[2],s=e[3],a=n+n,l=i+i,h=o+o,c=n*a,u=i*a,f=i*l,g=o*a,A=o*l,m=o*h,w=s*a,T=s*l,M=s*h;return t[0]=1-f-m,t[3]=u-M,t[6]=g+T,t[1]=u+M,t[4]=1-c-m,t[7]=A-w,t[2]=g-T,t[5]=A+w,t[8]=1-c-f,t}function iy(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t[4]=e[4]-n[4],t[5]=e[5]-n[5],t[6]=e[6]-n[6],t[7]=e[7]-n[7],t[8]=e[8]-n[8],t}var ry=Object.freeze({__proto__:null,add:function(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t[4]=e[4]+n[4],t[5]=e[5]+n[5],t[6]=e[6]+n[6],t[7]=e[7]+n[7],t[8]=e[8]+n[8],t},adjoint:function(t,e){var n=e[0],i=e[1],o=e[2],s=e[3],a=e[4],l=e[5],h=e[6],c=e[7],u=e[8];return t[0]=a*u-l*c,t[1]=o*c-i*u,t[2]=i*l-o*a,t[3]=l*h-s*u,t[4]=n*u-o*h,t[5]=o*s-n*l,t[6]=s*c-a*h,t[7]=i*h-n*c,t[8]=n*a-i*s,t},clone:function(t){var e=new Nm(9);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},create:Jm,determinant:function(t){var e=t[3],n=t[4],i=t[5],o=t[6],s=t[7],a=t[8];return t[0]*(a*n-i*s)+t[1]*(-a*e+i*o)+t[2]*(s*e-n*o)},equals:function(t,e){var n=t[0],i=t[1],o=t[2],s=t[3],a=t[4],l=t[5],h=t[6],c=t[7],u=t[8],f=e[0],g=e[1],A=e[2],m=e[3],w=e[4],T=e[5],M=e[6],C=e[7],P=e[8];return Math.abs(n-f)<=Fm*Math.max(1,Math.abs(n),Math.abs(f))&&Math.abs(i-g)<=Fm*Math.max(1,Math.abs(i),Math.abs(g))&&Math.abs(o-A)<=Fm*Math.max(1,Math.abs(o),Math.abs(A))&&Math.abs(s-m)<=Fm*Math.max(1,Math.abs(s),Math.abs(m))&&Math.abs(a-w)<=Fm*Math.max(1,Math.abs(a),Math.abs(w))&&Math.abs(l-T)<=Fm*Math.max(1,Math.abs(l),Math.abs(T))&&Math.abs(h-M)<=Fm*Math.max(1,Math.abs(h),Math.abs(M))&&Math.abs(c-C)<=Fm*Math.max(1,Math.abs(c),Math.abs(C))&&Math.abs(u-P)<=Fm*Math.max(1,Math.abs(u),Math.abs(P))},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]},frob:function(t){return Math.hypot(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8])},fromMat2d:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=0,t[3]=e[2],t[4]=e[3],t[5]=0,t[6]=e[4],t[7]=e[5],t[8]=1,t},fromMat4:Qm,fromQuat:ny,fromRotation:ey,fromScaling:function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=e[1],t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},fromTranslation:function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=e[0],t[7]=e[1],t[8]=1,t},fromValues:function(t,e,n,i,o,s,a,l,h){var c=new Nm(9);return c[0]=t,c[1]=e,c[2]=n,c[3]=i,c[4]=o,c[5]=s,c[6]=a,c[7]=l,c[8]=h,c},identity:function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},invert:$m,mul:ty,multiply:ty,multiplyScalar:function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*n,t[5]=e[5]*n,t[6]=e[6]*n,t[7]=e[7]*n,t[8]=e[8]*n,t},multiplyScalarAndAdd:function(t,e,n,i){return t[0]=e[0]+n[0]*i,t[1]=e[1]+n[1]*i,t[2]=e[2]+n[2]*i,t[3]=e[3]+n[3]*i,t[4]=e[4]+n[4]*i,t[5]=e[5]+n[5]*i,t[6]=e[6]+n[6]*i,t[7]=e[7]+n[7]*i,t[8]=e[8]+n[8]*i,t},normalFromMat4:function(t,e){var n=e[0],i=e[1],o=e[2],s=e[3],a=e[4],l=e[5],h=e[6],c=e[7],u=e[8],f=e[9],g=e[10],A=e[11],m=e[12],w=e[13],T=e[14],M=e[15],C=n*l-i*a,P=n*h-o*a,I=n*c-s*a,O=i*h-o*l,E=i*c-s*l,D=o*c-s*h,N=u*w-f*m,H=u*T-g*m,U=u*M-A*m,W=f*T-g*w,q=f*M-A*w,X=g*M-A*T,J=C*X-P*q+I*W+O*U-E*H+D*N;return J?(t[0]=(l*X-h*q+c*W)*(J=1/J),t[1]=(h*U-a*X-c*H)*J,t[2]=(a*q-l*U+c*N)*J,t[3]=(o*q-i*X-s*W)*J,t[4]=(n*X-o*U+s*H)*J,t[5]=(i*U-n*q-s*N)*J,t[6]=(w*D-T*E+M*O)*J,t[7]=(T*I-m*D-M*P)*J,t[8]=(m*E-w*I+M*C)*J,t):null},projection:function(t,e,n){return t[0]=2/e,t[1]=0,t[2]=0,t[3]=0,t[4]=-2/n,t[5]=0,t[6]=-1,t[7]=1,t[8]=1,t},rotate:function(t,e,n){var i=e[0],o=e[1],s=e[2],a=e[3],l=e[4],h=e[5],c=e[6],u=e[7],f=e[8],g=Math.sin(n),A=Math.cos(n);return t[0]=A*i+g*a,t[1]=A*o+g*l,t[2]=A*s+g*h,t[3]=A*a-g*i,t[4]=A*l-g*o,t[5]=A*h-g*s,t[6]=c,t[7]=u,t[8]=f,t},scale:function(t,e,n){var i=n[0],o=n[1];return t[0]=i*e[0],t[1]=i*e[1],t[2]=i*e[2],t[3]=o*e[3],t[4]=o*e[4],t[5]=o*e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},set:Ym,str:function(t){return"mat3("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+")"},sub:iy,subtract:iy,translate:function(t,e,n){var i=e[0],o=e[1],s=e[2],a=e[3],l=e[4],h=e[5],c=e[6],u=e[7],f=e[8],g=n[0],A=n[1];return t[0]=i,t[1]=o,t[2]=s,t[3]=a,t[4]=l,t[5]=h,t[6]=g*i+A*a+c,t[7]=g*o+A*l+u,t[8]=g*s+A*h+f,t},transpose:Km});function oy(){var t=new Nm(16);return Nm!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function sy(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function ay(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function ly(t,e){if(t===e){var n=e[1],i=e[2],o=e[3],s=e[6],a=e[7],l=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=n,t[6]=e[9],t[7]=e[13],t[8]=i,t[9]=s,t[11]=e[14],t[12]=o,t[13]=a,t[14]=l}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t}function hy(t,e){var n=e[0],i=e[1],o=e[2],s=e[3],a=e[4],l=e[5],h=e[6],c=e[7],u=e[8],f=e[9],g=e[10],A=e[11],m=e[12],w=e[13],T=e[14],M=e[15],C=n*l-i*a,P=n*h-o*a,I=n*c-s*a,O=i*h-o*l,E=i*c-s*l,D=o*c-s*h,N=u*w-f*m,H=u*T-g*m,U=u*M-A*m,W=f*T-g*w,q=f*M-A*w,X=g*M-A*T,J=C*X-P*q+I*W+O*U-E*H+D*N;return J?(t[0]=(l*X-h*q+c*W)*(J=1/J),t[1]=(o*q-i*X-s*W)*J,t[2]=(w*D-T*E+M*O)*J,t[3]=(g*E-f*D-A*O)*J,t[4]=(h*U-a*X-c*H)*J,t[5]=(n*X-o*U+s*H)*J,t[6]=(T*I-m*D-M*P)*J,t[7]=(u*D-g*I+A*P)*J,t[8]=(a*q-l*U+c*N)*J,t[9]=(i*U-n*q-s*N)*J,t[10]=(m*E-w*I+M*C)*J,t[11]=(f*I-u*E-A*C)*J,t[12]=(l*H-a*W-h*N)*J,t[13]=(n*W-i*H+o*N)*J,t[14]=(w*P-m*O-T*C)*J,t[15]=(u*O-f*P+g*C)*J,t):null}function cy(t,e,n){var i=e[0],o=e[1],s=e[2],a=e[3],l=e[4],h=e[5],c=e[6],u=e[7],f=e[8],g=e[9],A=e[10],m=e[11],w=e[12],T=e[13],M=e[14],C=e[15],P=n[0],I=n[1],O=n[2],E=n[3];return t[0]=P*i+I*l+O*f+E*w,t[1]=P*o+I*h+O*g+E*T,t[2]=P*s+I*c+O*A+E*M,t[3]=P*a+I*u+O*m+E*C,t[4]=(P=n[4])*i+(I=n[5])*l+(O=n[6])*f+(E=n[7])*w,t[5]=P*o+I*h+O*g+E*T,t[6]=P*s+I*c+O*A+E*M,t[7]=P*a+I*u+O*m+E*C,t[8]=(P=n[8])*i+(I=n[9])*l+(O=n[10])*f+(E=n[11])*w,t[9]=P*o+I*h+O*g+E*T,t[10]=P*s+I*c+O*A+E*M,t[11]=P*a+I*u+O*m+E*C,t[12]=(P=n[12])*i+(I=n[13])*l+(O=n[14])*f+(E=n[15])*w,t[13]=P*o+I*h+O*g+E*T,t[14]=P*s+I*c+O*A+E*M,t[15]=P*a+I*u+O*m+E*C,t}function uy(t,e,n){var i,o,s,a,l,h,c,u,f,g,A,m,w=n[0],T=n[1],M=n[2];return e===t?(t[12]=e[0]*w+e[4]*T+e[8]*M+e[12],t[13]=e[1]*w+e[5]*T+e[9]*M+e[13],t[14]=e[2]*w+e[6]*T+e[10]*M+e[14],t[15]=e[3]*w+e[7]*T+e[11]*M+e[15]):(o=e[1],s=e[2],a=e[3],l=e[4],h=e[5],c=e[6],u=e[7],f=e[8],g=e[9],A=e[10],m=e[11],t[0]=i=e[0],t[1]=o,t[2]=s,t[3]=a,t[4]=l,t[5]=h,t[6]=c,t[7]=u,t[8]=f,t[9]=g,t[10]=A,t[11]=m,t[12]=i*w+l*T+f*M+e[12],t[13]=o*w+h*T+g*M+e[13],t[14]=s*w+c*T+A*M+e[14],t[15]=a*w+u*T+m*M+e[15]),t}function fy(t,e,n){var i=n[0],o=n[1],s=n[2];return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t[4]=e[4]*o,t[5]=e[5]*o,t[6]=e[6]*o,t[7]=e[7]*o,t[8]=e[8]*s,t[9]=e[9]*s,t[10]=e[10]*s,t[11]=e[11]*s,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function dy(t,e,n,i){var o,s,a,l,h,c,u,f,g,A,m,w,T,M,C,P,I,O,E,D,N,H,U,W,q=i[0],X=i[1],J=i[2],Q=Math.hypot(q,X,J);return Q<Fm?null:(q*=Q=1/Q,X*=Q,J*=Q,o=Math.sin(n),s=Math.cos(n),h=e[1],c=e[2],u=e[3],g=e[5],A=e[6],m=e[7],T=e[9],M=e[10],C=e[11],E=q*X*(a=1-s)-J*o,D=X*X*a+s,N=J*X*a+q*o,H=q*J*a+X*o,U=X*J*a-q*o,W=J*J*a+s,t[0]=(l=e[0])*(P=q*q*a+s)+(f=e[4])*(I=X*q*a+J*o)+(w=e[8])*(O=J*q*a-X*o),t[1]=h*P+g*I+T*O,t[2]=c*P+A*I+M*O,t[3]=u*P+m*I+C*O,t[4]=l*E+f*D+w*N,t[5]=h*E+g*D+T*N,t[6]=c*E+A*D+M*N,t[7]=u*E+m*D+C*N,t[8]=l*H+f*U+w*W,t[9]=h*H+g*U+T*W,t[10]=c*H+A*U+M*W,t[11]=u*H+m*U+C*W,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t)}function gy(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t}function py(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Ay(t,e,n){var i,o,s,a=n[0],l=n[1],h=n[2],c=Math.hypot(a,l,h);return c<Fm?null:(a*=c=1/c,l*=c,h*=c,i=Math.sin(e),o=Math.cos(e),t[0]=a*a*(s=1-o)+o,t[1]=l*a*s+h*i,t[2]=h*a*s-l*i,t[3]=0,t[4]=a*l*s-h*i,t[5]=l*l*s+o,t[6]=h*l*s+a*i,t[7]=0,t[8]=a*h*s+l*i,t[9]=l*h*s-a*i,t[10]=h*h*s+o,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t)}function my(t,e,n){var i=e[0],o=e[1],s=e[2],a=e[3],l=i+i,h=o+o,c=s+s,u=i*l,f=i*h,g=i*c,A=o*h,m=o*c,w=s*c,T=a*l,M=a*h,C=a*c;return t[0]=1-(A+w),t[1]=f+C,t[2]=g-M,t[3]=0,t[4]=f-C,t[5]=1-(u+w),t[6]=m+T,t[7]=0,t[8]=g+M,t[9]=m-T,t[10]=1-(u+A),t[11]=0,t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=1,t}function yy(t,e){return t[0]=e[12],t[1]=e[13],t[2]=e[14],t}function _y(t,e){var n=e[4],i=e[5],o=e[6],s=e[8],a=e[9],l=e[10];return t[0]=Math.hypot(e[0],e[1],e[2]),t[1]=Math.hypot(n,i,o),t[2]=Math.hypot(s,a,l),t}function vy(t,e){var n=new Nm(3);_y(n,e);var i=1/n[0],o=1/n[1],s=1/n[2],a=e[0]*i,l=e[1]*o,h=e[2]*s,c=e[4]*i,u=e[5]*o,f=e[6]*s,g=e[8]*i,A=e[9]*o,m=e[10]*s,w=a+u+m,T=0;return w>0?(T=2*Math.sqrt(w+1),t[3]=.25*T,t[0]=(f-A)/T,t[1]=(g-h)/T,t[2]=(l-c)/T):a>u&&a>m?(T=2*Math.sqrt(1+a-u-m),t[3]=(f-A)/T,t[0]=.25*T,t[1]=(l+c)/T,t[2]=(g+h)/T):u>m?(T=2*Math.sqrt(1+u-a-m),t[3]=(g-h)/T,t[0]=(l+c)/T,t[1]=.25*T,t[2]=(f+A)/T):(T=2*Math.sqrt(1+m-a-u),t[3]=(l-c)/T,t[0]=(g+h)/T,t[1]=(f+A)/T,t[2]=.25*T),t}function xy(t,e,n,i){var o=e[0],s=e[1],a=e[2],l=e[3],h=o+o,c=s+s,u=a+a,f=o*h,g=o*c,A=o*u,m=s*c,w=s*u,T=a*u,M=l*h,C=l*c,P=l*u,I=i[0],O=i[1],E=i[2];return t[0]=(1-(m+T))*I,t[1]=(g+P)*I,t[2]=(A-C)*I,t[3]=0,t[4]=(g-P)*O,t[5]=(1-(f+T))*O,t[6]=(w+M)*O,t[7]=0,t[8]=(A+C)*E,t[9]=(w-M)*E,t[10]=(1-(f+m))*E,t[11]=0,t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=1,t}function by(t,e){var n=e[0],i=e[1],o=e[2],s=e[3],a=n+n,l=i+i,h=o+o,c=n*a,u=i*a,f=i*l,g=o*a,A=o*l,m=o*h,w=s*a,T=s*l,M=s*h;return t[0]=1-f-m,t[1]=u+M,t[2]=g-T,t[3]=0,t[4]=u-M,t[5]=1-c-m,t[6]=A+w,t[7]=0,t[8]=g+T,t[9]=A-w,t[10]=1-c-f,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function wy(t,e,n,i,o){var s,a=1/Math.tan(e/2);return t[0]=a/n,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=a,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=o&&o!==1/0?(t[10]=(o+i)*(s=1/(i-o)),t[14]=2*o*i*s):(t[10]=-1,t[14]=-2*i),t}var Ty=wy;function My(t,e,n,i,o,s,a){var l=1/(e-n),h=1/(i-o),c=1/(s-a);return t[0]=-2*l,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*h,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*c,t[11]=0,t[12]=(e+n)*l,t[13]=(o+i)*h,t[14]=(a+s)*c,t[15]=1,t}var Cy=My;function Sy(t,e,n,i){var o,s,a,l,h,c,u,f,g,A,m=e[0],w=e[1],T=e[2],M=i[0],C=i[1],P=i[2],I=n[0],O=n[1],E=n[2];return Math.abs(m-I)<Fm&&Math.abs(w-O)<Fm&&Math.abs(T-E)<Fm?ay(t):(u=m-I,f=w-O,g=T-E,o=C*(g*=A=1/Math.hypot(u,f,g))-P*(f*=A),s=P*(u*=A)-M*g,a=M*f-C*u,(A=Math.hypot(o,s,a))?(o*=A=1/A,s*=A,a*=A):(o=0,s=0,a=0),l=f*a-g*s,h=g*o-u*a,c=u*s-f*o,(A=Math.hypot(l,h,c))?(l*=A=1/A,h*=A,c*=A):(l=0,h=0,c=0),t[0]=o,t[1]=l,t[2]=u,t[3]=0,t[4]=s,t[5]=h,t[6]=f,t[7]=0,t[8]=a,t[9]=c,t[10]=g,t[11]=0,t[12]=-(o*m+s*w+a*T),t[13]=-(l*m+h*w+c*T),t[14]=-(u*m+f*w+g*T),t[15]=1,t)}function Py(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t[4]=e[4]-n[4],t[5]=e[5]-n[5],t[6]=e[6]-n[6],t[7]=e[7]-n[7],t[8]=e[8]-n[8],t[9]=e[9]-n[9],t[10]=e[10]-n[10],t[11]=e[11]-n[11],t[12]=e[12]-n[12],t[13]=e[13]-n[13],t[14]=e[14]-n[14],t[15]=e[15]-n[15],t}function Iy(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]}var Oy=cy,Ey=Object.freeze({__proto__:null,add:function(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t[4]=e[4]+n[4],t[5]=e[5]+n[5],t[6]=e[6]+n[6],t[7]=e[7]+n[7],t[8]=e[8]+n[8],t[9]=e[9]+n[9],t[10]=e[10]+n[10],t[11]=e[11]+n[11],t[12]=e[12]+n[12],t[13]=e[13]+n[13],t[14]=e[14]+n[14],t[15]=e[15]+n[15],t},adjoint:function(t,e){var n=e[0],i=e[1],o=e[2],s=e[3],a=e[4],l=e[5],h=e[6],c=e[7],u=e[8],f=e[9],g=e[10],A=e[11],m=e[12],w=e[13],T=e[14],M=e[15];return t[0]=l*(g*M-A*T)-f*(h*M-c*T)+w*(h*A-c*g),t[1]=-(i*(g*M-A*T)-f*(o*M-s*T)+w*(o*A-s*g)),t[2]=i*(h*M-c*T)-l*(o*M-s*T)+w*(o*c-s*h),t[3]=-(i*(h*A-c*g)-l*(o*A-s*g)+f*(o*c-s*h)),t[4]=-(a*(g*M-A*T)-u*(h*M-c*T)+m*(h*A-c*g)),t[5]=n*(g*M-A*T)-u*(o*M-s*T)+m*(o*A-s*g),t[6]=-(n*(h*M-c*T)-a*(o*M-s*T)+m*(o*c-s*h)),t[7]=n*(h*A-c*g)-a*(o*A-s*g)+u*(o*c-s*h),t[8]=a*(f*M-A*w)-u*(l*M-c*w)+m*(l*A-c*f),t[9]=-(n*(f*M-A*w)-u*(i*M-s*w)+m*(i*A-s*f)),t[10]=n*(l*M-c*w)-a*(i*M-s*w)+m*(i*c-s*l),t[11]=-(n*(l*A-c*f)-a*(i*A-s*f)+u*(i*c-s*l)),t[12]=-(a*(f*T-g*w)-u*(l*T-h*w)+m*(l*g-h*f)),t[13]=n*(f*T-g*w)-u*(i*T-o*w)+m*(i*g-o*f),t[14]=-(n*(l*T-h*w)-a*(i*T-o*w)+m*(i*h-o*l)),t[15]=n*(l*g-h*f)-a*(i*g-o*f)+u*(i*h-o*l),t},clone:function(t){var e=new Nm(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},copy:sy,create:oy,determinant:function(t){var e=t[0],n=t[1],i=t[2],o=t[3],s=t[4],a=t[5],l=t[6],h=t[7],c=t[8],u=t[9],f=t[10],g=t[11],A=t[12],m=t[13],w=t[14],T=t[15];return(e*a-n*s)*(f*T-g*w)-(e*l-i*s)*(u*T-g*m)+(e*h-o*s)*(u*w-f*m)+(n*l-i*a)*(c*T-g*A)-(n*h-o*a)*(c*w-f*A)+(i*h-o*l)*(c*m-u*A)},equals:function(t,e){var n=t[0],i=t[1],o=t[2],s=t[3],a=t[4],l=t[5],h=t[6],c=t[7],u=t[8],f=t[9],g=t[10],A=t[11],m=t[12],w=t[13],T=t[14],M=t[15],C=e[0],P=e[1],I=e[2],O=e[3],E=e[4],D=e[5],N=e[6],H=e[7],U=e[8],W=e[9],q=e[10],X=e[11],J=e[12],Q=e[13],Y=e[14],K=e[15];return Math.abs(n-C)<=Fm*Math.max(1,Math.abs(n),Math.abs(C))&&Math.abs(i-P)<=Fm*Math.max(1,Math.abs(i),Math.abs(P))&&Math.abs(o-I)<=Fm*Math.max(1,Math.abs(o),Math.abs(I))&&Math.abs(s-O)<=Fm*Math.max(1,Math.abs(s),Math.abs(O))&&Math.abs(a-E)<=Fm*Math.max(1,Math.abs(a),Math.abs(E))&&Math.abs(l-D)<=Fm*Math.max(1,Math.abs(l),Math.abs(D))&&Math.abs(h-N)<=Fm*Math.max(1,Math.abs(h),Math.abs(N))&&Math.abs(c-H)<=Fm*Math.max(1,Math.abs(c),Math.abs(H))&&Math.abs(u-U)<=Fm*Math.max(1,Math.abs(u),Math.abs(U))&&Math.abs(f-W)<=Fm*Math.max(1,Math.abs(f),Math.abs(W))&&Math.abs(g-q)<=Fm*Math.max(1,Math.abs(g),Math.abs(q))&&Math.abs(A-X)<=Fm*Math.max(1,Math.abs(A),Math.abs(X))&&Math.abs(m-J)<=Fm*Math.max(1,Math.abs(m),Math.abs(J))&&Math.abs(w-Q)<=Fm*Math.max(1,Math.abs(w),Math.abs(Q))&&Math.abs(T-Y)<=Fm*Math.max(1,Math.abs(T),Math.abs(Y))&&Math.abs(M-K)<=Fm*Math.max(1,Math.abs(M),Math.abs(K))},exactEquals:Iy,frob:function(t){return Math.hypot(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15])},fromQuat:by,fromQuat2:function(t,e){var n=new Nm(3),i=-e[0],o=-e[1],s=-e[2],a=e[3],l=e[4],h=e[5],c=e[6],u=e[7],f=i*i+o*o+s*s+a*a;return f>0?(n[0]=2*(l*a+u*i+h*s-c*o)/f,n[1]=2*(h*a+u*o+c*i-l*s)/f,n[2]=2*(c*a+u*s+l*o-h*i)/f):(n[0]=2*(l*a+u*i+h*s-c*o),n[1]=2*(h*a+u*o+c*i-l*s),n[2]=2*(c*a+u*s+l*o-h*i)),my(t,e,n),t},fromRotation:Ay,fromRotationTranslation:my,fromRotationTranslationScale:xy,fromRotationTranslationScaleOrigin:function(t,e,n,i,o){var s=e[0],a=e[1],l=e[2],h=e[3],c=s+s,u=a+a,f=l+l,g=s*c,A=s*u,m=s*f,w=a*u,T=a*f,M=l*f,C=h*c,P=h*u,I=h*f,O=i[0],E=i[1],D=i[2],N=o[0],H=o[1],U=o[2],W=(1-(w+M))*O,q=(A+I)*O,X=(m-P)*O,J=(A-I)*E,Q=(1-(g+M))*E,Y=(T+C)*E,K=(m+P)*D,$=(T-C)*D,tt=(1-(g+w))*D;return t[0]=W,t[1]=q,t[2]=X,t[3]=0,t[4]=J,t[5]=Q,t[6]=Y,t[7]=0,t[8]=K,t[9]=$,t[10]=tt,t[11]=0,t[12]=n[0]+N-(W*N+J*H+K*U),t[13]=n[1]+H-(q*N+Q*H+$*U),t[14]=n[2]+U-(X*N+Y*H+tt*U),t[15]=1,t},fromScaling:py,fromTranslation:gy,fromValues:function(t,e,n,i,o,s,a,l,h,c,u,f,g,A,m,w){var T=new Nm(16);return T[0]=t,T[1]=e,T[2]=n,T[3]=i,T[4]=o,T[5]=s,T[6]=a,T[7]=l,T[8]=h,T[9]=c,T[10]=u,T[11]=f,T[12]=g,T[13]=A,T[14]=m,T[15]=w,T},fromXRotation:function(t,e){var n=Math.sin(e),i=Math.cos(e);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=i,t[6]=n,t[7]=0,t[8]=0,t[9]=-n,t[10]=i,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},fromYRotation:function(t,e){var n=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=0,t[2]=-n,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=n,t[9]=0,t[10]=i,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},fromZRotation:function(t,e){var n=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=n,t[2]=0,t[3]=0,t[4]=-n,t[5]=i,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},frustum:function(t,e,n,i,o,s,a){var l=1/(n-e),h=1/(o-i),c=1/(s-a);return t[0]=2*s*l,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*s*h,t[6]=0,t[7]=0,t[8]=(n+e)*l,t[9]=(o+i)*h,t[10]=(a+s)*c,t[11]=-1,t[12]=0,t[13]=0,t[14]=a*s*2*c,t[15]=0,t},getRotation:vy,getScaling:_y,getTranslation:yy,identity:ay,invert:hy,lookAt:Sy,mul:Oy,multiply:cy,multiplyScalar:function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*n,t[5]=e[5]*n,t[6]=e[6]*n,t[7]=e[7]*n,t[8]=e[8]*n,t[9]=e[9]*n,t[10]=e[10]*n,t[11]=e[11]*n,t[12]=e[12]*n,t[13]=e[13]*n,t[14]=e[14]*n,t[15]=e[15]*n,t},multiplyScalarAndAdd:function(t,e,n,i){return t[0]=e[0]+n[0]*i,t[1]=e[1]+n[1]*i,t[2]=e[2]+n[2]*i,t[3]=e[3]+n[3]*i,t[4]=e[4]+n[4]*i,t[5]=e[5]+n[5]*i,t[6]=e[6]+n[6]*i,t[7]=e[7]+n[7]*i,t[8]=e[8]+n[8]*i,t[9]=e[9]+n[9]*i,t[10]=e[10]+n[10]*i,t[11]=e[11]+n[11]*i,t[12]=e[12]+n[12]*i,t[13]=e[13]+n[13]*i,t[14]=e[14]+n[14]*i,t[15]=e[15]+n[15]*i,t},ortho:Cy,orthoNO:My,orthoZO:function(t,e,n,i,o,s,a){var l=1/(e-n),h=1/(i-o),c=1/(s-a);return t[0]=-2*l,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*h,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=c,t[11]=0,t[12]=(e+n)*l,t[13]=(o+i)*h,t[14]=s*c,t[15]=1,t},perspective:Ty,perspectiveFromFieldOfView:function(t,e,n,i){var o=Math.tan(e.upDegrees*Math.PI/180),s=Math.tan(e.downDegrees*Math.PI/180),a=Math.tan(e.leftDegrees*Math.PI/180),l=Math.tan(e.rightDegrees*Math.PI/180),h=2/(a+l),c=2/(o+s);return t[0]=h,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=c,t[6]=0,t[7]=0,t[8]=-(a-l)*h*.5,t[9]=(o-s)*c*.5,t[10]=i/(n-i),t[11]=-1,t[12]=0,t[13]=0,t[14]=i*n/(n-i),t[15]=0,t},perspectiveNO:wy,perspectiveZO:function(t,e,n,i,o){var s,a=1/Math.tan(e/2);return t[0]=a/n,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=a,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=o&&o!==1/0?(t[10]=o*(s=1/(i-o)),t[14]=o*i*s):(t[10]=-1,t[14]=-i),t},rotate:dy,rotateX:function(t,e,n){var i=Math.sin(n),o=Math.cos(n),s=e[4],a=e[5],l=e[6],h=e[7],c=e[8],u=e[9],f=e[10],g=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=s*o+c*i,t[5]=a*o+u*i,t[6]=l*o+f*i,t[7]=h*o+g*i,t[8]=c*o-s*i,t[9]=u*o-a*i,t[10]=f*o-l*i,t[11]=g*o-h*i,t},rotateY:function(t,e,n){var i=Math.sin(n),o=Math.cos(n),s=e[0],a=e[1],l=e[2],h=e[3],c=e[8],u=e[9],f=e[10],g=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=s*o-c*i,t[1]=a*o-u*i,t[2]=l*o-f*i,t[3]=h*o-g*i,t[8]=s*i+c*o,t[9]=a*i+u*o,t[10]=l*i+f*o,t[11]=h*i+g*o,t},rotateZ:function(t,e,n){var i=Math.sin(n),o=Math.cos(n),s=e[0],a=e[1],l=e[2],h=e[3],c=e[4],u=e[5],f=e[6],g=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=s*o+c*i,t[1]=a*o+u*i,t[2]=l*o+f*i,t[3]=h*o+g*i,t[4]=c*o-s*i,t[5]=u*o-a*i,t[6]=f*o-l*i,t[7]=g*o-h*i,t},scale:fy,set:function(t,e,n,i,o,s,a,l,h,c,u,f,g,A,m,w,T){return t[0]=e,t[1]=n,t[2]=i,t[3]=o,t[4]=s,t[5]=a,t[6]=l,t[7]=h,t[8]=c,t[9]=u,t[10]=f,t[11]=g,t[12]=A,t[13]=m,t[14]=w,t[15]=T,t},str:function(t){return"mat4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+")"},sub:Py,subtract:Py,targetTo:function(t,e,n,i){var o=e[0],s=e[1],a=e[2],l=i[0],h=i[1],c=i[2],u=o-n[0],f=s-n[1],g=a-n[2],A=u*u+f*f+g*g;A>0&&(u*=A=1/Math.sqrt(A),f*=A,g*=A);var m=h*g-c*f,w=c*u-l*g,T=l*f-h*u;return(A=m*m+w*w+T*T)>0&&(m*=A=1/Math.sqrt(A),w*=A,T*=A),t[0]=m,t[1]=w,t[2]=T,t[3]=0,t[4]=f*T-g*w,t[5]=g*m-u*T,t[6]=u*w-f*m,t[7]=0,t[8]=u,t[9]=f,t[10]=g,t[11]=0,t[12]=o,t[13]=s,t[14]=a,t[15]=1,t},translate:uy,transpose:ly});function ky(){var t=new Nm(3);return Nm!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function Ry(t){return Math.hypot(t[0],t[1],t[2])}function Ly(t,e,n){var i=new Nm(3);return i[0]=t,i[1]=e,i[2]=n,i}function Dy(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function Fy(t,e,n,i){return t[0]=e,t[1]=n,t[2]=i,t}function Ny(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t}function Hy(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t}function By(t,e,n){return t[0]=e[0]*n[0],t[1]=e[1]*n[1],t[2]=e[2]*n[2],t}function zy(t,e,n){return t[0]=e[0]/n[0],t[1]=e[1]/n[1],t[2]=e[2]/n[2],t}function Gy(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}function jy(t,e,n,i){return t[0]=e[0]+n[0]*i,t[1]=e[1]+n[1]*i,t[2]=e[2]+n[2]*i,t}function Uy(t,e){return Math.hypot(e[0]-t[0],e[1]-t[1],e[2]-t[2])}function Vy(t,e){var n=e[0]-t[0],i=e[1]-t[1],o=e[2]-t[2];return n*n+i*i+o*o}function Wy(t){var e=t[0],n=t[1],i=t[2];return e*e+n*n+i*i}function Zy(t,e){var n=e[0],i=e[1],o=e[2],s=n*n+i*i+o*o;return s>0&&(s=1/Math.sqrt(s)),t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s,t}function qy(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function Xy(t,e,n){var i=e[0],o=e[1],s=e[2],a=n[0],l=n[1],h=n[2];return t[0]=o*h-s*l,t[1]=s*a-i*h,t[2]=i*l-o*a,t}function Jy(t,e,n){var i=e[0],o=e[1],s=e[2],a=n[3]*i+n[7]*o+n[11]*s+n[15];return t[0]=(n[0]*i+n[4]*o+n[8]*s+n[12])/(a=a||1),t[1]=(n[1]*i+n[5]*o+n[9]*s+n[13])/a,t[2]=(n[2]*i+n[6]*o+n[10]*s+n[14])/a,t}function Qy(t,e,n,i){var o=[],s=[];return o[0]=e[0]-n[0],o[1]=e[1]-n[1],o[2]=e[2]-n[2],s[0]=o[0]*Math.cos(i)-o[1]*Math.sin(i),s[1]=o[0]*Math.sin(i)+o[1]*Math.cos(i),s[2]=o[2],t[0]=s[0]+n[0],t[1]=s[1]+n[1],t[2]=s[2]+n[2],t}function Yy(t,e){var n=t[0],i=t[1],o=t[2],s=e[0],a=e[1],l=e[2],h=Math.sqrt(n*n+i*i+o*o)*Math.sqrt(s*s+a*a+l*l),c=h&&qy(t,e)/h;return Math.acos(Math.min(Math.max(c,-1),1))}function Ky(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]}function $y(t,e){var n=t[0],i=t[1],o=t[2],s=e[0],a=e[1],l=e[2];return Math.abs(n-s)<=Fm*Math.max(1,Math.abs(n),Math.abs(s))&&Math.abs(i-a)<=Fm*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(o-l)<=Fm*Math.max(1,Math.abs(o),Math.abs(l))}var t_,e_=Hy,n_=By,i_=zy,r_=Uy,o_=Vy,s_=Ry,a_=Wy,l_=(t_=ky(),function(t,e,n,i,o,s){var a,l;for(e||(e=3),n||(n=0),l=i?Math.min(i*e+n,t.length):t.length,a=n;a<l;a+=e)t_[0]=t[a],t_[1]=t[a+1],t_[2]=t[a+2],o(t_,t_,s),t[a]=t_[0],t[a+1]=t_[1],t[a+2]=t_[2];return t}),h_=Object.freeze({__proto__:null,add:Ny,angle:Yy,bezier:function(t,e,n,i,o,s){var a=1-s,l=a*a,h=s*s,c=l*a,u=3*s*l,f=3*h*a,g=h*s;return t[0]=e[0]*c+n[0]*u+i[0]*f+o[0]*g,t[1]=e[1]*c+n[1]*u+i[1]*f+o[1]*g,t[2]=e[2]*c+n[2]*u+i[2]*f+o[2]*g,t},ceil:function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t},clone:function(t){var e=new Nm(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},copy:Dy,create:ky,cross:Xy,dist:r_,distance:Uy,div:i_,divide:zy,dot:qy,equals:$y,exactEquals:Ky,floor:function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t},forEach:l_,fromValues:Ly,hermite:function(t,e,n,i,o,s){var a=s*s,l=a*(2*s-3)+1,h=a*(s-2)+s,c=a*(s-1),u=a*(3-2*s);return t[0]=e[0]*l+n[0]*h+i[0]*c+o[0]*u,t[1]=e[1]*l+n[1]*h+i[1]*c+o[1]*u,t[2]=e[2]*l+n[2]*h+i[2]*c+o[2]*u,t},inverse:function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t},len:s_,length:Ry,lerp:function(t,e,n,i){var o=e[0],s=e[1],a=e[2];return t[0]=o+i*(n[0]-o),t[1]=s+i*(n[1]-s),t[2]=a+i*(n[2]-a),t},max:function(t,e,n){return t[0]=Math.max(e[0],n[0]),t[1]=Math.max(e[1],n[1]),t[2]=Math.max(e[2],n[2]),t},min:function(t,e,n){return t[0]=Math.min(e[0],n[0]),t[1]=Math.min(e[1],n[1]),t[2]=Math.min(e[2],n[2]),t},mul:n_,multiply:By,negate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},normalize:Zy,random:function(t,e){e=e||1;var n=2*Hm()*Math.PI,i=2*Hm()-1,o=Math.sqrt(1-i*i)*e;return t[0]=Math.cos(n)*o,t[1]=Math.sin(n)*o,t[2]=i*e,t},rotateX:function(t,e,n,i){var o=[],s=[];return o[0]=e[0]-n[0],o[1]=e[1]-n[1],o[2]=e[2]-n[2],s[0]=o[0],s[1]=o[1]*Math.cos(i)-o[2]*Math.sin(i),s[2]=o[1]*Math.sin(i)+o[2]*Math.cos(i),t[0]=s[0]+n[0],t[1]=s[1]+n[1],t[2]=s[2]+n[2],t},rotateY:function(t,e,n,i){var o=[],s=[];return o[0]=e[0]-n[0],o[1]=e[1]-n[1],o[2]=e[2]-n[2],s[0]=o[2]*Math.sin(i)+o[0]*Math.cos(i),s[1]=o[1],s[2]=o[2]*Math.cos(i)-o[0]*Math.sin(i),t[0]=s[0]+n[0],t[1]=s[1]+n[1],t[2]=s[2]+n[2],t},rotateZ:Qy,round:function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t},scale:Gy,scaleAndAdd:jy,set:Fy,sqrDist:o_,sqrLen:a_,squaredDistance:Vy,squaredLength:Wy,str:function(t){return"vec3("+t[0]+", "+t[1]+", "+t[2]+")"},sub:e_,subtract:Hy,transformMat3:function(t,e,n){var i=e[0],o=e[1],s=e[2];return t[0]=i*n[0]+o*n[3]+s*n[6],t[1]=i*n[1]+o*n[4]+s*n[7],t[2]=i*n[2]+o*n[5]+s*n[8],t},transformMat4:Jy,transformQuat:function(t,e,n){var i=n[0],o=n[1],s=n[2],a=e[0],l=e[1],h=e[2],c=o*h-s*l,u=s*a-i*h,f=i*l-o*a,g=o*f-s*u,A=s*c-i*f,m=i*u-o*c,w=2*n[3];return u*=w,f*=w,A*=2,m*=2,t[0]=a+(c*=w)+(g*=2),t[1]=l+u+A,t[2]=h+f+m,t},zero:function(t){return t[0]=0,t[1]=0,t[2]=0,t}});function c_(){var t=new Nm(4);return Nm!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t}function u_(t){var e=new Nm(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function f_(t,e,n,i){var o=new Nm(4);return o[0]=t,o[1]=e,o[2]=n,o[3]=i,o}function d_(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function g_(t,e,n,i,o){return t[0]=e,t[1]=n,t[2]=i,t[3]=o,t}function p_(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t}function A_(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t}function m_(t,e,n){return t[0]=e[0]*n[0],t[1]=e[1]*n[1],t[2]=e[2]*n[2],t[3]=e[3]*n[3],t}function y_(t,e,n){return t[0]=e[0]/n[0],t[1]=e[1]/n[1],t[2]=e[2]/n[2],t[3]=e[3]/n[3],t}function __(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t}function v_(t,e){return Math.hypot(e[0]-t[0],e[1]-t[1],e[2]-t[2],e[3]-t[3])}function x_(t,e){var n=e[0]-t[0],i=e[1]-t[1],o=e[2]-t[2],s=e[3]-t[3];return n*n+i*i+o*o+s*s}function b_(t){return Math.hypot(t[0],t[1],t[2],t[3])}function w_(t){var e=t[0],n=t[1],i=t[2],o=t[3];return e*e+n*n+i*i+o*o}function T_(t,e){var n=e[0],i=e[1],o=e[2],s=e[3],a=n*n+i*i+o*o+s*s;return a>0&&(a=1/Math.sqrt(a)),t[0]=n*a,t[1]=i*a,t[2]=o*a,t[3]=s*a,t}function M_(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]}function C_(t,e,n,i){var o=e[0],s=e[1],a=e[2],l=e[3];return t[0]=o+i*(n[0]-o),t[1]=s+i*(n[1]-s),t[2]=a+i*(n[2]-a),t[3]=l+i*(n[3]-l),t}function S_(t,e,n){var i=e[0],o=e[1],s=e[2],a=e[3];return t[0]=n[0]*i+n[4]*o+n[8]*s+n[12]*a,t[1]=n[1]*i+n[5]*o+n[9]*s+n[13]*a,t[2]=n[2]*i+n[6]*o+n[10]*s+n[14]*a,t[3]=n[3]*i+n[7]*o+n[11]*s+n[15]*a,t}function P_(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function I_(t,e){var n=t[0],i=t[1],o=t[2],s=t[3],a=e[0],l=e[1],h=e[2],c=e[3];return Math.abs(n-a)<=Fm*Math.max(1,Math.abs(n),Math.abs(a))&&Math.abs(i-l)<=Fm*Math.max(1,Math.abs(i),Math.abs(l))&&Math.abs(o-h)<=Fm*Math.max(1,Math.abs(o),Math.abs(h))&&Math.abs(s-c)<=Fm*Math.max(1,Math.abs(s),Math.abs(c))}var O_=A_,E_=m_,k_=y_,R_=v_,L_=x_,D_=b_,F_=w_,N_=function(){var t=c_();return function(e,n,i,o,s,a){var l,h;for(n||(n=4),i||(i=0),h=o?Math.min(o*n+i,e.length):e.length,l=i;l<h;l+=n)t[0]=e[l],t[1]=e[l+1],t[2]=e[l+2],t[3]=e[l+3],s(t,t,a),e[l]=t[0],e[l+1]=t[1],e[l+2]=t[2],e[l+3]=t[3];return e}}(),H_=Object.freeze({__proto__:null,add:p_,ceil:function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t[3]=Math.ceil(e[3]),t},clone:u_,copy:d_,create:c_,cross:function(t,e,n,i){var o=n[0]*i[1]-n[1]*i[0],s=n[0]*i[2]-n[2]*i[0],a=n[0]*i[3]-n[3]*i[0],l=n[1]*i[2]-n[2]*i[1],h=n[1]*i[3]-n[3]*i[1],c=n[2]*i[3]-n[3]*i[2],u=e[0],f=e[1],g=e[2],A=e[3];return t[0]=f*c-g*h+A*l,t[1]=-u*c+g*a-A*s,t[2]=u*h-f*a+A*o,t[3]=-u*l+f*s-g*o,t},dist:R_,distance:v_,div:k_,divide:y_,dot:M_,equals:I_,exactEquals:P_,floor:function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t[3]=Math.floor(e[3]),t},forEach:N_,fromValues:f_,inverse:function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t[3]=1/e[3],t},len:D_,length:b_,lerp:C_,max:function(t,e,n){return t[0]=Math.max(e[0],n[0]),t[1]=Math.max(e[1],n[1]),t[2]=Math.max(e[2],n[2]),t[3]=Math.max(e[3],n[3]),t},min:function(t,e,n){return t[0]=Math.min(e[0],n[0]),t[1]=Math.min(e[1],n[1]),t[2]=Math.min(e[2],n[2]),t[3]=Math.min(e[3],n[3]),t},mul:E_,multiply:m_,negate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t},normalize:T_,random:function(t,e){var n,i,o,s,a,l;e=e||1;do{a=(n=2*Hm()-1)*n+(i=2*Hm()-1)*i}while(a>=1);do{l=(o=2*Hm()-1)*o+(s=2*Hm()-1)*s}while(l>=1);var h=Math.sqrt((1-a)/l);return t[0]=e*n,t[1]=e*i,t[2]=e*o*h,t[3]=e*s*h,t},round:function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t[3]=Math.round(e[3]),t},scale:__,scaleAndAdd:function(t,e,n,i){return t[0]=e[0]+n[0]*i,t[1]=e[1]+n[1]*i,t[2]=e[2]+n[2]*i,t[3]=e[3]+n[3]*i,t},set:g_,sqrDist:L_,sqrLen:F_,squaredDistance:x_,squaredLength:w_,str:function(t){return"vec4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},sub:O_,subtract:A_,transformMat4:S_,transformQuat:function(t,e,n){var i=e[0],o=e[1],s=e[2],a=n[0],l=n[1],h=n[2],c=n[3],u=c*i+l*s-h*o,f=c*o+h*i-a*s,g=c*s+a*o-l*i,A=-a*i-l*o-h*s;return t[0]=u*c+A*-a+f*-h-g*-l,t[1]=f*c+A*-l+g*-a-u*-h,t[2]=g*c+A*-h+u*-l-f*-a,t[3]=e[3],t},zero:function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=0,t}});function B_(){var t=new Nm(4);return Nm!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function z_(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}function G_(t,e,n){n*=.5;var i=Math.sin(n);return t[0]=i*e[0],t[1]=i*e[1],t[2]=i*e[2],t[3]=Math.cos(n),t}function j_(t,e,n){var i=e[0],o=e[1],s=e[2],a=e[3],l=n[0],h=n[1],c=n[2],u=n[3];return t[0]=i*u+a*l+o*c-s*h,t[1]=o*u+a*h+s*l-i*c,t[2]=s*u+a*c+i*h-o*l,t[3]=a*u-i*l-o*h-s*c,t}function U_(t,e,n){n*=.5;var i=e[0],o=e[1],s=e[2],a=e[3],l=Math.sin(n),h=Math.cos(n);return t[0]=i*h+a*l,t[1]=o*h+s*l,t[2]=s*h-o*l,t[3]=a*h-i*l,t}function V_(t,e,n){n*=.5;var i=e[0],o=e[1],s=e[2],a=e[3],l=Math.sin(n),h=Math.cos(n);return t[0]=i*h-s*l,t[1]=o*h+a*l,t[2]=s*h+i*l,t[3]=a*h-o*l,t}function W_(t,e,n){n*=.5;var i=e[0],o=e[1],s=e[2],a=e[3],l=Math.sin(n),h=Math.cos(n);return t[0]=i*h+o*l,t[1]=o*h-i*l,t[2]=s*h+a*l,t[3]=a*h-s*l,t}function Z_(t,e){var n=e[0],i=e[1],o=e[2],s=e[3],a=Math.sqrt(n*n+i*i+o*o),l=Math.exp(s),h=a>0?l*Math.sin(a)/a:0;return t[0]=n*h,t[1]=i*h,t[2]=o*h,t[3]=l*Math.cos(a),t}function q_(t,e){var n=e[0],i=e[1],o=e[2],s=e[3],a=Math.sqrt(n*n+i*i+o*o),l=a>0?Math.atan2(a,s)/a:0;return t[0]=n*l,t[1]=i*l,t[2]=o*l,t[3]=.5*Math.log(n*n+i*i+o*o+s*s),t}function X_(t,e,n,i){var o,s,a,l,h,c=e[0],u=e[1],f=e[2],g=e[3],A=n[0],m=n[1],w=n[2],T=n[3];return(s=c*A+u*m+f*w+g*T)<0&&(s=-s,A=-A,m=-m,w=-w,T=-T),1-s>Fm?(o=Math.acos(s),a=Math.sin(o),l=Math.sin((1-i)*o)/a,h=Math.sin(i*o)/a):(l=1-i,h=i),t[0]=l*c+h*A,t[1]=l*u+h*m,t[2]=l*f+h*w,t[3]=l*g+h*T,t}function J_(t,e){var n,i=e[0]+e[4]+e[8];if(i>0)n=Math.sqrt(i+1),t[3]=.5*n,t[0]=(e[5]-e[7])*(n=.5/n),t[1]=(e[6]-e[2])*n,t[2]=(e[1]-e[3])*n;else{var o=0;e[4]>e[0]&&(o=1),e[8]>e[3*o+o]&&(o=2);var s=(o+1)%3,a=(o+2)%3;n=Math.sqrt(e[3*o+o]-e[3*s+s]-e[3*a+a]+1),t[o]=.5*n,t[3]=(e[3*s+a]-e[3*a+s])*(n=.5/n),t[s]=(e[3*s+o]+e[3*o+s])*n,t[a]=(e[3*a+o]+e[3*o+a])*n}return t}function Q_(t,e,n,i){var o=.5*Math.PI/180;e*=o,n*=o,i*=o;var s=Math.sin(e),a=Math.cos(e),l=Math.sin(n),h=Math.cos(n),c=Math.sin(i),u=Math.cos(i);return t[0]=s*h*u-a*l*c,t[1]=a*l*u+s*h*c,t[2]=a*h*c-s*l*u,t[3]=a*h*u+s*l*c,t}var Y_,K_,$_,tv,ev,nv,iv=u_,rv=f_,ov=d_,sv=g_,av=p_,lv=j_,hv=__,cv=M_,uv=C_,fv=b_,dv=fv,gv=w_,pv=gv,Av=T_,mv=P_,yv=I_,_v=(Y_=ky(),K_=Ly(1,0,0),$_=Ly(0,1,0),function(t,e,n){var i=qy(e,n);return i<-.999999?(Xy(Y_,K_,e),s_(Y_)<1e-6&&Xy(Y_,$_,e),Zy(Y_,Y_),G_(t,Y_,Math.PI),t):i>.999999?(t[0]=0,t[1]=0,t[2]=0,t[3]=1,t):(Xy(Y_,e,n),t[0]=Y_[0],t[1]=Y_[1],t[2]=Y_[2],t[3]=1+i,Av(t,t))}),vv=(tv=B_(),ev=B_(),function(t,e,n,i,o,s){return X_(tv,e,o,s),X_(ev,n,i,s),X_(t,tv,ev,2*s*(1-s)),t}),xv=(nv=Jm(),function(t,e,n,i){return nv[0]=n[0],nv[3]=n[1],nv[6]=n[2],nv[1]=i[0],nv[4]=i[1],nv[7]=i[2],nv[2]=-e[0],nv[5]=-e[1],nv[8]=-e[2],Av(t,J_(t,nv))}),bv=Object.freeze({__proto__:null,add:av,calculateW:function(t,e){var n=e[0],i=e[1],o=e[2];return t[0]=n,t[1]=i,t[2]=o,t[3]=Math.sqrt(Math.abs(1-n*n-i*i-o*o)),t},clone:iv,conjugate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t},copy:ov,create:B_,dot:cv,equals:yv,exactEquals:mv,exp:Z_,fromEuler:Q_,fromMat3:J_,fromValues:rv,getAngle:function(t,e){var n=cv(t,e);return Math.acos(2*n*n-1)},getAxisAngle:function(t,e){var n=2*Math.acos(e[3]),i=Math.sin(n/2);return i>Fm?(t[0]=e[0]/i,t[1]=e[1]/i,t[2]=e[2]/i):(t[0]=1,t[1]=0,t[2]=0),n},identity:z_,invert:function(t,e){var n=e[0],i=e[1],o=e[2],s=e[3],a=n*n+i*i+o*o+s*s,l=a?1/a:0;return t[0]=-n*l,t[1]=-i*l,t[2]=-o*l,t[3]=s*l,t},len:dv,length:fv,lerp:uv,ln:q_,mul:lv,multiply:j_,normalize:Av,pow:function(t,e,n){return q_(t,e),hv(t,t,n),Z_(t,t),t},random:function(t){var e=Hm(),n=Hm(),i=Hm(),o=Math.sqrt(1-e),s=Math.sqrt(e);return t[0]=o*Math.sin(2*Math.PI*n),t[1]=o*Math.cos(2*Math.PI*n),t[2]=s*Math.sin(2*Math.PI*i),t[3]=s*Math.cos(2*Math.PI*i),t},rotateX:U_,rotateY:V_,rotateZ:W_,rotationTo:_v,scale:hv,set:sv,setAxes:xv,setAxisAngle:G_,slerp:X_,sqlerp:vv,sqrLen:pv,squaredLength:gv,str:function(t){return"quat("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"}});function wv(t,e,n){var i=.5*n[0],o=.5*n[1],s=.5*n[2],a=e[0],l=e[1],h=e[2],c=e[3];return t[0]=a,t[1]=l,t[2]=h,t[3]=c,t[4]=i*c+o*h-s*l,t[5]=o*c+s*a-i*h,t[6]=s*c+i*l-o*a,t[7]=-i*a-o*l-s*h,t}function Tv(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t}function Mv(t,e,n){var i=e[0],o=e[1],s=e[2],a=e[3],l=n[4],h=n[5],c=n[6],u=n[7],f=e[4],g=e[5],A=e[6],m=e[7],w=n[0],T=n[1],M=n[2],C=n[3];return t[0]=i*C+a*w+o*M-s*T,t[1]=o*C+a*T+s*w-i*M,t[2]=s*C+a*M+i*T-o*w,t[3]=a*C-i*w-o*T-s*M,t[4]=i*u+a*l+o*c-s*h+f*C+m*w+g*M-A*T,t[5]=o*u+a*h+s*l-i*c+g*C+m*T+A*w-f*M,t[6]=s*u+a*c+i*h-o*l+A*C+m*M+f*T-g*w,t[7]=a*u-i*l-o*h-s*c+m*C-f*w-g*T-A*M,t}var Cv=cv;var Sv=gv;var Pv=Object.freeze({__proto__:null,add:function(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t[4]=e[4]+n[4],t[5]=e[5]+n[5],t[6]=e[6]+n[6],t[7]=e[7]+n[7],t},clone:function(t){var e=new Nm(8);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e},conjugate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t[4]=-e[4],t[5]=-e[5],t[6]=-e[6],t[7]=e[7],t},copy:Tv,create:function(){var t=new Nm(8);return Nm!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[4]=0,t[5]=0,t[6]=0,t[7]=0),t[3]=1,t},dot:Cv,equals:function(t,e){var n=t[0],i=t[1],o=t[2],s=t[3],a=t[4],l=t[5],h=t[6],c=t[7],u=e[0],f=e[1],g=e[2],A=e[3],m=e[4],w=e[5],T=e[6],M=e[7];return Math.abs(n-u)<=Fm*Math.max(1,Math.abs(n),Math.abs(u))&&Math.abs(i-f)<=Fm*Math.max(1,Math.abs(i),Math.abs(f))&&Math.abs(o-g)<=Fm*Math.max(1,Math.abs(o),Math.abs(g))&&Math.abs(s-A)<=Fm*Math.max(1,Math.abs(s),Math.abs(A))&&Math.abs(a-m)<=Fm*Math.max(1,Math.abs(a),Math.abs(m))&&Math.abs(l-w)<=Fm*Math.max(1,Math.abs(l),Math.abs(w))&&Math.abs(h-T)<=Fm*Math.max(1,Math.abs(h),Math.abs(T))&&Math.abs(c-M)<=Fm*Math.max(1,Math.abs(c),Math.abs(M))},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]},fromMat4:function(t,e){var n=B_();vy(n,e);var i=new Nm(3);return yy(i,e),wv(t,n,i),t},fromRotation:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=0,t[5]=0,t[6]=0,t[7]=0,t},fromRotationTranslation:wv,fromRotationTranslationValues:function(t,e,n,i,o,s,a){var l=new Nm(8);l[0]=t,l[1]=e,l[2]=n,l[3]=i;var h=.5*o,c=.5*s,u=.5*a;return l[4]=h*i+c*n-u*e,l[5]=c*i+u*t-h*n,l[6]=u*i+h*e-c*t,l[7]=-h*t-c*e-u*n,l},fromTranslation:function(t,e){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t[4]=.5*e[0],t[5]=.5*e[1],t[6]=.5*e[2],t[7]=0,t},fromValues:function(t,e,n,i,o,s,a,l){var h=new Nm(8);return h[0]=t,h[1]=e,h[2]=n,h[3]=i,h[4]=o,h[5]=s,h[6]=a,h[7]=l,h},getDual:function(t,e){return t[0]=e[4],t[1]=e[5],t[2]=e[6],t[3]=e[7],t},getReal:ov,getTranslation:function(t,e){var n=e[4],i=e[5],o=e[6],s=e[7],a=-e[0],l=-e[1],h=-e[2],c=e[3];return t[0]=2*(n*c+s*a+i*h-o*l),t[1]=2*(i*c+s*l+o*a-n*h),t[2]=2*(o*c+s*h+n*l-i*a),t},identity:function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t[6]=0,t[7]=0,t},invert:function(t,e){var n=Sv(e);return t[0]=-e[0]/n,t[1]=-e[1]/n,t[2]=-e[2]/n,t[3]=e[3]/n,t[4]=-e[4]/n,t[5]=-e[5]/n,t[6]=-e[6]/n,t[7]=e[7]/n,t},len:fv,length:fv,lerp:function(t,e,n,i){var o=1-i;return Cv(e,n)<0&&(i=-i),t[0]=e[0]*o+n[0]*i,t[1]=e[1]*o+n[1]*i,t[2]=e[2]*o+n[2]*i,t[3]=e[3]*o+n[3]*i,t[4]=e[4]*o+n[4]*i,t[5]=e[5]*o+n[5]*i,t[6]=e[6]*o+n[6]*i,t[7]=e[7]*o+n[7]*i,t},mul:Mv,multiply:Mv,normalize:function(t,e){var n=Sv(e);if(n>0){n=Math.sqrt(n);var i=e[0]/n,o=e[1]/n,s=e[2]/n,a=e[3]/n,l=e[4],h=e[5],c=e[6],u=e[7],f=i*l+o*h+s*c+a*u;t[0]=i,t[1]=o,t[2]=s,t[3]=a,t[4]=(l-i*f)/n,t[5]=(h-o*f)/n,t[6]=(c-s*f)/n,t[7]=(u-a*f)/n}return t},rotateAroundAxis:function(t,e,n,i){if(Math.abs(i)<Fm)return Tv(t,e);var o=Math.hypot(n[0],n[1],n[2]);i*=.5;var s=Math.sin(i),a=s*n[0]/o,l=s*n[1]/o,h=s*n[2]/o,c=Math.cos(i),u=e[0],f=e[1],g=e[2],A=e[3];t[0]=u*c+A*a+f*h-g*l,t[1]=f*c+A*l+g*a-u*h,t[2]=g*c+A*h+u*l-f*a,t[3]=A*c-u*a-f*l-g*h;var m=e[4],w=e[5],T=e[6],M=e[7];return t[4]=m*c+M*a+w*h-T*l,t[5]=w*c+M*l+T*a-m*h,t[6]=T*c+M*h+m*l-w*a,t[7]=M*c-m*a-w*l-T*h,t},rotateByQuatAppend:function(t,e,n){var i=n[0],o=n[1],s=n[2],a=n[3],l=e[0],h=e[1],c=e[2],u=e[3];return t[0]=l*a+u*i+h*s-c*o,t[1]=h*a+u*o+c*i-l*s,t[2]=c*a+u*s+l*o-h*i,t[3]=u*a-l*i-h*o-c*s,t[4]=(l=e[4])*a+(u=e[7])*i+(h=e[5])*s-(c=e[6])*o,t[5]=h*a+u*o+c*i-l*s,t[6]=c*a+u*s+l*o-h*i,t[7]=u*a-l*i-h*o-c*s,t},rotateByQuatPrepend:function(t,e,n){var i=e[0],o=e[1],s=e[2],a=e[3],l=n[0],h=n[1],c=n[2],u=n[3];return t[0]=i*u+a*l+o*c-s*h,t[1]=o*u+a*h+s*l-i*c,t[2]=s*u+a*c+i*h-o*l,t[3]=a*u-i*l-o*h-s*c,t[4]=i*(u=n[7])+a*(l=n[4])+o*(c=n[6])-s*(h=n[5]),t[5]=o*u+a*h+s*l-i*c,t[6]=s*u+a*c+i*h-o*l,t[7]=a*u-i*l-o*h-s*c,t},rotateX:function(t,e,n){var i=-e[0],o=-e[1],s=-e[2],a=e[3],l=e[4],h=e[5],c=e[6],u=e[7],f=l*a+u*i+h*s-c*o,g=h*a+u*o+c*i-l*s,A=c*a+u*s+l*o-h*i,m=u*a-l*i-h*o-c*s;return U_(t,e,n),t[4]=f*(a=t[3])+m*(i=t[0])+g*(s=t[2])-A*(o=t[1]),t[5]=g*a+m*o+A*i-f*s,t[6]=A*a+m*s+f*o-g*i,t[7]=m*a-f*i-g*o-A*s,t},rotateY:function(t,e,n){var i=-e[0],o=-e[1],s=-e[2],a=e[3],l=e[4],h=e[5],c=e[6],u=e[7],f=l*a+u*i+h*s-c*o,g=h*a+u*o+c*i-l*s,A=c*a+u*s+l*o-h*i,m=u*a-l*i-h*o-c*s;return V_(t,e,n),t[4]=f*(a=t[3])+m*(i=t[0])+g*(s=t[2])-A*(o=t[1]),t[5]=g*a+m*o+A*i-f*s,t[6]=A*a+m*s+f*o-g*i,t[7]=m*a-f*i-g*o-A*s,t},rotateZ:function(t,e,n){var i=-e[0],o=-e[1],s=-e[2],a=e[3],l=e[4],h=e[5],c=e[6],u=e[7],f=l*a+u*i+h*s-c*o,g=h*a+u*o+c*i-l*s,A=c*a+u*s+l*o-h*i,m=u*a-l*i-h*o-c*s;return W_(t,e,n),t[4]=f*(a=t[3])+m*(i=t[0])+g*(s=t[2])-A*(o=t[1]),t[5]=g*a+m*o+A*i-f*s,t[6]=A*a+m*s+f*o-g*i,t[7]=m*a-f*i-g*o-A*s,t},scale:function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*n,t[5]=e[5]*n,t[6]=e[6]*n,t[7]=e[7]*n,t},set:function(t,e,n,i,o,s,a,l,h){return t[0]=e,t[1]=n,t[2]=i,t[3]=o,t[4]=s,t[5]=a,t[6]=l,t[7]=h,t},setDual:function(t,e){return t[4]=e[0],t[5]=e[1],t[6]=e[2],t[7]=e[3],t},setReal:ov,sqrLen:Sv,squaredLength:Sv,str:function(t){return"quat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+")"},translate:function(t,e,n){var i=e[0],o=e[1],s=e[2],a=e[3],l=.5*n[0],h=.5*n[1],c=.5*n[2],u=e[4],f=e[5],g=e[6],A=e[7];return t[0]=i,t[1]=o,t[2]=s,t[3]=a,t[4]=a*l+o*c-s*h+u,t[5]=a*h+s*l-i*c+f,t[6]=a*c+i*h-o*l+g,t[7]=-i*l-o*h-s*c+A,t}});function Iv(){var t=new Nm(2);return Nm!=Float32Array&&(t[0]=0,t[1]=0),t}function Ov(t,e){return t[0]=e[0],t[1]=e[1],t}function Ev(t,e,n){return t[0]=e,t[1]=n,t}function kv(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t}function Rv(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t}function Lv(t,e,n){return t[0]=e[0]*n[0],t[1]=e[1]*n[1],t}function Dv(t,e,n){return t[0]=e[0]/n[0],t[1]=e[1]/n[1],t}function Fv(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t}function Nv(t,e){return Math.hypot(e[0]-t[0],e[1]-t[1])}function Hv(t,e){var n=e[0]-t[0],i=e[1]-t[1];return n*n+i*i}function Bv(t){return Math.hypot(t[0],t[1])}function zv(t){var e=t[0],n=t[1];return e*e+n*n}function Gv(t,e,n){var i=e[0],o=e[1];return t[0]=n[0]*i+n[2]*o,t[1]=n[1]*i+n[3]*o,t}function jv(t,e,n,i){var o=e[0]-n[0],s=e[1]-n[1],a=Math.sin(i),l=Math.cos(i);return t[0]=o*l-s*a+n[0],t[1]=o*a+s*l+n[1],t}function Uv(t,e){return t[0]===e[0]&&t[1]===e[1]}var Vv=Bv,Wv=Rv,Zv=Lv,qv=Dv,Xv=Nv,Jv=Hv,Qv=zv,Yv=function(){var t=Iv();return function(e,n,i,o,s,a){var l,h;for(n||(n=2),i||(i=0),h=o?Math.min(o*n+i,e.length):e.length,l=i;l<h;l+=n)t[0]=e[l],t[1]=e[l+1],s(t,t,a),e[l]=t[0],e[l+1]=t[1];return e}}(),Kv=Object.freeze({__proto__:null,add:kv,angle:function(t,e){var n=t[0],i=t[1],o=e[0],s=e[1],a=Math.sqrt(n*n+i*i)*Math.sqrt(o*o+s*s);return Math.acos(Math.min(Math.max(a&&(n*o+i*s)/a,-1),1))},ceil:function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t},clone:function(t){var e=new Nm(2);return e[0]=t[0],e[1]=t[1],e},copy:Ov,create:Iv,cross:function(t,e,n){var i=e[0]*n[1]-e[1]*n[0];return t[0]=t[1]=0,t[2]=i,t},dist:Xv,distance:Nv,div:qv,divide:Dv,dot:function(t,e){return t[0]*e[0]+t[1]*e[1]},equals:function(t,e){var n=t[0],i=t[1],o=e[0],s=e[1];return Math.abs(n-o)<=Fm*Math.max(1,Math.abs(n),Math.abs(o))&&Math.abs(i-s)<=Fm*Math.max(1,Math.abs(i),Math.abs(s))},exactEquals:Uv,floor:function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t},forEach:Yv,fromValues:function(t,e){var n=new Nm(2);return n[0]=t,n[1]=e,n},inverse:function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t},len:Vv,length:Bv,lerp:function(t,e,n,i){var o=e[0],s=e[1];return t[0]=o+i*(n[0]-o),t[1]=s+i*(n[1]-s),t},max:function(t,e,n){return t[0]=Math.max(e[0],n[0]),t[1]=Math.max(e[1],n[1]),t},min:function(t,e,n){return t[0]=Math.min(e[0],n[0]),t[1]=Math.min(e[1],n[1]),t},mul:Zv,multiply:Lv,negate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t},normalize:function(t,e){var n=e[0],i=e[1],o=n*n+i*i;return o>0&&(o=1/Math.sqrt(o)),t[0]=e[0]*o,t[1]=e[1]*o,t},random:function(t,e){e=e||1;var n=2*Hm()*Math.PI;return t[0]=Math.cos(n)*e,t[1]=Math.sin(n)*e,t},rotate:jv,round:function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t},scale:Fv,scaleAndAdd:function(t,e,n,i){return t[0]=e[0]+n[0]*i,t[1]=e[1]+n[1]*i,t},set:Ev,sqrDist:Jv,sqrLen:Qv,squaredDistance:Hv,squaredLength:zv,str:function(t){return"vec2("+t[0]+", "+t[1]+")"},sub:Wv,subtract:Rv,transformMat2:Gv,transformMat2d:function(t,e,n){var i=e[0],o=e[1];return t[0]=n[0]*i+n[2]*o+n[4],t[1]=n[1]*i+n[3]*o+n[5],t},transformMat3:function(t,e,n){var i=e[0],o=e[1];return t[0]=n[0]*i+n[3]*o+n[6],t[1]=n[1]*i+n[4]*o+n[7],t},transformMat4:function(t,e,n){var i=e[0],o=e[1];return t[0]=n[0]*i+n[4]*o+n[12],t[1]=n[1]*i+n[5]*o+n[13],t},zero:function(t){return t[0]=0,t[1]=0,t}}),$v="undefined"!=typeof Float32Array?Float32Array:Array;function tx(){var t=new $v(3);return $v!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function ex(t,e,n){var i=new $v(3);return i[0]=t,i[1]=e,i[2]=n,i}function nx(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function ix(t,e,n,i){return t[0]=e,t[1]=n,t[2]=i,t}function rx(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t}function ox(t,e){var n=e[0],i=e[1],o=e[2],s=n*n+i*i+o*o;return s>0&&(s=1/Math.sqrt(s),t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s),t}function sx(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function ax(t,e,n){var i=e[0],o=e[1],s=e[2],a=n[0],l=n[1],h=n[2];return t[0]=o*h-s*l,t[1]=s*a-i*h,t[2]=i*l-o*a,t}var lx=function(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t};function hx(){var t=new $v(4);return $v!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function cx(t,e){var n=e[0]+e[4]+e[8],i=void 0;if(n>0)i=Math.sqrt(n+1),t[3]=.5*i,t[0]=(e[5]-e[7])*(i=.5/i),t[1]=(e[6]-e[2])*i,t[2]=(e[1]-e[3])*i;else{var o=0;e[4]>e[0]&&(o=1),e[8]>e[3*o+o]&&(o=2);var s=(o+1)%3,a=(o+2)%3;i=Math.sqrt(e[3*o+o]-e[3*s+s]-e[3*a+a]+1),t[o]=.5*i,t[3]=(e[3*s+a]-e[3*a+s])*(i=.5/i),t[s]=(e[3*s+o]+e[3*o+s])*i,t[a]=(e[3*a+o]+e[3*o+a])*i}return t}!function(){var t=tx()}(),function(){var t,e=(t=new $v(4),$v!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}();var ux=function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t},fx=function(t,e){var n=e[0],i=e[1],o=e[2],s=e[3],a=n*n+i*i+o*o+s*s;return a>0&&(a=1/Math.sqrt(a),t[0]=n*a,t[1]=i*a,t[2]=o*a,t[3]=s*a),t};!function(){var t=tx(),e=ex(1,0,0),n=ex(0,1,0)}(),function(){var t=hx(),e=hx()}(),function(){var t,e=(t=new $v(9),$v!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[5]=0,t[6]=0,t[7]=0),t[0]=1,t[4]=1,t[8]=1,t)}();
/*!
   * Contains code from google filament
   * https://github.com/google/filament/
   * License Apache-2.0
   */
const dx=8,gx=[],px=[],Ax=[],mx=[];function yx(t,e,n){const i=ax(px,e,n);t=cx(t,function(t,e,n,i,o,s,a,l,h,c){return t[0]=e,t[1]=n,t[2]=i,t[3]=o,t[4]=s,t[5]=a,t[6]=l,t[7]=h,t[8]=c,t}(gx,n[0],n[1],n[2],...i,...e)),t=function(t){return t[3]<0?ux(t,t,-1):t}(t=fx(t,t));const o=1/((1<<2*dx-1)-1);if(t[3]<o){t[3]=o;const e=Math.sqrt(1-o*o);t[0]*=e,t[1]*=e,t[2]*=e}const s=n[3]>0?ax(Ax,n,e):ax(Ax,e,n);return sx(ax(mx,n,e),s)<0&&ux(t,t,-1),t}const _x=[];function vx(t,e,n){const i=n||[];i.setLength&&i.setLength(t.length);const o=_x;o.length<t.length/3&&(o.length=t.length/3),o.fill(0,0,t.length/3);const s=void 0===e.length?e:e.length;for(let n=0;n<s/3;n++)void 0===e.length?Px(t,3*n,3*n+1,3*n+2,i,o):Px(t,e[3*n],e[3*n+1],e[3*n+2],i,o);for(let t=0;t<i.length;t+=3){const e=o[t/3];0!==e?(i[t]/=e,i[t+1]/=e,i[t+2]/=e):(i[t]=0,i[t+1]=0,i[t+2]=0)}return i}const xx=[],bx=[],wx=[],Tx=[],Mx=[],Cx=[],Sx=[];function Px(t,e,n,i,o,s){ix(Tx,t[3*e],t[3*e+1],t[3*e+2]),ix(Mx,t[3*n],t[3*n+1],t[3*n+2]),ix(Cx,t[3*i],t[3*i+1],t[3*i+2]);const a=lx(xx,Cx,Mx),l=lx(bx,Tx,Mx),h=ax(wx,a,l);ox(Sx,h),o[3*e]=o[3*e]||0,o[3*n]=o[3*n]||0,o[3*i]=o[3*i]||0,o[3*e+1]=o[3*e+1]||0,o[3*n+1]=o[3*n+1]||0,o[3*i+1]=o[3*i+1]||0,o[3*e+2]=o[3*e+2]||0,o[3*n+2]=o[3*n+2]||0,o[3*i+2]=o[3*i+2]||0,o[3*e]+=Sx[0],o[3*n]+=Sx[0],o[3*i]+=Sx[0],o[3*e+1]+=Sx[1],o[3*n+1]+=Sx[1],o[3*i+1]+=Sx[1],o[3*e+2]+=Sx[2],o[3*n+2]+=Sx[2],o[3*i+2]+=Sx[2],s[e]+=1,s[n]+=1,s[i]+=1}
/*!
   * Contains code from THREE.JS
   * https://github.com/mrdoob/three.js/
   * License MIT
   * 
   * Generate tangents per vertex.
   */function Ix(t,e,n,i,o){const s=t.length/3,a=o||new Array(4*s),l=[],h=[];for(let t=0;t<s;t++)l[t]=[0,0,0],h[t]=[0,0,0];const c=[0,0,0],u=[0,0,0],f=[0,0,0],g=[0,0],A=[0,0],m=[0,0],w=[0,0,0],T=[0,0,0];function M(e,i,o){Ox(c,t,3*e),Ox(u,t,3*i),Ox(f,t,3*o),Ex(g,n,2*e),Ex(A,n,2*i),Ex(m,n,2*o);const s=u[0]-c[0],a=f[0]-c[0],M=u[1]-c[1],C=f[1]-c[1],P=u[2]-c[2],I=f[2]-c[2],O=A[0]-g[0],E=m[0]-g[0],D=A[1]-g[1],N=m[1]-g[1],H=1/(O*N-E*D);ix(w,(N*s-D*a)*H,(N*M-D*C)*H,(N*P-D*I)*H),ix(T,(O*a-E*s)*H,(O*C-E*M)*H,(O*I-E*P)*H),rx(l[e],l[e],w),rx(l[i],l[i],w),rx(l[o],l[o],w),rx(h[e],h[e],T),rx(h[i],h[i],T),rx(h[o],h[o],T)}for(let t=0,e=i.length;t<e;t+=3)M(i[t+0],i[t+1],i[t+2]);const C=[],P=[],I=[],O=[];let E,D,N;function H(t){Ox(I,e,3*t),nx(O,I),D=l[t],nx(C,D),lx(C,C,function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}(I,I,sx(I,D))),ox(C,C),ax(P,O,D),N=sx(P,h[t]),E=N<0?-1:1,a[4*t]=C[0],a[4*t+1]=C[1],a[4*t+2]=C[2],a[4*t+3]=E}for(let t=0,e=i.length;t<e;t+=3)H(i[t+0]),H(i[t+1]),H(i[t+2]);return a}function Ox(t,e,n){return t[0]=e[n],t[1]=e[n+1],t[2]=e[n+2],t}function Ex(t,e,n){return t[0]=e[n],t[1]=e[n+1],t}
/*!
   * @ispace/reshader.gl v0.107.4
   * LICENSE : UNLICENSED
   * (c) 2016-2026 ispace.com
   */const kx=function(){if("undefined"!=typeof globalThis)return globalThis;if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("unable to locate global object")};function Rx(){return kx().ispace_gltf_loader}function Lx(t){return!Dx(t)&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}function Dx(t){return null==t}function Fx(t){return!Dx(t)}function Nx(t){return!Dx(t)&&("function"==typeof t||null!==t.constructor&&t.constructor===Function)}function Hx(t,...e){return Object.assign(t,...e),t}function Bx(t,...e){for(let n=0;n<e.length;n++){const i=e[n];for(const e in i)null!=i[e]&&(t[e]=i[e])}return t}function zx(t){return"number"==typeof t&&!isNaN(t)}function Gx(t,e,n){return t*(1-n)+e*n}function jx(t){return Array.isArray(t)||t instanceof Uint8Array||t instanceof Int8Array||t instanceof Uint16Array||t instanceof Int16Array||t instanceof Uint32Array||t instanceof Int32Array||t instanceof Uint8ClampedArray||t instanceof Float32Array||t instanceof Float64Array}function Ux(t){return(t=Math.abs(t))<128?Int8Array:t<32768?Int16Array:Float32Array}function Vx(t,e,n){return Math.min(n,Math.max(e,t))}function Wx(t){return t&&t.hasExtension("oes_vertex_array_object")}function Zx(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function qx(t){if(t.data){if(t.data.BYTES_PER_ELEMENT)return t.data.length*t.data.BYTES_PER_ELEMENT;if(t.data.length)return 4*t.data.length}else{if(t.BYTES_PER_ELEMENT)return t.length*t.BYTES_PER_ELEMENT;if(t.length)return 4*t.length;if(t.buffer&&t.buffer.destroy)return t.buffer._buffer.byteLength}return 0}function Xx(t){return t.width*t.height*Qx(t.format)*Jx(t.type)*("textureCube"===t._reglType?6:1)}function Jx(t){return"uint8"===t?1:"uint16"===t||"float16"===t||"half float"===t?2:"uint32"===t||"float"===t||"float32"===t?4:0}function Qx(t){return"depth"===t||"alpha"===t||"luminance"===t?1:"luminance alpha"===t||"depth stencil"===t?2:"srgba"===t||"rgb5 a1"===t||"rgba"===t.substring(0,4)?4:"srgb"===t||"rgb"===t.substring(0,3)?3:1}function Yx(t){if(!t.componentType)return!1;const e=Rx().GLTFLoader.getTypedArrayCtor(t.componentType);return t.byteStride>0&&t.byteStride!==t.itemSize*e.BYTES_PER_ELEMENT}function Kx(t){return t&&(t.stride>0||Yx(t))}function $x(t){let e=0;const n=t&&t.length||0;if(!n)return e;let i;for(let o=0;o<n;o++)i=t.charCodeAt(o),e=(e<<5)-e+i,e|=0;return e}function tb(t){return!(t&t-1)&&0!==t}function eb(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))}function nb(t,e,n){if(jx(t))return tb(e)&&tb(n)?t:function(t,e,n){let i=e,o=n;tb(e)||(i=eb(e)),tb(n)||(o=eb(n));const s=new ImageData(new Uint8ClampedArray(t),e,n),a=document.createElement("canvas");a.width=e,a.height=n,a.getContext("2d").putImageData(s,0,0);const l=document.createElement("canvas");l.width=i,l.height=o,l.getContext("2d").drawImage(a,0,0,e,n,0,0,o,o),console.warn(`Texture's size is not power of two, resize from (${e}, ${n}) to (${i}, ${o})`);let h=document.getElementById("_debug_resize_canvas");return h||(h=document.createElement("canvas"),h.id="_debug_resize_canvas",document.body.appendChild(h)),h.width=i,h.height=o,h.getContext("2d").drawImage(l,0,0),l}(t,e,n);if(tb(t.width)&&tb(t.height))return t;n=t.height,tb(e=t.width)||(e=eb(e)),tb(n)||(n=eb(n));const i=document.createElement("canvas");i.width=e,i.height=n,i.getContext("2d").drawImage(t,0,0,e,n);const o=t.src,s=o.lastIndexOf("/")+1,a=o.substring(s);return console.warn(`Texture(${a})'s size is not power of two, resize from (${t.width}, ${t.height}) to (${e}, ${n})`),i}function ib(t){return t._gl instanceof WebGL2RenderingContext}var rb=Object.freeze({__proto__:null,clamp:Vx,defined:Fx,extend:Hx,extendWithoutNil:Bx,getBufferSize:qx,getPosArrayType:Ux,getSupportedFormats:function(t){return{etc:!!t.getExtension("WEBGL_compressed_texture_etc"),etc1:!!t.getExtension("WEBGL_compressed_texture_etc1"),s3tc:!!t.getExtension("WEBGL_compressed_texture_s3tc"),pvrtc:!!t.getExtension("WEBGL_compressed_texture_pvrtc"),astc:!!t.getExtension("WEBGL_compressed_texture_astc"),bc7:!!t.getExtension("EXT_texture_compression_bptc")}},getTexMemorySize:Xx,getTextureByteWidth:Jx,getTextureChannels:Qx,hasOwn:Zx,hashCode:$x,interpolate:Gx,isArray:jx,isFunction:Nx,isInStride:Yx,isInterleaved:Kx,isNil:Dx,isNumber:zx,isPowerOfTwo:tb,isString:Lx,isSupportVAO:Wx,isTextureDestroyed:function(t){return!t._texture||!t._texture.texture},lerp:function(t,e,n,i){for(let o=0;o<t.length;o++)t[o]=e[o]+i*(n[o]-e[o]);return t},log2:function(t){return Math.log2(t)},normalize:function(t,e){let n=0;for(let t=0,i=e.length;t<i;t++)n+=e[t];for(let i=0,o=e.length;i<o;i++)t[i]=e[i]/n;return t},resizeToPowerOfTwo:nb,set:function(t,e){for(let n=0;n<t.length;n++)t[n]=e[n];return t},supportNPOT:ib});function ob(t){return class extends t{on(t,e){return this._events||(this._events={type:[e]}),this._events[t]=this._events[t]||[],this._events[t].push(e),this}once(t,e){return this.on(t,this._wrapOnce(t,e))}off(t,e){return this._events&&this._events[t]?(this._events[t].splice(this._events[t].indexOf(e),1),this):this}fire(t,e={}){if(!this._events||!this._events[t])return this;e.target||(e.target=this);const n=this._events[t].slice(0);for(const t of n)t(e);return this}_wrapOnce(t,e){const n=this;let i=!1;return function o(s){i||(i=!0,e(s),n.off(t,o))}}}}const sb="__reshader_disposed";var ab=Object.freeze({__proto__:null,KEY_DISPOSED:sb,WEBGL_EXTENSIONS:["ANGLE_instanced_arrays","OES_element_index_uint","OES_standard_derivatives"],WEBGL_OPTIONAL_EXTENSIONS:["OES_vertex_array_object","OES_texture_half_float","OES_texture_half_float_linear","OES_texture_float","OES_texture_float_linear","WEBGL_depth_texture","EXT_shader_texture_lod","EXT_texture_filter_anisotropic"]});const lb="_reshader_refCount";let hb=class z{},cb=class G extends(ob(hb)){constructor(t,e){if(super(),Nx(t)){this._texture=t,t=this.config={};for(const e in this._texture)Zx(this._texture,e)&&(Nx(this._texture[e])||(t[e]=this._texture[e]))}else if(this.config=t||{},this.resLoader=e,(t.url||t.promise)&&!t.data){this._loading=!0;const n=this;let i;if(t.promise)i=t.promise;else{let n;n=t.arrayBuffer?e.getArrayBuffer:e.get,i=n.call(e,t.url)}t.data=e.getDefaultTexture(t.url),this.promise=i,i.then((t=>(delete this.promise,n._loading=!1,n.config?(n.onLoad(t),Array.isArray(t)||(t=[t]),n.fire("complete",{target:this,resources:t}),t):t))).catch((t=>{console.error("error when loading texture image.",t),n.fire("error",{target:this,error:t})}))}}onLoad(t){}isReady(){return!this._loading}set(t,e){return this.config[t]=e,this.dirty=!0,this}get(t){return this.config[t]}createREGLTexture(t){return null}getREGLTexture(t){return this._texture||(this._texture=this.createREGLTexture(t),this.config.persistent||(this.config.data&&(this.config.data instanceof ImageBitmap||(this.config.data=[])),this.config.image&&(this.config.image.array=[]),this.config.mipmap&&delete this.config.mipmap)),this.dirty&&this._updateREGL(),this._texture}getMemorySize(){if(!this.config)return 0;const{width:t,height:e,type:n,format:i}=this.config;return t*e*Jx(n||"uint8")*Qx(i||"rgba")}_updateREGL(){this._texture&&!this._texture[sb]&&this._texture(this.config),this.dirty=!1}dispose(){this.config&&this.config.url&&(URL.revokeObjectURL(this.config.url),this.resLoader.disposeRes(this.config.url)),this.config&&this.config.data instanceof ImageBitmap&&(this.config.data.close(),this.config.data=[]),this._texture&&!this._texture[sb]&&(this._texture[lb]&&this._texture[lb]--,this._texture[lb]||(this._texture.destroy(),this._texture[sb]=!0,delete this._texture)),delete this.resLoader,delete this._regl;const t=this.config&&this.config.url;delete this.config,t&&this.fire("disposed",{target:this,url:t})}_needPowerOf2(t){if(ib(t))return!1;const e=this.config;return e.wrap&&"clamp"!==e.wrap||e.wrapS&&"clamp"!==e.wrapS||e.wrapT&&"clamp"!==e.wrapT||e.min&&"nearest"!==e.min&&"linear"!==e.min}};const ub=ay([]),fb=ay([]);let db=class j{constructor(t,e){this.min=t||[1/0,1/0,1/0],this.max=e||[-1/0,-1/0,-1/0],this.updateVertex()}static copy(t,e){Dy(t.min,e.min),Dy(t.max,e.max);for(let n=0;n<e.vertex.length;n++)Dy(t.vertex[n],e.vertex[n]);return t}combine(t){if(!t)return this;let e,n;return Array.isArray(t)?(e=t[0],n=t[1]):(e=t.min,n=t.max),e[0]<this.min[0]&&(this.min[0]=e[0],this._dirty=!0),e[1]<this.min[1]&&(this.min[1]=e[1],this._dirty=!0),e[2]<this.min[2]&&(this.min[2]=e[2],this._dirty=!0),n[0]>this.max[0]&&(this.max[0]=n[0],this._dirty=!0),n[1]>this.max[1]&&(this.max[1]=n[1],this._dirty=!0),n[2]>this.max[2]&&(this.max[2]=n[2],this._dirty=!0),this}dirty(){return this._dirty=!0,this}getCenter(){return this.center||(this.center=[0,0,0],this._dirty=!0),this._dirty&&(Ny(this.center,this.min,this.max),Gy(this.center,this.center,.5)),this._dirty=!1,this.center}containPoint(t){const e=this.min,n=this.max;return e[0]<=t[0]&&e[1]<=t[1]&&e[2]<=t[2]&&n[0]>=t[0]&&n[1]>=t[1]&&n[2]>=t[2]}isFinite(){const t=this.min,e=this.max;return isFinite(t[0])&&isFinite(t[1])&&isFinite(t[2])&&isFinite(e[0])&&isFinite(e[1])&&isFinite(e[2])}updateVertex(){if(!this.vertex){this.vertex=[];for(let t=0;t<8;t++)this.vertex.push([0,0,0])}return this.vertex[0][0]=this.min[0],this.vertex[0][1]=this.min[1],this.vertex[0][2]=this.min[2],this.vertex[1][0]=this.min[0],this.vertex[1][1]=this.min[1],this.vertex[1][2]=this.max[2],this.vertex[2][0]=this.min[0],this.vertex[2][1]=this.max[1],this.vertex[2][2]=this.max[2],this.vertex[3][0]=this.min[0],this.vertex[3][1]=this.max[1],this.vertex[3][2]=this.min[2],this.vertex[4][0]=this.max[0],this.vertex[4][1]=this.min[1],this.vertex[4][2]=this.min[2],this.vertex[5][0]=this.max[0],this.vertex[5][1]=this.min[1],this.vertex[5][2]=this.max[2],this.vertex[6][0]=this.max[0],this.vertex[6][1]=this.max[1],this.vertex[6][2]=this.max[2],this.vertex[7][0]=this.max[0],this.vertex[7][1]=this.max[1],this.vertex[7][2]=this.min[2],this.vertex}copy(t){return t?j.copy(t,this):new j(this.min.slice(),this.max.slice())}equals(t){if(!$y(this.min,t.min)||!$y(this.max,t.max))return!1;const e=t.vertex;for(let t=0;t<this.vertex.length;t++)if(!$y(e[t],this.vertex[t]))return!1;return!0}transform(t,e){if(t=t||fb,(e=e||fb)[1]||e[2]||e[4]||e[6]||e[8]||e[9]){const n=this.vertex,i=cy(ub,e,t);for(let t=0;t<n.length;t++)Jy(this.vertex[t],this.vertex[t],i);const o=this.vertex.map((t=>t[0])),s=this.vertex.map((t=>t[1])),a=this.vertex.map((t=>t[2])),l=Math.min(...o),h=Math.max(...o),c=Math.min(...s),u=Math.max(...s),f=Math.min(...a),g=Math.max(...a);Fy(this.min,l,c,f),Fy(this.max,h,u,g)}else{const n=cy(ub,e,t);Jy(this.min,this.min,n),Jy(this.max,this.max,n)}return this}};const gb=[],pb={5120:"int8",5122:"int16",5124:"int32",5121:"uint8",5123:"uint16",5125:"uint32",5126:"float"},Ab={5120:1,5122:2,5124:4,5121:1,5123:2,5125:4,5126:4},mb={positionSize:3,primitive:"triangles",positionAttribute:"aPosition",normalAttribute:"aNormal",uv0Attribute:"aTexCoord",uv1Attribute:"aTexCoord1",color0Attribute:"aColor0",tangentAttribute:"aTangent",pickingIdAttribute:"aPickingId",textureCoordMatrixAttribute:"aTextureCoordMatrix"};let yb=1;const _b="_reshader_refCount";let vb=class Z{constructor(t,e,n,i){this._version=0,this.data=t,this.elements=e,this.desc=Hx({},mb,i);const o=this._getPosAttritute();this.data[this.desc.positionAttribute]=o,n||(this.elements?n=xb(this.elements):o&&o.length?n=o.length/this.desc.positionSize:o&&o.interleavedArray?n=o.interleavedArray.length/this.desc.positionSize:o&&o.array&&(n=o.array.length/this.desc.positionSize)),this.count=n,this.elements||(this.elements=n),this.properties={},this._buffers={},this._vao={},this.getVertexCount(),this._prepareData(!0),this.updateBoundingBox()}set version(t){throw new Error("Geometry.version is read only.")}get version(){return this._version}_getPosAttritute(){return this.data[this.desc.positionAttribute]}_prepareData(t){if(!this.data)return;const e=this._buffers||{};for(const n in this.data){const i=this.data[n];if(i)if(i.buffer&&i.buffer.destroy){const e=i.buffer;e[_b]||(e[_b]=0),t&&e[_b]++}else if(i&&i.array)if(Yx(i)){let t=i.array.buffer.__id;t||(t=i.array.buffer.__id=yb++),this.data[n]={buffer:t,offset:i.byteOffset,stride:i.byteStride,type:pb[i.componentType],size:i.itemSize,count:i.count,componentType:i.componentType},e[t]||(e[t]={data:i.array.buffer})}else this.data[n]=i.array}this._buffers=e;const n=this.elements;n&&n.array&&(this.elements=n.array)}getAttrData(t){const e=t.key,n=!this._reglData||!this._reglData[e];if(this._reglData||(this._reglData={}),n){const t=this._reglData[e]={},n=this.data,{positionAttribute:i,normalAttribute:o,uv0Attribute:s,uv1Attribute:a,tangentAttribute:l,color0Attribute:h,pickingIdAttribute:c,textureCoordMatrixAttribute:u}=this.desc;Hx(t,this.data),t.aPosition=n[i],n[o]&&(t.aNormal=n[o]),n[s]&&(t.aTexCoord=n[s]),n[a]&&(t.aTexCoord1=n[a]),n[l]&&(t.aTangent=n[l]),n[h]&&(t.aColor0=n[h]),n[c]&&(t.aPickingId=n[c]),n[u]&&(t.aTextureCoordMatrix=n[u])}return this._reglData[e]}getREGLData(t,e,n){this.getAttrData(e);const i=!this._reglData||!this._reglData[e.key];if(Wx(t)&&!n){const n=e&&e.key||"default";if(!this._vao[n]||i||this._vao[n].dirty){const i=this._reglData[e.key],o=this._vertexCount,s=[];for(let t=0;t<e.length;t++){const n=e[t].name,a=i[n]&&i[n].buffer;if(a&&a.destroy)s.push(void 0!==i[n].stride?i[n]:a);else{const t=i[n];if(!t){s.push(this.desc.fillEmptyDataInMissingAttribute?new Uint8Array(4*o):gb);continue}const e=(t.data&&jx(t.data)?t.data.length:t.length)/o;t.data?(t.dimension=e,s.push(t)):s.push({data:t,dimension:e})}}const a={attributes:s,primitive:this.getPrimitive()};if(this.elements&&!zx(this.elements))if(this.elements.destroy)a.elements=this.elements;else{a.elements={primitive:this.getPrimitive(),data:this.elements};const t=this.getElementsType(this.elements);t&&(a.elements.type=t)}this._vao[n]?this._vao[n].vao(a):this._vao[n]={vao:t.vao(a)}}return delete this._vao[n].dirty,this._vao[n]}return this._reglData[e.key]}_isAttrChanged(t){if(t===this._activeAttributes)return!1;if(t.length!==this._activeAttributes.length)return!0;for(let e=0;e<t.length;e++)if(t[e]!==this._activeAttributes[e])return!0;return!1}generateBuffers(t){const e=this._buffers;for(const n in e)e[n].buffer||(e[n].buffer=t.buffer(e[n].data)),delete e[n].data;const n=this.desc.positionAttribute,i=this.desc.altitudeAttribute,o=this.data,s=this._vertexCount,a={};for(const l in o)if(o[l]){if(void 0===o[l].buffer||o[l].buffer instanceof ArrayBuffer){const e=o[l].data?o[l]:{data:o[l]};e.dimension=(o[l].data?o[l].data:o[l]).length/s;const h=t.buffer(e);h[_b]=1,a[l]={buffer:h},l!==n&&l!==i||(a[l].array=o[l])}else o[l].buffer.destroy?a[l]=o[l]:e[o[l].buffer]&&(a[l]=Hx({},o[l]),a[l].buffer=e[o[l].buffer].buffer);(this.desc.static||l!==n)&&delete o[l].array}if(this.data=a,delete this._reglData,this.elements&&!zx(this.elements)){const e={primitive:this.getPrimitive(),data:this.elements},n=this.getElementsType(this.elements);if(n&&(e.type=n),!this.desc.static&&!this.elements.destroy){const t=this.elements;this.indices=new Uint16Array(t.length);for(let e=0;e<t.length;e++)this.indices[e]=t[e]}this.elements=this.elements.destroy?this.elements:t.elements(e);const i=this.elements;i[_b]||(i[_b]=0),i[_b]++}}getVertexCount(){const{positionAttribute:t,positionSize:e,color0Attribute:n}=this.desc;let i=this.data[t];i.data&&(i=i.data),i.array&&(i=i.array),jx(i)?this._vertexCount=Math.ceil(i.length/e):i&&void 0!==i.count&&(this._vertexCount=i.count);const o=n;if(this.data[o]){const t=this.data[o].data||this.data[o].array||this.data[o];Array.isArray(t)?this._color0Size=t.length/this._vertexCount:t&&t.count?this._color0Size=t.count/this._vertexCount:this.data[o].buffer&&this.data[o].buffer.destroy&&(this._color0Size=this.data[o].buffer._buffer.dimension)}return this._vertexCount}getColor0Size(){return this._color0Size||0}addBuffer(t,e){return this._buffers[t]={data:e},delete this._reglData,this._deleteVAO(),this}updateBuffer(t,e){if(!this._buffers[t])throw new Error(`invalid buffer ${t} in geometry`);return this._buffers[t].buffer?this._buffers[t].buffer.subdata(e):this._buffers[t].data=e,delete this._reglData,this._deleteVAO(),this}deleteData(t){const e=this.data[t];return e?(this._incrVersion(),e.buffer&&e.buffer.destroy&&e.buffer.destroy(),delete this.data[t],delete this._reglData,this._markVAODirty(!1),this):this}updateData(t,e){const n=this.data[t];if(!n)return this;let i;return this._incrVersion(),this.data[t]=e,n.buffer&&n.buffer.destroy&&(i=n),t===this.desc.positionAttribute&&this.updateBoundingBox(),this.getVertexCount(),i&&(i.buffer(e),this.data[t]=i),this._prepareData(!1),this.desc.positionAttribute===t&&(this._posDirty=!0),delete this._reglData,this}updateSubData(t,e,n){const i=this.data[t];if(!i)return this;let o;if(this._incrVersion(),i.buffer&&i.buffer.destroy&&(o=i),t===this.desc.positionAttribute&&this._updateSubBoundingBox(e),o){const t=Ab[o.buffer._buffer.dtype];if(e.BYTES_PER_ELEMENT!==t){const n=function(t,e){return t instanceof Uint8Array||t instanceof Uint16Array||t instanceof Uint32Array||t instanceof Uint8ClampedArray?1===e?Uint8Array:2===e?Uint16Array:Uint32Array:t instanceof Int8Array||t instanceof Int16Array||t instanceof Int32Array?1===e?Int8Array:2===e?Int16Array:Int32Array:t instanceof Float32Array||t instanceof Float64Array?4===e?Float32Array:Float64Array:null}(e,t);e=new n(e)}o.buffer.subdata(e,n*t)}else{const i=this.data[t].data?this.data[t].data:this.data[t];for(let t=0;t<e.length;t++)i[n+t]=e[t]}return this._prepareData(!1),this.desc.positionAttribute===t&&(this._posDirty=!0),delete this._reglData,this}getPrimitive(){return this.desc.primitive}getElements(){return this.elements}setElements(t,e){if(!t)throw new Error("elements data is invalid");this._incrVersion();const n=this.elements;return this.count=void 0===e?xb(t):e,this.elements=t&&t.destroy?t:n.destroy?n(t):t,this._markVAODirty(!0),this}deleteElements(){return this.elements&&0!==this.elements.length?(this._incrVersion(),this.elements&&this.elements.destroy&&!this.elements[sb]&&(this.elements.destroy(),this.elements[sb]=1),this.elements=[],this._markVAODirty(!0),this):this}_markVAODirty(t){if(this._vao){for(const e in this._vao)t?this._vao[e].vao.destroy():this._vao[e].dirty=!0;t&&(this._vao={})}}setDrawCount(t){return this._incrVersion(),this.count1=t,this}getDrawCount(){return this.count1>=0?this.count1:this.count}setDrawOffset(t){return this._incrVersion(),this.offset=t,this}getDrawOffset(){return this.offset||0}dispose(){if(this._deleteVAO(),this._forEachBuffer((t=>{if(!t[sb]){let e=t[_b];e&&e--,e<=0?(t[sb]=!0,t.destroy()):t[_b]=e}})),this.properties){const t=this.properties.oldElementsBeforeHighlight;t&&!t[sb]&&t.destroy&&(t.destroy(),t[sb]=!0),delete this.properties.oldElementsBeforeHighlight,delete this.properties.hasInvisible}this.data={},this._buffers={},delete this._reglData,this.count=0,this.elements=[],delete this._tempPosArray,this._disposed=!0}isDisposed(){return!!this._disposed}updateBoundingBox(){let t=this.boundingBox;t||(t=this.boundingBox=new db);let e,n,i=this.data[this.desc.positionAttribute];if(jx(i)||(i.data?i=i.data:Kx(i)?i=this._getAttributeData(this.desc.positionAttribute):i.array&&(e=i.min,n=i.max,i=i.array)),i&&i.length){const o=t.min,s=t.max;if(e&&n)Fy(o,...e),Fy(s,...n);else{Fy(o,i[0],i[1],i[2]),Fy(s,i[0],i[1],i[2]);for(let t=3;t<i.length;){const e=i[t++],n=i[t++],a=i[t++];e<o[0]&&(o[0]=e),n<o[1]&&(o[1]=n),a<o[2]&&(o[2]=a),e>s[0]&&(s[0]=e),n>s[1]&&(s[1]=n),a>s[2]&&(s[2]=a)}}t.updateVertex(),t.dirty()}}_updateSubBoundingBox(t){const e=this.boundingBox,n=e.min,i=e.max,o=this.desc.positionSize;for(let e=0;e<t.length;){const s=t[e++],a=t[e++];let l=0;3===o&&(l=t[e++]),s<n[0]&&(n[0]=s),a<n[1]&&(n[1]=a),l<n[2]&&(n[2]=l),s>i[0]&&(i[0]=s),a>i[1]&&(i[1]=a),l>i[2]&&(i[2]=l)}e.updateVertex(),e.dirty()}_getAttributeData(t){const e=Rx(),n=this.data[t]&&this.data[t].array?this.data[t].array:this.data[t],i=n.buffer;if(Kx(n)){const o=this._buffers[i]?this._buffers[i].data:n.array,{count:s,size:a,stride:l,offset:h,componentType:c}=n,u=e.GLTFLoader.getTypedArrayCtor(c);if((0===l||l===a*u.BYTES_PER_ELEMENT)&&h%u.BYTES_PER_ELEMENT==0)return new u(o,h,s*a);if(t===this.desc.positionAttribute)return!this._tempPosArray||this._tempPosArray&&this._tempPosArray.length<a*s?(this._tempPosArray=new u(a*s),e.GLTFLoader.readInterleavedArray(this._tempPosArray,o,s,a,l,h,c)):this._posDirty?(this._posDirty=!1,e.GLTFLoader.readInterleavedArray(this._tempPosArray,o,s,a,l,h,c)):this._tempPosArray;{const t=new u(a*s);return e.GLTFLoader.readInterleavedArray(t,o,s,a,l,h,c)}}return n}createTangent(t="aTangent"){this._incrVersion();const{normalAttribute:e,positionAttribute:n,uv0Attribute:i}=this.desc,o=this._getAttributeData(e),s=Ix(this._getAttributeData(n),o,this.data[i],this.elements),a=this.data[t]=new Float32Array(s.length),l=[0,0,0,0],h=[0,0,0],c=[0,0,0,0];for(let t=0;t<s.length;t+=4){const e=t/4*3;Fy(h,o[e],o[e+1],o[e+2]),g_(l,s[t],s[t+1],s[t+2],s[t+3]),yx(c,h,l),d_(a.subarray(t,t+4),c)}delete this._reglData}createNormal(t="aNormal"){this._incrVersion();const e=this._getAttributeData(this.desc.positionAttribute);this.data[t]=vx(e.array||e,this.elements),delete this._reglData}createBarycentric(t="aBarycentric"){if("triangles"!==this.desc.primitive)throw new Error("Primitive must be triangles to create bary centric data");this._incrVersion();const e=new Uint8Array(3*this._vertexCount);for(let t=0,n=this.elements.length;t<n;)for(let n=0;n<3;n++)e[3*this.elements[t++]+n]=1;this.data[t]=e,delete this._reglData}buildUniqueVertex(){this._incrVersion();const t=this.data,e=this.elements;if(!jx(e))throw new Error("elements must be array to build unique vertex.");const n=Object.keys(t),i={};let o=t[this.desc.positionAttribute];if(o=o.length?o:o.array,!jx(o))throw new Error(this.desc.positionAttribute+" must be array to build unique vertex.");const s=this._vertexCount,a=e.length;for(let e=0;e<n.length;e++){const o=n[e],l=jx(t[o])?t[o]:t[o].array,h=l.length/s;if(!jx(l))throw new Error(o+" must be array to build unique vertex.");i[o]=l,t[o]=new l.constructor(a*h)}let l=0;for(let o=0;o<a;o++){const a=e[o];for(let e=0;e<n.length;e++){const o=n[e],h=t[o],c=i[o].length/s;for(let t=0;t<c;t++)h[l*c+t]=i[o][a*c+t]}e[o]=l++}o=this.data[this.desc.positionAttribute],this._vertexCount=Math.ceil(o.length/this.desc.positionSize),delete this._reglData}getMemorySize(){let t=0;for(const e in this.data)Zx(this.data,e)&&(t+=qx(this.data[e]));if(this.elements){const e=this.elements;e.destroy?t+=e._elements.buffer.byteLength:e.BYTES_PER_ELEMENT?t+=e.length*e.BYTES_PER_ELEMENT:e.length&&(t+=4*e.length)}return t}_deleteVAO(){for(const t in this._vao)this._vao[t].vao.destroy();this._vao={}}_forEachBuffer(t){this.elements&&this.elements.destroy&&t(this.elements);for(const e in this.data)Zx(this.data,e)&&this.data[e]&&this.data[e].buffer&&this.data[e].buffer.destroy&&t(this.data[e].buffer);for(const e in this._buffers)Zx(this._buffers,e)&&this._buffers[e]&&this._buffers[e].buffer&&this._buffers[e].buffer.destroy&&t(this._buffers[e].buffer)}getElementsType(t){return t instanceof Uint8Array?"uint8":t instanceof Uint16Array?"uint16":t instanceof Uint32Array?"uint32":void 0}_incrVersion(){this._version++}};function xb(t){if(zx(t))return t;if(void 0!==t.count)return t.count;if(t.destroy)return t._elements.vertCount;if(void 0!==t.length)return t.length;if(t.data)return t.data.length;throw new Error("invalid elements length")}const bb=["points","lines","line strip","line loop","triangles","triangle strip","triangle fan"];function wb(t){return bb[t]}const Tb={5121:"uint8",5123:"uint16",5125:"uint32",5126:"float",36193:"half float"};function Mb(t){return Tb[t]}const Cb={6406:"alpha",6407:"rgb",6408:"rgba",6409:"luminance",6410:"luminance alpha",33776:"rgb s3tc dxt1",33777:"rgba s3tc dxt1",33778:"rgba s3tc dxt3",33779:"rgba s3tc dxt5",35840:"rgb pvrtc 4bppv1",35841:"rgb pvrtc 2bppv1",35842:"rgba pvrtc 4bppv1",35843:"rgba pvrtc 2bppv1",35986:"rgb atc",35987:"rgba atc explicit alpha",34798:"rgba atc interpolated alpha",36196:"rgb etc1"};function Sb(t){return Cb[t]}const Pb={9729:"linear",9728:"nearest"};function Ib(t){return Pb[t]}const Ob={9729:"linear",9728:"nearest",9984:"nearest mipmap nearest",9985:"linear mipmap nearest",9986:"nearest mipmap linear",9987:"linear mipmap linear"};function Eb(t){return Ob[t]}const kb={10497:"repeat",33071:"clamp",33648:"mirror"};function Rb(t){return kb[t]}const Lb="__reshader_webgl_buffer",Db="__reshader_webgl_tex";function Fb(t,e,n){let i;if(jx(e)?e.buffer&&void 0!==e.byteOffset&&(i=e):e.array&&e.array.buffer&&void 0!==e.array.byteOffset&&(i=e.array),!i)return null;const o=i.buffer,s=i.byteOffset;o[Lb]||(o[Lb]={});let a=o[Lb][s];if(!a){const e={};n&&Hx(e,n),e.data=i,a=t.buffer(e),o[Lb][s]=a}return a}function Nb(t,e){const n=e.data;if(!n||!n.buffer)return t.texture(e);const i=n.buffer,o=n.byteOffset;i[Db]||(i[Db]={});let s=i[Db][o];return s||(s=t.texture(e),i[Db][o]=s),s}var Hb=Object.freeze({__proto__:null,getMaterialFormat:Sb,getMaterialType:Mb,getPrimitive:wb,getTextureMagFilter:Ib,getTextureMinFilter:Eb,getTextureWrap:Rb,getUniqueREGLBuffer:Fb,getUniqueTexture:Nb});const Bb=[0,0,0],zb=[0,0,0],Gb=[0,0,0],jb=[],Ub=[],Vb=[],Wb=["a","b","c"];let Zb=class Se extends vb{constructor(t,e,n,i){super(t,e,n,{primitive:wb(1),positionAttribute:i.positionAttribute})}_getPosAttritute(){const t=this.data[this.desc.positionAttribute];if(!t.length)return[];const e=Math.pow(10,4),n=Math.cos(Math.PI/180*.8),i=this.elements,o=t.length?t:t.array,s=i.length?i?i.length:o.length/3:i,a=[0,0,0],l=new Array(3),h={},c=[],u=new qb;for(let t=0;t<s;t+=3){i.length?(a[0]=i[t],a[1]=i[t+1],a[2]=i[t+2]):(a[0]=t,a[1]=t+1,a[2]=t+2),u.a=Xb(jb,o,a[0]),u.b=Xb(Ub,o,a[1]),u.c=Xb(Vb,o,a[2]);const s=u.getNormal(),f=u.a,g=u.b,A=u.c;if(l[0]=`${Math.round(f[0]*e)},${Math.round(f[1]*e)},${Math.round(f[2]*e)}`,l[1]=`${Math.round(g[0]*e)},${Math.round(g[1]*e)},${Math.round(g[2]*e)}`,l[2]=`${Math.round(A[0]*e)},${Math.round(A[1]*e)},${Math.round(A[2]*e)}`,l[0]!==l[1]&&l[1]!==l[2]&&l[2]!==l[0])for(let t=0;t<3;t++)this._calEdgeData(t,a,u,h,l,n,s,c)}for(const t in h)if(h[t]){const{index0:e,index1:n}=h[t];c.push(o[3*e],o[3*e+1],o[3*e+2]),c.push(o[3*n],o[3*n+1],o[3*n+2])}return this.elements=this._createElements(c),c}_calEdgeData(t,e,n,i,o,s,a,l){const h=(t+1)%3,c=o[t],u=o[h],f=n[Wb[t]],g=n[Wb[h]],A=`${c}_${u}`,m=`${u}_${c}`;m in i&&i[m]?(qy(a,i[m].normal)<=s&&(l.push(f[0],f[1],f[2]),l.push(g[0],g[1],g[2])),i[m]=null):A in i||(i[A]={index0:e[t],index1:e[h],normal:Dy([0,0,0],a)})}_createElements(t){const e=[],n=t.length/3;for(let t=0;t<n;t++)e.push(t);return e}},qb=class Te{constructor(t=[0,0,0],e=[0,0,0],n=[0,0,0]){this.a=t,this.b=e,this.c=n}getNormal(){const t=e_(Bb,this.a,this.b),e=e_(zb,this.a,this.c);Xy(Gb,t,e);const n=Ry(Gb);return Fy(Gb,Gb[0]/n,Gb[1]/n,Gb[2]/n)}};function Xb(t,e,n){return Fy(t,e[3*n],e[3*n+1],e[3*n+2])}let Jb=class Oe{},Qb=class Ce extends(ob(Jb)){constructor(t={},e){super(),this._version=0,this._propVerion=0,this.uniforms=Bx({},e||{},t);for(const e in t){const n=Object.getOwnPropertyDescriptor(t,e).get;n&&Object.defineProperty(this.uniforms,e,{get:n})}this.unlit=!1,this._reglUniforms={},this.refCount=0,this._bindedOnTextureComplete=(...t)=>this._onTextureComplete.call(this,...t),this._genUniformKeys(),this._checkTextures()}set version(t){throw new Error("Material.version is read only.")}get version(){return this._version}get propVersion(){return this._propVerion}set doubleSided(t){this.uniforms.doubleSided=t}get doubleSided(){return!!this.uniforms.doubleSided}isReady(){return this._loadingCount<=0}set(t,e){const n=Dx(this.uniforms[t])&&!Dx(e)||!Dx(this.uniforms[t])&&Dx(e);if(this.uniforms[t]&&this.isTexture(t)&&this.uniforms[t].dispose(),Dx(e))Dx(this.uniforms[t])||delete this.uniforms[t];else if(this.uniforms[t]=e,this._reglUniforms){const n=Object.getOwnPropertyDescriptor(this._reglUniforms,t);n&&!n.get&&(this._propVerion++,this._reglUniforms[t]=e)}return this.isTexture(t)&&this._checkTextures(),n&&(this._genUniformKeys(),this._incrVersion()),this}setFunctionUniform(t,e){return this._genUniformKeys(),this._incrVersion(),Object.defineProperty(this.uniforms,t,{enumerable:!0,get:e}),this}hasFunctionUniform(t){return!!this.uniforms&&Object.prototype.hasOwnProperty.call(this.uniforms,t)}get(t){return this.uniforms[t]}isDirty(){return this._uniformVer!==this.version}appendDefines(t,e){const n=this.uniforms;return n?(n.jointTexture&&(t.HAS_SKIN=1),n.morphWeights1&&(t.HAS_MORPH=1),(n.khr_offset||n.khr_rotation||n.khr_scale)&&(t.HAS_KHR_TEXTURE_TRANSFORM=1),t):t}hasSkinAnimation(){return!!(this.uniforms&&this.uniforms.jointTexture&&this.uniforms.skinAnimation)}getUniforms(t){if(this._reglUniforms&&!this.isDirty())return this._reglUniforms;const e=this.uniforms,n={};for(const i in e)this.isTexture(i)?Object.defineProperty(n,i,{enumerable:!0,configurable:!0,get:function(){return e[i].getREGLTexture(t)}}):Object.getOwnPropertyDescriptor(e,i).get?Object.defineProperty(n,i,{enumerable:!0,configurable:!0,get:function(){return e[i]}}):n[i]=e[i];return this._reglUniforms=n,this._uniformVer=this.version,n}isTexture(t){return this.uniforms[t]instanceof cb}dispose(){for(const t in this.uniforms){const e=this.uniforms[t];e&&(e.dispose?e.dispose():e.destroy&&!e[sb]&&(e.destroy(),e[sb]=!0))}delete this.uniforms,delete this._reglUniforms,delete this._bindedOnTextureComplete,this._disposed=!0}isDisposed(){return!!this._disposed}_checkTextures(){this._loadingCount=0;for(const t in this.uniforms)if(this.isTexture(t)){const e=this.uniforms[t];e.isReady()||(this._loadingCount++,e.on("complete",this._bindedOnTextureComplete))}}_onTextureComplete(){this._loadingCount--,this._incrVersion(),this._loadingCount<=0&&(this._disposed||this.fire("complete"))}getUniformKeys(){return this._uniformKeys}_genUniformKeys(){const t=[];for(const e in this.uniforms)Zx(this.uniforms,e)&&!Dx(this.uniforms[e])&&t.push(e);this._uniformKeys=t.join()}_incrVersion(){this._version++}getMemorySize(){const t=this.uniforms;let e=0;for(const n in t)this.isTexture(n)?e+=t[n].getMemorySize():this.uniforms[n]&&this.uniforms[n].destroy&&(e+=Xx(this.uniforms[n]));return e}};const Yb={time:0,seeThrough:!0,thickness:.03,fill:[1,.5137254902,.98,1],stroke:[.7019607843,.9333333333,.2274509804,1],dashEnabled:!1,dashAnimate:!1,dashRepeats:1,dashLength:.8,dashOverlap:!0,insideAltColor:!1,squeeze:!1,squeezeMin:.5,squeezeMax:1,dualStroke:!1,secondThickness:.05,opacity:1,noiseEnable:!1};const Kb={baseColorFactor:[1,1,1,1],materialShininess:32,environmentExposure:1,specularStrength:32,opacity:1,extrusionOpacity:0,extrusionOpacityRange:[0,1.8],baseColorTexture:null,normalTexture:null,emissiveTexture:null,occlusionTexture:null,uvScale:[1,1],uvOffset:[0,0],alphaTest:0};let $b=class Ie extends Qb{constructor(t){super(t,Kb)}static convertFrom(t){const e={};for(const n in Kb)e[n]=t.get(n);return new Ie(e)}appendDefines(t,e){super.appendDefines(t,e);const n=this.uniforms;return n.extrusionOpacity&&(t.HAS_EXTRUSION_OPACITY=1),e.data[e.desc.colorAttribute]&&(t.HAS_COLOR=1),e.data[e.desc.color0Attribute]&&(t.HAS_COLOR0=1,t.COLOR0_SIZE=e.getColor0Size()),e.data.aVertexColorType&&(t.HAS_VERTEX_COLOR=1),e.data[e.desc.tangentAttribute]?t.HAS_TANGENT=1:e.data[e.desc.normalAttribute]&&(t.HAS_NORMAL=1),e.data[e.desc.uv0Attribute]?(n.baseColorTexture&&(t.HAS_BASECOLOR_MAP=1),n.occlusionTexture&&e.data[e.desc.uv1Attribute]&&(t.HAS_AO_MAP=1),n.emissiveTexture&&(t.HAS_EMISSIVE_MAP=1),n.normalTexture&&(t.HAS_NORMAL_MAP=1),(t.HAS_BASECOLOR_MAP||t.HAS_AO_MAP||t.HAS_EMISSIVE_MAP||t.HAS_NORMAL_MAP)&&(t.HAS_MAP=1),t):t}};const tw={baseColorFactor:[1,1,1,1],uvScale:[1,1],uvOffset:[0,0],opacity:1,envMapExposure:128,emissiveFactor:[.1,.1,.1],specularFactor:[0,0,0],envRotationSin:0,envRotationCos:1,reflectivity:.01,themingColor:[0,0,0,0],exposureBias:.6};let ew=class De extends Qb{constructor(t){super(t,tw)}appendDefines(t,e){super.appendDefines(t,e);const n=this.uniforms;return n.extrusionOpacity&&(t.HAS_EXTRUSION_OPACITY=1),e.data[e.desc.colorAttribute]&&(t.HAS_COLOR=1),e.data[e.desc.color0Attribute]&&(t.HAS_COLOR0=1,t.COLOR0_SIZE=e.getColor0Size()),e.data[e.desc.uv0Attribute]?(n.baseColorTexture&&(t.HAS_BASECOLOR_MAP=1),n.occlusionTexture&&e.data[e.desc.uv1Attribute]&&(t.HAS_AO_MAP=1),n.emissiveTexture&&(t.HAS_EMISSIVE_MAP=1),n.normalTexture&&(t.HAS_NORMAL_MAP=1),(t.HAS_BASECOLOR_MAP||t.HAS_AO_MAP||t.HAS_EMISSIVE_MAP||t.HAS_NORMAL_MAP)&&(t.HAS_MAP=1),t.ALPHATEST=.01,t.GAMMA_INPUT=1,t.GAMMA_FACTOR=1,t.TONEMAP_OUTPUT=1,t.ENVMAP_MODE_REFLECTION=1,t.ENV_RGBM=1,t.IRR_RGBM=1,t):t}};const nw={diffuseFactor:[1,1,1,1],specularFactor:[1,1,1],glossinessFactor:1,diffuseTexture:null,specularGlossinessTexture:null,normalTexture:null,emissiveTexture:null,occlusionTexture:null};function iw(t){return class extends t{constructor(...t){let e=t[0];e=Hx({},nw,e||{}),super(e,t)}appendDefines(t,e){if(super.appendDefines(t,e),t.SHADING_MODEL_SPECULAR_GLOSSINESS=1,!e.data[e.desc.uv0Attribute])return t;const n=this.uniforms;return n.diffuseTexture&&(t.HAS_DIFFUSE_MAP=1),n.specularGlossinessTexture&&(t.HAS_SPECULARGLOSSINESS_MAP=1),(t.HAS_SPECULARGLOSSINESS_MAP||t.HAS_DIFFUSE_MAP)&&(t.HAS_MAP=1),t}}}let rw=class Ne extends(iw($b)){};const ow=new Array(16);let sw=0,aw=class Be{constructor(t,e,n={}){this._version=0,this._geometry=t,this._material=e,this.transparent=!!n.transparent,this.bloom=!!n.bloom,this.ssr=!!n.ssr,this._castShadow=Dx(n.castShadow)||n.castShadow,this.needUpdateShadow=!1,this.picking=!!n.picking,this.disableVAO=!!n.disableVAO,this.uniforms={},this._localTransform=ay(new Array(16)),this._positionMatrix=ay(new Array(16)),this.properties={},this._dirtyUniforms=!0,this._dirtyGeometry=!0,Object.defineProperty(this,"uuid",{value:sw++}),sw>Number.MAX_VALUE-10&&(sw=0)}set material(t){this._material!==t&&this.setMaterial(t)}get material(){return this._material}set version(t){throw new Error("Mesh.version is read only.")}get version(){return this._version}get geometry(){return this._geometry}set geometry(t){this._geometry!==t&&(this._incrVersion(),this._dirtyGeometry=!0),this._geometry=t}set localTransform(t){this._prevTMat||(this._prevTMat=new Array(16)),Array.isArray(t)&&!Iy(this._prevTMat,t)&&(this._incrVersion(),this._prevTMat=sy(this._prevTMat,t)),this._localTransform=t}get localTransform(){return Nx(this._localTransform)?this._localTransform():this._localTransform}set positionMatrix(t){this._prevPMat||(this._prevPMat=new Array(16)),Array.isArray(t)&&!Iy(this._prevPMat,t)&&(this._incrVersion(),this._prevPMat=sy(this._prevPMat,t)),this._positionMatrix=t}get positionMatrix(){return Nx(this._positionMatrix)?this._positionMatrix():this._positionMatrix}get config(){return this._options||(this._options={}),this._options.transparent=this.transparent,this._options.castShadow=this.castShadow,this._options.bloom=this.bloom,this._options.ssr=this.ssr,this._options.picking=this.picking,this._options}get defines(){return this._getDefines()}set defines(t){this.setDefines(t)}get castShadow(){return this._castShadow&&(!this.material||!this.material.unlit)}set castShadow(t){this._castShadow=t}setMaterial(t){return this._material=t,this._dirtyUniforms=!0,delete this._materialVer,this.dirtyDefines=!0,this}setParent(t){return this.parent=t,this}setLocalTransform(t){return this.localTransform=t,this}setPositionMatrix(t){this.positionMatrix=t}setUniform(t,e){return this._updateUniformState(t),this.uniforms[t]=e,this}setFunctionUniform(t,e){return this._updateUniformState(t),Object.defineProperty(this.uniforms,t,{enumerable:!0,get:e}),this}hasFunctionUniform(t){return!!this.uniforms&&Object.prototype.hasOwnProperty.call(this.uniforms,t)}_updateUniformState(t){void 0===this.uniforms[t]?this._dirtyUniforms=!0:(this._dirtyProps=this._dirtyProps||[],this._dirtyProps.push(t))}getUniform(t){return this.uniforms[t]}getDefines(){const t={};return Hx(t,this._getDefines()),this._material&&this._geometry&&this._material.appendDefines(t,this._geometry),t}_getDefines(){this._defines||(this._defines={});const t=this._geometry,e=t.data[t.desc.positionAttribute],n=t.data[t.desc.uv0Attribute],i=t.data[t.desc.normalAttribute];return e&&e.quantization&&(this._defines.HAS_DRACO_POSITION=1),n&&n.quantization&&(this._defines.HAS_DRACO_TEXCOORD=1),i&&i.quantization&&(this._defines.HAS_DRACO_NORMAL=1),this._defines}setDefines(t){const e=this._bakDefines;return this._defines=t,this.dirtyDefines=this.dirtyDefines||!!e!=!!t||!function(t,e){if(!t&&!e)return!0;const n=Object.getOwnPropertyNames(t),i=Object.getOwnPropertyNames(e);if(n.length!==i.length)return!1;for(let i=0;i<n.length;i++)if(t[n[i]]!==e[n[i]])return!1;return!0}(e,t),this.dirtyDefines&&(this._bakDefines=Hx({},t)),this}hasSkinAnimation(){return this._material&&this._material.hasSkinAnimation()}_getDefinesKey(){return this.dirtyDefines=!1,this._createDefinesKey(this.getDefines())}getCommandKey(t){if(!this._commandKey||this.dirtyDefines||this._material&&this._materialKeys!==this._material.getUniformKeys()){let t=this._getDefinesKey();t+="_"+(zx(this.getElements())?"count":"elements"),t+="_"+ +!!this.disableVAO,this._material&&(t+="_"+ +!!this._material.doubleSided),this._commandKey=t,this._material&&(this._materialKeys=this._material.getUniformKeys())}return this._commandKey}getUniforms(t){if(this._dirtyUniforms||this._dirtyGeometry||this._material&&this._materialVer!==this._material.version){this._uniformDescriptors=new Set,this._realUniforms={},this._prepareUniformsForDraco();const e=this.uniforms;for(const t in this.uniforms)Zx(this.uniforms,t)&&(Object.getOwnPropertyDescriptor(e,t).get?(this._uniformDescriptors.add(t),Object.defineProperty(this._realUniforms,t,{enumerable:!0,configurable:!0,get:function(){return e[t]}})):this._realUniforms[t]=e[t]);if(this._material){const e=this._material.getUniforms(t);for(const t in e)Zx(e,t)&&!Zx(this._realUniforms,t)&&(Object.getOwnPropertyDescriptor(e,t).get?(this._uniformDescriptors.add(t),Object.defineProperty(this._realUniforms,t,{enumerable:!0,configurable:!0,get:function(){return e[t]}})):void 0===this._realUniforms[t]&&(this._realUniforms[t]=e[t]))}this._dirtyUniforms=!1,this._dirtyGeometry=!1,this._materialVer=this._material&&this._material.version,this._materialPropVer=this._material&&this._material.propVersion,this._dirtyProps=null}else if(this._dirtyProps||this._material&&this._material.propVersion!==this._materialPropVer){if(this._dirtyProps)for(const t of this._dirtyProps)this._realUniforms[t]=this.uniforms[t];if(this._material&&this._material.propVersion!==this._materialPropVer){const e=this._material.getUniforms(t);for(const t in e)Zx(e,t)&&!this._uniformDescriptors.has(t)&&(Object.getOwnPropertyDescriptor(e,t).get||this._realUniforms[t]===e[t]||(this._realUniforms[t]=e[t]));this._materialPropVer=this._material.propVersion}this._dirtyProps=null}return this._realUniforms.modelMatrix=this.localTransform,this._realUniforms.positionMatrix=this.positionMatrix,this._realUniforms}_prepareUniformsForDraco(){const t=this._geometry,e=t.data[t.desc.positionAttribute],n=t.data[t.desc.uv0Attribute],i=t.data[t.desc.normalAttribute];if(e&&e.quantization){const t=e.quantization,n=t.range/(1<<t.quantizationBits);this._realUniforms.minValues_pos=t.minValues,this._realUniforms.gltf_u_dec_position_normConstant=n}if(n&&n.quantization){const t=n.quantization;this._realUniforms.minValues_tex=t.minValues,this._realUniforms.gltf_u_dec_texcoord_0_normConstant=t.range/(1<<t.quantizationBits)}i&&i.quantization&&(this._realUniforms.gltf_u_dec_normal_rangeConstant=(1<<i.quantization.quantizationBits)-1)}getMaterial(){return this._material}getElements(){return this._geometry.getElements()}_getREGLAttrData(t,e){return this._geometry.getREGLData(t,e,this.disableVAO)}getREGLProps(t,e){const n=this.getUniforms(t);return Hx(n,this._getREGLAttrData(t,e)),Wx(t)&&!this.disableVAO||(n.elements=this._geometry.getElements()),n.meshProperties=this.properties,n.geometryProperties=this._geometry.properties,n.meshConfig=this.config,n.count=this._geometry.getDrawCount(),n.offset=this._geometry.getDrawOffset(),n.primitive=this._geometry.getPrimitive(),n}dispose(){return delete this._geometry,delete this._material,this.uniforms=null,this}isValid(){return this._geometry&&!this._geometry.isDisposed()&&(!this._material||!this._material.isDisposed())}getBoundingBox(){return this._geometry?(this._bbox||this.updateBoundingBox(),cy(ow,this.localTransform,this.positionMatrix),Iy(ow,this._currentTransform)&&this._geometry.boundingBox.equals(this._geoBox)||this.updateBoundingBox(),this._bboxArr):null}updateBoundingBox(){const t=this._geometry.boundingBox;this._bbox||(this._bbox=new db),this._bboxArr||(this._bboxArr=[[0,0,0],[0,0,0]]),this._geoBox||(this._geoBox=new db),db.copy(this._bbox,t),this._bbox.updateVertex(),"InstancedMesh"===this.constructor.name?(this._bbox.transform(this.localTransform,this.positionMatrix),this._currentTransform=cy(this._currentTransform||new Array(16),this.positionMatrix,this.localTransform)):(this._bbox.transform(this.positionMatrix,this.localTransform),this._currentTransform=cy(this._currentTransform||new Array(16),this.localTransform,this.positionMatrix)),db.copy(this._geoBox,t),Dy(this._bboxArr[0],this._bbox.min),Dy(this._bboxArr[1],this._bbox.max)}_createDefinesKey(t){const e=[];for(const n in t)e.push(n,t[n]);return e.join(",")}_incrVersion(){this._version++}getMemorySize(){return(this.geometry&&this.geometry.getMemorySize()||0)+(this.material&&this.material.getMemorySize()||0)}getWorldTransform(){const t=this.parent;return t?cy(new Array(16),t.getWorldTransform(),this.localTransform):this.localTransform}},lw=class ze extends aw{constructor(t,e,n,i,o={}){super(n,i,o),this._instanceCount=e,this.instancedData=t||{},this._checkInstancedProp(),this._vao={}}get instanceCount(){return this._instanceCount}set instanceCount(t){this._incrVersion(),this._instanceCount=t}getMemorySize(){return super.getMemorySize()+this._getInstanceMemorySize()}_getInstanceMemorySize(){let t=0;for(const e in this.instancedData)Zx(this.instancedData,e)&&(t+=qx(this.instancedData[e]));return t}_checkInstancedProp(){for(const t in this.instancedData)if(this.geometry.data[t])throw new Error(`Duplicate attribute ${t} defined in geometry and instanced data`)}_getREGLAttrData(t,e){const n=this.geometry.getAttrData(e);if(Wx(t)){const i=e.key;if(!this._vao[i]||this._vao[i].dirty){const o=e.map((t=>t.name)),s=[];for(let t=0;t<o.length;t++){const e=n[o[t]];s.push(e&&e.buffer||this.instancedData[o[t]])}const a={attributes:s,primitive:this.geometry.getPrimitive()};this._vao[i]?this._vao[i].vao(a):this._vao[i]={vao:t.vao(a)},delete this._vao[i].dirty}return this._vao[i]}return n}getDefines(){const t=super.getDefines();return t.HAS_INSTANCE=1,t}getCommandKey(t){return"i_"+super.getCommandKey(t)}updateInstancedData(t,e){const n=this.instancedData[t];if(this._incrVersion(),this.instancedData[t]=e,n&&n.buffer&&n.buffer.destroy&&n.buffer.destroy(),this._vao)for(const t in this._vao)this._vao[t].dirty=!0;return this}generateInstancedBuffers(t){const e=this.instancedData,n={};for(const i in e){if(!e[i])continue;const o=e[i];void 0!==o.buffer&&o.buffer.destroy?(n[i]=o,n[i].divisor&&(n[i].divisor=1)):n[i]=e[i].destroy?{buffer:e[i],divisor:1}:{buffer:t.buffer({data:e[i],dimension:e[i].length/this._instanceCount}),divisor:1}}return this.instancedData=n,this}getREGLProps(t,e){const n=super.getREGLProps(t,e);return Wx(t)||Hx(n,this.instancedData),n.elements=this.geometry.getElements(),n.instances=this._instanceCount,n}disposeInstancedData(){const t=this.instancedData;if(t)for(const e in t){if(!t[e])continue;const n=t[e].destroy?t[e]:t[e].buffer;n.destroy&&!n[sb]&&(n[sb]=1,n.destroy())}this.instancedData={};for(const t in this._vao)this._vao[t].vao.destroy();this._vao={}}};const hw={};let cw=class Ve{constructor(t){this.regl=t}render(t,e,n,i){t.setUniforms(e||hw),t.setFramebuffer(i);let o=0;if(n){const{opaques:e,transparents:i}=n.getSortedMeshes();o+=t.draw(this.regl,e),o+=t.draw(this.regl,i)}else o+=t.draw(this.regl);return o}clear(t){this.regl.clear(t)}};const uw={getArrayBuffer:(t,e)=>uw.get(t,{responseType:"arraybuffer"},e),get:function(t,e,n){const i=uw._getClient(n);if(i.open("GET",t,!0),e){for(const t in e.headers)i.setRequestHeader(t,e.headers[t]);i.withCredentials="include"===e.credentials,e.responseType&&(i.responseType=e.responseType)}return i.send(null),i},_wrapCallback:function(t,e){return function(){4===t.readyState&&(200===t.status?"arraybuffer"===t.responseType?0===t.response.byteLength?e(new Error("http status 200 returned without content.")):e(null,{data:t.response,cacheControl:t.getResponseHeader("Cache-Control"),expires:t.getResponseHeader("Expires"),contentType:t.getResponseHeader("Content-Type")}):e(null,t.responseText):e(new Error(t.statusText+","+t.status)))}},_getClient:function(t){let e;try{e=new XMLHttpRequest}catch(t){try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(t){try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(t){}}}return e.onreadystatechange=uw._wrapCallback(e,t),e}};let fw=class je{constructor(t,e){this.defaultTexture=t,this.defaultCubeTexture=new Array(6),this.urlModifier=e,this.resources={}}setURLModifier(t){this.urlModifier=t}get(t){return Array.isArray(t)?this._loadImages(t):this._loadImage(t)}getArrayBuffer(t){if(Array.isArray(t)){const e=t.map((t=>this.getArrayBuffer(t)));return Promise.all(e)}return new Promise(((e,n)=>{let i=t;this.urlModifier&&(i=this.urlModifier(t)),uw.getArrayBuffer(i,((i,o)=>{i?n(i):e({url:t,data:o})}))}))}disposeRes(t){return Array.isArray(t)?t.forEach((t=>this._disposeOne(t))):this._disposeOne(t),this}isLoading(){return this._count&&this._count>0}getDefaultTexture(t){return Array.isArray(t)?this._getBlankTextures(t.length):this.defaultTexture}_disposeOne(t){const e=this.resources;e[t]&&(e[t].count--,e[t].count<=0&&delete e[t])}_loadImage(t){const e=this.resources;return e[t]?Promise.resolve({url:t,data:e[t].image}):new Promise(((n,i)=>{const o=new Image;o.crossOrigin="anonymous",o.onload=function(){e[t]={image:o,count:1},n({url:t,data:o})},o.onerror=function(t){i(t)},o.onabort=function(){i(`image(${t}) loading aborted.`)},o.src=this.urlModifier?this.urlModifier(t):t}))}_loadImages(t){const e=t.map((t=>this._loadImage(t)));return Promise.all(e)}_getBlankTextures(t){const e=new Array(t);for(let t=0;t<6;t++)e.push(this.defaultTexture);return e}},dw=class Xe extends(ob(fw)){};const gw=[0,0,0],pw=[0,0,0];let Aw,mw=0;function yw(t,e){return Jy(gw,t.geometry.boundingBox.getCenter(),t.localTransform),Jy(pw,e.geometry.boundingBox.getCenter(),e.localTransform),r_(pw,Aw)-r_(gw,Aw)}let _w=class Ze{constructor(t){this._id=mw++,this.sortedMeshes={},this.setMeshes(t),this.dirty()}setMeshes(t){if(this.clear(),!t||Array.isArray(t)&&!t.length||t===this.meshes)return this;t=Array.isArray(t)?t:[t],this.meshes=[];for(let e=0;e<t.length;e++){const n=t[e];n&&(n._scenes=n._scenes||{},n._scenes[this._id]=1,this.meshes.push(n))}return this.dirty(),this}addMesh(t){if(!t||Array.isArray(t)&&!t.length)return this;if(Array.isArray(t))t.forEach((t=>{const e=t._scenes=t._scenes||{};e[this._id]||(e[this._id]=1,this.meshes.push(t),this.dirty())}));else{const e=t._scenes=t._scenes||{};e[this._id]||(e[this._id]=1,this.meshes.push(t),this.dirty())}return this}removeMesh(t){if(!t||Array.isArray(t)&&!t.length)return this;if(Array.isArray(t)){let e=!1;for(let n=0;n<t.length;n++){const i=t[n]._scenes;i&&i[this._id]&&(e=!0,this.dirty(),delete i[this._id])}e&&(this.meshes=this.meshes.filter((e=>t.indexOf(e)<0)))}else{const e=t._scenes;if(!e||!e[this._id])return this;const n=this.meshes.indexOf(t);n>=0&&this.meshes.splice(n,1),delete e[this._id],this.dirty()}return this}getMeshes(){return this.meshes||[]}clear(){if(this.meshes)for(let t=0;t<this.meshes.length;t++)delete this.meshes[t]._scenes[this._id];return this.meshes=[],this.sortedMeshes.opaques=[],this.sortedMeshes.transparents=[],this}dirty(){return this._dirty=!0,this}sortMeshes(t){const e=this.meshes;this.sortFunction&&e.sort(this.sortFunction);let n=this.sortedMeshes.transparents;if(this._dirty){const t=this.sortedMeshes.opaques=[];n=this.sortedMeshes.transparents=[];for(let i=0,o=e.length;i<o;i++)e[i].transparent?n.push(e[i]):t.push(e[i])}t&&n.length>1&&(Aw=t,n.sort(yw)),this._dirty=!1}getSortedMeshes(){return this._dirty&&this.sortMeshes(),this.sortedMeshes||{}}};const vw=String.fromCharCode,xw=8,bw=32767;function ww(t,e,n,i){if(t[3]>0){const o=Math.pow(2,t[3]-128-8+i);e[n+0]=t[0]*o,e[n+1]=t[1]*o,e[n+2]=t[2]*o}else e[n+0]=0,e[n+1]=0,e[n+2]=0;return e[n+3]=1,e}function Tw(t,e,n,i){let o=0,s=0,a=i;for(;a>0;)if(t[s][0]=e[n++],t[s][1]=e[n++],t[s][2]=e[n++],t[s][3]=e[n++],1===t[s][0]&&1===t[s][1]&&1===t[s][2]){for(let e=t[s][3]<<o>>>0;e>0;e--)(h=t[s])[0]=(l=t[s-1])[0],h[1]=l[1],h[2]=l[2],h[3]=l[3],s++,a--;o+=8}else s++,a--,o=0;var l,h;return n}function Mw(t,e,n,i){if(i<xw|i>bw)return Tw(t,e,n,i);let o=e[n++];if(2!==o)return Tw(t,e,n-1,i);if(t[0][1]=e[n++],t[0][2]=e[n++],o=e[n++],(t[0][2]<<8>>>0|o)>>>0!==i)return null;for(let o=0;o<4;o++)for(let s=0;s<i;){let i=e[n++];if(i>128){i=(127&i)>>>0;const a=e[n++];for(;i--;)t[s++][o]=a}else for(;i--;)t[s++][o]=e[n++]}return n}function Cw(t,e=0){const n=new Uint8Array(t),i=n.length;if("#?"!==function(t,e,n){let i="";for(let e=0;e<2;e++)i+=vw(t[e]);return i}(n))return null;for(var o=2;o<i&&("\n"!==vw(n[o])||"\n"!==vw(n[o+1]));o++);if(o>=i)return null;o+=2;let s="";for(;o<i;o++){const t=vw(n[o]);if("\n"===t)break;s+=t}const a=s.split(" "),l=parseInt(a[1]),h=parseInt(a[3]);if(!h||!l)return null;let c=o+1;const u=[];for(let t=0;t<h;t++){u[t]=[];for(let e=0;e<4;e++)u[t][e]=0}const f=new Float32Array(h*l*4);let g=0;for(let t=0;t<l;t++){if(c=Mw(u,n,c,h),!c)return null;for(let t=0;t<h;t++)ww(u[t],f,g,e),g+=4}return{width:h,height:l,pixels:f}}const Sw=function(){const t=new ArrayBuffer(4),e=new Float32Array(t),n=new Uint32Array(t),i=new Uint32Array(512),o=new Uint32Array(512);for(let t=0;t<256;++t){const e=t-127;e<-27?(i[t]=0,i[256|t]=32768,o[t]=24,o[256|t]=24):e<-14?(i[t]=1024>>-e-14,i[256|t]=1024>>-e-14|32768,o[t]=-e-1,o[256|t]=-e-1):e<=15?(i[t]=e+15<<10,i[256|t]=e+15<<10|32768,o[t]=13,o[256|t]=13):e<128?(i[t]=31744,i[256|t]=64512,o[t]=24,o[256|t]=24):(i[t]=31744,i[256|t]=64512,o[t]=13,o[256|t]=13)}const s=new Uint32Array(2048),a=new Uint32Array(64),l=new Uint32Array(64);for(let t=1;t<1024;++t){let e=t<<13,n=0;for(;!(8388608&e);)e<<=1,n-=8388608;e&=-8388609,n+=947912704,s[t]=e|n}for(let t=1024;t<2048;++t)s[t]=939524096+(t-1024<<13);for(let t=1;t<31;++t)a[t]=t<<23;a[31]=1199570944,a[32]=2147483648;for(let t=33;t<63;++t)a[t]=2147483648+(t-32<<23);a[63]=3347054592;for(let t=1;t<64;++t)32!==t&&(l[t]=1024);return{floatView:e,uint32View:n,baseTable:i,shiftTable:o,mantissaTable:s,exponentTable:a,offsetTable:l}}();const Pw=function(t){Math.abs(t)>65504&&console.warn("THREE.DataUtils.toHalfFloat(): Value out of range."),t=Vx(t,-65504,65504),Sw.floatView[0]=t;const e=Sw.uint32View[0],n=e>>23&511;return Sw.baseTable[n]+((8388607&e)>>Sw.shiftTable[n])};let Iw=class ct extends cb{onLoad({data:t}){const e=this.config;if(e){if(e.hdr){if(!(t=Cw(t.data,0)))throw new Error("Invalid hdr data"+(e.url?":"+e.url:""));{const n=new Uint16Array(t.pixels.length);for(let e=0;e<t.pixels.length;e++)n[e]=Math.min(Pw(t.pixels[e]),65504);e.data=n,e.type="float16",e.colorSpace="browser",e.min="linear",e.mag="linear"}}else e.data=t;e.width=e.width||t.width,e.height=e.height||t.height,this._regl&&this._checkNPOT(this._regl),this._updateREGL()}}createREGLTexture(t){if(this._regl=t,this._checkNPOT(t),jx(this.config.data)||jx(this.config.mipmap)){const e=Nb(t,this.config);return e[lb]||(e[lb]=0),e[lb]++,e}return t.texture(this.config)}_checkNPOT(t){const e=this.config;e.data&&this._needPowerOf2(t)&&(e.data instanceof Image?(e.data=nb(e.data),e.width=e.data.width,e.height=e.data.height):e.hdr||!jx(e.data)||tb(e.width)&&tb(e.height)||(e.data=nb(e.data,e.width,e.height),e.width=e.data.width,e.height=e.data.height))}},Ow=class lt extends vb{constructor(t){super({aPosition:new(Ux(t=t||0))([-1,-1,t,1,-1,t,-1,1,t,1,1,t]),aNormal:new Int8Array([0,0,1,0,0,1,0,0,1,0,0,1])},new Uint16Array([0,1,3,3,2,0]))}};const Ew={vsm_shadow_vert:"\nuniform mat4 shadow_lightProjViewModelMatrix;\nvarying vec4 shadow_vLightSpacePos;\nvoid shadow_computeShadowPars(vec4 position) {\n    shadow_vLightSpacePos = shadow_lightProjViewModelMatrix * position;\n}",vsm_shadow_frag:"\nuniform sampler2D shadow_shadowMap;\nuniform float shadow_opacity;\nuniform vec3 shadow_color;\n#if defined(USE_ESM)\n    uniform float esm_shadow_threshold;\n#endif\nvarying vec4 shadow_vLightSpacePos;\n#ifdef PACK_FLOAT\n    #include <common_pack_float>\n#endif\n#if defined(USE_ESM)\nfloat esm(vec3 projCoords, vec4 shadowTexel) {\n    float compare = projCoords.z;\n    float c = 120.0;\n    #ifdef PACK_FLOAT\n        float depth = common_decodeDepth(shadowTexel);\n        if (depth >= 1.0 - 1E-6 || compare <= depth) {\n            return 1.0;\n        }\n    #else\n        float depth = shadowTexel.r;\n    #endif\n    depth = exp(-c * min(compare - depth, 0.05));\n    return clamp(depth, esm_shadow_threshold, 1.0);\n}\n#endif\n#if defined(USE_VSM)\nfloat vsm_shadow_chebyshevUpperBound(vec3 projCoords, vec4 shadowTexel){\n    vec2 moments = shadowTexel.rg;\n    float distance = projCoords.z;\n    if (distance >= 1.0 || distance <= moments.x)\n        return 1.0 ;\n    float variance = moments.y - (moments.x * moments.x);\n    variance = max(variance, 0.00002);\n    float d = distance - moments.x;\n    float p_max = variance / (variance + d * d);\n    return p_max;\n}\n#endif\nfloat shadow_computeShadow_coeff(sampler2D shadowMap, vec3 projCoords) {\n    vec2 uv = projCoords.xy;\n    vec4 shadowTexel = texture2D(shadowMap, uv);\n    #if defined(USE_ESM)\n        float esm_coeff = esm(projCoords, shadowTexel);\n        float coeff = esm_coeff * esm_coeff;\n    #endif\n    #if defined(USE_VSM)\n        float vsm_coeff = vsm_shadow_chebyshevUpperBound(projCoords, shadowTexel);\n        float coeff = vsm_coeff;\n    #endif\n    return 1.0 - (1.0 - coeff) * shadow_opacity;\n}\nfloat shadow_computeShadow() {\n    vec3 projCoords = shadow_vLightSpacePos.xyz / shadow_vLightSpacePos.w;\n    projCoords = projCoords * 0.5 + 0.5;\n    if(projCoords.z >= 1.0 || projCoords.x < 0.0 || projCoords.x > 1.0 || projCoords.y < 0.0 || projCoords.y > 1.0) return 1.0;\n    return shadow_computeShadow_coeff(shadow_shadowMap, projCoords);\n}\nvec3 shadow_blend(vec3 color, float coeff) {\n    color = color * coeff + shadow_color * shadow_opacity * (1.0 - coeff);\n    return color;\n}",fbo_picking_vert:"\n#ifdef ENABLE_PICKING\n#if HAS_PICKING_ID == 1\nattribute float aPickingId;\n#elif HAS_PICKING_ID == 2\nuniform float uPickingId;\n#endif\nvarying float vPickingId;\nvarying float vFbo_picking_viewZ;\nvarying float vFbo_picking_visible;\n#endif\nvarying float vFbo_picking_fragDepth;\nvoid fbo_picking_setData(float viewPosZ, bool visible) {\n    #ifdef ENABLE_PICKING\n    #if HAS_PICKING_ID == 1\n       vPickingId = aPickingId;\n    #elif HAS_PICKING_ID == 2\n        vPickingId = uPickingId;\n    #endif\n        vFbo_picking_viewZ = viewPosZ;\n    #endif\n    vFbo_picking_visible = visible ? 1.0 : 0.0;\n    vFbo_picking_fragDepth = viewPosZ + 1.0;\n}",common_pack_float:"const float COMMON_FLOAT_MAX =  1.70141184e38;\nconst float COMMON_FLOAT_MIN = 1.17549435e-38;\nfloat common_packFloat(vec4 val){\n    vec4 scl = floor(255.0 * val + 0.5);\n    float sgn = (scl.a < 128.0) ? 1.0 : -1.0;\n    float exn = mod(scl.a * 2.0, 256.0) + floor(scl.b / 128.0) - 127.0;\n    float man = 1.0 +\n        (scl.r / 8388608.0) +\n        (scl.g / 32768.0) +\n        mod(scl.b, 128.0) / 128.0;\n    return sgn * man * pow(2.0, exn);\n}\nvec4 common_unpackFloat(highp float v) {\n    highp float av = abs(v);\n    if(av < COMMON_FLOAT_MIN) {\n        return vec4(0.0, 0.0, 0.0, 0.0);\n    } else if(v > COMMON_FLOAT_MAX) {\n        return vec4(127.0, 128.0, 0.0, 0.0) / 255.0;\n    } else if(v < -COMMON_FLOAT_MAX) {\n        return vec4(255.0, 128.0, 0.0, 0.0) / 255.0;\n    }\n    highp vec4 c = vec4(0,0,0,0);\n    highp float e = floor(log2(av));\n    highp float m = av * pow(2.0, -e) - 1.0;\n    c[1] = floor(128.0 * m);\n    m -= c[1] / 128.0;\n    c[2] = floor(32768.0 * m);\n    m -= c[2] / 32768.0;\n    c[3] = floor(8388608.0 * m);\n    highp float ebias = e + 127.0;\n    c[0] = floor(ebias / 2.0);\n    ebias -= c[0] * 2.0;\n    c[1] += floor(ebias) * 128.0;\n    c[0] += 128.0 * step(0.0, -v);\n    return c / 255.0;\n}\nvec4 common_encodeDepth(const in float depth) {\n    float alpha = 1.0;\n    vec4 pack = vec4(0.0);\n    pack.a = alpha;\n    const vec3 code = vec3(1.0, 255.0, 65025.0);\n    pack.rgb = vec3(code * depth);\n    pack.gb = fract(pack.gb);\n    pack.rg -= pack.gb * (1.0 / 256.0);\n    pack.b -= mod(pack.b, 4.0 / 255.0);\n    return pack;\n}\nfloat common_decodeDepth(const in vec4 pack) {\n    return pack.r + pack.g / 255.0;\n}",invert_matrix:"mat4 invert_matrix(mat4 matrix) {\n    #if __VERSION__ == 300\n        return inverse(matrix);\n    #else\n        vec4 vector1 = matrix[0], vector2 = matrix[1], vector3 = matrix[2], vector4 = matrix[3];\n        float a00 = vector1.x, a01 = vector1.y, a02 = vector1.z, a03 = vector1.w;\n        float a10 = vector2.x, a11 = vector2.y, a12 = vector2.z, a13 = vector2.w;\n        float a20 = vector3.x, a21 = vector3.y, a22 = vector3.z, a23 = vector3.w;\n        float a30 = vector4.x, a31 = vector4.y, a32 = vector4.z, a33 = vector4.w;\n        float b00 = a00 * a11 - a01 * a10;\n        float b01 = a00 * a12 - a02 * a10;\n        float b02 = a00 * a13 - a03 * a10;\n        float b03 = a01 * a12 - a02 * a11;\n        float b04 = a01 * a13 - a03 * a11;\n        float b05 = a02 * a13 - a03 * a12;\n        float b06 = a20 * a31 - a21 * a30;\n        float b07 = a20 * a32 - a22 * a30;\n        float b08 = a20 * a33 - a23 * a30;\n        float b09 = a21 * a32 - a22 * a31;\n        float b10 = a21 * a33 - a23 * a31;\n        float b11 = a22 * a33 - a23 * a32;\n        float det = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06;\n        det = 1.0 / det;\n        mat4 m = mat4(\n            (a11 * b11 - a12 * b10 + a13 * b09) * det,\n            (a02 * b10 - a01 * b11 - a03 * b09) * det,\n            (a31 * b05 - a32 * b04 + a33 * b03) * det,\n            (a22 * b04 - a21 * b05 - a23 * b03) * det,\n            (a12 * b08 - a10 * b11 - a13 * b07) * det,\n            (a00 * b11 - a02 * b08 + a03 * b07) * det,\n            (a32 * b02 - a30 * b05 - a33 * b01) * det,\n            (a20 * b05 - a22 * b02 + a23 * b01) * det,\n            (a10 * b10 - a11 * b08 + a13 * b06) * det,\n            (a01 * b08 - a00 * b10 - a03 * b06) * det,\n            (a30 * b04 - a31 * b02 + a33 * b00) * det,\n            (a21 * b02 - a20 * b04 - a23 * b00) * det,\n            (a11 * b07 - a10 * b09 - a12 * b06) * det,\n            (a00 * b09 - a01 * b07 + a02 * b06) * det,\n            (a31 * b01 - a30 * b03 - a32 * b00) * det,\n            (a20 * b03 - a21 * b01 + a22 * b00) * det\n        );\n        return m;\n    #endif\n}\nmat4 transpose_matrix(mat4 matrix) {\n    #if __VERSION__ == 300\n        return transpose(matrix);\n    #else\n        vec4 vector1 = matrix[0], vector2 = matrix[1], vector3 = matrix[2], vector4 = matrix[3];\n        float a01 = vector1.y, a02 = vector1.z, a03 = vector1.w;\n        float a12 = vector2.z, a13 = vector2.w;\n        float a23 = vector3.w;\n        mat4 m = mat4(\n            vector1.x,\n            vector2.x,\n            vector3.x,\n            vector4.x,\n            a01,\n            vector2.y,\n            vector3.y,\n            vector4.y,\n            a02,\n            a12,\n            vector3.z,\n            vector4.z,\n            a03,\n            a13,\n            a23,\n            vector4.w\n        );\n        return m;\n    #endif\n}",get_output:"#include <invert_matrix>\n#include <draco_decode_vert>\n#ifdef HAS_INSTANCE\n    #include <instance_vert>\n    #ifdef HAS_INSTANCE_COLOR\n        varying vec4 vInstanceColor;\n    #endif\n#endif\n#ifdef HAS_SKIN\n    uniform int skinAnimation;\n    #include <skin_vert>\n#endif\n#include <mask_vert>\n#ifdef HAS_MORPH\n    attribute vec3 POSITION0;\n    attribute vec3 POSITION1;\n    attribute vec3 POSITION2;\n    attribute vec3 POSITION3;\n    attribute vec3 POSITION4;\n    attribute vec3 POSITION5;\n    attribute vec3 POSITION6;\n    attribute vec3 POSITION7;\n    #ifdef HAS_MORPHNORMALS\n        attribute vec3 NORMAL0;\n        attribute vec3 NORMAL1;\n        attribute vec3 NORMAL2;\n        attribute vec3 NORMAL3;\n    #endif\n    uniform vec4 morphWeights1;\n    uniform vec4 morphWeights2;\n#endif\n#ifdef HAS_TERRAIN_ALTITUDE\nattribute float aTerrainAltitude;\n#endif\nmat4 getPositionMatrix() {\n    mat4 worldMatrix;\n    #ifdef HAS_INSTANCE\n        #ifdef HAS_INSTANCE_COLOR\n            vInstanceColor = instance_getInstanceColor();\n        #endif\n        mat4 attributeMatrix = instance_getAttributeMatrix();\n        #ifdef HAS_SKIN\n            if (skinAnimation == 1) {\n                worldMatrix = attributeMatrix * positionMatrix * skin_getSkinMatrix();\n            } else {\n                worldMatrix = attributeMatrix * positionMatrix;\n            }\n        #else\n            worldMatrix = attributeMatrix * positionMatrix;\n        #endif\n    #else\n        #ifdef HAS_SKIN\n            if (skinAnimation == 1) {\n                worldMatrix = skin_getSkinMatrix() * positionMatrix;\n            } else {\n                worldMatrix = positionMatrix;\n            }\n        #else\n            worldMatrix = positionMatrix;\n        #endif\n    #endif\n    return worldMatrix;\n}\n#ifdef HAS_MIN_ALTITUDE\nuniform float minAltitude;\n#endif\nvec4 getPosition(vec3 aPosition) {\n    vec3 position = decode_getPosition(aPosition);\n    #ifdef HAS_MORPH\n        vec4 POSITION = vec4(position + morphWeights1[0] * POSITION0 + morphWeights1[1] * POSITION1 + morphWeights1[2] * POSITION2 + morphWeights1[3] * POSITION3\n        + morphWeights2[0] * POSITION4 + morphWeights2[1] * POSITION5 + morphWeights2[2] * POSITION6 + morphWeights2[3] * POSITION7\n        , 1.0);\n    #else\n        vec4 POSITION = vec4(position, 1.0);\n    #endif\n    #ifdef HAS_TERRAIN_ALTITUDE\n        POSITION.z += aTerrainAltitude * 100.0;\n    #endif\n    #ifdef HAS_MIN_ALTITUDE\n        POSITION.z += minAltitude * 100.0;\n    #endif\n    return POSITION;\n}\nvec3 appendMorphNormal(vec3 NORMAL) {\n    #ifdef HAS_MORPHNORMALS\n        vec3 normal = NORMAL + morphWeights1[0] * NORMAL0 + morphWeights1[1] * NORMAL1 + morphWeights1[2] * NORMAL2 + morphWeights1[3] * NORMAL3;\n    #else\n        vec3 normal = NORMAL;\n    #endif\n    return normal;\n}",instance_vert:"attribute vec4 instance_vectorA;\nattribute vec4 instance_vectorB;\nattribute vec4 instance_vectorC;\n#ifdef HAS_INSTANCE_TERRAIN_ALTITUDE\nattribute float aTerrainAltitude;\nuniform float terrainAltitudeScale;\n#endif\nmat4 instance_getAttributeMatrix() {\n    mat4 mat =  mat4(\n        instance_vectorA.x, instance_vectorB.x, instance_vectorC.x, 0.0,\n        instance_vectorA.y, instance_vectorB.y, instance_vectorC.y, 0.0,\n        instance_vectorA.z, instance_vectorB.z, instance_vectorC.z, 0.0,\n        instance_vectorA.w, instance_vectorB.w, instance_vectorC.w, 1.0\n    );\n    #ifdef HAS_INSTANCE_TERRAIN_ALTITUDE\n        mat4 terrainMat = mat4(\n            1., 0., 0., 0.,\n            0., 1., 0., 0.,\n            0., 0., 1., 0.,\n            0., 0., aTerrainAltitude * terrainAltitudeScale, 1.\n        );\n        mat = terrainMat * mat;\n    #endif\n    return mat;\n}\n#ifdef HAS_INSTANCE_HIGHLIGHT\n    attribute vec4 highlight_color;\n#endif\n#ifdef HAS_INSTANCE_COLOR\n   \n    attribute vec4 instance_color;\n    vec4 instance_getInstanceColor() {\n        vec4 color = instance_color;\n        #ifdef HAS_INSTANCE_HIGHLIGHT\n            color = instance_color * highlight_color;\n        #endif\n        return color;\n    }\n#endif",skin_vert:"attribute vec4 WEIGHTS_0;\nattribute vec4 JOINTS_0;\nuniform sampler2D jointTexture;\nuniform vec2 jointTextureSize;\nuniform float numJoints;\n#define ROW0_U ((0.5 + 0.0) / 4.)\n#define ROW1_U ((0.5 + 1.0) / 4.)\n#define ROW2_U ((0.5 + 2.0) / 4.)\n#define ROW3_U ((0.5 + 3.0) / 4.)\nmat4 skin_getBoneMatrix(float jointNdx) {\n    float v = (jointNdx + 0.5) / numJoints;\n    return mat4(\n        texture2D(jointTexture, vec2(ROW0_U, v)),\n        texture2D(jointTexture, vec2(ROW1_U, v)),\n        texture2D(jointTexture, vec2(ROW2_U, v)),\n        texture2D(jointTexture, vec2(ROW3_U, v)));\n}\nmat4 skin_getSkinMatrix() {\n        mat4 skinMatrix = skin_getBoneMatrix(JOINTS_0[0]) * WEIGHTS_0[0] +\n                        skin_getBoneMatrix(JOINTS_0[1]) * WEIGHTS_0[1] +\n                        skin_getBoneMatrix(JOINTS_0[2]) * WEIGHTS_0[2] +\n                        skin_getBoneMatrix(JOINTS_0[3]) * WEIGHTS_0[3];\n        return skinMatrix;\n}",heatmap_render_vert:"#ifdef HAS_HEATMAP\nvarying vec2 heatmap_vTexCoord;\nvoid heatmap_compute(mat4 matrix, vec3 position) {\n    vec4 pos = matrix * vec4(position.xy, 0., 1.);\n    heatmap_vTexCoord = (1. + pos.xy / pos.w) / 2.;\n}\n#endif",heatmap_render_frag:"#ifdef HAS_HEATMAP\nuniform sampler2D heatmap_inputTexture;\nuniform sampler2D heatmap_colorRamp;\nuniform float heatmap_heatmapOpacity;\nvarying vec2 heatmap_vTexCoord;\nvec4 heatmap_getColor(vec4 color) {\n    float t = texture2D(heatmap_inputTexture, heatmap_vTexCoord).r;\n    vec4 heatmapColor = texture2D(heatmap_colorRamp, vec2(t, 0.5)) * heatmap_heatmapOpacity;\n    return color * (1.0 - heatmapColor.a) + heatmapColor * heatmapColor.a;\n}\n#endif",line_extrusion_vert:"#ifdef IS_LINE_EXTRUSION\n    #define ALTITUDE_SCALE 32767.0;\n    #define EXTRUDE_SCALE 63.0;\n    attribute vec2 aExtrude;\n    #ifdef HAS_LINE_WIDTH\n        attribute float aLineWidth;\n    #else\n        uniform float lineWidth;\n    #endif\n    #ifdef HAS_LINE_HEIGHT\n        attribute float aLineHeight;\n    #else\n        uniform float lineHeight;\n    #endif\n    uniform float linePixelScale;\n    vec3 getLineExtrudePosition(vec3 position) {\n        #ifdef HAS_LINE_WIDTH\n            float lineWidth = aLineWidth / 2.0;\n        #endif\n        #ifdef HAS_LINE_HEIGHT\n            float lineHeight = aLineHeight / 10.0;\n        #endif\n        float halfwidth = lineWidth / 2.0;\n        float outset = halfwidth;\n        vec2 dist = outset * aExtrude / EXTRUDE_SCALE;\n        position.z *= lineHeight / ALTITUDE_SCALE;\n        return position + vec3(dist, 0.0) * linePixelScale;\n    }\n#endif",gl2_vert:"#if __VERSION__ == 300\n    #define texture2D texture\n    #define varying out\n    #define attribute in\n#endif",gl2_frag:"#if __VERSION__ == 300\n    #define varying in\n    #define gl_FragDepthEXT gl_FragDepth\n    #define texture2D texture\n    #define textureCube texture\n    #define texture2DProj textureProj\n    #define texture2DLodEXT textureLod\n    #define texture2DProjLodEXT textureProjLod\n    #define textureCubeLodEXT textureLod\n    #define texture2DGradEXT textureGrad\n    #define texture2DProjGradEXT textureProjGrad\n    #define textureCubeGradEXT textureGrad\n    out vec4 glFragColor;\n#else\n    vec4 glFragColor;\n#endif",hsv_frag:"\nconst mediump vec4 HSV_K0 = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);\nconst mediump vec4 HSV_K1 = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);\nconst mediump float HSV_E = 1.0e-10;\nvec3 hsv_rgb2hsv(vec3 c) {\n    vec4 K = HSV_K0;\n    vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));\n    vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));\n    float d = q.x - min(q.w, q.y);\n    float e = HSV_E;\n    return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);\n}\nvec3 hsv_hsv2rgb(vec3 c) {\n    vec4 K = HSV_K1;\n    vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);\n    return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);\n}\nvec4 hsv_apply(vec4 c, vec3 hsvOffset) {\n    vec3 hsv = hsv_rgb2hsv(c.rgb);\n    hsv += hsv * hsvOffset;\n    hsv = clamp(hsv, 0.0, 1.0);\n    return vec4(hsv_hsv2rgb(hsv), c.a);\n}\nvec3 hsv_apply(vec3 c, vec3 hsvOffset) {\n    vec3 hsv = hsv_rgb2hsv(c.rgb);\n    hsv += hsv * hsvOffset;\n    hsv = clamp(hsv, 0.0, 1.0);\n    return hsv_hsv2rgb(hsv);\n}\nmat4 contrastMatrix(float contrast)\n{\n    float t = (1.0 - contrast) / 2.0;\n    return mat4(\n        contrast, 0., 0., 0.,\n        0., contrast, 0., 0.,\n        0., 0., contrast, 0.,\n        t, t, t, 1\n    );\n}",snow_frag:"#ifdef HAS_SNOW\n    float lerp(float a, float b, float w) {\n        return a + w * (b - a);\n    }\n    vec3 snow(vec4 sceneColor, vec3 normalColor, float height) {\n        float snowIntense = normalColor.b;\n        vec3 fixedC = vec3(1.0, 1.0, 1.0);\n        if (height < 1.0) {\n            float r = lerp(0.5, fixedC.x, snowIntense);\n            float g = lerp(0.5, fixedC.y, snowIntense);\n            float b = lerp(0.5, fixedC.z, snowIntense);\n            return vec3(r, g, b);\n        } else {\n            float r = lerp(sceneColor.r, fixedC.x, snowIntense);\n            float g = lerp(sceneColor.g, fixedC.y, snowIntense);\n            float b = lerp(sceneColor.b, fixedC.z, snowIntense);\n            return vec3(r, g, b);\n        }\n    }\n#endif",draco_decode_vert:"#if defined(HAS_TANGENT)\n    attribute vec4 aTangent;\n#elif defined(HAS_NORMAL)\n    #ifdef HAS_DRACO_NORMAL\n        attribute vec2 aNormal;\n        uniform float gltf_u_dec_normal_rangeConstant;\n    #else\n        attribute vec3 aNormal;\n    #endif\n#endif\n#ifdef HAS_DRACO_POSITION\n    uniform float gltf_u_dec_position_normConstant;\n    uniform vec3 minValues_pos;\n    vec3 decodeDracoPosition(vec3 aPosition) {\n        return minValues_pos + aPosition * gltf_u_dec_position_normConstant;\n    }\n#endif\n#ifdef HAS_DRACO_TEXCOORD\n    uniform vec2 minValues_tex;\n    uniform float gltf_u_dec_texcoord_0_normConstant;\n    vec2 decodeDracoTexcoord(vec2 aTexCoord) {\n        return minValues_tex + aTexCoord * gltf_u_dec_texcoord_0_normConstant;\n    }\n#endif\n#ifdef HAS_WEB3D_quantized_attributes_TEXCOORD\n    uniform mat3 decodeMatrix;\n#endif\n#ifdef HAS_DRACO_NORMAL\n    float czm_signNotZero(float value) {\n        return value >= 0.0 ? 1.0 : -1.0;\n    }\n    vec2 czm_signNotZero(vec2 value) {\n        return vec2(czm_signNotZero(value.x), czm_signNotZero(value.y));\n    }\n    vec3 decodeDracoNormal(vec2 encoded, float range)\n    {\n        if (encoded.x == 0.0 && encoded.y == 0.0) {\n            return vec3(0.0, 0.0, 0.0);\n        }\n        encoded = encoded / range * 2.0 - 1.0;\n        vec3 v = vec3(encoded.x, encoded.y, 1.0 - abs(encoded.x) - abs(encoded.y));\n        if (v.z < 0.0) {\n            v.xy = (1.0 - abs(v.yx)) * czm_signNotZero(v.xy);\n        }\n        return normalize(v);\n    }\n    vec3 decode_getNormal(vec2 aNormal) {\n        return decodeDracoNormal(aNormal, gltf_u_dec_normal_rangeConstant).zxy;\n    }\n#endif\n#ifdef HAS_COMPRESSED_INT16\n    #ifdef HAS_COMPRESSED_INT16_POSITION\n      uniform vec2 compressedPositionRange;\n    #endif\n    #ifdef HAS_COMPRESSED_INT16_TEXCOORD_0\n      uniform vec2 compressedTexcoordRange_0;\n    #endif\n    #ifdef HAS_COMPRESSED_INT16_TEXCOORD_1\n      uniform vec2 compressedTexcoordRange_1;\n    #endif\n    #ifdef HAS_COMPRESSED_INT16_NORMAL\n      uniform vec2 compressedNormalRange;\n    #endif\n    #ifdef HAS_COMPRESSED_INT16_RATIO\n      uniform float compressed_ratio;\n    #endif\n    float int16ToFloat32(float value, vec2 range) {\n        float v = (value >= 32768.0) ? -(65536.0 - value) / 32768.0 : value / 32767.0;\n        return (v + 1.0) * (range.y - range.x) / 2.0 + range.x;\n    }\n#endif\nvec3 decode_getPosition(vec3 aPosition) {\n    vec3 position = aPosition;\n    #if defined(HAS_COMPRESSED_INT16) && defined(HAS_COMPRESSED_INT16_POSITION)\n        float x = int16ToFloat32(aPosition.x, compressedPositionRange);\n        float y = int16ToFloat32(aPosition.y, compressedPositionRange);\n        float z = int16ToFloat32(aPosition.z, compressedPositionRange);\n        #ifdef HAS_COMPRESSED_INT16_RATIO\n          position = vec3(x / compressed_ratio, y / compressed_ratio, z);\n        #else\n          position = vec3(x, y, z);\n        #endif\n    #endif\n    #ifdef HAS_DRACO_POSITION\n        return decodeDracoPosition(position);\n    #else\n        return position;\n    #endif\n}\nvec2 decode_getTexcoord(vec2 aTexCoord) {\n    vec2 texcoord = aTexCoord;\n    #if defined(HAS_COMPRESSED_INT16) && (defined(HAS_COMPRESSED_INT16_TEXCOORD_0) || defined(HAS_COMPRESSED_INT16_TEXCOORD_1))\n        float x = int16ToFloat32(aTexCoord.x, compressedTexcoordRange_0);\n        float y = int16ToFloat32(aTexCoord.y, compressedTexcoordRange_0);\n        texcoord = vec2(x, y);\n    #endif\n    #ifdef HAS_DRACO_TEXCOORD\n        return decodeDracoTexcoord(texcoord);\n    #elif defined(HAS_WEB3D_quantized_attributes_TEXCOORD)\n        vec3 web3dTexcoord = decodeMatrix * vec3(texcoord, 1.0);\n        return vec2(web3dTexcoord.x, web3dTexcoord.y);\n    #else\n        return texcoord;\n    #endif\n}\nvec3 decode_getNormal(vec3 aNormal) {\n    #ifdef HAS_COMPRESSED_INT16_NORMAL\n        aNormal.x = int16ToFloat32(aNormal.x, compressedNormalRange);\n        aNormal.y = int16ToFloat32(aNormal.y, compressedNormalRange);\n        aNormal.z = int16ToFloat32(aNormal.z, compressedNormalRange);\n    #endif\n    return aNormal;\n}",highlight_vert:"#if defined(HAS_HIGHLIGHT_COLOR)\n    attribute vec4 aHighlightColor;\n    varying vec4 vHighlightColor;\n#endif\n#if defined(HAS_HIGHLIGHT_OPACITY)\n    attribute float aHighlightOpacity;\n    varying float vHighlightOpacity;\n#endif\nvoid highlight_setVarying() {\n    #if defined(HAS_HIGHLIGHT_COLOR)\n        vHighlightColor = aHighlightColor / 255.0;\n    #endif\n    #if defined(HAS_HIGHLIGHT_OPACITY)\n        vHighlightOpacity = aHighlightOpacity / 255.0;\n    #endif\n}",highlight_frag:"#if defined(HAS_HIGHLIGHT_COLOR)\n\tvarying vec4 vHighlightColor;\n#endif\n#if defined(HAS_HIGHLIGHT_OPACITY)\n    varying float vHighlightOpacity;\n#endif\nvec4 highlight_blendColor(vec4 color) {\n\tvec4 outColor;\n\t#if defined(HAS_HIGHLIGHT_COLOR)\n\t\tcolor.rgb = color.rgb * (1.0 - vHighlightColor.a) + vHighlightColor.rgb * vHighlightColor.a;\n\t\t#ifndef HAS_HIGHLIGHT_COLOR_POINT\n        \tcolor.a = color.a * (1.0 - vHighlightColor.a) + vHighlightColor.a;\n        #endif\n        outColor = color;\n\t#else\n\t\toutColor = color;\n\t#endif\n\t#if defined(HAS_HIGHLIGHT_OPACITY)\n\t\toutColor *= vHighlightOpacity;\n\t#endif\n\treturn outColor;\n}",mask_vert:"#ifdef HAS_MASK_EXTENT\n    uniform vec4 mask_extent;\n    uniform sampler2D mask_colorExtent;\n    uniform sampler2D mask_modeExtent;\n    uniform float mask_maskMode;\n    uniform float mask_hasFlatOut;\n    uniform mat4 viewMatrix;\n    uniform float mask_heightRatio;\n    uniform float mask_heightOffset;\n    varying vec4 vWorldPosition;\n    varying vec2 vUVInExtent;\n    varying float vHeightRatio;\n    varying float vHeightOffset;\n    const float CLIPINSIDE_MODE = 0.2;\n    const float FLATINSIDE_MODE = 0.3;\n    const float FLATOUTSIDE_MODE = 0.4;\n    const float ELEVATE_MODE = 0.7;\n    float random (vec2 st) {\n        return fract(sin(dot(st.xy,vec2(12.9898,78.233)))*43758.5453123) * 0.1;\n    }\n    bool isInExtent(vec4 color) {\n        return length(color.rgb) > 0.0;\n    }\n    float getFlatHeight(float maskMode, float flatHeight, float height) {\n      if (maskMode <= ELEVATE_MODE && maskMode > 0.6) {\n          return flatHeight + height;\n      } else {\n        return flatHeight;\n      }\n    }\n    vec4 getNoErrorPosition(vec4 position, vec4 wPosition) {\n      vec4 realPos = modelViewMatrix * position;      vec4 pos = viewMatrix * wPosition;      vec4 tempPos = viewMatrix * modelMatrix * position;      float deltaX = realPos.x - tempPos.x;\n      float deltaY = realPos.y - tempPos.y;\n      float deltaZ = realPos.z - tempPos.z;\n      pos.x = pos.x + deltaX;\n      pos.y = pos.y + deltaY;\n      pos.z = pos.z + deltaZ;\n      return pos;\n    }\n    vec4 getMaskPosition(vec4 position, mat4 modelMatrix) {\n        vWorldPosition = modelMatrix * position;\n        float w = mask_extent.z - mask_extent.x;\n        float h = mask_extent.y - mask_extent.w;\n        vec2 uvInExtent = vec2((vWorldPosition.x - mask_extent.x) / abs(w), 1.0 - (vWorldPosition.y - mask_extent.w) / h);\n        vec4 extentColor = texture2D(mask_colorExtent, uvInExtent);\n        vec3 maskOptionColor = texture2D(mask_modeExtent, uvInExtent).rgb;\n        float maskMode = maskOptionColor.r;\n        float flatHeight = maskOptionColor.g / mask_heightRatio + mask_heightOffset;\n        float height = getFlatHeight(maskMode, flatHeight, vWorldPosition.z);\n        vec4 wPosition = vec4(vWorldPosition.x, vWorldPosition.y, height, vWorldPosition.w);\n        vUVInExtent = uvInExtent;\n        vHeightRatio = mask_heightRatio;\n        vHeightOffset = mask_heightOffset;\n        if (maskMode <= FLATOUTSIDE_MODE && maskMode > FLATINSIDE_MODE) {\n            return modelViewMatrix * position;;\n        } else if (mask_hasFlatOut == 1.0) {\n            return getNoErrorPosition(position, wPosition);\n        }\n        if (isInExtent(extentColor) == true && maskMode <= FLATINSIDE_MODE && maskMode > CLIPINSIDE_MODE) {\n            return getNoErrorPosition(position, wPosition);\n        } if (isInExtent(extentColor) == true && maskMode <= ELEVATE_MODE && maskMode > 0.6) {\n            return getNoErrorPosition(position, wPosition);\n        } else {\n            return modelViewMatrix * position;\n        }\n    }\n#endif",mask_frag:"#ifdef HAS_MASK_EXTENT\n    uniform sampler2D mask_colorExtent;\n    uniform sampler2D mask_modeExtent;\n    uniform float mask_hasClipOut;\n    varying float vHeightRatio;\n    varying float vHeightOffset;\n    varying vec2 vUVInExtent;\n    varying vec4 vWorldPosition;\n    const float CLIPINSIDE_MODE = 0.1;\n    const float CLIPOUTSIDE_MODE = 0.2;\n    const float FLATINSIDE_MODE = 0.3;\n    const float FLATOUTSIDE_MODE = 0.4;\n    const float COLOR_MODE = 0.5;\n    const float VIDEO_MODE = 0.6;\n    bool isInExtent(vec4 color) {\n        return length(color.rgb) > 0.0;\n    }\n    vec4 setMask(vec4 glFragColor) {\n        vec4 extentColor = texture2D(mask_colorExtent, vUVInExtent);\n        vec4 modeColor = texture2D(mask_modeExtent, vUVInExtent);\n        float maskMode = modeColor.r;\n        float minHeight = modeColor.b / vHeightRatio + vHeightOffset;\n        float maxHeight = modeColor.a / vHeightRatio + vHeightOffset;\n        if (maskMode > CLIPINSIDE_MODE && maskMode <= CLIPOUTSIDE_MODE) {\n            if (minHeight == 0.0 && maxHeight == 0.0) {\n                return glFragColor;\n            } else if (vWorldPosition.z >= minHeight && vWorldPosition.z <= maxHeight) {\n                return glFragColor;\n            } else {\n              discard;\n            }\n        } else if (mask_hasClipOut == 1.0) {\n            discard;\n        }\n        if (isInExtent(extentColor) == true && maskMode <= CLIPINSIDE_MODE && maskMode > 0.0) {\n            if (minHeight == 0.0 && maxHeight == 0.0) {\n                discard;\n            } else if (vWorldPosition.z >= minHeight && vWorldPosition.z <= maxHeight) {\n                discard;\n            } else {\n              return glFragColor;\n            }\n        } else if (isInExtent(extentColor) == true && maskMode <= VIDEO_MODE && maskMode > FLATOUTSIDE_MODE) {\n            if (minHeight == 0.0 && maxHeight == 0.0) {\n                glFragColor = vec4(mix(extentColor.rgb, glFragColor.rgb, 1.0 - extentColor.a), glFragColor.a);\n            } else if (vWorldPosition.z >= minHeight && vWorldPosition.z <= maxHeight) {\n                glFragColor = vec4(mix(extentColor.rgb, glFragColor.rgb, 1.0 - extentColor.a), glFragColor.a);\n            }\n        }\n        return glFragColor;\n    }\n#endif",computeTexcoord_frag:"#ifdef HAS_KHR_TEXTURE_TRANSFORM\n    uniform vec2 khr_offset;\n    uniform float khr_rotation;\n    uniform vec2 khr_scale;\n    vec2 khr_tex_transformTexCoord(vec2 texCoords, vec2 offset, float rotation, vec2 scale) {\n        rotation = -rotation;\n        mat3 transform = mat3(\n        cos(rotation) * scale.x, sin(rotation) * scale.x, 0.0, -sin(rotation) * scale.y, cos(rotation) * scale.y, 0.0, offset.x, offset.y, 1.0);\n        vec2 transformedTexCoords = (transform * vec3(fract(texCoords), 1.0)).xy;\n        return transformedTexCoords;\n    }\n#endif\nvarying highp vec2 vTexCoord;\n#ifdef HAS_I3S_UVREGION\n    varying vec4 vUvRegion;\n#endif\nvec2 computeTexCoord(vec2 texCoord) {\n    #ifdef HAS_I3S_UVREGION\n        vec2 atlasScale = vUvRegion.zw - vUvRegion.xy;\n        vec2 uvAtlas = fract(texCoord) * atlasScale + vUvRegion.xy;\n        return uvAtlas;\n    #elif defined(HAS_KHR_TEXTURE_TRANSFORM)\n        return khr_tex_transformTexCoord(texCoord, khr_offset, khr_rotation, khr_scale);\n    #else\n        return texCoord;\n    #endif\n}",terrain_normal_frag:"#ifdef HAS_TERRAIN_NORMAL\n    uniform sampler2D terrainHeightTexture;\n    uniform vec2 terrainHeightMapResolution;\n    uniform vec2 terrainResolution;\n    uniform vec4 terrainUnpackFactors;\n    float getHeight(vec2 uv) {\n        vec4 color = texture2D(terrainHeightTexture, uv) * 255.0;\n        color.a = -1.0;\n        return dot(color, terrainUnpackFactors) / 4.0;\n    }\n    vec3 convertTerrainHeightToNormalMap(vec2 uv) {\n        uv.y = 1.0 - uv.y;\n        vec2 epsilon = 1.0 / terrainHeightMapResolution;\n        float a = getHeight(uv + vec2(-epsilon.x, -epsilon.y));\n        float b = getHeight(uv + vec2(0, -epsilon.y));\n        float c = getHeight(uv + vec2(epsilon.x, -epsilon.y));\n        float d = getHeight(uv + vec2(-epsilon.x, 0));\n        float e = getHeight(uv + vec2(epsilon.x, 0));\n        float f = getHeight(uv + vec2(-epsilon.x, epsilon.y));\n        float g = getHeight(uv + vec2(0, epsilon.y));\n        float h = getHeight(uv + vec2(epsilon.x, epsilon.y));\n        vec2 dxy = vec2(\n            (c + e + e + h) - (a + d + d + f),\n            (f + g + g + h) - (a + b + b + c)\n        );\n        return normalize(vec3(dxy / epsilon, terrainResolution ));\n    }\n#endif",vertex_color_vert:"#ifdef HAS_VERTEX_COLOR\nattribute float aVertexColorType;\nuniform vec4 vertexColorsOfType[VERTEX_TYPES_COUNT];\nvarying vec4 vertexColor_color;\nvoid vertexColor_update() {\n    vertexColor_color = vertexColorsOfType[int(aVertexColorType)];\n}\n#endif\n//: topPolygonFill  bottomPolygonFill",vertex_color_frag:"#ifdef HAS_VERTEX_COLOR\nvarying vec4 vertexColor_color;\nvec4 vertexColor_get() {\n\treturn vertexColor_color;\n}\n#endif",excavate_vert:"#ifdef HAS_EXCAVATE_ANALYSIS\n  uniform vec4 excavateExtent;\n  varying vec2 vCoordinateTexcoord;\n  varying float vHeight;\n  float getWorldHeight() {\n    vec4 wPosition = modelMatrix * getPosition(aPosition);\n    return wPosition.z;\n  }\n  vec2 getCoordinateTexcoord() {\n    mat4 localPositionMatrix = getPositionMatrix();\n    vec4 wPosition = modelMatrix * localPositionMatrix * getPosition(aPosition);\n    float x = (wPosition.x - excavateExtent.x) / (excavateExtent.z - excavateExtent.x);\n    float y = (wPosition.y - excavateExtent.y) / (excavateExtent.w - excavateExtent.y);\n    return vec2(x, y);\n  }\n#endif",excavate_frag:"#ifdef HAS_EXCAVATE_ANALYSIS\n  uniform sampler2D heightmap;\n  uniform float excavateHeight;\n  varying vec2 vCoordinateTexcoord;\n  varying float vHeight;\n  const vec2 range = vec2(-100.0, 1000.0);\n  float decodeHeight(const in vec4 pack) {\n      return pack.r + pack.g / 255.0;\n  }\n  vec4 excavateColor(vec4 fragColor) {\n      float samplerHeight = decodeHeight(texture2D(heightmap, vCoordinateTexcoord));\n      float realHeight = samplerHeight * (range.y - range.x) + range.x;\n      if(realHeight < range.x || realHeight > range.y) {\n          realHeight = 0.0;\n      }\n      if(vHeight > realHeight) {\n          discard;\n      }\n      return fragColor;\n  }\n#endif",srgb_frag:"vec3 linearTosRGB(const in vec3 color) {\n    return vec3( color.r < 0.0031308 ? color.r * 12.92 : 1.055 * pow(color.r, 1.0/2.4) - 0.055, color.g < 0.0031308 ? color.g * 12.92 : 1.055 * pow(color.g, 1.0/2.4) - 0.055, color.b < 0.0031308 ? color.b * 12.92 : 1.055 * pow(color.b, 1.0/2.4) - 0.055);\n}\nvec3 sRGBToLinear(const in vec3 color) {\n    return vec3( color.r < 0.04045 ? color.r * (1.0 / 12.92) : pow((color.r + 0.055) * (1.0 / 1.055), 2.4), color.g < 0.04045 ? color.g * (1.0 / 12.92) : pow((color.g + 0.055) * (1.0 / 1.055), 2.4), color.b < 0.04045 ? color.b * (1.0 / 12.92) : pow((color.b + 0.055) * (1.0 / 1.055), 2.4));\n}"};var kw={register(t,e){if(Ew[t])throw new Error(`Key of ${t} is already registered in ShaderLib.`);Ew[t]=e},compile:t=>Lw(t)};const Rw=/^[ \t]*#include +<([\w\d.]+)>/gm;function Lw(t){return t.replace(Rw,Dw)}function Dw(t,e){const n=Ew[e];if(!n)throw new Error("Can not resolve #include <"+e+">");return Lw(n)}let Fw=0;const Nw={};let Hw=class pt{constructor({vert:t,frag:e,uniforms:n,defines:i,extraCommandProps:o}){this.vert=t,this.frag=e;const s=Fw++;Object.defineProperty(this,"uid",{enumerable:!0,configurable:!1,get:()=>s}),this.shaderDefines=i&&Hx({},i)||{},n=this.uniforms=(n||[]).slice(),this.contextDesc={};for(let t=0,e=n.length;t<e;t++){const e=n[t];if(Lx(e))if(e.indexOf("[")>0){const{name:t,len:n}=Bw(e);this.contextDesc[t]={name:t,type:"array",length:n}}else this.contextDesc[e]=null;else if(e.name.indexOf("[")>0){const{name:t,len:n}=Bw(e.name);this.contextDesc[t]={name:t,type:"array",length:n,fn:e.fn}}else this.contextDesc[e.name]=e}this.extraCommandProps=o&&Hx({},o)||{},this.commands={},this._compileSource()}set shaderDefines(t){this._shaderDefines=t,this.dkey=Object.keys(this._shaderDefines).join()}get shaderDefines(){return this._shaderDefines||{}}setDefines(t){this.shaderDefines=t}setFramebuffer(t){return this.context.framebuffer=t,this}appendDescUniforms(t,e){const n=e,i=this.contextDesc;for(const o in i)if(i[o])if("array"===i[o].type){const s=o,a=i[o].length;let l=e[o];if(i[o].fn&&(l=i[o].fn(null,e)),!l)continue;if(l.length!==a)throw new Error(`${s} uniform's length is not ${a}`);n[s]=n[s]||{};for(let e=0;e<a;e++)n[s][`${e}`]=l[e].getREGLTexture?l[e].getREGLTexture(t):l[e]}else"function"===i[o].type&&(Object.getOwnPropertyDescriptor(n,o)||Object.defineProperty(n,o,{configurable:!1,enumerable:!0,get:function(){return i[o].fn(null,e)}}));return n}setUniforms(t){if(t.modelMatrix||t.positionMatrix)throw new Error("modelMatrix or positionMatrix is reserved uniform name for Mesh, please change to another name");return this.contextKeys=t?Object.keys(t).join():null,this.context=t,this}getVersion(t,e){return"#version"===e.substring(0,8)?"":0===t.limits.version.indexOf("WebGL 2.0")&&300===this.version?"#version 300 es\n":"#version 100\n"}getActiveVars(t,e,n,i){const o=i;if(Nw[o])return Nw[o];const s=t._gl,a=s.createProgram(),l=s.createShader(35633);s.shaderSource(l,e),s.compileShader(l);const h=s.createShader(35632);s.shaderSource(h,n),s.compileShader(h),s.attachShader(a,h),s.attachShader(a,l),s.linkProgram(a);const c=s.getProgramParameter(a,35721),u=[];for(let t=0;t<c;++t){const e=s.getActiveAttrib(a,t);e&&u.push({name:e.name,type:e.type})}const f=s.getProgramParameter(a,35718),g=[];for(let t=0;t<f;++t){const e=s.getActiveUniform(a,t);let n=e.name;e.name.indexOf("[")>0&&(n=n.replace("[0]","")),g.push(n)}return s.deleteProgram(a),s.deleteShader(l),s.deleteShader(h),Nw[o]={activeUniforms:g,activeAttributes:u},Nw[o]}createREGLCommand(t,e,n,i,o,s={}){const a=Wx(t)&&!o,l=Hx({},this.shaderDefines||{},e||{}),h=this._insertDefines(this.vert,l),c=this.getVersion(t,h)+h,u=this._insertDefines(this.frag,l),f=this.getVersion(t,u)+u,g=$x(c)+"_"+$x(f),{activeAttributes:A,activeUniforms:m}=this.getActiveVars(t,c,f,g),w={};A.forEach(((e,n)=>{const i=e.name;w[i]=a?n:t.prop(i)}));const T={};m.forEach((e=>{T[e]=t.prop(e)}));const M=this.contextDesc;for(const e in M)if(M[e]&&"function"===M[e].type)T[e]=M[e].fn;else if(M[e]&&"array"===M[e].type){const n=M[e].name,i=M[e].length;for(let e=0;e<i;e++){const i=`${n}[${e}]`;T[i]=t.prop(i)}}else T[e]=t.prop(e);const C={vert:c,frag:f,uniforms:T,attributes:w};a&&(C.vao=t.prop("vao")),a&&!i||!n||zx(n)||(C.elements=t.prop("elements")),C.count=t.prop("count"),C.offset=t.prop("offset"),C.primitive=t.prop("primitive"),C.framebuffer=t.prop("framebuffer"),i&&(C.instances=t.prop("instances")),Hx(C,this.extraCommandProps,s);const P=t(C);return A.key=A.map((t=>t.name)).join(),P.activeAttributes=A,P}dispose(){for(const t in this.commands){const e=this.commands[t];e&&e.destroy&&!e[sb]&&(e[sb]=!0,e.destroy())}this.commands={},delete this.vert,delete this.frag}_insertDefines(t,e){const n=[];for(const t in e)Zx(e,t)&&!Nx(e[t])&&n.push(`#define ${t} ${e[t]}\n`);return n.join("")+t}_compileSource(){this.vert=kw.compile(this.vert),this.frag=kw.compile(this.frag)}};function Bw(t){const e=t.indexOf("["),n=t.indexOf("]");return{name:t.substring(0,e),len:+t.substring(e+1,n)}}let zw=class yt extends Hw{draw(t,e){if(!e||!e.length)return 0;const n=[];let i,o=0;for(let s=0,a=e.length;s<a;s++){if(!e[s].isValid()){s===a-1&&i&&n.length&&i(n);continue}if(!e[s].geometry.getDrawCount()||!this._runFilter(e[s])){s===a-1&&i&&n.length&&i(n);continue}const l=this.getMeshCommand(t,e[s]);n.length&&i!==l&&(i(n),n.length=0);const h=e[s].getREGLProps(t,l.activeAttributes);this._ensureContextDefines(h),h.shaderContext=this.context,this.appendDescUniforms(t,h),n.push(h),o++,s<a-1?i=l:s===a-1&&l(n)}return o}_ensureContextDefines(t){if(this.context&&(t.contextKeys||(t.contextKeys={}),t.contextKeys[this.uid]!==this.contextKeys)){for(const e in this.context)"framebuffer"===e||Object.getOwnPropertyDescriptor(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:function(){return this.shaderContext[e]}});Object.getOwnPropertyDescriptor(t,"framebuffer")||Object.defineProperty(t,"framebuffer",{configurable:!1,enumerable:!0,get:function(){return this.targetFramebuffer||this.shaderContext&&this.shaderContext.framebuffer}}),t.contextKeys[this.uid]=this.contextKeys}}_runFilter(t){const e=this.filter;if(!e)return!0;if(Array.isArray(e)){for(let n=0;n<e.length;n++)if(!e[n](t))return!1;return!0}return e(t)}getMeshCommand(t,e){this._cmdKeys||(this._cmdKeys={});const n=this.dkey||"default";let i=this._cmdKeys[n];i||(i=this._cmdKeys[n]={});const o=e.getCommandKey(t);i[o]||(i[o]=n+"_"+e.getCommandKey(t));const s=i[o];let a=this.commands[s];if(!a){const n=e.getDefines(),i=e.getMaterial(),o={};i&&i.doubleSided&&this.extraCommandProps&&(o.cull={enable:!1}),a=this.commands[s]=this.createREGLCommand(t,n,e.getElements(),e instanceof lw,e.disableVAO,o)}return a}},Gw=class St extends zw{constructor(t={}){const e=[],n=[],i=t.uniforms,o=[{name:"modelNormalMatrix",type:"function",fn:function(t,n){return Qm(e,n.modelMatrix)}},{name:"modelViewMatrix",type:"function",fn:function(t,e){return cy(n,e.viewMatrix,e.modelMatrix)}}];i&&o.push(...i),super({vert:t.vert||"#include <gl2_vert>\nattribute vec3 aPosition;\n#include <line_extrusion_vert>\n#ifdef HAS_MAP\nuniform vec2 uvScale;\nuniform vec2 uvOffset;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\n#ifdef HAS_I3S_UVREGION\nattribute vec4 uvRegion;\nvarying vec4 vUvRegion;\n#endif\n#if defined(HAS_AO_MAP)\nattribute vec2 aTexCoord1;\nvarying vec2 vTexCoord1;\n#endif\n#endif\n#if defined(HAS_COLOR)\nattribute vec4 aColor;\nvarying vec4 vColor;\n#elif defined(HAS_COLOR0)\n#if COLOR0_SIZE == 3\nattribute vec3 aColor0;\n#else\nattribute vec4 aColor0;\n#endif\nvarying vec4 vColor;\n#endif\nvarying vec3 vFragPos;\nvarying vec3 vNormal;\nuniform mat4 projMatrix;\nuniform mat3 modelNormalMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 positionMatrix;\nuniform vec2 halton;\nuniform vec2 outSize;\nuniform mat4 projViewMatrix;\n#include <highlight_vert>\n#include <get_output>\n#include <heatmap_render_vert>\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_vert>\n#endif\n#ifdef HAS_EXTRUSION_OPACITY\nattribute float aExtrusionOpacity;\nvarying float vExtrusionOpacity;\n#endif\n#if defined(HAS_TANGENT)\nvarying vec4 vTangent;\n#endif\nvoid c(const highp vec4 q, out highp vec3 d) {\n  d = vec3(.0, .0, 1.) + vec3(2., -2., -2.) * q.x * q.zwx + vec3(2., 2., -2.) * q.y * q.wzy;\n}\nvoid c(const highp vec4 q, out highp vec3 d, out highp vec3 t) {\n  c(q, d);\n  t = vec3(1., .0, .0) + vec3(-2., 2., -2.) * q.y * q.yxw + vec3(-2., 2., 2.) * q.z * q.zwx;\n}\n#include <vertex_color_vert>\nvoid main() {\n  \n#ifdef IS_LINE_EXTRUSION\nvec4 e = getPosition(getLineExtrudePosition(aPosition));\n#else\nvec4 e = getPosition(aPosition);\n#endif\nmat4 f = getPositionMatrix();\n  vFragPos = vec3(modelMatrix * f * e);\n#if defined(HAS_NORMAL) || defined(HAS_TANGENT)\nmat3 h = modelNormalMatrix * mat3(f);\n  vec3 i;\n#if defined(HAS_TANGENT)\nvec3 t;\n  c(aTangent, i, t);\n  vTangent = vec4(h * t, aTangent.w);\n#else\ni = decode_getNormal(aNormal);\n#endif\nvec3 j = appendMorphNormal(i);\n  vNormal = normalize(h * j);\n#else\nvNormal = vec3(.0);\n#endif\nmat4 k = projMatrix;\n  k[2].xy += halton.xy / outSize.xy;\n#ifdef HAS_MASK_EXTENT\ngl_Position = k * getMaskPosition(f * e, modelMatrix);\n#else\ngl_Position = k * modelViewMatrix * f * e;\n#endif\n#ifdef HAS_MAP\nvec2 l = decode_getTexcoord(aTexCoord);\n  vTexCoord = l * uvScale + uvOffset;\n#endif\n#ifdef HAS_AO_MAP\nvec2 m = decode_getTexcoord(aTexCoord1);\n  vTexCoord1 = m * uvScale + uvOffset;\n#endif\n#ifdef HAS_EXTRUSION_OPACITY\nvExtrusionOpacity = aExtrusionOpacity;\n#endif\n#if defined(HAS_COLOR)\nvColor = aColor / 255.;\n#elif defined(HAS_COLOR0)\n#if COLOR0_SIZE == 3\nvColor = vec4(aColor0 / 255., 1.);\n#else\nvColor = aColor0 / 255.;\n#endif\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nshadow_computeShadowPars(f * e);\n#endif\n#ifdef HAS_HEATMAP\nheatmap_compute(projMatrix * modelViewMatrix * f, e);\n#endif\n#ifdef HAS_I3S_UVREGION\nvUvRegion = uvRegion / 65535.;\n#endif\nhighlight_setVarying();\n#ifdef HAS_VERTEX_COLOR\nvertexColor_update();\n#endif\n}",frag:t.frag||"precision mediump float;\n#include <gl2_frag>\nuniform vec4 baseColorFactor;\nuniform float materialShininess;\nuniform float environmentExposure;\nuniform float specularStrength;\nuniform vec3 light0_viewDirection;\nuniform vec3 ambientColor;\nuniform vec4 light0_diffuse;\nuniform vec3 lightSpecular;\nuniform vec3 cameraPosition;\nuniform float alphaTest;\n#ifdef HAS_TOON\nuniform float toons;\nuniform float specularToons;\n#endif\n#ifdef HAS_TANGENT\nvarying vec4 vTangent;\n#endif\n#ifdef HAS_MAP\n#include <computeTexcoord_frag>\n#endif\nvarying vec3 vNormal;\nvarying vec3 vFragPos;\n#ifdef HAS_INSTANCE_COLOR\nvarying vec4 vInstanceColor;\n#endif\n#ifdef HAS_BASECOLOR_MAP\nuniform sampler2D baseColorTexture;\n#endif\n#ifdef HAS_EXTRUSION_OPACITY\nuniform vec2 extrusionOpacityRange;\nvarying float vExtrusionOpacity;\n#endif\n#if defined(HAS_COLOR) || defined(HAS_COLOR0)\nvarying vec4 vColor;\n#elif defined(IS_LINE_EXTRUSION)\nuniform vec4 lineColor;\n#else\nuniform vec4 polygonFill;\n#endif\n#ifdef HAS_LAYER_OPACITY\nuniform float layerOpacity;\n#endif\n#ifdef IS_LINE_EXTRUSION\nuniform float lineOpacity;\n#else\nuniform float polygonOpacity;\n#endif\n#ifdef HAS_AO_MAP\nuniform sampler2D occlusionTexture;\nvarying vec2 vTexCoord1;\n#endif\n#ifdef HAS_NORMAL_MAP\nuniform sampler2D normalTexture;\n#endif\n#ifdef HAS_EMISSIVE_MAP\nuniform sampler2D emissiveTexture;\n#endif\n#ifdef SHADING_MODEL_SPECULAR_GLOSSINESS\nuniform vec4 diffuseFactor;\nuniform vec3 specularFactor;\n#ifdef HAS_DIFFUSE_MAP\nuniform sampler2D diffuseTexture;\n#endif\n#ifdef HAS_SPECULARGLOSSINESS_MAP\nuniform sampler2D specularGlossinessTexture;\n#endif\n#endif\n#include <heatmap_render_frag>\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_frag>\n#endif\n#include <highlight_frag>\n#include <mask_frag>\n#include <vertex_color_frag>\nvec3 c() {\n  \n#if defined(HAS_NORMAL_MAP)\nvec3 d = normalize(vNormal);\n  vec3 e = texture2D(normalTexture, computeTexCoord(vTexCoord)).xyz * 2. - 1.;\n#if defined(HAS_TANGENT)\nvec3 t = normalize(vTangent.xyz);\n  vec3 b = normalize(cross(d, t) * sign(vTangent.w));\n  mat3 f = mat3(t, b, d);\n  return normalize(f * e);\n#else\nreturn normalize(e);\n#endif\n#else\nreturn normalize(vNormal);\n#endif\n}\nvec4 h() {\n  \n#if defined(HAS_BASECOLOR_MAP)\nreturn texture2D(baseColorTexture, computeTexCoord(vTexCoord));\n#elif defined(HAS_DIFFUSE_MAP)\nreturn texture2D(diffuseTexture, computeTexCoord(vTexCoord));\n#elif defined(SHADING_MODEL_SPECULAR_GLOSSINESS)\nreturn diffuseFactor;\n#else\nreturn baseColorFactor;\n#endif\n}\nvec3 i() {\n  \n#if defined(HAS_SPECULARGLOSSINESS_MAP)\nreturn texture2D(specularGlossinessTexture, computeTexCoord(vTexCoord)).rgb;\n#elif defined(SHADING_MODEL_SPECULAR_GLOSSINESS)\nreturn specularFactor;\n#else\nreturn vec3(1.);\n#endif\n}\nvoid main() {\n  vec4 j = h();\n  vec3 k = environmentExposure * ambientColor * j.rgb;\n#ifdef HAS_INSTANCE_COLOR\nk *= vInstanceColor.rgb;\n#endif\nvec3 l = c();\n  vec3 m = normalize(-light0_viewDirection);\n  float o = max(dot(l, m), .0);\n#ifdef HAS_TOON\nfloat u = floor(o * toons);\n  o = u / toons;\n#endif\nvec3 v = light0_diffuse.rgb * o * j.rgb;\n#if defined(HAS_COLOR) || defined(HAS_COLOR0)\nvec3 A = vColor.rgb;\n#elif defined(IS_LINE_EXTRUSION)\nvec3 A = lineColor.rgb;\n#else\nvec3 A = polygonFill.rgb;\n#endif\n#ifdef HAS_INSTANCE_COLOR\nA *= vInstanceColor.rgb;\n#endif\nk *= A.rgb;\n  v *= A.rgb;\n  vec3 B = normalize(cameraPosition - vFragPos);\n  vec3 C = normalize(m + B);\n  float D = pow(max(dot(l, C), .0), materialShininess);\n#ifdef HAS_TOON\nfloat E = floor(D * specularToons);\n  D = E / specularToons;\n#endif\nvec3 F = specularStrength * lightSpecular * D * i();\n#ifdef HAS_OCCLUSION_MAP\nfloat G = texture2D(occlusionTexture, computeTexCoord(vTexCoord1)).r;\n  k *= G;\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nfloat H = shadow_computeShadow();\n  v = shadow_blend(v, H).rgb;\n  F = shadow_blend(F, H).rgb;\n  k = shadow_blend(k, H).rgb;\n#endif\nvec3 I = k + v + F;\n#ifdef HAS_EMISSIVE_MAP\nvec3 J = texture2D(emissiveTexture, computeTexCoord(vTexCoord)).rgb;\n  I += J;\n#endif\n#ifdef IS_LINE_EXTRUSION\nglFragColor = vec4(I, lineOpacity * j.a);\n#else\nglFragColor = vec4(I, polygonOpacity * j.a);\n#endif\n#if defined(HAS_COLOR) || defined(HAS_COLOR0)\nfloat K = vColor.a;\n#elif defined(IS_LINE_EXTRUSION)\nfloat K = lineColor.a;\n#else\nfloat K = polygonFill.a;\n#endif\nglFragColor *= K;\n#ifdef HAS_EXTRUSION_OPACITY\nfloat L = extrusionOpacityRange.x;\n  float M = extrusionOpacityRange.y;\n  float N = L + vExtrusionOpacity * (M - L);\n  N = clamp(N, .0, 1.);\n  glFragColor *= N;\n#endif\nif(glFragColor.a < alphaTest) {\n    discard;\n  }\n#ifdef HAS_VERTEX_COLOR\nglFragColor *= vertexColor_get();\n#endif\n#ifdef HAS_HEATMAP\nglFragColor = heatmap_getColor(glFragColor);\n#endif\nglFragColor = highlight_blendColor(glFragColor);\n#ifdef HAS_LAYER_OPACITY\nglFragColor *= layerOpacity;\n#endif\n#ifdef HAS_MASK_EXTENT\nglFragColor = setMask(glFragColor);\n#endif\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:o,defines:t.defines||{},extraCommandProps:t.extraCommandProps||{}}),this.version=300}getGeometryDefines(t){const e={};return t.data[t.desc.tangentAttribute]?e.HAS_TANGENT=1:t.data[t.desc.normalAttribute]&&(e.HAS_NORMAL=1),e}};var jw="#if __VERSION__ == 300\n#define attribute in\n#define varying out\n#endif\nattribute vec2 aPosition;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\nvoid main() {\n  gl_Position = vec4(aPosition, 0., 1.);\n  vTexCoord = aTexCoord;\n}";const Uw=new Int8Array([-1,1,-1,-1,1,1,1,1,-1,-1,1,-1]),Vw=new Uint8Array([0,1,0,0,1,1,1,1,0,0,1,0]);let Ww=class Et extends zw{constructor(t){t.vert=t.vert||jw,t.extraCommandProps=t.extraCommandProps||{},t.extraCommandProps.depth||(t.extraCommandProps.depth={enable:!1,mask:!1}),t.extraCommandProps.stencil||(t.extraCommandProps.stencil={enable:!1}),super(t)}draw(t){return this._quadMesh||this._createQuadMesh(t),super.draw(t,this._quadMesh)}getMeshCommand(t){const e=this.dkey||"";return this.commands[e+"_quad"]||(this.commands[e+"_quad"]=this.createREGLCommand(t,null,this._quadMesh[0].getElements())),this.commands[e+"_quad"]}_createQuadMesh(t){const e=new vb({aPosition:Uw,aTexCoord:Vw},null,Uw.length/2,{positionSize:2,primitive:"triangles"});e.generateBuffers(t),this._quadMesh=[new aw(e)]}dispose(){if(this._quadMesh){const t=this._quadMesh[0];t.geometry.dispose(),t.dispose()}return delete this._quadMesh,super.dispose()}},Zw=class Pt extends Ww{constructor(){super({vert:jw,frag:"#define SHADER_NAME FXAA\nprecision mediump float;\nvarying vec2 vTexCoord;\nuniform float enableFXAA;\nuniform float enableToneMapping;\nuniform float enableSharpen;\nuniform vec2 resolution;\nuniform sampler2D textureSource;\n#ifdef HAS_NOAA_TEX\nuniform sampler2D noAaTextureSource;\n#endif\n#ifdef HAS_POINT_TEX\nuniform sampler2D pointTextureSource;\n#endif\n#ifdef HAS_TAA_TEX\nuniform sampler2D taaTextureSource;\n#ifdef HAS_FXAA_TEX\nuniform sampler2D fxaaTextureSource;\n#endif\n#endif\nuniform float pixelRatio;\nuniform float sharpFactor;\n#ifdef HAS_OUTLINE_TEX\nuniform sampler2D textureOutline;\nuniform float enableOutline;\nuniform float highlightFactor;\nuniform float outlineFactor;\nuniform float outlineWidth;\nuniform vec3 outlineColor;\n#endif\nvec2 c;\nvec4 d(vec2 e) {\n  \n#ifdef HAS_TAA_TEX\nvec4 f = texture2D(textureSource, e);\n  vec4 taa = texture2D(taaTextureSource, e);\n#ifdef HAS_FXAA_TEX\nvec4 h = texture2D(fxaaTextureSource, e);\n#else\nvec4 h = vec4(.0);\n#endif\nvec4 i = taa + f * (1. - taa.a);\n  return h + i * (1. - h.a);\n#else\nreturn texture2D(textureSource, e);\n#endif\n}\nvec3 j(const in vec3 k, const float l) {\n  vec2 m = pixelRatio / resolution.xy;\n  float n = .0;\n  vec4 o = texture2D(textureSource, c + m * vec2(-1., -1.));\n  o.rgb = mix(vec3(.0), o.rgb, sign(o.a));\n  n += mix(.0, 1., sign(o.a));\n  vec4 u = texture2D(textureSource, c + m * vec2(1.));\n  u.rgb = mix(vec3(.0), u.rgb, sign(u.a));\n  n += mix(.0, 1., sign(u.a));\n  vec4 v = texture2D(textureSource, c + m * vec2(1., -1.));\n  v.rgb = mix(vec3(.0), v.rgb, sign(v.a));\n  n += mix(.0, 1., sign(v.a));\n  vec4 A = texture2D(textureSource, c + m * vec2(-1., 1.));\n  A.rgb = mix(vec3(.0), A.rgb, sign(A.a));\n  n += mix(.0, 1., sign(A.a));\n  return k + l * (n * k - o.rgb - v.rgb - A.rgb - u.rgb);\n}\nvec4 B(const in vec4 k) {\n  return vec4(j(k.rgb, sharpFactor), k.a);\n}\nvec3 C(const vec3 x) {\n  const float a = 2.51;\n  const float b = .03;\n  const float D = 2.43;\n  const float E = .59;\n  const float F = .14;\n  return (x * (a * x + b)) / (x * (D * x + E) + F);\n}\nvec3 G(vec3 k) {\n  k = k / (k + vec3(1.));\n  return k = pow(k, vec3(1. / 2.2));\n}\n#ifdef HAS_OUTLINE_TEX\nvec4 H() {\n  float I = 2.;\n  float J = 1.;\n  float K = pixelRatio / resolution[0] * outlineWidth;\n  float L = pixelRatio / resolution[1] * outlineWidth;\n  vec4 M = (texture2D(textureOutline, c + vec2(K, L)));\n  vec4 N = (texture2D(textureOutline, c + vec2(K, .0)));\n  vec4 O = (texture2D(textureOutline, c + vec2(K, -L)));\n  vec4 P = (texture2D(textureOutline, c + vec2(.0, -L)));\n  vec4 Q = (texture2D(textureOutline, c + vec2(-K, -L)));\n  vec4 R = (texture2D(textureOutline, c + vec2(-K, .0)));\n  vec4 S = (texture2D(textureOutline, c + vec2(-K, L)));\n  vec4 T = (texture2D(textureOutline, c + vec2(.0, L)));\n  vec4 U = -I * R + I * N + -J * S + J * M + -J * Q + J * O;\n  vec4 V = -I * P + I * T + -J * Q + J * S + -J * O + J * M;\n  float W = sqrt(dot(V, V) + dot(U, U));\n  bool X = W < 1. / 65025.;\n  vec3 Y = (texture2D(textureOutline, c)).r * outlineColor;\n  if(Y == vec3(.0) || (highlightFactor == .0 && X)) {\n    return vec4(.0);\n  }\n  float Z = X ? highlightFactor : min(1., sqrt(W) * outlineFactor);\n  return Z * vec4(Y, 1.);\n}\nvec4 ba(const in vec4 k) {\n  vec4 H = H();\n  return H + vec4(k) * (1. - H.a);\n}\n#endif\nvoid main() {\n  c = vTexCoord;\n  vec4 k;\n  if(enableFXAA == 1.) {\n    \n  } else {\n    k = d(vTexCoord);\n  }\n  if(enableSharpen == 1.) {\n    k = B(k);\n  }\n#if defined(HAS_NOAA_TEX) || defined(HAS_POINT_TEX)\nvec4 bb = vec4(.0);\n  vec4 bc = vec4(.0);\n#ifdef HAS_POINT_TEX\nbb = texture2D(pointTextureSource, vTexCoord);\n#endif\n#ifdef HAS_NOAA_TEX\nbc = texture2D(noAaTextureSource, vTexCoord);\n#endif\nvec4 bd = bb + bc * (1. - bb.a);\n  k = bd + k * (1. - bd.a);\n#endif\nif(enableToneMapping == 1.) {\n    k.rgb = G(k.rgb);\n  }\n#ifdef HAS_OUTLINE_TEX\nk = ba(k);\n#endif\ngl_FragColor = k;\n}",extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.resolution[0],height:(t,e)=>e.resolution[1]}}})}getMeshCommand(t,e){const n=this.dkey||"";return this.commands[n+"_fxaa"]||(this.commands[n+"_fxaa"]=this.createREGLCommand(t,null,e.getElements())),this.commands[n+"_fxaa"]}},qw=class It extends Ww{constructor(){super({vert:jw,frag:"precision mediump float;\nvarying vec2 vTexCoord;\nuniform vec2 resolution;\nuniform sampler2D textureSource;\nuniform float enableVignette;\nuniform float enableGrain;\nuniform float enableLut;\nuniform float timeGrain;\nuniform float grainFactor;\nuniform vec2 lensRadius;\nuniform float frameMod;\nuniform sampler2D lookupTable;\n#include <srgb_frag>\nfloat c(const in vec2 d) {\n  vec3 e = fract(vec3(d.xyx) * .1031);\n  e += dot(e, e.yzx + 19.19);\n  return fract((e.x + e.y) * e.z);\n}\nfloat f() {\n  float h = c(gl_FragCoord.xy + 1000.0 * fract(timeGrain));\n  float i = h * 2. - 1.;\n  h = i * inversesqrt(abs(i));\n  h = max(-1., h);\n  h = h - sign(i) + .5;\n  return (h + .5) * .5;\n}\nvec4 j(const in vec4 k) {\n  float l = f();\n  return vec4(mix(k.rgb, k.rgb * (k.rgb + (1. - k.rgb) * 2. * l), grainFactor), k.a);\n}\nfloat m(const in vec2 d, const in float n) {\n  vec3 o = vec3(.06711056, .00583715, 52.9829189);\n  return fract(o.z * fract(dot(d.xy + n * vec2(47., 17.) * .695, o.xy)));\n}\nfloat u() {\n  vec2 v = lensRadius;\n  v.y = min(v.y, v.x - 1e-4);\n  float A = m(gl_FragCoord.xy, frameMod);\n  A = (v.x - v.y) * (v.x + v.y) * .07 * (A - .5);\n  return smoothstep(v.x, v.y, A + distance(vTexCoord, vec2(.5)));\n}\nvec4 B(const in vec4 k) {\n  float l = u();\n  return vec4(linearTosRGB(sRGBToLinear(k.rgb) * l), clamp(k.a + (1. - l), .0, 1.));\n}\nvec4 C(in vec4 D, in sampler2D E) {\n  mediump float F = D.b * 63.;\n  mediump vec2 G;\n  G.y = floor(floor(F) / 8.);\n  G.x = floor(F) - G.y * 8.;\n  mediump vec2 H;\n  H.y = floor(ceil(F) / 8.);\n  H.x = ceil(F) - H.y * 8.;\n  highp vec2 I;\n  I.x = G.x * .125 + .5 / 512. + (.125 - 1. / 512.) * D.r;\n  I.y = G.y * .125 + .5 / 512. + (.125 - 1. / 512.) * D.g;\n#ifdef LUT_FLIP_Y\nI.y = 1. - I.y;\n#endif\nhighp vec2 J;\n  J.x = H.x * .125 + .5 / 512. + (.125 - 1. / 512.) * D.r;\n  J.y = H.y * .125 + .5 / 512. + (.125 - 1. / 512.) * D.g;\n#ifdef LUT_FLIP_Y\nJ.y = 1. - J.y;\n#endif\nlowp vec4 K = texture2D(E, I);\n  lowp vec4 L = texture2D(E, J);\n  lowp vec4 M = mix(K, L, fract(F));\n  return M;\n}\nvoid main() {\n  vec4 k = texture2D(textureSource, vTexCoord);\n  if(enableLut == 1.) {\n    k = C(k, lookupTable);\n  }\n  if(enableVignette == 1.) {\n    k = B(k);\n  }\n  if(enableGrain == 1.) {\n    k = j(k);\n  }\n  gl_FragColor = k;\n}",extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.resolution[0],height:(t,e)=>e.resolution[1]}}})}getMeshCommand(t,e){return this.commands.postprocess||(this.commands.postprocess=this.createREGLCommand(t,null,e.getElements())),this.commands.postprocess}};const Xw=[[.263385,-.0252475],[-.38545,.054485],[-.139795,-.5379925],[-.2793775,.6875475],[.7139025,.4710925],[.90044,-.16422],[.4481775,-.82799],[-.9253375,-.2910625],[.3468025,1.02292],[-1.13742,.33522],[-.7676225,-.9123175],[-.2005775,-1.1774125],[-.926525,.96876],[1.12909,-.7500325],[.9603,1.14625]],Jw=Xw.length,Qw=[0,0];for(let t=0;t<Xw.length;t++)Qw[0]+=Xw[t][0],Qw[1]+=Xw[t][1];Qw[0]/=Jw,Qw[1]/=Jw;let Yw=class Ft{constructor(t){this._frameNum=0,this._ratio=t||.05,this._avg=[Qw[0]*this._ratio,Qw[1]*this._ratio]}getRatio(){return this._ratio}setRatio(t){this._ratio!==t&&(this._ratio=t,this.reset()),this._avg=[Qw[0]*this._ratio,Qw[1]*this._ratio]}getAverage(){return this._avg}reset(){this._frameNum=0}getJitter(t){const e=this._frameNum%Jw,n=this._ratio;return Ev(t,Xw[e][0]*n,Xw[e][1]*n),t}frame(){this._frameNum++,this._frameNum%Jw==0&&(this._frameNum=0)}getSampleCount(){return Jw}},Kw=class Nt{constructor(t,e,n=5){this._regl=t,this._renderer=new cw(t),this._inputRGBM=e,this._level=n}render(t,e){this._initShaders(),this._createTextures(t),this._blur(t,e||0);const n={blurTex0:this._blur01Tex,blurTex1:this._blur11Tex,blurTex2:this._blur21Tex,blurTex3:this._blur31Tex,blurTex4:this._blur41Tex};return this._level>5&&(n.blurTex5=this._blur51Tex,n.blurTex6=this._blur61Tex),n}_blur(t,e){let n=this._blurUniforms;n||(n=this._blurUniforms={rgbmRange:7,blurDir:[0,0],outSize:[0,0],pixelRatio:[1,1],outputSize:[0,0]}),Ev(n.outSize,t.width,t.height),this._blurOnce(this._blur0Shader,t,this._blur00FBO,this._blur01FBO,.5,e),this._blurOnce(this._blur1Shader,this._blur01FBO.color[0],this._blur10FBO,this._blur11FBO,.5),this._blurOnce(this._blur2Shader,this._blur11FBO.color[0],this._blur20FBO,this._blur21FBO,.5),this._blurOnce(this._blur3Shader,this._blur21FBO.color[0],this._blur30FBO,this._blur31FBO,.5),this._blurOnce(this._blur4Shader,this._blur31FBO.color[0],this._blur40FBO,this._blur41FBO,.5),this._level>5&&(this._blurOnce(this._blur5Shader,this._blur41FBO.color[0],this._blur50FBO,this._blur51FBO,.5),this._blurOnce(this._blur6Shader,this._blur51FBO.color[0],this._blur60FBO,this._blur51FBO,.5))}_blurOnce(t,e,n,i,o,s){const a=Math.ceil(o*e.width),l=Math.ceil(o*e.height);n.width===a&&n.height===l||n.resize(a,l),i.width===a&&i.height===l||i.resize(a,l);const h=this._blurUniforms;h.luminThreshold=s,h.TextureBlurInput=e,h.inputRGBM=+this._inputRGBM,Ev(h.blurDir,0,1),Ev(h.outputSize,n.width,n.height),this._renderer.render(t,h,null,n),h.luminThreshold=0,h.inputRGBM=1,Ev(h.blurDir,1,0),h.TextureBlurInput=n.color[0],this._renderer.render(t,h,null,i)}dispose(){this._blur0Shader&&(this._blur0Shader.dispose(),delete this._blur0Shader,this._blur1Shader.dispose(),this._blur2Shader.dispose(),this._blur3Shader.dispose(),this._blur4Shader.dispose(),this._blur5Shader&&(this._blur5Shader.dispose(),this._blur6Shader.dispose(),delete this._blur5Shader)),this._blur00Tex&&(delete this._blur00Tex,this._blur00FBO.destroy(),this._blur01FBO.destroy(),this._blur10FBO.destroy(),this._blur11FBO.destroy(),this._blur20FBO.destroy(),this._blur21FBO.destroy(),this._blur30FBO.destroy(),this._blur31FBO.destroy(),this._blur40FBO.destroy(),this._blur41FBO.destroy(),this._blur50FBO&&(this._blur50FBO.destroy(),this._blur51FBO.destroy(),this._blur60FBO.destroy(),this._blur61FBO.destroy()))}_createTextures(t){if(this._blur00Tex)return;let e=t.width,n=t.height;this._blur00Tex=this._createColorTex(t,e,n),this._blur00FBO=this._createBlurFBO(this._blur00Tex),this._blur01Tex=this._createColorTex(t),this._blur01FBO=this._createBlurFBO(this._blur01Tex),e=Math.ceil(e/2),n=Math.ceil(n/2),this._blur10Tex=this._createColorTex(t,e,n),this._blur10FBO=this._createBlurFBO(this._blur10Tex),this._blur11Tex=this._createColorTex(t,e,n),this._blur11FBO=this._createBlurFBO(this._blur11Tex),e=Math.ceil(e/2),n=Math.ceil(n/2),this._blur20Tex=this._createColorTex(t,e,n),this._blur20FBO=this._createBlurFBO(this._blur20Tex),this._blur21Tex=this._createColorTex(t,e,n),this._blur21FBO=this._createBlurFBO(this._blur21Tex),e=Math.ceil(e/2),n=Math.ceil(n/2),this._blur30Tex=this._createColorTex(t,e,n),this._blur30FBO=this._createBlurFBO(this._blur30Tex),this._blur31Tex=this._createColorTex(t,e,n),this._blur31FBO=this._createBlurFBO(this._blur31Tex),e=Math.ceil(e/2),n=Math.ceil(n/2),this._blur40Tex=this._createColorTex(t,e,n),this._blur40FBO=this._createBlurFBO(this._blur40Tex),this._blur41Tex=this._createColorTex(t,e,n),this._blur41FBO=this._createBlurFBO(this._blur41Tex),this._level>5&&(e=Math.ceil(e/2),n=Math.ceil(n/2),this._blur50Tex=this._createColorTex(t,e,n),this._blur50FBO=this._createBlurFBO(this._blur50Tex),this._blur51Tex=this._createColorTex(t,e,n),this._blur51FBO=this._createBlurFBO(this._blur51Tex),e=Math.ceil(e/2),n=Math.ceil(n/2),this._blur60Tex=this._createColorTex(t,e,n),this._blur60FBO=this._createBlurFBO(this._blur60Tex),this._blur61Tex=this._createColorTex(t,e,n),this._blur61FBO=this._createBlurFBO(this._blur61Tex))}_createColorTex(t,e,n){return this._regl.texture({min:"linear",mag:"linear",type:"uint8",width:e||t.width,height:n||t.height})}_createBlurFBO(t){return this._regl.framebuffer({width:t.width,height:t.height,colors:[t],depth:!1,stencil:!1})}_initShaders(){if(!this._blur0Shader){const t={vert:jw,extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.outputSize[0],height:(t,e)=>e.outputSize[1]}},frag:"#version 100\nprecision highp float;\nuniform float rgbmRange;\nuniform sampler2D TextureBlurInput;\nuniform sampler2D TextureInput;\nuniform vec2 blurDir;\nuniform vec2 pixelRatio;\nuniform vec2 outputSize;\nuniform float inputRGBM;\nuniform float luminThreshold;\n#define SHADER_NAME GAUSSIAN_BLUR0\nconst vec3 c = vec3(.2126, .7152, .0722);\nfloat d(const in vec3 e) {\n  return dot(e, c);\n}\nvec4 f(vec4 e) {\n  float h = max(sign(d(e.rgb) - luminThreshold), .0);\n  return e * h;\n}\nvec2 i;\nvec4 j(const in vec3 e, const in float k) {\n  vec4 l;\n  vec3 m = e / k;\n  l.a = clamp(max(max(m.r, m.g), max(m.b, 1e-6)), .0, 1.);\n  l.a = ceil(l.a * 255.) / 255.;\n  l.rgb = m / l.a;\n  return l;\n}\nvec3 n(const in vec4 e, const in float k) {\n  if(inputRGBM == .0)\n    return e.rgb;\n  return k * e.rgb * e.a;\n}\nvec4 o() {\n  vec3 u = .375 * (f(vec4(n(texture2D(TextureBlurInput, i.xy), rgbmRange), 1.))).rgb;\n  vec2 v;\n  vec2 A = pixelRatio.xy * blurDir.xy / outputSize.xy;\n  v = A * 1.2;\n  u += .3125 * (f(vec4(n(texture2D(TextureBlurInput, i.xy + v.xy), rgbmRange), 1.))).rgb;\n  u += .3125 * (f(vec4(n(texture2D(TextureBlurInput, i.xy - v.xy), rgbmRange), 1.))).rgb;\n  return vec4(u, 1.);\n}\nvoid main(void) {\n  i = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = o();\n  e = j(e.rgb, rgbmRange);\n  gl_FragColor = e;\n}"};this._blur0Shader=new Ww(t),t.frag="#version 100\nprecision highp float;\nuniform float rgbmRange;\nuniform sampler2D TextureBlurInput;\nuniform sampler2D TextureInput;\nuniform vec2 blurDir;\nuniform vec2 pixelRatio;\nuniform vec2 outputSize;\n#define SHADER_NAME GAUSSIAN_BLUR1\nvec2 c;\nvec4 d(const in vec3 e, const in float f) {\n  if(f <= .0)\n    return vec4(e, 1.);\n  vec4 h;\n  vec3 i = e / f;\n  h.a = clamp(max(max(i.r, i.g), max(i.b, 1e-6)), .0, 1.);\n  h.a = ceil(h.a * 255.) / 255.;\n  h.rgb = i / h.a;\n  return h;\n}\nvec3 j(const in vec4 e, const in float f) {\n  if(f <= .0)\n    return e.rgb;\n  return f * e.rgb * e.a;\n}\nvec4 k() {\n  vec3 l = .3125 * (vec4(j(texture2D(TextureBlurInput, c.xy), rgbmRange), 1.)).rgb;\n  vec2 m;\n  vec2 n = pixelRatio.xy * blurDir.xy / outputSize.xy;\n  m = n * 1.2857142857142858;\n  l += .328125 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .328125 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  return vec4(l, 1.);\n}\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = k();\n  e = d(e.rgb, rgbmRange);\n  gl_FragColor = e;\n}",this._blur1Shader=new Ww(t),t.frag="#version 100\nprecision highp float;\nuniform float rgbmRange;\nuniform sampler2D TextureBlurInput;\nuniform sampler2D TextureInput;\nuniform vec2 blurDir;\nuniform vec2 pixelRatio;\nuniform vec2 outputSize;\n#define SHADER_NAME GAUSSIAN_BLUR2\nvec2 c;\nvec4 d(const in vec3 e, const in float f) {\n  if(f <= .0)\n    return vec4(e, 1.);\n  vec4 h;\n  vec3 i = e / f;\n  h.a = clamp(max(max(i.r, i.g), max(i.b, 1e-6)), .0, 1.);\n  h.a = ceil(h.a * 255.) / 255.;\n  h.rgb = i / h.a;\n  return h;\n}\nvec3 j(const in vec4 e, const in float f) {\n  if(f <= .0)\n    return e.rgb;\n  return f * e.rgb * e.a;\n}\nvec4 k() {\n  vec3 l = .2734375 * (vec4(j(texture2D(TextureBlurInput, c.xy), rgbmRange), 1.)).rgb;\n  vec2 m;\n  vec2 n = pixelRatio.xy * blurDir.xy / outputSize.xy;\n  m = n * 1.3333333333333333;\n  l += .328125 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .328125 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 3.111111111111111;\n  l += .03515625 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .03515625 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  return vec4(l, 1.);\n}\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = k();\n  e = d(e.rgb, rgbmRange);\n  gl_FragColor = e;\n}",this._blur2Shader=new Ww(t),t.frag="#version 100\nprecision highp float;\nuniform float rgbmRange;\nuniform sampler2D TextureBlurInput;\nuniform sampler2D TextureInput;\nuniform vec2 blurDir;\nuniform vec2 pixelRatio;\nuniform vec2 outputSize;\n#define SHADER_NAME GAUSSIAN_BLUR3\nvec2 c;\nvec4 d(const in vec3 e, const in float f) {\n  if(f <= .0)\n    return vec4(e, 1.);\n  vec4 h;\n  vec3 i = e / f;\n  h.a = clamp(max(max(i.r, i.g), max(i.b, 1e-6)), .0, 1.);\n  h.a = ceil(h.a * 255.) / 255.;\n  h.rgb = i / h.a;\n  return h;\n}\nvec3 j(const in vec4 e, const in float f) {\n  if(f <= .0)\n    return e.rgb;\n  return f * e.rgb * e.a;\n}\nvec4 k() {\n  vec3 l = .24609375 * (vec4(j(texture2D(TextureBlurInput, c.xy), rgbmRange), 1.)).rgb;\n  vec2 m;\n  vec2 n = pixelRatio.xy * blurDir.xy / outputSize.xy;\n  m = n * 1.3636363636363635;\n  l += .322265625 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .322265625 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 3.1818181818181817;\n  l += .0537109375 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .0537109375 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  return vec4(l, 1.);\n}\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = k();\n  e = d(e.rgb, rgbmRange);\n  gl_FragColor = e;\n}",this._blur3Shader=new Ww(t),t.frag="#version 100\nprecision highp float;\nuniform float rgbmRange;\nuniform sampler2D TextureBlurInput;\nuniform sampler2D TextureInput;\nuniform vec2 blurDir;\nuniform vec2 pixelRatio;\nuniform vec2 outputSize;\n#define SHADER_NAME GAUSSIAN_BLUR4\nvec2 c;\nvec4 d(const in vec3 e, const in float f) {\n  if(f <= .0)\n    return vec4(e, 1.);\n  vec4 h;\n  vec3 i = e / f;\n  h.a = clamp(max(max(i.r, i.g), max(i.b, 1e-6)), .0, 1.);\n  h.a = ceil(h.a * 255.) / 255.;\n  h.rgb = i / h.a;\n  return h;\n}\nvec3 j(const in vec4 e, const in float f) {\n  if(f <= .0)\n    return e.rgb;\n  return f * e.rgb * e.a;\n}\nvec4 k() {\n  vec3 l = .2255859375 * (vec4(j(texture2D(TextureBlurInput, c.xy), rgbmRange), 1.)).rgb;\n  vec2 m;\n  vec2 n = pixelRatio.xy * blurDir.xy / outputSize.xy;\n  m = n * 1.3846153846153846;\n  l += .314208984375 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .314208984375 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 3.230769230769231;\n  l += .06982421875 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .06982421875 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 5.076923076923077;\n  l += .003173828125 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .003173828125 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  return vec4(l, 1.);\n}\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = k();\n  e = d(e.rgb, rgbmRange);\n  gl_FragColor = e;\n}",this._blur4Shader=new Ww(t),this._level>5&&(t.frag="precision highp float;\nuniform float rgbmRange;\nuniform sampler2D TextureBlurInput;\nuniform sampler2D TextureInput;\nuniform vec2 blurDir;\nuniform vec2 outSize;\nuniform vec2 pixelRatio;\nuniform vec2 outputSize;\n#define SHADER_NAME GAUSSIAN_BLUR5\nvec2 c;\nvec4 d(const in vec3 e, const in float f) {\n  if(f <= .0)\n    return vec4(e, 1.);\n  vec4 h;\n  vec3 i = e / f;\n  h.a = clamp(max(max(i.r, i.g), max(i.b, 1e-6)), .0, 1.);\n  h.a = ceil(h.a * 255.) / 255.;\n  h.rgb = i / h.a;\n  return h;\n}\nvec3 j(const in vec4 e, const in float f) {\n  if(f <= .0)\n    return e.rgb;\n  return f * e.rgb * e.a;\n}\nvec4 k() {\n  vec3 l = .20947265625 * (vec4(j(texture2D(TextureBlurInput, c.xy), rgbmRange), 1.)).rgb;\n  vec2 m;\n  vec2 n = pixelRatio.xy * blurDir.xy / outputSize.xy;\n  n *= outSize.y * .00075;\n  m = n * 1.4;\n  l += .30548095703125 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .30548095703125 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 3.2666666666666666;\n  l += .08331298828125 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .08331298828125 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 5.133333333333334;\n  l += .00640869140625 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .00640869140625 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  return vec4(l, 1.);\n}\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = k();\n  e = d(e.rgb, rgbmRange);\n  gl_FragColor = e;\n}",this._blur5Shader=new Ww(t),t.frag="#version 100\nprecision highp float;\nuniform float rgbmRange;\nuniform sampler2D TextureBlurInput;\nuniform sampler2D TextureInput;\nuniform vec2 blurDir;\nuniform vec2 outSize;\nuniform vec2 pixelRatio;\nuniform vec2 outputSize;\n#define SHADER_NAME GAUSSIAN_BLUR6\nvec2 c;\nvec4 d(const in vec3 e, const in float f) {\n  if(f <= .0)\n    return vec4(e, 1.);\n  vec4 h;\n  vec3 i = e / f;\n  h.a = clamp(max(max(i.r, i.g), max(i.b, 1e-6)), .0, 1.);\n  h.a = ceil(h.a * 255.) / 255.;\n  h.rgb = i / h.a;\n  return h;\n}\nvec3 j(const in vec4 e, const in float f) {\n  if(f <= .0)\n    return e.rgb;\n  return f * e.rgb * e.a;\n}\nvec4 k() {\n  vec3 l = .196380615234375 * (vec4(j(texture2D(TextureBlurInput, c.xy), rgbmRange), 1.)).rgb;\n  vec2 m;\n  vec2 n = pixelRatio.xy * blurDir.xy / outputSize.xy;\n  n *= outSize.y * .00075;\n  m = n * 1.411764705882353;\n  l += .2967529296875 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .2967529296875 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 3.2941176470588234;\n  l += .09442138671875 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .09442138671875 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 5.176470588235294;\n  l += .0103759765625 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .0103759765625 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  return vec4(l, 1.);\n}\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = k();\n  e = d(e.rgb, rgbmRange);\n  gl_FragColor = e;\n}",this._blur6Shader=new Ww(t))}}},$w=class Lt{constructor(t){this._regl=t,this._renderer=new cw(t)}render(t,e,n,i,o,s,a,l,h){this._initShaders(),this._createTextures(t);const c=this._blurPass.render(e,n);return this._combine(t,c,e,i,o,s,a,l,h)}_combine(t,e,n,i,o,s,a,l,h){h||this._combineTex.width===t.width&&this._combineTex.height===t.height||this._combineFBO.resize(t.width,t.height);let c=this._combineUniforms;const{blurTex0:u,blurTex1:f,blurTex2:g,blurTex3:A,blurTex4:m}=e;c||(c=this._combineUniforms={bloomFactor:0,bloomRadius:0,rgbmRange:7,TextureBloomBlur1:u,TextureBloomBlur2:f,TextureBloomBlur3:g,TextureBloomBlur4:A,TextureBloomBlur5:m,TextureInput:null,TextureSource:null,outputSize:[0,0]}),c.noAaTextureSource=s,c.pointTextureSource=a,c.enableAA=l,c.bloomFactor=i,c.bloomRadius=o,c.TextureInput=n,c.TextureSource=t,Ev(c.outputSize,t.width,t.height);const w={};return s?w.HAS_NOAA_TEX=1:delete w.HAS_NOAA_TEX,a?w.HAS_POINT_TEX=1:delete w.HAS_POINT_TEX,this._combineShader.setDefines(w),this._renderer.render(this._combineShader,c,null,h?null:this._combineFBO),h?null:this._combineTex}dispose(){this._combineFBO&&(this._combineFBO.destroy(),delete this._combineFBO),this._blurPass&&(this._blurPass.dispose(),delete this._blurPass),delete this._uniforms}_createTextures(t){this._combineTex||(this._combineTex=this._createColorTex(t,t.width,t.height,"uint8"),this._combineFBO=this._createBlurFBO(this._combineTex))}_createColorTex(t,e,n,i){return this._renderer.regl.texture({min:"linear",mag:"linear",type:i,width:e||t.width,height:n||t.height})}_createBlurFBO(t){return this._renderer.regl.framebuffer({width:t.width,height:t.height,colors:[t],depth:!1,stencil:!1})}_initShaders(){if(!this._combineShader){const t={x:0,y:0,width:(t,e)=>e.outputSize[0],height:(t,e)=>e.outputSize[1]};this._blurPass=new Kw(this._regl,!1),this._combineShader=new Ww({vert:jw,frag:"precision highp float;\nuniform float bloomFactor;\nuniform float bloomRadius;\nuniform float rgbmRange;\nuniform sampler2D TextureBloomBlur1;\nuniform sampler2D TextureBloomBlur2;\nuniform sampler2D TextureBloomBlur3;\nuniform sampler2D TextureBloomBlur4;\nuniform sampler2D TextureBloomBlur5;\nuniform sampler2D TextureInput;\nuniform sampler2D TextureSource;\n#ifdef HAS_NOAA_TEX\nuniform sampler2D noAaTextureSource;\n#endif\n#ifdef HAS_POINT_TEX\nuniform sampler2D pointTextureSource;\n#endif\nuniform float enableAA;\nuniform vec2 outputSize;\n#define SHADER_NAME bloomCombine\nvec2 c;\n#include <srgb_frag>\nvec3 d(const in vec4 e, const in float f) {\n  if(f <= .0)\n    return e.rgb;\n  return f * e.rgb * e.a;\n}\nfloat h(const float i, const float j) {\n  return mix(i, j * 2. - i, bloomRadius);\n}\nvec4 k() {\n  vec3 l = vec3(.0);\n  const float m = .6;\n  const float n = 1.1;\n  const float o = .9;\n  const float u = .6;\n  const float v = .3;\n  const float A = .1;\n  l += (vec4(d(texture2D(TextureBloomBlur1, c), rgbmRange), 1.)).rgb * h(n, m);\n  l += (vec4(d(texture2D(TextureBloomBlur2, c), rgbmRange), 1.)).rgb * h(o, m);\n  l += (vec4(d(texture2D(TextureBloomBlur3, c), rgbmRange), 1.)).rgb * h(u, m);\n  l += (vec4(d(texture2D(TextureBloomBlur4, c), rgbmRange), 1.)).rgb * h(v, m);\n  l += (vec4(d(texture2D(TextureBloomBlur5, c), rgbmRange), 1.)).rgb * h(A, m);\n  vec4 B;\n  if(enableAA == 1.) {\n    \n  } else {\n    B = texture2D(TextureInput, c);\n  }\n  B.rgb = mix(vec3(.0), B.rgb, sign(B.a));\n  vec4 C = texture2D(TextureSource, c);\n#ifdef HAS_NOAA_TEX\nvec4 D = texture2D(noAaTextureSource, c);\n  C = D + C * (1. - D.a);\n#endif\nvec4 E = vec4(.0);\n#ifdef HAS_POINT_TEX\nE = texture2D(pointTextureSource, c);\n#endif\nfloat F = sqrt((l.r + l.g + l.b) / 3.);\n  vec4 G = vec4(linearTosRGB(l * bloomFactor), F);\n  return E + (B + C * (1. - B.a)) * (1. - E.a) + G;\n}\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = k();\n  gl_FragColor = e;\n}",extraCommandProps:{viewport:t}})}}},tT=class kt extends Ww{constructor(){const t=[];super({vert:jw,frag:"precision highp float;\n#include <gl2_frag>\n#define SHADER_NAME COPY_DEPTH\nuniform sampler2D TextureDepth;\nuniform vec2 textureSize;\n#include <common_pack_float>\nvoid main(void) {\n  vec2 c = gl_FragCoord.xy / textureSize.xy;\n  float d = texture2D(TextureDepth, c).r;\n  glFragColor = common_encodeDepth(d);\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:[{name:"textureSize",type:"function",fn:(e,n)=>(t[0]=n.TextureDepth.width,t[1]=n.TextureDepth.height,t)}],extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.TextureDepth.width,height:(t,e)=>e.TextureDepth.height}}}),this.version=300}getMeshCommand(t,e){return this.commands.copy_depth||(this.commands.copy_depth=this.createREGLCommand(t,null,e.getElements())),this.commands.copy_depth}},eT=class Bt{static getUniformDeclares(){const t=[[0,0,0,0],[0,0,0,0]],e=new Array(16);return[{name:"invProjMatrix",type:"function",fn:(t,n)=>hy(e,n.projMatrix)},{name:"outputFovInfo",type:"array",length:2,fn:function(e,n){const i=Math.tan(.5*n.fov),o=n.outSize[0]/n.outSize[1]*i;return g_(t[0],o,i,o,-i),g_(t[1],-o,i,-o,-i),t}},{name:"reprojViewProjMatrix",type:"function",fn:(t,e)=>cy([],e.prevProjViewMatrix,e.cameraWorldMatrix)}]}static getDefines(){return{HAS_SSR:1}}constructor(t){this._regl=t,this._renderer=new cw(t),this._inputRGBM=0}setup(t){this._initShaders(),this._createTextures(t)}getSSRUniforms(t,e,n){if(!this._depthCopy)return null;const i=this._depthCopy;return{TextureDepth:i,TextureReflected:this.getMipmapTexture(),ssrFactor:e||1,ssrQuality:n||2,outSize:[i.width,i.height],fov:t.getFov()*Math.PI/180,prevProjViewMatrix:this._projViewMatrix||t.projViewMatrix,cameraWorldMatrix:t.cameraWorldMatrix}}genMipMap(t,e,n){return this.setup(t),this._mipmap(t),this.copyDepthTex(e),this._projViewMatrix||(this._projViewMatrix=[]),sy(this._projViewMatrix,n),delete this._depthCopied,this._outputTex}getPrevProjViewMatrix(){return this._projViewMatrix}copyDepthTex(t){return this._depthCopied?null:(this.setup(t),this._depthCopy?t.width===this._depthCopy.width&&t.height===this._depthCopy.height||this._depthCopyFBO.resize(t.width,t.height):(this._depthCopy=this._regl.texture({min:"nearest",mag:"nearest",mipmap:!1,type:"uint8",width:t.width,height:t.height}),this._depthCopyFBO=this._regl.framebuffer({width:t.width,height:t.height,colors:[this._depthCopy],colorFormat:"rgba"})),this._renderer.render(this._copyDepthShader,{TextureDepth:t},null,this._depthCopyFBO),this._depthCopied=!0,this._depthCopy)}_mipmap(t){const e=this._targetFBO,n=Math.ceil(.5*t.width),i=Math.ceil(.5*t.height);e.width===n&&e.height===i||e.resize(n,i);let o=this._blurUniforms;o||(o=this._blurUniforms={rgbmRange:7,outputSize:[0,0]}),o.TextureInput=t,o.inputRGBM=+this._inputRGBM,Ev(o.outputSize,e.width,e.height),this._renderer.render(this._ssrQuadShader,o,null,e)}getMipmapTexture(){return this._outputTex||(this._outputTex=this._renderer.regl.texture({type:"uint8",width:2,height:2})),this._outputTex}dispose(){this._copyDepthShader&&(this._ssrQuadShader.dispose(),this._copyDepthShader.dispose(),this._targetFBO.destroy(),delete this._copyDepthShader),this._depthCopy&&(this._depthCopyFBO.destroy(),delete this._depthCopy,delete this._depthCopyFBO)}_initShaders(){this._copyDepthShader||(this._copyDepthShader=new tT,this._ssrQuadShader=new Ww({vert:jw,frag:"#version 100\nprecision mediump float;\nuniform sampler2D TextureInput;\nuniform vec2 outputSize;\n#define SHADER_NAME QUAD\nvec2 c;\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 d = texture2D(TextureInput, c.xy);\n  gl_FragColor = d;\n}",extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.outputSize[0],height:(t,e)=>e.outputSize[1]}}}))}_createTextures(t){if(!this._targetFBO){const e=this._regl;this._outputTex&&this._outputTex.destroy(),this._outputTex=e.texture({min:"linear",mag:"linear",type:"uint8",width:t.width,height:t.height}),this._targetFBO=e.framebuffer({width:t.width,height:t.height,colors:[this._outputTex],depth:!1,stencil:!1})}}},nT=class zt extends zw{constructor(t){const e=[];super({vert:"#define SHADER_NAME HEATMAP\nuniform mat4 projViewModelMatrix;\nuniform float extrudeScale;\nuniform float heatmapIntensity;\nattribute vec3 aPosition;\nvarying vec2 vExtrude;\n#ifdef HAS_HEAT_WEIGHT\nattribute highp float aWeight;\nvarying highp float weight;\n#else\nuniform highp float heatmapWeight;\n#endif\nuniform mediump float heatmapRadius;\nconst highp float c = 1. / 255. / 16.;\n#define GAUSS_COEF 0.3989422804014327\nvoid main(void) {\n  \n#ifdef HAS_HEAT_WEIGHT\nhighp float d = aWeight / 255.;\n  weight = d;\n#else\nhighp float d = heatmapWeight;\n#endif\nmediump float e = heatmapRadius;\n  vec2 f = vec2(mod(aPosition.xy, 2.) * 2. - 1.);\n  float h = sqrt(-2. * log(c / d / heatmapIntensity / GAUSS_COEF)) / 3.;\n  vExtrude = h * f;\n  vec2 i = vExtrude * e * extrudeScale;\n  vec4 j = vec4(floor(aPosition.xy * .5) + i, aPosition.z, 1);\n  gl_Position = projViewModelMatrix * j;\n}",frag:"#define SHADER_NAME HEATMAP\nprecision mediump float;\nuniform highp float heatmapIntensity;\nvarying vec2 vExtrude;\n#ifdef HAS_HEAT_WEIGHT\nvarying highp float weight;\n#else\nuniform highp float heatmapWeight;\n#endif\n#define GAUSS_COEF 0.3989422804014327\nvoid main() {\n  \n#ifdef HAS_HEAT_WEIGHT\nhighp float c = weight;\n#else\nhighp float c = heatmapWeight;\n#endif\nfloat d = -.5 * 3. * 3. * dot(vExtrude, vExtrude);\n  float e = c * heatmapIntensity * GAUSS_COEF * exp(d);\n  gl_FragColor = vec4(e, 1., 1., 1.);\n}",uniforms:[{name:"extrudeScale",type:"function",fn:function(t,e){return e.resolution/e.dataResolution*e.tileRatio}},{name:"projViewModelMatrix",type:"function",fn:function(t,n){return cy(e,n.projViewMatrix,n.modelMatrix)}}],extraCommandProps:Hx({},t&&t.extraCommandProps||{},{blend:{enable:!0,func:{src:"one",dst:"one"},equation:"add"}})})}};var iT=[-1,1,-1,-1,-1,-1,1,-1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,-1,1,-1,1,1,1,1,1,1,1,1,1,-1,1,-1,-1,-1,-1,1,-1,1,1,1,1,1,1,1,1,1,-1,1,-1,-1,1,-1,1,-1,1,1,-1,1,1,1,1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,-1,-1,1,-1,-1,-1,-1,1,1,-1,1],rT="#define SHADER_NAME SKYBOX\n#if __VERSION__ == 100\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod : enable\n#define textureCubeLod(tex, uv, lod) textureCubeLodEXT(tex, uv, lod)\n#else\n#define textureCubeLod(tex, uv, lod) textureCube(tex, uv, lod)\n#endif\n#else\n#define textureCubeLod(tex, uv, lod) textureLod(tex, uv, lod)\n#endif\nprecision highp float;\n#define saturate(x)        clamp(x, 0.0, 1.0)\n#include <gl2_frag>\n#include <hsv_frag>\nuniform vec3 hsv;\nvarying vec3 vWorldPos;\n#ifdef USE_AMBIENT\nuniform vec3 diffuseSPH[9];\n#else\nuniform samplerCube cubeMap;\nuniform float bias;\nuniform float size;\n#endif\nuniform float environmentExposure;\nuniform float backgroundIntensity;\nvec4 c(const in samplerCube d, const in vec3 e, const in float f, const in float h) {\n  vec3 i = e;\n  return textureCubeLod(d, i, h);\n}\nvec3 j(const in vec3 k, const in vec3 l[9]) {\n  float x = k.x;\n  float y = k.y;\n  float z = k.z;\n  vec3 m = (l[0] + l[1] * x + l[2] * y + l[3] * z + l[4] * z * x + l[5] * y * z + l[6] * y * x + l[7] * (3. * z * z - 1.) + l[8] * (x * x - y * y));\n  return max(m, vec3(.0));\n}\nfloat n(const in vec2 o) {\n  vec3 u = fract(vec3(o.xyx) * .1031);\n  u += dot(u, u.yzx + 19.19);\n  return fract((u.x + u.y) * u.z);\n}\n#if defined(TONE_MAPPING)\nconst float v = 1.;\nvec3 A(vec3 B) {\n  vec3 a = B * (B + .0245786) - .000090537;\n  vec3 b = B * (.983729 * B + .4329510) + .238081;\n  return a / b;\n}\nvec3 C(vec3 D) {\n  const mat3 E = mat3(vec3(.59719, .07600, .02840), vec3(.35458, .90834, .13383), vec3(.04823, .01566, .83777));\n  const mat3 F = mat3(vec3(1.60475, -.10208, -.00327), vec3(-.53108, 1.10813, -.07276), vec3(-.07367, -.00605, 1.07602));\n  D *= v / .6;\n  D = E * D;\n  D = A(D);\n  D = F * D;\n  return saturate(D);\n}\nvec3 G(vec3 D) {\n  return C(D);\n}\nvec4 H(in vec4 I) {\n  return vec4(mix(pow(I.rgb, vec3(.41666)) * 1.055 - vec3(.055), I.rgb * 12.92, vec3(lessThanEqual(I.rgb, vec3(.0031308)))), I.a);\n}\nvec4 J(vec4 I) {\n  return (H(I));\n}\n#endif\nvoid main() {\n  vec4 K;\n#ifdef USE_AMBIENT\nvec3 k = normalize(vWorldPos + mix(-.5 / 255., .5 / 255., n(gl_FragCoord.xy)) * 2.);\n  K = vec4(j(k, diffuseSPH), 1.);\n#else\nK = c(cubeMap, vWorldPos, size, bias);\n#endif\nK.rgb *= environmentExposure;\n  K.rgb *= backgroundIntensity;\n  glFragColor = K;\n  if(length(hsv) > .0) {\n    glFragColor.rgb = hsv_apply(clamp(glFragColor.rgb, .0, 1.), hsv);\n  }\n#if defined(TONE_MAPPING)\nglFragColor.rgb = G(glFragColor.rgb);\n  glFragColor = J(glFragColor);\n#endif\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}";let oT=class Ut extends zw{constructor(){super({vert:"#include <gl2_vert>\nattribute vec3 aPosition;\nuniform mat4 projMatrix;\nuniform mat4 viewMatrix;\nuniform mat3 transformMatrix;\nvarying vec3 vWorldPos;\nvoid main() {\n  vWorldPos = aPosition;\n  mat4 c = mat4(mat3(viewMatrix) * transformMatrix);\n  vec4 d = projMatrix * c * vec4(vWorldPos, 1.);\n  gl_Position = d.xyww;\n}",frag:rT,extraCommandProps:{depth:{enable:!0,range:[1,1],func:"lequal"},viewport:{x:0,y:0,width:(t,e)=>e.resolution[0],height:(t,e)=>e.resolution[1]}}}),this.version=300}setMode(t,e){const n={};return t&&(n.TONE_MAPPING=1),0===e&&(n.USE_AMBIENT=1),this._skyboxMesh?this._skyboxMesh[0].setDefines(n):this._meshDefines=n,this}draw(t){return this._skyboxMesh||this._createSkyboxMesh(t),super.draw(t,this._skyboxMesh)}_createSkyboxMesh(t){const e=new vb({aPosition:new Int8Array(iT)},null,iT.length/3);e.generateBuffers(t),this._skyboxMesh=[new aw(e)],this._meshDefines&&(this._skyboxMesh[0].setDefines(this._meshDefines),delete this._meshDefines)}dispose(){if(this._skyboxMesh){const t=this._skyboxMesh[0];t.geometry.dispose(),t.dispose()}return delete this._skyboxMesh,super.dispose()}},sT=class jt extends zw{constructor(t,e){const n={blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"},viewport:t};e&&e.extraCommandProps&&Hx(n,e.extraCommandProps);const i=[];super({vert:"#define SHADER_NAME HEATMAP_DISPLAY\nuniform mat4 projViewModelMatrix;\nattribute vec3 aPosition;\nvoid main() {\n  gl_Position = projViewModelMatrix * vec4(aPosition, 1.);\n}",frag:"#define SHADER_NAME HEATMAP_DISPLAY\nprecision mediump float;\nuniform sampler2D inputTexture;\nuniform sampler2D colorRamp;\nuniform vec2 textureOutputSize;\nuniform float heatmapOpacity;\nvoid main() {\n  vec2 c = gl_FragCoord.xy / textureOutputSize.xy;\n  float t = texture2D(inputTexture, c).r;\n  vec4 d = texture2D(colorRamp, vec2(t, .5));\n  gl_FragColor = d * heatmapOpacity;\n}",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){return cy(i,e.projViewMatrix,e.modelMatrix)}}],extraCommandProps:n})}},aT=class Wt extends Ww{constructor(){super({vert:jw,frag:"precision highp float;\nuniform sampler2D texture;\nuniform vec2 size;\nuniform float enableSharpen;\nuniform float sharpFactor;\nuniform float pixelRatio;\nvec2 c;\nvec3 d(const in vec3 e, const float f) {\n  vec2 h = pixelRatio / size.xy;\n  float i = .0;\n  vec4 j = texture2D(texture, c + h * vec2(-1., -1.));\n  j.rgb = mix(vec3(.0), j.rgb, sign(j.a));\n  i += mix(.0, 1., sign(j.a));\n  vec4 k = texture2D(texture, c + h * vec2(1.));\n  k.rgb = mix(vec3(.0), k.rgb, sign(k.a));\n  i += mix(.0, 1., sign(k.a));\n  vec4 l = texture2D(texture, c + h * vec2(1., -1.));\n  l.rgb = mix(vec3(.0), l.rgb, sign(l.a));\n  i += mix(.0, 1., sign(l.a));\n  vec4 m = texture2D(texture, c + h * vec2(-1., 1.));\n  m.rgb = mix(vec3(.0), m.rgb, sign(m.a));\n  i += mix(.0, 1., sign(m.a));\n  return e + f * (i * e - j.rgb - l.rgb - m.rgb - k.rgb);\n}\nvoid main() {\n  c = gl_FragCoord.xy / size;\n  vec4 e = texture2D(texture, c);\n  if(enableSharpen == 1.) {\n    e.rgb = d(e.rgb, sharpFactor);\n  }\n  gl_FragColor = e;\n}",extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.size[0],height:(t,e)=>e.size[1]}}})}getMeshCommand(t,e){return this.commands.copy||(this.commands.copy=this.createREGLCommand(t,null,e.getElements())),this.commands.copy}},lT=class qt extends zw{constructor(t={}){const e=[],n=t.uniforms,i=[{name:"modelViewMatrix",type:"function",fn:function(t,n){return cy(e,n.viewMatrix,n.modelMatrix)}}];n&&i.push(...n),super({vert:"attribute vec3 aPosition;\nuniform mat4 projMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 positionMatrix;\nuniform mat4 modelViewMatrix;\n#include <get_output>\nvoid main() {\n  vec4 c = getPosition(aPosition);\n  mat4 d = getPositionMatrix();\n  gl_Position = projMatrix * modelViewMatrix * d * c;\n}",frag:"precision mediump float;\nuniform vec4 lineColor;\nuniform float lineOpacity;\nvoid main() {\n  gl_FragColor = lineColor;\n  gl_FragColor.a *= lineOpacity;\n}",uniforms:i,defines:t.defines||{},extraCommandProps:t.extraCommandProps||{}})}};const hT=[],cT=[];let uT=class Zt extends Ww{constructor(){super({vert:jw,frag:"#if __VERSION__ == 100\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives : enable\n#endif\n#endif\nprecision mediump float;\n#include <gl2_frag>\nvarying vec2 vTexCoord;\nuniform sampler2D sceneMap;\nuniform sampler2D scanEffectMap;\nvoid main() {\n  vec4 c = texture2D(sceneMap, vTexCoord);\n  vec4 d = texture2D(scanEffectMap, vTexCoord);\n  glFragColor = c + d;\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.resolution[0],height:(t,e)=>e.resolution[1]}}})}};const fT=[];let dT=class Qt{constructor(t,e,n){this._regl=t,this._layer=n,this._viewport=e,this._init()}_init(){this._shader=new zw({vert:"attribute vec3 aPosition;\nuniform mat4 projMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 positionMatrix;\nvarying vec4 vWorldPosition;\n#include <get_output>\nvoid main() {\n  vec4 c = getPosition(aPosition);\n  mat4 d = getPositionMatrix();\n  vec4 e = modelMatrix * d * c;\n  gl_Position = projMatrix * modelViewMatrix * d * c;\n  vWorldPosition = e;\n}",frag:"precision mediump float;\nvarying vec4 vWorldPosition;\nuniform vec2 fogDist;\nuniform vec3 cameraPosition;\nuniform float rainDepth;\nvoid main() {\n  vec3 c = vec3(vWorldPosition[0] - cameraPosition[0], vWorldPosition[1] - cameraPosition[1], vWorldPosition[2] - cameraPosition[2]);\n  float d = length(c);\n  float e = clamp(1. - (d - fogDist.x) / (fogDist.y - fogDist.x), .0, 1.);\n  if(vWorldPosition[2] < rainDepth) {\n    gl_FragColor = vec4(e, .0, .0, 1.);\n  } else {\n    gl_FragColor = vec4(e, 1., .0, 1.);\n  }\n}",uniforms:[{name:"modelViewMatrix",type:"function",fn:function(t,e){return cy(fT,e.viewMatrix,e.modelMatrix)}}],extraCommandProps:{viewport:this._viewport}});const t=this._layer.getRenderer().createFBOInfo();this._fbo=this._regl.framebuffer(t),this._scene=new _w,this.renderer=new cw(this._regl)}render(t,e){return this._resize(),this.renderer.clear({color:[0,0,0,1],depth:1,framebuffer:this._fbo}),this._scene.setMeshes(t),this.renderer.render(this._shader,{projMatrix:e.projMatrix,viewMatrix:e.viewMatrix,cameraPosition:e.cameraPosition,fogDist:e.fogDist,rainDepth:e.rainDepth},this._scene,this._fbo),this._fbo}dispose(){this._fbo&&this._fbo.destroy(),this._shader&&this._shader.dispose()}_resize(){const t=Nx(this._viewport.width.data)?this._viewport.width.data():this._viewport.width,e=Nx(this._viewport.height.data)?this._viewport.height.data():this._viewport.height;!this._fbo||this._fbo.width===t&&this._fbo.height===e||this._fbo.resize(t,e)}},gT=class en extends Ww{constructor(){super({vert:jw,frag:"#if __VERSION__ == 100\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives : enable\n#endif\n#endif\nprecision mediump float;\n#include <gl2_frag>\nvarying vec2 vTexCoord;\n#ifdef HAS_RAIN\nuniform sampler2D ripplesMap;\n#endif\n#ifdef HAS_SNOW\nuniform sampler2D normalMap;\n#endif\n#ifdef HAS_FOG\nuniform vec3 fogColor;\n#endif\nuniform sampler2D sceneMap;\nuniform sampler2D mixFactorMap;\nuniform float time;\nuniform vec2 resolution;\nuniform float snowIntensity;\nfloat c(float a, float b, float w) {\n  return a + w * (b - a);\n}\n#define HASHSCALE1 .1031\n#define HASHSCALE3 vec3(.1031, .1030, .0973)\n#define HASHSCALE4 vec3(.1031, .1030, .0973, .1099)\nfloat d = .5;\nfloat e = .2;\nfloat f = .5;\nfloat h = 20.;\nfloat i(float p) {\n  vec3 j = fract(vec3(p) * HASHSCALE1);\n  j += dot(j, j.yzx + 19.19);\n  return fract((j.x + j.y) * j.z);\n}\nvec2 k(vec2 p) {\n  vec3 j = fract(vec3(p.xyx) * HASHSCALE3);\n  j += dot(j, j.yzx + 19.19);\n  return fract((j.xx + j.yz) * j.zy);\n}\nvec2 l(vec2 m) {\n  float x = fract(sin(dot(m.xy, vec2(122.9898, 783.233))) * 43758.5453);\n  float y = fract(sin(dot(m.xy, vec2(457.6537, 537.2793))) * 37573.5913);\n  return vec2(x, y);\n}\nvec3 n(vec2 o, float u) {\n  vec3 v = vec3(.0);\n  o = o * (2. + u);\n  float A = e * snowIntensity;\n  float B = o.y * (((i(u) * 2. - 1.) * .5 + 1.) * A);\n  float C = (f * time);\n  o += vec2(B, C);\n  vec2 D = k(floor(o) + 31.1759 * u);\n  o = fract(o);\n  o -= (D * 2. - 1.) * .35;\n  o -= .5;\n  float r = length(o);\n  float E = .05 * (1. + .3 * sin(time * d));\n  float F = smoothstep(E, -E, r);\n  vec3 G = vec3(F) * D.x;\n  return G;\n}\nvec3 H() {\n  vec3 v = vec3(0);\n  vec2 o = gl_FragCoord.xy / resolution.xy;\n  o *= vec2(resolution.x / resolution.y, 1.);\n  float I = h * snowIntensity;\n  for(float J = 0.; J < I; J++) {\n    v += n(o, J);\n  }\n  return v;\n}\nvec3 K(vec4 L, vec4 M, float N) {\n  float O = M.b;\n  vec3 P = vec3(1.);\n  if(N < 1.) {\n    float r = c(.5, P.x, O);\n    float g = c(.5, P.y, O);\n    float b = c(.5, P.z, O);\n    return vec3(r, g, b);\n  } else {\n    float r = c(L.r, P.x, O);\n    float g = c(L.g, P.y, O);\n    float b = c(L.b, P.z, O);\n    return vec3(r, g, b);\n  }\n}\nvoid main() {\n  vec4 L = texture2D(sceneMap, vTexCoord);\n  glFragColor = L;\n  vec4 Q = texture2D(mixFactorMap, vTexCoord);\n#ifdef HAS_RAIN\nvec4 R = texture2D(ripplesMap, vTexCoord);\n  if(Q.g < 1.) {\n    L = mix(L, R, .4);\n  }\n  glFragColor = L;\n#endif\n#ifdef HAS_SNOW\nvec3 S = H();\n  glFragColor = vec4(L.rgb + S, L.a);\n#endif\n#ifdef HAS_FOG\nfloat T = Q.r;\n  vec3 U = mix(fogColor, glFragColor.rgb, T);\n  glFragColor = vec4(U, L.a);\n#endif\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.resolution[0],height:(t,e)=>e.resolution[1]}}})}};const pT=[],AT=[.03,.03,.03],mT=[],yT=[],_T=[],vT=my([],Q_([],90,0,0),[0,0,0]);let xT=class cn{constructor(t,e){this._regl=t,this._viewport=e,this._init()}_init(){this._shader=new zw({vert:"#include <gl2_vert>\nattribute vec3 aPosition;\nattribute vec3 aNormal;\nattribute vec2 aTexCoord;\nuniform mat4 projMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 positionMatrix;\nvarying vec2 vTexCoord;\n#include <get_output>\nvoid main() {\n  vec4 c = getPosition(aPosition);\n  mat4 d = getPositionMatrix();\n  gl_Position = projMatrix * modelViewMatrix * d * c;\n  vTexCoord = aTexCoord;\n}",frag:"#if __VERSION__ == 100\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives : enable\n#endif\n#endif\nprecision mediump float;\n#include <gl2_frag>\nvarying vec2 vTexCoord;\nuniform float rippleRadius;\nuniform float density;\nuniform float time;\nvec3 c(vec2 p) {\n  vec3 q = vec3(dot(p, vec2(127.1, 311.7)), dot(p, vec2(269.5, 183.3)), dot(p, vec2(419.2, 371.9)));\n  return fract(sin(q) * 43758.5453);\n}\nfloat d(in vec2 x) {\n  vec2 e = x * density / 4000.0;\n  vec2 p = floor(e);\n  vec2 f = fract(e);\n  float h = .0;\n  for(int i = -4; i <= 4; i++)\n    for(int k = -4; k <= 4; k++) {\n      vec2 g = vec2(float(k), float(i));\n      vec3 l = c(p + g);\n      vec2 r = g - f + l.xy;\n      float m = sqrt(dot(r, r));\n      float n = max(mix(smoothstep(.99, .999, max(cos(m - time * 2. + (l.x + l.y) * 5.), 0.)), 0., m), 0.);\n      h += n;\n    }\n  return h;\n}\nvoid main() {\n  vec2 u = vTexCoord;\n  float A = 24. / (rippleRadius * .01);\n  float f = d(A * u) * smoothstep(.0, .4, sin(u.x * 3.151592) * sin(u.y * 3.141592));\n  vec3 B = vec3(-dFdx(f), -dFdy(f), -dFdy(f));\n  glFragColor = vec4(B, 1.);\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:[{name:"modelViewMatrix",type:"function",fn:function(t,e){return cy(pT,e.viewMatrix,e.modelMatrix)}}],extraCommandProps:{viewport:this._viewport}}),this._shader.version=300,this._fbo=this._regl.framebuffer({color:this._regl.texture({width:this._viewport.width(),height:this._viewport.height(),wrap:"clamp",mag:"linear",min:"linear"}),depth:!0}),this._scene=new _w,this.renderer=new cw(this._regl)}_transformRipples(t){const e=t.coordinateToPointAtRes(t.getCenter(),t.getGLRes()),n=t.getGLScale()/t.getGLScale(this._fixZoom),i=Fy(yT,n,n,n),o=By(i,AT,i),s=ay(_T);xy(s,Q_(mT,0,0,0),[e.x,e.y,0],o),cy(s,s,vT),this._mesh.setLocalTransform(s)}_createRipplesMask(t){this._fixZoom=t.getZoom();const e=800*Math.pow(2,16.685648411389433-this._fixZoom),n={};n.POSITION=[-e,0,-e,e,0,-e,-e,0,e,e,0,e],n.NORMAL=[0,1,0,0,1,0,0,1,0,0,1,0],n.TEXCOORD_0=[0,0,1,0,0,1,1,1];const i=new vb(n,[3,1,0,0,2,3],0,{positionAttribute:"POSITION",normalAttribute:"NORMAL",uv0Attribute:"TEXCOORD_0"});i.generateBuffers(this._regl);const o=new Qb;return new aw(i,o)}render(t,e){return this._resize(),this.renderer.clear({color:[0,0,0,1],depth:1,framebuffer:this._fbo}),this._mesh=this._mesh||this._createRipplesMask(t),this._scene.setMeshes(this._mesh),this._transformRipples(t),this.renderer.render(this._shader,{projMatrix:e.projMatrix,viewMatrix:e.viewMatrix,time:e.time,rippleRadius:e.rippleRadius,density:e.density},this._scene,this._fbo),this._fbo}dispose(){this._fbo&&this._fbo.destroy(),this._shader&&this._shader.dispose()}_resize(){const t=Nx(this._viewport.width.data)?this._viewport.width.data():this._viewport.width,e=Nx(this._viewport.height.data)?this._viewport.height.data():this._viewport.height;!this._fbo||this._fbo.width===t&&this._fbo.height===e||this._fbo.resize(t,e)}};var bT="attribute vec3 aPosition;\nuniform mat4 positionMatrix;\nuniform mat4 projViewModelMatrix;\n#ifdef HAS_TEXTURE\nattribute vec2 aTexCoord;\nvarying vec2 uv;\nvarying vec4 vPos;\n#endif\n#include <get_output>\nvoid main() {\n  mat4 c = getPositionMatrix();\n  vec4 d = c * getPosition(aPosition);\n  gl_Position = projViewModelMatrix * d;\n#ifdef HAS_TEXTURE\nuv = aTexCoord;\n  vPos = getPosition(aPosition);\n#endif\n}";const wT=[0,0,0,1];let TT=class dn{constructor(t,e){this.regl=t,this._viewport=e,this.renderer=new cw(t),this._init()}_init(){this._maskColorFbo=this.renderer.regl.framebuffer({color:this.renderer.regl.texture({width:1,height:1,wrap:"clamp",mag:"linear",min:"linear"}),depth:!0}),this._maskModeFbo=this.renderer.regl.framebuffer({color:this.renderer.regl.texture({width:1,height:1,wrap:"clamp",mag:"nearest",min:"nearest"}),depth:!0});const t=[{name:"projViewModelMatrix",type:"function",fn:(t,e)=>cy([],e.projViewMatrix,e.modelMatrix)}];this._maskColorShader=new zw({vert:bT,frag:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform vec4 maskColor;\n#ifdef HAS_TEXTURE\nuniform sampler2D maskTexture;\nvarying vec2 uv;\nuniform vec3 mask_position0;\nuniform vec3 mask_position1;\nuniform vec3 mask_position2;\nuniform vec3 mask_position3;\nvarying vec4 vPos;\nvec2 c(vec2 d, vec2 a, vec2 b, vec2 e, vec2 f) {\n  vec2 h = vec2(.5);\n  for(int i = 0; i < 10; i++) {\n    float j = h.x;\n    float k = h.y;\n    vec2 l = (1. - j) * (1. - k) * a + j * (1. - k) * b + j * k * e + (1. - j) * k * f;\n    vec2 m = d - l;\n    if(length(m) < .001)\n      break;\n    vec2 n = -(1. - k) * a + (1. - k) * b + k * e - k * f;\n    vec2 o = -(1. - j) * a - j * b + j * e + (1. - j) * f;\n    float A = n.x * o.y - n.y * o.x;\n    if(abs(A) > .0001) {\n      vec2 B = vec2((m.x * o.y - m.y * o.x) / A, (m.y * n.x - m.x * n.y) / A);\n      h += B;\n    }\n    h = clamp(h, .0, 1.);\n  }\n  return h;\n}\n#endif\nvoid main() {\n  \n#ifdef HAS_TEXTURE\nvec2 d = vPos.xy;\n  vec2 C = c(d, mask_position0.xy, mask_position1.xy, mask_position2.xy, mask_position3.xy);\n  gl_FragColor = texture2D(maskTexture, C);\n  gl_FragColor.a *= maskColor.a;\n#else\nif(maskColor.a == .0) {\n    discard;\n  }\n  gl_FragColor = maskColor;\n#endif\n}",uniforms:t,extraCommandProps:{viewport:this._viewport}}),this._maskModeShader=new zw({vert:bT,frag:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform float maskMode;\n#ifdef HAS_MASK_FLAT\nuniform float flatHeight;\n#endif\n#ifdef HAS_MASK_COLOR\nuniform vec2 heightRange;\n#endif\nvoid main() {\n  \n#if defined(HAS_MASK_FLAT)\ngl_FragColor = vec4(maskMode, flatHeight, .0, 1.);\n#elif defined(HAS_MASK_COLOR)\ngl_FragColor = vec4(maskMode, .0, heightRange.x, heightRange.y);\n#else\ngl_FragColor = vec4(maskMode, .0, .0, .0);\n#endif\n}",uniforms:t,extraCommandProps:{viewport:this._viewport}}),this._scene=new _w}render(t,e){this._resize(),this.renderer.clear({color:wT,depth:1,framebuffer:this._maskColorFbo}),this.renderer.clear({color:wT,depth:1,framebuffer:this._maskModeFbo}),this._scene.setMeshes(t);const n={projViewMatrix:e};return this.renderer.render(this._maskColorShader,n,this._scene,this._maskColorFbo),this.renderer.render(this._maskModeShader,n,this._scene,this._maskModeFbo),{colorExtent:this._maskColorFbo,modeExtent:this._maskModeFbo}}_resize(){const t=Nx(this._viewport.width)?this._viewport.width():this._viewport.width.data(),e=Nx(this._viewport.height)?this._viewport.height():this._viewport.height.data();!this._maskColorFbo||this._maskColorFbo.width===t&&this._maskColorFbo.height===e||(this._maskColorFbo.resize(t,e),this._maskModeFbo.resize(t,e))}dispose(){this._maskColorFbo&&(this._maskColorFbo.destroy(),delete this._maskColorFbo),this._maskModeFbo&&(this._maskModeFbo.destroy(),delete this._maskModeFbo),this._maskColorShader&&(this._maskColorShader.dispose(),delete this._maskColorShader),this._maskModeShader&&(this._maskModeShader.dispose(),delete this._maskModeShader)}};const MT=[];let CT=class mn{constructor(t,e,n){this._regl=t,this._layer=n,this._viewport=e,this._init(),this._effectsLength=0}_init(){const t=this._layer.getRenderer().createFBOInfo();this._fbo=this._regl.framebuffer(t),this._scene=new _w,this.renderer=new cw(this._regl)}render(t,e){this._resize(),this.renderer.clear({color:[0,0,0,1],depth:1,framebuffer:this._fbo}),this._scene.setMeshes(t);const n=e.effectInfos;if(!this._shader||n.length!==this._effectsLength){this._shader&&this._shader.dispose();const t=this._createFragSource(n);this._shader=new zw({vert:"#include <gl2_vert>\n#define SHADER_NAME SCANEFFECT\nprecision highp float;\nattribute vec3 aPosition;\nuniform mat4 projMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 positionMatrix;\n#include <line_extrusion_vert>\n#include <get_output>\nvarying vec4 vWorldPosition;\nvoid main()\n{\n    mat4 localPositionMatrix = getPositionMatrix();\n    #ifdef IS_LINE_EXTRUSION\n        vec3 linePosition = getLineExtrudePosition(aPosition);\n        //linePixelScale = tileRatio * resolution / tileResolution\n        vec4 localVertex = getPosition(linePosition);\n    #else\n        vec4 localVertex = getPosition(aPosition);\n    #endif\n    vec4 worldPosition = modelMatrix * localPositionMatrix * localVertex;\n    vWorldPosition = worldPosition;\n    gl_Position = projMatrix * modelViewMatrix * localPositionMatrix * localVertex;\n}\n",frag:t,uniforms:[{name:"modelViewMatrix",type:"function",fn:function(t,e){return cy(MT,e.viewMatrix,e.modelMatrix)}}],extraCommandProps:{viewport:this._viewport}}),this._effectsLength=n.length}const i={projMatrix:e.projMatrix,viewMatrix:e.viewMatrix,effectTime:e.effectTime,minAltitude:0};return this._updateUniforms(i,n),this.renderer.render(this._shader,i,this._scene,this._fbo),this._fbo}_createFragSource(t){let e="";for(let n=0;n<t.length;n++)e+=`uniform mat3 ring${n};\n`;e="\n#ifdef GL_ES\n  precision highp float;\n#endif\nuniform mat3 ring;\n\nuniform float effectTime;\nvarying vec4 vWorldPosition;\n\nvec3 hsb2rgb(in vec3 c) {\n    vec3 rgb = clamp(abs(mod(c.x * 6.0 + vec3(0.0,4.0,2.0), 6.0)-3.0)-1.0, 0.0, 1.0 );\n    rgb = rgb*rgb*(3.0-2.0*rgb);\n    return c.z * mix( vec3(1.0), rgb, c.y);\n}\n\nvec4 glowring(vec4 worldPos, vec2 center, float radius, float speed, vec3 effectColor, float direction, float height) {\n  vec2 dir = vec2(worldPos.xy) - center;\n  float len = length(dir);\n  if (len > radius) {\n    return vec4(0.0);\n  } else {\n    vec2 uv = vec2(0.0);\n    if (direction == 0.0) {\n      vec2 lefttop = vec2(center.x - radius, center.y + radius);\n      vec2 rightbottom = vec2(center.x + radius, center.y - radius);\n      uv = vec2(abs(worldPos.x - lefttop.x) / (2.0 * radius), abs(worldPos.y - rightbottom.y) / (2.0 * radius));\n      uv.x -= 0.5;\n      uv.y -= 0.5;\n    } else {\n      if (worldPos.z < 0.1) {\n        return vec4(0.0);\n      }\n      uv = vec2(0.0, worldPos.z / height);\n    }\n    float itime = (effectTime / 2.0) * speed;\n    float r = length(uv) * 3.0;\n    vec3 color = hsb2rgb(effectColor);\n\n    float a = pow(r, 2.0);\n    float b = sin(r * 0.8 - 1.6);\n    float c = sin(r - 0.010);\n    float s = sin(a - itime * 3.0 + b) * c;\n    float t = abs(1.0 / (s * 10.8)) - 0.01;\n    color *= t;\n    vec4 newColor = vec4(color, t);\n    return newColor;\n  }\n}\n\nvoid main() {\n    vec4 color = vec4(0.0);\n    gl_FragColor = color;\n}\n".replace("uniform mat3 ring;",e);let n="";for(let e=0;e<t.length;e++)n+=`\n                vec2 center${e} = vec2(ring${e}[0][0], ring${e}[0][1]);\n                float radius${e} = ring${e}[0][2];\n                float speed${e} = ring${e}[1][0];\n                vec3 color${e} = vec3(ring${e}[1][1], ring${e}[1][2], ring${e}[2][0]);\n                float direction${e} = ring${e}[2][1];\n                float height${e} = ring${e}[2][2];\n                vec4 ringColor${e} = glowring(vWorldPosition, center${e}, radius${e}, speed${e}, color${e}, direction${e}, height${e});\n                color += ringColor${e};\n            `;return n+="gl_FragColor = color;",e=e.replace("gl_FragColor = color;",n),e}_updateUniforms(t,e){for(let n=0;n<e.length;n++)t[`ring${n}`]=e[n]}dispose(){this._fbo&&this._fbo.destroy(),this._shader&&this._shader.dispose()}_resize(){const t=Nx(this._viewport.width.data)?this._viewport.width.data():this._viewport.width,e=Nx(this._viewport.height.data)?this._viewport.height.data():this._viewport.height;!this._fbo||this._fbo.width===t&&this._fbo.height===e||this._fbo.resize(t,e)}};const ST=[],PT={width:4,type:"float"};let IT=class gn{constructor(t,e,n){this._regl=t,this.joints=e,this.inverseBindMatrices=[],this.jointMatrices=[],this.jointData=new Float32Array(16*e.length);for(let t=0;t<e.length;++t)this.inverseBindMatrices.push(new Float32Array(n.buffer,n.byteOffset+16*Float32Array.BYTES_PER_ELEMENT*t,16)),this.jointMatrices.push(new Float32Array(this.jointData.buffer,16*Float32Array.BYTES_PER_ELEMENT*t,16));this.jointTextureSize=[4,6]}update(t,e,n){hy(ST,t);for(let t=0;t<this.joints.length;++t){const n=this.jointMatrices[t];cy(n,ST,e[this.joints[t].nodeIndex]),cy(n,n,this.inverseBindMatrices[t])}PT.height=this.joints.length,PT.data=this.jointData;const i=PT;return n?n(i):n=this._regl.texture(i),n}};const OT=[0,0,0],ET=[0,0,0,1],kT=[1,1,1],RT=[];let LT=class An{constructor(t=[0,0,0],e=[0,0,0,1],n=[1,1,1]){this.translation=t,this.rotation=e,this.scale=n}getMatrix(){return xy(RT,this.rotation,this.translation,this.scale)}decompose(t){yy(this.translation,t),vy(this.rotation,t),_y(this.scale,t)}update(t){t&&(t.translation&&!$y(t.translation,OT)&&Dy(this.translation,t.translation),t.rotation&&!yv(t.rotation,ET)&&ov(this.rotation,t.rotation),t.scale&&!$y(t.scale,kT)&&Dy(this.scale,t.scale))}},DT=class Sn{constructor(t){this._init(t)}_init(t){this.bbox=t.bbox,this.geometry=t.geometry,this.nodeMatrix=t.nodeMatrix,this.materialInfo=t.materialInfo,this.extraInfo=t.extraInfo,this.animationMatrix=t.animationMatrix,this.morphWeights=t.morphWeights,this.skin=t.skin,this.nodeIndex=t.nodeIndex}copyEdgeGeometry(){this.copyGeometry||(this.copyGeometry=this._copyEdgeGeometry(this.geometry))}createCopyBarycentric(){this.copyGeometry&&!this.copyGeometry.data.aBarycentric&&(this.copyGeometry.buildUniqueVertex(),this.copyGeometry.createBarycentric("aBarycentric"))}_copyEdgeGeometry(t){const e=t.data,n=t.indices||t.elements,i={};for(const n in e)if(n===t.desc.positionAttribute)if(jx(e[n]))i[n]=e[n].slice();else if(e[n].buffer&&e[n].buffer.destroy)i[n]={buffer:e[n].buffer},jx(e[n].array)&&(i[n].array=e[n].array.slice());else{const e=t._getAttributeData(n);i[n]=n!==t.desc.positionAttribute?e:e.slice()}const o=void 0!==n.length?n.slice():n,s=JSON.parse(JSON.stringify(t.desc)),a=new Zb(i,o,0,s);return a.properties=t.properties,a}},FT=0;const NT=[],HT=[];let BT=class Cn{constructor(t,e){this.gltf=t,this.regl=e,this.geometries=[],e&&(this._emptyTexture=e.texture({width:2,height:2}))}getMeshesInfo(){return this.gltf?(this.geometries.length||(this._createTextures(this.gltf.textures),this._createSkins(this.gltf.skins),this.gltf.scenes[0].nodes.forEach((t=>{this._parserNode(t,this.geometries)})),this._checkBaseColorFactor()),this.geometries):null}getGLTFBBox(){if(!this.gltf)return null;const t=this.geometries;if(!t||!t.length)return null;const e=[1/0,1/0,1/0],n=[-1/0,-1/0,-1/0];for(let i=0;i<t.length;i++){const o=t[i].bbox,s=o.min,a=o.max;s[0]<e[0]&&(e[0]=s[0]),s[1]<e[1]&&(e[1]=s[1]),s[2]<e[2]&&(e[2]=s[2]),a[0]>n[0]&&(n[0]=a[0]),a[1]>n[1]&&(n[1]=a[1]),a[2]>n[2]&&(n[2]=a[2])}return{min:e,max:n}}_createSkins(t){if(t){this._skinMap={};for(let e=0;e<t.length;e++){const n=t[e];n.joints=n.joints.map((t=>this.gltf.nodes[t])),this._skinMap[e]=new IT(this.regl,n.joints,n.inverseBindMatrices.array),delete n.inverseBindMatrices}}}_createTextures(t){if(t){this._textureMap={};for(let e=0;e<t.length;e++){const n=t[e];this._textureMap[e]||(this._textureMap[e]=this._toTexture(n),delete n.image)}}}_checkBaseColorFactor(){if(!this._checkBaseColorFactorAlpha())for(let t=0;t<this.geometries.length;t++){const e=this.geometries[t].materialInfo.baseColorFactor;e&&0===e[3]&&(e[3]=1)}}_checkBaseColorFactorAlpha(){for(let t=0;t<this.geometries.length;t++){const e=this.geometries[t].materialInfo.baseColorFactor;if(e&&e[3]>0)return!0}return!1}dispose(){this._emptyTexture&&this._emptyTexture.destroy();const t=this.getMeshesInfo();if(t){t.forEach((t=>{t.geometry.dispose();for(const e in t.materialInfo){const n=t.materialInfo[e];n&&n.destroy&&!n[sb]&&n.destroy()}}));for(const t in this._textureMap){const e=this._textureMap[t];e&&e.destroy&&!e[sb]&&e.destroy()}delete this.gltf}}updateAnimation(t,e,n,i,o,s,a,l){const h=this.gltf;if(!h)return;const c=Rx();if(FT=h.animations?c.GLTFLoader.getAnimationTimeSpan(h,i):null,!FT)return;t-=o;let u=0;u=e||!e&&this._isFirstLoop(t,n,i,o)?t*n*.001%(FT.max-FT.min)+FT.min:t*n*.001+FT.min,h.scenes[0].nodes.forEach((t=>{this._updateNodeMatrix(i,u,t,null,s,l)}));for(const t in this.gltf.nodes){const e=this.gltf.nodes[t],n=s[e.nodeIndex];if(e.skin&&n){const t=e.skin.update(n,s,a[e.nodeIndex]&&a[e.nodeIndex].jointTexture);a[e.nodeIndex]||(a[e.nodeIndex]={jointTextureSize:e.skin.jointTextureSize,numJoints:e.skin.joints.length}),a[e.nodeIndex].jointTexture=t}}}_isFirstLoop(t,e,n,i){const o=this.gltf;if(!i||!o)return!0;const s=Rx();return FT=o.animations?s.GLTFLoader.getAnimationTimeSpan(o,n):null,t*e*.001/(FT.max-FT.min)<1}hasSkinAnimation(){return!!this._isAnimation}_updateNodeMatrix(t,e,n,i,o,s){n.trs&&(s?s.indexOf(Number(n.nodeIndex))>-1&&this._updateNodeTRS(n,e,t):this._updateNodeTRS(n,e,t)),o[n.nodeIndex]=i?cy(o[n.nodeIndex]||[],i,n.matrix||n.trs.getMatrix()):sy(o[n.nodeIndex]||[],n.matrix||n.trs.getMatrix()),n.children&&n.children.forEach((i=>{this._updateNodeMatrix(t,e,i,o[n.nodeIndex],o,s)}))}_updateNodeTRS(t,e,n){const i=Rx().GLTFLoader.getAnimationClip(this.gltf,Number(t.nodeIndex),e,n);i.weights&&this._updateMorph(t,i.weights),t.trs.update(i)}_updateMorph(t,e){const n=e.length;if(!t.influencesList){t.influencesList=[];for(let e=0;e<n;e++)t.influencesList[e]=[e,0]}const i=t.influencesList;for(let t=0;t<i.length;t++){const n=i[t];n[0]=t,n[1]=e[t]}i.sort(GT);const o=[];for(let t=0;t<8;t++)o[t]=[t,0];for(let t=0;t<8;t++)t<n&&i[t][1]?(o[t][0]=i[t][0],o[t][1]=i[t][1]):(o[t][0]=Number.MAX_SAFE_INTEGER,o[t][1]=0);o.sort(zT),t.geometries.forEach((t=>{const e=t.properties.morphTargets;for(let n=0;n<8;n++){const i=o[n],s=i[0],a=i[1];s!==Number.MAX_SAFE_INTEGER&&a?(t.updateData("POSITION"+n,e["POSITION_"+s].array),t.properties.morphWeights[n]=a):t.properties.morphWeights[n]=0}}))}_parserNode(t,e,n){if(t.isParsed)return;t.nodeMatrix=t.nodeMatrix||ay([]),t.localMatrix=t.localMatrix||ay([]),t.matrix?(t.trs=new LT,t.trs.decompose(t.matrix)):t.trs=new LT(t.translation,t.rotation,t.scale),t.localMatrix=t.trs.getMatrix(),n?cy(t.nodeMatrix,n,t.matrix||t.localMatrix):sy(t.nodeMatrix,t.matrix||t.localMatrix);const i=t.nodeMatrix;if(t.children)for(let n=0;n<t.children.length;n++)this._parserNode(t.children[n],e,i);if(Fx(t.skin)){this._isAnimation=!0;const e=t.skin;t.trs=new LT,t.skin=this._skinMap[e]}Fx(t.mesh)&&(t.mesh=this.gltf.meshes[t.mesh],t.mesh.node=t,t.geometries=t.geometries||[],t.mesh.primitives.forEach((n=>{const o=this._createMaterialInfo(n.material),s=function(t,e,n){const i=t.attributes,o=i.COLOR_0;if(o&&o.array instanceof Float32Array){const t=new Uint8Array(o.array.length);for(let e=0;e<t.length;e++)t[e]=Math.round(255*o.array[e]);o.array=t}else if(o&&(o.array instanceof Uint16Array||o.array instanceof Int16Array||o.array instanceof Uint32Array||o.array instanceof Int32Array)){const t=new Uint8Array(o.array);o.array=t}n&&i.TEXCOORD_0&&!i.TEXCOORD_0&&(i.TEXCOORD_1=i.TEXCOORD_0);const s={};for(const t in i)s[t]=Hx({},i[t]),e&&(s[t].buffer=Fb(e,i[t],{dimension:i[t].itemSize}));if(t.morphTargets){const t=Kx(s.POSITION)?s.POSITION.itemSize*s.POSITION.count:s.POSITION.array.length;for(let e=0;e<8;e++)s[`POSITION${e}`]||(s[`POSITION${e}`]=new Float32Array(t).fill(0));for(let t=0;t<4;t++)s[`NORMAL${t}`]||(s[`NORMAL${t}`]=new Float32Array(s.NORMAL.array?s.NORMAL.array.length:s.NORMAL.length).fill(0))}let a=t.indices;a&&void 0===a.bufferView&&a.array&&(a=a.array);const l=new vb(s,a,0,{primitive:zx(t.mode)?wb(t.mode):t.mode,positionAttribute:"POSITION",normalAttribute:"NORMAL",uv0Attribute:"TEXCOORD_0",uv1Attribute:"TEXCOORD_1",color0Attribute:"COLOR_0"});return t.morphTargets&&(l.properties.morphWeights=[]),t.mode>3&&!l.data.NORMAL&&l.createNormal("NORMAL"),l}(n,this.regl,o.occlusionTexture);s.properties.morphTargets=n.morphTargets,t.geometries.push(s);let a=s.boundingBox.copy();a=a.transform(ay(NT),i);const l={geometry:s,bbox:a,nodeMatrix:i,materialInfo:o,extraInfo:this._createExtralInfo(n.material),animationMatrix:t.trs.getMatrix(),morphWeights:t.weights,nodeIndex:t.nodeIndex};t.skin&&(l.skin={jointTextureSize:[4,6],numJoints:t.skin.joints.length,jointTexture:t.skin.jointTexture});const h=new DT(l);e.push(h)}))),t.isParsed=!0}_createMaterialInfo(t){const e={};if(this.gltf.materials&&this.gltf.materials[t]){const n=this.gltf.materials[t],i=n.pbrMetallicRoughness;if(i){const t=i.metallicRoughnessTexture,n=i.baseColorTexture;n&&(e.baseColorTexture=this._getTexture(n),n.KHR_texture_transform&&(e.khr_offset=n.KHR_texture_transform.offset||[0,0],e.khr_rotation=n.KHR_texture_transform.rotation||0,e.khr_scale=n.KHR_texture_transform.scale||[1,1])),i.baseColorFactor&&(e.baseColorFactor=i.baseColorFactor),t?e.metallicRoughnessTexture=this._getTexture(t):(e.metallicFactor=Fx(i.metallicFactor)?i.metallicFactor:1,e.roughnessFactor=Fx(i.roughnessFactor)?i.roughnessFactor:1)}const o=n.extensions;if(o&&o.KHR_materials_pbrSpecularGlossiness){const t=o.KHR_materials_pbrSpecularGlossiness;e.name="pbrSpecularGlossiness";for(const n in t)e[n]=Fx(t[n].index)?this._getTexture(t[n]):t[n]}n.normalTexture&&(e.normalTexture=this._getTexture(n.normalTexture)),n.occlusionTexture&&(e.occlusionTexture=this._getTexture(n.occlusionTexture)),n.emissiveTexture&&(e.emissiveTexture=this._getTexture(n.emissiveTexture)),n.emissiveFactor&&(e.emissiveFactor=n.emissiveFactor),e.alphaCutoff=n.alphaCutoff||.5,e.doubleSided=n.doubleSided,e.alphaMode=n.alphaMode||"OPAQUE"}return e}_createExtralInfo(t){const e={};if(this.gltf.materials&&this.gltf.materials[t]){const n=this.gltf.materials[t];e.doubleSided=n.doubleSided,e.alphaMode=n.alphaMode||"OPAQUE"}return e}_getTexture(t){const e=t.extensions,n=t.index;if(!Fx(n))return null;e&&e.KHR_texture_transform&&(t.KHR_texture_transform=e.KHR_texture_transform);const i=this._textureMap[n];return i.texInfo=t,i}_toTexture(t){if(!t)return this._emptyTexture;const e=t.sampler||{};return new Iw({width:t.image.width,height:t.image.height,data:t.image.array,mag:Ib(e.magFilter)||"linear",min:Eb(e.minFilter)||"linear mipmap linear",wrapS:Rb(e.wrapS)||"repeat",wrapT:Rb(e.wrapT)||"repeat"})}arrangeAlongLine(t,e,n,i,o,s){const a=[],l=this._getRotationZ(t,e),h=(t.z||0)-(e.z||0),c=this._getRotationXY(n,h);let u=this._calBoxWidth(i,s);u/=o;const f=Math.sqrt(n*n+h*h),g=Math.floor(f/u);let A=s.direction||0;if(1===A?A=2:2===A&&(A=1),g>=1){for(let n=1;n<=g;n++){const i=u*(n-.5)/f,o={coordinates:jT(t,e,i),t:i,scale:[1,1,1],rotation:[0,0,l],rotationZ:l,rotationXY:c};a.push(o)}if(s.scaleVertex){const n=(u*g+(f-u*g)/2)/f,i=[1,1,1];i[A]=(f-u*g)/u;const o={coordinates:jT(t,e,n),t:n,scale:i,rotation:[0,0,l],rotationZ:l,rotationXY:c};a.push(o)}}else if(s.scaleVertex){const n=[1,1,1];n[A]=f/u;const i={coordinates:jT(t,e,.5),t:.5,scale:n,rotation:[0,0,l],rotationZ:l,rotationXY:c};a.push(i)}return a}calModelHeightScale(t,e){const n=this.getGLTFBBox(),i=e/Math.abs(n.max[1]-n.min[1]);return Fy(t,i,i,i)}_calBoxWidth(t,e){const n=this.getGLTFBBox(),i=e.direction||0,o=e_(HT,n.max,n.min);return By(o,o,t),o[i]+e.gapLength}_getRotationZ(t,e){return Math.atan2(t.y-e.y,t.x-e.x)/Math.PI*180}_getRotationXY(t,e){return 180*Math.atan(e/t)/Math.PI}};function zT(t,e){return t[0]-e[0]}function GT(t,e){return Math.abs(e[1])-Math.abs(t[1])}function jT(t,e,n){const i=UT(t.x,e.x,n),o=UT(t.y,e.y,n),s=UT(t.z||0,e.z||0,n);return new t.constructor(i,o,s)}function UT(t,e,n){return t+n*(e-t)}function VT(t,e){const{Ajax:n}=Rx(),{fetchOptions:i,gltfLoaderOptions:o,urlModifier:s}=e,a=o||{};a.urlModifier=s;const l=t.lastIndexOf("/"),h=t.slice(0,l),c=t.slice(t.lastIndexOf(".")).toLowerCase();return".gltf"===c?n.getJSON(t,i,s).then((t=>ZT(h,t,a))):".glb"===c?n.getArrayBuffer(t,i,s).then((t=>ZT(h,{buffer:t.data,byteOffset:0},a))):null}function WT(t,e){return new BT(t,e)}function ZT(t,e,n){const{GLTFLoader:i}=Rx();return new i(t,e,n).load()}var qT=Object.freeze({__proto__:null,exportGLTFPack:WT,load:VT,loadGLTF:ZT});const XT=[-1,0,-1,1,0,-1,-1,0,1,1,0,1],JT=[3,1,0,0,2,3],QT=[0,0,1,0,0,1,1,1],YT={vertices:[-.8111000061035156,2.0102999210357666,-.8111000061035156,0,.010300000198185444,-0,-.8111000061035156,2.0102999210357666,.8111000061035156,-.8111000061035156,2.0102999210357666,.8111000061035156,0,.010300000198185444,-0,.8111000061035156,2.0102999210357666,.8111000061035156,.8111000061035156,2.0102999210357666,.8111000061035156,0,.010300000198185444,-0,.8111000061035156,2.0102999210357666,-.8111000061035156,.8111000061035156,2.0102999210357666,-.8111000061035156,0,.010300000198185444,-0,-.8111000061035156,2.0102999210357666,-.8111000061035156,.8111000061035156,2.0102999210357666,-.8111000061035156,-.8111000061035156,2.0102999210357666,-.8111000061035156,0,2.9419000148773193,-0,.8111000061035156,2.0102999210357666,.8111000061035156,.8111000061035156,2.0102999210357666,-.8111000061035156,0,2.9419000148773193,-0,-.8111000061035156,2.0102999210357666,-.8111000061035156,-.8111000061035156,2.0102999210357666,.8111000061035156,0,2.9419000148773193,-0,-.8111000061035156,2.0102999210357666,.8111000061035156,.8111000061035156,2.0102999210357666,.8111000061035156,0,2.9419000148773193,-0],normals:[-.9267006516456604,-.3758002817630768,-0,-.9267006516456604,-.3758002817630768,-0,-.9267006516456604,-.3758002817630768,-0,0,-.3758002817630768,.9267006516456604,0,-.3758002817630768,.9267006516456604,0,-.3758002817630768,.9267006516456604,.9267006516456604,-.3758002817630768,-0,.9267006516456604,-.3758002817630768,-0,.9267006516456604,-.3758002817630768,-0,0,-.3758002817630768,-.9267006516456604,0,-.3758002817630768,-.9267006516456604,0,-.3758002817630768,-.9267006516456604,0,.656676173210144,-.7541726231575012,0,.656676173210144,-.7541726231575012,0,.656676173210144,-.7541726231575012,.7541726231575012,.656676173210144,-0,.7541726231575012,.656676173210144,-0,.7541726231575012,.656676173210144,-0,-.7541726231575012,.656676173210144,-0,-.7541726231575012,.656676173210144,-0,-.7541726231575012,.656676173210144,-0,0,.656676173210144,.7541726231575012,0,.656676173210144,.7541726231575012,0,.656676173210144,.7541726231575012],indices:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23]},KT=["cube","plane","pyramid"],$T={cube:{meshes:[{primitives:[{attributes:{POSITION:{array:new Int8Array([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1])},NORMAL:{array:new Int8Array([0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1])},TEXCOORD_0:{array:new Int8Array([0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1])}},indices:new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]),mode:4}]}],scenes:[{nodes:[{mesh:0,scale:[60,60,60]}]}]},"plane-cube":{meshes:[{primitives:[{attributes:{POSITION:{array:new Int8Array(XT)},TEXCOORD_0:{array:new Int8Array(QT)}},indices:new Uint16Array(JT),mode:4}]}],scenes:[{nodes:[{mesh:0,scale:[60,60,60],translation:[0,-60,0]},{mesh:0,scale:[60,60,60],translation:[0,60,0]},{mesh:0,scale:[60,60,60],translation:[60,0,0],rotation:[0,0,.7071067811865475,.7071067811865476]},{mesh:0,scale:[60,60,60],translation:[-60,0,0],rotation:[0,0,.7071067811865475,.7071067811865476]},{mesh:0,scale:[60,60,60],translation:[0,0,60],rotation:[.7071067811865475,0,0,.7071067811865476]},{mesh:0,scale:[60,60,60],translation:[0,0,-60],rotation:[.7071067811865475,0,0,.7071067811865476]}]}]},plane:{meshes:[{primitives:[{attributes:{POSITION:{array:new Int8Array(XT)},NORMAL:{array:new Int8Array([0,1,0,0,1,0,0,1,0,0,1,0])},TEXCOORD_0:{array:new Int8Array(QT)}},indices:new Uint16Array(JT),mode:4}]}],scenes:[{nodes:[{mesh:0,scale:[60,60,60]}]}]},pyramid:{meshes:[{primitives:[{attributes:{POSITION:{array:new Float32Array(YT.vertices)},NORMAL:{array:new Float32Array(YT.normals)},TEXCOORD_0:{array:new Float32Array(YT.uv)}},indices:new Uint16Array(YT.indices),mode:4}]}],scenes:[{nodes:[{mesh:0,scale:[60,60,60]}]}]}};let tM=class Un{constructor(t,e){this.regl=t,this.resourceMap={},this.options=e||{}}getGLTF(t){return this.resourceMap[t]}loginGLTF(t,e){if(this.resourceMap[t])this.resourceMap[t].refCount+=1;else{if($T[t]){const e=function(t){let e=null;return $T[t]&&(e={meshes:$T[t].meshes},e.scenes=JSON.parse(JSON.stringify($T[t].scenes))),e}(t);this.resourceMap[t]=this._exportGLTFResource(e,t,!1)}else this.resourceMap[t]=e?e(t).then((e=>(this.resourceMap[t]=this._exportGLTFResource(e,t),this.resourceMap[t]))):this._loadGLTFModel(t);this.resourceMap[t].refCount=1}}logoutGLTF(t){if(this.resourceMap[t]&&(this.resourceMap[t].refCount-=1,this.resourceMap[t].refCount<1)){const e=this.resourceMap[t].resources;if(e)for(let t=0;t<e.length;t++)e[t].geometry.dispose(),e[t].copyGeometry&&e[t].copyGeometry.dispose(),e[t].material&&e[t].material.dispose();this.resourceMap[t].gltfPack&&this.resourceMap[t].gltfPack.dispose(),delete this.resourceMap[t]}}isSimpleModel(t){return $T[t]}addSimpleModel(t,e){!function(t,e){"string"==typeof t&&KT.indexOf(t)<0&&($T[t]=e)}(t,e)}removeSimpleModel(t){delete $T[t]}_exportGLTFResource(t,e,n=!0){if(!t)return null;const i=WT(t,n?this.regl:null),o=i.getMeshesInfo();return{bbox:i.getGLTFBBox(),gltfPack:i,resources:o,json:t.json,refCount:this.resourceMap[e]?this.resourceMap[e].refCount:0}}fetchGLTF(t){return VT(t,this.options).then((t=>t))}_loadGLTFModel(t){return this.fetchGLTF(t).then((e=>(this.resourceMap[t]=this._exportGLTFResource(e,t),this.resourceMap[t])))}};const eM=function(){const t=[0,0,0],e=90*Math.PI/180,n=[0,0,0,0],i=new Array(16);return function(o,s,a,l,h,c){const u=[Sy([],t,[1,0,0],c&&c[0]||[0,-1,0]),Sy([],t,[-1,0,0],c&&c[1]||[0,-1,0]),Sy([],t,[0,1,0],c&&c[2]||[0,0,1]),Sy([],t,[0,-1,0],c&&c[3]||[0,0,-1]),Sy([],t,[0,0,1],c&&c[4]||[0,-1,0]),Sy([],t,[0,0,-1],c&&c[5]||[0,-1,0])],f={context:{viewMatrix:function(t,e,n){return u[n]},projMatrix:Ty(i,e,1,.5,1.1)}};return s&&(f.framebuffer=s.faces?function(t,e,n){return s.faces[n]}:s),o(f)(6,((t,e,i)=>{const c={color:n,depth:1};s&&(c.framebuffer=s.faces?s.faces[i]:s),o.clear(c),a(l),h&&h()})),s}}();var nM={vertices:[1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1],textures:[1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]},iM="#define SHADER_NAME CUBE_MAP\nattribute vec3 aPosition;\nvarying vec3 vWorldPos;\nuniform mat4 projMatrix;\nuniform mat4 viewMatrix;\nvoid main() {\n  vWorldPos = aPosition;\n  gl_Position = projMatrix * viewMatrix * vec4(vWorldPos, 1.);\n}";
/*!
   * from claygl
   * https://github.com/pissang/claygl/
   * License: BSD-2-Clause
   */function rM(t,e){const n=t[0],i=t[1],o=t[2];return 0===e?1:1===e?n:2===e?i:3===e?o:4===e?n*o:5===e?i*o:6===e?n*i:7===e?3*o*o-1:n*n-i*i}const oM={px:[2,1,0,-1,-1,1],nx:[2,1,0,1,-1,-1],py:[0,2,1,1,-1,-1],ny:[0,2,1,1,1,1],pz:[0,1,2,-1,-1,-1],nz:[0,1,2,1,-1,1]},sM=["px","nx","py","ny","pz","nz"],aM=kw.compile(rT);function lM(t,e,n,i,o=1,s=!1){const a=t({frag:(s?"#define ENCODE_RGBM\n":"")+"#define SHADER_NAME CUBEMAP\nprecision highp float;\nuniform samplerCube cubeMap;\nuniform float exposure;\nvarying vec3 vWorldPos;\n#ifdef ENCODE_RGBM\nvec4 c(const in vec3 d, const in float e) {\n  if(e <= .0)\n    return vec4(d, 1.);\n  vec4 f;\n  vec3 h = d / e;\n  f.a = clamp(max(max(h.r, h.g), max(h.b, 1e-6)), .0, 1.);\n  f.a = ceil(f.a * 255.) / 255.;\n  f.rgb = h / f.a;\n  return f;\n}\n#endif\nvoid main() {\n  vec4 i = textureCube(cubeMap, vWorldPos);\n  i.rgb *= exposure;\n#ifdef ENCODE_RGBM\ni = c(i.rgb, 7.);\n#endif\n#if __VERSION__ == 100\ngl_FragColor = i;\n#endif\n}",vert:iM,attributes:{aPosition:nM.vertices},uniforms:{projMatrix:t.context("projMatrix"),viewMatrix:t.context("viewMatrix"),cubeMap:e,exposure:o},elements:nM.indices}),l=[],h=t.texture({radius:n,min:"linear",mag:"linear",type:i?"float":"uint8",format:"rgba"}),c=t.framebuffer({radius:n,color:h});return eM(t,c,a,{size:n},(function(){const e=t.read();if(i){const t=new Uint16Array(e.length);for(let n=0;n<e.length;n++)t[n]=Math.min(Pw(e[n]),65504);l.push(t)}else l.push(e)})),a.destroy(),c.destroy(),l}const hM=new Int8Array([-1,1,0,-1,-1,0,1,1,0,1,-1,0]),cM=new Int8Array([0,1,0,0,1,1,1,0]);function uM(t,e,n,i){e=e||256;const o=fM(n=n||1024,i=i||256),s=t.texture({data:o,width:i,height:n,min:"nearest",mag:"nearest"}),a=t.buffer(hM),l=t.buffer(cM),h=t.framebuffer({radius:e,colorType:"uint8",colorFormat:"rgba",min:"linear",mag:"linear"}),c=t({frag:"precision highp float;\nvarying vec2 vTexCoords;\nuniform sampler2D distributionMap;\nconst float c = 3.14159265359;\nvec4 d(float a, float b) {\n  a *= 65535.;\n  b *= 65535.;\n  vec4 rgba;\n  rgba[0] = mod(a, 255.);\n  rgba[1] = (a - rgba[0]) / 65280.0;\n  rgba[2] = mod(b, 255.);\n  rgba[3] = (b - rgba[2]) / 65280.0;\n  return rgba;\n}\nvec3 e(float f, vec3 h, float i) {\n  vec4 j = texture2D(distributionMap, vec2(i, f));\n  vec3 k = j.xyz;\n  float l = sign(j.w - .5);\n  float m = sign(j.w - clamp(l, .0, 1.) * 200.0 / 255. - .15);\n  k.x *= l;\n  k.y *= m;\n  vec3 n = abs(h.z) < .999 ? vec3(.0, .0, 1.) : vec3(1., .0, .0);\n  vec3 o = normalize(cross(n, h));\n  vec3 u = cross(h, o);\n  vec3 v = o * k.x + u * k.y + h * k.z;\n  return normalize(v);\n}\nfloat A(float B, float i) {\n  float a = i;\n  float C = (a * a) / 2.;\n  float D = B;\n  float E = B * (1. - C) + C;\n  return D / E;\n}\nfloat F(float B, float G, float i) {\n  float I = A(B, i);\n  float J = A(G, i);\n  return J * I;\n}\nvec2 K(float B, float i) {\n  vec3 L;\n  L.x = sqrt(1. - B * B);\n  L.y = .0;\n  L.z = B;\n  float M = .0;\n  float O = .0;\n  vec3 h = vec3(.0, .0, 1.);\n  const int P = 1024;\n  for(int Q = 0; Q < P; ++Q) {\n    vec3 k = e(float(Q) / float(P), h, i);\n    vec3 R = normalize(2. * dot(L, k) * k - L);\n    float G = max(R.z, .0);\n    float S = max(k.z, .0);\n    float T = max(dot(L, k), .0);\n    float B = max(dot(h, L), .0);\n    if(G > .0) {\n      float U = F(B, G, i);\n      float W = (U * T) / (S * B);\n      float X = pow(1. - T, 5.);\n      M += (1. - X) * W;\n      O += X * W;\n    }\n  }\n  M /= float(P);\n  O /= float(P);\n  return vec2(M, O);\n}\nvoid main() {\n  vec2 Y = K(vTexCoords.x, vTexCoords.y);\n  gl_FragColor = d(Y.x, Y.y);\n}",vert:"attribute vec3 aPosition;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoords;\nvoid main() {\n  vTexCoords = aTexCoord;\n  gl_Position = vec4(aPosition, 1.);\n}",attributes:{aPosition:{buffer:a},aTexCoord:{buffer:l}},uniforms:{distributionMap:s},framebuffer:h,viewport:{x:0,y:0,width:e,height:e},count:hM.length/3,primitive:"triangle strip"});return c(),c.destroy(),a.destroy(),l.destroy(),s.destroy(),h}function fM(t,e){const n=new Float32Array(t*e*4);for(let i=0;i<t;i++){const{x:o,y:s}=dM(i,t);for(let t=0;t<e;t++){const a=t/e,l=a*a,h=2*Math.PI*o,c=Math.sqrt((1-s)/(1+(l*l-1)*s)),u=Math.sqrt(1-c*c),f=4*(i*e+t),g=u*Math.cos(h),A=u*Math.sin(h);n[f]=Math.abs(255*g),n[f+1]=Math.abs(255*A),n[f+2]=255*c,n[f+3]=(g>0?200:0)+(A>0?55:0)}}return n}function dM(t,e){let n=(t<<16|t>>>16)>>>0;return n=((1431655765&n)<<1|(2863311530&n)>>>1)>>>0,n=((858993459&n)<<2|(3435973836&n)>>>2)>>>0,n=((252645135&n)<<4|(4042322160&n)>>>4)>>>0,n=(((16711935&n)<<8|(4278255360&n)>>>8)>>>0)/4294967296,{x:t/e,y:n}}function gM(t){return t._gl instanceof WebGL2RenderingContext||t.hasExtension("OES_texture_half_float")}var pM=Object.freeze({__proto__:null,createIBLMaps:function(t,e={}){const n=e.envTexture,i=e.envCubeSize||512,o=e.sampleSize||1024,s=e.roughnessLevels||256,a=e.prefilterCubeSize||256;let l,h=!1;if(Array.isArray(n)){const e=t.cube({flipY:!0,faces:n});l=function(t,e,n){const i=t({frag:aM,vert:iM,attributes:{aPosition:nM.vertices},uniforms:{hsv:[0,0,0],projMatrix:t.context("projMatrix"),viewMatrix:t.context("viewMatrix"),cubeMap:e,bias:0,size:e.width,environmentExposure:1,backgroundIntensity:1},elements:nM.indices}),o=t.cube({width:n,height:n,min:"linear",mag:"linear",format:"rgba"}),s=t.framebufferCube({radius:n,color:o});return eM(t,s,i,{size:n},null,[[0,0,-1],[0,0,-1],[0,0,1],[0,0,1],[0,-1,0],[0,-1,0]]),i.destroy(),s}(t,e,i),e.destroy()}else l=function(t,e,n){if(!gM(t))throw new Error("HDR is not supported for lack of support for float 16 texture");n=n||512;const i=t({frag:"precision highp float;\n#define PI 3.1415926\nvarying vec3 vWorldPos;\nuniform sampler2D equirectangularMap;\nconst vec2 c = vec2(.1591, .3183);\nvec2 d(vec3 e) {\n  vec2 f = vec2(atan(e.y, e.x), asin(e.z));\n  f *= c;\n  f += .5;\n  return f;\n}\nvoid main() {\n  vec2 f = d(normalize(vWorldPos));\n  vec4 h = texture2D(equirectangularMap, f);\n  gl_FragColor = vec4(h.rgb, 1.);\n}",vert:iM,attributes:{aPosition:nM.vertices},uniforms:{projMatrix:t.context("projMatrix"),viewMatrix:t.context("viewMatrix"),equirectangularMap:e},elements:nM.indices}),o=t.cube({width:n,height:n,min:"linear mipmap linear",mag:"linear",type:"float16",format:"rgba"}),s=t.framebufferCube({radius:n,color:o});return eM(t,s,i),i.destroy(),s}(t,n,i),h=!0;const{prefilterMap:c,prefilterMipmap:u}=function(t,e,n,i,o,s){const a=function(t,e,n,i,o,s){const a=fM(i=i||1024,o=o||256),l=t.texture({data:a,width:o,height:i,min:"nearest",mag:"nearest"}),h=t({frag:"#define SHADER_NAME PBR_prefilter\nprecision highp float;\nvarying vec3 vWorldPos;\nuniform samplerCube environmentMap;\nuniform sampler2D distributionMap;\nuniform float roughness;\nuniform float resolution;\nconst float c = 3.14159265359;\nfloat d(vec3 e, vec3 f, float h) {\n  float a = h * h;\n  float i = a * a;\n  float j = max(dot(e, f), .0);\n  float k = j * j;\n  float l = i;\n  float m = (k * (i - 1.) + 1.);\n  m = c * m * m;\n  return l / m;\n}\nvec3 n(float o, vec3 e, float h) {\n  vec4 u = texture2D(distributionMap, vec2(h, o));\n  vec3 f = u.xyz;\n  float v = sign(u.w - .5);\n  float A = sign(u.w - 200.0 / 255. * clamp(v, .0, 1.) - .15);\n  f.x *= v;\n  f.y *= A;\n  vec3 B = abs(e.z) < .999 ? vec3(.0, .0, 1.) : vec3(1., .0, .0);\n  vec3 C = normalize(cross(B, e));\n  vec3 D = cross(e, C);\n  vec3 E = C * f.x + D * f.y + e * f.z;\n  return normalize(E);\n}\nvoid main() {\n  vec3 e = normalize(vWorldPos);\n  vec3 F = e;\n  vec3 G = F;\n  const int I = 1024;\n  vec3 J = vec3(.0);\n  float K = .0;\n  for(int L = 0; L < I; ++L) {\n    vec3 f = n(float(L) / float(I), e, roughness);\n    vec3 M = normalize(2. * dot(G, f) * f - G);\n    float O = max(dot(e, M), .0);\n    if(O > .0) {\n      J += textureCube(environmentMap, M).rgb * O;\n      K += O;\n    }\n  }\n  J = J / K;\n  gl_FragColor = vec4(J, 1.);\n}",vert:iM,attributes:{aPosition:nM.vertices},uniforms:{projMatrix:t.context("projMatrix"),viewMatrix:t.context("viewMatrix"),environmentMap:e,distributionMap:l,roughness:t.prop("roughness"),resolution:n},elements:nM.indices,viewport:{x:0,y:0,width:t.prop("size"),height:t.prop("size")}});let c=n;const u=t.texture({radius:n,min:"linear",mag:"linear",type:s?"float":"uint8"}),f=t.framebuffer({radius:n,color:u}),g=Math.log(c)/Math.log(2),A=[];for(let e=0;e<=g;e++){let n=0;eM(t,f,h,{roughness:e/(g-1),size:c},(function(){const e=t.read({framebuffer:f});let i=e;if(s){i=new Uint16Array(e.length);for(let t=0;t<e.length;t++)i[t]=Math.min(Pw(e[t]),65504)}A[n]||(A[n]={mipmap:[]}),A[n].mipmap.push(i),n++})),c/=2,f.resize(c)}return l.destroy(),f.destroy(),h.destroy(),A}(t,e,n,i,o,s);return{prefilterMap:t.cube({radius:n,min:"linear",mag:"linear",type:s?"float16":"uint8",faces:a,format:"rgba"}),prefilterMipmap:a}}(t,l,a,o,s,h);let f;if(!e.ignoreSH){const n=a;f=function(t,e,n){const i=new Array(9),o=[],s=[],a=[];for(let l=0;l<9;l++){const h=[0,0,0];for(let i=0;i<sM.length;i++){const c=t[i],u=[0,0,0];let f=0,g=0;const A=oM[sM[i]];for(let t=0;t<n;t++)for(let i=0;i<e;i++){o[0]=i/(e-1)*2-1,o[1]=t/(n-1)*2-1,o[2]=-1,Zy(o,o),a[0]=o[A[0]]*A[3],a[1]=o[A[1]]*A[4],a[2]=o[A[2]]*A[5],s[0]=c[g++]/255,s[1]=c[g++]/255,s[2]=c[g++]/255;const h=c[g++]/255*7;s[0]*=h,s[1]*=h,s[2]*=h,jy(u,u,s,rM(a,l)*-o[2]),f+=-o[2]}jy(h,h,u,1/f)}i[l]=Gy(h,h,1/6)}return i}(lM(t,c,n,!1,e.environmentExposure,!0),n,n);const i=[];for(let t=0;t<f.length;t++)i.push(...f[t]);f=i}const g={envMap:l,isHDR:h,prefilterMap:c};return f&&(g.sh=f),"array"===e.format&&(g.envMap={width:l.width,height:l.height,faces:lM(t,l,i,h)},g.prefilterMap={width:c.width,height:c.height,faces:u},l.destroy(),c.destroy()),g},generateDFGLUT:uM,supportFloat16:gM});const AM={uvScale:[1,1],uvOffset:[0,0],uvRotation:0,textureOrigin:null,textureWidth:null,baseColorFactor:[1,1,1,1],emissiveFactor:[0,0,0],baseColorIntensity:1,emitColorFactor:1,occlusionFactor:1,roughnessFactor:.4,metallicFactor:0,normalMapFactor:1,specularF0:.5,emitMultiplicative:1,normalMapFlipY:0,outputSRGB:1,baseColorTexture:null,normalTexture:null,occlusionTexture:null,metallicRoughnessTexture:null,emissiveTexture:null,uvOrigin:[0,0],noiseTexture:null,specularAAVariance:20,specularAAThreshold:20,hsv:[0,0,0],contrast:1,bumpTexture:null,bumpScale:.05,bumpMinLayers:5,bumpMaxLayers:20,alphaTest:0};let mM=class dr extends Qb{constructor(t){const e=Hx({},AM);(t.metallicRoughnessTexture||t.metallicRoughnessTexture)&&(e.roughnessFactor=1,e.metallicFactor=1),super(t,e)}appendDefines(t,e){super.appendDefines(t,e);const n=this.uniforms;if(n.GAMMA_CORRECT_INPUT&&(t.GAMMA_CORRECT_INPUT=1),e.data[e.desc.colorAttribute]&&(t.HAS_COLOR=1),e.data[e.desc.color0Attribute]&&(t.HAS_COLOR0=1,t.COLOR0_SIZE=e.getColor0Size()),e.data[e.desc.tangentAttribute]?t.HAS_TANGENT=1:e.data[e.desc.normalAttribute]&&(t.HAS_NORMAL=1),e.data.aVertexColorType&&(t.HAS_VERTEX_COLOR=1),!e.data[e.desc.uv0Attribute])return t;n.baseColorTexture&&(t.HAS_ALBEDO_MAP=1),n.metallicRoughnessTexture&&(t.HAS_METALLICROUGHNESS_MAP=1),n.occlusionTexture&&e.data[e.desc.uv1Attribute]&&(t.HAS_AO_MAP=1),n.emissiveTexture&&(t.HAS_EMISSIVE_MAP=1),n.normalTexture&&(t.HAS_NORMAL_MAP=1),n.bumpTexture&&(t.HAS_BUMP_MAP=1),n.skinTexture&&(t.HAS_SKIN_MAP=1),(t.HAS_ALBEDO_MAP||t.HAS_METALLICROUGHNESS_MAP||t.HAS_AO_MAP||t.HAS_EMISSIVE_MAP||t.HAS_NORMAL_MAP||t.HAS_BUMP_MAP||t.HAS_SKIN_MAP)&&(t.HAS_MAP=1),n.noiseTexture&&(t.HAS_RANDOM_TEX=1),e.data[e.desc.tangentAttribute]?t.HAS_TANGENT=1:e.data[e.desc.normalAttribute]&&(t.HAS_NORMAL=1);const i=n.alphaMode&&n.alphaMode.toUpperCase();return"MASK"===i?t.ALPHA_MODE=1:"OPAQUE"===i&&(t.ALPHA_MODE=2),t}},yM=class ur extends(iw(mM)){};function _M(t,e,n){if(n.ambientUpdate){const{iblTexes:i}=t,o=n.target;i?(bM(i),t.iblTexes=xM(e,o)):t.iblTexes=xM(e,o),o.getRenderer().setToRedraw()}}const vM=[0,0];function xM(t,e){const n=e.getLightManager(),i=n&&n.getAmbientResource();if(!i)return null;const o=i.isHDR;return{prefilterMap:t.cube({width:i.prefilterMap.width,height:i.prefilterMap.height,faces:i.prefilterMap.faces,min:"linear",mag:"linear",format:"rgba",type:o?"float16":"uint8"}),envMap:t.cube({width:i.envMap.width,height:i.envMap.height,faces:i.envMap.faces,min:"linear",mag:"linear",format:"rgba",type:o?"float16":"uint8"}),sh:i.sh}}function bM(t){for(const e in t)t[e]&&t[e].destroy&&t[e].destroy(),delete t[e]}var wM=Object.freeze({__proto__:null,createIBLTextures:xM,disposeIBLTextures:bM,getIBLResOnCanvas:function(t){const{dfgLUT:e,iblTexes:n}=t;return{dfgLUT:e,iblTexes:n}},getPBRUniforms:function(t,e,n,i,o){const s=t.viewMatrix,a=t.projMatrix,l=t.cameraPosition,h=t.getRenderer().canvas,c=function(t,e){const n=t.getLightManager(),i=n&&n.getAmbientResource(),o=n&&n.getAmbientLight()||{},s=n&&n.getDirectionalLight()||{};let a;if(i){const t=e.prefilterMap.width,n=Math.log(t)/Math.log(2);a={prefilterMap:e.prefilterMap,diffuseSPH:e.sh,prefilterMiplevel:[n,n],prefilterSize:[t,t],hdrHSV:o.hsv||[0,0,0]}}else a={ambientColor:o.color||[.2,.2,.2]};return a.environmentExposure=zx(o.exposure)?o.exposure:1,a.environmentOrientation=o.orientation||0,a.light0_diffuse=[...s.color||[1,1,1],1],a.light0_viewDirection=s.direction||[1,1,-1],a}(t,e),u=Hx({viewMatrix:s,projMatrix:a,projViewMatrix:t.projViewMatrix,cameraPosition:l,outSize:[h.width,h.height],cameraNearFar:[t.cameraNear,t.cameraFar]},c);return u.brdfLUT=n,i&&i.renderUniforms&&Hx(u,i.renderUniforms),u.halton=o||vM,u},isSupported:function(t){return t.hasExtension("EXT_shader_texture_lod")},loginIBLResOnCanvas:function(t,e,n){if(!t.dfgLUT&&(t.dfgLUT=uM(e),t.dfgLUT.mtkRefCount=0,n)){const i=(...n)=>_M.call(this,t,e,...n);n.on("updatelights",i),t._iblResListener=i}t.dfgLUT.mtkRefCount++;const i=n.getLightManager();return i&&i.getAmbientResource()?(t.iblTexes||(t.iblTexes=xM(e,n)),{dfgLUT:t.dfgLUT,iblTexes:t.iblTexes}):{dfgLUT:t.dfgLUT,iblTexes:null}},logoutIBLResOnCanvas:function(t,e){let n=!1;t.dfgLUT&&(t.dfgLUT.mtkRefCount--,t.dfgLUT.mtkRefCount<=0)&&(n=!0,e&&e.off("updatelights",t._iblResListener),t.dfgLUT.destroy(),delete t.dfgLUT),t.iblTexes&&n&&(bM(t.iblTexes),delete t.iblTexes)}});let TM=class xr extends zw{constructor(t){super({vert:"attribute vec3 aPosition;\nuniform mat4 lightProjViewModelMatrix;\nuniform mat4 positionMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 modelMatrix;\n#include <line_extrusion_vert>\n#include <get_output>\nvarying vec4 vPosition;\nvoid main() {\n  mat4 c = getPositionMatrix();\n#ifdef IS_LINE_EXTRUSION\nvec3 d = getLineExtrudePosition(aPosition);\n  vec4 e = getPosition(d);\n#else\nvec4 e = getPosition(aPosition);\n#endif\ngl_Position = lightProjViewModelMatrix * c * e;\n  vPosition = gl_Position;\n}",frag:"#define SHADER_NAME vsm_mapping\n#ifdef USE_VSM\n#extension GL_OES_standard_derivatives : enable\n#endif\nprecision highp float;\nvarying vec4 vPosition;\n#ifdef PACK_FLOAT\n#include <common_pack_float>\n#endif\nvoid main() {\n  \n#if defined(USE_VSM)\nfloat c = vPosition.z / vPosition.w;\n  c = c * .5 + .5;\n  float d = c;\n  float e = c * c;\n  float f = dFdx(c);\n  float h = dFdy(c);\n  e += .25 * (f * f + h * h);\n  gl_FragColor = vec4(d, e, c, .0);\n#endif\n#if defined(USE_ESM)\n#ifdef PACK_FLOAT\ngl_FragColor = common_encodeDepth(gl_FragCoord.z);\n#else\ngl_FragColor = vec4(gl_FragCoord.z, .0, .0, 1.);\n#endif\n#endif\n}",uniforms:[{name:"lightProjViewModelMatrix",type:"function",fn:function(t,e){return cy([],e.lightProjViewMatrix,e.modelMatrix)}}],extraCommandProps:{},defines:t})}filter(t){return t.castShadow}},MM=class pr extends Ww{constructor({blurOffset:t}){super({vert:jw,frag:"precision highp float;\nvarying vec2 vTexCoord;\nuniform sampler2D textureSource;\nuniform vec2 resolution;\n#include <common_pack_float>\nvoid main() {\n  float c = .0;\n  float d = .0;\n  for(int x = -BOXBLUR_OFFSET; x <= BOXBLUR_OFFSET; ++x)\n    for(int y = -BOXBLUR_OFFSET; y <= BOXBLUR_OFFSET; ++y) {\n      vec2 e = vTexCoord.st + vec2(float(x) / resolution.x, float(y) / resolution.y);\n      e = clamp(e, .0, 1.);\n      float f = common_decodeDepth(texture2D(textureSource, e));\n      float s = max(.0, sign(1. - f));\n      d += sign(f) * s;\n      c += f;\n    }\n  float h = c / max(1., d);\n  gl_FragColor = common_encodeDepth(h);\n}",defines:{BOXBLUR_OFFSET:t||2}}),this._blurOffset=t||2}getMeshCommand(t,e){const n="box_shadow_blur_"+this._blurOffset;return this.commands[n]||(this.commands[n]=this.createREGLCommand(t,null,e.getElements())),this.commands[n]}},CM=null,SM=null,PM=class Ar{constructor(t,{width:e,height:n,blurOffset:i,defines:o}){this.renderer=t,this.width=e||512,this.height=n||512,this.blurOffset=Dx(i)?2:i,this._init(o)}render(t,{cameraProjViewMatrix:e,lightDir:n,farPlane:i,cameraLookAt:o}){return{lightProjViewMatrix:this._renderShadow(t,e,n,i,o),shadowMap:this.blurTex||this.depthTex,depthFBO:this.depthFBO,blurFBO:this.blurFBO}}resize(t,e){return this.depthTex&&(this.depthTex.resize(t,e),this.depthFBO.resize(t,e)),this.width=t,this.blurFBO&&(this.blurTex.resize(t,e),this.blurFBO.resize(t,e)),this.height=e,this}_renderShadow(t,e,n,i,o){const s=this.renderer,a=CM(e);if(i)for(let t=4;t<8;t++)a[t]=i[t-4];const l=SM(o,a,n);return s.clear({color:[1,0,0,1],depth:1,framebuffer:this.depthFBO}),s.render(this.shadowMapShader,{lightProjViewMatrix:l},t,this.depthFBO),this.blurFBO&&(this.boxBlurShader||(this.boxBlurShader=new MM({blurOffset:this.blurOffset})),s.clear({color:[1,0,0,1],depth:1,framebuffer:this.blurFBO}),s.render(this.boxBlurShader,{resolution:[this.depthTex.width,this.depthTex.height],textureSource:this.depthTex},null,this.blurFBO)),l}_init(t){const e=this.renderer.regl,n="uint8",i=this.width,o=this.height;this.depthTex=e.texture({width:i,height:o,format:"rgb",type:n,min:"nearest",mag:"nearest"}),this.shadowMapShader=new TM(t),this.shadowMapShader.filter=t=>t.castShadow,this.depthFBO=e.framebuffer({color:this.depthTex}),this.blurOffset<=0||(this.blurTex=e.texture({width:i,height:o,format:"rgb",type:n,min:"linear",mag:"linear"}),this.blurFBO=e.framebuffer({color:this.blurTex}))}dispose(){this.depthTex&&(this.depthTex.destroy(),this.depthFBO.destroy(),delete this.depthTex,delete this.depthFBO),this.blurTex&&(this.blurTex.destroy(),this.blurFBO.destroy(),delete this.blurTex,delete this.blurFBO),this.shadowMapShader&&(this.shadowMapShader.dispose(),delete this.shadowMapShader),this.boxBlurShader&&(this.boxBlurShader.dispose(),delete this.boxBlurShader)}};CM=function(){const t=[[-1,-1,-1,1],[1,-1,-1,1],[1,1,-1,1],[-1,1,-1,1],[-1,-1,1,1],[1,-1,1,1],[1,1,1,1],[-1,1,1,1]],e=new Array(16);return function(n){hy(e,n);const i=[];for(let n=0;n<t.length;n++){const o=S_([],t[n],e);__(o,o,1/o[3]),i.push(o)}return i}}(),SM=function(){let t=new Array(4);const e=new Array(3),n=[0,0,0,0],i=[0,1,0],o=new Array(3);let s=new Array(16),a=new Array(16);const l=new Array(16),h=[1,1,1],c=[0,0,0];return function(u,f,g){g_(n,...u,1),Gy(e,g,-1),s=Sy(s,Ny(o,n,Zy(o,e)),n,i),S_(t,f[0],s);let A=t[2],m=t[2],w=t[0],T=t[0],M=t[1],C=t[1];for(let e=1;e<8;e++)t=S_(t,f[e],s),t[2]>m&&(m=t[2]),t[2]<A&&(A=t[2]),t[0]>T&&(T=t[0]),t[0]<w&&(w=t[0]),t[1]>C&&(C=t[1]),t[1]<M&&(M=t[1]);a=Cy(a,-1,1,-1,1,-m,-A);const P=h[0]=2/(T-w),I=h[1]=-2/(C-M);c[0]=-.5*(w+T)*P,c[1]=-.5*(M+C)*I,ay(l),uy(l,l,c),fy(l,l,h);const O=cy(a,l,a);return cy(new Array(16),O,s)}}();let IM=class Sr extends zw{constructor(t){super({vert:"#define SHADER_NAME SHADOW_DISPLAY\nattribute vec3 aPosition;\nuniform mat4 projMatrix;\nuniform mat4 modelViewMatrix;\nuniform vec2 halton;\nuniform vec2 globalTexSize;\nvarying vec4 vPosition;\n#include <vsm_shadow_vert>\nvoid main() {\n  vec4 c = vec4(aPosition, 1.);\n  vec4 d = modelViewMatrix * c;\n  mat4 e = projMatrix;\n  e[2].xy += halton.xy / globalTexSize.xy;\n  gl_Position = e * d;\n  vPosition = gl_Position;\n  shadow_computeShadowPars(c);\n}",frag:"#define SHADER_NAME SHADOW_DISPLAY\nprecision mediump float;\nuniform vec3 color;\n#include <vsm_shadow_frag>\nvoid main() {\n  float c = shadow_computeShadow();\n  float d = 1. - c;\n  gl_FragColor = vec4(color * d, d);\n}",uniforms:[{name:"modelViewMatrix",type:"function",fn:function(t,e){const n=[];return cy(n,e.viewMatrix,e.modelMatrix),n}}],defines:t||{USE_ESM:1},extraCommandProps:{depth:{enable:!0,mask:!1},viewport:{x:0,y:0,width:(t,e)=>e.globalTexSize[0],height:(t,e)=>e.globalTexSize[1]}}})}getMeshCommand(t,e){return this.commands.shadow_display||(this.commands.shadow_display=this.createREGLCommand(t,null,e.getElements())),this.commands.shadow_display}};function OM(t){return 256*t[2]*256+256*t[1]+t[0]}const EM=new Uint8Array(4),kM=new Float32Array(EM.buffer);let RM,LM;const DM=[1,1],FM="\n    vec3 unpack(highp float f) {\n        highp vec3 color;\n        color.b = floor(f / 65536.0);\n        color.g = floor((f - color.b * 65536.0) / 256.0);\n        color.r = f - floor(color.b * 65536.0) - floor(color.g * 256.0);\n        // now we have a vec3 with the 3 components in range [0..255]. Let's normalize it!\n        return color / 255.0;\n    }\n",NM=`\n    precision highp float;\n\n    varying float vPickingId;\n    varying float vFbo_picking_visible;\n\n    uniform float fbo_picking_meshId;\n\n    ${FM}\n\n    void main() {\n        if (vFbo_picking_visible == 0.0) {\n            discard;\n            return;\n        }\n        gl_FragColor = vec4(unpack(vPickingId), fbo_picking_meshId / 255.0);\n    }\n`,HM=`\n    precision highp float;\n\n    uniform int fbo_picking_meshId;\n    varying float vFbo_picking_visible;\n\n    ${FM}\n\n    void main() {\n        if (vFbo_picking_visible == 0.0) {\n            discard;\n            return;\n        }\n        gl_FragColor = vec4(unpack(float(fbo_picking_meshId)), 1.0);\n        // gl_FragColor = vec4(unpack(float(35)), 1.0);\n    }\n`,BM=`\n    precision highp float;\n\n    varying float vPickingId;\n    varying float vFbo_picking_visible;\n\n    ${FM}\n\n    void main() {\n        if (vFbo_picking_visible == 0.0) {\n            discard;\n            return;\n        }\n        gl_FragColor = vec4(unpack(vPickingId), 1.0);\n    }\n`;let zM=class Hr{constructor(t,{vert:e,uniforms:n,defines:i,extraCommandProps:o,enableStencil:s},a,l){this._renderer=t,this._fbo=a,this._map=l,this._clearFbo(a),this._vert=e,this._uniforms=n,this._defines=i,this._extraCommandProps=Hx({},o),delete this._extraCommandProps.blend,s?this._extraCommandProps.stencil={enable:s,mask:255,func:{cmp:"<",ref:1,mask:255},op:{fail:"keep",zfail:"keep",zpass:"replace"}}:delete this._extraCommandProps.stencil,this._currentMeshes=[],this._init()}_init(){const t=[];this._uniforms&&t.push(...this._uniforms);const e={ENABLE_PICKING:1,HAS_PICKING_ID:1};if(this._defines)for(const t in this._defines)e[t]=this._defines[t];const n=this._vert,i=this._extraCommandProps;this._shader0=new zw({vert:n,frag:NM,uniforms:t,defines:e,extraCommandProps:i}),this._shader2=new zw({vert:n,frag:BM,uniforms:t,defines:e,extraCommandProps:i});const o={ENABLE_PICKING:1,HAS_PICKING_ID:1};if(this._defines)for(const t in this._defines)o[t]=this._defines[t];this._shader1=new zw({vert:n,frag:HM,uniforms:t,defines:o,extraCommandProps:i}),this._depthShader=new zw({vert:n,frag:"\n    #ifdef GL_ES\n        precision highp float;\n    #endif\n    #if __VERSION__ == 100 && defined(GL_EXT_frag_depth)\n        #extension GL_EXT_frag_depth : enable\n    #endif\n    #include <gl2_frag>\n    #include <common_pack_float>\n    varying float vFbo_picking_viewZ;\n    uniform float logDepthBufFC;\n    varying float vFbo_picking_fragDepth;\n\n    const float PackUpscale = 256. / 255.;\n    const float UnpackDownscale = 255. / 256.;\n    const vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256., 256. );\n    const vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\n    const float ShiftRight8 = 1. / 256.;\n    vec4 packDepthToRGBA(const in float v ) {\n        vec4 r = vec4(fract(v * PackFactors), v);\n        r.yzw -= r.xyz * ShiftRight8;\n        return r * PackUpscale;\n    }\n\n    void main() {\n        float fragDepth = vFbo_picking_fragDepth > 1.0 ? vFbo_picking_fragDepth : vFbo_picking_viewZ + 1.0;\n        #if __VERSION__ == 300 || __VERSION__ == 100 && defined(GL_EXT_frag_depth)\n            gl_FragDepthEXT = log2(fragDepth) * logDepthBufFC * 0.5;\n        #endif\n        vec4 depthColor = packDepthToRGBA(fragDepth - 1.0);\n        glFragColor = common_unpackFloat(dot(depthColor, UnpackFactors));\n        #if __VERSION__ == 100\n            gl_FragColor = glFragColor;\n        #endif\n    }\n",uniforms:t,defines:o,extraCommandProps:i}),this._scene=new _w,this._scene1=new _w}filter(){return!0}render(t,e,n=!1){if(!t||!t.length)return this;const i=this._fbo;n&&this.clear(),t=t.filter((t=>t&&t.isValid&&t.isValid())),this._scene.setMeshes(t);const o=this._getShader(t,n);o.filter=this.filter,this._currentShader&&o!==this._currentShader&&this.clear(),this._currentShader=o,t.forEach(((t,e)=>{t.setUniform("fbo_picking_meshId",e+this._currentMeshes.length)}));for(let e=0;e<t.length;e++)this._currentMeshes.push(t[e]);return this._renderer.render(o,e,this._scene,i),this}pickAll(t,e,n,i,o){n=jM(n);const{meshIds:s,pickingIds:a,coords:l,points:h}=this._pick(t,e,n,i,o),c=[];if(a&&s){const t={};for(let e=0;e<s.length;e++){const n=`${a[e]}_${s[e]}`;null==s[e]||null==a[e]||t[n]||(t[n]=!0,c.push({meshId:s[e],pickingId:a[e],point:h[e]||null,coordinate:l[e]||null}))}}return c}pick(t,e,n,i,o={}){n=jM(n);const{meshIds:s,pickingIds:a,width:l,coords:h,points:c}=this._pick(t,e,n,i,o);if(a&&s){const t=[];for(let e=0;e<=n[0];e++)t.push(e),e>0&&t.push(-e);for(let e=0;e<t.length;e++)for(let i=0;i<t.length;i++){const o=(t[i]+n[1])*l+(t[e]+n[0]);if(null!=s[o])return{meshId:s[o],pickingId:a[o],point:c[o]||null,coordinate:h[o]||null}}}return{pickingId:null,meshId:null,point:null}}_pick(t,e,n,i,o={}){const s=this._currentShader,a=this._currentMeshes;if(!s||!a||!a.length)return{pickingId:null,meshId:null,point:null};t=Math.round(t),e=Math.round(e);const l=this._fbo;if(t<=2||t>=l.width-2||e<=2||e>=l.height-2)return{pickingId:null,meshId:null,point:null};const{px:h,py:c,width:u,height:f}=this._getParams(t,e,n,l),g=new Uint8Array(4*u*f),A=this._renderer.regl.read({data:g,x:h,y:c,framebuffer:l,width:u,height:f}),m=[];let w=[];for(let t=0;t<A.length;t+=4){const{pickingId:e,meshId:n}=this._packData(A.subarray(t,t+4),s);m.push(n),w.push(e)}const T={},M=m.filter((t=>null!=t&&!T[t]&&(T[t]=1,!0))).map((t=>a[t]));let C;for(let t=0;t<M.length;t++)if(M[t]&&M[t].geometry){C=M[t];break}if(!C)return{pickingId:null,meshId:null,point:null};const P=C.geometry.desc.pickingIdAttribute;m.length&&s===this._shader1&&(void 0!==C.getUniform("uPickingId")||C.geometry.data[P])&&(w=this._getPickingId(h,c,u,f,g,M,i));const I=[],O=[];if(m.length&&o.returnPoint){const{viewMatrix:n,projMatrix:s}=o,a=this._pickDepth(h,c,u,f,g,M,i);for(let i=0;i<a.length;i++)if(a[i]&&null!=m[i]){const o=this._getWorldPos(t,e,a[i],n,s),l=this._convertPickPoint(o);I.push(o),O.push(l)}else I.push(null),O.push(null)}return{meshIds:m,pickingIds:w,coords:O,points:I,width:u,height:f}}_convertPickPoint(t){const e=this._map;if(!e)return null;const n=e.getGLRes();if(!RM){const t=e.getCenter();LM=new t.constructor(0,0,0);const n=e.coordToPoint(t);RM=new n.constructor(0,0)}RM.set(t[0],t[1]);const i=e.pointAtResToCoord(RM,n,LM),o=e.pointAtResToAltitude(t[2],n);return[i.x,i.y,o]}clear(){return this._fbo&&this._clearFbo(this._fbo),this._currentMeshes=[],delete this._currentShader,this}getMeshAt(t){return this._currentMeshes?this._currentMeshes[t]:null}getRenderedMeshes(){return this._currentMeshes}dispose(){this.clear(),this._shader0&&this._shader0.dispose(),this._shader1&&this._shader1.dispose(),this._shader2&&this._shader2.dispose(),this._scene&&this._scene.clear(),this._scene1&&this._scene1.clear()}_getWorldPos(t,e,n,i,o){const s=this._fbo,a=[],l=s.width/2||1,h=s.height/2||1,c=[(t-l)/l,(h-e)/h,0,1],u=[(t-l)/l,(h-e)/h,1,1],f=hy(a,o),g=[],A=[];GM(g,c,f),GM(A,u,f);const m=-g[2],w=(n-m)/(-A[2]-m),T=hy(a,cy(a,o,i)),M=GM(c,c,T),C=GM(u,u,T);return[Gx(M[0],C[0],w),Gx(M[1],C[1],w),Gx(M[2],C[2],w)]}_getPickingId(t,e,n,i,o,s,a){const l=this._renderer.regl,h=this._getFBO1();this._clearFbo(h),this._scene1.setMeshes(s),this._renderer.render(this._shader2,a,this._scene1,h);const c=l.read({data:o,x:t,y:e,framebuffer:h,width:n,height:i}),u=[];for(let t=0;t<c.length;t+=4)u.push(OM(c.subarray(t,t+4)));return u}_pickDepth(t,e,n,i,o,s,a){const l=this._renderer.regl,h=this._getFBO1();this._scene1.setMeshes(s),this._clearFbo(h),a.logDepthBufFC=2/(Math.log(this._map.cameraFar+1)/Math.LN2),this._renderer.render(this._depthShader,a,this._scene1,h);const c=l.read({data:o,x:t,y:e,framebuffer:h,width:n,height:i}),u=[];for(let t=0;t<c.length;t+=4)u.push((f=c.subarray(t,t+4),EM[0]=f[3],EM[1]=f[2],EM[2]=f[1],EM[3]=f[0],kM[0]));var f;return u}_packData(t,e){if(255===t[0]&&255===t[1]&&255===t[2]&&255===t[3])return{meshId:null,pickingId:null};let n=null,i=null;return e===this._shader1?i=OM(t):e===this._shader0?(i=t[3],n=OM(t)):(i=null,n=OM(t)),{meshId:i,pickingId:n}}_clearFbo(t){this._renderer.regl.clear({color:[1,1,1,1],depth:1,stencil:255,framebuffer:t})}_getShader(t,e){return e&&t.length<256?this._shader0:this._shader1}_getFBO1(){const t=this._renderer.regl,e=this._fbo;return this._fbo1?this._fbo1.width===e.width&&this._fbo1.height===e.height||this._fbo1.resize(e.width,e.height):this._fbo1=t.framebuffer(e.width,e.height),this._fbo1}_getParams(t,e,n,i){const o=n[0],s=n[1];e=i.height-e;let a=2*o+1,l=2*s+1;const h=(t-=o)+a,c=(e-=s)+l;return h>i.width&&(a-=h-i.width),c>i.height&&(l-=c-i.height),{px:t=t<0?0:t,py:e=e<0?0:e,width:a,height:l}}getPickingVert(){return this._vert}getUniformDeclares(){return this._uniforms}};function GM(t,e,n){const i=e[0],o=e[1],s=e[2],a=1/(n[3]*i+n[7]*o+n[11]*s+n[15]);return t[0]=(n[0]*i+n[4]*o+n[8]*s+n[12])*a,t[1]=(n[1]*i+n[5]*o+n[9]*s+n[13])*a,t[2]=(n[2]*i+n[6]*o+n[10]*s+n[14])*a,t}function jM(t){return zx(t)&&(DM[0]=DM[1]=t,t=DM),t}const UM=t=>t&&t.geometry&&void 0===t.geometry.properties.shaderHash,VM=[],WM=[],ZM=[{name:"modelViewMatrix",type:"function",fn:(t,e)=>cy(VM,e.viewMatrix,e.modelMatrix)},{name:"modelViewProjMatrix",type:"function",fn:(t,e)=>{const n=cy(VM,e.viewMatrix,e.modelMatrix);return cy(VM,e.projMatrix,n)}},{name:"modelMatrixInverse",type:"function",fn:(t,e)=>hy(VM,e.modelMatrix)},{name:"projMatrixInverse",type:"function",fn:(t,e)=>hy(VM,e.projMatrix)},{name:"modelViewMatrixInverse",type:"function",fn:(t,e)=>(cy(VM,e.viewMatrix,e.modelMatrix),hy(VM,VM))},{name:"modelViewProjMatrixInverse",type:"function",fn:(t,e)=>{const n=cy(VM,e.viewMatrix,e.modelMatrix);return cy(VM,e.projMatrix,n),hy(VM,VM)}},{name:"modelInverseTransposeMatrix",type:"function",fn:(t,e)=>{const n=Qm(WM,e.modelMatrix),i=Km(n,n);return $m(i,i)}},{name:"modelViewInverseTransposeMatrix",type:"function",fn:(t,e)=>{const n=cy(VM,e.viewMatrix,e.modelMatrix),i=Qm(WM,n),o=Km(i,i);return $m(o,o)}}],qM={LOCAL:"positionMatrix",MODEL:"modelMatrix",VIEW:"viewMatrix",PROJECTION:"projMatrix",MODELVIEW:"modelViewMatrix",MODELVIEWPROJECTION:"modelViewProjMatrix",MODELINVERSE:"modelMatrixInverse",VIEWINVERSE:"viewMatrixInverse",PROJECTIONINVERSE:"projMatrixInverse",MODELVIEWINVERSE:"modelViewMatrixInverse",MODELVIEWPROJECTIONINVERSE:"modelViewProjMatrixInverse",MODELINVERSETRANSPOSE:"modelInverseTransposeMatrix",MODELVIEWINVERSETRANSPOSE:"modelViewInverseTransposeMatrix",VIEWPORT:"viewport",JOINTMATRIX:"jointMatrix",ALPHACUTOFF:"alphaCutoff"};let XM=class Vr{constructor(t,e,n){this._regl=t,this._khrShaders={},this._commandProps=e,this._resLoader=n}getExcludeFilter(){return UM}forEachShader(t){for(const e in this._khrShaders){const n=this._khrShaders[e];t(n.shader,n.filter,n.uniformSemantics)}}createMesh(t,e,n,i){const o=e.extensions.KHR_techniques_webgl,s=e.materials[t.material].extensions.KHR_techniques_webgl,{technique:a,values:l}=s,h=o.techniques[a],c=o.programs[h.program],u=o.shaders[c.vertexShader],f=o.shaders[c.fragmentShader];f.content=function(t){return t&&t.indexOf("precision")<0?"precision mediump float;\n"+t:t}(f.content);const g=$x(u.content)+"-"+$x(f.content);this._khrShaders[g]||(this._khrShaders[g]=this._createTechniqueShader(g,o,a,this._commandProps,i));const{attributeSemantics:A}=this._khrShaders[g],m=this._createGeometry(t,A,n,g),w=Hx({},l);for(const t in l)h.uniforms[t]&&35678===h.uniforms[t].type&&(w[t]=this._getTexture(e.textures[l[t].index]));return{geometry:m,material:new Qb(w)}}_createGeometry(t,e,n,i){const o=t.attributes,s="COLOR_0";if(o[s]){const t=o[s].array||o[s];if(t instanceof Float32Array){const e=new Uint8Array(t.length);for(let n=0;n<e.length;n++)e[n]=Math.round(255*t[n]);o[s].array?(o[s].array=e,o[s].componentType=5121):o[s]=e}}const a={};for(const t in o){const n=Fb(this._regl,o[t],{dimension:o[t].itemSize}),i=e[t]||t;a[i]={buffer:n},o[t].quantization&&(a[i].quantization=o[t].quantization),i===e.POSITION&&(a[i].array=o[t].array)}const l=new vb(a,t.indices.array?t.indices.array:t.indices,0,{positionAttribute:e.POSITION,normalAttribute:e.NORMAL,uv0Attribute:e.TEXCOORD_0,uv1Attribute:e.TEXCOORD_1,color0Attribute:e.COLOR_0,tangentAttribute:e.TANGENT,textureCoordMatrixAttribute:e.TextureCoordMatrix,primitive:void 0===t.mode?"triangles":wb(t.mode)});l.generateBuffers(this._regl,{excludeElementsInVAO:n}),l.properties.shaderHash=i;const h=l.data[l.desc.positionAttribute];return h&&h.array&&delete h.array,l}_getTexture(t){const e={type:t.type?Mb(t.type):"uint8",format:t.format?Sb(t.format):"rgba",flipY:!!t.flipY},n=t.image;n.array?e.data=n.array:n.mipmap&&(e.mipmap=n.mipmap),e.width=n.width,e.height=n.height;const i=t.sampler||t.texture.sampler;return i&&(i.magFilter&&(e.mag=Ib(i.magFilter)),i.minFilter&&(e.min=Eb(i.minFilter)),i.wrapS&&(e.wrapS=Rb(i.wrapS)),i.wrapT&&(e.wrapT=Rb(i.wrapT))),new Iw(e,this._resLoader)}_createTechniqueShader(t,e,n,i,o){const{techniques:s,programs:a,shaders:l}=e,h=s[n],c=a[h.program],u=l[c.vertexShader].content,f=l[c.fragmentShader].content,g={};for(const t in h.uniforms){const e=h.uniforms[t];e.semantic&&(g[e.semantic]=t)}const A=ZM.slice();for(const t in g)A.push({name:g[t],type:"function",fn:(e,n)=>n[qM[t]]});const m=new zw({vert:u,frag:f,uniforms:A,extraCommandProps:i});o&&(m.version=300);const w={};for(const t in h.attributes)w[h.attributes[t].semantic]=t;return{shader:m,filter:e=>e&&e.geometry&&e.geometry.properties.shaderHash===t,uniformSemantics:g,attributeSemantics:w}}dispose(){for(const t in this._khrShaders){const{shader:e}=this._khrShaders[t];e.dispose()}this._khrShaders={}}};function JM(t,e,n,i,o){let s;if(o===function(t,e,n,i){let o=0;for(let s=e,a=n-i;s<n;s+=i)o+=(t[a]-t[s])*(t[s+1]+t[a+1]),a=s;return o}(t,e,n,i)>0)for(let o=e;o<n;o+=i)s=mC(o/i|0,t[o],t[o+1],s);else for(let o=n-i;o>=e;o-=i)s=mC(o/i|0,t[o],t[o+1],s);return s&&uC(s,s.next)&&(yC(s),s=s.next),s}function QM(t,e){if(!t)return t;e||(e=t);let n,i=t;do{if(n=!1,i.steiner||!uC(i,i.next)&&0!==cC(i.prev,i,i.next))i=i.next;else{if(yC(i),i=e=i.prev,i===i.next)break;n=!0}}while(n||i!==e);return e}function YM(t,e,n,i,o,s,a){if(!t)return;!a&&s&&function(t,e,n,i){let o=t;do{0===o.z&&(o.z=oC(o.x,o.y,e,n,i)),o.prevZ=o.prev,o.nextZ=o.next,o=o.next}while(o!==t);o.prevZ.nextZ=null,o.prevZ=null,function(t){let e,n=1;do{let i,o=t;t=null;let s=null;for(e=0;o;){e++;let a=o,l=0;for(let t=0;t<n&&(l++,a=a.nextZ,a);t++);let h=n;for(;l>0||h>0&&a;)0!==l&&(0===h||!a||o.z<=a.z)?(i=o,o=o.nextZ,l--):(i=a,a=a.nextZ,h--),s?s.nextZ=i:t=i,i.prevZ=s,s=i;o=a}s.nextZ=null,n*=2}while(e>1)}(o)}(t,i,o,s);let l=t;for(;t.prev!==t.next;){const h=t.prev,c=t.next;if(s?$M(t,i,o,s):KM(t))e.push(h.i,t.i,c.i),yC(t),t=c.next,l=c.next;else if((t=c)===l){a?1===a?YM(t=tC(QM(t),e),e,n,i,o,s,2):2===a&&eC(t,e,n,i,o,s):YM(QM(t),e,n,i,o,s,1);break}}}function KM(t){const e=t.prev,n=t,i=t.next;if(cC(e,n,i)>=0)return!1;const o=e.x,s=n.x,a=i.x,l=e.y,h=n.y,c=i.y,u=Math.min(o,s,a),f=Math.min(l,h,c),g=Math.max(o,s,a),A=Math.max(l,h,c);let m=i.next;for(;m!==e;){if(m.x>=u&&m.x<=g&&m.y>=f&&m.y<=A&&lC(o,l,s,h,a,c,m.x,m.y)&&cC(m.prev,m,m.next)>=0)return!1;m=m.next}return!0}function $M(t,e,n,i){const o=t.prev,s=t,a=t.next;if(cC(o,s,a)>=0)return!1;const l=o.x,h=s.x,c=a.x,u=o.y,f=s.y,g=a.y,A=Math.min(l,h,c),m=Math.min(u,f,g),w=Math.max(l,h,c),T=Math.max(u,f,g),M=oC(A,m,e,n,i),C=oC(w,T,e,n,i);let P=t.prevZ,I=t.nextZ;for(;P&&P.z>=M&&I&&I.z<=C;){if(P.x>=A&&P.x<=w&&P.y>=m&&P.y<=T&&P!==o&&P!==a&&lC(l,u,h,f,c,g,P.x,P.y)&&cC(P.prev,P,P.next)>=0)return!1;if(P=P.prevZ,I.x>=A&&I.x<=w&&I.y>=m&&I.y<=T&&I!==o&&I!==a&&lC(l,u,h,f,c,g,I.x,I.y)&&cC(I.prev,I,I.next)>=0)return!1;I=I.nextZ}for(;P&&P.z>=M;){if(P.x>=A&&P.x<=w&&P.y>=m&&P.y<=T&&P!==o&&P!==a&&lC(l,u,h,f,c,g,P.x,P.y)&&cC(P.prev,P,P.next)>=0)return!1;P=P.prevZ}for(;I&&I.z<=C;){if(I.x>=A&&I.x<=w&&I.y>=m&&I.y<=T&&I!==o&&I!==a&&lC(l,u,h,f,c,g,I.x,I.y)&&cC(I.prev,I,I.next)>=0)return!1;I=I.nextZ}return!0}function tC(t,e){let n=t;do{const i=n.prev,o=n.next.next;!uC(i,o)&&fC(i,n,n.next,o)&&pC(i,o)&&pC(o,i)&&(e.push(i.i,n.i,o.i),yC(n),yC(n.next),n=t=o),n=n.next}while(n!==t);return QM(n)}function eC(t,e,n,i,o,s){let a=t;do{let t=a.next.next;for(;t!==a.prev;){if(a.i!==t.i&&hC(a,t)){let l=AC(a,t);return a=QM(a,a.next),l=QM(l,l.next),YM(a,e,n,i,o,s,0),void YM(l,e,n,i,o,s,0)}t=t.next}a=a.next}while(a!==t)}function nC(t,e){let n=t.x-e.x;return 0===n&&(n=t.y-e.y,0===n)&&(n=(t.next.y-t.y)/(t.next.x-t.x)-(e.next.y-e.y)/(e.next.x-e.x)),n}function iC(t,e){const n=function(t,e){let n=e;const i=t.x,o=t.y;let s,a=-1/0;if(uC(t,n))return n;do{if(uC(t,n.next))return n.next;if(o<=n.y&&o>=n.next.y&&n.next.y!==n.y){const t=n.x+(o-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(t<=i&&t>a&&(a=t,s=n.x<n.next.x?n:n.next,t===i))return s}n=n.next}while(n!==e);if(!s)return null;const l=s,h=s.x,c=s.y;let u=1/0;n=s;do{if(i>=n.x&&n.x>=h&&i!==n.x&&aC(o<c?i:a,o,h,c,o<c?a:i,o,n.x,n.y)){const e=Math.abs(o-n.y)/(i-n.x);pC(n,t)&&(e<u||e===u&&(n.x>s.x||n.x===s.x&&rC(s,n)))&&(s=n,u=e)}n=n.next}while(n!==l);return s}(t,e);if(!n)return e;const i=AC(n,t);return QM(i,i.next),QM(n,n.next)}function rC(t,e){return cC(t.prev,t,e.prev)<0&&cC(e.next,t,t.next)<0}function oC(t,e,n,i,o){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-n)*o|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-i)*o|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function sC(t){let e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function aC(t,e,n,i,o,s,a,l){return(o-a)*(e-l)>=(t-a)*(s-l)&&(t-a)*(i-l)>=(n-a)*(e-l)&&(n-a)*(s-l)>=(o-a)*(i-l)}function lC(t,e,n,i,o,s,a,l){return!(t===a&&e===l)&&aC(t,e,n,i,o,s,a,l)}function hC(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){let n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&fC(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&(pC(t,e)&&pC(e,t)&&function(t,e){let n=t,i=!1;const o=(t.x+e.x)/2,s=(t.y+e.y)/2;do{n.y>s!=n.next.y>s&&n.next.y!==n.y&&o<(n.next.x-n.x)*(s-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==t);return i}(t,e)&&(cC(t.prev,t,e.prev)||cC(t,e.prev,e))||uC(t,e)&&cC(t.prev,t,t.next)>0&&cC(e.prev,e,e.next)>0)}function cC(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function uC(t,e){return t.x===e.x&&t.y===e.y}function fC(t,e,n,i){const o=gC(cC(t,e,n)),s=gC(cC(t,e,i)),a=gC(cC(n,i,t)),l=gC(cC(n,i,e));return o!==s&&a!==l||!(0!==o||!dC(t,n,e))||!(0!==s||!dC(t,i,e))||!(0!==a||!dC(n,t,i))||!(0!==l||!dC(n,e,i))}function dC(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function gC(t){return t>0?1:t<0?-1:0}function pC(t,e){return cC(t.prev,t,t.next)<0?cC(t,e,t.next)>=0&&cC(t,t.prev,e)>=0:cC(t,e,t.prev)<0||cC(t,t.next,e)<0}function AC(t,e){const n=_C(t.i,t.x,t.y),i=_C(e.i,e.x,e.y),o=t.next,s=e.prev;return t.next=e,e.prev=t,n.next=o,o.prev=n,i.next=n,n.prev=i,s.next=i,i.prev=s,i}function mC(t,e,n,i){const o=_C(t,e,n);return i?(o.next=i.next,o.prev=i,i.next.prev=o,i.next=o):(o.prev=o,o.next=o),o}function yC(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function _C(t,e,n){return{i:t,x:e,y:n,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}const vC={parseHDR:Cw},xC={PBRHelper:pM,StandardMaterial:mM,StandardSpecularGlossinessMaterial:yM,StandardShader:class extends zw{constructor(t={}){let e=t.extraCommandProps||{};const n=t.uniforms;e=Hx({},e);const i=t.defines||{},o=[],s=[],a=[],l=[],h=[],c=[{name:"modelNormalMatrix",type:"function",fn:(t,e)=>Qm(o,e.modelMatrix)},{name:"modelViewNormalMatrix",type:"function",fn:(t,e)=>{const n=cy(s,e.viewMatrix,e.modelMatrix),i=hy(n,n),o=ly(i,i);return Qm(a,o)}},{name:"modelViewMatrix",type:"function",fn:(t,e)=>cy(l,e.viewMatrix,e.modelMatrix)},{name:"environmentTransform",type:"function",fn:(t,e)=>ey(h,Math.PI*(e.environmentOrientation||0)/180)}];n&&c.push(...n),super({vert:t.vert||"#include <gl2_vert>\n#define SHADER_NAME PBR\nprecision highp float;\nattribute vec3 aPosition;\n#if defined(HAS_MAP)\nattribute vec2 aTexCoord;\nuniform vec2 uvOrigin;\nuniform vec2 uvScale;\nuniform vec2 uvOffset;\nuniform float uvRotation;\n#ifdef HAS_I3S_UVREGION\nattribute vec4 uvRegion;\nvarying vec4 vUvRegion;\n#endif\n#if defined(HAS_AO_MAP)\nattribute vec2 aTexCoord1;\nvarying vec2 vTexCoord1;\n#endif\n#endif\nvec3 c;\nvec3 d;\nvec4 e;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 positionMatrix;\nuniform mat4 projMatrix;\nuniform mediump vec3 cameraPosition;\nuniform mat3 modelNormalMatrix;\n#ifdef HAS_SSR\nuniform mat3 modelViewNormalMatrix;\nvarying vec3 vViewNormal;\n#ifdef HAS_TANGENT\nvarying vec4 vViewTangent;\n#endif\n#endif\nvarying vec3 vModelNormal;\nvarying vec4 vViewVertex;\n#if defined(HAS_TANGENT)\nvarying vec4 vModelTangent;\nvarying vec3 vModelBiTangent;\n#endif\nvarying vec3 vModelVertex;\n#if defined(HAS_MAP)\nvarying vec2 vTexCoord;\n#endif\n#if defined(HAS_COLOR)\nattribute vec4 aColor;\nvarying vec4 vColor;\n#endif\n#ifdef HAS_OPACITY\nattribute float aOpacity;\n#endif\nvarying float vOpacity;\n#include <highlight_vert>\n#if defined(HAS_COLOR0)\n#if COLOR0_SIZE == 3\nattribute vec3 aColor0;\nvarying vec3 vColor0;\n#else\nattribute vec4 aColor0;\nvarying vec4 vColor0;\n#endif\n#endif\n#include <line_extrusion_vert>\n#include <get_output>\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_vert>\n#endif\n#include <heatmap_render_vert>\n#include <vertex_color_vert>\n#if defined(HAS_BUMP_MAP) && defined(HAS_TANGENT)\nvarying vec3 vTangentViewPos;\nvarying vec3 vTangentFragPos;\n#if __VERSION__ == 100\nmat3 f(in mat3 h) {\n  vec3 i = h[0];\n  vec3 j = h[1];\n  vec3 k = h[2];\n  return mat3(vec3(i.x, j.x, k.x), vec3(i.y, j.y, k.y), vec3(i.z, j.z, k.z));\n}\n#else\nmat3 f(in mat3 h) {\n  return transpose(h);\n}\n#endif\n#endif\nvoid l(const highp vec4 q, out highp vec3 m) {\n  m = vec3(.0, .0, 1.) + vec3(2., -2., -2.) * q.x * q.zwx + vec3(2., 2., -2.) * q.y * q.wzy;\n}\nvoid l(const highp vec4 q, out highp vec3 m, out highp vec3 t) {\n  l(q, m);\n  t = vec3(1., .0, .0) + vec3(-2., 2., -2.) * q.y * q.yxw + vec3(-2., 2., 2.) * q.z * q.zwx;\n}\nconst float o = .5;\nvec2 u(vec2 v, float A) {\n  return vec2(cos(A) * (v.x - o) + sin(A) * (v.y - o) + o, cos(A) * (v.y - o) - sin(A) * (v.x - o) + o);\n}\n#if defined(HAS_MAP)\nvec2 B(vec2 v) {\n  vec2 C = decode_getTexcoord(v);\n#ifdef HAS_RANDOM_TEX\nvec2 D = uvOrigin;\n  vec2 E = C * uvScale + uvOffset;\n  return mod(D, 1.) + E;\n#else\nvec2 D = uvOrigin;\n  vec2 E = C * uvScale;\n  if(uvRotation != .0) {\n    D = u(D, uvRotation);\n    E = u(E, uvRotation);\n  }\n  return mod(D, 1.) + E + uvOffset;\n#endif\n}\n#endif\n#ifdef PICKING_MODE\n#include <fbo_picking_vert>\n#endif\n#include <excavate_vert>\nvoid main() {\n  mat4 F = getPositionMatrix();\n#ifdef IS_LINE_EXTRUSION\nvec3 G = getLineExtrudePosition(aPosition);\n  vec4 H = getPosition(G);\n#else\nvec4 H = getPosition(aPosition);\n#endif\nvModelVertex = (modelMatrix * H).xyz;\n  vec4 I = F * H;\n  vec4 J = modelViewMatrix * I;\n  vViewVertex = J;\n#ifdef HAS_MASK_EXTENT\ngl_Position = projMatrix * getMaskPosition(I, modelMatrix);\n#else\ngl_Position = projMatrix * J;\n#endif\n#ifdef PICKING_MODE\nfloat K = 1.;\n#if defined(HAS_COLOR)\nK *= aColor.a;\n#endif\n#if defined(HAS_COLOR0) && COLOR0_SIZE == 4\nK *= aColor0.a;\n#endif\nfbo_picking_setData(gl_Position.w, K != .0);\n#else\n#if defined(HAS_MAP)\nvTexCoord = B(aTexCoord);\n#ifdef HAS_AO_MAP\nvTexCoord1 = B(aTexCoord1);\n#endif\n#ifdef HAS_I3S_UVREGION\nvUvRegion = uvRegion / 65535.;\n#endif\n#endif\n#if defined(HAS_TANGENT) || defined(HAS_NORMAL)\nmat3 L = mat3(F);\n  mat3 M = modelNormalMatrix * L;\n#if defined(HAS_TANGENT)\nvec3 t;\n  l(aTangent, d, t);\n  vModelTangent = vec4(M * t, aTangent.w);\n#else\nd = decode_getNormal(aNormal);\n#endif\nvec3 N = d;\n  vModelNormal = M * N;\n#else\nd = vec3(.0);\n  vModelNormal = vec3(.0);\n#endif\n#if defined(HAS_TANGENT)\nvModelBiTangent = cross(vModelNormal, vModelTangent.xyz) * sign(aTangent.w);\n#endif\n#ifdef HAS_SSR\nmat3 O = modelViewNormalMatrix * L;\n  vViewNormal = O * d;\n#if defined(HAS_TANGENT)\nvec4 P = vec4(t, aTangent.w);\n  vViewTangent = vec4(O * P.xyz, P.w);\n#endif\n#endif\n#if defined(HAS_COLOR)\nvColor = aColor / 255.;\n#endif\n#ifdef HAS_OPACITY\nvOpacity = aOpacity / 255.;\n#else\nvOpacity = 1.;\n#endif\nhighlight_setVarying();\n#if defined(HAS_COLOR0)\nvColor0 = aColor0 / 255.;\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nshadow_computeShadowPars(I);\n#endif\n#ifdef HAS_HEATMAP\nheatmap_compute(projMatrix * modelViewMatrix * F, H);\n#endif\n#if defined(HAS_BUMP_MAP) && defined(HAS_TANGENT)\nmat3 Q = f(mat3(vModelTangent.xyz, vModelBiTangent, vModelNormal));\n  vTangentViewPos = Q * cameraPosition;\n  vTangentFragPos = Q * vModelVertex;\n#endif\n#ifdef HAS_VERTEX_COLOR\nvertexColor_update();\n#endif\n#ifdef HAS_EXCAVATE_ANALYSIS\nvCoordinateTexcoord = getCoordinateTexcoord();\n  vHeight = getWorldHeight();\n#endif\n#endif\n}",frag:t.frag||"#define PI 3.141593\n#define RECIPROCAL_PI 1.0\n#if __VERSION__ == 100\n#if defined(GL_EXT_shader_texture_lod)\n#extension GL_EXT_shader_texture_lod : enable\n#define textureCubeLod(tex, uv, lod) textureCubeLodEXT(tex, uv, lod)\n#else\n#define textureCubeLod(tex, uv, lod) textureCube(tex, uv, lod)\n#endif\n#if defined(GL_OES_standard_derivatives)\n#extension GL_OES_standard_derivatives : enable\n#endif\n#else\n#define textureCubeLod(tex, uv, lod) textureLod(tex, uv, lod)\n#endif\n#define saturate(x)        clamp(x, 0.0, 1.0)\nprecision mediump float;\n#include <gl2_frag>\n#include <hsv_frag>\n#include <srgb_frag>\nuniform vec3 hsv;\nuniform float contrast;\nstruct MaterialUniforms {\n  vec2 roughnessMetalness;\n  vec3 albedo;\n  float alpha;\n  vec3 normal;\n  vec3 emit;\n  float ao;\n  vec3 specularColor;\n  float glossiness;\n  vec4 skinColor;\n} c;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_frag>\n#endif\nuniform vec3 cameraPosition;\nuniform float alphaTest;\n#if defined(SHADING_MODEL_SPECULAR_GLOSSINESS)\nuniform vec4 diffuseFactor;\nuniform vec3 specularFactor;\nuniform float glossinessFactor;\n#if defined(HAS_DIFFUSE_MAP)\nuniform sampler2D diffuseTexture;\n#endif\n#if defined(HAS_SPECULARGLOSSINESS_MAP)\nuniform sampler2D specularGlossinessTexture;\n#endif\n#endif\nuniform vec3 emissiveFactor;\nuniform vec4 baseColorFactor;\nuniform float baseColorIntensity;\nuniform float emitColorFactor;\nuniform float occlusionFactor;\nuniform float environmentExposure;\nuniform float roughnessFactor;\nuniform float metallicFactor;\nuniform float normalMapFactor;\nuniform float specularF0;\nuniform int emitMultiplicative;\nuniform int normalMapFlipY;\nuniform int outputSRGB;\nuniform mat3 environmentTransform;\n#if defined(HAS_ALBEDO_MAP)\nuniform sampler2D baseColorTexture;\n#endif\n#if defined(HAS_METALLICROUGHNESS_MAP)\nuniform sampler2D metallicRoughnessTexture;\n#endif\n#if defined(HAS_EMISSIVE_MAP)\nuniform sampler2D emissiveTexture;\n#endif\n#if defined(HAS_AO_MAP)\nuniform sampler2D occlusionTexture;\nvarying vec2 vTexCoord1;\n#endif\n#if defined(HAS_NORMAL_MAP) && defined(HAS_TANGENT)\nuniform sampler2D normalTexture;\n#endif\n#if defined(HAS_SKIN_MAP)\nuniform sampler2D skinTexture;\n#endif\n#if defined(ALPHA_MODE) && ALPHA_MODE == 1\nuniform float alphaCutoff;\n#endif\n#ifdef HAS_RANDOM_TEX\nuniform highp vec2 uvOrigin;\nuniform sampler2D noiseTexture;\n#endif\nuniform sampler2D brdfLUT;\n#if defined(HAS_IBL_LIGHTING)\nuniform vec3 hdrHSV;\nuniform samplerCube prefilterMap;\nuniform vec3 diffuseSPH[9];\nuniform vec2 prefilterMiplevel;\nuniform vec2 prefilterSize;\n#else\nuniform vec3 ambientColor;\n#endif\nuniform vec2 cameraNearFar;\nuniform vec3 light0_viewDirection;\nuniform vec4 light0_diffuse;\n#ifdef HAS_SSR\nvarying vec3 vViewNormal;\n#if defined(HAS_TANGENT)\nvarying vec4 vViewTangent;\n#endif\n#endif\nvarying vec3 vModelVertex;\nvarying vec4 vViewVertex;\n#if defined(HAS_MAP)\n#include <computeTexcoord_frag>\n#endif\nvarying vec3 vModelNormal;\n#if defined(HAS_TANGENT)\nvarying vec4 vModelTangent;\nvarying vec3 vModelBiTangent;\n#endif\n#if defined(HAS_COLOR0)\n#if COLOR0_SIZE == 3\nvarying vec3 vColor0;\n#else\nvarying vec4 vColor0;\n#endif\n#endif\n#if defined(HAS_COLOR)\nvarying vec4 vColor;\n#elif defined(IS_LINE_EXTRUSION)\nuniform vec4 lineColor;\n#else\nuniform vec4 polygonFill;\n#endif\n#ifdef HAS_LAYER_OPACITY\nuniform float layerOpacity;\n#endif\nvarying float vOpacity;\n#ifdef HAS_INSTANCE_COLOR\nvarying vec4 vInstanceColor;\n#endif\n#ifdef IS_LINE_EXTRUSION\nuniform float lineOpacity;\n#else\nuniform float polygonOpacity;\n#endif\n#ifdef HAS_PATTERN\nuniform sampler2D linePatternFile;\nuniform vec2 atlasSize;\nuniform float flipY;\nuniform float currentTime;\nuniform float animSpeedScale;\n#ifdef HAS_PATTERN_ANIM\nvarying float vLinePatternAnimSpeed;\n#else\nuniform float linePatternAnimSpeed;\n#endif\n#ifdef HAS_PATTERN_GAP\nvarying float vLinePatternGap;\n#else\nuniform float linePatternGap;\n#endif\nuniform vec4 linePatternGapColor;\nuniform vec2 uvScale;\nvarying float vPatternHeight;\nvarying float vLinesofar;\nvarying vec4 vTexInfo;\nvarying float vNormalY;\nvec2 d(vec2 e) {\n  vec2 f = mod(e, 1.);\n  vec2 h = vTexInfo.xy;\n  vec2 i = vTexInfo.zw;\n  return (h + f * i) / atlasSize;\n}\n#endif\n#include <heatmap_render_frag>\n#include <snow_frag>\n#include <mask_frag>\n#include <terrain_normal_frag>\n#include <vertex_color_frag>\n#include <excavate_frag>\n#ifdef HAS_RANDOM_TEX\nconst float j = .5;\nvec2 k(vec2 f, float l) {\n  return vec2(cos(l) * (f.x - j) + sin(l) * (f.y - j) + j, cos(l) * (f.y - j) - sin(l) * (f.x - j) + j);\n}\nfloat m(vec3 n) {\n  return n.x + n.y + n.z;\n}\n#endif\nvec4 o(sampler2D u, in vec2 f) {\n  \n#ifdef HAS_RANDOM_TEX\nhighp vec2 A = uvOrigin;\n  highp vec2 B = f + A - mod(A, 1.);\n  float C = texture2D(noiseTexture, .005 * B).x;\n  vec2 D = dFdx(B);\n  vec2 E = dFdx(B);\n  float F = C * 8.;\n  float G = fract(F);\n#if 1\nfloat H = floor(F);\n  float I = H + 1.;\n#else\nfloat H = floor(F + .5);\n  float I = floor(F);\n  G = min(G, 1. - G) * 2.;\n#endif\nvec2 J = sin(vec2(3., 7.) * H);\n  vec2 K = sin(vec2(3., 7.) * I);\n  float L = .5;\n  vec4 M = texture2DGradEXT(u, f + L * J, D, E);\n  vec4 N = texture2DGradEXT(u, f + L * K, D, E);\n  return mix(M, N, smoothstep(.2, .8, G - .1 * m(M.xyz - N.xyz)));\n#else\nreturn texture2D(u, f);\n#endif\n}\n#if defined(HAS_BUMP_MAP) && defined(HAS_TANGENT)\nuniform sampler2D bumpTexture;\nuniform float bumpScale;\nuniform float bumpMaxLayers;\nuniform float bumpMinLayers;\nvec2 O(vec2 f, vec3 P) {\n  float Q = mix(bumpMaxLayers, bumpMinLayers, abs(dot(vec3(.0, .0, 1.), P)));\n  float R = 1. / Q;\n  float S = .0;\n  vec2 T = P.xy * bumpScale / (P.z * Q);\n  vec2 U = f;\n  float V = o(bumpTexture, U).r;\n  for(int W = 0; W < 30; W++) {\n    S += R;\n    U -= T;\n    V = o(bumpTexture, U).r;\n    if(V < S) {\n      break;\n    }\n  }\n  vec2 X = U + T;\n  float Y = V - S;\n  float Z = o(bumpTexture, X).r - S + R;\n  return mix(U, X, Y / (Y - Z));\n}\nvarying vec3 vTangentViewPos;\nvarying vec3 vTangentFragPos;\n#endif\n#define SHADER_NAME PBR\nvec3 ba() {\n  return c.albedo;\n}\nfloat bb() {\n  return c.alpha;\n}\nfloat bc() {\n  return c.roughnessMetalness.y;\n}\nfloat bd() {\n  \n#if defined(SHADING_MODEL_SPECULAR_GLOSSINESS)\nreturn 1. - c.glossiness;\n#else\nreturn c.roughnessMetalness.x;\n#endif\n}\nvec3 be() {\n  return c.emit;\n}\nvec4 bf() {\n  return c.skinColor;\n}\nvec3 bg() {\n  return c.normal;\n}\nfloat bh() {\n  return c.ao;\n}\nfloat bi(const in vec4 bj) {\n  return bj.r + bj.g / 255.;\n}\nvec3 bk(const in float bl, in vec3 bm, const in vec3 t, const in vec3 b, in vec3 bn) {\n  bm.xy = bl * bm.xy;\n  mat3 bo = mat3(t, b, bn);\n  return normalize(bo * bm);\n}\nfloat bp(const float bq, const vec3 bm, const vec3 br) {\n  float bs = clamp(dot(bm, br), 0., 1.);\n  float a = bq * bq;\n  float bt = a * a;\n  float bu = (bs * bt - bs) * bs + 1.;\n  return bt / (PI * bu * bu);\n}\nvec3 bv(const vec3 bw, const float bx, const in vec3 by, const in vec3 br) {\n  float bz = clamp(dot(by, br), 0., 1.);\n  bz = pow(1. - bz, 5.);\n  return bx * bz + (1. - bz) * bw;\n}\nfloat bA(const in vec3 bm, const in vec3 bB, const in float bq, const float bC) {\n  float bD = clamp(dot(bm, bB), 0., 1.);\n  float a = bq * bq;\n  float bE = bD * (bC * (1. - a) + a);\n  float bF = bC * (bD * (1. - a) + a);\n  return .5 / (bF + bE);\n}\nvec3 bG(const float bq, const vec3 bm, const vec3 bB, const vec3 by, const vec3 bH, const float bC, const float bx) {\n  vec3 br = normalize(bB + by);\n  float bI = bp(bq, bm, br);\n  float bJ = bA(bm, bB, bq, bC);\n  vec3 bK = bv(bH, bx, by, br);\n  return (bI * bJ * PI) * bK;\n}\nvec3 bL(const in vec3 bM) {\n  return RECIPROCAL_PI * bM;\n}\nvoid bN(const in vec3 bm, const in vec3 bB, const in float bC, const in float bq, const in vec3 bO, const in vec3 bH, const in vec3 bP, const in vec3 by, const in float bx, out vec3 bQ, out vec3 bR) {\n  if(bC <= .0) {\n    bR = bQ = vec3(.0);\n    return;\n  }\n  vec3 a = bC * bP;\n  vec3 bS = bG(bq, bm, bB, by, bH, bC, bx);\n  bR = a * bS;\n  bQ = a * bL(bO);\n}\n#if defined(HAS_IBL_LIGHTING)\nvec3 bT(const in vec3 bm) {\n  vec3 bn = environmentTransform * bm;\n  float x = bn.x;\n  float y = bn.y;\n  float z = bn.z;\n  vec3 bU = (diffuseSPH[0] + diffuseSPH[1] * x + diffuseSPH[2] * y + diffuseSPH[3] * z + diffuseSPH[4] * z * x + diffuseSPH[5] * y * z + diffuseSPH[6] * y * x + diffuseSPH[7] * (3. * z * z - 1.) + diffuseSPH[8] * (x * x - y * y));\n  if(length(hdrHSV) > .0) {\n    bU = hsv_apply(bU, hdrHSV);\n  }\n  return max(bU, vec3(.0));\n}\nvec3 bV(const in float bq, const in vec3 bW) {\n  vec3 bX = bW;\n  float bY = prefilterMiplevel.x;\n  float bZ = min(bY, bq * prefilterMiplevel.y);\n  vec3 ca = textureCubeLod(prefilterMap, bX, bZ).rgb;\n  if(length(hdrHSV) > .0) {\n    return hsv_apply(ca, hdrHSV);\n  } else {\n    return ca;\n  }\n}\nvec3 cb(const in vec3 cc, const in vec3 bB, const in float bq, const in vec3 cd, const in vec3 bO) {\n  float ce = 1. - bq;\n  vec3 bW = mix(cc, reflect(-bB, cc), ce * (sqrt(ce) + bq));\n  float bl = clamp(1. + dot(bW, cd), .0, 1.);\n  vec3 cf = bV(bq, environmentTransform * bW) * bl * bl;\n  return cf;\n}\n#else\nvec3 cb(const in vec3 bm, const in vec3 cg, const in float bq, const in vec3 cd, const in vec3 bO) {\n  return ambientColor * bL(bO);\n}\n#endif\nvec3 ch(const in vec3 ci, const in float bq, const in float bD, const in float bx) {\n  vec4 rgba = texture2D(brdfLUT, vec2(bD, bq)) * vec4(255., 65280.0, 255., 65280.0);\n  float b = (rgba[3] + rgba[2]);\n  float a = (rgba[1] + rgba[0]);\n  return (ci * a + b * bx) / 65535.;\n}\nvec3 cj(const in vec3 bm, const in vec3 cg, const in float bD, const in float bq, const in vec3 bH, const in vec3 cd, const in float bx, const in vec3 bO) {\n  return cb(bm, cg, bq, cd, bO) * ch(bH, bq, bD, bx);\n}\nfloat ck(const in float cl, const in float bD) {\n  float bu = bD + cl;\n  return clamp(bu * bu - 1. + cl, .0, 1.);\n}\nvoid cm() {\n  \n#ifdef HAS_MAP\nvec2 f = computeTexCoord(vTexCoord);\n#endif\n#ifdef HAS_UV_FLIP\nf.y = 1. - f.y;\n#endif\n#if defined(HAS_BUMP_MAP) && defined(HAS_TANGENT)\nf = O(f, normalize(vTangentViewPos - vTangentFragPos));\n#endif\nc.albedo = baseColorIntensity * baseColorFactor.rgb;\n  c.alpha = baseColorFactor.a * vOpacity;\n#if defined(HAS_PATTERN)\nfloat cn = vLinesofar;\n  vec2 i = vTexInfo.zw;\n#ifdef HAS_PATTERN_GAP\nfloat co = vLinePatternGap;\n#else\nfloat co = linePatternGap;\n#endif\n#ifdef HAS_PATTERN_ANIM\nfloat cp = vLinePatternAnimSpeed;\n#else\nfloat cp = linePatternAnimSpeed;\n#endif\nfloat cq = ceil(i.x * vPatternHeight / i.y);\n  float cr = cq * (1. + co);\n  cp /= animSpeedScale;\n  cn += mod(currentTime * -cp * .2, cr);\n  float cs = mod(cn / cr, 1.);\n  float ct = mod(flipY * vNormalY, 1.);\n  vec2 f = d(vec2(cs * (1. + co) * uvScale[0], ct * uvScale[1]));\n  vec4 cu = texture2D(linePatternFile, f);\n  float cv = clamp(sign(1. / (1. + co) - cs) + .000001, .0, 1.);\n  cu = mix(linePatternGapColor, cu, cv);\n#ifdef IS_SQUARE_TUBE\nfloat n = clamp(sign(abs(vNormalY) - .999999), .0, 1.);\n  cu = mix(cu, vec4(1.), n);\n#endif\nc.albedo *= cu.rgb;\n  c.alpha *= cu.a;\n#endif\n#if defined(HAS_ALBEDO_MAP)\nvec4 cw = o(baseColorTexture, f);\n  c.albedo *= sRGBToLinear(cw.rgb);\n  c.alpha *= cw.a;\n#endif\n#if defined(HAS_SKIN_MAP)\nvec4 cx = o(skinTexture, f);\n  c.skinColor = cx;\n#endif\n#if defined(HAS_COLOR0)\nc.albedo *= vColor0.rgb;\n#if COLOR0_SIZE == 4\nc.alpha *= vColor0.a;\n#endif\n#endif\n#if defined(HAS_COLOR)\nc.albedo *= vColor.rgb;\n  c.alpha *= vColor.a;\n#elif defined(IS_LINE_EXTRUSION)\nc.albedo *= lineColor.rgb;\n  c.alpha *= lineColor.a;\n#else\nc.albedo *= polygonFill.rgb;\n  c.alpha *= polygonFill.a;\n#endif\n#if defined(HAS_INSTANCE_COLOR)\nc.albedo *= vInstanceColor.rgb;\n  c.alpha *= vInstanceColor.a;\n#endif\n#if defined(HAS_METALLICROUGHNESS_MAP)\nc.roughnessMetalness = o(metallicRoughnessTexture, f).gb * vec2(roughnessFactor, metallicFactor);\n#else\nc.roughnessMetalness = vec2(roughnessFactor, metallicFactor);\n#endif\nc.emit = emissiveFactor;\n#if defined(HAS_EMISSIVE_MAP)\nif(emitMultiplicative == 1) {\n    c.emit *= sRGBToLinear(o(emissiveTexture, f).rgb);\n  } else {\n    c.emit += sRGBToLinear(o(emissiveTexture, f).rgb);\n  }\n#endif\nc.emit *= emitColorFactor;\n#if defined(HAS_AO_MAP)\nvec2 cy = computeTexCoord(vTexCoord1);\n  c.ao = o(occlusionTexture, cy).r;\n#else\nc.ao = 1.;\n#endif\nc.ao *= occlusionFactor;\n#if defined(HAS_NORMAL_MAP) && defined(HAS_TANGENT)\nvec3 cz = o(normalTexture, f).xyz * 2. - 1.;\n  cz.y = normalMapFlipY == 1 ? -cz.y : cz.y;\n  c.normal = cz;\n#else\nc.normal = normalize(vModelNormal);\n#endif\n#if defined(HAS_TERRAIN_NORMAL) && defined(HAS_TANGENT)\nvec3 cz = convertTerrainHeightToNormalMap(f);\n  cz.y = normalMapFlipY == 1 ? -cz.y : cz.y;\n  c.normal = cz;\n#endif\n#if defined(SHADING_MODEL_SPECULAR_GLOSSINESS)\nc.albedo *= diffuseFactor.rgb;\n  c.alpha *= diffuseFactor.a;\n#if defined(HAS_DIFFUSE_MAP)\nvec4 cA = o(diffuseTexture, f);\n  c.albedo *= sRGBToLinear(cA.rgb);\n  c.alpha *= cA.a;\n#endif\nc.specularColor = specularFactor;\n  c.glossiness = glossinessFactor;\n#if defined(HAS_SPECULARGLOSSINESS_MAP)\nvec4 cB = o(specularGlossinessTexture, f);\n  c.specularColor *= sRGBToLinear(cB.rgb);\n  c.glossiness *= cB.a;\n#endif\n#endif\n}\nvec3 cC(const vec3 x) {\n  const float a = 2.51;\n  const float b = .03;\n  const float cD = 2.43;\n  const float bu = .59;\n  const float cE = .14;\n  return (x * (a * x + b)) / (x * (cD * x + bu) + cE);\n}\nvec3 cF(vec3 cG) {\n  cG = cC(cG);\n  return cG = pow(cG, vec3(1. / 2.2));\n}\nuniform float specularAAVariance;\nuniform float specularAAThreshold;\nfloat cH(float bq, const vec3 cI) {\n  \n#if defined(GL_OES_standard_derivatives) || __VERSION__ == 300\nvec3 cJ = dFdx(cI);\n  vec3 cK = dFdy(cI);\n  float cL = specularAAVariance * (dot(cJ, cJ) + dot(cK, cK));\n  float cM = min(2. * cL, specularAAThreshold);\n  float cN = saturate(bq * bq + cM);\n  return sqrt(cN);\n#else\nreturn bq;\n#endif\n}\n#ifdef HAS_SSR\nuniform sampler2D TextureDepth;\nuniform highp vec2 outSize;\nuniform float ssrFactor;\nuniform float ssrQuality;\nuniform sampler2D TextureReflected;\nuniform highp mat4 projMatrix;\nuniform mat4 invProjMatrix;\nuniform vec4 outputFovInfo[2];\nuniform mat4 reprojViewProjMatrix;\nvec3 cO(const in mat4 cP, const in vec3 cQ) {\n  vec4 cR = cP * vec4(cQ, 1.);\n  return vec3(.5 + .5 * cR.xy / cR.w, cR.w);\n}\nvec3 cS(const in float cT, const in vec2 f) {\n  return texture2D(TextureReflected, f).rgb;\n}\nfloat cU(float cV) {\n  highp mat4 cP = projMatrix;\n  highp float z = cV * 2. - 1.;\n  return -cP[3].z / (z + cP[2].z);\n}\nfloat cW(const vec2 f) {\n  float cV = bi(texture2D(TextureDepth, f));\n  return cV;\n}\nfloat cX(const in vec2 cY, const in float cZ) {\n  vec3 da = vec3(.06711056, .00583715, 52.9829189);\n  return fract(da.z * fract(dot(cY.xy + cZ * vec2(47., 17.) * .695, da.xy))) * .5;\n}\nvec3 db(const in float cZ, const in vec3 dc, const in vec3 dd, const in vec3 de, const in vec3 cg, const in float df) {\n  vec2 dg;\n  dg.x = cX(gl_FragCoord.yx, cZ);\n  dg.y = fract(dg.x * 52.9829189);\n  dg.y = mix(dg.y, 1., .7);\n  float dh = 2. * 3.14159 * dg.x;\n  float di = pow(max(dg.y, .000001), df / (2. - df));\n  float dj = sqrt(1. - di * di);\n  vec3 dk = vec3(dj * cos(dh), dj * sin(dh), di);\n  dk = dk.x * dc + dk.y * dd + dk.z * de;\n  return normalize((2. * dot(cg, dk)) * dk - cg);\n}\nfloat dl(const in float cZ) {\n  return (cX(gl_FragCoord.xy, cZ) - .5);\n}\nvec3 dm(const in vec3 dn, const in float dp, const in vec3 dq) {\n  vec3 dr = cO(projMatrix, vViewVertex.xyz + dq * dp);\n  dr.z = 1. / dr.z;\n  dr -= dn;\n  float ds = min(1., .99 * (1. - dn.x) / max(1e-5, dr.x));\n  float dt = min(1., .99 * (1. - dn.y) / max(1e-5, dr.y));\n  float dw = min(1., .99 * dn.x / max(1e-5, -dr.x));\n  float dx = min(1., .99 * dn.y / max(1e-5, -dr.y));\n  return dr * min(ds, dt) * min(dw, dx);\n}\nfloat dy(const in vec3 dn, const in vec3 dr, inout float dz, inout float dA) {\n  float dB = (dA + dz) * .5;\n  vec3 dC = dn + dr * dB;\n  float z = cW(dC.xy);\n  float cV = cU(z);\n  float dD = -1. / dC.z;\n  dz = cV > dD ? dz : dB;\n  dA = cV > dD ? dB : dA;\n  return dB;\n}\nvec4 dE(const in vec3 dn, const in float dp, in float dF, const in vec3 dq, const in float bq, const in float cZ) {\n  int dG = 20;\n  float dH = 1. / float(dG);\n  dF *= dH;\n  vec3 dr = dm(dn, dp, dq);\n  float dI = dH;\n  vec3 dJ = vec3(.0, dI, 1.);\n  vec3 dC;\n  float z, cV, dD, dK, dL, dM;\n  bool dN;\n  float dO = 1.;\n  float dB;\n  for(int W = 0; W < dG; W++) {\n    dC = dn + dr * dJ.y;\n    z = cW(dC.xy);\n    cV = cU(z);\n    dD = -1. / dC.z;\n    float dP = clamp(sign(.999 - z), .0, 1.);\n    dK = dP * (dD - cV);\n    dK *= clamp(sign(abs(dK) - dp * dH * dH), .0, 1.);\n    dN = abs(dK + dF) < dF;\n    dL = clamp(dJ.x / (dJ.x - dK), .0, 1.);\n    dM = dN ? dJ.y + dL * dH - dH : 1.;\n    dJ.z = min(dJ.z, dM);\n    dJ.x = dK;\n    if(dN) {\n      float dz = dJ.y - dH;\n      float dA = dJ.y;\n      dB = dy(dn, dr, dz, dA);\n      dB = dy(dn, dr, dz, dA);\n      dB = dy(dn, dr, dz, dA);\n      dO = dB;\n      break;\n    }\n    dJ.y += dH;\n  }\n  return vec4(dn + dr * dO, 1. - dO);\n}\nvec4 dQ(in vec4 dR, const in float dS, const in vec3 dT, const in vec3 dU, const in float bq) {\n  vec4 dV = mix(outputFovInfo[0], outputFovInfo[1], dR.x);\n  dR.xyz = vec3(mix(dV.xy, dV.zw, dR.y), 1.) * -1. / dR.z;\n  dR.xyz = (reprojViewProjMatrix * vec4(dR.xyz, 1.)).xyw;\n  dR.xy /= dR.z;\n  float dW = clamp(6. - 6. * max(abs(dR.x), abs(dR.y)), .0, 1.);\n  dR.xy = .5 + .5 * dR.xy;\n  vec3 dX = dU * cS(bq * (1. - dR.w), dR.xy);\n  return vec4(mix(dT, dX, dS * dW), 1.);\n}\nvec3 ssr(const in vec3 dT, const in vec3 dU, const in float bq, const in vec3 bm, const in vec3 cg) {\n  float dY = .0;\n  vec4 bU = vec4(.0);\n  float df = bq * bq;\n  df = df * df;\n  vec3 dZ = abs(bm.z) < .999 ? vec3(.0, .0, 1.) : vec3(1., .0, .0);\n  vec3 dc = normalize(cross(dZ, bm));\n  vec3 dd = cross(bm, dc);\n  float dS = ssrFactor * clamp(-4. * dot(cg, bm) + 3.8, .0, 1.);\n  dS *= clamp(4.7 - bq * 5., .0, 1.);\n  vec3 dn = cO(projMatrix, vViewVertex.xyz);\n  dn.z = 1. / dn.z;\n  vec3 dq = db(dY, dc, dd, bm, cg, df);\n  float dp = mix(cameraNearFar.y + vViewVertex.z, -vViewVertex.z - cameraNearFar.x, dq.z * .5 + .5);\n  float dF = .5 * dp;\n  vec4 dR;\n  if(dot(dq, bm) > .001 && dS > .0) {\n    dR = dE(dn, dp, dF, dq, bq, dY);\n    if(dR.w > .0)\n      bU += dQ(dR, dS, dT, dU, bq);\n    \n  }\n  return bU.w > .0 ? bU.rgb / bU.w : dT;\n}\n#endif\n#include <highlight_frag>\nvec4 ea(in vec4 eb) {\n  return vec4(mix(pow(eb.rgb, vec3(.41666)) * 1.055 - vec3(.055), eb.rgb * 12.92, vec3(lessThanEqual(eb.rgb, vec3(.0031308)))), eb.a);\n}\nvec4 ec(vec4 eb) {\n  return (ea(eb));\n}\nvoid main() {\n  cm();\n  vec3 cg = normalize(cameraPosition - vModelVertex.xyz);\n#if defined(HAS_DOUBLE_SIDE)\nvec3 cd = gl_FrontFacing ? normalize(vModelNormal) : -normalize(vModelNormal);\n#else\nvec3 cd = normalize(vModelNormal);\n#endif\n#if defined(HAS_TANGENT)\nvec4 ed;\n  ed = vModelTangent;\n#if defined(HAS_DOUBLE_SIDE)\ned.xyz = gl_FrontFacing ? normalize(ed.xyz) : -normalize(ed.xyz);\n#else\ned.xyz = normalize(ed.xyz);\n#endif\nvec3 ee = normalize(vModelBiTangent);\n#endif\nfloat bw = .08 * specularF0;\n  float ef = bc();\n  vec3 bO = ba();\n#if defined(SHADING_MODEL_SPECULAR_GLOSSINESS)\nvec3 eg = c.specularColor;\n#else\nvec3 eg = mix(vec3(bw), bO, ef);\n#endif\nbO *= 1. - ef;\n  float eh = clamp(50.0 * eg.g, .0, 1.);\n  float ei = bd();\n  if(specularAAVariance > .0) {\n    ei = cH(ei, cd);\n  }\n  vec3 ej = be();\n  vec3 ek = bg();\n  vec3 el = vec3(ek);\n#if defined(HAS_TANGENT) && (defined(HAS_NORMAL_MAP) || defined(HAS_TERRAIN_NORMAL))\nel = bk(normalMapFactor, el, ed.xyz, ee, cd);\n#endif\nvec3 cA = vec3(.0);\n  vec3 bH = vec3(.0);\n#if defined(HAS_IBL_LIGHTING)\ncA = bO * bT(el) * .5;\n#else\ncA = bO * ambientColor;\n#endif\nfloat bD = dot(el, cg);\n  bH = cj(el, cg, bD, ei, eg, cd, eh, bO);\n  float em;\n  float en = 1.;\n  float eo = bh();\n  cA *= environmentExposure * eo;\n#ifdef HAS_IBL_LIGHTING\nen = ck(eo, bD);\n#endif\n#ifdef HAS_SSR\nvec3 ep = normalize(gl_FrontFacing ? vViewNormal : -vViewNormal);\n  vec3 eq = ep;\n#if defined(HAS_TANGENT) && (defined(HAS_NORMAL_MAP) || defined(HAS_TERRAIN_NORMAL))\nvec4 er;\n  er = vViewTangent;\n  er = gl_FrontFacing ? er : -er;\n  er.xyz = normalize(er.xyz);\n  vec3 es = normalize(cross(ep, er.xyz)) * er.w;\n  eq = bk(normalMapFactor, ek, er.xyz, es, ep);\n#endif\nbH = ssr(bH, eg * en, ei, eq, -normalize(vViewVertex.xyz));\n#endif\nbH *= environmentExposure * en;\n  vec3 et, eu;\n  vec3 ev = vModelNormal;\n  vec3 ew = -light0_viewDirection;\n  float ex = saturate(dot(ew, el));\n  bN(el, cg, ex, max(.045, ei), bO, eg, light0_diffuse.rgb, ew, eh, eu, et);\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nfloat ey = shadow_computeShadow();\n  eu = shadow_blend(eu, ey).rgb;\n  et = shadow_blend(et, ey).rgb;\n#endif\ncA += eu;\n  bH += et;\n  cA += ej;\n  vec3 ez = bH + cA;\n  if(outputSRGB == 1)\n    ez = linearTosRGB(ez);\n  \n#ifdef HAS_SKIN_MAP\nvec4 eA = bf();\n  ez.rgb = ez.rgb * (1. - eA.a) + eA.rgb * eA.a;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nez.rgb = shadow_blend(ez.rgb, ey).rgb;\n#endif\n#endif\nfloat eB = bb();\n  if(eB < alphaTest) {\n    discard;\n  }\n#if defined(ALPHA_MODE)\n#if ALPHA_MODE == 1\nif(eB < alphaCutoff) {\n    discard;\n  } else {\n    eB = 1.;\n  }\n#else\neB = 1.;\n#endif\n#endif\n#if defined(IS_LINE_EXTRUSION)\neB *= lineOpacity;\n#else\neB *= polygonOpacity;\n#endif\nglFragColor = vec4(ez * eB, eB);\n#ifdef HAS_VERTEX_COLOR\nglFragColor *= vertexColor_get();\n#endif\n#ifdef HAS_EXCAVATE_ANALYSIS\nglFragColor = excavateColor(glFragColor);\n#endif\n#ifdef HAS_HEATMAP\nglFragColor = heatmap_getColor(glFragColor);\n#endif\n#ifdef HAS_SNOW\nglFragColor.rgb = snow(glFragColor, bg(), 1.);\n#endif\nif(contrast != 1.) {\n    glFragColor = contrastMatrix(contrast) * glFragColor;\n  }\n  if(length(hsv) > .0) {\n    glFragColor = hsv_apply(glFragColor, hsv);\n  }\n#ifdef OUTPUT_NORMAL\nglFragColor = vec4(cd, 1.);\n#endif\nglFragColor = highlight_blendColor(glFragColor);\n#ifdef HAS_LAYER_OPACITY\nglFragColor *= layerOpacity;\n#endif\n#ifdef HAS_MASK_EXTENT\nglFragColor = setMask(glFragColor);\n#endif\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:c,extraCommandProps:e,defines:i}),this.version=300}getGeometryDefines(t){const e={};return t.data[t.desc.tangentAttribute]?e.HAS_TANGENT=1:t.data[t.desc.normalAttribute]&&(e.HAS_NORMAL=1),t.data[t.desc.colorAttribute]&&(e.HAS_COLOR=1),t.data[t.desc.color0Attribute]&&(e.HAS_COLOR0=1,e.COLOR0_SIZE=t.getColor0Size()),e}},StandardDepthShader:class extends zw{constructor(t={}){const e=[];super({vert:"#define SHADER_NAME depth_vert\nprecision highp float;\nattribute vec3 aPosition;\n#include <line_extrusion_vert>\nuniform mat4 modelViewMatrix;\nuniform mat4 positionMatrix;\nuniform mat4 projMatrix;\nuniform vec2 outSize;\nuniform vec2 halton;\n#include <get_output>\nvoid main() {\n  mat4 c = getPositionMatrix();\n#ifdef IS_LINE_EXTRUSION\nvec4 d = getPosition(getLineExtrudePosition(aPosition));\n#else\nvec4 d = getPosition(aPosition);\n#endif\nvec4 e = modelViewMatrix * c * d;\n  mat4 f = projMatrix;\n  f[2].xy += halton.xy / outSize.xy;\n  gl_Position = f * e;\n}",frag:"#define SHADER_NAME depth_frag\nprecision highp float;\nvoid main() {\n  gl_FragColor = vec4(1., .0, .0, 1.);\n}",uniforms:[{name:"modelViewMatrix",type:"function",fn:(t,n)=>cy(e,n.viewMatrix,n.modelMatrix)}],extraCommandProps:t.extraCommandProps,defines:t.defines})}},PBRUtils:wM},bC=function(t,e,n=2){const i=e&&e.length,o=i?e[0]*n:t.length;let s=JM(t,0,o,n,!0);const a=[];if(!s||s.next===s.prev)return a;let l,h,c;if(i&&(s=function(t,e,n,i){const o=[];for(let n=0,s=e.length;n<s;n++){const a=JM(t,e[n]*i,n<s-1?e[n+1]*i:t.length,i,!1);a===a.next&&(a.steiner=!0),o.push(sC(a))}o.sort(nC);for(let t=0;t<o.length;t++)n=iC(o[t],n);return n}(t,e,s,n)),t.length>80*n){l=1/0,h=1/0;let e=-1/0,i=-1/0;for(let s=n;s<o;s+=n){const n=t[s],o=t[s+1];n<l&&(l=n),o<h&&(h=o),n>e&&(e=n),o>i&&(i=o)}c=Math.max(e-l,i-h),c=0!==c?32767/c:0}return YM(s,a,n,l,h,c,0),a};bC.flatten=function(t){const e=[],n=[],i=t[0][0].length;let o=0,s=0;for(const a of t){for(const t of a)for(let n=0;n<i;n++)e.push(t[n]);s&&(o+=s,n.push(o)),s=a.length}return{vertices:e,holes:n,dimensions:i}};var wC=Object.freeze({__proto__:null,AbstractTexture:cb,BloomPass:$w,BoundingBox:db,BoxBlurShader:class wt extends Ww{constructor({blurOffset:t}){super({vert:jw,frag:"precision highp float;\nvarying vec2 vTexCoord;\nuniform sampler2D textureSource;\nuniform vec2 resolution;\nuniform float ignoreTransparent;\nvoid main() {\n  vec4 c = vec4(.0);\n  float d = .0;\n  for(int x = -BOXBLUR_OFFSET; x <= BOXBLUR_OFFSET; ++x)\n    for(int y = -BOXBLUR_OFFSET; y <= BOXBLUR_OFFSET; ++y) {\n      vec2 e = vTexCoord.st + vec2(float(x) / resolution.x, float(y) / resolution.y);\n      e = clamp(e, .0, 1.);\n      vec4 f = texture2D(textureSource, e);\n      float h;\n      if(ignoreTransparent == 1.) {\n        h = sign(f.a);\n      } else {\n        h = 1.;\n      }\n      d += h;\n      c += h * f;\n    }\n  gl_FragColor = c / max(d, 1.) * clamp(sign(d - 1.), .0, 1.);\n}",defines:{BOXBLUR_OFFSET:t||2},extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.resolution[0],height:(t,e)=>e.resolution[1]}}}),this._blurOffset=t||2}getMeshCommand(t,e){const n="box_blur_"+this._blurOffset;return this.commands[n]||(this.commands[n]=this.createREGLCommand(t,null,e.getElements())),this.commands[n]}},Constants:ab,CopyShader:aT,EdgeGeometry:Zb,EdgeShader:lT,ExtentPass:TT,FBORayPicking:zM,FogPass:dT,FogShader:gT,FxaaShader:Zw,GLTFHelper:qT,GLTFManager:tM,Geometry:vb,HDR:vC,HeatmapDisplayShader:sT,HeatmapShader:nT,InstancedMesh:lw,Jitter:Yw,KHRTechniquesWebglManager:XM,Material:Qb,Mesh:aw,MeshShader:zw,PhongMaterial:$b,PhongShader:Gw,PhongSpecularGlossinessMaterial:rw,Plane:Ow,PointLineShader:class Tt extends zw{constructor(t={}){const e=[];super({vert:"attribute vec3 aPosition;\n#ifdef HAS_COLOR0\nattribute vec4 aColor0;\nvarying vec4 vColor;\n#endif\nuniform mat4 modelMatrix;\nuniform mat4 projMatrix;\nuniform mat4 positionMatrix;\nuniform mat4 projViewModelMatrix;\nuniform float pointSize;\n#if defined(HAS_MAP)\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\n#endif\n#include <get_output>\n#include <heatmap_render_vert>\n#ifdef HAS_FLOODANALYSE\nvarying float vHeight;\n#endif\nvoid main() {\n  vec4 c = getPosition(aPosition);\n  mat4 d = getPositionMatrix();\n  gl_PointSize = pointSize;\n#ifdef HAS_MASK_EXTENT\ngl_Position = projMatrix * getMaskPosition(d * c, modelMatrix);\n#else\ngl_Position = projViewModelMatrix * d * c;\n#endif\n#ifdef HAS_COLOR0\nvColor = aColor0 / 255.;\n#endif\n#ifdef HAS_MAP\nvTexCoord = aTexCoord;\n#endif\n#ifdef HAS_HEATMAP\nheatmap_compute(projMatrix * modelViewMatrix * d, c);\n#endif\n}",frag:"precision mediump float;\n#include <gl2_frag>\n#if defined(HAS_COLOR0)\nvarying vec4 vColor;\n#endif\n#include <heatmap_render_frag>\nuniform vec4 baseColorFactor;\n#if defined(HAS_MAP)\n#if defined(HAS_ALBEDO_MAP)\nuniform sampler2D baseColorTexture;\n#endif\n#if defined(HAS_DIFFUSE_MAP)\nuniform sampler2D diffuseTexture;\n#endif\nvarying vec2 vTexCoord;\n#endif\n#include <mask_frag>\nvoid main() {\n  \n#ifdef HAS_COLOR0\nglFragColor = vColor * baseColorFactor;\n#else\nglFragColor = vec4(1.) * baseColorFactor;\n#endif\n#ifdef HAS_MAP\n#ifdef HAS_ALBEDO_MAP\nglFragColor *= texture2D(baseColorTexture, vTexCoord);\n#endif\n#ifdef HAS_DIFFUSE_MAP\nglFragColor *= texture2D(diffuseTexture, vTexCoord);\n#endif\n#endif\n#ifdef HAS_HEATMAP\nglFragColor = heatmap_getColor(glFragColor);\n#endif\n#ifdef HAS_MASK_EXTENT\nglFragColor = setMask(glFragColor);\n#endif\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:[{name:"projViewModelMatrix",type:"function",fn:(t,n)=>cy(e,n.projViewMatrix,n.modelMatrix)}],defines:t.defines||{},extraCommandProps:t.extraCommandProps||{}})}},PostProcessShader:qw,QuadShader:Ww,REGLHelper:Hb,RainRipplesPass:xT,Renderer:cw,ResourceLoader:dw,ScanEffectPass:CT,ScanEffectShader:uT,Scene:_w,Shader:Hw,ShaderLib:kw,ShadowDisplayShader:IM,ShadowMapShader:TM,ShadowPass:PM,SkyboxShader:oT,SsrPass:eT,StandardLiteMaterial:ew,StandardLiteShader:class Yt extends zw{constructor(t={}){const e=[],n=t.uniforms,i=[{name:"viewMatrixInverse",type:"function",fn:(t,e)=>hy(hT,e.viewMatrix)},{name:"modelViewMatrix",type:"function",fn:function(t,n){return cy(e,n.viewMatrix,n.modelMatrix)}},{name:"environmentTransform",type:"function",fn:(t,e)=>ey(cT,Math.PI*(e.environmentOrientation||0)/180)}];n&&i.push(...n),super({vert:"precision mediump float;\n#include <gl2_vert>\nattribute vec3 aPosition;\n#include <line_extrusion_vert>\n#ifdef HAS_MAP\nuniform vec2 uvScale;\nuniform vec2 uvOffset;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\n#ifdef HAS_I3S_UVREGION\nattribute vec4 uvRegion;\nvarying vec4 vUvRegion;\n#endif\n#endif\n#if defined(HAS_COLOR)\nattribute vec4 aColor;\n#elif defined(HAS_COLOR0)\n#if COLOR0_SIZE == 3\nattribute vec3 aColor0;\n#else\nattribute vec4 aColor0;\n#endif\nvarying vec4 vColor;\n#endif\nuniform mat4 projMatrix;\nuniform mat3 modelNormalMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 positionMatrix;\nuniform vec2 halton;\nuniform vec2 outSize;\nuniform mat4 projViewMatrix;\n#include <get_output>\n#include <heatmap_render_vert>\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_vert>\n#endif\nvarying vec3 vViewPosition;\nvoid main() {\n  \n#ifdef IS_LINE_EXTRUSION\nvec4 c = getPosition(getLineExtrudePosition(aPosition));\n#else\nvec4 c = getPosition(aPosition);\n#endif\nmat4 d = getPositionMatrix();\n  mat4 e = projMatrix;\n  e[2].xy += halton.xy / outSize.xy;\n#ifdef HAS_MASK_EXTENT\ngl_Position = e * getMaskPosition(d * c, modelMatrix);\n#else\ngl_Position = e * modelViewMatrix * d * c;\n#endif\nvec4 f = modelViewMatrix * d * c;\n  vViewPosition = -f.xyz;\n#ifdef HAS_MAP\nvec2 h = decode_getTexcoord(aTexCoord);\n  vTexCoord = h * uvScale + uvOffset;\n#endif\n#if defined(HAS_COLOR)\nvColor = aColor / 255.;\n#elif defined(HAS_COLOR0)\n#if COLOR0_SIZE == 3\nvColor = vec4(aColor0 / 255., 1.);\n#else\nvColor = aColor0 / 255.;\n#endif\n#endif\n}",frag:"#if __VERSION__ == 100\n#if defined(GL_EXT_shader_texture_lod)\n#extension GL_EXT_shader_texture_lod : enable\n#define textureCubeLod(tex, uv, lod) textureCubeLodEXT(tex, uv, lod)\n#else\n#define textureCubeLod(tex, uv, lod) textureCube(tex, uv, lod)\n#endif\n#if defined(GL_OES_standard_derivatives)\n#extension GL_OES_standard_derivatives : enable\n#endif\n#else\n#define textureCubeLod(tex, uv, lod) textureLod(tex, uv, lod)\n#endif\n#define saturate(x)        clamp(x, 0.0, 1.0)\nprecision mediump float;\n#include <gl2_frag>\n#include <hsv_frag>\nuniform vec3 hsv;\n#define GET_BASEMAP(UV) (texture2D(baseColorTexture, (UV)))\nuniform mat4 viewMatrix;\nuniform mat4 projMatrix;\nuniform vec3 cameraPosition;\n#if defined(HAS_IBL_LIGHTING)\nuniform mat4 viewMatrixInverse;\n#endif\nuniform vec4 baseColorFactor;\nuniform vec3 emissiveFactor;\nuniform vec3 specularFactor;\nuniform float opacity;\nuniform float envRotationSin;\nuniform float envRotationCos;\nuniform float rgbmRange;\n#if defined(HAS_MAP)\n#include <computeTexcoord_frag>\n#endif\n#ifdef HAS_BASECOLOR_MAP\nuniform sampler2D baseColorTexture;\n#endif\n#ifdef HAS_NORMAL_MAP\nuniform sampler2D normalTexture;\nvec3 c(vec3 d, vec3 e) {\n  vec3 f = dFdx(d.xyz);\n  vec3 h = dFdy(d.xyz);\n  vec3 i = normalize(f - h);\n  vec3 j = normalize(-f + h);\n  vec3 k = normalize(e);\n  vec3 l = texture2D(normalTexture, computeTexCoord(vTexCoord)).rgb * 2. - 1.;\n  mat3 m = mat3(i, j, k);\n  return normalize(m * l);\n}\n#endif\n#ifdef HAS_EMISSIVE_MAP\nuniform sampler2D emissiveTexture;\n#endif\n#ifdef SHADING_MODEL_SPECULAR_GLOSSINESS\nuniform vec4 diffuseFactor;\n#ifdef HAS_DIFFUSE_MAP\nuniform sampler2D diffuseTexture;\n#endif\n#ifdef HAS_SPECULARGLOSSINESS_MAP\nuniform sampler2D specularGlossinessTexture;\n#endif\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_frag>\n#endif\n#if defined(HAS_COLOR) || defined(HAS_COLOR0)\nvarying vec4 vColor;\n#endif\n#ifdef GAMMA_INPUT\nvec3 n(vec3 o) {\n  return o * o;\n}\nfloat n(float o) {\n  return o * o;\n}\n#else\nvec3 n(vec3 o) {\n  return o;\n}\nfloat n(float o) {\n  return o;\n}\n#endif\nvec3 u() {\n  \n#ifdef SHADING_MODEL_SPECULAR_GLOSSINESS\n#ifdef HAS_SPECULARGLOSSINESS_MAP\nreturn texture2D(specularGlossinessTexture, computeTexCoord(vTexCoord)).rgb;\n#else\nreturn specularFactor;\n#endif\n#else\nreturn specularFactor;\n#endif\n}\nvec3 v() {\n  \n#ifdef HAS_EMISSIVE_MAP\nreturn texture2D(emissiveTexture, computeTexCoord(vTexCoord)).rgb;\n#else\nreturn emissiveFactor;\n#endif\n}\n#if defined(TONEMAP_OUTPUT)\n#if TONEMAP_OUTPUT > 0\nuniform float exposureBias;\nfloat A(vec3 rgb) {\n  return dot(rgb, vec3(.299, .587, .114));\n}\nfloat B(vec3 rgb) {\n  return dot(rgb, vec3(.212671, .715160, .072169));\n}\nvec3 C(vec3 xyz) {\n  vec3 D = vec3(3.240479, -1.53715, -.498535);\n  vec3 E = vec3(-.969256, 1.875992, .041556);\n  vec3 F = vec3(.055648, -.204043, 1.057311);\n  vec3 rgb;\n  rgb.b = dot(xyz, F);\n  rgb.g = dot(xyz, E);\n  rgb.r = dot(xyz, D);\n  return rgb;\n}\nvec3 H(vec3 rgb) {\n  vec3 I = vec3(.412453, .35758, .180423);\n  vec3 J = vec3(.212671, .71516, .0721688);\n  vec3 K = vec3(.0193338, .119194, .950227);\n  vec3 xyz;\n  xyz.x = dot(rgb, I);\n  xyz.y = dot(rgb, J);\n  xyz.z = dot(rgb, K);\n  return xyz;\n}\nvec3 L(vec3 xyz) {\n  float M = xyz.x + xyz.y + xyz.z;\n  M = 1. / M;\n  vec3 O;\n  O.z = xyz.y;\n  O.x = xyz.x * M;\n  O.y = xyz.y * M;\n  return O;\n}\nvec3 P(vec3 O) {\n  float x = O.x;\n  float y = O.y;\n  float J = O.z;\n  vec3 xyz;\n  xyz.y = J;\n  xyz.x = x * (J / y);\n  xyz.z = (1. - x - y) * (J / y);\n  return xyz;\n}\nfloat Q(float x) {\n  float U = pow(x, 1.60525727);\n  float V = ((1.05542877 * 4.68037409) * U) / (4.68037409 * U + 1.);\n  return clamp(V, .0, 1.);\n}\nconst float W = 1. / .18;\nfloat ba(float x) {\n  x *= W;\n  const float bb = .2;\n  const float F = .34;\n  const float bc = .002;\n  const float bd = 1.68;\n  const float be = .0005;\n  const float bf = .252;\n  const float bg = 1. / .833837;\n  return ((x * (bb * x + bc * F) + bd * be) / (x * (bb * x + F) + bd * bf) - be / bf) * bg;\n}\nvec3 bh(vec3 x) {\n  x *= W;\n  const float bb = .27;\n  const float F = .29;\n  const float bc = .052;\n  const float bd = .2;\n  const float bf = .18;\n  const float bg = 1. / .897105;\n  return ((x * (bb * x + bc * F)) / (x * (bb * x + F) + bd * bf)) * bg;\n}\nvec3 bi(vec3 x) {\n  vec3 bj = x.rgb;\n  bj = min(bj, vec3(3.));\n  float bk = B(bj);\n  if(bk > .0) {\n    float bl = Q(bk);\n    bj = bj * (bl / bk);\n    bj = clamp(bj, vec3(.0), vec3(1.));\n  }\n  float bm = 1. / 2.2;\n  bj = pow(bj, vec3(bm));\n  return bj;\n}\n#endif\n#endif\n#if defined(IRR_RGBM) || defined(ENV_RGBM) || defined(ENV_GAMMA) || defined(IRR_GAMMA)\nuniform float envMapExposure;\n#endif\nuniform vec4 themingColor;\nuniform mat3 environmentTransform;\nvec3 bn(vec3 bo, vec3 bp) {\n  \n#if defined(HAS_SHADOWMAP)\nfloat bq = dot(shadowLightDir, bp);\n  float br = (bq + 1.) / 2.;\n  br = min(1., br * 1.5);\n  float bs = 1.;\n  vec3 bt = bo * min(bs, br);\n  return bt;\n#else\nreturn bo;\n#endif\n}\n#ifdef HAS_IBL_LIGHTING\nuniform float reflectivity;\nuniform vec3 hdrHSV;\nuniform samplerCube prefilterMap;\nuniform vec3 diffuseSPH[9];\nuniform vec2 prefilterMiplevel;\nuniform vec2 prefilterSize;\n#else\nuniform vec3 ambientColor;\n#endif\n#if defined(HAS_IBL_LIGHTING)\nvec3 bu(const in vec3 bv) {\n  vec3 bw = environmentTransform * bv;\n  float x = bw.x;\n  float y = bw.y;\n  float z = bw.z;\n  vec3 bt = (diffuseSPH[0] + diffuseSPH[1] * x + diffuseSPH[2] * y + diffuseSPH[3] * z + diffuseSPH[4] * z * x + diffuseSPH[5] * y * z + diffuseSPH[6] * y * x + diffuseSPH[7] * (3. * z * z - 1.) + diffuseSPH[8] * (x * x - y * y));\n  if(length(hdrHSV) > .0) {\n    bt = hsv_apply(bt, hdrHSV);\n  }\n  return max(bt, vec3(.0));\n}\nvec3 bx(const in vec4 by, const in float bz) {\n  if(bz <= .0)\n    return by.rgb;\n  return bz * by.rgb * by.a;\n}\nfloat bA(const in float bB) {\n  return bB;\n}\nvec3 bC(const in float bD, const in vec3 D) {\n  vec3 bE = D;\n  float bF = prefilterMiplevel.x;\n  float bG = min(bF, bA(bD) * prefilterMiplevel.y);\n  vec3 bH = bx(textureCubeLod(prefilterMap, bE, bG), rgbmRange);\n  if(length(hdrHSV) > .0) {\n    return hsv_apply(bH, hdrHSV);\n  } else {\n    return bH;\n  }\n}\nvec3 bI(const in vec3 k, const in vec3 D, const in float bJ) {\n  float bK = 1. - bJ;\n  float bL = bK * (sqrt(bK) + bJ);\n  return mix(k, D, bL);\n}\nvec3 bM(const in vec3 bv, const in vec3 bN, const in float bO, const in vec3 bP) {\n  vec3 D = reflect(-bN, bv);\n  D = bI(bv, D, bO);\n  vec3 bQ = bC(bO, environmentTransform * D);\n  float bR = clamp(1. + dot(D, bP), .0, 1.);\n  bQ *= bR * bR;\n  return bQ;\n}\n#else\nvec3 bM(const in vec3 bv, const in vec3 bN, const in float bO, const in vec3 bP) {\n  return ambientColor;\n}\n#endif\nvarying highp vec3 vViewPosition;\nvec3 bS(vec3 bT, float bU) {\n  float bV = max(1. - bU, .0);\n  return bT + (1. - bT) * pow(bV, 5.);\n}\nfloat bW(float bT, float bU) {\n  float bV = max(1. - bU, .0);\n  return bT + (1. - bT) * pow(bV, 5.);\n}\n#include <srgb_frag>\nvoid main() {\n  glFragColor = vec4(vec3(1.), opacity);\n#ifdef HAS_BASECOLOR_MAP\nvec4 bX = GET_BASEMAP(computeTexCoord(vTexCoord));\n#ifdef GAMMA_INPUT\nbX.xyz *= bX.xyz;\n#endif\nglFragColor = glFragColor * bX;\n#endif\n#ifdef ALPHATEST\nif(glFragColor.a < ALPHATEST)\n    discard;\n  \n#endif\nfloat bY = 1.;\n  vec3 bZ = dFdx(vViewPosition);\n  vec3 ca = dFdy(vViewPosition);\n  vec3 bv = normalize(cross(bZ, ca));\n  vec3 cb;\n  if(projMatrix[3][3] == .0) {\n    cb = normalize(vViewPosition);\n  } else {\n    cb = vec3(.0, .0, 1.);\n  }\n  bv = faceforward(bv, -cb, bv);\n  vec3 cc = bv;\n#ifdef HAS_NORMAL_MAP\nbv = c(-vViewPosition, bv);\n#endif\nvec3 cd = vec3(.0);\n  vec3 ce = vec3(.0);\n#ifdef HAS_IBL_LIGHTING\nvec3 bp = mat3(viewMatrixInverse) * bv;\n  vec3 cf = glFragColor.rgb * bu(bp) * .5;\n  cf = bn(cf, bp);\n  cd += n(baseColorFactor.rgb) * cf;\n#endif\nvec3 cg = v();\n#ifdef METAL\nglFragColor.xyz = glFragColor.xyz * (n(cg) + cd + n(baseColorFactor.rgb) + ce);\n#else\nglFragColor.xyz = glFragColor.xyz * (n(cg) + cd + n(baseColorFactor.rgb)) + ce;\n#endif\nvec3 ch;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nfloat ci = shadow_computeShadow();\n  ch = shadow_blend(ch, ci).rgb;\n#endif\n#ifdef HAS_COLOR\nglFragColor = glFragColor * vColor;\n#endif\nglFragColor.rgb += ch;\n  glFragColor.rgb = linearTosRGB(glFragColor.rgb);\n#if defined(HAS_IBL_LIGHTING)\nvec3 cj;\n#if defined(HAS_NORMAL_MAP)\n#ifdef ENVMAP_MODE_REFLECTION\ncj = reflect(-cb, bv);\n#else\ncj = refract(-cb, bv, 1.);\n#endif\n#else\ncj = reflect(-cb, bv);\n#endif\ncj = mat3(viewMatrixInverse) * cj;\n  float ck = 1.;\n  vec3 cl;\n#ifdef HAS_IBL_LIGHTING\ncl = vec3(.0);\n#elif\ncl = ambientColor;\n#endif\ncl *= ck;\n  float bV = dot(cb, bv);\n  if(bV < -1e-2 || reflectivity == .0)\n    bV = 1.;\n  else\n    bV = max(1e-6, bV);\n  vec3 cm;\n  vec3 cn = u();\n#ifdef METAL\ncm = n(cn);\n#else\ncm = bS(n(cn), bV) * (1. - envRotationSin);\n  glFragColor.a = mix(glFragColor.a, bW(glFragColor.a, bV), reflectivity) * envRotationCos;\n  float co = pow(1. - bV * .5, 5.);\n  float cp = (28. / 23.) * (1. - co) * (1. - co);\n  glFragColor.rgb *= cp * (1. - n(cn));\n#endif\nglFragColor.rgb += cl.rgb * bY * cm.rgb;\n#endif\n#if defined(TONEMAP_OUTPUT)\n#if TONEMAP_OUTPUT == 1\nglFragColor.rgb = bi(exposureBias * glFragColor.rgb);\n#elif TONEMAP_OUTPUT == 2\nglFragColor.rgb = bh(exposureBias * glFragColor.rgb);\n#endif\n#endif\nglFragColor.rgb = mix(glFragColor.rgb, themingColor.rgb, themingColor.a);\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:i,defines:t.defines||{},extraCommandProps:t.extraCommandProps||{}}),this.version=300}},Texture2D:Iw,Util:rb,WaterShader:class Xt extends zw{constructor(t={}){super({vert:"precision highp float;\nprecision highp sampler2D;\nconst float c = 3.141592653589793;\nuniform mat4 projMatrix;\nuniform mat4 viewMatrix;\nuniform mat4 modelMatrix;\nattribute vec3 aPosition;\nattribute vec2 aTexCoord;\nattribute vec3 aNormal;\nvarying vec2 vuv;\nvarying vec3 vpos;\nvarying vec3 vnormal;\nvarying mat3 vtbnMatrix;\nvec4 d(mat4 e, mat4 f, vec3 h) {\n  return e * modelMatrix * f * vec4(h, 1.);\n}\nvec3 i(in vec3 h, in vec3 j) {\n  return normalize(h + j);\n}\nmat3 k(in vec3 l) {\n  vec3 t = normalize(cross(vec3(.0, .0, 1.), l));\n  vec3 b = normalize(cross(l, t));\n  return mat3(t, b, l);\n}\nvoid m() {\n  \n}\nvoid main(void) {\n  vuv = aTexCoord;\n  vpos = (modelMatrix * vec4(aPosition, 1.)).xyz;\n  vnormal = aNormal;\n  vtbnMatrix = k(vnormal);\n  gl_Position = d(projMatrix, viewMatrix, vpos);\n  m();\n}",frag:"precision highp float;\nprecision highp sampler2D;\nuniform sampler2D texWaveNormal;\nuniform sampler2D texWavePerturbation;\nuniform vec3 octaveTextureRepeat;\nuniform vec4 waveParams;\nuniform vec2 waveDirection;\nuniform vec4 waterColor;\nuniform vec3 lightingDirection;\nuniform vec3 lightingIntensity;\nuniform vec3 camPos;\nuniform float timeElapsed;\nvarying vec2 vuv;\nvarying vec3 vpos;\nvarying vec3 vnormal;\nvarying mat3 vtbnMatrix;\nconst vec2 c = vec2(6. / 25., 5. / 24.);\nvec2 d(sampler2D e, vec2 f) {\n  return 2. * texture2D(e, f).rg - 1.;\n}\nfloat h(vec2 f) {\n  return texture2D(texWavePerturbation, f).b;\n}\nvec3 i(sampler2D e, vec2 f) {\n  return 2. * texture2D(e, f).rgb - 1.;\n}\nfloat j(vec2 f, float k) {\n  return fract(k);\n}\nfloat l(vec2 f, float k) {\n  float m = j(f, k);\n  return 1. - abs(1. - 2. * m);\n}\nvec3 n(sampler2D o, vec2 f, float k, float u) {\n  float v = waveParams[2];\n  float A = waveParams[3];\n  vec2 B = d(o, f) * v;\n  float m = j(f, k + u);\n  float C = l(f, k + u);\n  vec2 D = f;\n  D -= B * (m + A);\n  D += u;\n  D += (k - m) * c;\n  return vec3(D, C);\n}\nconst float E = .3737;\nconst float F = 7.77;\nvec3 G(sampler2D H, sampler2D I, vec2 f, vec2 J, float k) {\n  float K = waveParams[0];\n  vec2 L = k * -J;\n  float M = h(f * E) * F;\n  vec3 N = n(I, f + L, k + M, .0);\n  vec3 O = n(I, f + L, k + M, .5);\n  vec3 P = i(H, N.xy) * N.z;\n  vec3 Q = i(H, O.xy) * O.z;\n  vec3 R = normalize(P + Q);\n  R.xy *= K;\n  R.z = sqrt(1. - dot(R.xy, R.xy));\n  return R;\n}\nvec3 S(vec2 f, float k) {\n  float T = waveParams[1];\n  return G(texWaveNormal, texWavePerturbation, f * T, waveDirection, k);\n}\nconst float U = 3.141592653589793;\nconst float V = 1. / U;\nconst float W = .3183098861837907;\nconst float X = 1.570796326794897;\nstruct PBRShadingWater {\n  float NdotL;\n  float NdotV;\n  float NdotH;\n  float VdotH;\n  float LdotH;\n  float VdotN;\n};\nfloat Y = 2.2;\nvec3 Z(float ba, vec3 bb, float bc) {\n  return bb + (bc - bb) * pow(1. - ba, 5.);\n}\nfloat bd(float be, float bf) {\n  float bg = bf * bf;\n  float bh = be * be;\n  float bi = pow((bh * (bg - 1.) + 1.), Y) * U;\n  return bg / bi;\n}\nfloat bj(float bk) {\n  return .25 / (bk * bk);\n}\nvec3 bl(in PBRShadingWater bm, float bf, vec3 bn, float bo) {\n  vec3 bp = Z(bm.VdotH, bn, bo);\n  float bq = bd(bm.NdotH, bf);\n  float br = bj(bm.LdotH);\n  return (bq * br) * bp;\n}\nvec3 bs(const vec3 x) {\n  return (x * (2.51 * x + .03)) / (x * (2.43 * x + .59) + .14);\n}\nconst float bt = 2.2;\nconst float bu = .4545454545;\nvec4 bv(vec4 bw) {\n  return vec4(pow(bw.rgb, vec3(bu)), bw.w);\n}\nvec3 bx(vec3 bw) {\n  return pow(bw, vec3(bt));\n}\nconst vec3 by = vec3(.02, 1., 5.);\nconst vec2 bz = vec2(.02, .1);\nconst float bf = .06;\nconst vec3 bA = vec3(0, .6, .9);\nconst vec3 bB = vec3(.72, .92, 1.);\nPBRShadingWater bC;\nvec3 bD(in float bE, in vec3 bF, in vec3 bG) {\n  float bH = pow((1. - bE), by[2]);\n  return mix(bG, bF, bH);\n}\nvec3 bI(in vec3 bJ, in vec3 bK, in vec3 bL, vec3 bw, in vec3 bM, in vec3 bN, in float bO) {\n  vec3 bP = bx(bw);\n  vec3 bQ = normalize(bL + bK);\n  bC.NdotL = clamp(dot(bJ, bL), .0, 1.);\n  bC.NdotV = clamp(dot(bJ, bK), .001, 1.);\n  bC.VdotN = clamp(dot(bK, bJ), .001, 1.);\n  bC.NdotH = clamp(dot(bJ, bQ), .0, 1.);\n  bC.VdotH = clamp(dot(bK, bQ), .0, 1.);\n  bC.LdotH = clamp(dot(bL, bQ), .0, 1.);\n  float bR = max(dot(bN, bK), .0);\n  vec3 bS = bx(bB);\n  vec3 bT = bx(bA);\n  vec3 bB = bD(bR, bS, bT);\n  float bU = max(dot(bN, bL), .0);\n  bB *= .1 + bU * .9;\n  float bV = clamp(bO, .8, 1.);\n  vec3 bW = Z(bC.VdotN, vec3(by[0]), by[1]) * bB * bV;\n  vec3 bX = bP * mix(bB, bU * bM * V, 2. / 3.) * bV;\n  vec3 bY = vec3(.0);\n  if(bR > .0 && bU > .0) {\n    vec3 bZ = bl(bC, bf, vec3(bz[0]), bz[1]);\n    vec3 ca = bM * V * bO;\n    bY = bC.NdotL * ca * bZ;\n  }\n  return bs(bW + bX + bY);\n}\nvoid main() {\n  vec3 bN = vnormal;\n  vec3 cb = S(vuv, timeElapsed);\n  vec3 bJ = normalize(vtbnMatrix * cb);\n  vec3 bK = -normalize(vpos - camPos);\n  vec3 bL = normalize(-lightingDirection);\n  float bO = 1.;\n  vec4 cc = vec4(bI(bJ, bK, bL, waterColor.rgb, lightingIntensity, bN, bO), waterColor.w);\n  gl_FragColor = bv(cc);\n}",defines:t.defines||{},extraCommandProps:t.extraCommandProps||{}})}},WireFrameMaterial:class Pe extends Qb{constructor(t){super(t,Yb)}},WireframeShader:class At extends zw{constructor(t={}){let e=t.extraCommandProps||{};const n=[];e=Hx({},e,{blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"},sample:{alpha:!0}}),super({vert:"#include <gl2_vert>\nattribute vec3 aPosition;\nattribute vec3 aBarycentric;\nvarying vec3 vBarycentric;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 projMatrix;\nuniform mat4 positionMatrix;\nvarying vec3 vPosition;\n#include <get_output>\nvoid main() {\n  mat4 c = getPositionMatrix();\n  vec4 d = getPosition(aPosition);\n#ifdef HAS_MASK_EXTENT\ngl_Position = projMatrix * getMaskPosition(c * d, modelMatrix);\n#else\ngl_Position = projMatrix * modelViewMatrix * c * d;\n#endif\nvBarycentric = aBarycentric;\n  vPosition = aPosition;\n}",frag:"#if __VERSION__ == 100\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives : enable\n#endif\n#endif\nprecision mediump float;\n#include <gl2_frag>\nvarying vec3 vBarycentric;\nuniform float time;\nuniform float thickness;\nuniform float secondThickness;\nuniform float dashRepeats;\nuniform float dashLength;\nuniform bool dashOverlap;\nuniform bool dashEnabled;\nuniform bool dashAnimate;\nuniform bool seeThrough;\nuniform bool insideAltColor;\nuniform bool dualStroke;\nuniform bool squeeze;\nuniform float squeezeMin;\nuniform float squeezeMax;\nuniform vec4 stroke;\nuniform vec4 fill;\nuniform float opacity;\nuniform bool noiseEnable;\nvarying vec3 vPosition;\n#ifdef HAS_INSTANCE\nvarying vec4 vInstanceColor;\n#endif\n#include <mask_frag>\n#define F4 0.309016994374947451\n#define halfDist 0.5\nvec4 c(vec4 x) {\n  return x - floor(x * (1. / 289.)) * 289.;\n}\nfloat c(float x) {\n  return x - floor(x * (1. / 289.)) * 289.;\n}\nvec4 d(vec4 x) {\n  return c((x * 34. + 1.) * x);\n}\nfloat d(float x) {\n  return c((x * 34. + 1.) * x);\n}\nvec4 e(vec4 r) {\n  return 1.79284291400159 - .85373472095314 * r;\n}\nfloat e(float r) {\n  return 1.79284291400159 - .85373472095314 * r;\n}\nvec4 f(float h, vec4 i) {\n  const vec4 k = vec4(1., 1., 1., -1.);\n  vec4 p, s;\n  p.xyz = floor(fract(vec3(h) * i.xyz) * 7.) * i.z - 1.;\n  p.w = 1.5 - dot(abs(p.xyz), k.xyz);\n  s = vec4(lessThan(p, vec4(.0)));\n  p.xyz = p.xyz + (s.xyz * 2. - 1.) * s.www;\n  return p;\n}\nfloat l(vec4 m) {\n  const vec4 n = vec4(.138196601125011, .276393202250021, .414589803375032, -.447213595499958);\n  vec4 o = floor(m + dot(m, vec4(F4)));\n  vec4 u = m - o + dot(o, n.xxxx);\n  vec4 A;\n  vec3 B = step(u.yzw, u.xxx);\n  vec3 D = step(u.zww, u.yyz);\n  A.x = B.x + B.y + B.z;\n  A.yzw = 1. - B;\n  A.y += D.x + D.y;\n  A.zw += 1. - D.xy;\n  A.z += D.z;\n  A.w += 1. - D.z;\n  vec4 E = clamp(A, .0, 1.);\n  vec4 F = clamp(A - 1., .0, 1.);\n  vec4 G = clamp(A - 2., .0, 1.);\n  vec4 H = u - G + n.xxxx;\n  vec4 I = u - F + n.yyyy;\n  vec4 J = u - E + n.zzzz;\n  vec4 K = u + n.wwww;\n  o = c(o);\n  float L = d(d(d(d(o.w) + o.z) + o.y) + o.x);\n  vec4 M = d(d(d(d(o.w + vec4(G.w, F.w, E.w, 1.)) + o.z + vec4(G.z, F.z, E.z, 1.)) + o.y + vec4(G.y, F.y, E.y, 1.)) + o.x + vec4(G.x, F.x, E.x, 1.));\n  vec4 i = vec4(1. / 294., 1. / 49., 1. / 7., .0);\n  vec4 N = f(L, i);\n  vec4 O = f(M.x, i);\n  vec4 P = f(M.y, i);\n  vec4 Q = f(M.z, i);\n  vec4 R = f(M.w, i);\n  vec4 S = e(vec4(dot(N, N), dot(O, O), dot(P, P), dot(Q, Q)));\n  N *= S.x;\n  O *= S.y;\n  P *= S.z;\n  Q *= S.w;\n  R *= e(dot(R, R));\n  vec3 T = max(.6 - vec3(dot(u, u), dot(H, H), dot(I, I)), .0);\n  vec2 U = max(.6 - vec2(dot(J, J), dot(K, K)), .0);\n  T = T * T;\n  U = U * U;\n  return 49. * (dot(T * T, vec3(dot(N, u), dot(O, H), dot(P, I))) + dot(U * U, vec2(dot(Q, J), dot(R, K))));\n}\nconst float V = 3.14159265359;\nfloat W(float X, float Y) {\n  float Z = fwidth(Y) * halfDist;\n  return smoothstep(X - Z, X + Z, Y);\n}\nvec4 ba(vec3 bb) {\n  float bc = min(min(bb.x, bb.y), bb.z);\n  float bd = .0;\n  if(noiseEnable)\n    bd += l(vec4(vPosition.xyz * 80.0, time * halfDist)) * .12;\n  bc += bd;\n  float be = max(bb.x, bb.y);\n  if(bb.y < bb.x && bb.y < bb.z) {\n    be = 1. - be;\n  }\n  float bf = thickness;\n  if(squeeze) {\n    bf *= mix(squeezeMin, squeezeMax, (1. - sin(be * V)));\n  }\n  if(dashEnabled) {\n    float bg = 1. / dashRepeats * dashLength / 2.;\n    if(!dashOverlap) {\n      bg += 1. / dashRepeats / 2.;\n    }\n    if(dashAnimate) {\n      bg += time * .22;\n    }\n    float bh = fract((be + bg) * dashRepeats);\n    bf *= 1. - W(dashLength, bh);\n  }\n  float bi = 1. - W(bf, bc);\n#ifdef HAS_INSTANCE\nvec4 bj = vInstanceColor;\n#else\nvec4 bj = stroke;\n#endif\nvec4 bk = vec4(.0);\n  if(seeThrough) {\n    bk = vec4(bj.xyz, bi);\n    if(insideAltColor && !gl_FrontFacing) {\n      bk.rgb = fill.xyz;\n    }\n  } else {\n    vec3 bl = mix(fill.xyz, bj.xyz, bi);\n    bk.a = fill.a;\n    if(dualStroke) {\n      float bm = 1. - W(secondThickness, bc);\n      vec3 bn = mix(fill.xyz, stroke.xyz, abs(bm - bi));\n      bk.rgb = bn;\n    } else {\n      bk.rgb = bl;\n    }\n  }\n  return bk;\n}\nvoid main() {\n  glFragColor = ba(vBarycentric);\n  glFragColor *= halfDist + opacity;\n#ifdef HAS_MASK_EXTENT\nglFragColor = setMask(glFragColor);\n#endif\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:[{name:"modelViewMatrix",type:"function",fn:(t,e)=>cy(n,e.viewMatrix,e.modelMatrix)}],extraCommandProps:e}),this.version=300}},earcut:bC,glMatrix:zm,mat2:Wm,mat2d:Xm,mat3:ry,mat4:Ey,pbr:xC,quat:bv,quat2:Pv,vec2:Kv,vec3:h_,vec4:H_}),TC=Array.isArray,MC=Object.keys,CC=Object.prototype.hasOwnProperty,SC=function t(e,n){if(e===n)return!0;if(e&&n&&"object"==typeof e&&"object"==typeof n){var i,o,s,a=TC(e),l=TC(n);if(a&&l){if((o=e.length)!=n.length)return!1;for(i=o;0!=i--;)if(!t(e[i],n[i]))return!1;return!0}if(a!=l)return!1;var h=e instanceof Date,c=n instanceof Date;if(h!=c)return!1;if(h&&c)return e.getTime()==n.getTime();var u=e instanceof RegExp,f=n instanceof RegExp;if(u!=f)return!1;if(u&&f)return e.toString()==n.toString();var g=MC(e);if((o=g.length)!==MC(n).length)return!1;for(i=o;0!=i--;)if(!CC.call(n,g[i]))return!1;for(i=o;0!=i--;)if(!t(e[s=g[i]],n[s]))return!1;return!0}return e!=e&&n!=n},PC=km(SC);
/*!
   * @ispace/fusiongl v0.9.3
   * LICENSE : UNLICENSED
   * (c) 2016-2026 ispace.com
   */
function IC(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)t[e]=n[e]}return t}function OC(t,...e){for(let n=0;n<e.length;n++)IC(t,e[n])}class DrawBuffersExt{constructor(t){this.context=t,this.COLOR_ATTACHMENT0_WEBGL=36064,this.COLOR_ATTACHMENT1_WEBGL=36065,this.COLOR_ATTACHMENT2_WEBGL=36066,this.COLOR_ATTACHMENT3_WEBGL=36067,this.COLOR_ATTACHMENT4_WEBGL=36068,this.COLOR_ATTACHMENT5_WEBGL=36069,this.COLOR_ATTACHMENT6_WEBGL=36070,this.COLOR_ATTACHMENT7_WEBGL=36071,this.COLOR_ATTACHMENT8_WEBGL=36072,this.COLOR_ATTACHMENT9_WEBGL=36073,this.COLOR_ATTACHMENT10_WEBGL=577040,this.COLOR_ATTACHMENT11_WEBGL=577041,this.COLOR_ATTACHMENT12_WEBGL=577042,this.COLOR_ATTACHMENT13_WEBGL=577043,this.COLOR_ATTACHMENT14_WEBGL=577044,this.COLOR_ATTACHMENT15_WEBGL=577045,this.DRAW_BUFFER0_WEBGL=34853,this.DRAW_BUFFER1_WEBGL=34854,this.DRAW_BUFFER2_WEBGL=34855,this.DRAW_BUFFER3_WEBGL=34856,this.DRAW_BUFFER4_WEBGL=34857,this.DRAW_BUFFER5_WEBGL=34858,this.DRAW_BUFFER6_WEBGL=34859,this.DRAW_BUFFER7_WEBGL=34860,this.DRAW_BUFFER8_WEBGL=34861,this.DRAW_BUFFER9_WEBGL=34862,this.DRAW_BUFFER10_WEBGL=34863,this.DRAW_BUFFER11_WEBGL=34864,this.DRAW_BUFFER12_WEBGL=34865,this.DRAW_BUFFER13_WEBGL=34866,this.DRAW_BUFFER14_WEBGL=34867,this.DRAW_BUFFER15_WEBGL=34868,this.MAX_COLOR_ATTACHMENTS_WEBGL=36063,this.MAX_DRAW_BUFFERS_WEBGL=2178}drawBuffersWEBGL(){return this.context.drawBuffers.apply(this.context,arguments)}}class VertexArrayObjectExt{constructor(t){this.context=t,this.VERTEX_ARRAY_BINDING_OES=34229}createVertexArrayOES(){return this.context.createVertexArray()}deleteVertexArrayOES(){return this.context.deleteVertexArray.apply(this.context,arguments)}isVertexArrayOES(){return this.context.isVertexArray.apply(this.context,arguments)}bindVertexArrayOES(){return this.context.bindVertexArray.apply(this.context,arguments)}}class AngleInstancedArrayExt{constructor(t){this.context=t,this.VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE=35070}drawArraysInstancedANGLE(){return this.context.drawArraysInstanced.apply(this.context,arguments)}drawElementsInstancedANGLE(){return this.context.drawElementsInstanced.apply(this.context,arguments)}vertexAttribDivisorANGLE(){return this.context.vertexAttribDivisor.apply(this.context,arguments)}}const EC=36193,kC={webgl_depth_texture:{UNSIGNED_INT_24_8_WEBGL:34042},oes_element_index_uint:{},oes_texture_float:{},oes_texture_half_float:{HALF_FLOAT_OES:36193},ext_color_buffer_float:{},oes_standard_derivatives:{},ext_frag_depth:{},ext_blend_minmax:{MIN_EXT:32775,MAX_EXT:32776},ext_shader_texture_lod:{}},RC={has(t,e){const n=t.t;return!(!n&&!t.i.getExtension(e))&&(e=e.toLowerCase(),n&&kC[e]||"webgl_draw_buffers"===e||"oes_vertex_array_object"===e||"angle_instanced_arrays"===e)},mock:(t,e)=>(e=e.toLowerCase(),kC[e]?t.t?("oes_texture_float"!==e&&"oes_texture_half_float"!==e||t.i.getExtension("EXT_color_buffer_float"),kC[e]):t.i.getExtension(e):"webgl_draw_buffers"===e?new DrawBuffersExt(t):"oes_vertex_array_object"===e?new VertexArrayObjectExt(t):"angle_instanced_arrays"===e?new AngleInstancedArrayExt(t):null),getInternalFormat:(t,e,n)=>6402===e?33190:34041===e?35056:n===EC&&e===t.RGBA?34842:n===EC&&e===t.RGB?34843:n===t.FLOAT&&e===t.RGBA?34836:n===t.FLOAT&&e===t.RGB?34837:e,getTextureType:(t,e)=>e===EC?t.HALF_FLOAT:e};let LC=1,DC=class WebGL2RenderingContext{constructor(t){this.uid=LC++,this.states=function(t){return{scissor:[0,0,t.canvas.width,t.canvas.height],viewport:[0,0,t.canvas.width,t.canvas.height],blendColor:[0,0,0,0],blendEquationSeparate:[t.FUNC_ADD,t.FUNC_ADD],blendFuncSeparate:[t.ONE,t.ZERO,t.ONE,t.ZERO],clearColor:[0,0,0,0],clearDepth:[1],clearStencil:[0],colorMask:[!0,!0,!0,!0],cullFace:[t.BACK],depthFunc:[t.LESS],depthMask:[!0],depthRange:[0,1],capabilities:{3042:!1,2884:!1,2929:!1,3024:!1,32823:!1,32926:!1,32928:!1,3089:!1,2960:!1},frontFace:[t.CCW],hint:{33170:[t.DONT_CARE],35723:[t.DONT_CARE]},lineWidth:[1],pixelStorei:{3333:[4],3317:[4],37440:[!1],37441:[!1],37443:[t.BROWSER_DEFAULT_WEBGL]},polygonOffset:[0,0],sampleCoverage:[1,!1],stencilFuncSeparate:{1028:[t.ALWAYS,0,4294967295],1029:[t.ALWAYS,0,4294967295]},stencilMaskSeparate:{1028:[4294967295],1029:[4294967295]},stencilOpSeparate:{1028:[t.KEEP,t.KEEP,t.KEEP],1029:[t.KEEP,t.KEEP,t.KEEP]},program:null,framebuffer:{36160:null,36008:null,36009:null},renderbuffer:{36161:null},textures:{active:-1,units:function(){const e=[],n=t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS);for(let t=0;t<n;t++)e.push({3553:null,34067:null});return e[-1]={3553:null,34067:null},e}()},attributes:{},arrayBuffer:null,elementArrayBuffer:null}}(t),this.i=t,this.i._fusiongl_drawCalls=0,this.t=void 0!==window.WebGL2RenderingContext&&this.i instanceof window.WebGL2RenderingContext;const e=Object.getPrototypeOf(this);Object.setPrototypeOf(e,this.t?window.WebGL2RenderingContext.prototype:WebGLRenderingContext.prototype),this.h=t.getParameter(t.MAX_VERTEX_ATTRIBS)}get canvas(){return this.i.canvas}get drawingBufferWidth(){return this.i.drawingBufferWidth}get drawingBufferHeight(){return this.i.drawingBufferHeight}get drawingBufferColorSpace(){return this.i.drawingBufferColorSpace}set drawingBufferColorSpace(t){this.i.drawingBufferColorSpace=t}get gl(){return this.i}get buffersOES(){return this.u||(this.u=this.i.getExtension("WEBGL_draw_buffers")),this.u}get vaoOES(){return this.o||(this.o=this.i.getExtension("OES_vertex_array_object")),this.o}get angleOES(){return this.l||(this.l=this.i.getExtension("ANGLE_instanced_arrays")),this.l}get standOES(){return this.m||(this.m=this.i.getExtension("OES_standard_derivatives")),this.m}attachShader(t,e){return this.i.attachShader(t,e)}shaderSource(t,e){return this.i.shaderSource(t,e)}compileShader(t){return this.i.compileShader(t)}createShader(t){return this.i.createShader(t)}createProgram(){return this.i.createProgram()}deleteProgram(t){return this.states.program===t&&(this.states.program=null),this.i.deleteProgram(t)}deleteShader(t){return this.i.deleteShader(t)}detachShader(t,e){return this.i.detachShader(t,e)}getAttachedShaders(t){return this.i.getAttachedShaders(t)}linkProgram(t){return this.i.linkProgram(t)}makeXRCompatible(){return this.i.makeXRCompatible()}getShaderParameter(t,e){return this.i.getShaderParameter(t,e)}getShaderPrecisionFormat(t,e){return this.i.getShaderPrecisionFormat(t,e)}getShaderInfoLog(t){return this.i.getShaderInfoLog(t)}getShaderSource(t){return this.i.getShaderSource(t)}getProgramInfoLog(t){return this.i.getProgramInfoLog(t)}getProgramParameter(t,e){return this.i.getProgramParameter(t,e)}getError(){return this.i.getError()}getContextAttributes(){return this.i.getContextAttributes()}getExtension(t){return RC.has(this,t)?RC.mock(this,t):this.i.getExtension(t)}getSupportedExtensions(){return this.i.getSupportedExtensions()}getParameter(t){return this.i.getParameter(t)}isEnabled(t){return this.i.isEnabled(t)}isProgram(t){return this.i.isProgram(t)}isShader(t){return this.i.isShader(t)}validateProgram(t){return this.i.validateProgram(t)}clear(t){return this.v(),this.i.clear(t)}drawArrays(t,e,n){return this.v(),this._(),this.i.drawArrays(t,e,n)}drawElements(t,e,n,i){return this.v(),this._(),this.i.drawElements(t,e,n,i)}drawBuffers(t){return this.v(),this._(),this.t?this.i.drawBuffers(t):this.buffersOES.drawBuffersWEBGL(t)}_(){this.i._fusiongl_drawCalls++}resetDrawCalls(){this.i._fusiongl_drawCalls=0}getDrawCalls(){return this.i._fusiongl_drawCalls}S(){const t=this.i,e=t.getParameter(t.CURRENT_PROGRAM),n=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES),i=[];for(let e=0;e<n;e++)i.push(t.getVertexAttrib(e,t.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING));this.A={buffers:i,elements:t.getParameter(t.ELEMENT_ARRAY_BUFFER_BINDING),framebuffer:t.getParameter(t.FRAMEBUFFER_BINDING)},window.DEBUGGING&&(console.log(this.uid,this.A),console.log(this.uid,this.states.attributes),console.log(this.states.attributes[0].buffer===this.A.buffers[0]),console.log(this.states.attributes[1].buffer===this.A.buffers[1]),console.log(this.states.attributes[2].buffer===this.A.buffers[2]))}finish(){return this.i.finish()}flush(){return this.v(),this.i.flush()}commit(){return this.v(),this.i.commit()}isContextLost(){return this.i.isContextLost()}getFragDataLocation(t,e){return this.i.getFragDataLocation(t,e)}createSampler(){return this.i.createSampler()}deleteSampler(){return this.i.deleteSampler()}bindSampler(){return this.i.bindSampler()}isSampler(){return this.i.isSampler()}getSamplerParameter(){return this.i.getSamplerParameter()}isQuery(t){return this.i.beginQuery(t)}beginQuery(t,e){return this.i.beginQuery(t,e)}deleteQuery(t){return this.i.query(t)}isTransformFeedback(t){return this.i.isTransformFeedback(t)}beginTransformFeedback(t){return this.i.beginTransformFeedback(t)}deleteTransformFeedback(t){return this.i.deleteTransformFeedback(t)}pauseTransformFeedback(){return this.i.pauseTransformFeedback()}resumeTransformFeedback(){return this.i.resumeTransformFeedback()}transformFeedbackVaryings(t,e,n){return this.i.transformFeedbackVaryings(t,e,n)}bindBufferBase(t,e,n){return this.i.bbindBufferBase(t,e,n)}bindBufferRange(t,e,n,i,o){return this.i.bindBufferRange(t,e,n,i,o)}bindTransformFeedback(t,e){return this.i.bindTransformFeedback(t,e)}fenceSync(t,e){return this.i.fenceSync(t,e)}isSync(t){return this.i.isSync(t)}deleteSync(t){return this.i.deleteSync(t)}clientWaitSync(t,e,n){return this.i.clientWaitSync(t,e,n)}waitSync(t,e,n){return this.i.waitSync(t,e,n)}getSyncParameter(t,e){return this.i.getSyncParameter(t,e)}getIndexedParameter(t,e){return this.i.getIndexedParameter(t,e)}};OC(DC.prototype,{bufferData(...t){return this.v(),this.i.bufferData(...t)},bufferSubData(...t){return this.v(),this.i.bufferSubData(...t)},createBuffer(){return this.i.createBuffer()},deleteBuffer(t){const e=this.states;e.arrayBuffer===t?e.arrayBuffer=null:e.elementArrayBuffer===t&&(e.elementArrayBuffer=null);const n=e.attributes;for(const e in n)n[e].buffer===t&&(n[e].buffer=null);return this.i.deleteBuffer(t)},getBufferParameter(t,e){return this.v(),this.i.getBufferParameter(t,e)},isBuffer(t){return this.i.isBuffer(t)},copyBufferSubData(t,e,n,i,o){return this.i.isBuffer(t,e,n,i,o)},readBuffer(t){return this.i.readBuffer(t)}}),OC(DC.prototype,{checkFramebufferStatus(t){return this.i.checkFramebufferStatus(t)},createFramebuffer(){return this.i.createFramebuffer()},deleteFramebuffer(t){const e=this.states.framebuffer;for(const n in e)e[n]===t&&(e[n]=null);return this.i.deleteFramebuffer(t)},framebufferRenderbuffer(t,e,n,i){return this.v(),this.i.framebufferRenderbuffer(t,e,n,i)},framebufferTexture2D(t,e,n,i,o){return this.v(),this.i.framebufferTexture2D(t,e,n,i,o)},getFramebufferAttachmentParameter(t,e,n){return this.v(),this.i.getFramebufferAttachmentParameter(t,e,n)},isFramebuffer(t){return this.i.isFramebuffer(t)},readPixels(t,e,n,i,o,s,a){return this.v(),this.i.readPixels(t,e,n,i,o,s,a)},blitFramebuffer(t,e,n,i,o,s,a,l,h,c){return this.v(),this.i.blitFramebuffer(t,e,n,i,o,s,a,l,h,c)}}),OC(DC.prototype,{createRenderbuffer(){return this.i.createRenderbuffer()},deleteRenderbuffer(t){const e=this.states.renderbuffer;for(const n in e)e[n]===t&&(e[n]=null);return this.i.deleteRenderbuffer(t)},getRenderbufferParameter(t,e){return this.v(),this.i.getRenderbufferParameter(t,e)},isRenderbuffer(t){return this.i.isRenderbuffer(t)},renderbufferStorage(t,e,n,i){return this.v(),this.i.renderbufferStorage(t,e,n,i)},renderbufferStorageMultisample(t,e,n,i,o){return this.v(),this.i.renderbufferStorageMultisample(t,e,n,i,o)}});const FC="_fusion_context";OC(DC.prototype,{scissor(t,e,n,i){this.v();const o=this.states.scissor;o[0]===t&&o[1]===e&&o[2]===n&&o[3]===i||(o[0]=t,o[1]=e,o[2]=n,o[3]=i,this.i.scissor(t,e,n,i))},viewport(t,e,n,i){this.v();const o=this.states.viewport;o[0]===t&&o[1]===e&&o[2]===n&&o[3]===i||(o[0]=t,o[1]=e,o[2]=n,o[3]=i,this.i.viewport(t,e,n,i))},blendColor(t,e,n,i){this.v();const o=this.states.blendColor;o[0]===t&&o[1]===e&&o[2]===n&&o[3]===i||(o[0]=t,o[1]=e,o[2]=n,o[3]=i,this.i.blendColor(t,e,n,i))},blendEquation(t){this.v();const e=this.states.blendEquationSeparate;e[0]===t&&e[1]===t||(e[0]=t,e[1]=t,this.i.blendEquation(t))},blendEquationSeparate(t,e){this.v();const n=this.states.blendEquationSeparate;n[0]===t&&n[1]===e||(n[0]=t,n[1]=e,this.i.blendEquationSeparate(t,e))},blendFunc(t,e){this.v();const n=this.states.blendFuncSeparate;n[0]===t&&n[2]===t&&n[1]===e&&n[3]===e||(n[0]=t,n[1]=e,n[2]=t,n[3]=e,this.i.blendFunc(t,e))},blendFuncSeparate(t,e,n,i){this.v();const o=this.states.blendFuncSeparate;o[0]===t&&o[1]===e&&o[2]===n&&o[3]===i||(o[0]=t,o[1]=e,o[2]=n,o[3]=i,this.i.blendFuncSeparate(t,e,n,i))},clearColor(t,e,n,i){this.v();const o=this.states.clearColor;o[0]===t&&o[1]===e&&o[2]===n&&o[3]===i||(o[0]=t,o[1]=e,o[2]=n,o[3]=i,this.i.clearColor(t,e,n,i))},clearDepth(t){this.v();const e=this.states.clearDepth;e[0]!==t&&(e[0]=t,this.i.clearDepth(t))},clearStencil(t){this.v();const e=this.states.clearStencil;e[0]!==t&&(e[0]=t,this.i.clearStencil(t))},colorMask(t,e,n,i){this.v();const o=this.states.colorMask;o[0]===t&&o[1]===e&&o[2]===n&&o[3]===i||(o[0]=t,o[1]=e,o[2]=n,o[3]=i,this.i.colorMask(t,e,n,i))},cullFace(t){this.v();const e=this.states.cullFace;e[0]!==t&&(e[0]=t,this.i.cullFace(t))},depthFunc(t){this.v();const e=this.states.depthFunc;e[0]!==t&&(e[0]=t,this.i.depthFunc(t))},depthMask(t){this.v();const e=this.states.depthMask;e[0]!==t&&(e[0]=t,this.i.depthMask(t))},depthRange(t,e){this.v();const n=this.states.depthRange;n[0]===t&&n[1]===e||(n[0]=t,n[1]=e,this.i.depthRange(t,e))},disable(t){this.v();const e=this.states.capabilities;e[t]&&(e[t]=!1,this.i.disable(t))},enable(t){this.v();const e=this.states.capabilities;e[t]||(e[t]=!0,this.i.enable(t))},frontFace(t){this.v();const e=this.states.frontFace;e[0]!==t&&(e[0]=t,this.i.frontFace(t))},hint(t,e){this.v();const n=this.states.hint;n[t][0]!==e&&(n[t][0]=e,this.i.hint(t,e))},lineWidth(t){this.v();const e=this.states.lineWidth;e[0]!==t&&(e[0]=t,this.i.lineWidth(t))},pixelStorei(t,e){this.v();const n=this.states.pixelStorei;n[t]!==e&&(n[t]&&(n[t][0]=e),this.i.pixelStorei(t,e))},polygonOffset(t,e){this.v();const n=this.states.polygonOffset;n[0]===t&&n[1]===e||(n[0]=t,n[1]=e,this.i.polygonOffset(t,e))},sampleCoverage(t,e){this.v();const n=this.states.sampleCoverage;n[0]===t&&n[1]===e||(n[0]=t,n[1]=e,this.i.sampleCoverage(t,e))},stencilFunc(t,e,n){this.v();const i=this.states.stencilFuncSeparate,o=this.i;i[o.FRONT][0]===t&&i[o.FRONT][1]===e&&i[o.FRONT][2]===n&&i[o.BACK][0]===t&&i[o.BACK][1]===e&&i[o.BACK][2]===n||(i[o.FRONT][0]=i[o.BACK][0]=t,i[o.FRONT][1]=i[o.BACK][1]=e,i[o.FRONT][2]=i[o.BACK][2]=n,this.i.stencilFunc(t,e,n))},stencilFuncSeparate(t,e,n,i){if(this.v(),t===this.i.FRONT_AND_BACK)return void this.stencilFunc(e,n,i);const o=this.states.stencilFuncSeparate;o[t][0]===e&&o[t][1]===n&&o[t][2]===i||(o[t][0]=e,o[t][1]=n,o[t][2]=i,this.i.stencilFuncSeparate(t,e,n,i))},stencilMask(t){this.v();const e=this.i,n=this.states.stencilMaskSeparate;n[e.FRONT][0]===t&&n[e.BACK][0]===t||(n[e.FRONT][0]=t,n[e.BACK][0]=t,this.i.stencilMask(t))},stencilMaskSeparate(t,e){if(this.v(),t===this.i.FRONT_AND_BACK)return void this.stencilMask(e);const n=this.states.stencilMaskSeparate;n[t][0]!==e&&(n[t][0]=e,this.i.stencilMaskSeparate(t,e))},stencilOp(t,e,n){this.v();const i=this.states.stencilOpSeparate,o=this.i;i[o.FRONT][0]===t&&i[o.FRONT][1]===e&&i[o.FRONT][2]===n&&i[o.BACK][0]===t&&i[o.BACK][1]===e&&i[o.BACK][2]===n||(i[o.FRONT][0]=i[o.BACK][0]=t,i[o.FRONT][1]=i[o.BACK][1]=e,i[o.FRONT][2]=i[o.BACK][2]=n,this.i.stencilOp(t,e,n))},stencilOpSeparate(t,e,n,i){if(this.v(),t===this.i.FRONT_AND_BACK)return void this.stencilOp(e,n,i);const o=this.states.stencilOpSeparate;o[t][0]===e&&o[t][1]===n&&o[t][2]===i||(o[t][0]=e,o[t][1]=n,o[t][2]=i,this.i.stencilOpSeparate(t,e,n,i))},bindFramebuffer(t,e){this.v();const n=this.states.framebuffer;n[t]!==e&&(n[t]=e,this.i.bindFramebuffer(t,e))},bindRenderbuffer(t,e){this.v();const n=this.states.renderbuffer;n[t]!==e&&(n[t]=e,this.i.bindRenderbuffer(t,e))},bindTexture(t,e){this.v();const n=this.states.textures;n.units[-1!==n.active?n.active-33984:-1][t]=e,this.i.bindTexture(t,e)},activeTexture(t){this.v();const e=this.i,n=this.states.textures,i=n.active;n.active=t,this.activeUnit!==t&&(e.activeTexture(t),this.activeUnit=t),-1===i&&(n.units[t-33984][e.TEXTURE_2D]=n.units[-1][e.TEXTURE_2D],n.units[t-33984][e.TEXTURE_CUBE_MAP]=n.units[-1][e.TEXTURE_CUBE_MAP],n.units[-1][e.TEXTURE_2D]=null,n.units[-1][e.TEXTURE_CUBE_MAP]=null)},useProgram(t){this.v();const e=this.states;e.program!==t&&(this.states.activeAttribType=0,e.program=t,void 0===t.fid&&(t.fid=0),this.p(),this.i.useProgram(t))},p(){const t=this.states.program;if(!t)return;const e=t.cachedUniforms=t.cachedUniforms||{};for(const t in e)Array.isArray(e[t])?e[t].fill(null):e[t]=null},bindBuffer(t,e){this.v();const n=this.i,i=this.states;t===n.ELEMENT_ARRAY_BUFFER?i.elementArrayBuffer=e:i.arrayBuffer=e,n.bindBuffer(t,e)},bindVertexArray(t){this.v(),this.states.activeAttribType=1;const e=this.i,n=this.states;n.vao!==t&&(n.vao=t,this.t?e.bindVertexArray(t):this.vaoOES.bindVertexArrayOES(t))},vertexAttribPointer(t,e,n,i,o,s){this.v(),this.states.attributes[t]||(this.states.attributes[t]={enable:!0});const a=this.states.attributes[t];return a.buffer=this.states.arrayBuffer,a.args?(a.args[0]=t,a.args[1]=e,a.args[2]=n,a.args[3]=i,a.args[4]=o,a.args[5]=s):a.args=[t,e,n,i,o,s],this.i.vertexAttribPointer(t,e,n,i,o,s)},vertexAttribDivisor(t,e){return this.v(),this.states.attributes[t].divisor=e,this.t?this.i.vertexAttribDivisor(t,e):this.angleOES.vertexAttribDivisorANGLE(t,e)}},{v(){const t=this.i;if(t[FC]!==this)if(t[FC]){this.N(t[FC].states),t[FC]=this}else t[FC]=this},N(t){if(!t)return;delete this.activeUnit;const e=this.states,n=this.i;let i=0;for(const o in e)if("capabilities"!==o&&"textures"!==o&&"attributes"!==o&&"arrayBuffer"!==o&&"elementArrayBuffer"!==o&&"vao"!==o)if("program"===o)e.program!==t.program&&(n.useProgram(e.program),e.program&&(i=n.getProgramParameter(e.program,n.ACTIVE_ATTRIBUTES)));else if("framebuffer"===o)for(const i in e[o])e[o][i]!==t[o][i]&&n.bindFramebuffer(+i,e[o][i]);else if("renderbuffer"===o)for(const i in e[o])e[o][i]!==t[o][i]&&n.bindRenderbuffer(+i,e[o][i]);else if(!PC(e[o],t[o]))if(Array.isArray(t[o]))n[o](...e[o]);else if(t[o])for(const i in e[o])PC(e[o][i],t[o][i])||n[o](+i,...e[o][i]);this.p();for(const i in e.capabilities)e.capabilities[i]!==t.capabilities[i]&&n[e.capabilities[i]?"enable":"disable"](+i);const o=e.textures,s=o.units,a=t.textures.units,l=o.active-n.TEXTURE0;for(let t=0;t<s.length;t++)t===l||s[t][n.TEXTURE_2D]===a[t][n.TEXTURE_2D]&&s[t][n.TEXTURE_CUBE_MAP]===a[t][n.TEXTURE_CUBE_MAP]||(n.activeTexture(n.TEXTURE0+t),n.bindTexture(n.TEXTURE_2D,s[t][n.TEXTURE_2D]),n.bindTexture(n.TEXTURE_CUBE_MAP,s[t][n.TEXTURE_CUBE_MAP]));if(o.active>-1){const t=s[l];t[n.TEXTURE_2D]===a[l][n.TEXTURE_2D]&&t[n.TEXTURE_CUBE_MAP]===a[l][n.TEXTURE_CUBE_MAP]||(n.activeTexture(o.active),n.bindTexture(n.TEXTURE_2D,t[n.TEXTURE_2D]),n.bindTexture(n.TEXTURE_CUBE_MAP,t[n.TEXTURE_CUBE_MAP]))}this.t?n.bindVertexArray(null):this.o&&this.o.bindVertexArrayOES(null);const h=this.h;if(this.t||this.angleOES)for(let t=0;t<h;t++)this.t?n.vertexAttribDivisor(t,0):this.angleOES.vertexAttribDivisorANGLE(t,0);n.bindBuffer(n.ARRAY_BUFFER,e.arrayBuffer),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e.elementArrayBuffer),1===e.activeAttribType?this.F(e,n):this.L(e,n,i)},F(t,e){const n=t.vao;n&&(this.t?e.bindVertexArray(n||null):this.o&&this.o.bindVertexArrayOES(n||null))},L(t,e,n){const i=this.h,o=t.attributes;let s=0;for(let t=0;t<i;t++){const i=o[t];if(s<n&&i){if(i.buffer){if(e.bindBuffer(e.ARRAY_BUFFER,i.buffer),e.vertexAttribPointer(...i.args),i.divisor&&(this.t?e.vertexAttribDivisor(t,i.divisor):this.angleOES.vertexAttribDivisorANGLE(t,i.divisor)),i.enable){e.enableVertexAttribArray(t),s++;continue}e.disableVertexAttribArray(t)}e.disableVertexAttribArray(t)}else e.disableVertexAttribArray(t)}}}),OC(DC.prototype,{compressedTexImage2D(t,e,n,i,o,s,a){return this.v(),this.i.compressedTexImage2D(t,e,n,i,o,s,a)},copyTexImage2D(t,e,n,i,o,s,a,l){return this.v(),this.i.copyTexImage2D(t,e,n,i,o,s,a,l)},copyTexSubImage2D(t,e,n,i,o,s,a,l){return this.v(),this.i.copyTexSubImage2D(t,e,n,i,o,s,a,l)},createTexture(){return this.i.createTexture()},deleteTexture(t){const e=this.states.textures.units;for(let n=0;n<e.length;n++)for(const i in e[n])e[n][i]===t&&(e[n][i]=null);return this.i.deleteTexture(t)},generateMipmap(t){return this.v(),this.i.generateMipmap(t)},getTexParameter(t,e){return this.v(),this.i.getTexParameter(t,e)},isTexture(t){return this.i.isTexture(t)},texImage2D(...t){if(this.v(),this.t){const e=t[t.length-2],n=RC.getInternalFormat(this.i,t[2],e);n!==t[2]&&(t[2]=n);const i=RC.getTextureType(this.i,e);i!==e&&(t[t.length-2]=i)}return this.i.texImage2D(...t)},texSubImage2D(...t){if(this.v(),this.t){const e=t[t.length-2],n=RC.getTextureType(this.i,e);n!==e&&(t[t.length-2]=n)}return this.i.texSubImage2D(...t)},texParameterf(t,e,n){return this.v(),this.i.texParameterf(t,e,n)},texParameteri(t,e,n){return this.v(),this.i.texParameteri(t,e,n)},texStorage2D(t,e,n,i,o){return this.v(),this.i.texStorage2D(t,e,n,i,o)},texImage3D(t,e,n,i,o,s,a,l,h,c){return this.v(),this.i.texImage3D(t,e,n,i,o,s,a,l,h,c)},texStorage3D(t,e,n,i,o,s){return this.v(),this.i.texStorage3D(t,e,n,i,o,s)},texSubImage3D(t,e,n,i,o,s,a,l,h,c,u){return this.v(),this.i.texSubImage3D(t,e,n,i,o,s,a,l,h,c,u)},copyTexSubImage3D(t,e,n,i,o,s,a,l,h){return this.v(),this.i.copyTexSubImage3D(t,e,n,i,o,s,a,l,h)},compressedTexSubImage3D(t,e,n,i,o,s,a,l,h,c,u){return this.v(),this.i.compressedTexSubImage3D(t,e,n,i,o,s,a,l,h,c,u)}});const NC=[];function HC(t,e){const n=e.length;for(let i=0;i<n;i++)t[i]=e[i];return t}OC(DC.prototype,{bindAttribLocation(t,e,n){return this.i.bindAttribLocation(t,e,n)},enableVertexAttribArray(t){return this.v(),this.states.attributes[t]||(this.states.attributes[t]={}),this.states.attributes[t].enable=!0,this.i.enableVertexAttribArray(t)},disableVertexAttribArray(t){return this.v(),this.states.attributes[t]||(this.states.attributes[t]={}),this.states.attributes[t].enable=!1,this.i.disableVertexAttribArray(t)},getActiveAttrib(t,e){return this.i.getActiveAttrib(t,e)},getActiveUniform(t,e){return this.i.getActiveUniform(t,e)},getAttribLocation(t,e){return this.i.getAttribLocation(t,e)},getUniformLocation(t,e){return this.i.getUniformLocation(t,e)},getVertexAttrib(t,e){return this.v(),this.i.getVertexAttrib(t,e)},getVertexAttribOffset(t,e){return this.v(),this.i.getVertexAttribOffset(t,e)},uniformBlockBinding(t,e,n){return this.v(),this.i.uniformBlockBinding(t,e,n)},B(t,...e){const n=this.states.program;if(!n)return!1;let i=t.fid;void 0===i&&(i=t.fid=n.fid++);const o=n.cachedUniforms[i];return!!function(t,e){if(!t)return!1;const n=e.length;for(let i=0;i<n;i++)if(t[i]&&void 0!==t[i].length){const n=t[i].length;for(let o=0;o<n;o++)if(t[i][o]!==e[i][o])return!1}else if(t[i]!==e[i])return!1;return!0}(o,e)||(n.cachedUniforms[i]=function(t,e){t=t||new Array(e.length);const n=e.length;for(let i=0;i<n;i++)t[i]=void 0!==e[i].length?HC(t[i]||[],e[i]):e[i];return t}(o,e),!1)},uniformMatrix2fv(t,e,n){this.B(t,e,n)||(this.v(),this.i.uniformMatrix2fv(t,e,n))},uniformMatrix3fv(t,e,n){this.B(t,e,n)||(this.v(),this.i.uniformMatrix3fv(t,e,n))},uniformMatrix4fv(t,e,n){t?(n=this.C(n),this.B(t,e,n)||this.i.uniformMatrix4fv(t,e,n)):console.warn("UniformLocation invalid, null value encountered in browser:",navigator.userAgent)},C:t=>t?(NC[0]=isNaN(t[0])?-1e30:t[0],NC[1]=isNaN(t[1])?-1e30:t[1],NC[2]=isNaN(t[2])?-1e30:t[2],NC[3]=isNaN(t[3])?-1e30:t[3],NC[4]=isNaN(t[4])?-1e30:t[4],NC[5]=isNaN(t[5])?-1e30:t[5],NC[6]=isNaN(t[6])?-1e30:t[6],NC[7]=isNaN(t[7])?-1e30:t[7],NC[8]=isNaN(t[8])?-1e30:t[8],NC[9]=isNaN(t[9])?-1e30:t[9],NC[10]=isNaN(t[10])?-1e30:t[10],NC[11]=isNaN(t[11])?-1e30:t[11],NC[12]=isNaN(t[12])?-1e30:t[12],NC[13]=isNaN(t[13])?-1e30:t[13],NC[14]=isNaN(t[14])?-1e30:t[14],NC[15]=isNaN(t[15])?-1e30:t[15],NC):t,uniform1f(t,e){return this.v(),this.i.uniform1f(t,e)},uniform1i(t,e){return this.v(),this.i.uniform1i(t,e)},uniform2f(t,e,n){return this.v(),this.i.uniform2f(t,e,n)},uniform2i(t,e,n){return this.v(),this.i.uniform2i(t,e,n)},uniform3f(t,e,n,i){return this.v(),this.i.uniform3f(t,e,n,i)},uniform3i(t,e,n,i){return this.v(),this.i.uniform3i(t,e,n,i)},uniform4f(t,e,n,i,o){return this.v(),this.i.uniform4f(t,e,n,i,o)},uniform4i(t,e,n,i,o){return this.v(),this.i.uniform4i(t,e,n,i,o)},uniform1ui(t,e){return this.v(),this.i.uniform1ui(t,e)},uniform2ui(t,e,n){return this.v(),this.i.uniform2ui(t,e,n)},uniform3ui(t,e,n,i){return this.v(),this.i.uniform3ui(t,e,n,i)},uniform4ui(t,e,n,i,o){return this.v(),this.i.uniform4ui(t,e,n,i,o)},uniform1fv(t,e,n,i){this.v(),void 0!==i?this.i.uniform1fv(t,e,n,i):void 0!==n?this.i.uniform1fv(t,e,n):this.i.uniform1fv(t,e)},uniform2fv(t,e,n,i){this.v(),void 0!==i?this.i.uniform2fv(t,e,n,i):void 0!==n?this.i.uniform2fv(t,e,n):this.i.uniform2fv(t,e)},uniform3fv(t,e,n,i){this.v(),void 0!==i?this.i.uniform3fv(t,e,n,i):void 0!==n?this.i.uniform3fv(t,e,n):this.i.uniform3fv(t,e)},uniform4fv(t,e,n,i){this.v(),void 0!==i?this.i.uniform4fv(t,e,n,i):void 0!==n?this.i.uniform4fv(t,e,n):this.i.uniform4fv(t,e)},uniform1iv(t,e,n,i){this.v(),void 0!==i?this.i.uniform1iv(t,e,n,i):void 0!==n?this.i.uniform1iv(t,e,n):this.i.uniform1iv(t,e)},uniform2iv(t,e,n,i){this.v(),void 0!==i?this.i.uniform2iv(t,e,n,i):void 0!==n?this.i.uniform2iv(t,e,n):this.i.uniform2iv(t,e)},uniform3iv(t,e,n,i){this.v(),void 0!==i?this.i.uniform3iv(t,e,n,i):void 0!==n?this.i.uniform3iv(t,e,n):this.i.uniform3iv(t,e)},uniform4iv(t,e,n,i){this.v(),void 0!==i?this.i.uniform4iv(t,e,n,i):void 0!==n?this.i.uniform4iv(t,e,n):this.i.uniform4iv(t,e)},uniform1uiv(t,e,n,i){this.v(),void 0!==i?this.i.uniform1uiv(t,e,n,i):void 0!==n?this.i.uniform1uiv(t,e,n):this.i.uniform1uiv(t,e)},uniform2uiv(t,e,n,i){this.v(),void 0!==i?this.i.uniform2uiv(t,e,n,i):void 0!==n?this.i.uniform2uiv(t,e,n):this.i.uniform2uiv(t,e)},uniform3uiv(t,e,n,i){this.v(),void 0!==i?this.i.uniform3uiv(t,e,n,i):void 0!==n?this.i.uniform3uiv(t,e,n):this.i.uniform3uiv(t,e)},uniform4uiv(t,e,n,i){this.v(),void 0!==i?this.i.uniform4uiv(t,e,n,i):void 0!==n?this.i.uniform4uiv(t,e,n):this.i.uniform4uiv(t,e)},vertexAttrib1f(t,e){return this.v(),this.i.vertexAttrib1f(t,e)},vertexAttrib2f(t,e,n){return this.v(),this.i.vertexAttrib2f(t,e,n)},vertexAttrib3f(t,e,n,i){return this.v(),this.i.vertexAttrib3f(t,e,n,i)},vertexAttrib4f(t,e,n,i,o){return this.v(),this.i.vertexAttrib4f(t,e,n,i,o)},vertexAttrib1fv(t,e){return this.v(),this.i.vertexAttrib1fv(t,e)},vertexAttrib2fv(t,e){return this.v(),this.i.vertexAttrib2fv(t,e)},vertexAttrib3fv(t,e){return this.v(),this.i.vertexAttrib3fv(t,e)},vertexAttrib4fv(t,e){return this.v(),this.i.vertexAttrib4fv(t,e)},vertexAttribI4i(t,e,n,i,o){return this.v(),this.i.vertexAttribI4i(t,e,n,i,o)},vertexAttribI4ui(t,e,n,i,o){return this.v(),this.i.vertexAttribI4ui(t,e,n,i,o)},vertexAttribI4iv(t,e){return this.v(),this.i.vertexAttribI4iv(t,e)},vertexAttribI4uiv(t,e){return this.v(),this.i.vertexAttribI4uiv(t,e)}}),OC(DC.prototype,{createVertexArray(){return this.t?this.i.createVertexArray():this.vaoOES.createVertexArrayOES()},deleteVertexArray(t){const e=this.states;return e.vao===t&&(e.vao=null),this.t?this.i.deleteVertexArray(t):this.vaoOES.deleteVertexArrayOES(t)},isVertexArray(t){return this.t?this.i.isVertexArray(t):this.vaoOES.isVertexArrayOES(t)}}),OC(DC.prototype,{drawArraysInstanced(t,e,n,i){return this.v(),this._(),this.t?this.i.drawArraysInstanced(t,e,n,i):this.angleOES.drawArraysInstancedANGLE(t,e,n,i)},drawElementsInstanced(t,e,n,i,o){return this.v(),this._(),this.t?this.i.drawElementsInstanced(t,e,n,i,o):this.angleOES.drawElementsInstancedANGLE(t,e,n,i,o)}});
/*!
   * @ispace/gl v0.108.4
   * LICENSE : UNLICENSED
   * (c) 2016-2026 ispace.com
   */
const BC=function(){if("undefined"!=typeof globalThis)return globalThis;if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("unable to locate global object")},zC=BC(),GC=zC.gl_trans__coders=zC.gl_trans__coders||{};function jC(t){var e=function(){return"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:void 0};if(e().ispace_gltf_loader)return;
/*!
  	 * @ispace/gltf-loader v0.102.8
  	 * LICENSE : UNLICENSED
  	 * (c) 2016-2026 ispace.org
  	 */var n="undefined"!=typeof Float32Array?Float32Array:Array;function i(t,e,n){var i=e[0],o=e[1],s=e[2],a=e[3],l=e[4],h=e[5],c=e[6],u=e[7],f=e[8],g=e[9],A=e[10],m=e[11],w=e[12],T=e[13],M=e[14],C=e[15],P=n[0],I=n[1],O=n[2],E=n[3];return t[0]=P*i+I*l+O*f+E*w,t[1]=P*o+I*h+O*g+E*T,t[2]=P*s+I*c+O*A+E*M,t[3]=P*a+I*u+O*m+E*C,t[4]=(P=n[4])*i+(I=n[5])*l+(O=n[6])*f+(E=n[7])*w,t[5]=P*o+I*h+O*g+E*T,t[6]=P*s+I*c+O*A+E*M,t[7]=P*a+I*u+O*m+E*C,t[8]=(P=n[8])*i+(I=n[9])*l+(O=n[10])*f+(E=n[11])*w,t[9]=P*o+I*h+O*g+E*T,t[10]=P*s+I*c+O*A+E*M,t[11]=P*a+I*u+O*m+E*C,t[12]=(P=n[12])*i+(I=n[13])*l+(O=n[14])*f+(E=n[15])*w,t[13]=P*o+I*h+O*g+E*T,t[14]=P*s+I*c+O*A+E*M,t[15]=P*a+I*u+O*m+E*C,t}function o(){var t=new n(3);return n!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function s(t,e,i){var o=new n(3);return o[0]=t,o[1]=e,o[2]=i,o}function a(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function l(t,e,n,i){return t[0]=e,t[1]=n,t[2]=i,t}function h(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t}function c(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}function u(t,e,n,i,o){return t[0]=e,t[1]=n,t[2]=i,t[3]=o,t}function f(t,e,n){var i=e[0],o=e[1],s=e[2],a=e[3];return t[0]=n[0]*i+n[4]*o+n[8]*s+n[12]*a,t[1]=n[1]*i+n[5]*o+n[9]*s+n[13]*a,t[2]=n[2]*i+n[6]*o+n[10]*s+n[14]*a,t[3]=n[3]*i+n[7]*o+n[11]*s+n[15]*a,t}function g(){var t=new n(4);return n!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)}),o(),function(){var t;t=new n(4),n!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0)}();var A,m=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t};o(),s(1,0,0),s(0,1,0),g(),g(),A=new n(9),n!=Float32Array&&(A[1]=0,A[2]=0,A[3]=0,A[5]=0,A[6]=0,A[7]=0),A[0]=1,A[4]=1,A[8]=1;let w=0;function T(t){return null==t}function M(t){return!T(t)}function C(t){return!T(t)&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}function P(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)t[e]=n[e]}return t}function I(t){switch(t){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array}throw new Error("unsupported bufferView's component type: "+t)}function O(t){return 0===t.indexOf("data:")&&t.indexOf("base64,")>0}function E(t){const e=function(t){return"undefined"!=typeof self?self.atob(t):window.atob(t)}(t.substring(t.indexOf(",")+1)),n=e.length,i=new Uint8Array(n);for(let t=0;t<n;t++)i[t]=e.charCodeAt(t);return i.buffer}const D=[],N=[],H=[],U=[0,0,0],W=function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}([]),q=[1,1,1];function X(t,e,n,i,o,s,a){const l=I(a),h=l.BYTES_PER_ELEMENT;if((0===o||o===i*h)&&s%h==0){const o=new l(e,s,n*i);return t.set(o),t}0===o&&(o=i*h);const c=new Uint8Array(i*h);for(let a=0;a<n;a++){let n=null;const u=new Uint8Array(e,o*a+s,i*h);c.set(u),n=new l(c.buffer,0,i);for(let e=0;e<i;e++)t[a*i+e]=n[e]}return t}const J="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;function Q(t,e,n){const i=new Uint8Array(t,e,n);return J.decode(i)}const Y={get:function(t,e={},n){e||(e={});const i=new AbortController,o=i.signal,s=P({},e);s.signal=o,s.method||(s.method="GET"),s.referrerPolicy=s.referrerPolicy||"origin","undefined"==typeof window||s.referrer||(s.referrer=window.location.href),n&&(t=n(t));const a=fetch(t,s).then((t=>{const n=this.t(t,e.responseType);return n.message?n:n.then((n=>"arraybuffer"===e.responseType?{data:n,cacheControl:t.headers.get("Cache-Control"),expires:t.headers.get("Expires"),contentType:t.headers.get("Content-Type")}:n)).catch((t=>{if(!t.code||t.code!==DOMException.ABORT_ERR)throw t}))})).catch((t=>{if(!t.code||t.code!==DOMException.ABORT_ERR)throw t}));return a.xhr=i,a},t:(t,e)=>200!==t.status?{status:t.status,statusText:t.statusText,message:`incorrect http request with status code(${t.status}): ${t.statusText}`}:"arraybuffer"===e?t.arrayBuffer():"json"===e?t.json():t.text(),getArrayBuffer:(t,e={},n)=>(e||(e={}),e.responseType="arraybuffer",Y.get(t,e,n)),getJSON:function(t,e={},n){return e&&e.jsonp?Y.jsonp(t):((e=e||{}).responseType="json",Y.get(t,e,n))},jsonp:function(t){const e="_ispace_jsonp_"+w++;t.match(/\?/)?t+="&callback="+e:t+="?callback="+e;let n=document.createElement("script");return n.type="text/javascript",n.src=t,new Promise((t=>{window[e]=function(i){document.getElementsByTagName("head")[0].removeChild(n),n=null,delete window[e],t(i)},document.getElementsByTagName("head")[0].appendChild(n)}))}};class R{constructor(t,e,n,i,o){this.i=t,this.decoders=e,this.o=n,this.images={},this.h={},this.u=i||{},this.l=o}requestImageFromBufferURI(t,e,n){if(this.buffers[t.id]){const i=this.m(e,this.buffers[t.id]);return this.getImageByBuffer(i,n)}if(this.h[t.id])return this.h[t.id].then((()=>{const i=this.m(e,this.buffers[t.id]);return this.getImageByBuffer(i,n)}));if(O(t.uri)){const i=this.buffers[t.id]=E(t.uri),o=this.m(e,i);return this.getImageByBuffer(o,n)}let i;const o=t.uri.indexOf("blob:")>=0;return i=t.uri.indexOf("://")>0||o?t.uri:this.rootPath+"/"+t.uri,this.h[t.id]=Y.getArrayBuffer(i,this.u,this.l).then((i=>{const o=this.buffers[t.id]=i.data,s=this.m(e,o);return this.getImageByBuffer(s,n)}))}getImageByBuffer(t,e){if(this.images[e.id])return Promise.resolve(this.images[e.id]);const n=this.decoders;if(n[e.mimeType])return n[e.mimeType](t,{supportedFormats:this.o});if("image/crn"===e.mimeType||"image/ktx2"===e.mimeType||"image/cttf"===e.mimeType)throw new Error("missing transcoder for "+e.mimeType,"");return this.p(e.id,t)}requestExternalImage(t){if(this.images[t.id])return Promise.resolve(this.images[t.id]);const e=0===t.uri.indexOf("data:image/")?t.uri:this.rootPath+"/"+t.uri;return this.h[t.id]?this.h[t.id].then((()=>this.images[t.id])):this.h[t.id]=this.p(t.id,e)}p(t,e){return new Promise(((n,i)=>{let o=e;this.l&&(o=this.l(e)),this.i(o,this.u,((o,s)=>{o?i(o):(URL.revokeObjectURL(e),this.images[t]=s,n(this.images[t]))}))}))}}const K=["SCALAR",1,"VEC2",2,"VEC3",3,"VEC4",4,"MAT2",4,"MAT3",9,"MAT4",16],$=[];class k{constructor(t,e,n,i,o){this.rootPath=t,this.gltf=e,this._=!1,this.glbBuffer=n,this.buffers={},this.requests={},this.accessors={},this.A(),this.u=i,this.l=o}T(t,e){const n=this.gltf,i=n.accessors[e];if(void 0===i.bufferView)return this.accessors[i.id]=this.M(t,e,null,0),Promise.resolve(this.accessors[i.id]);if(i&&this.accessors[i.id])return Promise.resolve(this.accessors[i.id]);return this.I(n.bufferViews[i.bufferView]).then((n=>{const{buffer:o,byteOffset:s}=n;return this.accessors[i.id]=this.M(t,e,o,s)}))}I(t){const e=this.gltf.buffers[t.buffer];if(this.buffers[e.id]){return Promise.resolve({buffer:this.buffers[e.id],byteOffset:0})}if(this.requests[e.id])return this.requests[e.id].then((()=>Promise.resolve({buffer:this.buffers[e.id],byteOffset:0})));if("binary_glTF"!==t.buffer&&"KHR_binary_glTF"!==t.buffer&&e.uri){if(O(e.uri)){const t=this.buffers[e.id]=E(e.uri);return Promise.resolve({buffer:t,byteOffset:0})}let t;const n=e.uri.indexOf("blob:")>=0;return t=e.uri.indexOf("://")>0||n?e.uri:this.rootPath+"/"+e.uri,this.requests[e.id]=Y.getArrayBuffer(t,this.u,!n&&this.l).then((i=>(n&&URL.revokeObjectURL(t),{buffer:this.buffers[e.id]=i.data,byteOffset:0})))}return Promise.resolve({buffer:this.glbBuffer.buffer,byteOffset:this.glbBuffer.byteOffset})}M(t,e,n,i=0){const o=this.gltf,s=o.accessors[e],a=void 0!==s.bufferView?o.bufferViews[s.bufferView]:{},l=(a.byteOffset||0)+i,h=this.v(s.type),c=I(s.componentType),u=a.byteStride||0,g={array:void 0,name:t,accessorName:e,byteLength:s.count*h*c.BYTES_PER_ELEMENT,componentType:s.componentType,count:s.count,type:s.type,itemSize:h,max:s.max,min:s.min,extensions:s.extensions};if(s.min&&(g.min=s.min),s.max&&(g.max=s.max),n)if(this._)g.byteStride=u,g.byteOffset=l+(s.byteOffset||0),!u||u===h*c.BYTES_PER_ELEMENT||"indices"===t||"input"===t||"output"===t||t.indexOf("morph")>=0?(g.array=this.P(n,s.count,h,l+(s.byteOffset||0),c),g.array.buffer.byteLength===g.byteLength&&(g.byteOffset=0)):g.array=new Uint8Array(n,l,a.byteLength);else if(s.interleaved){g.byteStride=0,g.byteOffset=0;const t=new c(s.count*h);if(g.array=X(t,n,s.count,h,u,l+(s.byteOffset||0),s.componentType),g.extensions&&g.extensions.WEB3D_quantized_attributes&&h>2){const t=new Float32Array(g.array.length),{decodeMatrix:e}=g.extensions.WEB3D_quantized_attributes;for(let n=0;n<g.array.length;n+=h){$[0]=g.array[n],$[1]=g.array[n+1],$[2]=g.array[n+2],$[3]=1;const i=f($,$,e);t[n]=i[0],t[n+1]=i[1],t[n+2]=i[2]}g.componentType=5126,g.array=t}}else g.byteStride=0,g.array=this.P(n,s.count,h,l+(s.byteOffset||0),c),g.byteOffset=g.array.byteOffset;else{g.array=new c(s.count);const t=g.min||g.max;t&&(g.array[0]=t[0],g.array[1]=t[1],g.array[2]=t[2])}return g}A(){const t=this.gltf.accessors;if(Array.isArray(t))for(let e=0;e<t.length;e++)for(let n=0;n<t.length;n++)e!==n&&t[e].bufferView===t[n].bufferView&&(t[e].interleaved=t[n].interleaved=!0);else for(const e in t)for(const n in t)e!==n&&t[e].bufferView===t[n].bufferView&&(t[e].interleaved=t[n].interleaved=!0)}P(t,e,n,i,o){return i%o.BYTES_PER_ELEMENT!=0&&(t=t.slice(i,i+e*n*o.BYTES_PER_ELEMENT),i=0),new o(t,i,n*e)}v(t){const e=K.indexOf(t);return K[e+1]}requestKHRTechniquesWebgl(t){const{shaders:e}=t,n=e.map((t=>{if(void 0!==t.bufferView){const e=this.gltf.bufferViews[t.bufferView],{byteLength:n}=e;return this.I(e).then((i=>{const{buffer:o,byteOffset:s}=i,a=Q(o,s+(e.byteOffset||0),n);return t.content=a,t}))}if(t.uri){if(O(t.uri)){const e=E(t.uri),n=Q(e,0,e.byteLength);return t.content=n,Promise.resolve(t)}return Y.get(this.rootPath+"/"+t.uri,this.u,this.l).then((e=>(t.content=e,t)))}return Promise.resolve(t)}));return Promise.all(n).then((()=>t))}}class L extends R{constructor(t,e,n,i,o,s,a,l){super(i,o,s,a,l),this.rootPath=t,this.gltf=e,this.requests={},this.buffers={},this.glbBuffer=n,this.accessor=new k(t,e,n,a,l)}iterate(t,e){const n=this.gltf[e];if(!n)return;let i=0;for(const e in n)t(e,n[e],i++)}createNode(t){const e={};if(M(t.name)&&(e.name=t.name),M(t.children)&&(e.children=t.children),M(t.jointName)&&(e.jointName=t.jointName),M(t.matrix)&&(e.matrix=t.matrix),M(t.rotation)&&(e.rotation=t.rotation),M(t.scale)&&(e.scale=t.scale),M(t.translation)&&(e.translation=t.translation),M(t.extras)&&(e.extras=t.extras),M(t.meshes)&&(e.mesh=t.meshes[0]),e.translation||e.rotation||e.scale){const t=function(t,e){if(e.matrix)return e.matrix;if(e.translation||e.scale||e.rotation){const n=function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t}(D,e.translation||U),o=function(t,e){var n=e[0],i=e[1],o=e[2],s=e[3],a=n+n,l=i+i,h=o+o,c=n*a,u=i*a,f=i*l,g=o*a,A=o*l,m=o*h,w=s*a,T=s*l,M=s*h;return t[0]=1-f-m,t[1]=u+M,t[2]=g-T,t[3]=0,t[4]=u-M,t[5]=1-c-m,t[6]=A+w,t[7]=0,t[8]=g+T,t[9]=A-w,t[10]=1-c-f,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}(N,e.rotation||W),s=function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}(H,e.scale||q);return i(s,o,s),i(t,n,s)}return function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}(t)}([],e);delete e.translation,delete e.rotation,delete e.scale,e.matrix=t}return e}O(t){const e={};for(const n in t){const i=t[n];let o,s;i.instanceTechnique&&i.instanceTechnique.values?(o=i.instanceTechnique,s=o.values.diffuse):(o=i,s=o.values.tex||o.values.diffuseTex||o.values.diffuse);const a={baseColorTexture:{index:s}};i.name&&(a.name=i.name),i.extensions&&(a.extensions=i.extensions),i.extras&&(a.extras=i.extras),e[n]=a}return e}N(t){if(t.bufferView||t.extensions&&(t.extensions.KHR_binary_glTF||t.extensions.binary_glTF)){const e=t.bufferView?t:t.extensions.KHR_binary_glTF||t.extensions.binary_glTF;t.extensions&&(t.mimeType=e.mimeType,t.width=e.width,t.height=e.height);const n=this.gltf.bufferViews[e.bufferView],i=this.buffers[e.bufferView]=new Uint8Array(this.glbBuffer.buffer,(n.byteOffset||0)+this.glbBuffer.byteOffset,n.byteLength);return this.getImageByBuffer(i,t)}return this.requestExternalImage(t)}S(t){const e=this.gltf.textures[t];if(!e)return null;const n=this.gltf.images[e.source];return this.N(n).then((t=>({image:{array:t.data,width:t.width,height:t.height,index:e.source,mimeType:n.mimeType,name:n.name,extras:n.extras},sampler:this.gltf.samplers[e.sampler]})))}getBaseColorTexture(t){const e=this.gltf.materials[t];let n,i;if(e.instanceTechnique&&e.instanceTechnique.values?(n=e.instanceTechnique,i=n.values.diffuse):(n=e,i=n.values.tex||n.values.diffuseTex||n.values.diffuse),void 0===i||void 0===this.gltf.textures)return null;const o=this.gltf.textures[i];if(!o)return null;return{format:o.format||6408,internalFormat:o.internalFormat||6408,type:o.type||5121,sampler:this.gltf.samplers[o.sampler],source:this.gltf.images[o.source]}}getMaterial(){return null}getAnimations(){return null}}const tt=9729;class F extends R{constructor(t,e,n,i,o,s,a,l){super(i,o,s,a,l),this.rootPath=t,this.gltf=e,this.glbBuffer=n,this.buffers={},this.requests={},this.accessor=new k(t,e,n,a,l)}iterate(t,e){const n=this.gltf[e];if(n)for(let e=0;e<n.length;e++)t(e,n[e],e)}createNode(t){const e={};return P(e,t),!M(t.weights)&&this.gltf.meshes&&M(e.mesh)?e.weights=this.gltf.meshes[e.mesh].weights:t.weights&&(e.weights=t.weights),e}S(t){const e=this.gltf.textures[t];if(!e)return null;let n=e.source;if(e.extensions&&e.extensions.EXT_texture_webp?n=e.extensions.EXT_texture_webp.source:e.extensions&&e.extensions.KHR_texture_basisu&&(n=e.extensions.KHR_texture_basisu.source),!M(n))return null;const i=this.gltf.images[n];return this.N(i).then((t=>{if(!t)return null;const n={image:{array:t.data,mipmap:t.mipmap,width:t.width,height:t.height,index:e.source,mimeType:i.mimeType,name:i.name,extensions:i.extensions,extras:i.extras}};P(n,e);const o=M(e.sampler)?this.gltf.samplers[e.sampler]:void 0;if(o&&(n.sampler=o,n.sampler.magFilter=o.magFilter||tt,n.sampler.minFilter=o.minFilter||9987,n.sampler.wrapS=o.wrapS||10497,n.sampler.wrapT=o.wrapT||10497),"image/ktx2"===n.image.mimeType&&!n.image.mipmap&&n.sampler&&n.sampler.minFilter!==tt&&9728!==n.sampler.minFilter){const t=n.sampler.minFilter;n.sampler.minFilter=9984===t||9986===t?9728:tt}return t.format&&(n.format=t.format),n}))}N(t){if(!M(t.bufferView))return this.requestExternalImage(t);{const e=this.gltf.bufferViews[t.bufferView],n=this.gltf.buffers[e.buffer];if(n.uri)return this.requestImageFromBufferURI(n,e,t);if(this.glbBuffer)return this.B(e,t)}return null}B(t,e){const n=this.m(t,this.glbBuffer.buffer,this.glbBuffer.byteOffset);return this.getImageByBuffer(n,e)}m(t,e,n){n=n||0;return new Uint8Array(e,(t.byteOffset||0)+n,t.byteLength)}R(t,e){const n=new Array(t.byteLength);for(let e=0;e<t.byteLength;e++)n[e]=String.fromCharCode(t[e]);n.join("");const i="data:"+(e=e||"image/png")+";base64,"+function(t){return"undefined"!=typeof self?self.btoa(t):window.btoa(t)}(unescape(encodeURIComponent(n)));return i}getAnimations(t){const e=[];return t.forEach((t=>{e.push(this.getSamplers(t.samplers))})),Promise.all(e).then((e=>{for(let n=0;n<e.length;n++)t[n].samplers=e[n];return t}))}getSamplers(t){const e=[];for(let n=0;n<t.length;n++)(M(t[n].input)||M(t[n].output))&&(e.push(this.accessor.T("input",t[n].input)),e.push(this.accessor.T("output",t[n].output)));return Promise.all(e).then((e=>{for(let n=0;n<e.length/2;n++)t[n].input=e[2*n],t[n].output=e[2*n+1],t[n].interpolation||(t[n].interpolation="LINEAR");return t}))}}const et="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;class V{static read(t,e=0,n=0){n||(n=t.byteLength);const i=new DataView(t,e,n),o=i.getUint32(4,!0);if(1===o)return V.readV1(i,e);if(2===o)return V.readV2(t,e);throw new Error("Unsupported glb version : "+o)}static readV1(t,e){const n=t.getUint32(8,!0),i=t.getUint32(12,!0);if(n!==t.byteLength)throw new Error("Length in GLB header is inconsistent with glb's byte length.");const o=nt(t.buffer,20+e,i);return{json:JSON.parse(o),glbBuffer:{byteOffset:20+e+i,buffer:t.buffer,byteLength:n}}}static readV2(t,e){let n,i,o;const s=new DataView(t,e+12);let a=0;for(;a+8<s.byteLength;){const l=s.getUint32(a,!0);a+=4;const h=s.getUint32(a,!0);if(a+=4,1313821514===h)n=nt(t,e+12+a,l);else if(5130562===h){o=e+12+a,i=l;break}a+=l}return{json:JSON.parse(n),glbBuffer:{byteOffset:o,buffer:t,byteLength:i}}}}function nt(t,e,n){if(et){const i=new Uint8Array(t,e,n);return et.decode(i)}return function(t){const e=t.length;let n="";for(let i=0;i<e;){let o=t[i++];if(128&o){let n=it[o>>3&7];if(!(64&o)||!n||i+n>e)return null;for(o&=63>>n;n>0;n-=1){const e=t[i++];if(128!=(192&e))return null;o=o<<6|63&e}}n+=String.fromCharCode(o)}return n}(new Uint8Array(t,e,n))}const it=[1,1,1,1,2,2,3,0],rt=[0,0,0],ot=[0,0,0,1],st=[1,1,1],at={TRANSLATION:[0,0,0],ROTATION:[0,0,0,1],SCALE:[1,1,1]},ut={PREVIOUS:null,NEXT:null,PREINDEX:null,NEXTINDEX:null,INTERPOLATION:null},ft={C(t,e,n,i,o,s,l,h){const c=M(t)?e.animations:[e.animations[0]],u={};for(let e=0;e<c.length;e++){const f=c[e],g=f.name||e;if(M(t)&&g!==t)continue;const A=f.channelsMap[n];if(A)for(let t=0;t<A.length;t++){const e=A[t];"translation"===e.target.path?(this.U(o,f.samplers[e.sampler],i,1),u.translation=a(rt,o)):"rotation"===e.target.path?(this.k(s,f.samplers[e.sampler],i,1),u.rotation=m(ot,s)):"scale"===e.target.path?(this.U(l,f.samplers[e.sampler],i,1),u.scale=a(st,l)):"weights"===e.target.path&&h&&(this.U(h,f.samplers[e.sampler],i,h.length),u.weights=h)}}return u},U(t,e,n,i){switch(e.interpolation){case"LINEAR":{const o=this.L(ut,e,n,1*i);o&&(t=function(t,e,n,i){for(let o=0;o<t.length;o++)t[o]=e[o]+i*(n[o]-e[o]);return t}(t,o.PREVIOUS,o.NEXT,o.INTERPOLATION));break}case"STEP":{const o=this.L(ut,e,n,1*i);o&&(t=function(t,e){for(let n=0;n<t.length;n++)t[n]=e[n];return t}(t,...o.PREVIOUS));break}case"CUBICSPLINE":{const o=this.L(ut,e,n,3*i);o&&(t=this.q(t,o,e.input.array,3*i));break}}return t},k(t,e,n){switch(e.interpolation){case"LINEAR":{const i=this.L(ut,e,n,1);i&&function(t,e,n,i){var o,s,a,l,h,c=e[0],u=e[1],f=e[2],g=e[3],A=n[0],m=n[1],w=n[2],T=n[3];(s=c*A+u*m+f*w+g*T)<0&&(s=-s,A=-A,m=-m,w=-w,T=-T),1-s>1e-6?(o=Math.acos(s),a=Math.sin(o),l=Math.sin((1-i)*o)/a,h=Math.sin(i*o)/a):(l=1-i,h=i),t[0]=l*c+h*A,t[1]=l*u+h*m,t[2]=l*f+h*w,t[3]=l*g+h*T}(t,i.PREVIOUS,i.NEXT,i.INTERPOLATION);break}case"STEP":{const i=this.L(ut,e,n,1);i&&(t=u(t,...i.PREVIOUS));break}case"CUBICSPLINE":{const i=this.L(ut,e,n,3);if(i){for(let t=0;t<i.PREVIOUS.length;t++)i.PREVIOUS[t]=Math.acos(i.PREVIOUS[t]),i.NEXT[t]=Math.acos(i.NEXT[t]);t=this.q(t,i,e.input.array,3);for(let e=0;e<t.length;e++)t[e]=Math.cos(t[e])}break}}return t},F(t,e){const n=t.length;let i,o,s,a=0,l=n-1,h=Math.floor((a+l)/2);for(;a<=n-1&&l>=0;){if(a===l)return null;if(t[h]<=e&&e<=t[h+1]){const n=t[h];return i=h,o=h+1,s=(e-n)/(t[h+1]-n),{preIndx:i,nextIndex:o,interpolation:s}}e<t[h]?(l=h,h=Math.floor((a+l)/2)):t[h+1]<e&&(a=h,h=Math.floor((a+l)/2))}return null},L(t,e,n,i){const o=e.input.array,s=e.output.array,a=e.output.itemSize;(n<o[0]||n>o[o.length-1])&&(n=Math.max(o[0],Math.min(o[o.length-1],n))),n===o[o.length-1]&&(n=o[0]);const l=this.F(o,n);if(!l||!l.nextIndex)return null;const{preIndx:h,nextIndex:c,interpolation:u}=l;t.PREINDEX=h,t.NEXTINDEX=c,t.INTERPOLATION=u;const f=a*i;return t.PREVIOUS=s.subarray(t.PREINDEX*f,(t.PREINDEX+1)*f),t.NEXT=s.subarray(t.NEXTINDEX*f,(t.NEXTINDEX+1)*f),t},q(t,e,n,i){const o=e.INTERPOLATION,s=n[e.PREINDEX],a=n[e.NEXTINDEX];for(let n=0;n<3;n++){const l=e.PREVIOUS[i+n],h=(a-s)*e.PREVIOUS[2*i+n],c=e.NEXT[3+n],u=(a-s)*e.NEXT[n],f=(2*Math.pow(o,3)-3*Math.pow(o,2)+1)*l+(Math.pow(o,3)-2*Math.pow(o,2)+o)*h+(2*-Math.pow(o,3)+3*Math.pow(o,2))*c+(Math.pow(o,3)-Math.pow(o,2))*u;t[n]=f}return t},getAnimationClip(t,e,n,i){const o=t.nodes[e]&&t.nodes[e].weights;return l(rt,...at.TRANSLATION),u(ot,...at.ROTATION),l(st,...at.SCALE),this.C(i,t,e,n,rt,ot,st,o)},getTimeSpan(t){if(!t.animations)return null;if(t.timeSpan)return t.timeSpan;const e=t.animations;return t.timeSpan={},e.forEach(((e,n)=>{let i=-1/0,o=1/0;const s=e.channels;for(let t=0;t<s.length;t++){const n=e.samplers[s[t].sampler].input.array;n[n.length-1]>i&&(i=n[n.length-1]),n[0]<o&&(o=n[0])}t.timeSpan[e.name||n]={max:i,min:o}})),t.timeSpan},getTimeSpanByName(t,e){const n=this.getTimeSpan(t);return n?M(e)?n[e]:n[Object.keys(n)[0]]:null}};let gt=!1;if("undefined"!=typeof OffscreenCanvas){let t;try{t=new OffscreenCanvas(2,2).getContext("2d")}catch(n){}t&&"undefined"!=typeof createImageBitmap&&(gt=!0)}const vt="undefined"==typeof document?null:document.createElement("canvas");function xt(t,e,n){const i=new Image;i.crossOrigin="",i.onload=()=>{if(!vt)return void n(new Error("There is no canvas to draw image!"));vt.width=i.width,vt.height=i.height;const t=vt.getContext("2d",{willReadFrequently:!0});t.drawImage(i,0,0,i.width,i.height);const e=t.getImageData(0,0,i.width,i.height),o={width:i.width,height:i.height,data:new Uint8Array(e.data)};n(null,o)},i.onerror=function(t){n(t)},i.src=t}const bt=[],Ct=[],Ot=30;let Gt,$t;function ne(t,e,n){Gt||(Gt=new OffscreenCanvas(2,2),$t=Gt.getContext("2d",{willReadFrequently:!0}));let i=null;if(C(t))this.options.urlModifier&&(t=this.options.urlModifier(t)),bt.push([t,e,n,this]),re();else{const e=new Blob([t]);i=createImageBitmap(e),i.then(oe.bind(this)).then((t=>{n(null,t)})).catch((t=>{console.warn(t),n(t)}))}}function re(){if(!bt.length||Ct.length>Ot)return;const t=bt.shift(),[e,n,i,o]=t;Ct.push(t),fetch(e,n).then((t=>t.arrayBuffer())).then((t=>{const e=new Blob([new Uint8Array(t)]);return createImageBitmap(e)})).then(oe.bind(o)).then((e=>{i.call(o,null,e);const n=Ct.indexOf(t);Ct.splice(n,1),re()})).catch((e=>{console.warn(e),i.call(o,e);const n=Ct.indexOf(t);Ct.splice(n,1),re()}))}function oe(t){let{width:e,height:n}=t;ae(e)||(e=he(e)),ae(n)||(n=he(n));const i=this.options.maxTextureSize;i&&(e=Math.min(i,e),n=Math.min(i,n)),Gt.width=e,Gt.height=n,$t.drawImage(t,0,0,e,n),t.close();const o=$t.getImageData(0,0,e,n);return{width:e,height:n,data:new Uint8Array(o.data)}}function ae(t){return!(t&t-1)&&0!==t}function he(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))}function ce(t,e){for(const n in t)if(t[n]===e)return n;return e}t.Ajax=Y,t.GLTFLoader=class{constructor(t,e,n){if(this.options=n||{},this.options.decoders||(this.options.decoders={}),this.u=this.options.fetchOptions||{},e.buffer instanceof ArrayBuffer){const{json:n,glbBuffer:i}=V.read(e.buffer,e.byteOffset,e.byteLength);this.D(t,n,i)}else this.D(t,e);this.V=new k(this.rootPath,this.gltf,this.glbBuffer,this.u,this.options.urlModifier),this.j()}j(){const t=this.gltf.extensionsRequired;if(t){if(t.indexOf("KHR_draco_mesh_compression")>=0&&!this.options.decoders.draco)throw new Error("KHR_draco_mesh_compression is required but @ispace/transcoders.draco is not loaded");if(t.indexOf("KHR_texture_basisu")>=0&&!this.options.decoders["image/ktx2"])throw new Error("KHR_texture_basisu is required but @ispace/transcoders.ktx2 is not loaded");if(t.indexOf("EXT_meshopt_compression")>=0)throw new Error("EXT_meshopt_compression extension is not supported yet.")}}K(){const t=this.gltf.extensions;return t&&t.KHR_techniques_webgl?this.V.requestKHRTechniquesWebgl(t.KHR_techniques_webgl).then((e=>(t.KHR_techniques_webgl=e,t))):Promise.resolve(t)}H(){if(!Array.isArray(this.gltf.programs))return;const t=this.gltf.materials;for(let e=0;e<t.length;e++)t[e]&&t[e].extensions&&t[e].extensions.KHR_technique_webgl&&(t[e].extensions.KHR_techniques_webgl=t[e].extensions.KHR_technique_webgl,delete t[e].extensions.KHR_technique_webgl);const e=this.gltf.extensions||{},n=this.gltf.techniques;e.KHR_techniques_webgl={programs:this.gltf.programs,shaders:this.gltf.shaders,techniques:n};for(let e=0;e<t.length;e++){const o=(i=t[e])&&i.extensions&&i.extensions.KHR_techniques_webgl;if(o){const{values:t,technique:e}=o,i=n[e];if(!i||!t)continue;const{uniforms:s,parameters:a}=i,l={};for(const e in t){const n=ce(s,e);l[n]=t[e],a[e]&&35678===a[e].type&&(l[n]={index:t[e]})}o.values=l}}var i;for(let t=0;t<n.length;t++){const e=n[t];if(!e)continue;const{attributes:i,uniforms:o,parameters:s}=e;if(i)for(const t in i){i[t]=s[i[t]]}if(o)for(const t in o){o[t]=s[o[t]]}delete e.parameters}return delete this.gltf.programs,delete this.gltf.shaders,delete this.gltf.techniques,this.gltf.extensions=e,e}load(t){t=t||{},this.H();const e=this.X(t),n=this.$(),i=this.G(),o=this.K();return Promise.all([e,n,i,o]).then((t=>(t[0].animations=t[1],t[0].textures=t[2],t[0].extensions=t[3],t[0].transferables=this.transferables||[],this.createChannelsMap(t[0]),t[0])))}createChannelsMap(t){const e=t.animations;if(e)for(let t=0;t<e.length;t++){const n=e[t];n.channelsMap={};for(let t=0;t<n.channels.length;t++){const e=n.channels[t];n.channelsMap[e.target.node]||(n.channelsMap[e.target.node]=[]),n.channelsMap[e.target.node].push(e)}}}getExternalResources(){const t=[];if(this.gltf){const{buffers:e,images:n}=this.gltf;for(let n=0;n<e.length;n++)e[n].uri&&e[n].uri.indexOf("data:application/octet-stream;base64")<0&&t.push({type:"buffer",uri:e[n].uri});for(let e=0;e<n.length;e++)n[e].uri&&n[e].uri.indexOf("data:image/")<0&&t.push({type:"image",uri:n[e].uri})}return t}static getAnimationClip(t,e,n,i){return ft.getAnimationClip(t,e,n,i)}static getAnimationTimeSpan(t,e){return ft.getTimeSpanByName(t,e)}static getTypedArrayCtor(t){return I(t)}static readInterleavedArray(t,e,n,i,o,s,a){return X(t,e,n,i,o,s,a)}D(t,e,n){this.gltf=e,this.glbBuffer=n,this.version=e.asset?+e.asset.version:1,this.rootPath=t,this.buffers={},this.requests={},this.options.requestImage=gt?ne.bind(this):this.options.requestImage||xt,this.options.transferable&&(this.transferables=[]),2===this.version?(this.adapter=new F(t,e,n,this.options.requestImage,this.options.decoders||{},this.options.supportedFormats||{},this.u,this.options.urlModifier),this.adapter.iterate(((t,e,n)=>{e.id="buffer_"+n}),"buffers"),this.adapter.iterate(((t,e,n)=>{e.id="image_"+n}),"images"),this.adapter.iterate(((t,e,n)=>{e.id="accessor_"+n}),"accessors")):(this.adapter=new L(t,e,n,this.options.requestImage,this.options.decoders||{},this.options.supportedFormats||{},this.u,this.options.urlModifier),this.adapter.iterate(((t,e,n)=>{e.id="accessor_"+n}),"accessors"),this.adapter.iterate(((t,e,n)=>{e.id="image_"+n}),"images"))}J(t,e){if(t.children&&t.children.length>0){if(!("number"==typeof(n=t.children[0])&&isFinite(n)||C(t.children[0])))return t;const i=t.children.map((t=>{const n=e[t];return n.nodeIndex=t,this.J(n,e)}));t.children=i}var n;return t}X(t){return this.W(t).then((t=>{const e=this.scenes=[];let n;for(const e in t)t[e]=this.J(t[e],t),t[e].nodeIndex=Number(e)?Number(e):e;this.adapter.iterate(((i,o,s)=>{const a={};o.name&&(a.name=o.name),o.nodes&&(a.nodes=o.nodes.map((e=>t[e]))),this.gltf.scene===i&&(n=s),e.push(a)}),"scenes");const i={textures:this.gltf.textures,asset:this.gltf.asset,scene:n,scenes:e,nodes:t,meshes:this.meshes,materials:this.gltf.materials,skins:this.skins,extensionsRequired:this.gltf.extensionsRequired,extensionsUsed:this.gltf.extensionsUsed};if(this.gltf.extensions&&(i.extensions=this.gltf.extensions),1===this.version){const t=this.adapter.O(this.gltf.materials);i.materials=t}return delete this.gltf.buffers,i.json=this.gltf,i}))}W(t){return this.Y(t).then((()=>{const t=this.nodes={};return this.adapter.iterate(((e,n)=>{const i=this.adapter.createNode(n,this.meshes,this.skins);t[e]=i}),"nodes"),t}))}Z(){this.skins=[];const t=[];return this.adapter.iterate(((e,n,i)=>{t.push(this.tt(n).then((t=>{t.index=i,this.skins.push(t)})))}),"skins"),t}tt(t){return this.adapter.accessor.T("inverseBindMatrices",t.inverseBindMatrices).then((e=>(t.inverseBindMatrices=e,e&&e.buffer&&this.transferables&&this.transferables.indexOf(e.buffer)<0&&this.transferables.push(e.buffer),t)))}$(){const t=this.gltf.animations;return M(t)?this.adapter.getAnimations(t):null}Y(t){this.meshes={};let e=[];return this.adapter.iterate(((n,i,o)=>{e.push(this.et(i,t).then((t=>{t.index=o,this.meshes[n]=t})))}),"meshes"),e=e.concat(this.Z()),Promise.all(e)}et(t,e){const n=t.primitives.map((t=>this.nt(t,e))).filter((t=>!!t));return Promise.all(n).then((e=>{const n={};return P(n,t),n.primitives=e,n}))}G(){const t=this.gltf.textures;if(!t)return null;const e=[];for(const n in t)e.push(this.adapter.S(n));return Promise.all(e).then((e=>{if(this.transferables)for(let t=0;t<e.length;t++){const n=e[t]&&e[t].image.array;if(n){let t;t=n instanceof ImageBitmap?n:n.buffer,t&&this.transferables.indexOf(t)<0&&this.transferables.push(t)}}if(!Array.isArray(t)){const n={},i=Object.keys(t);for(let t=0;t<e.length;t++)e[t]&&(n[i[t]]=e[t]);return n}return e}))}nt(t,e){let n;const i=[],o=t.extensions;if(M(t.targets))for(let e=0;e<t.targets.length;e++){const n=t.targets[e];for(const t in n){const o=this.adapter.accessor.T(`morphTargets_${t}_${e}`,n[t]);o&&i.push(o)}}if(o&&o.KHR_draco_mesh_compression){if(!this.options.decoders.draco&&(!this.gltf.extensionsRequired||!this.gltf.extensionsRequired.indexOf("KHR_draco_mesh_compression")<0))return null;const t=this.options.decoders.draco,{bufferView:s,attributes:a}=o.KHR_draco_mesh_compression,l=this.gltf.bufferViews[s],h=this.V.I(l).then((n=>{const{buffer:i,byteOffset:o}=n;let{byteOffset:s}=l;s||(s=0);const h=new DataView(i,o+s,l.byteLength);return t(h,{attributes:a,useUniqueIDs:!1,skipAttributeTransform:e.skipAttributeTransform}).then((t=>{const e=Object.values(t.attributes);return t.indices&&e.push(t.indices),e}))}));i.push(h),n=Promise.all(i)}else{const e=t.attributes;for(const t in e){const n=this.adapter.accessor.T(t,e[t]);n&&i.push(n)}if(M(t.indices)){const e=this.adapter.accessor.T("indices",t.indices);e&&i.push(e)}n=Promise.all(i)}return n.then((e=>{if(o&&o.KHR_draco_mesh_compression){const n=t.targets?t.targets.length:0;e[n]=e[n].concat(e.slice(0,n)),e=e[n]}let n,i;const s={attributes:e.reduce(((t,e)=>{if("indices"===e.name)n=e;else if(e.name.indexOf("morphTargets_")>-1)i=i||{},i[e.name.slice(13)]=e;else{if(!("POSITION"!==e.name||e.min&&e.max)){const t=[1/0,1/0,1/0],n=[-1/0,-1/0,-1/0],{itemSize:i,array:o}=e,s=o.length/i;for(let e=0;e<s;e++)for(let s=0;s<i;s++){const a=e*i+s;o[a]<t[s]&&(t[s]=o[a]),o[a]>n[s]&&(n[s]=o[a])}if(e.quantization){const i=e.quantization,o=i.range/(1<<i.quantizationBits),s=i.minValues;c(t,t,o),h(t,t,s),c(n,n,o),h(n,n,s)}e.min=t,e.max=n}t[e.name]=e}return this.transferables&&e.array.buffer&&this.transferables.indexOf(e.array.buffer)<0&&this.transferables.push(e.array.buffer),t}),{}),material:t.material};return n&&(s.indices=n),i&&(s.morphTargets=i),s.mode=M(t.mode)?t.mode:4,M(t.extras)&&(s.extras=t.extras),s}))}},e().ispace_gltf_loader=t}function UC(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}GC.inject=function(t){const e=t.toString(),n=e.indexOf("{")+1,i=e.substring(0,n),o=zC.gl_trans__coders=zC.gl_trans__coders||{};let s=`${i}\n    const _____getGlobal = ${BC.toString()};\n    const g___lobals = _____getGlobal()\n    const tran_____scoders = g___lobals['gl_trans__coders'] = g___lobals['gl_trans__coders'] || {};`;for(const t in o)"inject"!==t&&"getTranscoder"!==t&&"registerTranscoder"!==t&&(s+='tran_____scoders["'+t+'"] ='+o[t].toString()+"\n;");return s+="\n("+BC().ispace_gltf_loader_bundle.toString()+")({});\n",s+="\n"+e.substring(i.length),s},GC.registerTranscoder=function(t,e){GC[t]=e},GC.getTranscoder=function(t){return GC[t]},jC({});var VC={exports:{}},WC={exports:{}},ZC=function(t){return!(!t||"string"==typeof t)&&(t instanceof Array||Array.isArray(t)||t.length>=0&&(t.splice instanceof Function||Object.getOwnPropertyDescriptor(t,t.length-1)&&"String"!==t.constructor.name))},qC=Array.prototype.concat,XC=Array.prototype.slice,JC=WC.exports=function(t){for(var e=[],n=0,i=t.length;n<i;n++){var o=t[n];ZC(o)?e=qC.call(e,XC.call(o)):e.push(o)}return e};JC.wrap=function(t){return function(){return t(JC(arguments))}};var QC={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},YC=WC.exports,KC=Object.hasOwnProperty,$C=Object.create(null);for(var tS in QC)KC.call(QC,tS)&&($C[QC[tS]]=tS);var eS=VC.exports={to:{},get:{}};function nS(t,e,n){return Math.min(Math.max(e,t),n)}function iS(t){var e=Math.round(t).toString(16).toUpperCase();return e.length<2?"0"+e:e}eS.get=function(t){var e,n;switch(t.substring(0,3).toLowerCase()){case"hsl":e=eS.get.hsl(t),n="hsl";break;case"hwb":e=eS.get.hwb(t),n="hwb";break;default:e=eS.get.rgb(t),n="rgb"}return e?{model:n,value:e}:null},eS.get.rgb=function(t){if(!t)return null;var e,n,i,o=[0,0,0,1];if(e=t.match(/^#([a-f0-9]{6})([a-f0-9]{2})?$/i)){for(i=e[2],e=e[1],n=0;n<3;n++){var s=2*n;o[n]=parseInt(e.slice(s,s+2),16)}i&&(o[3]=parseInt(i,16)/255)}else if(e=t.match(/^#([a-f0-9]{3,4})$/i)){for(i=(e=e[1])[3],n=0;n<3;n++)o[n]=parseInt(e[n]+e[n],16);i&&(o[3]=parseInt(i+i,16)/255)}else if(e=t.match(/^rgba?\(\s*([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/)){for(n=0;n<3;n++)o[n]=parseInt(e[n+1],0);e[4]&&(o[3]=e[5]?.01*parseFloat(e[4]):parseFloat(e[4]))}else{if(!(e=t.match(/^rgba?\(\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/)))return(e=t.match(/^(\w+)$/))?"transparent"===e[1]?[0,0,0,0]:KC.call(QC,e[1])?((o=QC[e[1]])[3]=1,o):null:null;for(n=0;n<3;n++)o[n]=Math.round(2.55*parseFloat(e[n+1]));e[4]&&(o[3]=e[5]?.01*parseFloat(e[4]):parseFloat(e[4]))}for(n=0;n<3;n++)o[n]=nS(o[n],0,255);return o[3]=nS(o[3],0,1),o},eS.get.hsl=function(t){if(!t)return null;var e=t.match(/^hsla?\(\s*([+-]?(?:\d{0,3}\.)?\d+)(?:deg)?\s*,?\s*([+-]?[\d\.]+)%\s*,?\s*([+-]?[\d\.]+)%\s*(?:[,|\/]\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/);if(e){var n=parseFloat(e[4]);return[(parseFloat(e[1])%360+360)%360,nS(parseFloat(e[2]),0,100),nS(parseFloat(e[3]),0,100),nS(isNaN(n)?1:n,0,1)]}return null},eS.get.hwb=function(t){if(!t)return null;var e=t.match(/^hwb\(\s*([+-]?\d{0,3}(?:\.\d+)?)(?:deg)?\s*,\s*([+-]?[\d\.]+)%\s*,\s*([+-]?[\d\.]+)%\s*(?:,\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/);if(e){var n=parseFloat(e[4]);return[(parseFloat(e[1])%360+360)%360,nS(parseFloat(e[2]),0,100),nS(parseFloat(e[3]),0,100),nS(isNaN(n)?1:n,0,1)]}return null},eS.to.hex=function(){var t=YC(arguments);return"#"+iS(t[0])+iS(t[1])+iS(t[2])+(t[3]<1?iS(Math.round(255*t[3])):"")},eS.to.rgb=function(){var t=YC(arguments);return t.length<4||1===t[3]?"rgb("+Math.round(t[0])+", "+Math.round(t[1])+", "+Math.round(t[2])+")":"rgba("+Math.round(t[0])+", "+Math.round(t[1])+", "+Math.round(t[2])+", "+t[3]+")"},eS.to.rgb.percent=function(){var t=YC(arguments),e=Math.round(t[0]/255*100),n=Math.round(t[1]/255*100),i=Math.round(t[2]/255*100);return t.length<4||1===t[3]?"rgb("+e+"%, "+n+"%, "+i+"%)":"rgba("+e+"%, "+n+"%, "+i+"%, "+t[3]+")"},eS.to.hsl=function(){var t=YC(arguments);return t.length<4||1===t[3]?"hsl("+t[0]+", "+t[1]+"%, "+t[2]+"%)":"hsla("+t[0]+", "+t[1]+"%, "+t[2]+"%, "+t[3]+")"},eS.to.hwb=function(){var t=YC(arguments),e="";return t.length>=4&&1!==t[3]&&(e=", "+t[3]),"hwb("+t[0]+", "+t[1]+"%, "+t[2]+"%"+e+")"},eS.to.keyword=function(t){return $C[t.slice(0,3)]};var rS=VC.exports,oS={exports:{}},sS={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},aS={};for(var lS in sS)sS.hasOwnProperty(lS)&&(aS[sS[lS]]=lS);var hS=oS.exports={rgb:{channels:3,labels:"rgb"},hsl:{channels:3,labels:"hsl"},hsv:{channels:3,labels:"hsv"},hwb:{channels:3,labels:"hwb"},cmyk:{channels:4,labels:"cmyk"},xyz:{channels:3,labels:"xyz"},lab:{channels:3,labels:"lab"},lch:{channels:3,labels:"lch"},hex:{channels:1,labels:["hex"]},keyword:{channels:1,labels:["keyword"]},ansi16:{channels:1,labels:["ansi16"]},ansi256:{channels:1,labels:["ansi256"]},hcg:{channels:3,labels:["h","c","g"]},apple:{channels:3,labels:["r16","g16","b16"]},gray:{channels:1,labels:["gray"]}};for(var cS in hS)if(hS.hasOwnProperty(cS)){if(!("channels"in hS[cS]))throw new Error("missing channels property: "+cS);if(!("labels"in hS[cS]))throw new Error("missing channel labels property: "+cS);if(hS[cS].labels.length!==hS[cS].channels)throw new Error("channel and label counts mismatch: "+cS);var uS=hS[cS].channels,fS=hS[cS].labels;delete hS[cS].channels,delete hS[cS].labels,Object.defineProperty(hS[cS],"channels",{value:uS}),Object.defineProperty(hS[cS],"labels",{value:fS})}function dS(t,e){return Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2)+Math.pow(t[2]-e[2],2)}hS.rgb.hsl=function(t){var e,n,i=t[0]/255,o=t[1]/255,s=t[2]/255,a=Math.min(i,o,s),l=Math.max(i,o,s),h=l-a;return l===a?e=0:i===l?e=(o-s)/h:o===l?e=2+(s-i)/h:s===l&&(e=4+(i-o)/h),(e=Math.min(60*e,360))<0&&(e+=360),n=(a+l)/2,[e,100*(l===a?0:n<=.5?h/(l+a):h/(2-l-a)),100*n]},hS.rgb.hsv=function(t){var e,n,i,o,s,a=t[0]/255,l=t[1]/255,h=t[2]/255,c=Math.max(a,l,h),u=c-Math.min(a,l,h),f=function(t){return(c-t)/6/u+.5};return 0===u?o=s=0:(s=u/c,e=f(a),n=f(l),i=f(h),a===c?o=i-n:l===c?o=1/3+e-i:h===c&&(o=2/3+n-e),o<0?o+=1:o>1&&(o-=1)),[360*o,100*s,100*c]},hS.rgb.hwb=function(t){var e=t[0],n=t[1],i=t[2];return[hS.rgb.hsl(t)[0],100*(1/255*Math.min(e,Math.min(n,i))),100*(i=1-1/255*Math.max(e,Math.max(n,i)))]},hS.rgb.cmyk=function(t){var e,n=t[0]/255,i=t[1]/255,o=t[2]/255;return[100*((1-n-(e=Math.min(1-n,1-i,1-o)))/(1-e)||0),100*((1-i-e)/(1-e)||0),100*((1-o-e)/(1-e)||0),100*e]},hS.rgb.keyword=function(t){var e=aS[t];if(e)return e;var n,i=1/0;for(var o in sS)if(sS.hasOwnProperty(o)){var s=dS(t,sS[o]);s<i&&(i=s,n=o)}return n},hS.keyword.rgb=function(t){return sS[t]},hS.rgb.xyz=function(t){var e=t[0]/255,n=t[1]/255,i=t[2]/255;return[100*(.4124*(e=e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92)+.3576*(n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92)+.1805*(i=i>.04045?Math.pow((i+.055)/1.055,2.4):i/12.92)),100*(.2126*e+.7152*n+.0722*i),100*(.0193*e+.1192*n+.9505*i)]},hS.rgb.lab=function(t){var e=hS.rgb.xyz(t),n=e[0],i=e[1],o=e[2];return i/=100,o/=108.883,n=(n/=95.047)>.008856?Math.pow(n,1/3):7.787*n+16/116,[116*(i=i>.008856?Math.pow(i,1/3):7.787*i+16/116)-16,500*(n-i),200*(i-(o=o>.008856?Math.pow(o,1/3):7.787*o+16/116))]},hS.hsl.rgb=function(t){var e,n,i,o,s,a=t[0]/360,l=t[1]/100,h=t[2]/100;if(0===l)return[s=255*h,s,s];e=2*h-(n=h<.5?h*(1+l):h+l-h*l),o=[0,0,0];for(var c=0;c<3;c++)(i=a+1/3*-(c-1))<0&&i++,i>1&&i--,o[c]=255*(s=6*i<1?e+6*(n-e)*i:2*i<1?n:3*i<2?e+(n-e)*(2/3-i)*6:e);return o},hS.hsl.hsv=function(t){var e=t[0],n=t[1]/100,i=t[2]/100,o=n,s=Math.max(i,.01);return n*=(i*=2)<=1?i:2-i,o*=s<=1?s:2-s,[e,100*(0===i?2*o/(s+o):2*n/(i+n)),100*((i+n)/2)]},hS.hsv.rgb=function(t){var e=t[0]/60,n=t[1]/100,i=t[2]/100,o=Math.floor(e)%6,s=e-Math.floor(e),a=255*i*(1-n),l=255*i*(1-n*s),h=255*i*(1-n*(1-s));switch(i*=255,o){case 0:return[i,h,a];case 1:return[l,i,a];case 2:return[a,i,h];case 3:return[a,l,i];case 4:return[h,a,i];case 5:return[i,a,l]}},hS.hsv.hsl=function(t){var e,n,i,o=t[0],s=t[1]/100,a=t[2]/100,l=Math.max(a,.01);return i=(2-s)*a,n=s*l,[o,100*(n=(n/=(e=(2-s)*l)<=1?e:2-e)||0),100*(i/=2)]},hS.hwb.rgb=function(t){var e,n,i,o,s,a,l,h=t[0]/360,c=t[1]/100,u=t[2]/100,f=c+u;switch(f>1&&(c/=f,u/=f),i=6*h-(e=Math.floor(6*h)),1&e&&(i=1-i),o=c+i*((n=1-u)-c),e){default:case 6:case 0:s=n,a=o,l=c;break;case 1:s=o,a=n,l=c;break;case 2:s=c,a=n,l=o;break;case 3:s=c,a=o,l=n;break;case 4:s=o,a=c,l=n;break;case 5:s=n,a=c,l=o}return[255*s,255*a,255*l]},hS.cmyk.rgb=function(t){var e=t[1]/100,n=t[2]/100,i=t[3]/100;return[255*(1-Math.min(1,t[0]/100*(1-i)+i)),255*(1-Math.min(1,e*(1-i)+i)),255*(1-Math.min(1,n*(1-i)+i))]},hS.xyz.rgb=function(t){var e,n,i,o=t[0]/100,s=t[1]/100,a=t[2]/100;return n=-.9689*o+1.8758*s+.0415*a,i=.0557*o+-.204*s+1.057*a,e=(e=3.2406*o+-1.5372*s+-.4986*a)>.0031308?1.055*Math.pow(e,1/2.4)-.055:12.92*e,n=n>.0031308?1.055*Math.pow(n,1/2.4)-.055:12.92*n,i=i>.0031308?1.055*Math.pow(i,1/2.4)-.055:12.92*i,[255*(e=Math.min(Math.max(0,e),1)),255*(n=Math.min(Math.max(0,n),1)),255*(i=Math.min(Math.max(0,i),1))]},hS.xyz.lab=function(t){var e=t[0],n=t[1],i=t[2];return n/=100,i/=108.883,e=(e/=95.047)>.008856?Math.pow(e,1/3):7.787*e+16/116,[116*(n=n>.008856?Math.pow(n,1/3):7.787*n+16/116)-16,500*(e-n),200*(n-(i=i>.008856?Math.pow(i,1/3):7.787*i+16/116))]},hS.lab.xyz=function(t){var e,n,i;e=t[1]/500+(n=(t[0]+16)/116),i=n-t[2]/200;var o=Math.pow(n,3),s=Math.pow(e,3),a=Math.pow(i,3);return n=o>.008856?o:(n-16/116)/7.787,e=s>.008856?s:(e-16/116)/7.787,i=a>.008856?a:(i-16/116)/7.787,[e*=95.047,n*=100,i*=108.883]},hS.lab.lch=function(t){var e,n=t[0],i=t[1],o=t[2];return(e=360*Math.atan2(o,i)/2/Math.PI)<0&&(e+=360),[n,Math.sqrt(i*i+o*o),e]},hS.lch.lab=function(t){var e,n=t[1];return e=t[2]/360*2*Math.PI,[t[0],n*Math.cos(e),n*Math.sin(e)]},hS.rgb.ansi16=function(t){var e=t[0],n=t[1],i=t[2],o=1 in arguments?arguments[1]:hS.rgb.hsv(t)[2];if(0===(o=Math.round(o/50)))return 30;var s=30+(Math.round(i/255)<<2|Math.round(n/255)<<1|Math.round(e/255));return 2===o&&(s+=60),s},hS.hsv.ansi16=function(t){return hS.rgb.ansi16(hS.hsv.rgb(t),t[2])},hS.rgb.ansi256=function(t){var e=t[0],n=t[1],i=t[2];return e===n&&n===i?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(n/255*5)+Math.round(i/255*5)},hS.ansi16.rgb=function(t){var e=t%10;if(0===e||7===e)return t>50&&(e+=3.5),[e=e/10.5*255,e,e];var n=.5*(1+~~(t>50));return[(1&e)*n*255,(e>>1&1)*n*255,(e>>2&1)*n*255]},hS.ansi256.rgb=function(t){if(t>=232){var e=10*(t-232)+8;return[e,e,e]}var n;return t-=16,[Math.floor(t/36)/5*255,Math.floor((n=t%36)/6)/5*255,n%6/5*255]},hS.rgb.hex=function(t){var e=(((255&Math.round(t[0]))<<16)+((255&Math.round(t[1]))<<8)+(255&Math.round(t[2]))).toString(16).toUpperCase();return"000000".substring(e.length)+e},hS.hex.rgb=function(t){var e=t.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);if(!e)return[0,0,0];var n=e[0];3===e[0].length&&(n=n.split("").map((function(t){return t+t})).join(""));var i=parseInt(n,16);return[i>>16&255,i>>8&255,255&i]},hS.rgb.hcg=function(t){var e,n=t[0]/255,i=t[1]/255,o=t[2]/255,s=Math.max(Math.max(n,i),o),a=Math.min(Math.min(n,i),o),l=s-a;return e=l<=0?0:s===n?(i-o)/l%6:s===i?2+(o-n)/l:4+(n-i)/l+4,e/=6,[360*(e%=1),100*l,100*(l<1?a/(1-l):0)]},hS.hsl.hcg=function(t){var e=t[1]/100,n=t[2]/100,i=1,o=0;return(i=n<.5?2*e*n:2*e*(1-n))<1&&(o=(n-.5*i)/(1-i)),[t[0],100*i,100*o]},hS.hsv.hcg=function(t){var e=t[2]/100,n=t[1]/100*e,i=0;return n<1&&(i=(e-n)/(1-n)),[t[0],100*n,100*i]},hS.hcg.rgb=function(t){var e=t[1]/100,n=t[2]/100;if(0===e)return[255*n,255*n,255*n];var i,o=[0,0,0],s=t[0]/360%1*6,a=s%1,l=1-a;switch(Math.floor(s)){case 0:o[0]=1,o[1]=a,o[2]=0;break;case 1:o[0]=l,o[1]=1,o[2]=0;break;case 2:o[0]=0,o[1]=1,o[2]=a;break;case 3:o[0]=0,o[1]=l,o[2]=1;break;case 4:o[0]=a,o[1]=0,o[2]=1;break;default:o[0]=1,o[1]=0,o[2]=l}return[255*(e*o[0]+(i=(1-e)*n)),255*(e*o[1]+i),255*(e*o[2]+i)]},hS.hcg.hsv=function(t){var e=t[1]/100,n=e+t[2]/100*(1-e),i=0;return n>0&&(i=e/n),[t[0],100*i,100*n]},hS.hcg.hsl=function(t){var e=t[1]/100,n=t[2]/100*(1-e)+.5*e,i=0;return n>0&&n<.5?i=e/(2*n):n>=.5&&n<1&&(i=e/(2*(1-n))),[t[0],100*i,100*n]},hS.hcg.hwb=function(t){var e=t[1]/100,n=e+t[2]/100*(1-e);return[t[0],100*(n-e),100*(1-n)]},hS.hwb.hcg=function(t){var e=1-t[2]/100,n=e-t[1]/100,i=0;return n<1&&(i=(e-n)/(1-n)),[t[0],100*n,100*i]},hS.apple.rgb=function(t){return[t[0]/65535*255,t[1]/65535*255,t[2]/65535*255]},hS.rgb.apple=function(t){return[t[0]/255*65535,t[1]/255*65535,t[2]/255*65535]},hS.gray.rgb=function(t){return[t[0]/100*255,t[0]/100*255,t[0]/100*255]},hS.gray.hsl=hS.gray.hsv=function(t){return[0,0,t[0]]},hS.gray.hwb=function(t){return[0,100,t[0]]},hS.gray.cmyk=function(t){return[0,0,0,t[0]]},hS.gray.lab=function(t){return[t[0],0,0]},hS.gray.hex=function(t){var e=255&Math.round(t[0]/100*255),n=((e<<16)+(e<<8)+e).toString(16).toUpperCase();return"000000".substring(n.length)+n},hS.rgb.gray=function(t){return[(t[0]+t[1]+t[2])/3/255*100]};var gS=oS.exports,pS=gS;function AS(t){var e=function(){for(var t={},e=Object.keys(pS),n=e.length,i=0;i<n;i++)t[e[i]]={distance:-1,parent:null};return t}(),n=[t];for(e[t].distance=0;n.length;)for(var i=n.pop(),o=Object.keys(pS[i]),s=o.length,a=0;a<s;a++){var l=o[a],h=e[l];-1===h.distance&&(h.distance=e[i].distance+1,h.parent=i,n.unshift(l))}return e}function mS(t,e){return function(n){return e(t(n))}}function yS(t,e){for(var n=[e[t].parent,t],i=pS[e[t].parent][t],o=e[t].parent;e[o].parent;)n.unshift(e[o].parent),i=mS(pS[e[o].parent][o],i),o=e[o].parent;return i.conversion=n,i}var _S=gS,vS=function(t){for(var e=AS(t),n={},i=Object.keys(e),o=i.length,s=0;s<o;s++){var a=i[s];null!==e[a].parent&&(n[a]=yS(a,e))}return n},xS={};Object.keys(_S).forEach((function(t){xS[t]={},Object.defineProperty(xS[t],"channels",{value:_S[t].channels}),Object.defineProperty(xS[t],"labels",{value:_S[t].labels});var e=vS(t);Object.keys(e).forEach((function(n){var i=e[n];xS[t][n]=function(t){var e=function(e){if(null==e)return e;arguments.length>1&&(e=Array.prototype.slice.call(arguments));var n=t(e);if("object"==typeof n)for(var i=n.length,o=0;o<i;o++)n[o]=Math.round(n[o]);return n};return"conversion"in t&&(e.conversion=t.conversion),e}(i),xS[t][n].raw=function(t){var e=function(e){return null==e?e:(arguments.length>1&&(e=Array.prototype.slice.call(arguments)),t(e))};return"conversion"in t&&(e.conversion=t.conversion),e}(i)}))}));var bS=rS,wS=xS,TS=[].slice,MS=["keyword","gray","hex"],CS={};Object.keys(wS).forEach((function(t){CS[TS.call(wS[t].labels).sort().join("")]=t}));var SS={};function PS(t,e){if(!(this instanceof PS))return new PS(t,e);if(e&&e in MS&&(e=null),e&&!(e in wS))throw new Error("Unknown model: "+e);var n,i;if(null==t)this.model="rgb",this.color=[0,0,0],this.valpha=1;else if(t instanceof PS)this.model=t.model,this.color=t.color.slice(),this.valpha=t.valpha;else if("string"==typeof t){var o=bS.get(t);if(null===o)throw new Error("Unable to parse color from string: "+t);this.model=o.model,this.color=o.value.slice(0,i=wS[this.model].channels),this.valpha="number"==typeof o.value[i]?o.value[i]:1}else if(t.length){this.model=e||"rgb";var s=TS.call(t,0,i=wS[this.model].channels);this.color=ES(s,i),this.valpha="number"==typeof t[i]?t[i]:1}else if("number"==typeof t)t&=16777215,this.model="rgb",this.color=[t>>16&255,t>>8&255,255&t],this.valpha=1;else{this.valpha=1;var a=Object.keys(t);"alpha"in t&&(a.splice(a.indexOf("alpha"),1),this.valpha="number"==typeof t.alpha?t.alpha:0);var l=a.sort().join("");if(!(l in CS))throw new Error("Unable to parse color from object: "+JSON.stringify(t));this.model=CS[l];var h=wS[this.model].labels,c=[];for(n=0;n<h.length;n++)c.push(t[h[n]]);this.color=ES(c)}if(SS[this.model])for(i=wS[this.model].channels,n=0;n<i;n++){var u=SS[this.model][n];u&&(this.color[n]=u(this.color[n]))}this.valpha=Math.max(0,Math.min(1,this.valpha)),Object.freeze&&Object.freeze(this)}function IS(t,e,n){return(t=Array.isArray(t)?t:[t]).forEach((function(t){(SS[t]||(SS[t]=[]))[e]=n})),t=t[0],function(i){var o;return arguments.length?(n&&(i=n(i)),(o=this[t]()).color[e]=i,o):(o=this[t]().color[e],n&&(o=n(o)),o)}}function OS(t){return function(e){return Math.max(0,Math.min(t,e))}}function ES(t,e){for(var n=0;n<e;n++)"number"!=typeof t[n]&&(t[n]=0);return t}PS.prototype={toString:function(){return this.string()},toJSON:function(){return this[this.model]()},string:function(t){var e=this.model in bS.to?this:this.rgb(),n=1===(e=e.round("number"==typeof t?t:1)).valpha?e.color:e.color.concat(this.valpha);return bS.to[e.model](n)},percentString:function(t){var e=this.rgb().round("number"==typeof t?t:1),n=1===e.valpha?e.color:e.color.concat(this.valpha);return bS.to.rgb.percent(n)},array:function(){return 1===this.valpha?this.color.slice():this.color.concat(this.valpha)},object:function(){for(var t={},e=wS[this.model].channels,n=wS[this.model].labels,i=0;i<e;i++)t[n[i]]=this.color[i];return 1!==this.valpha&&(t.alpha=this.valpha),t},unitArray:function(){var t=this.rgb().color;return t[0]/=255,t[1]/=255,t[2]/=255,1!==this.valpha&&t.push(this.valpha),t},unitObject:function(){var t=this.rgb().object();return t.r/=255,t.g/=255,t.b/=255,1!==this.valpha&&(t.alpha=this.valpha),t},round:function(t){return t=Math.max(t||0,0),new PS(this.color.map(function(t){return function(e){return function(t,e){return Number(t.toFixed(e))}(e,t)}}(t)).concat(this.valpha),this.model)},alpha:function(t){return arguments.length?new PS(this.color.concat(Math.max(0,Math.min(1,t))),this.model):this.valpha},red:IS("rgb",0,OS(255)),green:IS("rgb",1,OS(255)),blue:IS("rgb",2,OS(255)),hue:IS(["hsl","hsv","hsl","hwb","hcg"],0,(function(t){return(t%360+360)%360})),saturationl:IS("hsl",1,OS(100)),lightness:IS("hsl",2,OS(100)),saturationv:IS("hsv",1,OS(100)),value:IS("hsv",2,OS(100)),chroma:IS("hcg",1,OS(100)),gray:IS("hcg",2,OS(100)),white:IS("hwb",1,OS(100)),wblack:IS("hwb",2,OS(100)),cyan:IS("cmyk",0,OS(100)),magenta:IS("cmyk",1,OS(100)),yellow:IS("cmyk",2,OS(100)),black:IS("cmyk",3,OS(100)),x:IS("xyz",0,OS(100)),y:IS("xyz",1,OS(100)),z:IS("xyz",2,OS(100)),l:IS("lab",0,OS(100)),a:IS("lab",1),b:IS("lab",2),keyword:function(t){return arguments.length?new PS(t):wS[this.model].keyword(this.color)},hex:function(t){return arguments.length?new PS(t):bS.to.hex(this.rgb().round().color)},rgbNumber:function(){var t=this.rgb().color;return(255&t[0])<<16|(255&t[1])<<8|255&t[2]},luminosity:function(){for(var t=this.rgb().color,e=[],n=0;n<t.length;n++){var i=t[n]/255;e[n]=i<=.03928?i/12.92:Math.pow((i+.055)/1.055,2.4)}return.2126*e[0]+.7152*e[1]+.0722*e[2]},contrast:function(t){var e=this.luminosity(),n=t.luminosity();return e>n?(e+.05)/(n+.05):(n+.05)/(e+.05)},level:function(t){var e=this.contrast(t);return e>=7.1?"AAA":e>=4.5?"AA":""},isDark:function(){var t=this.rgb().color;return(299*t[0]+587*t[1]+114*t[2])/1e3<128},isLight:function(){return!this.isDark()},negate:function(){for(var t=this.rgb(),e=0;e<3;e++)t.color[e]=255-t.color[e];return t},lighten:function(t){var e=this.hsl();return e.color[2]+=e.color[2]*t,e},darken:function(t){var e=this.hsl();return e.color[2]-=e.color[2]*t,e},saturate:function(t){var e=this.hsl();return e.color[1]+=e.color[1]*t,e},desaturate:function(t){var e=this.hsl();return e.color[1]-=e.color[1]*t,e},whiten:function(t){var e=this.hwb();return e.color[1]+=e.color[1]*t,e},blacken:function(t){var e=this.hwb();return e.color[2]+=e.color[2]*t,e},grayscale:function(){var t=this.rgb().color,e=.3*t[0]+.59*t[1]+.11*t[2];return PS.rgb(e,e,e)},fade:function(t){return this.alpha(this.valpha-this.valpha*t)},opaquer:function(t){return this.alpha(this.valpha+this.valpha*t)},rotate:function(t){var e=this.hsl(),n=e.color[0];return e.color[0]=n=(n=(n+t)%360)<0?360+n:n,e},mix:function(t,e){if(!t||!t.rgb)throw new Error('Argument to "mix" was not a Color instance, but rather an instance of '+typeof t);var n=t.rgb(),i=this.rgb(),o=void 0===e?.5:e,s=2*o-1,a=n.alpha()-i.alpha(),l=((s*a==-1?s:(s+a)/(1+s*a))+1)/2,h=1-l;return PS.rgb(l*n.red()+h*i.red(),l*n.green()+h*i.green(),l*n.blue()+h*i.blue(),n.alpha()*o+i.alpha()*(1-o))}},Object.keys(wS).forEach((function(t){if(-1===MS.indexOf(t)){var e=wS[t].channels;PS.prototype[t]=function(){if(this.model===t)return new PS(this);if(arguments.length)return new PS(arguments,t);var n,i="number"==typeof arguments[e]?e:this.valpha;return new PS((n=wS[this.model][t].raw(this.color),Array.isArray(n)?n:[n]).concat(i),t)},PS[t]=function(n){return"number"==typeof n&&(n=ES(TS.call(arguments),e)),new PS(n,t)}}}));var kS=UC(PS);const RS="function"==typeof Object.assign,LS=[];function DS(t){if(RS)Object.assign.apply(Object,arguments);else for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)t[e]=n[e]}return t}function FS(t){return null==t}function NS(t){return"number"==typeof t&&!isNaN(t)}function HS(t){return!FS(t)&&("function"==typeof t||null!==t.constructor&&t.constructor===Function)}const BS=[];function zS(t,e){const n=e._get2DExtentAtRes(e.getGLRes()),i=n.getWidth(),o=n.getHeight(),s=t;ay(s);const a=Dy(LS,e.cameraLookAt);return a[2]=0,uy(s,s,a),fy(s,s,Fy(BS,i,o,1)),s}function GS(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function jS(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];if(n)for(let e=0,i=n.length;e<i;e++)t.push(n[e])}return t.length}const US={};function VS(t,e){if(!Array.isArray(e)){e=US[e]=US[e]||kS(e).unitArray()}for(let n=0;n<e.length;n++)t[n]=e[n];return 3===e.length&&(t[3]=1),t}function WS(t,e){if(!Array.isArray(e)){e=US[e]=US[e]||kS(e).unitArray()}for(let n=0;n<e.length;n++)t[n]=255*e[n];return 3===t.length&&t.push(255),t}function ZS(t,e,n=0){if(!(t&&e instanceof gh))return null;const i=t.coordinateToPointAtRes(e,t.getGLRes());return[i.x,i.y,n]}const qS=[0,0],XS=[0,0,0];let JS;class ShadowProcess{static getUniformDeclares(){const t=[],e=[];return e.push({name:"shadow_lightProjViewModelMatrix",type:"function",fn:function(e,n){return cy(t,n.shadow_lightProjViewMatrix,n.modelMatrix)}}),e}constructor(t,e){this.renderer=new cw(t),this._esmShadowThreshold=.3,this._layer=e,this._init()}resize(){const t=this.canvas;t.width=this._layer.getRenderer().canvas.width,t.height=this._layer.getRenderer().canvas.height}_init(){const t=(this._layer._getSceneConfig()||{}).shadow||{},e=this._getShadowRes(),n=this.getDefines();this._shadowPass=new PM(this.renderer,{width:e,height:e,blurOffset:t.blurOffset,defines:n}),this._shadowDisplayShader=new IM(n),this._createGround()}_getShadowRes(){let t=2048;const e=((this._layer._getSceneConfig()||{}).shadow||{}).quality;return"medium"===e?t=1024:"low"===e&&(t=512),t}getDefines(){return{HAS_SHADOWING:1,PACK_FLOAT:1,USE_ESM:1}}render(t,e,n,i,o,s,a,l,h,c){this._transformGround();const u=this._layer.getMap(),f=this._getShadowRes();let g,A;if(c||f!==this._shadowPass.width||this._shadowChanged(u,a,!!t)){f!==this._shadowPass.width&&this._shadowPass.resize(f,f),this._tempMat0=this._tempMat0||[],this._tempMat1=this._tempMat1||[];const i=cy(this._tempMat0,e,n),o=Zy(this._tempMat1,s);JS||(JS=u.getContainerExtent());let l=u.height;u.getPitch()>62&&(l=u._getVisualHeight(62));const h=JS.set(0,u.height-l,u.width,u.height).convertTo((t=>u._containerPointToPointAtRes(t,u.getGLRes()))),c=h.toArray();t&&a.addMesh(this._ground);const m=c.map((t=>[t.x,t.y,0,1])),{lightProjViewMatrix:w,shadowMap:T,blurFBO:M}=this._shadowPass.render(a,{cameraProjViewMatrix:i,lightDir:o,farPlane:m,cameraLookAt:u.cameraLookAt});g=this._lightProjViewMatrix=w,A=this._shadowMap=T,this._blurFBO=M,this._renderedShadows=a.getMeshes().reduce(((t,e)=>(e.castShadow&&e.geometry&&(t[e.uuid]={v0:e.version,v1:e.geometry.version}),t)),{}),this._renderedView={count:a.getMeshes().length-+!!t,displayShadow:!!t},this._updated=!0}else g=this._lightProjViewMatrix,A=this._shadowMap,this._updated=!1;this._projMatrix=e,this._viewMatrix=n,FS(o)&&(o=1),t&&a.getMeshes().length&&this.displayShadow(i,o,l,h);return{shadow_lightProjViewMatrix:g,shadow_shadowMap:A,shadow_opacity:o,shadow_color:i||XS,esm_shadow_threshold:this._esmShadowThreshold}}displayShadow(t,e,n,i){const o=this._lightProjViewMatrix,s=this._ground,a=this._groundLightProjViewModelMatrix||[],l=this._layer.getRenderer().canvas,h=this._texSize=this._texSize||[];h[0]=l.width,h[1]=l.height,this.renderer.render(this._shadowDisplayShader,{halton:n||qS,globalTexSize:h,projMatrix:this._projMatrix,viewMatrix:this._viewMatrix,shadow_lightProjViewModelMatrix:cy(a,o,s.localTransform),shadow_shadowMap:this._shadowMap,esm_shadow_threshold:this._esmShadowThreshold,shadow_opacity:e,color:t||XS},this._groundScene,i)}dispose(){this._shadowPass.dispose(),this._shadowDisplayShader.dispose(),this._ground&&(this._ground.geometry.dispose(),this._ground.dispose()),delete this.renderer}isUpdated(){return!1!==this._updated}_shadowChanged(t,e,n){if(!this._renderedShadows)return!0;const i=this._renderedView;if(e.getMeshes().length!==i.count||n!==i.displayShadow)return!0;const o=e.getMeshes();for(let t=0;t<o.length;t++){const e=this._renderedShadows[o[t].uuid];if(o[t].castShadow&&(o[t].hasSkinAnimation()||!e||e.v0!==o[t].version||e.v1!==o[t].geometry.version))return!0}return!1}_createGround(){const t=new Ow;t.generateBuffers(this.renderer.regl),this._ground=new aw(t),this._groundScene=new _w([this._ground])}_transformGround(){const t=this._layer.getMap(),e=zS(this._ground.localTransform,t);this._ground.setLocalTransform(e)}}const QS=[0,0],YS=new gh(0,0),KS=new gh(0,0),$S=[],tP=[],eP=[];function nP(t,e,n,i){const o=t.getGLRes(),s=t.distanceToPointAtRes(e,e,o,n?YS:null,KS);return i?s.y:s.x}const{getIBLResOnCanvas:iP,logoutIBLResOnCanvas:rP,getPBRUniforms:oP,loginIBLResOnCanvas:sP}=xC.PBRUtils,aP=[0,0],lP=[1,1],hP=[],cP=[],uP=[],fP=[],dP=[];class GroundPainter{static getGroundTransform(t,e){return zS(t,e)}constructor(t,e){this._regl=t,this.renderer=new cw(t),this._layer=e,this._loader=new dw,this._bindOnMaterialComplete=(...t)=>this._onMaterialComplete.call(this,...t),this._init();const n=this.getMap().getRenderer().canvas;sP(n,t,this.getMap())}needToRedraw(){const t=this._getUVOffsetAnim();return t&&(t[0]||t[1])}getMap(){return this._layer&&this._layer.getMap()}getSymbol(){const t=this._layer.getGroundConfig();return t&&t.symbol}isEnable(){const t=this._layer.getGroundConfig();return t&&t.enable}paint(t){if(!this.isEnable())return!1;const e=this._getShader();if(this._isInSSRPhase(t)&&e===this._fillShader)return!1;const n=this._getGroundDefines(t);n&&this._ground.setDefines(n),this._ground.material!==this.material&&this._ground.setMaterial(this.material);const i=this._layer.getGroundConfig();this._ground.ssr=(i&&i.symbol).ssr?1:0,this._transformGround();const o=this._getUniformValues(t);o.offsetFactor=t.offsetFactor,o.offsetUnits=t.offsetUnits;const s=t&&t.renderTarget&&t.renderTarget.fbo;return e===this._fillShader?(this.renderer.render(e,o,this._groundScene,s),this._layer.getRenderer().setCanvasUpdated(),!0):(e.filter=t.sceneFilter,this.renderer.render(e,o,this._groundScene,s),this._layer.getRenderer().setCanvasUpdated(),!0)}_isInSSRPhase(t){return!(!this._layer.getRenderer().isEnableSSR||!this._layer.getRenderer().isEnableSSR())&&!(!t||!t.ssr)}update(){const t=this._layer.getGroundConfig();if(!t)return;const e=t&&t.symbol,n=t.urlModifier;if(e){this._polygonFill=this._parseColor(e.polygonFill||[1,1,1,1]),this._polygonOpacity=void 0===e.polygonOpacity?1:e.polygonOpacity;const t=e.polygonPatternFile;if(t){if(!this._polygonPatternFile||this._polygonPatternFile._pattern_src!==t){const e=new Image;e.onload=()=>{this._polygonPatternFile&&this._polygonPatternFile.destroy(),this._polygonPatternFile=this._createPatternTexture(e),this._polygonPatternFile._pattern_src=t,this.setToRedraw()},e.src=n&&n(t)||t}}else this._polygonPatternFile&&(this._polygonPatternFile.destroy(),delete this._polygonPatternFile)}else this._polygonFill=[1,1,1,1],this._polygonOpacity=1,this._polygonPatternFile&&(this._polygonPatternFile.destroy(),delete this._polygonPatternFile);this._updateMaterial()}setToRedraw(){const t=this._layer.getRenderer();t&&t.setToRedraw()}dispose(){this.material&&(this.material.dispose(),delete this.material),this._ground&&(this._ground.geometry.dispose(),this._ground.material&&this._ground.material.dispose(),this._ground.dispose(),delete this._ground),this._polygonPatternFile&&(this._polygonPatternFile.destroy(),delete this._polygonPatternFile),this._fillShader&&(this._fillShader.dispose(),delete this._fillShader),this._standardShader&&(this._standardShader.dispose(),delete this._standardShader),this._disposeIblTextures()}_getShader(){const t=this._layer.getGroundConfig();if(!t||!t.renderPlugin)return this._fillShader;const e=t.renderPlugin.type;if("lit"===e)return this._standardShader;if("fill"===e)return this._fillShader;throw new Error("unsupported render plugin of "+e+" for layer ground")}_getUniformValues(t){const e=this._getCommonUniforms(t);e.polygonFill=this._polygonFill,e.polygonOpacity=this._polygonOpacity;return this._getShader()===this._fillShader&&this._polygonPatternFile&&(e.polygonPatternFile=this._polygonPatternFile),e}_getCommonUniforms(t){let e;if("lit"===this._layer.getGroundConfig().renderPlugin.type){const n=this.getMap().getRenderer().canvas,{iblTexes:i,dfgLUT:o}=iP(n);e=oP(this.getMap(),i,o,t&&t.ssr,t&&t.jitter)}else{e={projViewMatrix:this.getMap().projViewMatrix}}return this._setIncludeUniformValues(e,t),e}_setIncludeUniformValues(t,e){const n=e&&e.includes;if(n)for(const i in n)n[i]&&e[i].renderUniforms&&DS(t,e[i].renderUniforms)}_disposeIblTextures(){const t=this.getMap().getRenderer().canvas;rP(t,this.getMap())}_init(){const t=this._getExtraCommandProps(),e=ShadowProcess.getUniformDeclares(),n=[];e.push({name:"projViewModelMatrix",type:"function",fn:function(t,e){return cy(n,e.projViewMatrix,e.modelMatrix)}}),this._fillShader=new zw({vert:"attribute vec3 aPosition;\nuniform mat4 projViewModelMatrix;\nuniform mat4 modelMatrix;\n#ifdef HAS_PATTERN\n    attribute vec2 aTexCoord;\n    uniform vec2 uvScale;\n    uniform vec2 uvOffset;\n    varying vec2 vTexCoord;\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n    #include <vsm_shadow_vert>\n#endif\nvoid main () {\n    #ifdef HAS_PATTERN\n        vTexCoord = aTexCoord * uvScale + uvOffset;\n    #endif\n    vec3 position = vec3(aPosition);\n    gl_Position = projViewModelMatrix * vec4(position, 1.0);\n    #if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n        shadow_computeShadowPars(vec4(position, 1.0));\n    #endif\n}",frag:"precision mediump float;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n    #include <vsm_shadow_frag>\n#endif\n#ifdef HAS_PATTERN\n    uniform sampler2D polygonPatternFile;\n    varying vec2 vTexCoord;\n#endif\nuniform vec4 polygonFill;\nuniform float polygonOpacity;\nvoid main() {\n    #ifdef HAS_PATTERN\n        vec4 color = texture2D(polygonPatternFile, vTexCoord);\n    #else\n        vec4 color = polygonFill;\n    #endif\n    gl_FragColor = color * polygonOpacity;\n    #if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n        float shadowCoeff = shadow_computeShadow();\n        gl_FragColor.rgb = shadow_blend(gl_FragColor.rgb, shadowCoeff);\n    #endif\n}",uniforms:e,extraCommandProps:t});const i=ShadowProcess.getUniformDeclares();i.push(...eT.getUniformDeclares()),this._standardShader=new xC.StandardShader({uniforms:i,extraCommandProps:t}),this._createGround(),this.update()}_getExtraCommandProps(){const t=[0,1],e=this._layer.getRenderer().canvas;return{viewport:{x:0,y:0,width:()=>e.width,height:()=>e.height},cull:{enable:!0},depth:{enable:!0,mask:()=>{const t=this._layer.getGroundConfig();return t.depth||void 0===t.depth},range:()=>{const e=this._layer.getGroundConfig(),n=e&&e.renderPlugin.sceneConfig;return n&&n.depthRange||t},func:"<="},blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"},polygonOffset:{enable:!0,offset:{factor:(t,e)=>e.offsetFactor,units:(t,e)=>e.offsetUnits}}}}_hasIBL(){const t=this.getMap().getLightManager();return!!(t&&t.getAmbientResource())}_createGround(){const t=new Ow;t.data.aTexCoord=new Uint8Array([0,0,1,0,0,1,1,1]),t.createTangent(),t.generateBuffers(this.renderer.regl),this._ground=new aw(t,null,{castShadow:!1});const e=this._standardShader.getGeometryDefines(t);this._ground.setDefines(e),this._groundScene=new _w([this._ground])}_transformGround(){const t=this.getMap(),e=GroundPainter.getGroundTransform(this._ground.localTransform,t);this._ground.setLocalTransform(e);const n=t.getGLRes(),i=t._get2DExtentAtRes(n),o=i.getWidth(),s=i.getHeight(),a=t.cameraLookAt,l=a[0]-o,h=a[1]-s,c=this._polygonPatternFile?this._polygonPatternFile.width/this._polygonPatternFile.height:1,u=this.getSymbol(),f=this.material?this.material.get("textureOrigin"):u.polygonPatternFileOrigin,g=!!(this.material?this.material.get("uvOffsetInMeter"):u.uvOffsetInMeter),A=(this.material?this.material.get("uvOffset"):u.uvOffset)||aP,m=this.material&&this.material.get("uvScale")||lP,w=this.material?this.material.get("textureWidth"):u.polygonPatternFileWidth,T=this.material?w*(m[1]/m[0]):u.polygonPatternFileHeight,M=this._getUVOffsetAnim(),[C,P,I,O,E]=function(t,e,n,i,o,s,a,l,h,c,u){const f=t.getGLRes();i&&(YS.set(i[0],i[1]),t.coordToPointAtRes(YS,f,KS),e-=KS.x,n-=KS.y);const g=i?YS:null;c=Ov(tP,c);const A=!h&&c||QS;let m=h&&c||QS;m=Ov($S,m),m[0]&&(m[0]=nP(t,m[0],g)),m[1]&&(m[1]=nP(t,m[1],g,1));let w=.5;o&&(w=nP(t,o,g));let T=w/a;if(s&&(T=nP(t,s,g,1)),u&&(u[0]||u[1])){const e=performance.now()/1e3;let n=u[0],i=u[1];h&&(n=-nP(t,u[0],g),i=-nP(t,u[1],g,1)),u[0]&&(h?m[0]=e*n:A[0]=e*n),u[1]&&(h?m[1]=e*i:A[1]=e*i)}const M=(e+m[0])/(w/l[0]),C=(n-m[1])/(T/l[1]);return eP[0]=w/l[0],eP[1]=T/l[1],eP[2]=M,eP[3]=C,eP[4]=A,eP}(t,l,h,f,w,T,c,m,g,A,M),D=2*i.getWidth()/C,N=2*i.getHeight()/P;if(!this.material)return this._ground.setUniform("uvScale",Ev(hP,D,N)),void this._ground.setUniform("uvOffset",Ev(cP,I%1+E[0],O%1+E[1]));this._ground.setUniform("uvScale",Ev(dP,D,N)),this._ground.setUniform("uvOffset",Ev(uP,I%1+E[0],O%1+E[1])),this._ground.setUniform("uvOrigin",Ev(fP,I-I%1,O-O%1)),this._ground.setUniform("uvRotation",0)}_getGroundDefines(t){let e=!1;const n=this._ground.defines,i=this._layer._getSceneConfig&&this._layer._getSceneConfig(),o=this._layer.getGroundConfig();function s(t,i){t?n[i]||(n[i]=1,e=!0):n[i]&&(delete n[i],e=!0)}s(this._hasIBL(),"HAS_IBL_LIGHTING");s(t&&t.ssr&&o&&o.symbol&&o.symbol.ssr,"HAS_SSR");const a=t&&i&&i.shadow&&i.shadow.enable;s(a,"HAS_SHADOWING"),s(a,"USE_ESM");return s(!!this._polygonPatternFile,"HAS_PATTERN"),e?n:null}_updateMaterial(){const t=this.getSymbol()&&this.getSymbol().material;if(!t)return;const e={};let n=!1;const i=this._layer.getGroundConfig();this._loader.setURLModifier(i.urlModifier);for(const i in t)if(GS(t,i))if(i.indexOf("Texture")>0){let o=t[i];if(!o)continue;o="string"==typeof o?{url:o,wrap:"repeat"}:o,o.flipY=!0,o.min="linear mipmap linear",o.mag="linear",o.flipY=!0,e[i]=new Iw(o,this._loader),n=!0}else e[i]=t[i];this.material?(this._loadingMaterial=new xC.StandardMaterial(e),this._loadingMaterial.isReady()?this._onMaterialComplete():this._loadingMaterial.once("complete",this._bindOnMaterialComplete)):(this.material=new xC.StandardMaterial(e),this.material.once("complete",this._bindOnMaterialComplete,this)),n||this._onMaterialComplete()}_onMaterialComplete(){this._loadingMaterial&&(this.material.dispose(),this.material=this._loadingMaterial,delete this._loadingMaterial),this.setToRedraw(!0)}_createPatternTexture(t){t=rb.resizeToPowerOfTwo(t);return this._regl.texture({width:t.width,height:t.height,data:t,mag:"linear",min:"linear mipmap linear",flipY:!0,wrap:"repeat"})}_parseColor(t){return VS([],t)}_getUVOffsetAnim(){return this.material&&this.material.get("uvOffsetAnim")}getRenderMeshes(){return this._groundScene.getMeshes()}}const{createIBLTextures:gP,disposeIBLTextures:pP}=xC.PBRUtils,AP=[0,0,0],mP=[],yP=[];class EnvironmentPainter{constructor(t,e){this._maxLevel=4,this._regl=t,this.renderer=new cw(t),this._layer=e,this._init(),this._updateMode()}paint(t){if(!this.isEnable()||!this._resource)return;const e=this._getUniformValues(t);this.renderer.render(this._shader,e,null,t&&t.renderTarget&&t.renderTarget.fbo)}update(){const t=this.getMap();if(!t||!this.isEnable())return;const e=t.getLightManager(),n=e&&e.getAmbientResource();n!==this._resource&&this._iblTexes&&(pP(this._iblTexes),delete this._iblTexes),this._resource=n,this._updateMode()}dispose(){this._shader.dispose(),pP(this._iblTexes),delete this._shader,delete this._iblTexes,delete this._resource}getMap(){return this._layer.getMap()}_updateMode(){if(!this._resource)return;const t=this._layer._getSceneConfig().environment||{};this._shader.setMode(t.toneMapping,t.mode?1:0)}isEnable(){const t=this._layer._getSceneConfig();return this._hasIBL()&&t&&t.environment&&t.environment.enable}_hasIBL(){const t=this.getMap().getLightManager();return!!(t&&t.getAmbientResource())}_getUniformValues(){const t=this.getMap(),e=this.getMap().getLightManager(),n=e&&e.getAmbientLight();let i=this._iblTexes;i||(i=this._iblTexes=gP(this._regl,t));const o=this._layer.getRenderer().canvas,s=this._layer._getSceneConfig().environment||{},a=s.level||0,l=i.prefilterMap.width,h=this._transform=this._transform||[],c=s.brightness||0,u=s.intensity||1;return Dy(mP,n&&n.hsv||AP),c&&(mP[2]+=c),yP[0]=o.width,yP[1]=o.height,{cubeMap:i.prefilterMap,bias:a,size:l/Math.pow(2,Math.max(0,a-1)),environmentExposure:NS(n&&n.exposure)?n.exposure:1,backgroundIntensity:u,diffuseSPH:i.sh,viewMatrix:t.viewMatrix,projMatrix:t.projMatrix,resolution:yP,hsv:mP,transformMatrix:ey(h,n&&Math.PI/180*-n.orientation||0)}}_init(){const t=this.getMap();if(t.on("updatelights",this.update,this),this._shader=new oT,t.options.lights){const t=this.getMap().getLightManager().getAmbientResource();this._resource=t}}}const _P=[],vP=[.03,.03,.03],xP=[],bP=[],wP=[],TP=[1,1,1],MP=[-1200,-1200,0],CP=[1200,1200,1e3],SP={min:[],max:[]},PP=my([],Q_([],90,0,0),[0,0,0]);class RainPainer{constructor(t,e){this._regl=t,this.renderer=new cw(t),this._layer=e,this._timer=new Clock,this._init()}getMap(){return this._layer&&this._layer.getMap()}_init(){const t=this._layer.getRenderer().canvas;this._shader=new zw({vert:"attribute vec3 aPosition;\nattribute vec3 aNormal;\nattribute vec2 aTexCoord;\nuniform mat4 projMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 positionMatrix;\nuniform vec3 cameraPosition;\nuniform float top;\nuniform float bottom;\nuniform float time;\nvarying vec2 vTexCoord;\n#include <get_output>\nfloat angle(float x, float y){\n    return atan(y, x);\n}\nvec2 getFoot(vec2 camera, vec2 normal, vec2 pos) {\n    vec2 position = vec2(0.0, 0.0);\n    float distanceLen = distance(pos, normal);\n    float a = angle(camera.x - normal.x, camera.y - normal.y);\n    pos.x > normal.x ? a -= 0.785 : a += 0.785;\n    position.x = cos(a) * distanceLen;\n    position.y = sin(a) * distanceLen;\n    return position + normal;\n    return position;\n}\nvoid main()\n{\n    vec4 localPosition = getPosition(aPosition);\n    mat4 localPositionMatrix = getPositionMatrix();\n    vec2 foot = getFoot(vec2(cameraPosition.x, cameraPosition.z), vec2(aNormal.x, aNormal.z), vec2(localPosition.x, localPosition.z));\n    float height = top - bottom;\n    float y = aNormal.y - bottom - height * time;\n    y = y + (y < 0.0 ? height : 0.0);\n    float ratio = (1.0 - y / height) * (1.0 - y / height);\n    y = height * (1.0 - ratio);\n    y += bottom;\n    y += aPosition.y - aNormal.y;\n    localPosition = vec4( foot.x, y, foot.y , 1.0);\n    gl_Position = projMatrix * modelViewMatrix * localPositionMatrix * localPosition;\n    vTexCoord = aTexCoord;\n}",frag:"precision mediump float;\nvarying vec2 vTexCoord;\nuniform vec3 diffuse;\nuniform float opacity;\nuniform sampler2D rainMap;\nvoid main() {\n    vec4 rainColor = texture2D(rainMap, vTexCoord);\n    vec4 diffuseColor = vec4(diffuse, opacity);\n    diffuseColor *= rainColor;\n    gl_FragColor = diffuseColor;\n}",uniforms:[{name:"modelViewMatrix",type:"function",fn:function(t,e){return cy(_P,e.viewMatrix,e.modelMatrix)}}],extraCommandProps:{viewport:{x:0,y:0,width:()=>t.width,height:()=>t.height},depth:{enable:!0,mask:!1,func:"less",range:[0,1]},blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}}),this._createScene()}_createScene(){const t=this._regl.texture({width:2,height:2});if(this._mesh=this._createRain(),!this._mesh)return;this._scene=new _w(this._mesh);const e=this._getRainConfig();e.rainTexture?this._creatRainTexture(e.rainTexture).then((t=>{this._mesh.material.set("rainMap",t)})):(this._mesh.material.set("rainMap",t),console.warn("should set rain texture."))}_createRain(){const t=this.getMap(),e=this._getRainConfig();if(!e)return null;this._fixZoom=t.getZoom();const n=this._getFixExtent(),i=this._rainDensity=e.density,o=this._rainWidth=e.rainWidth||1,s=this._rainHeight=e.rainHeight||1,a=[],l=[],h=[],c=[];for(let t=0;t<i;t++){const e={};e.x=Math.random()*(n.max[0]-n.min[0])+n.min[0],e.y=Math.random()*(n.max[2]-n.min[2])+n.min[2],e.z=Math.random()*(n.max[1]-n.min[1])+n.min[1];const i=(n.max[2]-n.min[2])/37.5*s,u=i/3*o;a.push(e.x+u,e.y+i,e.z,e.x-u,e.y+i,e.z,e.x-u,e.y,e.z,e.x+u,e.y,e.z),l.push(e.x,e.y-i/2,e.z,e.x,e.y-i/2,e.z,e.x,e.y-i/2,e.z,e.x,e.y-i/2,e.z),h.push(1,1,0,1,0,0,1,0),c.push(4*t+0,4*t+1,4*t+2,4*t+0,4*t+2,4*t+3)}const u={};u.POSITION=a,u.NORMAL=l,u.TEXCOORD_0=h;const f=new vb(u,c,0,{primitive:"triangles",positionAttribute:"POSITION",normalAttribute:"NORMAL",uv0Attribute:"TEXCOORD_0"});f.generateBuffers(this.renderer.regl);const g=new Qb({rainMap:this._regl.texture({width:2,height:2}),diffuse:e.color||[1,1,1],opacity:e.opacity||1}),A=new aw(f,g);return A.setUniform("top",n.max[2]),A.setUniform("bottom",n.min[2]),this._transformRain(A),A.transparent=!0,A}_creatRainTexture(t){const e=new Image;return e.src=this._rainTexture=t,new Promise(((t,n)=>{e.onload=()=>{const n=this._regl.texture({mag:"linear",min:"linear mipmap nearest",wrapS:"clamp",wrapT:"clamp",data:e});t(n)},e.onerror=t=>{n(t)}}))}paint(t){if(!this._scene)return;const e=this._getRainConfig(),n={},i=this.getMap();n.projMatrix=i.projMatrix,n.viewMatrix=i.viewMatrix,n.cameraPosition=i.cameraPosition;const o=e.speed||1,s=this._timer.getElapsedTime()/(2/o)%1;n.time=s,this._mesh.material.set("diffuse",e.color||TP),this._mesh.material.set("opacity",e.opacity||1),this._transformRain(this._mesh);this.renderer.render(this._shader,n,this._scene,t&&t.renderTarget&&t.renderTarget.fbo),this._layer.getRenderer().setCanvasUpdated()}_transformRain(t){const e=this.getMap(),n=e.coordinateToPointAtRes(e.getCenter(),e.getGLRes()),i=e.getGLScale()/e.getGLScale(this._fixZoom),o=Fy(bP,i,i,i),s=By(o,vP,o),a=ay(wP),l=this._getRainConfig(),h=e.getBearing();xy(a,Q_(xP,l.windDirectionX||0,l.windDirectionY||0,90-h),[n.x,n.y,0],s),cy(a,a,PP),t.setLocalTransform(a)}setToRedraw(){const t=this._layer.getRenderer();t&&t.setToRedraw()}update(){const t=this._getRainConfig();if(t){if(this._mesh||this._createScene(),t.density!==this._rainDensity||t.rainWidth!==this._rainWidth||t.rainHeight!==this._rainHeight){const t=this._mesh.material.get("rainMap");this._mesh.geometry.dispose(),this._mesh.dispose(),this._scene.clear(),this._mesh=this._createRain(),this._mesh.material.set("rainMap",t),this._scene.setMeshes(this._mesh)}t.rainTexture!==this._rainTexture&&this._creatRainTexture(t.rainTexture).then((t=>{this._mesh.material.set("rainMap",t)}))}}dispose(){this._mesh&&(this._mesh.geometry.dispose(),this._mesh.material&&this._mesh.material.dispose(),this._mesh.dispose(),delete this._mesh),this._shader&&(this._shader.dispose(),delete this._shader)}isEnable(){const t=this._getRainConfig();return t&&t.enable}_getRainConfig(){const t=this._layer.getWeatherConfig();return t&&t.rain}_getFixExtent(){const t=16.685648411389433-this.getMap().getZoom();return Gy(SP.min,MP,Math.pow(2,t)),Gy(SP.max,CP,Math.pow(2,t)),SP}}class Clock{constructor(t){this.autoStart=void 0===t||t,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}start(){this.startTime=("undefined"==typeof performance?Date:performance).now(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0}stop(){this.getElapsedTime(),this.running=!1,this.autoStart=!1}getElapsedTime(){return this.getDelta(),this.elapsedTime}getDelta(){let t=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){const e=("undefined"==typeof performance?Date:performance).now();t=(e-this.oldTime)/1e3,this.oldTime=e,this.elapsedTime+=t}return 0}}const IP=[],OP=[.03,.03,.03],EP=[],kP=[],RP=[],LP=my([],Q_([],90,0,0),[0,0,0]);class SnowPainter{constructor(t,e){this._regl=t,this._layer=e,this._init()}_init(){const t=this._layer.getRenderer().canvas;this._shader=new zw({vert:"#include <gl2_vert>\nattribute vec3 aPosition;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\nuniform mat4 projMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 positionMatrix;\n#include <get_output>\nvoid main()\n{\n    mat4 localPositionMatrix = getPositionMatrix();\n    vec4 localPosition = getPosition(aPosition);\n    gl_Position = projMatrix * modelViewMatrix * localPositionMatrix * localPosition;\n    vTexCoord = aTexCoord;\n}",frag:"#if __VERSION__ == 100\n  #ifdef GL_OES_standard_derivatives\n    #extension GL_OES_standard_derivatives : enable\n  #endif\n#endif\nprecision mediump float;\n#include <gl2_frag>\nprecision mediump float;\nuniform sampler2D perlinTexture;\nvarying vec2 vTexCoord;\nfloat lerp(float a, float b, float w) {\n    return a + w * (b - a);\n}\nvoid main() {\n    float snowIntense = texture2D(perlinTexture, vTexCoord).r;\n    vec3 fixedC = vec3(1.0, 1.0, 1.0);\n    float r = lerp(0.5, fixedC.x, snowIntense);\n    float g = lerp(0.5, fixedC.y, snowIntense);\n    float b = lerp(0.5, fixedC.z, snowIntense);\n    glFragColor = vec4(r, g, b, 1.0);\n    #if __VERSION__ == 100\n        gl_FragColor = glFragColor;\n    #endif\n}",uniforms:[{name:"modelViewMatrix",type:"function",fn:function(t,e){return cy(IP,e.viewMatrix,e.modelMatrix)}}],extraCommandProps:{viewport:{x:0,y:0,width:()=>t.width,height:()=>t.height}}}),this._shader.version=300,this._scene=new _w,this._groundMask=this._createGroundMask(),this._scene.setMeshes(this._groundMask),this.renderer=new cw(this._regl);const e=this._getSnowConfig();e&&(e.snowGroundTexture?this._createSnowTexture(e.snowGroundTexture):(this._groundNormal=this._regl.texture({width:2,height:2}),console.warn("should set snow ground texture.")))}render(t){this._groundNormal&&this._groundMask.material.set("perlinTexture",this._groundNormal);const e=this._layer.getMap();this._transformMask(e);this.renderer.render(this._shader,{projMatrix:e.projMatrix,viewMatrix:e.viewMatrix,cameraPosition:e.cameraPosition},this._scene,t&&t.renderTarget&&t.renderTarget.fbo),this._layer.getRenderer().setCanvasUpdated()}_transformMask(t){const e=t.coordinateToPointAtRes(t.getCenter(),t.getGLRes()),n=t.getGLScale()/t.getGLScale(this._fixZoom),i=Fy(kP,n,n,n),o=By(i,OP,i),s=ay(RP);xy(s,Q_(EP,0,0,0),[e.x,e.y,.005],o),cy(s,s,LP),this._groundMask.setLocalTransform(s)}_createSnowTexture(t){const e=new Image;e.onload=()=>{this._groundNormal=this._regl.texture({mag:"linear",min:"linear mipmap nearest",wrapS:"repeat",wrapT:"repeat",data:e})},e.onerror=t=>{console.log(t)},e.src=this._snowGroundTexture=t}_createGroundMask(){const t=this._layer.getMap();this._fixZoom=t.getZoom();const e=16e3*Math.pow(2,16.685648411389433-this._fixZoom),n={};n.POSITION=[-e,0,-e,e,0,-e,-e,0,e,e,0,e],n.NORMAL=[0,1,0,0,1,0,0,1,0,0,1,0],n.TEXCOORD_0=[0,0,1,0,0,1,1,1];const i=new vb(n,[3,1,0,0,2,3],0,{positionAttribute:"POSITION",normalAttribute:"NORMAL",uv0Attribute:"TEXCOORD_0"});i.generateBuffers(this._regl);const o=new Qb({perlinTexture:this._regl.texture({with:2,height:2})});return new aw(i,o)}getMeshes(){return this._groundMask}dispose(){this._groundMask&&(this._groundMask.geometry.dispose(),this._groundMask.material&&this._groundMask.material.dispose(),this._groundMask.dispose(),delete this._groundMask),this._shader&&(this._shader.dispose(),delete this._shader)}update(){const t=this._getSnowConfig();t&&t.snowGroundTexture===!this._snowGroundTexture&&this._createSnowTexture(t.snowGroundTexture)}isEnable(){const t=this._getSnowConfig();return t&&t.enable}_getSnowConfig(){const t=this._layer.getWeatherConfig();return t&&t.snow}}const DP=[];class WeatherPainter{constructor(t,e,n){this._regl=t,this._layer=e,this._config=n,this._init()}_init(){this.renderer=new cw(this._regl);const t=this._layer.getRenderer(),e=this._viewport={x:0,y:0,width:()=>t.canvas?t.canvas.width:1,height:()=>t.canvas?t.canvas.height:1};this._width=e.width,this._height=e.height,this._fbo=this._regl.framebuffer({color:this._regl.texture({width:t.canvas?t.canvas.width:1,height:t.canvas?t.canvas.height:1,wrap:"clamp",mag:"linear",min:"linear"}),depth:!0}),this.EMPTY_TEXTURE=this._regl.texture({with:2,height:2}),this._rainPainter=new RainPainer(this._regl,this._layer),this._rainRipplesPass=new xT(this._regl,e),this._snowPainter=new SnowPainter(this._regl,this._layer),this._fogPass=new dT(this._regl,e,this._layer),this._weatherShader=new gT,this._weatherShader.version=300}getMap(){return this._layer&&this._layer.getMap()}renderScene(t){this.renderSnowMask(t),this.renderRain(t)}renderRain(t){this.isEnableRain()&&this._rainPainter.paint(t)}renderSnowMask(t){if(!this.isEnableSnow()||!this._showSnowGround())return;const e=this.getMap();this._snowPainter.render(t,e)}paint(t,e){if(!e||!e.length)return t;this._resize();const n=this._layer.getWeatherConfig(),i={};if(this.isEnableRain()?(i.ripplesMap=this._renderRainRipples(),this._weatherShader.shaderDefines.HAS_RAIN=1):delete this._weatherShader.shaderDefines.HAS_RAIN,this.isEnableSnow()?(this._weatherShader.shaderDefines.HAS_SNOW=1,i.snowIntensity=rb.isNumber(n.snow.snowIntensity)?n.snow.snowIntensity:.5,e.forEach((t=>{t.defines.HAS_SNOW=1}))):(delete this._weatherShader.shaderDefines.HAS_SNOW,e.forEach((t=>{delete t.defines.HAS_SNOW}))),this.isEnableFog()){i.fogColor=n.fog.color||[.9,.9,.9],this._weatherShader.shaderDefines.HAS_FOG=1}else delete this._weatherShader.shaderDefines.HAS_FOG;return this._weatherShader.setDefines(this._weatherShader.shaderDefines),i.mixFactorMap=this._renderMixFactor(e)||this.EMPTY_TEXTURE,i.sceneMap=t,i.time=this._getTimeSpan()/1e3,i.resolution=Ev(DP,this._fbo.width,this._fbo.height),this.renderer.render(this._weatherShader,i,null,this._fbo),this._renderMeshes=e,this._fbo}_renderMixFactor(t){const e={},n=this.getMap(),i=n.getZoom(),o=Math.pow(2,16.685648411389433-i),s=this._layer.getWeatherConfig(),a=s.fog;if(!a||!a.enable)return null;const l=a.start||.1,h=a.end||100;e.projMatrix=n.projMatrix,e.viewMatrix=n.viewMatrix,e.cameraPosition=n.cameraPosition,e.fogDist=[l*o,h*o],e.rainDepth=n.altitudeToPoint(s.rain&&s.rain.rainDepth||.1,n.getGLRes());const c=this._fogPass.render(t,e);return this._layer.getRenderer()._getFBOColor(c)}_renderRainRipples(){const t=this.getMap(),e=this._layer.getWeatherConfig(),n=e.rain.rippleRadius||24,i={};i.projMatrix=t.projMatrix,i.viewMatrix=t.viewMatrix,i.time=this._getTimeSpan()/1e3,i.rippleRadius=n,i.density=e.rain.density||2e3;return this._rainRipplesPass.render(t,i)}_getTimeSpan(){if(!this._layer)return 0;if(void 0===this._currentFrameTime&&(this._currentFrameTime=0),this.isPlaying()){const t=this._layer.getRenderer();this._currentFrameTime=t.getFrameTime()}return this._currentFrameTime}isEnable(){const t=this._layer.getWeatherConfig();return t&&t.enable}isEnableRain(){const t=this._layer.getWeatherConfig();return t&&t.enable&&t.rain&&t.rain.enable}isEnableFog(){const t=this._layer.getWeatherConfig();return t&&t.enable&&t.fog&&t.fog.enable}isEnableSnow(){const t=this._layer.getWeatherConfig();return t&&t.enable&&t.snow&&t.snow.enable}_showSnowGround(){const t=this._layer.getWeatherConfig();return this.isEnableSnow()&&!1===t.snow.showGround}isPlaying(){const t=this._layer.getWeatherConfig();return!!t&&!1!==t.playing}_hasWeather(){return this.isEnableRain()||this.isEnableFog()||this.isEnableSnow()}update(){!this.isEnable()&&this._renderMeshes&&this._renderMeshes.forEach((t=>{delete t.defines.HAS_SNOW,delete t.defines.HAS_RAIN,delete t.defines.HAS_FOG})),this.isEnableRain()&&(this._rainPainter=this._rainPainter||new RainPainer(this._regl,this._layer),this._rainPainter.update()),this.isEnableSnow()&&(this._snowPainter=this._snowPainter||new SnowPainter(this._regl,this._layer),this._snowPainter.update())}getShadowMeshes(){return this._snowPainter.getMeshes()}_resize(){const t=this._width(),e=this._height();!this._fbo||this._fbo.width===t&&this._fbo.height===e||this._fbo.resize(t,e)}dispose(){this._fbo&&this._fbo.destroy(),this._weatherShader&&(this._weatherShader.dispose(),delete this._weatherShader),this._rainPainter&&(this._rainPainter.dispose(),delete this._rainPainter),this._snowPainter&&(this._snowPainter.dispose(),delete this._snowPainter)}}const FP=[],NP=t=>!!t.bloom,HP=t=>!!t.ssr;class PostProcess{constructor(t,e){this._regl=t,this._layer=e,this._renderer=new cw(t),this._fxaaShader=new Zw,this._copyShader=new aT,this._ssrPass=new eT(this._regl)}setContextIncludes(){}bloom(t,e,n,i,o,s,a){this._bloomPass||(this._bloomPass=new $w(this._regl));const l=this._layer.getRenderer()._getFBOColor(this._bloomFBO);return this._bloomPass.render(t,l,i,o,s,e,n,a)}drawBloom(t){const e=this._layer.getRenderer(),n=this._regl,i=this._bloomFBO;if(i){const{width:e,height:o}=t;i.width===e&&i.height===o||i.resize(e,o),n.clear({color:[0,0,0,0],framebuffer:i})}else{const e=this._createFBOInfo(t);this._bloomFBO=n.framebuffer(e)}const o=e.getFrameTime(),s=e.getFrameEvent(),a=e.getFrameContext(),l=a.renderMode,h=a.sceneFilter,c=a.renderTarget;a.isPostProcess=!0,a.renderMode="default",a.sceneFilter=NP,a.renderTarget={fbo:this._bloomFBO,getFramebuffer:BP,getDepthTexture:zP};const u=e.glCtx;return u.resetDrawCalls(),e.forEachRenderer(s?t=>{e.clearStencil(t,i),t.drawOnInteracting(s,o,a)}:t=>{e.clearStencil(t,i),t.draw(o,a)}),delete a.isPostProcess,a.renderMode=l,a.sceneFilter=h,a.renderTarget=c,u.getDrawCalls()}genSsrMipmap(t,e){const n=this._layer.getMap().projViewMatrix;this._ssrPass.genMipMap(t,e,n)}getPrevSsrProjViewMatrix(){return this._ssrPass&&this._ssrPass.getPrevProjViewMatrix()}drawSSR(t,e,n){n&&this._ssrPass.copyDepthTex(t);const i=this._layer.getRenderer(),o=i.getFrameTime(),s=i.getFrameEvent(),a=i.getFrameContext();a.isPostProcess=!0,a.ssr=this.getSSRContext();const l=a.renderMode,h=a.sceneFilter;a.renderMode="default",a.sceneFilter=HP,a.renderTarget.fbo=e;const c=i.glCtx;let u=!1;i.forEachRenderer(s?t=>{i.clearStencil(t,e),u||(c.resetDrawCalls(),u=!0),t.drawOnInteracting(s,o,a)}:t=>{i.clearStencil(t,e),u||(c.resetDrawCalls(),u=!0),t.draw(o,a)});const f=i.drawGround();return delete a.ssr,delete a.isPostProcess,a.renderMode=l,a.sceneFilter=h,this._ssrPainted=c.getDrawCalls()>0,f}getSSRUniforms(){const t=this._layer._getSceneConfig(),e=t&&t.postProcess,n=this._layer.getMap();return this._ssrPass.getSSRUniforms(n,e.ssr.factor,e.ssr.quality)}getSSRContext(){const t=this._layer._getSceneConfig(),e=t&&t.postProcess,n=this._layer.getMap(),i=this._ssrPass.getSSRUniforms(n,e.ssr.factor,e.ssr.quality);if(!i)return null;return{renderUniforms:i,defines:{HAS_SSR:1}}}fxaa(t,e,n,i,o,s,a,l,h,c,u,f){!t||t.width===e.fbo&&t.height===e.height||t.resize(e.width,e.height);const g={};l?g.HAS_OUTLINE_TEX=1:delete g.HAS_OUTLINE_TEX,this._fxaaShader.setDefines(g),this._renderer.render(this._fxaaShader,{textureSource:e,resolution:Ev(FP,e.width,e.height),enableFXAA:n,enableToneMapping:i,enableSharpen:o,pixelRatio:s,sharpFactor:a,textureOutline:l,highlightFactor:h,outlineFactor:c,outlineWidth:u,outlineColor:f},null,t)}renderFBOToScreen(t,e,n,i){this._copyFBOSize||(this._copyFBOSize=[]),this._copyFBOSize[0]=t.width,this._copyFBOSize[1]=t.height;const o=this._layer.getRenderer();this._renderer.render(this._copyShader,{texture:t.color&&o._getFBOColor(t)||t,size:this._copyFBOSize,enableSharpen:+!!e,sharpFactor:n,pixelRatio:i})}postprocess(t,e,n){this._postProcessShader||(this._postProcessShader=new qw);const i=this._layer&&this._layer.getRenderer(),o=n||i._getFBOColor(t);return e.resolution=Ev(FP,o.width,o.height),e.textureSource=o,e.timeGrain=performance.now(),this._renderer.render(this._postProcessShader,e),this._target}dispose(){this._bloomFBO&&(this._bloomFBO.destroy(),delete this._bloomFBO),this._bloomPass&&(this._bloomPass.dispose(),delete this._bloomPass),this._postProcessShader&&(this._postProcessShader.dispose(),delete this._postProcessShader),this._fxaaShader&&(this._fxaaShader.dispose(),delete this._fxaaShader),this._copyShader&&(this._copyShader.dispose(),delete this._copyShader)}_createFBOInfo(t,e){const{width:n,height:i}=this._layer.getRenderer().canvas,o=this._regl;let s;s=this._layer.getRenderer()._isUseMultiSample()?o.renderbuffer({width:n,height:i,samples:this._layer.options.multiSamples,format:"rgba8"}):o.texture({min:"nearest",mag:"nearest",format:e||"rgba",width:n,height:i});const a={width:n,height:i,colors:[s]};return t&&(a.depthStencil=t),a}}function BP(t){return t._framebuffer.framebuffer}function zP(t){return t.depthStencil._texture.texture}class AnalysisShader extends Ww{constructor(t){super({vert:"#if __VERSION__ == 300\n\t#define attribute in\n\t#define varying out\n#endif\nattribute vec2 aPosition;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\nvoid main()\n{\n  gl_Position = vec4(aPosition, 0., 1.);\n  vTexCoord = aTexCoord;\n}",frag:"#if __VERSION__ == 100\n  #ifdef GL_OES_standard_derivatives\n    #extension GL_OES_standard_derivatives : enable\n  #endif\n#endif\nprecision mediump float;\n#include <gl2_frag>\nvarying vec2 vTexCoord;\n#ifdef HAS_FLOODANALYSE\n    uniform vec3 flood_waterColor;\n    uniform float flood_waterOpacity;\n    uniform sampler2D floodMap;\n#endif\n#ifdef HAS_SKYLINE\n    uniform sampler2D skylineMap;\n#endif\n#ifdef HAS_VIEWSHED\n    uniform vec4 viewshed_visibleColor;\n    uniform vec4 viewshed_invisibleColor;\n    uniform sampler2D viewshedMap;\n#endif\n#ifdef HAS_INSIGHT\n    uniform vec4 insight_visibleColor;\n    uniform vec4 insight_invisibleColor;\n    uniform sampler2D insightMap;\n#endif\n#ifdef HAS_CUT\n    uniform sampler2D meshesMap;\n    uniform sampler2D invisibleMap;\n#endif\n#ifdef HAS_EXCAVATE\n    uniform sampler2D excavateMap;\n#endif\n#ifdef HAS_CROSSCUT\n    uniform sampler2D crosscutMap;\n    uniform vec4 cutLineColor;\n#endif\n#ifdef HAS_HEIGHTLIMIT\n    uniform vec3 limitColor;\n    uniform sampler2D heightLimitMap;\n#endif\nuniform sampler2D sceneMap;\nvoid main() {\n    vec4 sceneColor = texture2D(sceneMap, vTexCoord);\n    glFragColor = sceneColor;\n    #ifdef HAS_VIEWSHED\n        vec4 viewshedColor = texture2D(viewshedMap, vTexCoord);\n        if (viewshedColor.r > 0.99) {\n            glFragColor = vec4(mix(viewshed_invisibleColor.rgb, sceneColor.rgb, viewshed_invisibleColor.a), sceneColor.a);\n        } else if (viewshedColor.g > 0.99) {\n            glFragColor = vec4(mix(viewshed_visibleColor.rgb, sceneColor.rgb, viewshed_visibleColor.a), sceneColor.a);\n        } else if (viewshedColor.a < 0.01) {\n            glFragColor = vec4(viewshedColor.rgb, 1.0);\n        }\n    #endif\n    #ifdef HAS_FLOODANALYSE\n        vec4 floodColor = texture2D(floodMap, vTexCoord);\n        if (floodColor.r > 0.0) {\n            glFragColor = vec4(mix(glFragColor.rgb, flood_waterColor, flood_waterOpacity), glFragColor.a);\n        }\n    #endif\n    #ifdef HAS_SKYLINE\n        vec4 skylineColor = texture2D(skylineMap, vTexCoord);\n        if (skylineColor.r > 0.0 || skylineColor.g > 0.0 || skylineColor.b > 0.0) {\n            glFragColor = skylineColor;\n        }\n    #endif\n    #ifdef HAS_INSIGHT\n        vec4 insightColor = texture2D(insightMap, vTexCoord);\n        if (insightColor.g > 0.0) {\n            glFragColor = insight_visibleColor;\n        } else if (insightColor.r > 0.0) {\n            glFragColor = insight_invisibleColor;\n        }\n    #endif\n    #ifdef HAS_CUT\n        vec4 cutColor = texture2D(invisibleMap, vTexCoord);\n        vec4 meshesMapColor = texture2D(meshesMap, vTexCoord);\n        if (cutColor.r == 1.0 && cutColor.g == 0.0 && cutColor.b == 0.0) {\n            glFragColor = meshesMapColor;\n        } else if (cutColor.r == 0.0 && cutColor.g == 1.0 && cutColor.b == 0.0) {\n            glFragColor = meshesMapColor;\n        } else if (cutColor.r == 0.0 && cutColor.g == 0.0 && cutColor.b == 1.0) {\n          glFragColor = sceneColor;\n        }\n    #endif\n    #ifdef HAS_EXCAVATE\n        vec4 excavateColor = texture2D(excavateMap, vTexCoord);\n        if (excavateColor.r == 1.0 && excavateColor.g == 0.0 && excavateColor.b == 0.0) {\n          glFragColor = sceneColor;\n        }  else {\n          glFragColor = excavateColor;\n        }\n    #endif\n    #ifdef HAS_CROSSCUT\n        vec4 crosscutColor = texture2D(crosscutMap, vTexCoord);\n        if (crosscutColor.r > 0.0) {\n            glFragColor = vec4(mix(cutLineColor.rgb, glFragColor.rgb, 0.99), glFragColor.a);\n        }\n    #endif\n    #ifdef HAS_HEIGHTLIMIT\n        vec4 heightLimitColor = texture2D(heightLimitMap, vTexCoord);\n        if (heightLimitColor.r > 0.0) {\n            glFragColor = vec4(mix(limitColor, glFragColor.rgb, 0.6), glFragColor.a);\n        }\n    #endif\n    #if __VERSION__ == 100\n        gl_FragColor = glFragColor;\n    #endif\n}",extraCommandProps:{viewport:t,cull:{enable:!0},blend:{enable:!0,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one minus src alpha",dstAlpha:"one minus src alpha"},equation:"add"}}})}}class AnalysisPainter{constructor(t,e,n){this._regl=t,this._layer=e,this._config=n,this._init()}_init(){this.renderer=new cw(this._regl);const t=this._layer.getRenderer(),e=this._viewport={x:0,y:0,width:()=>t.canvas?t.canvas.width:1,height:()=>t.canvas?t.canvas.height:1};this._fbo=this._regl.framebuffer({color:this._regl.texture({width:t.canvas?t.canvas.width:1,height:t.canvas?t.canvas.height:1,wrap:"clamp",mag:"linear",min:"linear"}),depth:!0}),this._shader=new AnalysisShader(e)}getMap(){return this._layer&&this._layer.getMap()}paint(t,e){if(!e&&e.length)return t;this._resize();const n={},i=this._layer._analysisTaskList;if(!this._hasAnalysis())return t;this._regl.clear({color:[0,0,0,0],depth:1,stencil:0,framebuffer:this._fbo}),delete this._shader.shaderDefines.HAS_FLOODANALYSE,delete this._shader.shaderDefines.HAS_VIEWSHED,delete this._shader.shaderDefines.HAS_SKYLINE,delete this._shader.shaderDefines.HAS_INSIGHT,delete this._shader.shaderDefines.HAS_CUT,delete this._shader.shaderDefines.HAS_CROSSCUT,delete this._shader.shaderDefines.HAS_HEIGHTLIMIT;for(let t=0;t<i.length;t++){const o=i[t];if(!o.isEnable())continue;const s=o.getDefines();DS(this._shader.shaderDefines,s);const a=this.getMap(),l=a.width,h=a.height,c=this._getToAnalysisMeshes(e,o.getExcludeLayers()),u=o.renderAnalysis(c,l,h);u&&DS(n,u)}return n.sceneMap=t,this._shader.setDefines(this._shader.shaderDefines),this.renderer.render(this._shader,n,null,this._fbo),this._fbo}_getToAnalysisMeshes(t,e){let n=[];for(let i=0;i<t.length;i++){if(e.indexOf(t[i].getId())>-1)continue;const o=t[i].getRenderer();if(o&&o.getAnalysisMeshes){const t=o.getAnalysisMeshes();t.forEach((t=>{t.setUniform("useAnalysis",1)})),n=n.concat(t)}}return n}_resize(){const t=hs.isFunction(this._viewport.width.data)?this._viewport.width.data():this._viewport.width,e=hs.isFunction(this._viewport.height.data)?this._viewport.height.data():this._viewport.height;!this._fbo||this._fbo.width===t&&this._fbo.height===e||this._fbo.resize(t,e)}_hasAnalysis(){const t=this._layer&&this._layer._analysisTaskList;if(!t)return!1;for(let e=0;e<t.length;e++)if(t[e].isEnable())return!0;return!1}}const GP=[],jP=new gh(0,0);let UP={};class ScanEffectPainter{constructor(t,e){this._regl=t,this._layer=e,this._init()}_init(){this.renderer=new cw(this._regl);const t=this._layer.getRenderer(),e=this._viewport={x:0,y:0,width:()=>t.canvas?t.canvas.width:1,height:()=>t.canvas?t.canvas.height:1};this._width=e.width,this._height=e.height,this._fbo=this._regl.framebuffer({color:this._regl.texture({width:t.canvas?t.canvas.width:1,height:t.canvas?t.canvas.height:1,wrap:"clamp",mag:"linear",min:"linear"}),depth:!0}),this.EMPTY_TEXTURE=this._regl.texture({with:2,height:2}),this._shader=new uT,this._pass=new CT(this._regl,e,this._layer),this._shader.version=300}getMap(){return this._layer&&this._layer.getMap()}paint(t,e){if(!e||!e.length)return t;const n=this._layer.getMap();this._resize();const i=this._layer.getScanEffectConfig(),o={},{effects:s}=i,a=n.getGLRes(),l=[];this._effectLength!==s.length&&(UP={});for(let t=0;t<s.length;t++){const{center:e,radius:i,speed:o,color:h,direction:c,height:u}=s[t],f=VP(e),g=n.coordinateToPointAtRes(f,a,jP).toArray(),A=n.distanceToPointAtRes(i,0,a).x,m="vertical"===c?1:0,w=n.altitudeToPoint(u||0,a);UP[t]=UP[t]||[];const T=Ym(UP[t],g[0],g[1],A,o,h[0],h[1],h[2],m,w);l.push(T)}const h={projMatrix:n.projMatrix,viewMatrix:n.viewMatrix,effectInfos:l,effectTime:this._getTimeSpan()/1e3},c=this._layer.getRenderer(),u=this._pass.render(e,h)||this.EMPTY_TEXTURE;return o.scanEffectMap=c._getFBOColor(u),o.sceneMap=t,o.resolution=Ev(GP,this._fbo.width,this._fbo.height),this.renderer.render(this._shader,o,null,this._fbo),this._fbo}_getTimeSpan(){if(!this._layer)return 0;if(void 0===this._currentFrameTime&&(this._currentFrameTime=0),this.isPlaying()){const t=this._layer.getRenderer();this._currentFrameTime=t.getFrameTime()}return this._currentFrameTime}isPlaying(){const t=this._layer.getScanEffectConfig();return!!t&&!1!==t.playing}_resize(){const t=this._width(),e=this._height();!this._fbo||this._fbo.width===t&&this._fbo.height===e||this._fbo.resize(t,e)}dispose(){this._fbo&&this._fbo.destroy(),this._shader&&(this._shader.dispose(),delete this._shader),this._pass&&this._pass.dispose()}}function VP(t){return Array.isArray(t)?(jP.x=t[0],jP.y=t[1],jP):t}const WP=[0,0,0,0],ZP=[1,1,-1],qP=[0,0],XP=t=>!t.bloom&&!t.ssr,JP=t=>!t.bloom,QP=t=>!t.ssr;function YP(t){return"number"==typeof t&&!isNaN(t)}function KP(t){return t._framebuffer.framebuffer}function $P(t){return t.depthStencil._texture.texture}function tI(t,e,n){return null==t[e]?n:t[e]}class TerrainWorkerConnection extends Em.Actor{constructor(t){super("@ispace/terrain"),this.mapId=t}checkUrl(t){return t&&hs.isString(t)?hs.getAbsoluteURL(t):t}fetchTerrain(t,e,n){t=this.checkUrl(t);const i=e.tileImage,o={actorId:this.actorId,mapId:this.mapId,command:"fetchTerrain",params:{url:t,origin:location.origin,terrainWidth:e.terrainWidth,type:e.type,accessToken:e.accessToken,cesiumIonTokenURL:e.cesiumIonTokenURL,error:e.error,colors:e.colors,tileSize:e.tileSize,tileImage:i}},s=[];i&&s.push(i),this.send(o,s,((t,e)=>{t?n(t):n(t,e)}))}abortTerrain(t,e){this.broadcast({actorId:this.actorId,mapId:this.mapId,command:"abortTerrain",params:{url:t}},null,e)}addLayer(t,e,n){this.broadcast({actorId:this.actorId,mapId:this.mapId,layerId:t,command:"addLayer",params:{}},null,n)}createTerrainMesh(t,e){this.send({actorId:this.actorId,command:"createTerrainMesh",params:t},[t.terrainHeights.data.buffer],((t,n)=>{t?e(t):e(t,n)}))}removeLayer(t,e,n){this.broadcast({mapId:this.mapId,layerId:t,command:"removeLayer"},null,n)}}class Martini{constructor(t=257){this.gridSize=t;const e=t-1;if(e&e-1)throw new Error(`Expected grid size to be 2^n+1, got ${t}.`);this.numTriangles=e*e*2-2,this.numParentTriangles=this.numTriangles-e*e,this.indices=new Uint32Array(this.gridSize*this.gridSize),this.coords=new Uint16Array(4*this.numTriangles);for(let t=0;t<this.numTriangles;t++){let n=t+2,i=0,o=0,s=0,a=0,l=0,h=0;for(1&n?s=a=l=e:i=o=h=e;(n>>=1)>1;){const t=i+s>>1,e=o+a>>1;1&n?(s=i,a=o,i=l,o=h):(i=s,o=a,s=l,a=h),l=t,h=e}const c=4*t;this.coords[c+0]=i,this.coords[c+1]=o,this.coords[c+2]=s,this.coords[c+3]=a}}createTile(t){return new Tile(t,this)}}class Tile{constructor(t,e){const n=e.gridSize;if(t.length!==n*n)throw new Error(`Expected terrain data of length ${n*n} (${n} x ${n}), got ${t.length}.`);this.terrain=t,this.martini=e,this.errors=new Float32Array(t.length),this.update()}update(){const{numTriangles:t,numParentTriangles:e,coords:n,gridSize:i}=this.martini,{terrain:o,errors:s}=this;for(let a=t-1;a>=0;a--){const t=4*a,l=n[t+0],h=n[t+1],c=n[t+2],u=n[t+3],f=l+c>>1,g=h+u>>1,A=f+g-h,m=g+l-f,w=g*i+f,T=Math.abs((o[h*i+l]+o[u*i+c])/2-o[w]);if(s[w]=Math.max(s[w],T),a<e){s[w]=Math.max(s[w],s[(h+m>>1)*i+(l+A>>1)],s[(u+m>>1)*i+(c+A>>1)])}}}getMesh(t=0){const{gridSize:e,indices:n}=this.martini,{errors:i}=this;let o=0,s=0;const a=e-1;function l(a,h,c,u,f,g){const A=a+c>>1,m=h+u>>1;Math.abs(a-f)+Math.abs(h-g)>1&&i[m*e+A]>t?(l(f,g,a,h,A,m),l(c,u,f,g,A,m)):(n[h*e+a]=n[h*e+a]||++o,n[u*e+c]=n[u*e+c]||++o,n[g*e+f]=n[g*e+f]||++o,s++)}n.fill(0),l(0,0,a,a,a,0),l(a,a,0,0,0,a);const h=new Uint16Array(2*o),c=new Uint32Array(3*s);let u=0;function f(o,s,a,l,g,A){const m=o+a>>1,w=s+l>>1;if(Math.abs(o-g)+Math.abs(s-A)>1&&i[w*e+m]>t)f(g,A,o,s,m,w),f(a,l,g,A,m,w);else{const t=n[s*e+o]-1,i=n[l*e+a]-1,f=n[A*e+g]-1;h[2*t]=o,h[2*t+1]=s,h[2*i]=a,h[2*i+1]=l,h[2*f]=g,h[2*f+1]=A,c[u++]=t,c[u++]=i,c[u++]=f}}return f(0,0,a,a,a,0),f(a,a,0,0,0,a),{vertices:h,triangles:c}}getMeshWithSkirts(t=0,e){const{gridSize:n,indices:i}=this.martini,{errors:o}=this;let s=0,a=0;const l=n-1;let h,c,u=0;const f=[],g=[],A=[],m=[];function w(e,T,M,C,P,I){const O=e+M>>1,E=T+C>>1;Math.abs(e-P)+Math.abs(T-I)>1&&o[E*n+O]>t?(w(P,I,e,T,O,E),w(M,C,P,I,O,E)):(h=T*n+e,c=C*n+M,u=I*n+P,0===i[h]&&(0===e?f.push(s):e===l&&g.push(s),0===T?A.push(s):T===l&&m.push(s),i[h]=++s),0===i[c]&&(0===M?f.push(s):M===l&&g.push(s),0===C?A.push(s):C===l&&m.push(s),i[c]=++s),0===i[u]&&(0===P?f.push(s):P===l&&g.push(s),0===I?A.push(s):I===l&&m.push(s),i[u]=++s),a++)}let T;i.fill(0),w(0,0,l,l,l,0),w(l,l,0,0,0,l),T=e?2*(s+3*f.length-2+3*g.length-2+3*A.length-2+3*m.length-2):2*(s+f.length+g.length+A.length+m.length);const M=3*(a+2*(f.length-1)+2*(g.length-1)+2*(A.length-1)+2*(m.length-1)),C=new Uint16Array(T),P=new Uint32Array(M);let I=0;function O(e,s,a,l,h,c){const u=e+a>>1,f=s+l>>1;if(Math.abs(e-h)+Math.abs(s-c)>1&&o[f*n+u]>t)O(h,c,e,s,u,f),O(a,l,h,c,u,f);else{const t=i[s*n+e]-1,o=i[l*n+a]-1,u=i[c*n+h]-1;C[2*t]=e,C[2*t+1]=s,C[2*o]=a,C[2*o+1]=l,C[2*u]=h,C[2*u+1]=c,P[I++]=t,P[I++]=o,P[I++]=u}}O(0,0,l,l,l,0),O(l,l,0,0,0,l),f.sort(((t,e)=>C[2*t+1]-C[2*e+1])),g.sort(((t,e)=>C[2*e+1]-C[2*t+1])),A.sort(((t,e)=>C[2*e]-C[2*t])),m.sort(((t,e)=>C[2*t]-C[2*e]));let E,D,N,H,U=2*s,W=0;function q(t){W=t.length;for(let n=0;n<W-1;n++)E=t[n],D=t[n+1],N=U/2,H=(U+(e?6:2))/2,C[U++]=2*E,C[U++]=2*E+1,e&&(C[U++]=2*E,C[U++]=2*E+1,C[U++]=2*D,C[U++]=2*D+1),e?(P[I++]=N+1,P[I++]=N,P[I++]=N+2,P[I++]=N,P[I++]=H,P[I++]=N+2):(P[I++]=E,P[I++]=N,P[I++]=D,P[I++]=N,P[I++]=H,P[I++]=D);C[U++]=2*t[W-1],C[U++]=2*t[W-1]+1}q(f);const X=U;q(g);const J=U;q(A);const Q=U;q(m);return{vertices:C,triangles:P,numVerticesWithoutSkirts:s,numTrianglesWithoutSkirts:a,leftSkirtIndex:X,rightSkirtIndex:J,bottomSkirtIndex:Q,topSkirtIndex:U}}}const eI={};function nI(t,e,n){let i=eI[n];i||(i=eI[n]=new Martini(n));const o=i.createTile(e).getMeshWithSkirts(t,!0),{triangles:s,vertices:a,leftSkirtIndex:l,rightSkirtIndex:h,bottomSkirtIndex:c,topSkirtIndex:u}=o;let{numVerticesWithoutSkirts:f,numTrianglesWithoutSkirts:g}=o;f||(f=a.length/2,g=s.length/3);const A=a.length/2,m=new Float32Array(3*A),w=new Float32Array(2*A);let T=1/0,M=-1/0;const C=n-1;for(let t=0;t<A;t++){const i=a[2*t],o=a[2*t+1];if(t>=f){const e=i/2*3;let n,o=.001;(t-(t<l/2?f:t<h/2?l/2:t<c/2?h/2:c/2))%3==0?(n=Math.min(0,T),o=0):n=m[e+2];m[3*t]=m[e],m[3*t+1]=m[e+1],m[3*t+2]=n,w[2*t]=m[e]/C+o,w[2*t+1]=-m[e+1]/C+o}else{const s=e[o*n+i];m[3*t]=1*i,m[3*t+1]=1*-o,m[3*t+2]=s,w[2*t]=i/C,w[2*t+1]=o/C,s<T&&(T=s),s>M&&(M=s)}}return{positions:m,texcoords:w,triangles:s,leftSkirtIndex:l,rightSkirtIndex:h,bottomSkirtIndex:c,topSkirtIndex:u,numTrianglesWithoutSkirts:g,numVerticesWithoutSkirts:f,minHeight:Math.min(0,T),maxHeight:M,terrainWidth:n}}function iI(t,e,n,i,o,s,a,l,h){const c={};for(let u=0;u<h;u++)c[u+""]=oI(t,e,n,i,o,s,a,l,u);return c}const rI=[];function oI(t,e,n,i,o,s,a,l,h){if((i-=h)<=0)return rI;const c=t.getTileSize().width,u=t._getTileOffset(i,o),f=s[0]-u[0],g=u[1]-s[1],A=t._getTileConfig(),m=t.getSpatialReference().getResolution(i),w=A.tileSystem.scale.y,T=1e-7;let M=0,C=0,P=l/=Math.pow(2,h),I=l;if(f<0?P+=Math.ceil(-f/c-T):f>0&&(M-=Math.ceil(f/c-T)),g>0?C-=Math.ceil(g/c-T):g<0&&(I+=Math.ceil(-g/c-T)),0===M&&0===C&&P<=1&&I<=1){const o=Math.floor(e*l);let s=Math.floor(n*l);const h=s;return w!==a&&(s=lI(A,s,m)),[{x:o,y:s,skinY:h,z:i,offset:u,tileSize:c,id:t._getTileId(o,s,i)}]}const O=[];for(let o=M;o<P;o++)for(let s=C;s<I;s++){const h=e*l+o;let f=n*l+s;const g=f;w!==a&&(f=lI(A,f,m)),O.push({x:h,y:f,skinY:g,z:i,offset:u,tileSize:c,id:t._getTileId(h,f,i)})}return O}function sI(t,e,n,i){let o=t/n*i/e;return o<1?(o=1/o,o=1/Math.round(o)):o=Math.round(o),o}function aI(t,e,n){const i=t.getResolution(e),o=e-Math.log(n/i)*Math.LOG2E;return{zoom:o,res:t.getResolution(o)}}function lI(t,e,n){const i=t.fullExtent,o=t.tileSize.width,s=Math.max(i.top,i.bottom),a=Math.min(i.top,i.bottom);return Math.ceil(s/o/n)-1-Math.floor(a/o/n)-e}function hI(t,e){const n=e*e,i=0!==t?new Float32Array(n):new Uint8Array(n);return i.fill(t),{data:i,width:e,height:e,max:t,min:t}}new _e(0,0);const cI=hI(0,5),uI=nI(1,cI.data,cI.width);function fI(t,e,n){const i=n&&n.includes;if(i)for(const o in i)i[o]&&(n[o].uniformDeclares&&e.push(...n[o].uniformDeclares),n[o].defines&&DS(t,n[o].defines))}function dI(t,e){const n=e&&e.includes;if(n)for(const i in n)n[i]&&e[i].renderUniforms&&DS(t,e[i].renderUniforms)}uI.empty=!0;var gI=Object.freeze({__proto__:null,fillIncludes:fI,setIncludeUniformValues:dI});const pI=[],AI=[];class TerrainPainter{constructor(t){this.layer=t,this.regl=t.getRenderer().regl,this.renderer=new cw(this.regl),this._leafScene=new _w;const e=new Uint8Array(16);e.fill(255),this._emptyTileTexture=this.regl.texture({width:2,height:2,data:e}),this._resLoader=new dw(this._emptyTileTexture),this._createEmptyTerrainGeo()}setToRedraw(){this.layer.getRenderer().setToRedraw()}getMap(){return this.layer.getMap()}startFrame(t){t&&t.states&&t.states.includesChanged&&(this.shader.dispose(),delete this.shader),this.shader||this.initShader(t),this._leafScene.clear()}createTerrainMesh(t,e){const{mesh:n,image:i}=e;let o=e.terrainMesh;const{positions:s,texcoords:a,triangles:l,empty:h}=n;if(o&&o.geometry!==this._emptyTerrainGeometry)o.geometry.updateData("aPosition",s),o.geometry.updateData("aTexCoord",a),o.geometry.setElements(l);else{const t=h?this._emptyTerrainGeometry:new vb({aPosition:s,aTexCoord:a},l,0);o?o.geometry=t:(o=new aw(t,null,{disableVAO:!0}),t.generateBuffers(this.regl))}if(!o.uniforms.skin){const t=this.getEmptyTexture();o.setUniform("skin",t)}return o.setUniform("heightTexture",i),this.prepareMesh(o,t,e),o}_updateMaskDefines(t){const e=this.layer.getRenderer();e&&e.updateMaskDefines(t)}_getPositionMatrix(t){const e=this._getHeightScale(),n=ay(t);return fy(n,n,[1,1,e]),n}_getHeightScale(){let t=this.layer.options.exaggeration;return FS(t)&&(t=1),this._getPointZ(100)/100*t}_getLocalTransform(t,e,n){const i=this.getMap(),o=this.layer.getTileSize().width,s=e.res/i.getGLRes(),a=o/(n-1),{extent2d:l,offset:h}=e;Fy(pI,(l.xmin-h[0])*s,(e.extent2d.ymax-h[1])*s,0);const c=ay(t);return uy(c,c,pI),Fy(AI,s*a,s*a,1),fy(c,c,AI),c}prepareMesh(t,e,n){if(!t.isValid())return;const{mesh:i}=n;this._updateMaskDefines(t);const{triangles:o,numTrianglesWithoutSkirts:s,terrainWidth:a}=i;t.localTransform=this._getLocalTransform(t.localTransform||[],e,a),t.positionMatrix=this._getPositionMatrix(t.positionMatrix||[]),t.properties.skirtOffset=3*s,t.properties.skirtCount=o.length-3*s,t.properties.z=e.z,t.properties.minHeight=i.minHeight,t.properties.maxHeight=i.maxHeight,t.properties.terrainWidth=a,t.castShadow=!1,GS(t.uniforms,"minAltitude")||Object.defineProperty(t.uniforms,"minAltitude",{enumerable:!0,get:()=>n.minAltitude||0})}addTerrainImage(t,e){const n=e.terrainMesh;n&&n.geometry&&e.skin&&(n.setUniform("skin",e.skin.color[0]),n.setUniform("polygonOpacity",1),this._leafScene.addMesh(n))}endFrame(t){this.updateIBLDefines(this.shader);let e=0;const n=this.getUniformValues(),i=this._getRenderFBO(t);return this.shader.filter=t&&t.sceneFilter,dI(n,t),this._leafScene.getMeshes().forEach((t=>{this._updateMaskDefines(t)})),e+=this.renderer.render(this.shader,n,this._leafScene,i),e}delete(){this.shader&&(this.shader.dispose(),delete this.shader),this._emptyTileTexture&&(this._emptyTileTexture.destroy(),delete this._emptyTileTexture),this._emptyTerrainGeometry&&(this._emptyTerrainGeometry.dispose(),delete this._emptyTerrainGeometry)}deleteMesh(t){if(!t)return;const e=t.geometry;t.dispose(),e!==this._emptyTerrainGeometry&&e.dispose()}initShader(t){const e=[],n=[],i={},o=[];fI(i,o,t),this.shader=new zw({vert:"#define SHADER_NAME TERRAIN_MESH\nattribute vec3 aPosition;\nattribute vec2 aTexCoord;\nuniform float minAltitude;\nuniform mat4 projViewModelMatrix;\nuniform mat4 projMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 positionMatrix;\nuniform float heightScale;\nvarying vec2 vUv;\n#include <mask_vert>\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n    #include <vsm_shadow_vert>\n#endif\nvoid main() {\n    vec4 position = vec4(aPosition.xy, (aPosition.z + minAltitude) * heightScale, 1.0);\n    position = positionMatrix * position;\n    #ifdef HAS_MASK_EXTENT\n        gl_Position = projMatrix * getMaskPosition(position, modelMatrix);\n    #else\n        gl_Position = projViewModelMatrix * position;\n    #endif\n    vUv = aTexCoord;\n    #if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n        shadow_computeShadowPars(position);\n    #endif\n}",frag:"#define SHADER_NAME TERRAIN_MESH\nprecision mediump float;\nuniform sampler2D skin;\nuniform float polygonOpacity;\nvarying vec2 vUv;\n#include <mask_frag>\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n    #include <vsm_shadow_frag>\n#endif\nvoid main() {\n    vec2 uv = vec2(vUv);\n    uv.y = 1.0 - uv.y;\n    vec4 color = texture2D(skin, uv);\n    #if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n        float shadowCoeff = shadow_computeShadow();\n        color.rgb = shadow_blend(color.rgb, shadowCoeff).rgb;\n    #endif\n    gl_FragColor = color * polygonOpacity;\n    #ifdef HAS_MASK_EXTENT\n      gl_FragColor = setMask(gl_FragColor);\n    #endif\n}",uniforms:o.concat([{name:"modelViewMatrix",type:"function",fn:function(t,e){return cy(n,e.viewMatrix,e.modelMatrix)}},{name:"projViewModelMatrix",type:"function",fn:function(t,n){return cy(e,n.projViewMatrix,n.modelMatrix)}}]),defines:i,extraCommandProps:this.getExtraCommandProps()})}getExtraCommandProps(){const t=this.layer.getRenderer().canvas;return{viewport:{x:0,y:0,width:()=>t?t.width:1,height:()=>t?t.height:1},stencil:{enable:!1},cull:{enable:!0,face:"back"},depth:{enable:!0,mask:()=>!!this.layer.options.depthMask,func:this.layer.options.depthFunc||"<="},blend:{enable:!0,func:{src:this.layer.options.blendSrc,dst:this.layer.options.blendDst},equation:"add"}}}_getRenderFBO(t){return t&&t.renderTarget&&t.renderTarget.fbo}getUniformValues(){const t=this.getMap(),e=t.projViewMatrix,n=this.layer.getRenderer().getMaskUniforms(),i={viewMatrix:t.viewMatrix,projMatrix:t.projMatrix,projViewMatrix:e,heightScale:1};return DS(i,n),i}_getPointZ(t){const e=this.layer.getMap();if(!e)return null;return e.altitudeToPoint(t,e.getGLRes())}getEmptyTexture(){return this._emptyTileTexture}hasIBL(){const t=this.getMap().getLightManager();return!!(t&&t.getAmbientResource())}updateIBLDefines(t){const e=t.shaderDefines;let n=!1;this.hasIBL()?e[["HAS_IBL_LIGHTING"]]||(e.HAS_IBL_LIGHTING=1,n=!0):e[["HAS_IBL_LIGHTING"]]&&(delete e.HAS_IBL_LIGHTING,n=!0),n&&(t.shaderDefines=e)}_createEmptyTerrainGeo(){const t=uI,{positions:e,texcoords:n,triangles:i}=t;this._emptyTerrainGeometry=new vb({aPosition:e,aTexCoord:n},i,0),this._emptyTerrainGeometry.generateBuffers(this.regl)}}const{getIBLResOnCanvas:mI,getPBRUniforms:yI,loginIBLResOnCanvas:_I,logoutIBLResOnCanvas:vI}=xC.PBRUtils,xI={baseColorFactor:[1,1,1,1],emissiveFactor:[0,0,0],baseColorIntensity:1,emitColorFactor:1,roughnessFactor:1,metallicFactor:0,emitMultiplicative:1,outputSRGB:1,hsv:[0,0,0],contrast:1,alphaTest:0};class TerrainLitPainter extends TerrainPainter{constructor(...t){super(...t),this.createIBLTextures(),this._matVer=0}updateMaterial(t,e){this._matVer=e,this._material=this._material||{},DS(this._material,t),this.setToRedraw()}setMaterial(t,e){this._matVer=e,this._material=DS({},xI,t),this.setToRedraw()}createIBLTextures(){const t=this.getMap().getRenderer().canvas;_I(t,this.regl,this.getMap()),this.layer.fire("iblupdated")}disposeIBLTextures(){const t=this.getMap().getRenderer().canvas;vI(t,this.getMap())}createTerrainMesh(t,e){const{mesh:n,image:i}=e,{positions:o,texcoords:s,triangles:a,leftSkirtIndex:l,rightSkirtIndex:h,bottomSkirtIndex:c,numVerticesWithoutSkirts:u}=n,f=new Int8Array(o.length);for(let t=2;t<f.length;t+=3)t<3*u?f[t]=1:t<l/2*3?f[t-2]=-1:t<h/2*3?f[t-2]=1:f[t-1]=t<c/2*3?-1:1;const g=new vb({aPosition:o,aTexCoord:s,aNormal:f},a,0);let A;g.createTangent(),delete g.data.aNormal,g.generateBuffers(this.regl),A=i?this.regl.texture({width:i.width,height:i.height,data:i,min:"linear",mag:"linear"}):this.getEmptyTexture();const m=this.getEmptyTexture(),w=DS({},xI,this.layer.options.material||{});w.skinTexture=m,w.terrainHeightTexture=A;const T=new xC.StandardMaterial(w),M=new aw(g,T);M.properties.matVer=this._matVer;const C=M.defines;return C.HAS_UV_FLIP=1,C.HAS_TERRAIN_NORMAL=1,C.HAS_MAP=1,M.defines=C,this.prepareMesh(M,t,e),M}addTerrainImage(t,e){const n=e.terrainMesh;if(n){if(this._material&&n.properties.matVer!==this._matVer){for(const t in this._material)n.material.set(t,this._material[t]);n.properties.matVer=this._matVer}e.skin&&n.material.set("skinTexture",e.skin),n.setUniform("polygonOpacity",1),this._leafScene.addMesh(n)}}getUniformValues(){const t=this.getMap(),e=t.getRenderer().canvas,{iblTexes:n,dfgLUT:i}=mI(e),o=yI(t,n,i),s=this.layer.getTileSize().width,a=this.layer.getRenderer().getMaskUniforms();return DS(o,{viewMatrix:t.viewMatrix,projMatrix:t.projMatrix,projViewMatrix:t.projViewMatrix,outSize:[e.width,e.height],polygonFill:[1,1,1,1],terrainHeightMapResolution:[s,s],terrainResolution:[e.width,e.height],terrainUnpackFactors:[6553.6,25.6,.1,1e4]}),DS(o,a),o}initShader(t){const e={},n=[];fI(e,n,t),this.shader=new xC.StandardShader({uniforms:n,defines:e,extraCommandProps:this.getExtraCommandProps()})}delete(){return this.disposeIBLTextures(),super.delete()}}function bI(t,e,n,i){const o=wI.call(this,n,i);this._projViewMatrix=e;const{colorExtent:s,modeExtent:a}=this._extentPass.render(o,e);this._maskUniforms=this._maskUniforms||{},this._maskUniforms.mask_colorExtent=s,this._maskUniforms.mask_extent=t,this._maskUniforms.mask_modeExtent=a,this._maskUniforms.mask_hasFlatOut=MI.call(this,"flat-outside"),this._maskUniforms.mask_hasClipOut=MI.call(this,"clip-outside"),this._maskUniforms.mask_hasVideo=MI.call(this,"video"),this._maskUniforms.mask_heightRatio=n,this._maskUniforms.mask_heightOffset=i,this.setToRedraw()}function wI(t,e){const n=[],i=this.layer.getMasks();for(let o=0;o<i.length;o++){const s=i[o].getMesh(this.regl,t,e);s&&n.push(s)}return n}function TI(){if(!this._extentPass||!this._maskUniforms)return;const t=wI.call(this,this._maskUniforms.mask_heightRatio,this._maskUniforms.mask_heightOffset);this._extentPass.render(t,this._projViewMatrix);const e=this.layer.getMasks();for(let t=0;t<e.length;t++)e[t]._update&&e[t]._update()}function MI(t){const e=this.layer.getMasks();for(let n=0;n<e.length;n++)if(e[n].getMode()===t)return 1;return 0}function CI(){const t=this.layer.getMasks();if(!t)return!1;for(let e=0;e<t.length;e++)if(t[e]._needUpdate)return t[e]._needUpdate();return!1}function SI(t){return class extends t{setMask(t,e,n,i){this.viewport||(this.viewport={x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1}),this._extentPass?bI.call(this,t,e,n,i):this.regl?(this._extentPass=new TT(this.regl,this.viewport),bI.call(this,t,e,n,i)):this.layer.once("contextcreate",(()=>{this._extentPass=new TT(this.regl,this.viewport),bI.call(this,t,e,n,i)}),this)}needToRedraw(){return!!super.needToRedraw()||!!CI.call(this)}getMaskUniforms(){return CI.call(this)&&TI.call(this),this.layer.updateMaskExtent(),this._maskUniforms}getMaskDefines(){return this._maskDefines||(this._maskDefines={}),this._maskUniforms&&this._maskUniforms.mask_colorExtent?this._maskDefines.HAS_MASK_EXTENT=1:delete this._maskDefines.HAS_MASK_EXTENT,this._maskDefines}updateMaskDefines(t){const e=t.getDefines();delete e.HAS_MASK_EXTENT;DS(e,this.getMaskDefines()),t.setDefines(e)}_clearMask(){this._deleteMaskUniforms(),this._extentPass&&(this._extentPass.dispose(),delete this._extentPass),this.setToRedraw()}_deleteMaskUniforms(){delete this._maskUniforms}}}class LRUPool{constructor(t,e){this.max=t,this.onRemove=e,this.reset()}reset(){if(this.data){const t=this.data.values();for(const e of t)this.onRemove(e)}return this.data=new Map,this}clear(){this.reset(),delete this.onRemove}add(t,e){return e?(this.has(t)?(this.data.delete(t),this.data.set(t,e)):this.data.set(t,e),this):this}keys(){const t=new Array(this.data.size);let e=0;const n=this.data.keys();for(const i of n)t[e++]=i;return t}has(t){return this.data.has(t)}getAndRemove(t){if(!this.has(t))return null;const e=this.data.get(t);return this.data.delete(t),e}get(t){if(!this.has(t))return null;return this.data.get(t)}pop(){if(this.data.size<this.max)return null;const t=this.data.keys().next();return this.data.get(t.value).current?(this.max+=Math.ceil(this.max/2),null):this.getAndRemove(t.value)}remove(t){if(!this.has(t))return this;const e=this.data.get(t);return this.data.delete(t),this.onRemove(e),this}resetCurrent(t){this.data&&this.data.forEach((e=>{e.current=t}))}}const PI=new _e(0,0),II=new _e(0,0),OI=new Oh(0,0,0,0),EI=new _e(0,0),kI=new _e(20,20),RI={color:[0,0,0,0],depth:1,stencil:0};class TerrainLayerRenderer extends(SI(vm.TileLayerCanvasRenderer)){isDrawable(){return!0}getTempTileOnLoading(t,e){if(e.image&&!e.image.reset)return e;this._debugTile(t,"getTempTileOnLoading");const n=this._createTerrainFromParent(t);return n.temp=!0,e.image||(e.image=n),delete e.image.reset,e.current=!0,e.info=t,DS(e.image,n),this._createMesh(e.image,t),e}_resetTerrainImage(t,e,n){e.reset=!0,delete e.data,delete e.loadTime,delete e.rendered,delete e.minAltitude;const i=t.id+"-temp",o=e.skinImages;if(o)for(let t=0;t<o.length;t++){const e=o[t];if(e){for(let t=0;t<e.length;t++){const o=e[t];o&&(o.refs.delete(i),o.refs.size||n.push(o))}delete e.currentSkins,delete e.tileIds}}delete e.sourceZoom,delete e.skinImages,delete e.skinStatus,delete e.skinTileIds,e.debugTexture&&(e.debugTexture.destroy(),delete e.debugTexture)}_createTerrainFromParent(t,e){for(e=e||this.findParentTile(t);e&&e.image&&(-1===e.image.sourceZoom||e.image.originalError);)e=this.findParentTile(e.info);const n=t.res,i=this.getMap().pointAtResToDistance(1,1,n),o=e&&e.image&&e.image.data&&this._clipParentTerrain(e,t),s=o&&-1!==e.image.sourceZoom?e.info.z:-1;if(!o||o.width<=1){const n=this._findTileMinAltitude(t,e);return{data:hI(n||0,5),minAltitude:n,mesh:uI,sourceZoom:s}}return{data:o,mesh:nI(i/2,o.data,o.width),sourceZoom:s}}_findTileMinAltitude(t,e){if(e&&e.minAltitude)return e.minAltitude;const{idx:n,idy:i,z:o}=t;for(let t=-1;t<=1;t++)for(let e=-1;e<=1;e++){if(0===t&&0===e)continue;const s=this.layer.getTileId(n+t,i+e,o),a=this.layer.tileInfoCache,l=a&&a.get(s);if(l&&l.minAltitude)return l.minAltitude}return 0}consumeTile(t,e){if(this._debugTile(e,"consumeTile"),t.empty&&!t.mesh){const n=this.findParentTile(e);if(!n||n.image&&n.image.empty){t.mesh=uI;const n=this._findTileMinAltitude(e);t.data=hI(n||0,5),t.minAltitude=n,t.sourceZoom=-1}else t=this._createTerrainFromParent(e,n)}this._createMesh(t,e),super.consumeTile(t,e),this._recenterMapOnTerrain(e)}_createMesh(t,e){if(t&&t.mesh){t.terrainMesh=this._painter.createTerrainMesh(e,t),e.minAltitude=t.data.min,e.maxAltitude=t.data.max,delete t.mesh;const n=this.layer.tileInfoCache;if(n&&e.parent&&!t.empty&&!t.temp){const t=n.get(e.parent);if(t){const{minAltitude:n,maxAltitude:i}=e;(void 0===t.minAltitude||t.minAltitude>n)&&(t.minAltitude=n),(void 0===t.maxAltitude||t.maxAltitude<i)&&(t.maxAltitude=i)}}}}_recenterMapOnTerrain(t){const e=this.getMap();if(e.updateCenterAltitude&&void 0===e.centerAltitude&&t.z===this.getCurrentTileZoom()){const n=e._getPrjCenter(),i=e._prjToPointAtRes(n,t.res,EI);t.extent2d.contains(i)&&e.updateCenterAltitude()}}draw(t,e){this._createPainter(),this._painter.startFrame(e),super.draw(t,e),this._endFrame(e)}drawTile(t,e){const n=this.getMap();if(!t||!n||!e)return;if(!this.drawingCurrentTiles&&!this.drawingChildTiles)return;this._debugTile(t,"drawTile");let i=this.drawingCurrentTiles?this.getTileOpacity(e):1;i*=this.layer.options.opacity||1,this._painter.addTerrainImage(t,e,i)}_drawTiles(t,e,n,i,o,s,a){const l=[];this._newTerrainTileCounter=0;const h=this.layer.getSkinCount(),c=new Set;if(a&&a.length){jS(s,a.map((t=>t.info)));for(let t=0;t<h;t++)this._renderChildTerrainSkin(t,a,c,l)}jS(t,this._getTempTilesForMissed(s,l)),this._debugTile(t,"drawTiles");for(let e=0;e<h;e++)this._renderChildTerrainSkin(e,t,c,l);for(let e=0;e<t.length;e++)this._renderTerrainMeshSkin(t[e].info,t[e].image);for(let t=0;t<l.length;t++)l[t]&&l[t].texture&&!l[t].refs.size&&(this._skinImageCache.delete(l[t].tile.id),this._deleteSkinImage(l[t]));return this._clearCachdeSkinImages(),super._drawTiles(...arguments)}_getTempTilesForMissed(t,e){const n=[];let i=this._tempTilesPool;i||(i=this._tempTilesPool=new LRUPool(this.layer.options.tempTileCacheSize,(t=>{const{info:e,image:n}=t;this._deleteTerrainImage(e,n)}))),i.resetCurrent(!1);for(let o=0;o<t.length;o++){const s=t[o];let a;this._debugTile(s,"getTempTilesForMissed"),i.has(s.id)?a=i.getAndRemove(s.id):(a=i.pop(),a?a.image&&(this._resetTerrainImage(a.info,a.image,e),a.image.temp=!0):a={info:s}),a.current=!0,i.add(s.id,a),n.push(a)}for(let e=0;e<t.length;e++)this.getTempTileOnLoading(t[e],n[e]);return n}_clearCachdeSkinImages(){if(!this._skinImageCache)return;const t=this.getCurrentTimestamp();if(this._clearSkinImageTimestamp&&t-this._clearSkinImageTimestamp<1e3)return;const e=new Set;for(const t of this.tileCache.data.values())this._collectSkinImages(t,e);for(const t in this.tilesInView){this._collectSkinImages(this.tilesInView[t],e)}if(this._tempTilesPool)for(const t of this._tempTilesPool.data.values())this._collectSkinImages(t,e);e.size&&(this._skinImageCache.forEach(((t,n)=>{e.has(n)||(console.log("deleted:",n),this._deleteSkinImage(this._skinImageCache.get(n)),this._skinImageCache.delete(n))})),this._clearSkinImageTimestamp=t)}_collectSkinImages(t,e){const n=t.image&&t.image.skinImages;if(n&&n.length)for(let t=0;t<n.length;t++){const i=n[t]&&n.currentSkins;if(i)for(const t of i)e.add(t)}}_renderChildTerrainSkin(t,e,n,i){const o=this.layer.getSkinLayer(t).getRenderer();if(!o)return;const s=[];for(let o=0;o<e.length;o++){const{info:a,image:l}=e[o];if(this._debugTile(a,"renderChildTerrainSkin"),this._prepareChildTerrainSkin(t,a,l,i)){const i=e[o].image.skinImages[t];for(let t=0;t<i.length;t++){const e=i[t].tile.info.id;n.has(e)||(s.push(i[t]),n.add(e))}}}o.renderTerrainSkin(this.regl,this.layer,s)}_prepareChildTerrainSkin(t,e,n,i){const o=this.getMap();if(delete n.path,!e||!o||!n)return!1;if(!n.terrainMesh)return!1;const s=this.layer.getSkinLayer(t),a=s.getRenderer();if(!a)return!1;n.skinImages||(n.skinImages=[]),n.skinStatus||(n.skinStatus=[]),n.skinTileIds||(n.skinTileIds=[]);const l=a.isAnimating&&a.isAnimating(),h=n.skinStatus[t],c=a.needToRefreshTerrainTileOnZooming&&a.needToRefreshTerrainTileOnZooming(),u=l||c&&n.renderedZoom!==o.getZoom();if(h&&!u)return!1;const f=s.getSpatialReference(),{x:g,y:A,z:m,res:w,offset:T}=e;let M=e.nw;M||(M=e.nw=this.getMap().pointAtResToCoord(e.extent2d.getMin(PI),e.res));const C=this.layer.getTileSize().width;let{res:P,zoom:I}=aI(f,m,w);let O=sI(P,s.getTileSize().width,w,C),E=n.skinTileIds[t];if(!E){const e=this.layer._getTileConfig().tileSystem.scale.y,i=s.options.maxAvailableZoom;!FS(i)&&i>=0&&I>i&&(O*=Math.pow(2,i-I),I=i),E=n.skinTileIds[t]=iI(s,g,A,I,M,T,e,O,LI)}const D=E[0];let N=!0;const H=[];for(let t=0;t<D.length;t++){const e=a.getCachedTile(D[t],!1);if(e)H.push(e);else{N=!1;const e=a.findParentTile(D[t]);e&&H.push(e)}}const U=n.skinImages[t]||[];U.currentSkins=U.currentSkins||new Set;const W=new Set;let q=!1;for(let t=0;t<U.length;t++){if(!U[t].tile){q=!0;continue}W.add(U[t].tile.info.id)}if(!H.length)return U.currentSkins.clear(),n.skinImages[t]=[],!1;const X=H.length?H.map((t=>t.info.id)).join():H[0].info.id;if(!u&&!q&&U.tileIds===X)return!1;U.tileIds=X;let J=!1;U.currentSkins.clear(),U.length=0;const Q=U.currentSkins;let Y=e.id;n.temp&&(Y+="-temp");for(let t=0;t<H.length;t++){const e=H[t].info.id;Q.add(e);let n=this._getCachedSkinImage(e);n&&((K=n)&&K.texture)||(n={tile:DS({},H[t]),layer:s,refs:new Set,texture:a.createTerrainTexture(this.regl)},this._saveCachedSkinImage(e,n)),n.refs.add(Y),U.push(n),J=!0}var K;return this._clearPrevSkinImages(e,n,W,Q,i),J&&this._newTerrainTileCounter++,n.skinImages[t]=U,s.fire("renderterrainskin",{tile:e,skinTiles:H}),N&&(n.skinStatus[t]=1),!0}_clearPrevSkinImages(t,e,n,i,o){if(!n.size)return;let s=t.id;e.temp&&(s+="-temp");for(const t of n)if(!i||!i.has(t)){const e=this._getCachedSkinImage(t);this._deleteCachedSkinImage(e,s,o)}}_getCachedSkinImage(t){return this._skinImageCache||(this._skinImageCache=new Map),this._skinImageCache.get(t)}_saveCachedSkinImage(t,e){this._skinImageCache.set(t,e)}_renderTerrainMeshSkin(t,e){const n=this.getMap();if(!t||!n||!e)return;this._debugTile(t,"_renderTerrainMeshSkin");const i=e.skinImages,o=this._needRefreshTerrainSkins(e.renderedZoom);if(e.rendered&&!o)return;e.skin?(RI.framebuffer=e.skin,this.regl.clear(RI)):e.skin=this._createTerrainTexture(t,e),this._initSkinShader();const s=this.layer.options.debug,a=[],l=s&&[],h=this.layer.getTileSize().width;if(i)for(let e=0;e<i.length;e++){const n=i[e];for(let e=0;e<n.length;e++){const{tile:i,texture:o,layer:s}=n[e];if((i.info.offset[0]||i.info.offset[1])&&t.skinTileIds){const e=t.skinTileIds[s.getId()];for(let t=0;t<e.length;t++)if(i.info.x===e[t].x&&i.info.y===e[t].y){i.info.offset=e[t].offset;break}}const l=FI(t,i,h),c=n[e].skinMesh||new aw(this._skinGeometry);c.setUniform("skinTexture",o);const u=s.getOpacity();c.setUniform("opacity",FS(u)?1:u),c.setUniform("skinDim",l),c.setUniform("tileSize",h),c.setUniform("x",t.x),c.setUniform("y",t.y),n[e].skinMesh=c,a.push(c)}}if(s){const n=e.skinDebugMesh||new aw(this._skinGeometry);n.setUniform("tileSize",h);const i=e.debugTexture||this._createDebugTexture(t,h,e.temp);e.debugTexture=i,e.skinDebugMesh=n,n.setUniform("opacity",1),n.setUniform("skinTexture",i),n.setUniform("skinDim",[0,0,1]),n.setUniform("tileSize",h),l.push(n)}if(a.length){this._skinScene.setMeshes(a);try{this.renderer.render(this._skinShader,null,this._skinScene,e.skin)}catch(t){throw console.error(e),t}}l&&l.length&&this.layer.options.debug&&(this._skinScene.setMeshes(l),this.renderer.render(this._skinShader,null,this._skinScene,e.skin)),e.rendered=this._isSkinReady(e),e.renderedZoom=n.getZoom()}_createDebugTexture(t,e,n){e*=2;const{x:i,y:o,z:s}=t,a=`terrain:${i}/${o}/${s}`+(n?"-temp":""),l=document.createElement("canvas");l.width=e,l.height=e;const h=l.getContext("2d");h.font="60px monospace";const c=this.layer.options.debugOutline;return h.fillStyle=c,h.strokeStyle=c,h.fillText(a,20,e-40),h.beginPath(),h.lineWidth=4,h.moveTo(0,0),h.lineTo(e,0),h.lineTo(e,e),h.lineTo(0,e),h.lineTo(0,0),h.stroke(),this.regl.texture({data:l,flipY:!0,mag:"linear",min:"linear"})}_createTerrainTexture(t){const e=this.layer.getTileSize().width,n=2*e,i=2*e,o=this.regl,s=t.colorsTexture;let a;a=s&&s instanceof Uint8Array?o.texture({data:s,min:"linear",mag:"linear",type:"uint8",width:n,height:i,flipY:!0}):o.texture({min:"linear",mag:"linear",type:"uint8",width:n,height:i,flipY:!0});const l=o.framebuffer({width:n,height:i,colors:[a],colorFormat:"rgba",ignoreStatusCheck:!0,depthStencil:!1,depth:!1,stencil:!1});return l.colorTex=a,l}_endFrame(t){this._painter.endFrame(t)&&!Object.keys(this.tilesLoading).length&&this.layer.fire("terrainreadyandrender")}_clipParentTerrain(t,e){const{image:n,info:i}=t,o=n.data,s=o.width,{extent2d:a,res:l}=i,{extent2d:h,res:c}=e,u=a.getWidth(),f=a.getHeight();let g=(h.xmin*c/l-a.xmin)/u*(s-1),A=(a.ymax-h.ymax*c/l)/f*(s-1);let m=Math.round((h.xmax*c/l-a.xmin)/u*(s-1)-g);const w=Math.log2(m);m=Math.pow(2,Math.round(w))+1,g=Math.floor(g),A=Math.floor(A);const T=new Float32Array(m*m);let M=1/0,C=-1/0;for(let t=0;t<m;t++)for(let e=0;e<m;e++){let n=t+g,i=e+A;n>s-1?n=s-1:n<0&&(n=0),i>s-1?i=s-1:i<0&&(i=0);const a=o.data[n+i*s];T[t+e*m]=a,a<M&&(M=a),a>C&&(C=a)}return{width:m,height:m,data:T,min:M,max:C}}getTileOpacity(t){return this._isSkinReady(t)?super.getTileOpacity(t):(this.resetTileLoadTime(t),0)}_isSkinReady(t){const e=this.layer.getSkinCount();if(!e)return!0;if(!t.skinStatus)return!1;for(let n=0;n<e;n++)if(!t.skinStatus[n])return!1;return!0}_needRefreshTerrainSkins(t){const e=this.getMap().getZoom(),n=this.layer.getSkinLayers();for(let i=0;i<n.length;i++){const o=n[i]&&n[i].getRenderer();if(o){if(o.isAnimating&&o.isAnimating())return!0;if(o.needToRefreshTerrainTileOnZooming&&o.needToRefreshTerrainTileOnZooming()&&t!==e)return!0}}return!1}isValidCachedTile(t){return t.image&&!t.image.temp&&(!t.image.skinStatus||this._isSkinReady(t.image))}isTileComplete(t){return t.image&&!t.image.temp&&this._isSkinReady(t.image)}_getTerrainWidth(){const t=this.layer.options,e=this.layer.getTileSize().width;return FS(t.terrainWidth)?e/4+1:t.terrainWidth}_getParentTileRequest(t,e){const n=this.layer.options.maxAvailableZoom-this.layer.options.zoomOffset,i=Math.pow(2,t.z-n),o=Math.floor(t.x/i),s=Math.floor(t.y/i),a=Math.floor(t.idx/i),l=Math.floor(t.idy/i),h=NI(o,s);this._parentRequests||(this._parentRequests={});const c=!this._parentRequests[h];return c&&e&&(this._parentRequests[h]=new Set,this._parentRequests[h].url=this.layer.getTileUrl(o,s,n+this.layer.options.zoomOffset)),{x:o,y:s,idx:a,idy:l,requests:this._parentRequests[h],isFirst:c,key:h}}loadTile(t){const e=this.layer,n=this._getTerrainWidth(),i=e.getSpatialReference().getResolution(t.z);let o=this.getMap().pointAtResToDistance(1,1,i);const s=e.options.maxAvailableZoom&&e.options.maxAvailableZoom-(e.options.zoomOffset||0);if(s&&t.z>s){const n=this._createTerrainFromParent(t);if(-1!==n.sourceZoom)return this.onTileLoad(n,t),n;{const{requests:i,isFirst:a,x:l,y:h,idx:c,idy:u}=this._getParentTileRequest(t,!0);if(i.add(t),!a)return n;const f=t.z-s;o*=Math.pow(2,f);const g=[l,h,s,c,u,t.res*Math.pow(2,f),t.error*Math.pow(2,f)];t=e.createTileNode?e.createTileNode(...g):e._createTileNode(...g)}}const a=t.url,l={},h=e.options,c=e.getTileSize(),u={terrainWidth:n,type:h.type,accessToken:h.accessToken,cesiumIonTokenURL:h.cesiumIonTokenURL,error:o,colors:h.colors,tileSize:c?[c.width,c.height]:[256,256],command:"loadTile"},f=()=>{this.workerConn.fetchTerrain(a,u,((e,n)=>{if(this._parentRequests){const e=NI(t.x,t.y),n=this._parentRequests[e];if(n&&n.size){this.tileCache.add(t.id,{info:t,image:l});for(const t of n)this.removeTileLoading(t)}delete this._parentRequests[e]}if(e){if(e.canceled)return;return console.warn(e),void this.onTileError(l,t)}hs.extend(l,n),t.colorsTexture=l.colorsTexture,this.onTileLoad(l,t)}))},g=e=>{e&&e.canceled||(console.warn(e),this.onTileError(l,t))};return this.loadTileBitmap&&HS(this.loadTileBitmap)?this.loadTileBitmap(a,t,((t,e)=>{t?g(t):e&&e instanceof ImageBitmap?(u.tileImage=e,f()):g(new Error("bitmap is not ImageBitmap"))}),u):f(),l}deleteTile(t){if(!t||!t.image)return;super.deleteTile(t);const{info:e,image:n}=t;n.temp||(delete e.skinTileIds,this._deleteTerrainImage(t.info,n))}_deleteTerrainImage(t,e){const n=e.skin;n&&(n.destroy(),n.colorTex.destroy(),delete n.colorTex),e.debugTexture&&(e.debugTexture.destroy(),delete e.debugTexture,e.skinDebugMesh.dispose(),delete e.skinDebugMesh);const i=e.skinImages;if(i&&i.length){let n=t.id;e.temp&&(n+="-temp");for(let t=0;t<i.length;t++){const e=i[t];if(e){for(let t=0;t<e.length;t++){if(!e[t]||!e[t].tile)continue;const i=this._skinImageCache&&this._skinImageCache.get(e[t].tile.info.id);i&&this._deleteCachedSkinImage(i,n)}e.length=0}}}e.terrainMesh&&this._painter.deleteMesh(e.terrainMesh),e.image&&e.image.close&&e.image.close(),delete e.skinImages,delete e.skin,delete e.skinStatus,delete e.skinTileIds,delete e.terrainMesh,delete e.image,delete e.data,delete e.mesh,delete e.rendered}_deleteCachedSkinImage(t,e,n){t&&(t.refs.delete(e),t.refs.size||(n?n.push(t):this._deleteSkinImage(t)))}_deleteSkinImage(t){if(!t||!t.tile)return;const e=t.tile.info.id,n=t.layer.getRenderer();delete t.canvas,delete t.layer,t.refs.clear(),t.texture&&(n?n.deleteTerrainTexture(t.texture):t.texture.destroy&&t.texture.destroy(),delete t.texture),t.skinMesh&&(t.skinMesh.dispose(),delete t.skinMesh),n&&(n.removeTileCache&&n.removeTileCache(e),n.deleteTile&&n.constructor.prototype.deleteTile.call(n,t.tile)),delete t.tile,this._skinImageCache.delete(e)}_clearSkinImageCache(){if(!this._skinImageCache)return;const t=this._skinImageCache.keys();for(const e of t){const t=this._getCachedSkinImage(e);this._deleteSkinImage(t)}this._skinImageCache.clear()}abortTileLoading(t,e){const n=this.layer,i=n.options.maxAvailableZoom&&n.options.maxAvailableZoom-n.options.zoomOffset,o=(t,e)=>{this.loadTileBitmap&&HS(this.loadTileBitmap)?this.loadTileBitmap(t,e,(()=>{}),{command:"abortTile"}):this.workerConn&&this.workerConn.abortTerrain(t)};if(e)if(i&&e.z>i){const{requests:t,key:n}=this._getParentTileRequest(e);t&&t.size&&(t.delete(e),t.size||(delete this._parentRequests[n],o(t.url,e)))}else e&&e.url&&o(e.url,e);super.abortTileLoading(t,e)}onTileError(t,e){super.onTileError(t,e)}_getTerrainTileAtPrjCoord(t){const e=this.getCurrentTileZoom(),n=this.layer.getSpatialReference().getResolution(e),i=this.layer._getTileConfig().getTileIndex(t,n,this.layer.options.repeatWorld);return i.z=e,i}_queryTerrain(t,e,n,i,o){const s=this.layer.getMinZoom(),a=this._findTerrainData(e,n.x,n.y,n.z,s);if(a&&a.image&&a.image.data){const e=a.info.extent2d,s=a.info.res/o,l=e.ymax*s-i.y;let h=this._queryAltitudeInHeights(a.image.data,(i.x-e.xmin*s)/(e.getWidth()*s),l/(e.getHeight()*s));const c=this.layer._getExaggeration();0!==c&&(h*=c),t[0]=h,t[1]=null===h?0:+(a.info.z===n.z)}else t[0]=null,t[1]=0;return t}_findTerrainData(t,e,n,i,o){t||(t=this.layer._getTileId(e,n,i));const s=this.tilesInView[t]||this.tileCache.get(t);return!s&&i-1>=o?this._findTerrainData(null,Math.floor(e/2),Math.floor(n/2),i-1,o):s}_queryAltitudeInHeights(t,e,n){const{width:i,height:o,data:s}=t,a=Math.floor((i-1)*e),l=Math.floor((o-1)*n)*i+a;return void 0===s[l]?null:s[l]}_queryTileAltitude(t,e,n){t||(t={tiles:{},dirty:!0,complete:!1});const i=this.layer,o=this.getCurrentTileZoom(),s=i.getSpatialReference().getResolution(o),{xmin:a,ymin:l,xmax:h,ymax:c}=e,u=i._getTileConfig();PI.set(a,l)._multi(n);const f=u._getTileNum(PI,n,!0);II.set(h,c)._multi(n);const g=u._getTileNum(II,n,!0),A=Math.min(f.x,g.x),m=Math.max(f.x,g.x),w=Math.min(f.y,g.y),T=Math.max(f.y,g.y),M=n/s;PI.set(a,l)._multi(M),II.set(h,c)._multi(M);const C=OI.set(PI.x,PI.y,II.x,II.y),P=i.getTileSize().width+1;C._expand(C.getWidth()/P),t.array=t.array||new Float32Array(P*P);const I=t.tiles;t.complete=!0,t.array.fill(0);for(let e=A;e<=m;e++)for(let n=w;n<=T;n++){const i=this.layer._getTileId(e,n,o);if(I[i])continue;const s=this.tileCache.get(i);s?(this._fillAltitudeData(t.array,s,C,P),t.dirty=!0,I[i]=1):(t.dirty=t.dirty||void 0!==t.tiles[i],t.tiles[i]&&delete t.tiles[i],t.complete=!1)}return t}_fillAltitudeData(t,e,n,i){const o=e.info.extent2d,s=o.intersection(n),{xmin:a,ymin:l,xmax:h,ymax:c}=s,{data:u}=e.image,f=u.width,g=n.getWidth()/i,A=Math.floor((a-n.xmin)/g),m=Math.floor((l-n.ymin)/g),w=Math.floor((h-n.xmin)/g)-A,T=Math.floor((c-n.ymin)/g)-m,M=o.getWidth()/f,C=Math.floor((a-o.xmin)/M),P=Math.floor((l-o.ymin)/M),I=Math.floor(g/M);for(let e=0;e<=w;e++)for(let n=0;n<=T;n++){const o=e+A+(m+n)*i;let s=0;for(let t=0;t<I;t++)for(let i=0;i<I;i++){const o=(C+Math.floor(e*I))*f+t+P+Math.floor(n*I)+i;s+=u.data[o]}t[o]=s/Math.max(I,1)}return t}clear(){return this.clearTempResources(),super.clear()}clearTempResources(){this._tempTilesPool&&(this._tempTilesPool.reset(),delete this._tempTilesPool),this._skinImageCache&&this._clearSkinImageCache()}onAdd(){super.onAdd(),this.prepareWorker()}onRemove(){this.workerConn&&(this.workerConn.removeLayer(this.layer.getId(),(t=>{if(t)throw t})),this.workerConn.remove(),delete this.workerConn),this.clearTempResources(),this._skinShader&&(this._skinShader.dispose(),delete this._skinShader),this._skinGeometry&&(this._skinGeometry.dispose(),delete this._skinGeometry),delete this._parentRequests,super.onRemove(),this._painter&&(this._painter.delete(),delete this._painter)}prepareWorker(){const t=this.layer.getMap();this.workerConn||(this.workerConn=new TerrainWorkerConnection(t.id));const e=this.workerConn;if(!e.isActive())return;const n=this.layer.options||{},i=this.layer.getId();e.addLayer(i,n,(t=>{if(t)throw t;this.layer&&(this.ready=!0,this.setToRedraw(),this.layer.fire("workerready"))}))}createContext(){this.canvas.gl&&this.canvas.gl.wrap?(this.gl=this.canvas.gl.wrap(),this.regl=this.canvas.gl.regl):this._createREGLContext(),this.renderer=new cw(this.regl),this.layer.fire("contextcreate",{regl:this.regl})}_createPainter(){const t=this._painter;"lit"===this.layer.options.shader||"pbr"===this.layer.options.shader?(t&&t.constructor===TerrainPainter||!t)&&(t&&(t.delete(),this.clear(),this.setToRedraw()),this._painter=new TerrainLitPainter(this.layer),this.layer.fire("paintercreated")):(t&&t.constructor===TerrainLitPainter||!t)&&(t&&(t.delete(),this.clear(),this.setToRedraw()),this._painter=new TerrainPainter(this.layer),this.layer.fire("paintercreated"))}_createREGLContext(){const t=this.layer,e=t.options.glOptions||{alpha:!0,depth:!0,antialias:this.layer.options.antialias};e.preserveDrawingBuffer=!0,e.stencil=!0,this.glOptions=e,this.gl=this.gl||this._createGLContext(this.canvas,e),this.regl=Lm.createREGL({gl:this.gl,attributes:e,extensions:["OES_element_index_uint"],optionalExtensions:t.options.glExtensions})}_createGLContext(t,e){const n=["webgl","experimental-webgl"];let i=null;for(let o=0;o<n.length;++o){try{i=t.getContext(n[o],e)}catch(t){}if(i)break}return i}resizeCanvas(t){this.canvas&&super.resizeCanvas(t)}clearCanvas(){this.canvas&&super.clearCanvas()}_initSkinShader(){if(this._skinShader)return;const t=this.layer.getTileSize().width;this._skinShader=new zw({vert:"#define SHADER_NAME TERRAIN_SKIN\nattribute vec2 aPosition;\nvoid main() {\n    gl_Position = vec4(aPosition, 0.0, 1.0);\n}",frag:"#define SHADER_NAME TERRAIN_SKIN\nprecision mediump float;\nuniform float tileSize;\nuniform sampler2D skinTexture;\nuniform vec3 skinDim;\nuniform float opacity;\nvoid main() {\n    vec2 fragCoord = gl_FragCoord.xy / 2.0;\n    vec2 resolution = vec2(tileSize);\n    vec2 uv = (fragCoord - skinDim.xy) /  (resolution * skinDim.z);\n    if (uv.x >= 0.0 && uv.x <= 1.0 && uv.y >= 0.0 && uv.y <= 1.0) {\n        gl_FragColor = texture2D(skinTexture, uv) * opacity;\n    } else {\n        gl_FragColor = vec4(0.0);\n    }\n}",extraCommandProps:{cull:{enable:!1},viewport:{x:0,y:0,width:2*t,height:2*t},depth:{enable:!1},stencil:{enable:!1},blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"}}});const e=new Int8Array([-1,-1,1,1,-1,1,1,1,-1,-1,1,-1]);this._skinGeometry=this._skinGeometry||new vb({aPosition:e},0,6,{positionSize:2}),this._skinGeometry.generateBuffers(this.regl),this._skinScene=this._skinScene||new _w}updateMaterial(t){this._painter&&t&&this._painter.updateMaterial&&(void 0===this._matVer&&(this._matVer=1),this._painter.updateMaterial(t,this._matVer++))}setMaterial(t){this._painter&&t&&this._painter.setMaterial&&(void 0===this._matVer&&(this._matVer=1),this._painter.setMaterial(t,this._matVer++))}getAnalysisMeshes(){return this._painter&&this._painter._leafScene?this._painter._leafScene.getMeshes():[]}_debugTile(t,e,n){if(this.layer.options.debugTile){if(Array.isArray(t)){for(let i=0;i<t.length;i++)t[i]&&this._debugTile(t[i],e+" at "+i,n);return}if(!t)return;const{x:i,y:o,z:s}=this.layer.options.debugTile,{info:a}=t;a&&(t=a),i===t.x&&o===t.y&&s===t.z&&console.log(`Found debug tile in TerrainLayerRenderer.${e}:`,t)}}}const LI=1;function DI(t,e,n,i,o,s,a,l,h=0){t.font="20px monospace",t.fillStyle=n,kI.y=l-30,t.globalAlpha=1,t.fillText(e,kI.x+o,kI.y+s+h),t.globalAlpha=.6,t.strokeStyle=n,t.lineWidth=i,t.beginPath(),t.moveTo(o,s),t.lineTo(o+a,s),t.lineTo(o+a,s+l),t.lineTo(o,s+l),t.lineTo(o,s),t.stroke(),t.globalAlpha=1}function FI(t,e,n){const{res:i,extent2d:o,offset:s}=t,{info:a}=e,l=a.res/i,h=a.offset;return[a.extent2d.xmin*l-o.xmin+(s[0]-h[0]),-(o.ymin-a.extent2d.ymin*l+(h[1]-s[1])),l*a.tileSize/n]}function NI(t,e){return t+"-"+e}vm.TileLayerCanvasRenderer.include({renderTerrainSkin(t,e,n){const i=this.layer.getTileSize().width,o=e.options.debug;for(let t=0;t<n.length;t++){const{tile:e,texture:s}=n[t];if(!e.image)continue;const a=document.createElement("canvas");n[t].canvas=a,a.width=i,a.height=i;const l=a.getContext("2d");if(l.drawImage(e.image,0,0),o){const{x:t,y:n,z:o}=e.info;DI(l,`${t}/${n}/${o}`,"yellow",1,0,0,i,i,-18)}s({data:a,width:i,height:i,flipY:!0,min:"linear mipmap linear",mag:"linear"})}},createTerrainTexture(t){const e=this.layer.getTileSize().width;return t.texture({width:e,height:e,flipY:!0,min:"linear mipmap linear",mag:"linear",depthStencil:!1,depth:!1,stencil:!1})},deleteTerrainTexture(t){t.destroy()}});const HI={"clip-inside":.1,"clip-outside":.2,"flat-inside":.3,"flat-outside":.4,color:.5,texture:.6,elevate:.7},BI=[],zI=[1,1,1],GI={polygonFill:[255,0,0],polygonOpacity:.8},jI=new gh(0,0),UI=new gh(0,0),VI=[],WI=new gh(0,0),ZI=new _e(0,0),qI=new _e(0,0),XI=new _e(0,0);class Mask extends od{getMode(){return this._mode}remove(){const t=this.getLayer();return t?(t.removeMask(this),this._dispose(),super.remove(),this):this}getMesh(t,e,n){return this.isVisible()&&this.getLayer()?(this._mesh||(this._mesh=this._createMesh(t,e,n)),this._updateUniforms(this._mesh,e,n),this._mesh):null}setCoordinates(t){super.setCoordinates(t);const e=this.getLayer();if(e&&(delete e._maskProjViewMatrix,delete e._maskExtentInWorld),!this._mesh)return this;const n=this.getMode(),i=this.toGeoJSON();i.geometry.coordinates[0].reverse();const o=bC.flatten(i.geometry.coordinates),{positions:s,uvs:a,triangles:l}="texture"===n?this._createBilinearPOSITON(o):this._createPOSITION(o),h=this._mesh.geometry;if(h.updateData("POSITION",s),h.updateData("TEXCOORD",a),h.setElements(l),this._setLocalTransform(this._mesh),this._copyMesh){const t=this._createPOSITION(bC.flatten(i.geometry.coordinates),!0).positions;this._copyMesh.geometry.updateData("POSITION",t),this._setLocalTransform(this._copyMesh)}}_createGeometry(t){const e=this.getMode(),n=this.toGeoJSON();n.geometry.coordinates[0].reverse();const i=bC.flatten(n.geometry.coordinates),{positions:o,uvs:s,triangles:a}="texture"===e?this._createBilinearPOSITON(i):this._createPOSITION(i),l=this._createPOSITION(bC.flatten(n.geometry.coordinates),!0).positions,h=new vb({POSITION:o,TEXCOORD:s},a,0,{positionAttribute:"POSITION",uv0Attribute:"TEXCOORD"});h.generateBuffers(t);const c=new vb({POSITION:l,TEXCOORD:s},a,0,{positionAttribute:"POSITION",uv0Attribute:"TEXCOORD"});return c.generateBuffers(t),"texture"===e?{geometry:h,copyGeometry:c}:h}_createPOSITION(t,e){const n=this.getMap(),i=t.dimensions;for(let e=0;e<t.vertices.length;e+=i){WI.x=t.vertices[e],WI.y=t.vertices[e+1];const i=ZS(n,WI);t.vertices[e]=i[0],t.vertices[e+1]=i[1]}const o=ZS(n,this.getCenter()),s=[],a=.01*this.getLayer().getMasks().indexOf(this),l="texture"===this.getMode()?4:t.vertices.length/i;for(let h=0;h<l;h++)s.push(t.vertices[h*i]-o[0]),s.push(t.vertices[h*i+1]-o[1]),s.push(a+e?n.altitudeToPoint(t.vertices[h*i+2],n.getGLRes()):0);return{positions:s,uvs:this._createTexcoords(t.vertices,i),triangles:bC(s,t.holes,3)}}_createTexcoords(t,e){const n=[0,0,0,1,1,1,1,0];if(this.hasHoles()){const i=t.length/e*2;for(let t=n.length/2-1;t<i;t+=2)n[t]=n[t+1]=0}return n}_createBilinearPOSITON(t){const e=t.dimensions,n=[],i=[],o=[],s=this.getMap();for(let n=0;n<t.vertices.length;n+=e){WI.x=t.vertices[n],WI.y=t.vertices[n+1];const e=ZS(s,WI);t.vertices[n]=e[0],t.vertices[n+1]=e[1]}const a=ZS(this.getMap(),this.getCenter()),l={};l.a={x:t.vertices[0*e]-a[0],y:t.vertices[0*e+1]-a[1]},l.b={x:t.vertices[1*e]-a[0],y:t.vertices[1*e+1]-a[1]},l.c={x:t.vertices[2*e]-a[0],y:t.vertices[2*e+1]-a[1]},l.d={x:t.vertices[3*e]-a[0],y:t.vertices[3*e+1]-a[1]},this._positions=[];for(let n=0;n<4;n++)this._positions.push(t.vertices[n*e]-a[0]),this._positions.push(t.vertices[n*e+1]-a[1]),this._positions.push(0);for(let t=0;t<=20;t++)for(let e=0;e<=20;e++){const o=e/20,s=t/20;n.push((1-o)*(1-s)*l.a.x+o*(1-s)*l.b.x+o*s*l.c.x+(1-o)*s*l.d.x,(1-o)*(1-s)*l.a.y+o*(1-s)*l.b.y+o*s*l.c.y+(1-o)*s*l.d.y,0),i.push(o,1-s)}for(let t=0;t<20;t++)for(let e=0;e<20;e++){const n=21*t+e,i=21*(t+1)+e,s=i+1;o.push(n,n+1,s),o.push(n,s,i)}return{positions:n,uvs:i,triangles:o}}clearMesh(){this._dispose(),delete this._mesh,this.maskGeoJSON&&(this.maskGeoJSON=null)}_getMaskMode(){return HI[this._mode]}_getMaskColor(){const t=this.getSymbol(),{polygonFill:e,polygonOpacity:n}=t||GI,i=VS([],e);return i[3]=NS(n)?n:"texture"===this.getMode()?1:GI.polygonOpacity,i}_altitudeToPoint(t=0){const e=this.getMap(),n=e.getGLRes();return e.altitudeToPoint(t,n)}_setLocalTransform(t){const e=ZS(this.getMap(),this.getCenter()),n=xy(t.localTransform,z_(BI),e,zI);t.localTransform=n}_dispose(){this._mesh&&(this._mesh.material&&this._mesh.material.dispose(),this._mesh.geometry&&this._mesh.geometry.dispose(),this._copyMesh&&this._copyMesh.geometry&&(this._copyMesh.geometry.dispose(),this._copyMesh.dispose()),this._mesh.dispose(),delete this._mesh,delete this._copyMesh)}containsPoint(t){const e=this.getExtent();if(WI.set(t[0],t[1]),!e||!e.contains(WI))return!1;const n=this.getHoles();for(let e=0;e<n.length;e++)if(this._contains(n[e],t))return!1;const i=this.getShell();return this._contains(i,t)}_contains(t,e){const n=this._calArea(t);let i=0;for(let n=0;n<t.length;n++){jI.x=t[n].x,jI.y=t[n].y;const o=n+1>=t.length?0:n+1;UI.x=t[o].x,UI.y=t[o].y,WI.x=e[0],WI.y=e[1],VI[0]=WI,VI[1]=jI,VI[2]=UI;i+=this._calArea(VI)}return!(Math.abs(i-n)>1e-8)}_calArea(t){const e=this.getMap();let n=0;const i=e.getGLRes(),o=e.coordToPointAtRes(t[0],i,ZI);for(let h=1;h<t.length-1;h++){const c=e.coordToPointAtRes(t[h],i,qI),u=e.coordToPointAtRes(t[h+1],i,XI);n+=(((a=c).x-(s=o).x)*((l=u).y-s.y)-(a.y-s.y)*(l.x-s.x))/2}var s,a,l;
/*!
  * Contains code from THREE.js
  * MIT License
  * https://github.com/mrdoob/three.js
  */return n}}for(var JI=[],QI=0;QI<6;QI++)JI[QI]=[];var YI=[];function KI(t,e,n){!function(t){var e=t,n=e[0],i=e[1],o=e[2],s=e[3],a=e[4],l=e[5],h=e[6],c=e[7],u=e[8],f=e[9],g=e[10],A=e[11],m=e[12],w=e[13],T=e[14],M=e[15];$I(JI[0],s-n,c-a,A-u,M-m),$I(JI[1],s+n,c+a,A+u,M+m),$I(JI[2],s+i,c+l,A+f,M+w),$I(JI[3],s-i,c-l,A-f,M-w),$I(JI[4],s-o,c-h,A-g,M-T),$I(JI[5],s+o,c+h,A+g,M+T)}(t);for(var i=0;i<6;i++){var o=JI[i];if(YI[0]=o[0]>0?e[1][0]:e[0][0],YI[1]=o[1]>0?e[1][1]:e[0][1],YI[2]=o[2]>0?e[1][2]:e[0][2],tO(o,YI)<0)return!1}return!0}function $I(t,e,n,i,o){var s=1/Math.sqrt(e*e+n*n+i*i);return t[0]=e*s,t[1]=n*s,t[2]=i*s,t[3]=o*s,t}function tO(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]}const eO=new gh(0,0),nO=[0,0,0],iO=[0,0,0],rO=ay([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]);function oO(){return this._maskList?(this._maskList.forEach((t=>{t.remove()})),this._maskList=[],this.updateMaskExtent(),this):this}function sO(){for(let t=0;t<this._maskList.length;t++)if(this._maskList[t].isVisible())return!0;return!1}function aO(t){return class MaskLayerMixin extends t{removeMask(t){if(!this._maskList)return this;if(!t)return oO.call(this),this;const e=Array.isArray(t)?t:[t];for(let t=0;t<e.length;t++){const n=this._maskList.indexOf(e[t]);n>-1&&this._maskList.splice(n,1)}return this.updateMaskExtent(),this.fire("removemask",{masks:t}),this}setMask(t){return this.removeMask(null),this._maskList||(this._maskList=[]),Array.isArray(t)?t.forEach((t=>{this._maskList.push(t)})):this._maskList.push(t),this._maskList.forEach((t=>{t._bindLayer(this),t._updateCoordinates&&t._updateCoordinates()})),this.updateMaskExtent(),this.fire("setmask",{masks:t}),this}onAdd(){super.onAdd(),this.updateMaskExtent()}getMasks(){return this._maskList||[]}onGeometryEvent(t){if(!t||!t.target)return;"shapechange"===t.type&&t.target instanceof Mask&&t.target.clearMesh(),t.target instanceof Mask&&this.updateMaskExtent(),super.onGeometryEvent&&super.onGeometryEvent(t)}identifyMask(t,e){if(!this.getMap())return[];if(!this._maskList||!this._maskList.length)return[];const n=DS({},e);n.excludeMasks=!0;const i=this.identifyAtPoint(t,n),o=i.length&&i[0].coordinate;if(o){const t=this._maskList;if(!t)return[];const e=[];for(let n=0;n<t.length;n++){const i=t[n].getMode();!t[n].containsPoint(o)||"color"!==i&&"texture"!==i||e.push(t[n])}return e}return[]}remove(){this._maskList&&this._maskList.length&&this._maskList.forEach((t=>{t.remove()})),super.remove()}updateMask(t){const e=this.getMap(),{projViewMatrix:n,mapExtent:i}=this.getProjViewMatrixInOrtho(t);eO.x=i.xmin,eO.y=i.ymin;const o=lO(nO,eO,e);eO.x=i.xmax,eO.y=i.ymax;const s=lO(iO,eO,e);return{projViewMatrix:n,extentInWorld:[o[0],o[1],s[0],s[1]]}}getProjViewMatrixInOrtho(t){const e=this.getMap(),n=e.getView(),i=e.getFitZoom(t),o=t.getCenter();e.setView({center:o,zoom:i,pitch:0,bearing:0});const s=e.getExtent(),a=sy(rO,e.projViewMatrix);return e.setView(n),{mapExtent:s,projViewMatrix:a}}updateMaskExtent(){if(!this._maskList)return;if(!this.getMap())return;const t=this.getRenderer();if(t&&!this._maskList.length)return void t._clearMask();if(t&&!sO.call(this))return t._deleteMaskUniforms(),void t.setToRedraw();const e=this.getMaskExtent();if(!e)return;const{extent:n,ratio:i,minHeight:o}=e,{projViewMatrix:s,extentInWorld:a}=this.updateMask(n);this._maskProjViewMatrix=s,this._maskExtentInWorld=a,t?t.setMask(this._maskExtentInWorld,this._maskProjViewMatrix,i,o):this.once("renderercreate",(t=>{t.renderer.setMask(this._maskExtentInWorld,this._maskProjViewMatrix,i,o)}))}getMaskExtent(){let t=1/0,e=1/0,n=-1/0,i=-1/0,o=-1/0,s=1/0,a=!1;const l=this.getMap();for(let h=0;h<this._maskList.length;h++){const c=this._maskList[h];if(!c.isVisible())continue;const u=c.getExtent();if(u){if(c._mesh&&c.getBBox){const t=c.getBBox();if(!KI(l.projViewMatrix,t))continue}if(a=!0,u.xmin<t&&(t=u.xmin),u.ymin<e&&(e=u.ymin),u.xmax>n&&(n=u.xmax),u.ymax>i&&(i=u.ymax),c._getHeightRange){const t=c._getHeightRange();t[0]<s&&(s=t[0]),t[1]>o&&(o=t[1])}}}if(!a)return null;const{ratio:h,minHeight:c}=function(t,e){const n=t===1/0?0:t,i=Math.abs((e===-1/0?0:e)-n);return 0===i?{ratio:1,minHeight:0}:{ratio:Math.pow(i,-1),minHeight:n}}(s,o);return{extent:new Ph(t,e,n,i),ratio:h,minHeight:c}}}}function lO(t,e,n,i=0){if(!(n&&e instanceof gh))return null;const o=n.coordinateToPointAtRes(e,n.getGLRes());return t[0]=o.x,t[1]=o.y,t[2]=i,t}const hO=new gh(0,0),cO=new gh(0,0),uO=new _e(0,0),fO=[],dO={tileGrids:[],count:0},gO="01",pO="1";class TerrainLayer extends(aO(kp)){constructor(t,e){e&&!e.tileSystem&&("cesium"===e.type||"cesium-ion"===e.type?e.tileSystem=[1,1,-180,-90]:"tianditu"===e.type&&(e.tileSystem=[1,-1,-180,90])),e.tileSize||"mapbox"===e.type&&(e.tileSize=512),super(t,e)}onAdd(){const t=this.options,e=this.getMap().getProjection(),n="EPSG:3857"===e.code;512!==t.tileSize||t.spatialReference||("mapbox"===t.type?"EPSG:4326"===e.code||"EPSG:4490"===e.code?t.spatialReference="preset-4326-512":n&&(t.spatialReference="preset-3857-512"):"cesium"===t.type||"cesium-ion"===t.type?t.spatialReference="preset-4326-512":"tianditu"===t.type&&(t.spatialReference={projection:"EPSG:4326",fullExtent:{top:90,left:-180,bottom:-90,right:180},resolutions:function(){const t=[];for(let e=0;e<=22;e++)t[e]=90/(128*Math.pow(2,e));return t}()})),t.terrainWidth||"tianditu"!==t.type||(t.terrainWidth=65)}getTileUrl(t,e,n){let i=super.getTileUrl(t,e,n);return"mapbox"===this.options.type&&this.options.requireSkuToken&&(this._skuToken||(this._skuToken=this._createSkuToken()),i.indexOf("?")>-1?i+="&sku="+this._skuToken:i+="?sku="+this._skuToken),i}getMaxAvailableZoom(){return this.getSpatialReference().getMaxZoom()}_createSkuToken(){let t="";for(let e=0;e<10;e++)t+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return[pO,gO,t].join("")}_getExaggeration(){let t=this.options.exaggeration;return FS(t)&&(t=1),t}setSkinLayers(t){this._skinLayers=t;const e=this.getRenderer();e&&(e.clear(),e.setToRedraw())}getSkinTiles(t){const e=this.getRenderer();if(!e)return dO;const n=e.getTileGridsInCurrentFrame().tileGrids[0];if(!n)return dO;const i=t.getId(),o=this._getTileConfig().tileSystem.scale,s=t.getTileSize().width,a=n.tiles;if(!a.length)return dO;const l=this.getMap(),h=n.parents||fO,c=h.length,u=h.concat(a),f=t.getSpatialReference(),g=a[0].extent2d.getWidth(),A=o.x,m=o.y,w=[],T=[],M=new Set,C=this._getTileConfig().tileSystem.scale.y;for(let e=0;e<u.length;e++){const n=u[e],{res:o}=n;let a=n.nw;a||(a=n.nw=l.pointAtResToCoord(n.extent2d.getMin(uO),n.res));const{res:h,zoom:P}=aI(f,n.z,o),I=h/o,O=sI(h,s,o,g),{extent2d:E,offset:D}=n,N=O*n.x,H=O*n.y;if(n.skinTileIds||(n.skinTileIds={}),!n.skinTileIds[i]){const e=new Set,o=[],l=oI(t,n.x,n.y,P,a,D,m,O,0);for(let n=0;n<l.length;n++){const i=l[n];if(e.has(i.id))continue;i.idx=i.x,i.idy=i.y,i.res=h,i.url=t.getTileUrl(i.x,i.y,i.z+t.options.zoomOffset);const a=m*(i.skinY-H)*s,c=E.xmin*I+A*(i.x-N)*s,u=E.ymax*I+a,f=E.ymin*I+a;i.extent2d=C>0?new Oh(c,f,c+s,f+s):new Oh(c,u-s,c+s,u),e.add(i.id),o.push(i)}n.skinTileIds[i]=o}const U=n.skinTileIds[i];for(let t=0;t<U.length;t++)M.has(U[t].id)||(e<c?w.push(U[t]):T.push(U[t]),M.add(U[t].id))}return{tileGrids:[{extent:n.extent,tiles:T,parents:w,count:T.length}],count:T.length}}getSkinLayer(t){return this.getSkinLayers()[t]}getSkinLayers(){return this._skinLayers||fO}getSkinCount(){return this._skinLayers&&this._skinLayers.length||0}queryTerrainByProjCoord(t,e){e=e||[];const n=this.getRenderer();if(!n)return e[0]=null,e[1]=0,e;const i=this.getMap(),o=n._getTerrainTileAtPrjCoord(t);if(!o)return e[0]=null,e[1]=0,e;const s=i._prjToPointAtRes(t,1,uO);return n._queryTerrain(e,o.id,o,s,1)}queryTileTerrainByProjCoord(t,e,n,i){i=i||[];const o=this.getRenderer();if(!o)return i[0]=null,i[1]=0,i;const s=this.getMap()._prjToPointAtRes(t,1,uO);return o._queryTerrain(i,e,n,s,1)}queryTileTerrainByPointAtRes(t,e,n,i,o){o=o||[];const s=this.getRenderer();return s?s._queryTerrain(o,n,i,t,e):(o[0]=null,o[1]=0,o)}queryTerrain(t,e){e=e||[];if(!this.getRenderer())return e[0]=null,e[1]=0,e;const n=this.getMap().getProjection().project(t,hO);return this.queryTerrainByProjCoord(n,e)}queryTileMesh(t,e){const n=this.getRenderer();n&&n._queryTileMesh(t,e)}getTerrainTiles(t,e){const{x:n,y:i,z:o,res:s,offset:a}=e,l=e.extent2d.getWidth(),h=this._getTileConfig(),c=t._getTileConfig(),u=this.getSpatialReference(),{res:f,zoom:g}=aI(u,o,s),A=this.getTileSize().width,m=sI(f,A,s,l);let w=e.nw;w||(w=e.nw=this.getMap().pointAtResToCoord(e.extent2d.getMin(uO),e.res));const T=iI(this,n,i,g,w,a,c.tileSystem.scale.y,m,1)[0];for(let t=0;t<T.length;t++){const{x:e,y:n}=T[t],i=h.getTilePointNW(e,n,f,uO);T[t].res=f,T[t].extent2d=new Oh(i.x,i.y,i.x+A,i.y-A)}return T}isTerrainTileLoaded(t){const e=this.getRenderer();return!!e&&e.isTileCached(t)}updateMaterial(t){if(!t)return;this.options.material||(this.options.material={}),DS(this.options.material,t);const e=this.getRenderer();e&&e.updateMaterial(t)}setMaterial(t){if(!t)return;this.options.material=t;const e=this.getRenderer();e&&e.setMaterial(t)}_createTileNode(t,e,n,i,o,s,a,l,h,c){const u=this.getMap(),f=this.options.zoomOffset;if(!h){h=this._getTileConfig().getTilePrjExtent(t,e,s).convertTo((t=>u._prjToPointAtRes(t,s,cO)))}const g=this._getTileOffset(n);return{parent:l,layer:this.getId(),x:t,y:e,z:n,idx:i,idy:o,res:s,extent2d:h,id:c||this._getTileId(t,e,n),url:this.getTileUrl(t,e,n+f),offset:g,error:a,children:[]}}}TerrainLayer.mergeOptions({forceRenderOnMoving:!0,forceRenderOnZooming:!0,forceRenderOnRotating:!0,fadeAnimation:!1,fadeDuration:1e3/60*15,tileLimitPerFrame:2,newTerrainTileRenderLimitPerFrameOnInteracting:1,opacity:1,renderer:"gl",pyramidMode:1,tileSize:512,terrainWidth:null,backZoomOffset:0,depthMask:!0,blendSrc:"one",blendDst:"one minus src alpha",requireSkuToken:!0,cesiumIonTokenURL:"https://api.cesium.com/v1/assets/1/endpoint?access_token=",tileRetryCount:0,shader:"default",terrainTileMode:!0,tempTileCacheSize:64,tileStackStartDepth:7,tileStackDepth:6,currentTilesFirst:!1,exaggeration:1,colors:[]}),TerrainLayer.registerJSONType("TerrainLayer"),TerrainLayer.registerRenderer("gl",TerrainLayerRenderer);const AO=[],mO=[],yO=[],_O=[],vO=new _e(0,0),xO=[],bO=[],wO=[],TO=[],MO=[],CO=[],SO=[],PO=[],IO=[];class RayCaster{constructor(t,e,n=!0){this._from=t,this._to=e,this._isLngLat=n}setFromPoint(t){this._from=Array.isArray(t)?new gh(t):t}setToPoint(t){this._to=Array.isArray(t)?new gh(t):t}test(t,e,n={}){const i=n.count||0,o=[];let s=this._from,a=this._to;this._isLngLat&&(s=EO(e,this._from.x,this._from.y,this._from.z),a=EO(e,this._to.x,this._to.y,this._to.z));const l=new fa.Ray(s,a);for(let n=0;n<t.length;n++){const s=t[n];if(!this._checkBBox(s.getBoundingBox(),l))continue;const a=s.localTransform,h=s.geometry,c=h.data[h.desc.positionAttribute].array,u=h.data[h.desc.altitudeAttribute]&&h.data[h.desc.altitudeAttribute].array||xO,f=h.indices;if(!(c&&c.length&&f&&f.length))continue;const g=cy(TO,a,s.positionMatrix),A=this._testMesh(s,l,e,c,u,f,h.desc.positionSize,g,i);if(A){if(o.push({mesh:s,coordinates:A}),0!==i&&o.length>=i)break}}return o}_testMesh(t,e,n,i,o,s,a,l,h){const c=[];for(let u=0;u<s.length&&!(u>t.properties.skirtOffset);u+=3){const t=s[u],f=s[u+1],g=s[u+2],A=Fy(MO,i[t*a],i[t*a+1],i[t*a+2]),m=this._toWorldPosition(mO,n,A,o[t]/100,l),w=Fy(CO,i[f*a],i[f*a+1],i[f*a+2]),T=this._toWorldPosition(yO,n,w,o[f]/100,l),M=Fy(SO,i[g*a],i[g*a+1],i[g*a+2]),C=this._toWorldPosition(_O,n,M,o[g]/100,l),P=Fy(AO,m,T,C),I=e_(bO,m,T),O=e_(wO,m,C),E=this._testIntersection(PO,P,e);if(E){const e=n.pointAtResToAltitude(E[2],n.getGLRes());vO.x=E[0],vO.y=E[1];const i=n.pointAtResToCoordinate(vO,n.getGLRes());if(i.z=e,c.push({coordinate:i,indices:[t,f,g],normal:Xy([],I,O)}),0!==h&&c.length>=h)break}}return c.length?c:null}_toWorldPosition(t,e,n,i,o){let s;return hs.isNumber(i)?(s=e.altitudeToPoint(i,e.getGLRes()),g_(t,n[0],n[1],0,1),S_(t,t,o),t[2]=s):(g_(t,n[0],n[1],n[2],1),S_(t,t,o)),t}_testIntersection(t,e,n){return n.intersectTriangle(e[0],e[1],e[2],!0,t)}_checkBBox(t,e){return!!t&&e.intersectBox(t,IO)}}const OO=new gh(0,0);function EO(t,e,n,i){if(!t)return null;OO.set(e,n);const o=t.coordinateToPointAtRes(OO,t.getGLRes()),s=t.altitudeToPoint(i||0,t.getGLRes());return[o.x,o.y,s]}const kO=()=>{},RO=new gh(0,0),LO=[0,0,0],DO=[0,0,0],FO=[0,0,0];class GroupGLLayer extends Pf{static fromJSON(t){if(!t||"GroupGLLayer"!==t.type)return null;const e=t.layers.map((t=>Pf.fromJSON(t)));return new GroupGLLayer(t.id,e,t.options)}constructor(t,e,n){super(t,n),this.layers=e&&e.slice()||[],this.layers.forEach((t=>{if(t.getMap())throw new Error(`layer(${t.getId()} is already added on map`)})),this._checkChildren(),this.sortLayersByZIndex(),this._layerMap={}}sortLayersByZIndex(){if(this.layers&&this.layers.length){for(let t=0,e=this.layers.length;t<e;t++)this.layers[t].__group_gl_order=t;this.layers.sort(HO)}}setSceneConfig(t){this.options.sceneConfig=t;const e=this.getRenderer();return e&&e.updateSceneConfig(),this}getSceneConfig(){return JSON.parse(JSON.stringify(this._getSceneConfig()))}_getSceneConfig(){return this.options.sceneConfig||{}}getGroundConfig(){return this._getSceneConfig().ground}getWeatherConfig(){return this._getSceneConfig().weather}getScanEffectConfig(){const t=this._getSceneConfig();return t.postProcess&&t.postProcess.scanEffect}addLayer(t,e){if(t.getMap())throw new Error(`layer(${t.getId()}) is already added on map`);if("gl"!==t.options.renderer)throw new Error(`layer(${t.getId()})'s renderer is canvas, not supported to be added to GroupGLLayer`);void 0===e?this.layers.push(t):this.layers.splice(e,0,t),this._checkChildren(),this.sortLayersByZIndex();const n=this.getRenderer();return n?(this._prepareLayer(t),this._updateTerrainSkinLayers(),n.setToRedraw(),this):this}removeLayer(t){hs.isString(t)&&(t=this.getChildLayer(t));const e=this.layers.indexOf(t);if(e<0)return this;const n=t.getRenderer();n&&n.setTerrainHelper&&n.setTerrainHelper(null),t._doRemove(),this._unbindChildListeners(t),delete this._layerMap[t.getId()],this.layers.splice(e,1);const i=this.getRenderer();return i?(this._updateTerrainSkinLayers(),i.setToRedraw(),this):this}clearLayers(){const t=this.getLayers();for(let e=0;e<t.length;e++)t[e]&&t[e].remove();return this}_updatePolygonOffset(){let t=0;for(let e=0;e<this.layers.length;e++){const n=this.layers[e];n.setPolygonOffset&&n.getPolygonOffsetCount&&(t+=n.getPolygonOffsetCount())}let e=0;for(let n=this.layers.length-1;n>=0;n--){const i=this.layers[n];i.setPolygonOffset&&i.getPolygonOffsetCount&&(i.setPolygonOffset(e,t),e+=i.getPolygonOffsetCount())}this._polygonOffset=e}getPolygonOffsetCount(){return this._polygonOffset}getLayers(){return this.layers.slice()}_getLayers(){return this.layers}toJSON(){const t=[];if(this.layers)for(let e=0;e<this.layers.length;e++){const n=this.layers[e];n&&(n&&n.toJSON&&t.push(n.toJSON()))}return{type:this.getJSONType(),id:this.getId(),layers:t,options:this.config()}}onLoadEnd(){this.layers.forEach((t=>{this._prepareLayer(t)})),this.options.terrain&&this._initTerrainLayer(),super.onLoadEnd()}_prepareLayer(t){const e=this.getMap();this._layerMap[t.getId()]=t,t._canvas=this.getRenderer().canvas,t._bindMap(e),t.once("renderercreate",this._onChildRendererCreate,this),t.remove=()=>(this.removeLayer(t),t.constructor.prototype.remove.call(t),delete t.remove,this),t.load(),this._bindChildListeners(t)}onRemove(){this._removeTerrainLayer(),this.layers.forEach((t=>{this._resetSkinLayer(t),t._doRemove(),this._unbindChildListeners(t)})),this._layerMap={},this.clearAnalysis(),super.onRemove()}getChildLayer(t){return this._layerMap[t]||null}getLayer(t){return this.getChildLayer(t)}_bindChildListeners(t){t.on("show hide",this._onLayerShowHide,this),t.on("idchange",this._onLayerIDChange,this)}_unbindChildListeners(t){t.off("show hide",this._onLayerShowHide,this),t.off("idchange",this._onLayerIDChange,this)}_onLayerShowHide(){const t=this.getRenderer();t&&t.setToRedraw()}_onLayerIDChange(t){const e=t.new,n=t.old,i=this.getLayer(n);delete this._layerMap[n],this._layerMap[e]=i}_onChildRendererCreate(t){t.renderer.clearCanvas=NO}_checkChildren(){const t={};this.layers.forEach((e=>{const n=e.getId();if(t[n])throw new Error(`Duplicate child layer id (${n}) in the GroupGLLayer (${this.getId()})`);t[n]=1}))}addAnalysis(t){this._analysisTaskList=this._analysisTaskList||[],this._analysisTaskList.push(t);const e=this.getRenderer();e&&e.setToRedraw()}removeAnalysis(t){if(this._analysisTaskList){const e=this._analysisTaskList.indexOf(t);e>-1&&(this._analysisTaskList.splice(e,1),t.remove())}const e=this.getRenderer();e&&e.setToRedraw()}clearAnalysis(){this._analysisTaskList&&(this._analysisTaskList.forEach((t=>{t.remove()})),this._analysisTaskList=[]);const t=this.getRenderer();t&&t.setToRedraw()}identify(t,e){const n=this.getMap(),i=this.getRenderer();if(!n||!i)return[];const o=n.coordToContainerPoint(new gh(t));return this.identifyAtPoint(o,e)}identifyAtPoint(t,e={}){const n=e.includeInternals,i=this.getLayers(),o=e&&e.childLayers||i,s=this.getMap();if(!s)return[];const a=FS(e.count)?1:e.count;let l=[];for(let s=o.length-1;s>=0;s--){const a=o[s];if(i.indexOf(a)<0||!a.identifyAtPoint)continue;const h=a.options.geometryEvents;if(n&&(void 0===h||!1===h||0===h))continue;if(a.isGeometryListening&&n&&e.eventTypes.indexOf("mousemove")>=0&&!a.isGeometryListening(e.eventTypes))continue;const c=a.identifyAtPoint(t,e);if(!c||!c.length)continue;const u=a.getId();for(let t=0;t<c.length;t++)c[t]&&(c[t].layer=u);l.push(...c)}if(e.orderByCamera){const t=s.cameraPosition;l.sort(((e,n)=>n.point?e.point?r_(e.point,t)-r_(n.point,t):1:-1))}return a&&(l=l.slice(0,a)),l}getTerrain(){return this.options.terrain}setTerrain(t){return this.options.terrain=t,this.getRenderer()?(this._initTerrainLayer(),this.getMap().updateCenterAltitude(),this):this}removeTerrain(){return this.setTerrain(null)}updateTerrainMaterial(t){this._terrainLayer&&t&&(this.options.terrain.material?DS(this.options.terrain.material,t):this.options.terrain.material=t,this._terrainLayer.updateMaterial(t))}_initTerrainLayer(){const t=this.getRenderer();t&&t.setToRedraw();const e=this.options.terrain;if(this._terrainLayer){const t=this._terrainLayer,n=t.options;if(e&&n.urlTemplate===e.urlTemplate&&n.spatialReference===e.spatialReference){for(const n in e)"material"===n?t.setMaterial(e[n]):"urlTemplate"!==n&&"spatialReference"!==n&&t.config(n,e[n]);return this}this._removeTerrainLayer()}if(this._resetTerrainSkinLayers(),!e)return this;this._terrainLayer=new TerrainLayer("__terrain_in_group",e),this._updateTerrainSkinLayers();const n=this._terrainLayer;n.on("tileload",this._onTerrainTileLoad,this),this._prepareLayer(n);const i=e.masks;return i&&i.length?n.setMask(i):n.removeMask(),this.fire("terrainlayercreated"),this}queryTerrain(t,e){return this._terrainLayer?this._terrainLayer.queryTerrain(t,e):(e&&(e[0]=null,e[1]=0),[null,0])}queryTerrainAtPoint(t){if(!this._terrainLayer)return null;const e=this._terrainLayer.getRenderer().getAnalysisMeshes();return this._queryRayCast(t,e)}query3DTilesAtPoint(t){const e=this._getLayers().filter((t=>t&&t.isGeo3DTilesLayer));if(!e.length)return null;const n={excludeMasks:!0};for(let i=0;i<e.length;i++){if(!e[i].getRenderer())continue;const o=e[i].identifyAtPoint(t,n);if(o.length)return new gh(o[0].coordinate)}return null}_queryRayCast(t,e){const n=this.getMap(),i=n.getGLRes();n.getContainerPointRay(DO,FO,t);const o=new RayCaster(DO,FO,!1).test(e,n,{count:1}),s=[];o.forEach((t=>{t.coordinates.forEach((t=>{s.push(t.coordinate)}))}));const a=n.pointAtResToCoordinate(new _e(DO[0],DO[1]),i,RO);this._meterToGLPoint||(this._meterToGLPoint=n.altitudeToPoint(1,i)),a.z=DO[2]/this._meterToGLPoint;const l=Fy(LO,a.x,a.y,a.z);return s.sort(((t,e)=>r_(t.toArray(),l)-r_(e.toArray(),l))),s[0]}queryTerrainByProjCoord(t,e){return this._terrainLayer?this._terrainLayer.queryTerrainByProjCoord(t,e):(e&&(e[0]=null,e[1]=0),[null,0])}_updateTerrainSkinLayers(){if(!this._terrainLayer)return;const t=this.layers,e=[];for(let n=0;n<t.length;n++){if(!t[n])continue;const i=t[n],o=i.getRenderer();if(o.renderTerrainSkin){if(o.deleteTile===kO){e.push(t[n]);continue}i.getTiles=()=>this._terrainLayer&&this._terrainLayer.getSkinTiles(i),o.drawTile=o.drawTileOnTerrain?(...t)=>o.drawTileOnTerrain(...t):kO,o.deleteTile=kO,e.push(t[n])}o.setTerrainHelper&&o.setTerrainHelper(this._terrainLayer)}this._terrainLayer.setSkinLayers(e)}_resetSkinLayer(t){if(!function(t){if(!t)return!1;const e=t.getRenderer();if(!e)return!1;return!!e.renderTerrainSkin}(t))return;const e=t.getRenderer();e&&(e.setTerrainHelper&&e.setTerrainHelper(null),e.clear&&e.clear(),delete e.drawTile,delete e.deleteTile),delete t.getTiles}_resetTerrainSkinLayers(){const t=this.layers;for(let e=0;e<t.length;e++)t[e]&&this._resetSkinLayer(t[e])}_onTerrainTileLoad(){const t=this.getRenderer();t&&t.setToRedraw()}_removeTerrainLayer(){if(this._terrainLayer){const t=this._terrainLayer;t.off("tileload",this._onTerrainTileLoad,this),this._unbindChildListeners(t),this._terrainLayer._doRemove(),delete this._terrainLayer,this.fire("terrainlayerremoved")}}getTerrainLayer(){return this._terrainLayer}_bindMap(...t){if(this.options.single){const e=t[0].getLayers();for(let t=0;t<e.length;t++)if(e[t]instanceof GroupGLLayer)throw new Error("Only one GroupGLLayer is allowed in a map instance. Set options.single to false if you want to add two or more GroupGLLayers.")}return super._bindMap(...t)}fire(...t){if("layerload"===t[0]){const t=this._getLayers();for(const e of t){const t=e.getRenderer();t&&t.isRenderComplete()&&e.fire("layerload")}}super.fire(...t)}}function NO(){}function HO(t,e){const n=t.getZIndex()-e.getZIndex();return 0===n?t.__group_gl_order-e.__group_gl_order:n}var BO;GroupGLLayer.mergeOptions({renderer:"gl",antialias:!0,extensions:[],single:!0,onlyWebGL1:!1,optionalExtensions:["ANGLE_instanced_arrays","OES_element_index_uint","OES_standard_derivatives","OES_vertex_array_object","OES_texture_half_float","OES_texture_half_float_linear","OES_texture_float","OES_texture_float_linear","WEBGL_depth_texture","EXT_shader_texture_lod","EXT_frag_depth","EXT_texture_filter_anisotropic","WEBGL_compressed_texture_astc","WEBGL_compressed_texture_etc","WEBGL_compressed_texture_etc1","WEBGL_compressed_texture_pvrtc","WEBGL_compressed_texture_s3tc","WEBGL_compressed_texture_s3tc_srgb"],forceRenderOnZooming:!0,forceRenderOnMoving:!0,forceRenderOnRotating:!0,viewMoveThreshold:100,geometryEvents:!0,multiSamples:4,forceRedrawPerFrame:!1}),GroupGLLayer.registerJSONType("GroupGLLayer"),GroupGLLayer.registerRenderer("gl",class GroupGLLayerRenderer extends vm.CanvasRenderer{setToRedraw(){this.setRetireFrames(),super.setToRedraw()}onAdd(){super.onAdd(),this.prepareCanvas()}updateSceneConfig(){this._groundPainter&&this._groundPainter.update(),this._envPainter&&this._envPainter.update(),this._weatherPainter&&this._weatherPainter.update(),this.setToRedraw()}render(...t){this.getMap()&&this.layer.isVisible()&&(this.forEachRenderer((t=>{t._replacedDrawFn||(t.draw=this._buildDrawFn(t.draw),t.drawOnInteracting=this._buildDrawOnInteractingFn(t.drawOnInteracting),t.setToRedraw=this._buildSetToRedrawFn(t.setToRedraw),t._replacedDrawFn=!0)})),this.prepareRender(),this.prepareCanvas(),this.layer._updatePolygonOffset(),this._toRedraw=!1,this._renderChildLayers("render",t),this._renderOutlines(),this._postProcess())}prepareCanvas(){super.prepareCanvas(),this.forEachRenderer((t=>{t.prepareCanvas()}))}drawOnInteracting(...t){this.getMap()&&this.layer.isVisible()&&(this.layer._updatePolygonOffset(),this._toRedraw=!1,this._renderChildLayers("drawOnInteracting",t),this._renderOutlines(),this._postProcess())}_renderChildLayers(t,e){this._renderMode="default";const n=this.hasRenderTarget(),i=this._getDrawContext(e);if(n&&(this._drawContext.renderTarget=this._getFramebufferTarget()),this._envPainter.paint(i),this.drawGround(!0),!n)return void this._renderInMode("default",null,t,e,!0);const o=this.glCtx,s=this.layer._getSceneConfig(),a=s&&s.postProcess,l=this.isSSROn();i.jitter=qP;const h=this.layer.getGroundConfig();i.hasSSRGround=!!(l&&h&&h.enable&&h.symbol&&h.symbol.ssr),o.resetDrawCalls(),this._renderInMode("default",this._targetFBO,t,e),l&&this._postProcessor.drawSSR(this._blitDepthTex(),this._targetFBO);a.bloom&&a.bloom.enable&&(this._bloomPainted=this._postProcessor.drawBloom(this._depthTex)),2===l&&this._postProcessor.drawSSR(this._blitDepthTex(),this._targetFBO,!0),o.resetDrawCalls(),this._weatherPainter.renderScene(i),this._pointDrawCount=o.getDrawCalls()}_renderInMode(t,e,n,i,o){this._renderMode=t;const s=this._getDrawContext(i);s.renderMode=this._renderMode,s.renderTarget&&(s.renderTarget.fbo=e),o&&(s.isFinalRender=!0),this.forEachRenderer(((t,o)=>{o.isVisible()&&(this.clearStencil(t,e),t[n].apply(t,i))}))}_getDrawContext(t){let e=t[0];return YP(e)||(e=t[1]),e!==this._contextFrameTime&&(this.forEachRenderer(((t,e)=>{e.isVisible()&&t.needRetireFrames&&t.needRetireFrames()&&this.setRetireFrames()})),this._drawContext=this._prepareDrawContext(e),this._contextFrameTime=e,this._frameEvent=YP(t[0])?null:t[0]),this._drawContext}_renderOutlines(){if(!this.isEnableOutline())return;const t=this._getOutlineFBO(),e=this.glCtx;e.resetDrawCalls(),this.forEachRenderer(((e,n)=>{n.isVisible()&&e.drawOutline&&e.drawOutline(t)})),this._outlineCounts=e.getDrawCalls()}_getOutlineFBO(){const{width:t,height:e}=this.canvas;let n=this._outlineFBO;if(n)t===n.width&&e===n.height||n.resize(t,e);else{const i=this.regl.texture({width:t,height:e,format:"rgba4"});n=this._outlineFBO=this.regl.framebuffer({width:t,height:e,colors:[i],depth:!1,stencil:!1})}return n}_getFBOColor(t){if(this._isUseMultiSample()){const e=this._getBlitFBO(t);return e.width!==t.width||e.height!==t.height?e.resize(t.width,t.height):this.regl.clear({color:[0,0,0,0],fbo:e}),e.blit(t),e.color[0]}return t.color[0]}_blitDepthTex(){if(this._depthTex.subimage)return this._depthTex;const{width:t,height:e}=this._depthTex;if(!this._blitDepthFBO){const n=this.regl,i=n.texture({min:"nearest",mag:"nearest",mipmap:!1,type:"depth stencil",width:t,height:e,format:"depth stencil"}),o=n.renderbuffer({width:t,height:e,format:"rgba4"});this._blitDepthFBO=n.framebuffer({depthStencil:i,colors:[o],colorFormat:"rgba4",width:t,height:e})}return this._blitDepthFBO.width===t&&this._blitDepthFBO.height===e||this._blitDepthFBO.resize(t,e),this.regl.clear({color:[0,0,0,0],depth:1,fbo:this._blitDepthFBO}),this._blitDepthFBO.blit(this._targetFBO,256,"nearest"),this._blitDepthFBO.depthStencil}_getBlitFBO(t){if(this._blitFBOs||(this._blitFBOs=[]),!t._blitFBO){const e=this._createSimpleFBOInfo(!0,t.width,t.height),n=this.regl.framebuffer(e);this._blitFBOs.push(n),t._blitFBO=n}return t._blitFBO}_isUseMultiSample(){return 0===this.regl.limits.version.indexOf("WebGL 2.0")&&this.layer.options.antialias}hasRenderTarget(){const t=this.layer._getSceneConfig(),e=t&&t.postProcess;return!(!e||!e.enable)}testIfNeedRedraw(){if(this.layer.options.forceRedrawPerFrame)return!0;if(this._toRedraw)return this._toRedraw=!1,!0;if(this.getMap().isInteracting()&&(this._groundPainter&&this._groundPainter.isEnable()||this._envPainter&&this._envPainter.isEnable()))return!0;if(this._weatherPainter&&this._weatherPainter.isEnable())return!0;if(this.isEnableScanEffect())return!0;const t=this.layer.getTerrainLayer();if(t){const e=t.getRenderer();if(e&&e.testIfNeedRedraw())return this._needUpdateSSR=!0,!0}const e=this._getLayers();for(const t of e){if(!t)continue;const e=t.getRenderer();if(e&&e.testIfNeedRedraw())return this._needUpdateSSR=!0,!0}return!1}isRenderComplete(){const t=this._getLayers();for(const e of t){const t=e.getRenderer();if(t&&!t.isRenderComplete())return!1}return!0}mustRenderOnInteracting(){const t=this._getLayers();for(const e of t){const t=e.getRenderer();if(t&&t.mustRenderOnInteracting())return!0}return!1}isCanvasUpdated(){if(super.isCanvasUpdated())return!0;const t=this._getLayers();for(const e of t){const t=e.getRenderer();if(t&&t.isCanvasUpdated())return!0}return!1}isBlank(){if(this._groundPainter&&this._groundPainter.isEnable())return!1;if(this._envPainter&&this._envPainter.isEnable())return!1;const t=this.layer.getTerrainLayer();if(t){const e=t.getRenderer();if(e&&!e.isBlank())return!1}const e=this._getLayers();for(const t of e){const e=t.getRenderer();if(e&&!e.isBlank())return!1}return!0}createContext(){const t=this.layer,e=t.options.glOptions||{alpha:!0,depth:!0,stencil:!0};e.preserveDrawingBuffer=!0,e.antialias=!!t.options.antialias,this.glOptions=e;const n=this.gl=function(t,e,n){const i=n?["webgl","experimental-webgl"]:["webgl2","webgl","experimental-webgl"];let o=null;for(let n=0;n<i.length;++n){try{o=t.getContext(i[n],e)}catch(t){}if(o)break}return o||console.error("Browser doesn't support WebGL."),o}(this.canvas,e,t.options.onlyWebGL1);this._initGL(n),n.wrap=()=>new DC(this.gl),this.glCtx=n.wrap(),this.canvas.gl=this.gl,this.reglGL=n.wrap(),this.regl=Dm({gl:this.reglGL,attributes:e,extensions:t.options.extensions,optionalExtensions:t.options.optionalExtensions}),this.gl.regl=this.regl,this._jitter=[0,0],this._groundPainter=new GroundPainter(this.regl,this.layer),this._envPainter=new EnvironmentPainter(this.regl,this.layer);const i=this.layer.getWeatherConfig();this._weatherPainter=new WeatherPainter(this.regl,t,i),this._analysisPainter=new AnalysisPainter(this.regl,t),this._scanEffectPainter=new ScanEffectPainter(this.regl,t);const o=this.layer._getSceneConfig()||{},s=o&&o.postProcess;this._jitGetter=new Yw(s&&s.antialias&&s.antialias.jitterRatio||.2),this._postProcessor=new PostProcess(this.regl,this.layer,this._jitGetter),this._shadowProcess=new ShadowProcess(this.regl,this.layer)}_initGL(){const t=this.layer,e=this.gl,n=t.options.extensions;n&&n.forEach((t=>{e.getExtension(t)}));const i=t.options.optionalExtensions;i&&i.forEach((t=>{e.getExtension(t)})),this.gl.clearColor(0,0,0,0)}clearCanvas(){super.clearCanvas(),this._clearFramebuffers()}_clearFramebuffers(){const t=this.regl;this._targetFBO&&t.clear({color:WP,depth:1,stencil:255,framebuffer:this._targetFBO}),this._outlineFBO&&t.clear({color:WP,framebuffer:this._outlineFBO}),t.clear({color:WP,depth:1,stencil:255})}resizeCanvas(){const t=this.canvas.width,e=this.canvas.height;!this._targetFBO||this._targetFBO.width===t&&this._targetFBO.height===e||(super.resizeCanvas(),this._targetFBO.resize(t,e),this._clearFramebuffers(),this.forEachRenderer((t=>{t.canvas&&t.resizeCanvas()})))}getCanvasImage(){return this.forEachRenderer((t=>{t.getCanvasImage()})),super.getCanvasImage()}_getLayers(){return this.layer._getLayers()}forEachRenderer(t){const e=this._getLayers();for(const n of e){if(!n.isVisible()||!n.options.beneathTerrain)continue;const e=n.getRenderer();e&&t(e,n)}const n=this.layer.getTerrainLayer();if(n){const e=n.getRenderer();e&&t(e,n)}for(const n of e){if(!n.isVisible()||n.options.beneathTerrain)continue;const e=n.getRenderer();e&&t(e,n)}}clearStencil(t,e){const n={stencil:t.getStencilValue?t.getStencilValue():255};e&&(n.framebuffer=e),this.regl.clear(n)}onRemove(){this.canvas.pickingFBO&&this.canvas.pickingFBO.destroy&&this.canvas.pickingFBO.destroy(),this._destroyFramebuffers(),this._groundPainter&&(this._groundPainter.dispose(),delete this._groundPainter),this._envPainter&&(this._envPainter.dispose(),delete this._envPainter),this._shadowProcess&&(this._shadowProcess.dispose(),delete this._shadowProcess),this._postProcessor&&(this._postProcessor.dispose(),delete this._postProcessor),this._outlineFBO&&(this._outlineFBO.destroy(),delete this._outlineFBO),this._weatherPainter&&(this._weatherPainter.dispose(),delete this._weatherPainter),super.onRemove()}_destroyFramebuffers(){if(this._targetFBO&&(this._targetFBO.destroy(),delete this._targetFBO,this._postFBO&&(this._postFBO.destroy(),delete this._postFBO),this._blitDepthFBO&&(this._blitDepthFBO.destroy(),delete this._blitDepthFBO),this._blitFBOs)){for(let t=0;t<this._blitFBOs.length;t++)this._blitFBOs[t]&&this._blitFBOs[t].destroy();delete this._blitFBOs}}setRetireFrames(){this._needRetireFrames=!0}getFrameTime(){return this._contextFrameTime}getFrameEvent(){return this._frameEvent}getFrameContext(){return this._drawContext}drawGround(t){const e=this.layer.getGroundConfig();if(!e||!e.enable)return!1;if(!this._groundPainter)return!1;const n=this.getFrameContext(),i=n.jitter;n.jitter=qP;const o=this.layer.getPolygonOffsetCount();let s;n.offsetFactor=o+1,n.offsetUnits=o+1,t&&(s=n.sceneFilter,delete n.sceneFilter);const a=this._groundPainter.paint(n);return this._groundPainter.needToRedraw()&&this.setToRedraw(),s&&(n.sceneFilter=s),n.jitter=i,a}_buildDrawFn(t){const e=this;return function(n,i){return(i=i||e._drawContext)&&i.renderTarget&&(i.renderTarget.getFramebuffer=KP,i.renderTarget.getDepthTexture=$P),t.call(this,n,i)}}_buildDrawOnInteractingFn(t){const e=this;return function(n,i,o){return(o=o||e._drawContext)&&o.renderTarget&&(o.renderTarget.getFramebuffer=KP,o.renderTarget.getDepthTexture=$P),t.call(this,n,i,o)}}_buildSetToRedrawFn(t){return function(...e){return t.apply(this,e)}}isEnableSSR(){const t=this.layer._getSceneConfig(),e=t&&t.postProcess;return e&&e.enable&&e.ssr&&e.ssr.enable}isSSROn(){const t=this.isEnableSSR(),e=this.getMap();if(!t||e.getPitch()<=-.001)return 0;const n=e.projViewMatrix,i=this._postProcessor.getPrevSsrProjViewMatrix();return i&&Iy(i,n)?1:2}isEnableTAA(){return!1}isEnableSSAO(){return!1}isEnableOutline(){const t=this.layer._getSceneConfig(),e=t&&t.postProcess;return e&&e.enable&&e.outline&&e.outline.enable}isEnableWeather(){const t=this.layer._getSceneConfig(),e=t&&t.weather;return e&&e.enable}_getViewStates(){const t=this.layer.getMap();if(!this._renderedView){this._renderedView={center:t.getCenter(),bearing:t.getBearing(),pitch:t.getPitch(),res:t.getResolution()};let e=!1;if(t.options.lights){const n=t.getLightManager().getDirectionalLight().direction||ZP;this._renderedView.lightDirection=Dy([],n),e=!0}return{viewChanged:!0,lightDirectionChanged:e}}const e=t.getResolution()/this._renderedView.res,n=t.coordToContainerPoint(this._renderedView.center),i=this.layer.options.viewMoveThreshold,o=n._sub(t.width/2,t.height/2).mag()>i||e<.95||e>1.05;let s=!1;if(t.options.lights){const e=t.getLightManager().getDirectionalLight().direction||ZP;s=!$y(this._renderedView.lightDirection,e),s&&(this._renderedView.lightDirection=Dy([],e))}return o&&(this._renderedView.center=t.getCenter(),this._renderedView.bearing=t.getBearing(),this._renderedView.pitch=t.getPitch(),this._renderedView.res=t.getResolution()),{viewChanged:o,lightDirectionChanged:s}}_prepareDrawContext(t){const e=this.layer._getSceneConfig(),n=e&&e.postProcess,i=e&&e.weather,o={timestamp:t,renderMode:this._renderMode||"default",includes:{},states:this._getViewStates(),testSceneFilter:t=>!o.sceneFilter||o.sceneFilter(t),isFinalRender:!1,weather:{fog:i&&i.fog}},s=this._jitGetter;s&&s.setRatio(n&&n.antialias&&n.antialias.jitterRatio||.2);const a=this.isSSROn();let l;if(n&&n.enable){if(this.isEnableTAA()){(this.getMap().isInteracting()||this._needRetireFrames)&&s.reset(),s.getJitter(this._jitter),s.frame()}else Ev(this._jitter,0,0);o.jitter=this._jitter;const t=n.bloom&&n.bloom.enable;t&&a?(o.bloom=1,o.sceneFilter=XP):t?(o.bloom=1,o.sceneFilter=JP):a&&(o.sceneFilter=QP),l=this._getFramebufferTarget(),l&&(o.renderTarget=l)}else this._destroyFramebuffers();return"noAa"!==this._renderMode&&(this._shadowContext=this._prepareShadowContext(o),this._shadowContext&&(o.includes.shadow=1),this._includesState=this._updateIncludesState(o)),this._shadowContext&&(o.shadow=this._shadowContext,o.includes.shadow=1),o.states.includesChanged=this._includesState,n&&n.enable&&this._postProcessor&&this._postProcessor.setContextIncludes(o),o}_renderAnalysis(t){const e=this._getLayers().filter((t=>t.isVisible()));return this.layer.getTerrainLayer()&&e.push(this.layer.getTerrainLayer()),this._analysisPainter.paint(t,e)}_updateIncludesState(t){let e=!1;const n=Object.keys(t.includes),i=this._prevIncludeKeys;if(i){const t=n.filter((t=>-1===i.indexOf(t))).concat(i.filter((t=>-1===n.indexOf(t))));t.length&&(e=t.reduce(((t,e)=>(t[e]=1,t)),{}))}return this._prevIncludeKeys=n,e}_prepareShadowContext(t){const e=this.layer._getSceneConfig();if(!e||!e.shadow||!e.shadow.enable)return this._shadowProcess&&(this._shadowProcess.dispose(),delete this._shadowProcess),null;this._shadowProcess||(this._shadowProcess=new ShadowProcess(this.regl,this.layer));const n={config:e.shadow,defines:this._shadowProcess.getDefines(),uniformDeclares:ShadowProcess.getUniformDeclares()};return n.renderUniforms=this._renderShadow(t),n}_renderShadow(t){const e=t.renderTarget&&t.renderTarget.fbo,n=this.layer._getSceneConfig(),i=[];let o=t.states.lightDirectionChanged||t.states.viewChanged;this.forEachRenderer(((t,e)=>{if(!t.getShadowMeshes||!e.isVisible())return;const n=t.getShadowMeshes();if(Array.isArray(n))for(let t=0;t<n.length;t++)n[t]&&(n[t].needUpdateShadow&&(o=!0,n[t].needUpdateShadow=!1),n[t].hasFunctionUniform&&(n[t].hasFunctionUniform("minAltitude")||n[t].setFunctionUniform("minAltitude",(()=>e&&e.options.altitude||0)),i.push(n[t])))})),this._shadowScene||(this._shadowScene=new _w),this._shadowScene.setMeshes(i);const s=this.getMap(),a=n.shadow,l=s.getLightManager(),h=l&&l.getDirectionalLight().direction||ZP;return this._shadowProcess.render(!n.ground||!n.ground.enable,s.projMatrix,s.viewMatrix,a.color,a.opacity,h,this._shadowScene,this._jitter,e,o)}_renderWeather(t){let e=[];if(this.forEachRenderer(((t,n)=>{if(!t.getAnalysisMeshes||!n.isVisible())return;const i=t.getAnalysisMeshes();e=e.concat(i)})),this._groundPainter){const t=this._groundPainter.getRenderMeshes();e=e.concat(t)}const n=this.layer.getWeatherConfig();return this._weatherPainter.paint(t,e,n)}_renderScanEffect(t){let e=[];if(this.forEachRenderer(((t,n)=>{if(!t.getAnalysisMeshes||!n.isVisible())return;const i=t.getAnalysisMeshes();e=e.concat(i)})),this._groundPainter){const t=this._groundPainter.getRenderMeshes();e=e.concat(t)}return this._scanEffectPainter.paint(t,e)}getGroundMesh(){if(this._groundPainter){return this._groundPainter.getRenderMeshes()}return[]}_getFramebufferTarget(){const t=this.layer._getSceneConfig();if(!this._targetFBO){const e=this.regl;let n=this._depthTex;(!n||!n._texture||n._texture.refCount<=0)&&(n=null);const i=this.createFBOInfo(t&&t.postProcess,n);this._depthTex=i.depth||i.depthStencil,this._targetFBO=e.framebuffer(i),this._clearFramebuffers()}return{fbo:this._targetFBO}}_createSimpleFBOInfo(t,e,n){e=e||this.canvas.width,n=n||this.canvas.height;const i=this.regl,o=this._isUseMultiSample();let s;if(!t&&o)s=i.renderbuffer({width:e,height:n,samples:this.layer.options.multiSamples,format:"rgba8"});else{s=i.texture({min:"nearest",mag:"nearest",type:"uint8",width:e,height:n})}return{width:e,height:n,colors:[s],colorFormat:o?"rgba8":"rgba"}}createFBOInfo(t,e){let{width:n,height:i}=this.canvas;n=n||1,i=i||1;const o=this.regl,s=this._createSimpleFBOInfo(),a=this._isUseMultiSample(),l=o.hasExtension("WEBGL_depth_texture");if(a){const t=e||o.renderbuffer({width:n,height:i,format:"depth24 stencil8",samples:this.layer.options.multiSamples});s.depthStencil=t}else if(l){const t=e||o.texture({min:"nearest",mag:"nearest",mipmap:!1,type:"depth stencil",width:n,height:i,format:"depth stencil"});s.depthStencil=t}else{const t=e||o.renderbuffer({width:n,height:i,format:"depth stencil"});s.depthStencil=t}return s}_postProcess(){if(!this._targetFBO)return void(this._needRetireFrames=!1);const t=this.layer._getSceneConfig(),e=t&&t.postProcess;if(!e||!e.enable){if(this.isEnableWeather())throw new Error("you must enable the post process to turn on weather");return}this.layer.fire("postprocessstart");const n=this.layer.getMap();let i=e.sharpen&&e.sharpen.factor;i||0===i||(i=.2);let o=0,s=.2,a=.3,l=1,h=[1,1,0];e.outline&&(o=+!!e.outline.enable,s=tI(e.outline,"highlightFactor",s),a=tI(e.outline,"outlineFactor",a),l=tI(e.outline,"outlineWidth",l),h=tI(e.outline,"outlineColor",h));const c=e.ssr&&e.ssr.enable,u=e.bloom&&e.bloom.enable,f=this._analysisPainter._hasAnalysis(),g=this._weatherPainter._hasWeather(),A=this.isEnableScanEffect(),m=u||c||f||g||A;let w=this._postFBO;if(m){if(!w){const t=this._createSimpleFBOInfo();this._isUseMultiSample()&&(t.depthStencil=this.regl.renderbuffer({width:this.canvas.width,height:this.canvas.height,samples:this.layer.options.multiSamples,format:"depth24 stencil8"})),w=this._postFBO=this.regl.framebuffer(t)}const{width:t,height:e}=this.canvas;w.width===t&&w.height===e||w.resize(t,e)}else w=null,this._postFBO&&(this._postFBO.destroy(),delete this._postFBO);let T=this._getFBOColor(this._targetFBO);if(this._postProcessor.fxaa(w,T,0,+!(!e.toneMapping||!e.toneMapping.enable),+!(m||!e.sharpen||!e.sharpen.enable),n.getDevicePixelRatio(),i,o&&this._outlineCounts>0&&this._getOutlineFBO(),s,a,l,h),w&&(T=this._getFBOColor(w)),u&&this._bloomPainted){const t=e.bloom,n=+t.threshold||0,i=tI(t,"factor",1),o=tI(t,"radius",1);T=this._postProcessor.bloom(T,null,null,n,i,o,0)}if(c&&(this._postProcessor.genSsrMipmap(T,this._blitDepthTex()),this._needUpdateSSR)){const t=this._needRetireFrames;this.setToRedraw(),this._needRetireFrames=t,this._needUpdateSSR=!1}this._scanEffectPainter&&this.isEnableScanEffect()&&(T=this._renderScanEffect(T)),this._analysisPainter&&(T=this._renderAnalysis(T)),this.isEnableWeather()&&(T=this._renderWeather(T)),m&&this._postProcessor.renderFBOToScreen(T,+!(!e.sharpen||!e.sharpen.enable),i,n.getDevicePixelRatio()),this.layer.fire("postprocessend")}isEnableScanEffect(){const t=this.layer._getSceneConfig(),e=t&&t.postProcess&&t.postProcess.scanEffect;return e&&e.enable&&e.effects.length}}),GroupGLLayer.registerRenderer("canvas",null),function(t){t[t.AMBIENT=0]="AMBIENT",t[t.REALISTIC=1]="REALISTIC"}(BO||(BO={}));class LightManager{constructor(t){this._map=t,this._loader=new dw}getDirectionalLight(){return this._config&&this._config.directional||{}}getAmbientLight(){return this._config&&this._config.ambient||{}}getAmbientResource(){return this._iblMaps}setConfig(t){const e=this._config;this._urlModifier=t.urlModifier,this._config=JSON.parse(JSON.stringify(t));let n=!1;if(t&&t.ambient&&t.ambient.resource){if(!(e&&e.ambient&&function(t,e){if(!t.resource)return!1;if(t.resource.url!==e.resource.url)return!1;return!0}(e.ambient,t.ambient)))return void this._initAmbientResources();this._iblMaps&&(t.ambient.prefilterCubeSize!==e.ambient&&e.ambient.prefilterCubeSize&&this._onHDRLoaded(),n=!0,t.ambient.resource.sh&&(this._iblMaps.sh=t.ambient.resource.sh))}else this._disposeCubeLight(),n=e&&e.ambient&&e.ambient.resource;this._map.fire("updatelights",{ambientUpdate:n})}_tryToGetREGLContext(t){const e=t.getLayers();for(let t=0;t<e.length;t++){const n=e[t]&&e[t].getRenderer();if(n&&n.regl)return n.regl}const n=document.createElement("canvas"),i=Dm({canvas:n,attributes:{depth:!1,stencil:!1,alpha:!1},optionalExtensions:["OES_standard_derivatives","OES_texture_half_float","OES_texture_half_float_linear","OES_texture_float","OES_texture_float_linear"]});return i._temp=!0,i}_initAmbientResources(){const t=this._config.ambient.resource,e=t&&t.url;if(!e)return;const n=[];let i=0,o=0;const s=()=>{o++,o>=i&&this._onSkyboxLoaded(n)},a=function(){throw new Error(`skybox image with url(${this.src}) failed to load, please check the image's url.`)},l=this._urlModifier;if(e.top||e.nx){const{front:t,back:o,right:h,left:c,top:u,bottom:f}=e,{nx:g,ny:A,px:m,py:w,nz:T,pz:M}=e;let C;C=t?[c,h,o,t,u,f]:[g,m,T,M,w,A],i=C.length;for(let t=0;t<i;t++){const e=new Image;e.onload=s,e.onerror=a,e.src=l&&l(C[t])||C[t],n[t]=e}}else{const e={url:t.url,arrayBuffer:!0,hdr:!0,flipY:!0};this._loader.setURLModifier(l),this._hdr=new Iw(e,this._loader),this._hdr.once("complete",(()=>{this._onHDRLoaded()})),this._hdr.once("error",(()=>{this._onHDRError()}))}}dispose(){this._disposeCubeLight()}_onHDRLoaded(){this._hdr&&(this._iblMaps=this._createIBLMaps(this._hdr),this._map.fire("updatelights",{ambientUpdate:!0}))}_onHDRError(){this._map.fire("hdrerror")}_onSkyboxLoaded(t){this._iblMaps=this._createIBLMaps(t),this._map.fire("updatelights",{ambientUpdate:!0})}_createIBLMaps(t){const e=this._config.ambient.resource,n=e.prefilterCubeSize||512,i=this._tryToGetREGLContext(this._map),o=xC.PBRHelper.createIBLMaps(i,{envTexture:Array.isArray(t)?t:t.getREGLTexture(i),ignoreSH:!!e.sh,envCubeSize:n,prefilterCubeSize:n,environmentExposure:this._config.ambient.exposure,format:"array"});if(e.sh&&(o.sh=e.sh,Array.isArray(o.sh[0]))){const t=o.sh,e=[];for(let n=0;n<t.length;n++)e.push(...t[n]);o.sh=e}return i._temp&&(delete this._hdr,i.destroy()),o}_disposeCubeLight(){this._hdr&&(this._hdr.dispose(),delete this._hdr),delete this._iblMaps}}let zO,GO,jO,UO,VO;Lf.include({setLights(t){return this.options.lights=t,this._initLightManager(),this},getLights(){return this.options.lights},_initLightManager(){this._lightManager||(this._lightManager=new LightManager(this)),this._lightManager.setConfig(this.getLights())},getLightManager(){return this._lightManager?this._lightManager:null}}),Lf.addOnLoadHook((function(){this.options.lights&&this._initLightManager()}));const WO={color:[0,0,0,0]},ZO={enable:!1};Lf.include({setPostProcessConfig(t){return this.options.postProcessConfig=t,this},getPostProcessConfig(){return this.options.postProcessConfig}});const qO=vm.MapCanvasRenderer.prototype.drawLayerCanvas;vm.MapCanvasRenderer.prototype.drawLayerCanvas=function(){const t=qO.apply(this,arguments);return t&&function(t,e){const n=t.map.getPostProcessConfig();if(!n||!n.enable)return;zO||(i=e.width,o=e.height,zO=document.createElement("canvas",i,o),GO=Dm({canvas:zO,attributes:{depth:!1,stencil:!1,alpha:!0,antialias:!1,premultipliedAlpha:!1}}),jO=GO.texture({mag:"linear",min:"linear",mipmap:!1,flipY:!0,width:i,height:o}),UO=GO.texture());var i,o;zO.width===e.width&&zO.height===e.height||(zO.width=e.width,zO.height=e.height);GO.clear(WO);const s=n.filmicGrain||ZO;void 0===s.enable&&(s.enable=!0);const a=n.vignette||ZO;void 0===a.enable&&(a.enable=!0);const l=n.colorLUT||ZO;void 0===l.enable&&(l.enable=!0);t._postProcessContext||(t._postProcessContext={});const h=t._postProcessContext;if(l.enable){const e=l.lut;if(!h.lutTexture||h.lutTexture.url!==e){const n=new Image;n.onload=function(){const i={data:n,min:"linear",mag:"linear"},o=h.lutTexture?h.lutTexture.texture(i):GO.texture(i);h.lutTexture={url:e,texture:o},t.setLayerCanvasUpdated()},n.src=e}}const c={enableGrain:+!!s.enable,grainFactor:void 0===s.factor?.15:s.factor,timeGrain:performance.now(),enableVignette:+!!a.enable,lensRadius:a.lensRadius||[.8,.25],frameMod:1,enableLut:+!!l.enable,lookupTable:h.lutTexture?h.lutTexture.texture:UO};VO||(VO=new PostProcess(GO));VO.postprocess(null,c,jO({width:zO.width,height:zO.height,data:e,flipY:!0,mag:"linear",min:"linear",mipmap:!1})),s.enable&&t.setLayerCanvasUpdated();t.context.drawImage(zO,0,0,zO.width,zO.height)}(this,this.canvas),t};const XO=vm.MapCanvasRenderer.prototype.renderFrame;vm.MapCanvasRenderer.prototype.renderFrame=function(){const t=XO.apply(this,arguments),e=this.map.getPostProcessConfig(),n=e&&e.filmicGrain;return!n||void 0!==n.enable&&!0!==n.enable||this.setLayerCanvasUpdated(),t};const JO=[];function QO(t){t.properties.showOnlyTimestamp&&(delete t.properties.showOnlyTimestamp,KO(t))}function YO(t,e){const n=t.geometry.properties;n.oldElementsBeforeHighlight||(n.oldElementsBeforeHighlight=t.geometry.elements),n.elements&&(n.oldElementsArrBeforeHighlight||(n.oldElementsArrBeforeHighlight=n.elements),n.elements=e)}function KO(t){const e=t.geometry.properties.oldElementsBeforeHighlight;e&&t.geometry.elements!==e&&(t.geometry.deleteElements(),t.geometry.setElements(t.geometry.properties.oldElementsBeforeHighlight),t.geometry.properties.oldElementsArrBeforeHighlight&&(t.geometry.properties.elements=t.geometry.properties.oldElementsArrBeforeHighlight,delete t.geometry.properties.oldElementsArrBeforeHighlight),delete t.geometry.properties.hasInvisible,delete t.geometry.properties.oldElementsBeforeHighlight)}function $O(t){if(!t.properties.highlightTimestamp)return;const e=t.defines;delete e.HAS_HIGHLIGHT_COLOR,delete e.HAS_HIGHLIGHT_OPACITY,t.setDefines(e),delete t.properties.highlightTimestamp,KO(t),tE(t)}function tE(t){if(!t)return;const{hlBloomMesh:e}=t.properties;if(e){const n=e.geometry;n.elements&&n.elements.destroy&&n.deleteElements(),e.dispose(),delete t.properties.hlBloomMesh}}var eE=Object.freeze({__proto__:null,clearHighlight:$O,clearShowOnly:QO,deleteHighlightBloomMesh:tE,highlightMesh:function(t,e,n,i,o){const{highlightTimestamp:s}=e.properties;if(!n)return void(s&&$O(e));if(i===s)return;const a=e instanceof lw,l=a?e.instanceCount:e.geometry.getVertexCount();let{aHighlightColor:h,aHighlightOpacity:c}=e.geometry.properties;h&&h.fill(0),c&&c.fill(255);let u=!1,f=!1;const g=n.keys();let A=null,m=null;for(const t of g)if(o.has(t)){const i=n.get(t),{color:s,bloom:a,visible:g,nodeIndex:w}=i;if(!FS(w)&&w!==e.properties.nodeIndex)continue;let T,{opacity:M}=i;if(s&&(u||(h||(h=new Uint8Array(4*l)),u=!0),T=WS(JO,s)),M=FS(M)?1:M,M<1&&(f||(c||(c=new Uint8Array(l),c.fill(255)),f=!0)),!1===g&&(m||(m=new Set),m.add(t)),T||M<1||a){const e=o.get(t);if(e)for(let t=0;t<e.length;t++){const n=e[t];T&&g_(h.subarray(4*n,4*n+4),...T),M<1&&(c[n]=255*M),a&&(A||(A=[]),A.push(n))}}}const w=e.geometry,T=e.defines;if(u?(a?(e.updateInstancedData("aHighlightColor",h),e.generateInstancedBuffers(t)):(w.data.aHighlightColor?w.updateData("aHighlightColor",h):(w.data.aHighlightColor=h,w.generateBuffers(t)),w.properties.aHighlightColor=h),T.HAS_HIGHLIGHT_COLOR=1):T.HAS_HIGHLIGHT_COLOR&&(a?(e.updateInstancedData("aHighlightColor",h),e.generateInstancedBuffers(t)):w.updateData("aHighlightColor",h),delete T.HAS_HIGHLIGHT_COLOR),f?(a?(e.updateInstancedData("aHighlightOpacity",c),e.generateInstancedBuffers(t)):(w.data.aHighlightOpacity?w.updateData("aHighlightOpacity",c):(w.data.aHighlightOpacity=c,w.generateBuffers(t)),w.properties.aHighlightOpacity=c),T.HAS_HIGHLIGHT_OPACITY=1):T.HAS_HIGHLIGHT_OPACITY&&(a?(e.updateInstancedData("aHighlightOpacity",c),e.generateInstancedBuffers(t)):w.updateData("aHighlightOpacity",c),delete T.HAS_HIGHLIGHT_OPACITY),m&&m.size>0){let n=[];o.forEach(((t,e)=>{m.has(e)||jS(n,t)})),w.properties.hasInvisible=!0,YO(e,n);const i={data:n,primitive:w.getPrimitive()};w.elements!==w.properties.oldElementsBeforeHighlight&&w.elements.destroy&&w.deleteElements(),n=t.elements(i),w.setElements(n),w.generateBuffers(t)}else w.properties.hasInvisible&&KO(e);e.setDefines(T),e.properties.highlightTimestamp=i;let M=e.properties.hlBloomMesh;if(A&&A.length){if(M){const t=sy(M.localTransform,e.localTransform),n=sy(M.positionMatrix,e.positionMatrix);M.setLocalTransform(t),M.setPositionMatrix(n),e.properties.hlBloomMesh.geometry.setElements(A)}else{const n=new vb(w.data,A,0,w.desc);n.generateBuffers(t);M=new aw(n,e.material,e.config);const i=e.uniforms;for(const t in i)Object.defineProperty(M.uniforms,t,{enumerable:!0,get:function(){return e.getUniform(t)}});const o=DS({},e.defines);o.HAS_BLOOM=1;const s=sy([],e.localTransform),a=sy([],e.positionMatrix);M.setLocalTransform(s),M.setPositionMatrix(a),DS(M.properties,e.properties),DS(n.properties,w.properties),M.setDefines(o),M.bloom=1}e.properties.hlBloomMesh=M}else M&&tE(e)},showOnly:function(t,e,n,i,o){const{showOnlyTimestamp:s}=e.properties;if(!n)return void(s&&QO(e));if(i===s)return;e.properties.showOnlyTimestamp=i;const a=n.keys(),l=[];for(const t of a){if(!o.has(t))continue;const e=o.get(t);e&&jS(l,e)}YO(e,l),e.geometry.elements!==e.geometry.properties.oldElementsBeforeHighlight&&e.geometry.elements.destroy&&e.geometry.deleteElements();const h={data:l,primitive:e.geometry.getPrimitive()};e.geometry.setElements(t.elements(h)),e.geometry.generateBuffers(t)}});const nE=[0,0,0,0];class HeatmapProcess{constructor(t,e,n,i,o,s){this.renderer=new cw(t),this.sceneConfig=e,this._layer=n,this._colorStops=i,this._stencil=o,this._polygonOffset=s||{factor:0,units:0},this._init(),this._outputSize=[]}render(t,e,n){this._check();const i=this._layer.getMap();this.renderer.regl.clear({color:nE,depth:1,stencil:255,framebuffer:this._heatmapFBO}),this.renderer.render(this._heatmapShader,e,t,this._heatmapFBO);const o=this._layer.getRenderer().canvas;this._outputSize[0]=o.width,this._outputSize[1]=o.height;const s=DS({colorRamp:this._colorRampTex,inputTexture:this._heatmapFBO,projViewMatrix:i.projViewMatrix,textureOutputSize:this._outputSize},e);return this._transformGround(),this.renderer.render(this._displayShader,s,this._groundScene,n)}dispose(){this._heatmapShader&&(this._heatmapShader.dispose(),delete this._heatmapShader),this._displayShader&&(this._displayShader.dispose(),delete this._displayShader),this._ground&&(this._ground.geometry.dispose(),this._ground.dispose(),delete this._ground,delete this._groundScene),this._heatmapFBO&&(this._heatmapFBO.destroy(),delete this._heatmapFBO)}_createColorRamp(){const t=this._colorStops;let e=this._rampCanvas,n=this._rampCtx;n?n.clearRect(0,0,256,1):(e=this._rampCanvas=document.createElement("canvas"),e.width=256,e.height=1,n=this._rampCtx=e.getContext("2d"));const i=n.createLinearGradient(0,0,256,1);for(let e=0;e<t.length;e++)i.addColorStop(t[e][0],t[e][1]);n.fillStyle=i,n.fillRect(0,0,256,1),this._colorRampTex&&this._colorRampTex.destroy();this._colorRampTex=this.renderer.regl.texture({width:256,height:1,data:e,min:"linear",mag:"linear",premultiplyAlpha:!0})}_check(){const t=this._layer.getRenderer().canvas,e=Math.ceil(t.width/4),n=Math.ceil(t.height/4),i=this._heatmapFBO;i.width===e&&i.height===n||i.resize(e,n)}_init(){this._createColorRamp(),this._createShader(),this._createHeatmapTex(),this._createGround()}_createGround(){const t=new Ow;t.generateBuffers(this.renderer.regl),this._ground=new aw(t),this._groundScene=new _w([this._ground])}_transformGround(){const t=this._layer.getMap(),e=GroundPainter.getGroundTransform(this._ground.localTransform,t);this._ground.setLocalTransform(e)}_createHeatmapTex(){const t=this._layer.getRenderer().canvas,e=this.renderer.regl,n=e.hasExtension("OES_texture_half_float")?"half float":"float",i=Math.ceil(t.width/4),o=Math.ceil(t.height/4),s=e.texture({width:i,height:o,type:n,min:"linear",mag:"linear",format:"rgba"});this._heatmapFBO=e.framebuffer({width:i,height:o,color:[s]})}_createShader(){const t=this._layer.getRenderer().canvas,e=this.sceneConfig.depthRange,n={viewport:{x:0,y:0,width:()=>t?Math.ceil(t.width/4):1,height:()=>t?Math.ceil(t.height/4):1},depth:{enable:!0,func:"always"}};this._stencil&&(n.stencil=this._stencil),this._heatmapShader=new nT({extraCommandProps:n}),this._displayShader=new sT({x:0,y:0,width:()=>t?t.width:1,height:()=>t?t.height:1},{extraCommandProps:{stencil:{enable:!1},depth:{enable:!0,range:e||[0,1],func:"<="},polygonOffset:{enable:!0,offset:this._polygonOffset},scissor:{enable:!1}}})}}class ClipMask extends Mask{constructor(t,e){super(t,e)}_createMesh(t){const e=this._createGeometry(t),n=new aw(e);return this._setDefines(n),this._setLocalTransform(n),n}_updateUniforms(t,e,n){const i=this._getMaskMode();t.setUniform("maskMode",i);const o=this._getMaskColor();if(t.setUniform("maskColor",o),NS(e)){const i=this._getHeightRange();i[0]=(i[0]-n)*e,i[1]=(i[1]-n)*e,t.setUniform("heightRange",i)}}setHeightRange(t){this.options.heightRange=t,this._fireEvent("heightrangechange")}getHeightRange(){return this.options.heightRange}_getHeightRange(){const t=[0,0];return this.options.heightRange&&(t[0]=this._altitudeToPoint(this.options.heightRange[0]),t[1]=this._altitudeToPoint(this.options.heightRange[1])),t}_setDefines(t){const e=t.getDefines();e.HAS_MASK_COLOR=1,t.setDefines(e)}}class ClipOutsideMask extends ClipMask{constructor(t,e){super(t,e),this._mode="clip-outside"}}class FlatMask extends Mask{constructor(t,e){super(t,e)}setFlatheight(t){this.options.flatHeight=t,this._fireEvent("flatheightchange")}_createMesh(t){const e=this._createGeometry(t),n=new aw(e);return this._setDefines(n),this._setLocalTransform(n),n}_updateUniforms(t){const e=this._getMaskMode();t.setUniform("maskMode",e);const n=this._getMaskColor();t.setUniform("maskColor",n);const i=this._altitudeToPoint(this.options.flatHeight||0);t.setUniform("flatHeight",i)}_setDefines(t){const e=t.getDefines();e.HAS_MASK_FLAT=1,t.setDefines(e)}_getHeightRange(){const t=[0,this.options.flatHeight];return t[1]=this._altitudeToPoint(t[1]),t}}const iE=new _e(0,0),rE=new _e(0,0),oE=new _e(0,0),sE=new _e(0,0);class BoxClipMask extends ClipMask{constructor(t,e){super([],e),this._position=t}setPosition(t){this._position=t,this._updateCoordinates()}getPosition(){return this._position}setWidth(t){this.options.width=t,this._updateCoordinates()}setLength(t){this.options.length=t,this._updateCoordinates()}setHeight(t){this.options.height=t,this._updateCoordinates()}setRotation(t){this.options.rotation=t,this._updateCoordinates()}_updateCoordinates(){const t=this.getLayer();if(!t)return;const e=t.getMap();if(e){const{length:t,width:n,height:i}=this.options,o=this._position,s=this.options.rotation||0,{coordinates:a,heightRange:l}=this._generateCoordinates(e,o,t,n,i,s);this.setCoordinates(a),this.setHeightRange(l)}}_generateCoordinates(t,e,n,i,o,s){const a=t.getGLRes(),l=t.distanceToPointAtRes(i/2,0,a,iE),h=t.distanceToPointAtRes(0,n/2,a,rE),c=t.coordinateToPointAtRes(e,a,oE),u=c.x-l.x,f=c.x+l.x,g=c.y+h.y,A=c.y-h.y,m=this._rotatePoint([[u,g],[f,g],[f,A],[u,A]],c,s);sE.set(m[0][0],m[0][1]);const w=t.pointAtResToCoordinate(sE,a);sE.set(m[1][0],m[1][1]);const T=t.pointAtResToCoordinate(sE,a);sE.set(m[2][0],m[2][1]);const M=t.pointAtResToCoordinate(sE,a);sE.set(m[3][0],m[3][1]);const C=t.pointAtResToCoordinate(sE,a),P=e.z-o/2;return{coordinates:[[w.x,w.y,P],[T.x,T.y,P],[M.x,M.y,P],[C.x,C.y,P],[w.x,w.y,P]],heightRange:[P,e.z+o/2]}}_rotatePoint(t,e,n){for(let i=0;i<t.length;i++)jv(t[i],t[i],[e.x,e.y],n*Math.PI/180);return t}}class Measure3DTool extends Yd{constructor(t){super(t),this.on("enable",this._afterEnable,this),this.on("disable",this._afterDisable,this),this._drawCoordinates=[]}addTo(t){return t&&(super.addTo(t),this._map=t,this._addHelperLayer()),this}_addHelperLayer(){this._map.getLayer(Fn+"drawtool").hide()}_afterEnable(){this.on("drawstart",this._msOnDrawStart,this).on("drawvertex",this._msOnDrawVertex,this).on("mousemove",this._msOnMouseMove,this).on("drawend",this._msOnDrawEnd,this)}_afterDisable(){this.off("drawstart",this._msOnDrawStart,this).off("drawvertex",this._msOnDrawVertex,this).off("mousemove",this._msOnMouseMove,this).off("drawend",this._msOnDrawEnd,this)}_getPickedCoordinate(t){const{coordinate:e,containerPoint:n}=t,i=this._map.getLayers((t=>t.queryTerrainAtPoint))[0];if(!i)return e.z=e.z||0,e;const o=i.identify(e,{includeInternals:!1})[0];let s=null;if(o&&o.coordinate?s=new gh(o.coordinate):(e.z=e.z||0,s=e),i.getTerrainLayer()){const t=i.queryTerrainAtPoint(n);return t&&t.z>s.z?t:s}return s}_msOnDrawStart(t){const e=this._getPickedCoordinate(t);e&&(this._first=!0,this._drawCoordinates.push(e),this._addHelperGeometry(e))}_msOnDrawVertex(t){const e=this._getPickedCoordinate(t);e&&(this._first=!0,this._drawCoordinates[this._drawCoordinates.length-1]=e,this._drawVertexMarker())}_msOnMouseMove(t){const e=this._getPickedCoordinate(t);e&&(this._first?this._drawCoordinates.push(e):this._drawCoordinates[this._drawCoordinates.length-1]=e,this._drawVertexMarker(),this._first=!1)}_msOnDrawEnd(t){const e=this._getPickedCoordinate(t);e&&(this._drawCoordinates.push(e),this._drawEnd())}_drawEnd(){this._drawVertexMarker(),this._drawCoordinates=[],this._helperGeometry=null,this._label=null}remove(){this._helperLayer&&this._helperLayer.remove(),this._markerLayer&&this._markerLayer.remove()}clear(){this._helperLayer&&this._helperLayer.clear(),this._markerLayer&&this._markerLayer.clear()}}Measure3DTool.mergeOptions({mode:"LineString",language:"zh-CN",metric:!0,imperial:!1,once:!0,symbol:{lineColor:"#e8542b",lineWidth:2,polygonFill:"#eee",polygonOpacity:.5},vertexSymbol:{markerType:"ellipse",markerFill:"#e8542b",markerLineColor:"#fff",markerLineWidth:2,markerWidth:10,markerHeight:10,markerDy:0},labelSymbol:{boxStyle:{padding:[15,6],verticalAlignment:"top",horizontalAlignment:"left",minWidth:150,minHeight:30,symbol:{markerType:"square",markerFill:"rgb(60, 60, 60)",markerFillOpacity:.8,markerLineColor:"#fff",markerLineWidth:2,textDx:-110}},textSymbol:{textFill:"#fff",textSize:16,textVerticalAlignment:"top"}}});const aE=[["","",""],["spatial distance","vertical height","horizontal distance"]];const lE="${",hE=`function(e){\n/*!\n     * @ispace/gltf-loader v0.102.8\n     * LICENSE : UNLICENSED\n     * (c) 2016-2026 ispace.org\n     */\nvar n,t,r="undefined"!=typeof Float32Array?Float32Array:Array;function o(){var e=new r(3);return r!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function i(e,n,t){var o=new r(3);return o[0]=e,o[1]=n,o[2]=t,o}function a(){var e=new r(4);return r!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}Math.hypot||(Math.hypot=function(){for(var e=0,n=arguments.length;n--;)e+=arguments[n]*arguments[n];return Math.sqrt(e)}),o(),n=new r(4),r!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0,n[3]=0),o(),i(1,0,0),i(0,1,0),a(),a(),t=new r(9),r!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[5]=0,t[6]=0,t[7]=0),t[0]=1,t[4]=1,t[8]=1;let s=0;!function(e){e[0]=0,e[1]=0,e[2]=0,e[3]=1}([]),"undefined"!=typeof TextDecoder&&new TextDecoder("utf-8");const c={get:function(e,n={},t){n||(n={});const r=new AbortController,o=r.signal,i=function(e){for(let n=1;n<arguments.length;n++){const t=arguments[n];for(const n in t)e[n]=t[n]}return e}({},n);i.signal=o,i.method||(i.method="GET"),i.referrerPolicy=i.referrerPolicy||"origin","undefined"==typeof window||i.referrer||(i.referrer=window.location.href),t&&(e=t(e));const a=fetch(e,i).then((e=>{const t=this._(e,n.responseType);return t.message?t:t.then((t=>"arraybuffer"===n.responseType?{data:t,cacheControl:e.headers.get("Cache-Control"),expires:e.headers.get("Expires"),contentType:e.headers.get("Content-Type")}:t)).catch((e=>{if(!e.code||e.code!==DOMException.ABORT_ERR)throw e}))})).catch((e=>{if(!e.code||e.code!==DOMException.ABORT_ERR)throw e}));return a.xhr=r,a},_:(e,n)=>200!==e.status?{status:e.status,statusText:e.statusText,message:\`incorrect http request with status code(${lE}e.status}): ${lE}e.statusText}\`}:"arraybuffer"===n?e.arrayBuffer():"json"===n?e.json():e.text(),getArrayBuffer:(e,n={},t)=>(n||(n={}),n.responseType="arraybuffer",c.get(e,n,t)),getJSON:function(e,n={},t){return n&&n.jsonp?c.jsonp(e):((n=n||{}).responseType="json",c.get(e,n,t))},jsonp:function(e){const n="_ispace_jsonp_"+s++;e.match(/\\?/)?e+="&callback="+n:e+="?callback="+n;let t=document.createElement("script");return t.type="text/javascript",t.src=e,new Promise((e=>{window[n]=function(r){document.getElementsByTagName("head")[0].removeChild(t),t=null,delete window[n],e(r)},document.getElementsByTagName("head")[0].appendChild(t)}))}};if("undefined"!=typeof TextDecoder&&new TextDecoder("utf-8"),"undefined"!=typeof OffscreenCanvas){let e;try{e=new OffscreenCanvas(2,2).getContext("2d")}catch(r){}}"undefined"!=typeof document&&document.createElement("canvas"),\n/** @license zlib.js 2012 - imaya [ https://github.com/imaya/zlib.js ] The MIT License */function(){function e(e){throw e}var n=void 0,t=!0,r=this;function o(e,t){var o,i=e.split("."),a=r;!(i[0]in a)&&a.execScript&&a.execScript("var "+i[0]);for(;i.length&&(o=i.shift());)i.length||t===n?a=a[o]?a[o]:a[o]={}:a[o]=t}var i="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array&&"undefined"!=typeof DataView;function a(n,t){this.index="number"==typeof t?t:0,this.i=0,this.buffer=n instanceof(i?Uint8Array:Array)?n:new(i?Uint8Array:Array)(32768),2*this.buffer.length<=this.index&&e(Error("invalid index")),this.buffer.length<=this.index&&this.f()}a.prototype.f=function(){var e,n=this.buffer,t=n.length,r=new(i?Uint8Array:Array)(t<<1);if(i)r.set(n);else for(e=0;e<t;++e)r[e]=n[e];return this.buffer=r},a.prototype.d=function(e,n,t){var r,o=this.buffer,i=this.index,a=this.i,s=o[i];if(t&&1<n&&(e=8<n?(d[255&e]<<24|d[e>>>8&255]<<16|d[e>>>16&255]<<8|d[e>>>24&255])>>32-n:d[e]>>8-n),8>n+a)s=s<<n|e,a+=n;else for(r=0;r<n;++r)s=s<<1|e>>n-r-1&1,8==++a&&(a=0,o[i++]=d[s],s=0,i===o.length&&(o=this.f()));o[i]=s,this.buffer=o,this.i=a,this.index=i},a.prototype.finish=function(){var e,n=this.buffer,t=this.index;return 0<this.i&&(n[t]<<=8-this.i,n[t]=d[n[t]],t++),i?e=n.subarray(0,t):(n.length=t,e=n),e};var s,c=new(i?Uint8Array:Array)(256);for(s=0;256>s;++s){for(var f=h=s,l=7,h=h>>>1;h;h>>>=1)f<<=1,f|=1&h,--l;c[s]=(f<<l&255)>>>0}var d=c;function v(e){this.buffer=new(i?Uint16Array:Array)(2*e),this.length=0}function u(e){var n,t,r,o,a,s,c,f,l,h,d=e.length,v=0,u=Number.POSITIVE_INFINITY;for(f=0;f<d;++f)e[f]>v&&(v=e[f]),e[f]<u&&(u=e[f]);for(n=1<<v,t=new(i?Uint32Array:Array)(n),r=1,o=0,a=2;r<=v;){for(f=0;f<d;++f)if(e[f]===r){for(s=0,c=o,l=0;l<r;++l)s=s<<1|1&c,c>>=1;for(h=r<<16|f,l=s;l<n;l+=a)t[l]=h;++o}++r,o<<=1,a<<=1}return[t,v,u]}function _(e,n){this.h=g,this.w=0,this.input=i&&e instanceof Array?new Uint8Array(e):e,this.b=0,n&&(n.lazy&&(this.w=n.lazy),"number"==typeof n.compressionType&&(this.h=n.compressionType),n.outputBuffer&&(this.a=i&&n.outputBuffer instanceof Array?new Uint8Array(n.outputBuffer):n.outputBuffer),"number"==typeof n.outputIndex&&(this.b=n.outputIndex)),this.a||(this.a=new(i?Uint8Array:Array)(32768))}v.prototype.getParent=function(e){return 2*((e-2)/4|0)},v.prototype.push=function(e,n){var t,r,o,i=this.buffer;for(t=this.length,i[this.length++]=n,i[this.length++]=e;0<t&&(r=this.getParent(t),i[t]>i[r]);)o=i[t],i[t]=i[r],i[r]=o,o=i[t+1],i[t+1]=i[r+1],i[r+1]=o,t=r;return this.length},v.prototype.pop=function(){var e,n,t,r,o,i=this.buffer;for(n=i[0],e=i[1],this.length-=2,i[0]=i[this.length],i[1]=i[this.length+1],o=0;!((r=2*o+2)>=this.length)&&(r+2<this.length&&i[r+2]>i[r]&&(r+=2),i[r]>i[o]);)t=i[o],i[o]=i[r],i[r]=t,t=i[o+1],i[o+1]=i[r+1],i[r+1]=t,o=r;return{index:e,value:n,length:this.length}};var m,g=2,x={NONE:0,r:1,k:g,N:3},p=[];for(m=0;288>m;m++)switch(t){case 143>=m:p.push([m+48,8]);break;case 255>=m:p.push([m-144+400,9]);break;case 279>=m:p.push([m-256+0,7]);break;case 287>=m:p.push([m-280+192,8]);break;default:e("invalid literal: "+m)}function A(e,n){this.length=e,this.G=n}_.prototype.j=function(){var r,o,s,c,f=this.input;switch(this.h){case 0:for(s=0,c=f.length;s<c;){var l,h,d,v=o=i?f.subarray(s,s+65535):f.slice(s,s+65535),u=(s+=o.length)===c,_=n,m=n,x=this.a,A=this.b;if(i){for(x=new Uint8Array(this.a.buffer);x.length<=A+v.length+5;)x=new Uint8Array(x.length<<1);x.set(this.a)}if(l=u?1:0,x[A++]=0|l,d=65536+~(h=v.length)&65535,x[A++]=255&h,x[A++]=h>>>8&255,x[A++]=255&d,x[A++]=d>>>8&255,i)x.set(v,A),A+=v.length,x=x.subarray(0,A);else{for(_=0,m=v.length;_<m;++_)x[A++]=v[_];x.length=A}this.b=A,this.a=x}break;case 1:var y=new a(i?new Uint8Array(this.a.buffer):this.a,this.b);y.d(1,1,t),y.d(1,2,t);var b,E,O,S=w(this,f);for(b=0,E=S.length;b<E;b++)if(O=S[b],a.prototype.d.apply(y,p[O]),256<O)y.d(S[++b],S[++b],t),y.d(S[++b],5),y.d(S[++b],S[++b],t);else if(256===O)break;this.a=y.finish(),this.b=this.a.length;break;case g:var C,M,H,k,N,P,D,R,U,L,F,z,W,G,V,j=new a(i?new Uint8Array(this.a.buffer):this.a,this.b),X=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],K=Array(19);for(C=g,j.d(1,1,t),j.d(C,2,t),M=w(this,f),D=T(P=I(this.L,15)),U=T(R=I(this.K,7)),H=286;257<H&&0===P[H-1];H--);for(k=30;1<k&&0===R[k-1];k--);var B,q,Z,Y,J,$,Q=H,ee=k,ne=new(i?Uint32Array:Array)(Q+ee),te=new(i?Uint32Array:Array)(316),re=new(i?Uint8Array:Array)(19);for(B=q=0;B<Q;B++)ne[q++]=P[B];for(B=0;B<ee;B++)ne[q++]=R[B];if(!i)for(B=0,Y=re.length;B<Y;++B)re[B]=0;for(B=J=0,Y=ne.length;B<Y;B+=q){for(q=1;B+q<Y&&ne[B+q]===ne[B];++q);if(Z=q,0===ne[B])if(3>Z)for(;0<Z--;)te[J++]=0,re[0]++;else for(;0<Z;)($=138>Z?Z:138)>Z-3&&$<Z&&($=Z-3),10>=$?(te[J++]=17,te[J++]=$-3,re[17]++):(te[J++]=18,te[J++]=$-11,re[18]++),Z-=$;else if(te[J++]=ne[B],re[ne[B]]++,3>--Z)for(;0<Z--;)te[J++]=ne[B],re[ne[B]]++;else for(;0<Z;)($=6>Z?Z:6)>Z-3&&$<Z&&($=Z-3),te[J++]=16,te[J++]=$-3,re[16]++,Z-=$}for(r=i?te.subarray(0,J):te.slice(0,J),L=I(re,7),G=0;19>G;G++)K[G]=L[X[G]];for(N=19;4<N&&0===K[N-1];N--);for(F=T(L),j.d(H-257,5,t),j.d(k-1,5,t),j.d(N-4,4,t),G=0;G<N;G++)j.d(K[G],3,t);for(G=0,V=r.length;G<V;G++)if(z=r[G],j.d(F[z],L[z],t),16<=z){switch(G++,z){case 16:W=2;break;case 17:W=3;break;case 18:W=7;break;default:e("invalid code: "+z)}j.d(r[G],W,t)}var oe,ie,ae,se,ce,fe,le,he,de=[D,P],ve=[U,R];for(ce=de[0],fe=de[1],le=ve[0],he=ve[1],oe=0,ie=M.length;oe<ie;++oe)if(ae=M[oe],j.d(ce[ae],fe[ae],t),256<ae)j.d(M[++oe],M[++oe],t),se=M[++oe],j.d(le[se],he[se],t),j.d(M[++oe],M[++oe],t);else if(256===ae)break;this.a=j.finish(),this.b=this.a.length;break;default:e("invalid compression type")}return this.a};var y=function(){function n(n){switch(t){case 3===n:return[257,n-3,0];case 4===n:return[258,n-4,0];case 5===n:return[259,n-5,0];case 6===n:return[260,n-6,0];case 7===n:return[261,n-7,0];case 8===n:return[262,n-8,0];case 9===n:return[263,n-9,0];case 10===n:return[264,n-10,0];case 12>=n:return[265,n-11,1];case 14>=n:return[266,n-13,1];case 16>=n:return[267,n-15,1];case 18>=n:return[268,n-17,1];case 22>=n:return[269,n-19,2];case 26>=n:return[270,n-23,2];case 30>=n:return[271,n-27,2];case 34>=n:return[272,n-31,2];case 42>=n:return[273,n-35,3];case 50>=n:return[274,n-43,3];case 58>=n:return[275,n-51,3];case 66>=n:return[276,n-59,3];case 82>=n:return[277,n-67,4];case 98>=n:return[278,n-83,4];case 114>=n:return[279,n-99,4];case 130>=n:return[280,n-115,4];case 162>=n:return[281,n-131,5];case 194>=n:return[282,n-163,5];case 226>=n:return[283,n-195,5];case 257>=n:return[284,n-227,5];case 258===n:return[285,n-258,0];default:e("invalid length: "+n)}}var r,o,i=[];for(r=3;258>=r;r++)o=n(r),i[r]=o[2]<<24|o[1]<<16|o[0];return i}(),b=i?new Uint32Array(y):y;function w(r,o){function a(n,r){var o,i,a,s,c=n.G,f=[],l=0;switch(o=b[n.length],f[l++]=65535&o,f[l++]=o>>16&255,f[l++]=o>>24,t){case 1===c:i=[0,c-1,0];break;case 2===c:i=[1,c-2,0];break;case 3===c:i=[2,c-3,0];break;case 4===c:i=[3,c-4,0];break;case 6>=c:i=[4,c-5,1];break;case 8>=c:i=[5,c-7,1];break;case 12>=c:i=[6,c-9,2];break;case 16>=c:i=[7,c-13,2];break;case 24>=c:i=[8,c-17,3];break;case 32>=c:i=[9,c-25,3];break;case 48>=c:i=[10,c-33,4];break;case 64>=c:i=[11,c-49,4];break;case 96>=c:i=[12,c-65,5];break;case 128>=c:i=[13,c-97,5];break;case 192>=c:i=[14,c-129,6];break;case 256>=c:i=[15,c-193,6];break;case 384>=c:i=[16,c-257,7];break;case 512>=c:i=[17,c-385,7];break;case 768>=c:i=[18,c-513,8];break;case 1024>=c:i=[19,c-769,8];break;case 1536>=c:i=[20,c-1025,9];break;case 2048>=c:i=[21,c-1537,9];break;case 3072>=c:i=[22,c-2049,10];break;case 4096>=c:i=[23,c-3073,10];break;case 6144>=c:i=[24,c-4097,11];break;case 8192>=c:i=[25,c-6145,11];break;case 12288>=c:i=[26,c-8193,12];break;case 16384>=c:i=[27,c-12289,12];break;case 24576>=c:i=[28,c-16385,13];break;case 32768>=c:i=[29,c-24577,13];break;default:e("invalid distance")}for(o=i,f[l++]=o[0],f[l++]=o[1],f[l++]=o[2],a=0,s=f.length;a<s;++a)g[x++]=f[a];A[f[0]]++,y[f[3]]++,p=n.length+r-1,u=null}var s,c,f,l,h,d,v,u,_,m={},g=i?new Uint16Array(2*o.length):[],x=0,p=0,A=new(i?Uint32Array:Array)(286),y=new(i?Uint32Array:Array)(30),w=r.w;if(!i){for(f=0;285>=f;)A[f++]=0;for(f=0;29>=f;)y[f++]=0}for(A[256]=1,s=0,c=o.length;s<c;++s){for(f=h=0,l=3;f<l&&s+f!==c;++f)h=h<<8|o[s+f];if(m[h]===n&&(m[h]=[]),d=m[h],!(0<p--)){for(;0<d.length&&32768<s-d[0];)d.shift();if(s+3>=c){for(u&&a(u,-1),f=0,l=c-s;f<l;++f)_=o[s+f],g[x++]=_,++A[_];break}0<d.length?(v=E(o,s,d),u?u.length<v.length?(_=o[s-1],g[x++]=_,++A[_],a(v,0)):a(u,-1):v.length<w?u=v:a(v,0)):u?a(u,-1):(_=o[s],g[x++]=_,++A[_])}d.push(s)}return g[x++]=256,A[256]++,r.L=A,r.K=y,i?g.subarray(0,x):g}function E(e,n,t){var r,o,i,a,s,c,f=0,l=e.length;a=0,c=t.length;e:for(;a<c;a++){if(r=t[c-a-1],i=3,3<f){for(s=f;3<s;s--)if(e[r+s-1]!==e[n+s-1])continue e;i=f}for(;258>i&&n+i<l&&e[r+i]===e[n+i];)++i;if(i>f&&(o=r,f=i),258===i)break}return new A(f,n-o)}function I(e,n){var t,r,o,a,s,c=e.length,f=new v(572),l=new(i?Uint8Array:Array)(c);if(!i)for(a=0;a<c;a++)l[a]=0;for(a=0;a<c;++a)0<e[a]&&f.push(a,e[a]);if(t=Array(f.length/2),r=new(i?Uint32Array:Array)(f.length/2),1===t.length)return l[f.pop().index]=1,l;for(a=0,s=f.length/2;a<s;++a)t[a]=f.pop(),r[a]=t[a].value;for(o=function(e,n,t){function r(e){var t=u[e][_[e]];t===n?(r(e+1),r(e+1)):--d[t],++_[e]}var o,a,s,c,f,l=new(i?Uint16Array:Array)(t),h=new(i?Uint8Array:Array)(t),d=new(i?Uint8Array:Array)(n),v=Array(t),u=Array(t),_=Array(t),m=(1<<t)-n,g=1<<t-1;for(l[t-1]=n,a=0;a<t;++a)m<g?h[a]=0:(h[a]=1,m-=g),m<<=1,l[t-2-a]=(l[t-1-a]/2|0)+n;for(l[0]=h[0],v[0]=Array(l[0]),u[0]=Array(l[0]),a=1;a<t;++a)l[a]>2*l[a-1]+h[a]&&(l[a]=2*l[a-1]+h[a]),v[a]=Array(l[a]),u[a]=Array(l[a]);for(o=0;o<n;++o)d[o]=t;for(s=0;s<l[t-1];++s)v[t-1][s]=e[s],u[t-1][s]=s;for(o=0;o<t;++o)_[o]=0;for(1===h[t-1]&&(--d[0],++_[t-1]),a=t-2;0<=a;--a){for(c=o=0,f=_[a+1],s=0;s<l[a];s++)(c=v[a+1][f]+v[a+1][f+1])>e[o]?(v[a][s]=c,u[a][s]=n,f+=2):(v[a][s]=e[o],u[a][s]=o,++o);_[a]=0,1===h[a]&&r(a)}return d}(r,r.length,n),a=0,s=t.length;a<s;++a)l[t[a].index]=o[a];return l}function T(e){var n,t,r,o,a=new(i?Uint16Array:Array)(e.length),s=[],c=[],f=0;for(n=0,t=e.length;n<t;n++)s[e[n]]=1+(0|s[e[n]]);for(n=1,t=16;n<=t;n++)c[n]=f,f+=0|s[n],f<<=1;for(n=0,t=e.length;n<t;n++)for(f=c[e[n]],c[e[n]]+=1,r=a[n]=0,o=e[n];r<o;r++)a[n]=a[n]<<1|1&f,f>>>=1;return a}function O(n,t){switch(this.l=[],this.m=32768,this.e=this.g=this.c=this.q=0,this.input=i?new Uint8Array(n):n,this.s=!1,this.n=C,this.B=!1,!t&&(t={})||(t.index&&(this.c=t.index),t.bufferSize&&(this.m=t.bufferSize),t.bufferType&&(this.n=t.bufferType),t.resize&&(this.B=t.resize)),this.n){case S:this.b=32768,this.a=new(i?Uint8Array:Array)(32768+this.m+258);break;case C:this.b=0,this.a=new(i?Uint8Array:Array)(this.m),this.f=this.J,this.t=this.H,this.o=this.I;break;default:e(Error("invalid inflate mode"))}}var S=0,C=1,M={D:S,C:C};O.prototype.p=function(){for(;!this.s;){var r=Z(this,3);switch(1&r&&(this.s=t),r>>>=1){case 0:var o=this.input,a=this.c,s=this.a,c=this.b,f=o.length,l=n,h=s.length,d=n;switch(this.e=this.g=0,a+1>=f&&e(Error("invalid uncompressed block header: LEN")),l=o[a++]|o[a++]<<8,a+1>=f&&e(Error("invalid uncompressed block header: NLEN")),l===~(o[a++]|o[a++]<<8)&&e(Error("invalid uncompressed block header: length verify")),a+l>o.length&&e(Error("input buffer is broken")),this.n){case S:for(;c+l>s.length;){if(l-=d=h-c,i)s.set(o.subarray(a,a+d),c),c+=d,a+=d;else for(;d--;)s[c++]=o[a++];this.b=c,s=this.f(),c=this.b}break;case C:for(;c+l>s.length;)s=this.f({v:2});break;default:e(Error("invalid inflate mode"))}if(i)s.set(o.subarray(a,a+l),c),c+=l,a+=l;else for(;l--;)s[c++]=o[a++];this.c=a,this.b=c,this.a=s;break;case 1:this.o(K,q);break;case 2:var v,_,m,g,x=Z(this,5)+257,p=Z(this,5)+1,A=Z(this,4)+4,y=new(i?Uint8Array:Array)(P.length),b=n,w=n,E=n,I=n,T=n;for(T=0;T<A;++T)y[P[T]]=Z(this,3);if(!i)for(T=A,A=y.length;T<A;++T)y[P[T]]=0;for(v=u(y),b=new(i?Uint8Array:Array)(x+p),T=0,g=x+p;T<g;)switch(w=Y(this,v),w){case 16:for(I=3+Z(this,2);I--;)b[T++]=E;break;case 17:for(I=3+Z(this,3);I--;)b[T++]=0;E=0;break;case 18:for(I=11+Z(this,7);I--;)b[T++]=0;E=0;break;default:E=b[T++]=w}_=u(i?b.subarray(0,x):b.slice(0,x)),m=u(i?b.subarray(x):b.slice(x)),this.o(_,m);break;default:e(Error("unknown BTYPE: "+r))}}return this.t()};var H,k,N=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],P=i?new Uint16Array(N):N,D=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,258,258],R=i?new Uint16Array(D):D,U=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0],L=i?new Uint8Array(U):U,F=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],z=i?new Uint16Array(F):F,W=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],G=i?new Uint8Array(W):W,V=new(i?Uint8Array:Array)(288);for(H=0,k=V.length;H<k;++H)V[H]=143>=H?8:255>=H?9:279>=H?7:8;var j,X,K=u(V),B=new(i?Uint8Array:Array)(30);for(j=0,X=B.length;j<X;++j)B[j]=5;var q=u(B);function Z(n,t){for(var r,o=n.g,i=n.e,a=n.input,s=n.c,c=a.length;i<t;)s>=c&&e(Error("input buffer is broken")),o|=a[s++]<<i,i+=8;return r=o&(1<<t)-1,n.g=o>>>t,n.e=i-t,n.c=s,r}function Y(n,t){for(var r,o,i=n.g,a=n.e,s=n.input,c=n.c,f=s.length,l=t[0],h=t[1];a<h&&!(c>=f);)i|=s[c++]<<a,a+=8;return(o=(r=l[i&(1<<h)-1])>>>16)>a&&e(Error("invalid code length: "+o)),n.g=i>>o,n.e=a-o,n.c=c,65535&r}function J(e){if("string"==typeof e){var n,t,r=e.split("");for(n=0,t=r.length;n<t;n++)r[n]=(255&r[n].charCodeAt(0))>>>0;e=r}for(var o,i=1,a=0,s=e.length,c=0;0<s;){s-=o=1024<s?1024:s;do{a+=i+=e[c++]}while(--o);i%=65521,a%=65521}return(a<<16|i)>>>0}function $(n,t){var r,o;if(this.input=n,this.c=0,!t&&(t={})||(t.index&&(this.c=t.index),t.verify&&(this.M=t.verify)),r=n[this.c++],o=n[this.c++],(15&r)===Q)this.method=Q;else e(Error("unsupported compression method"));0!=((r<<8)+o)%31&&e(Error("invalid fcheck flag:"+((r<<8)+o)%31)),32&o&&e(Error("fdict flag is not supported")),this.A=new O(n,{index:this.c,bufferSize:t.bufferSize,bufferType:t.bufferType,resize:t.resize})}O.prototype.o=function(e,n){var t=this.a,r=this.b;this.u=e;for(var o,i,a,s,c=t.length-258;256!==(o=Y(this,e));)if(256>o)r>=c&&(this.b=r,t=this.f(),r=this.b),t[r++]=o;else for(s=R[i=o-257],0<L[i]&&(s+=Z(this,L[i])),o=Y(this,n),a=z[o],0<G[o]&&(a+=Z(this,G[o])),r>=c&&(this.b=r,t=this.f(),r=this.b);s--;)t[r]=t[r++-a];for(;8<=this.e;)this.e-=8,this.c--;this.b=r},O.prototype.I=function(e,n){var t=this.a,r=this.b;this.u=e;for(var o,i,a,s,c=t.length;256!==(o=Y(this,e));)if(256>o)r>=c&&(c=(t=this.f()).length),t[r++]=o;else for(s=R[i=o-257],0<L[i]&&(s+=Z(this,L[i])),o=Y(this,n),a=z[o],0<G[o]&&(a+=Z(this,G[o])),r+s>c&&(c=(t=this.f()).length);s--;)t[r]=t[r++-a];for(;8<=this.e;)this.e-=8,this.c--;this.b=r},O.prototype.f=function(){var e,n,t=new(i?Uint8Array:Array)(this.b-32768),r=this.b-32768,o=this.a;if(i)t.set(o.subarray(32768,t.length));else for(e=0,n=t.length;e<n;++e)t[e]=o[e+32768];if(this.l.push(t),this.q+=t.length,i)o.set(o.subarray(r,r+32768));else for(e=0;32768>e;++e)o[e]=o[r+e];return this.b=32768,o},O.prototype.J=function(e){var n,t,r,o=this.input.length/this.c+1|0,a=this.input,s=this.a;return e&&("number"==typeof e.v&&(o=e.v),"number"==typeof e.F&&(o+=e.F)),2>o?t=(r=(a.length-this.c)/this.u[2]/2*258|0)<s.length?s.length+r:s.length<<1:t=s.length*o,i?(n=new Uint8Array(t)).set(s):n=s,this.a=n},O.prototype.t=function(){var e,n,t,r,o,a=0,s=this.a,c=this.l,f=new(i?Uint8Array:Array)(this.q+(this.b-32768));if(0===c.length)return i?this.a.subarray(32768,this.b):this.a.slice(32768,this.b);for(n=0,t=c.length;n<t;++n)for(r=0,o=(e=c[n]).length;r<o;++r)f[a++]=e[r];for(n=32768,t=this.b;n<t;++n)f[a++]=s[n];return this.l=[],this.buffer=f},O.prototype.H=function(){var e,n=this.b;return i?this.B?(e=new Uint8Array(n)).set(this.a.subarray(0,n)):e=this.a.subarray(0,n):(this.a.length>n&&(this.a.length=n),e=this.a),this.buffer=e},$.prototype.p=function(){var n,t=this.input;return n=this.A.p(),this.c=this.A.c,this.M&&((t[this.c++]<<24|t[this.c++]<<16|t[this.c++]<<8|t[this.c++])>>>0!==J(n)&&e(Error("invalid adler-32 checksum"))),n};var Q=8;function ee(e,n){this.input=e,this.a=new(i?Uint8Array:Array)(32768),this.h=ne.k;var t,r={};for(t in!n&&(n={})||"number"!=typeof n.compressionType||(this.h=n.compressionType),n)r[t]=n[t];r.outputBuffer=this.a,this.z=new _(this.input,r)}var ne=x;function te(e,n){var t,r,i,a;if(Object.keys)t=Object.keys(n);else for(r in t=[],i=0,n)t[i++]=r;for(i=0,a=t.length;i<a;++i)o(e+"."+(r=t[i]),n[r])}ee.prototype.j=function(){var n,t,r,o,a,s,c,f=0;if(c=this.a,(n=Q)===Q)t=Math.LOG2E*Math.log(32768)-8;else e(Error("invalid compression method"));if(r=t<<4|n,c[f++]=r,n===Q)switch(this.h){case ne.NONE:a=0;break;case ne.r:a=1;break;case ne.k:a=2;break;default:e(Error("unsupported compression type"))}else e(Error("invalid compression method"));return o=a<<6,c[f++]=o|31-(256*r+o)%31,s=J(this.input),this.z.b=f,f=(c=this.z.j()).length,i&&((c=new Uint8Array(c.buffer)).length<=f+4&&(this.a=new Uint8Array(c.length+4),this.a.set(c),c=this.a),c=c.subarray(0,f+4)),c[f++]=s>>24&255,c[f++]=s>>16&255,c[f++]=s>>8&255,c[f++]=255&s,c},o("Zlib.Inflate",$),o("Zlib.Inflate.prototype.decompress",$.prototype.p),te("Zlib.Inflate.BufferType",{ADAPTIVE:M.C,BLOCK:M.D}),o("Zlib.Deflate",ee),o("Zlib.Deflate.compress",(function(e,n){return new ee(e,n).j()})),o("Zlib.Deflate.prototype.compress",ee.prototype.j),te("Zlib.Deflate.CompressionType",{NONE:ne.NONE,FIXED:ne.r,DYNAMIC:ne.k})}.call(self);var f="undefined"!=typeof Float32Array?Float32Array:Array;function l(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}Math.hypot||(Math.hypot=function(){for(var e=0,n=arguments.length;n--;)e+=arguments[n]*arguments[n];return Math.sqrt(e)});function h(){var e=new f(3);return f!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function d(e,n,t){var r=new f(3);return r[0]=e,r[1]=n,r[2]=t,r}function v(e,n){var t=n[0],r=n[1],o=n[2],i=t*t+r*r+o*o;return i>0&&(i=1/Math.sqrt(i)),e[0]=n[0]*i,e[1]=n[1]*i,e[2]=n[2]*i,e}function u(e,n,t){var r=n[0],o=n[1],i=n[2],a=t[0],s=t[1],c=t[2];return e[0]=o*c-i*s,e[1]=i*a-r*c,e[2]=r*s-o*a,e}var _=function(e,n,t){return e[0]=n[0]-t[0],e[1]=n[1]-t[1],e[2]=n[2]-t[2],e};function m(){var e=new f(4);return f!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}h(),function(){var e,n=(e=new f(4),f!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e)}();var g;function x(e,n,t){return e[0]=n,e[1]=t,e}h(),d(1,0,0),d(0,1,0),m(),m(),g=new f(9),f!=Float32Array&&(g[1]=0,g[2]=0,g[3]=0,g[5]=0,g[6]=0,g[7]=0),g[0]=1,g[4]=1,g[8]=1,function(){var e=function(){var e=new f(2);return f!=Float32Array&&(e[0]=0,e[1]=0),e}()}(),\n/*!\n     * @ispace/reshader.gl v0.107.4\n     * LICENSE : UNLICENSED\n     * (c) 2016-2026 ispace.com\n     */\nl([]),l([]),new Array(16),function(){const e=new ArrayBuffer(4),n=new Float32Array(e),t=new Uint32Array(e),r=new Uint32Array(512),o=new Uint32Array(512);for(let e=0;e<256;++e){const n=e-127;n<-27?(r[e]=0,r[256|e]=32768,o[e]=24,o[256|e]=24):n<-14?(r[e]=1024>>-n-14,r[256|e]=1024>>-n-14|32768,o[e]=-n-1,o[256|e]=-n-1):n<=15?(r[e]=n+15<<10,r[256|e]=n+15<<10|32768,o[e]=13,o[256|e]=13):n<128?(r[e]=31744,r[256|e]=64512,o[e]=24,o[256|e]=24):(r[e]=31744,r[256|e]=64512,o[e]=13,o[256|e]=13)}const i=new Uint32Array(2048),a=new Uint32Array(64),s=new Uint32Array(64);for(let e=1;e<1024;++e){let n=e<<13,t=0;for(;!(8388608&n);)n<<=1,t-=8388608;n&=-8388609,t+=947912704,i[e]=n|t}for(let e=1024;e<2048;++e)i[e]=939524096+(e-1024<<13);for(let e=1;e<31;++e)a[e]=e<<23;a[31]=1199570944,a[32]=2147483648;for(let e=33;e<63;++e)a[e]=2147483648+(e-32<<23);a[63]=3347054592;for(let e=1;e<64;++e)32!==e&&(s[e]=1024)}();const p={vsm_shadow_vert:"\\nuniform mat4 shadow_lightProjViewModelMatrix;\\nvarying vec4 shadow_vLightSpacePos;\\nvoid shadow_computeShadowPars(vec4 position) {\\n    shadow_vLightSpacePos = shadow_lightProjViewModelMatrix * position;\\n}",vsm_shadow_frag:"\\nuniform sampler2D shadow_shadowMap;\\nuniform float shadow_opacity;\\nuniform vec3 shadow_color;\\n#if defined(USE_ESM)\\n    uniform float esm_shadow_threshold;\\n#endif\\nvarying vec4 shadow_vLightSpacePos;\\n#ifdef PACK_FLOAT\\n    #include <common_pack_float>\\n#endif\\n#if defined(USE_ESM)\\nfloat esm(vec3 projCoords, vec4 shadowTexel) {\\n    float compare = projCoords.z;\\n    float c = 120.0;\\n    #ifdef PACK_FLOAT\\n        float depth = common_decodeDepth(shadowTexel);\\n        if (depth >= 1.0 - 1E-6 || compare <= depth) {\\n            return 1.0;\\n        }\\n    #else\\n        float depth = shadowTexel.r;\\n    #endif\\n    depth = exp(-c * min(compare - depth, 0.05));\\n    return clamp(depth, esm_shadow_threshold, 1.0);\\n}\\n#endif\\n#if defined(USE_VSM)\\nfloat vsm_shadow_chebyshevUpperBound(vec3 projCoords, vec4 shadowTexel){\\n    vec2 moments = shadowTexel.rg;\\n    float distance = projCoords.z;\\n    if (distance >= 1.0 || distance <= moments.x)\\n        return 1.0 ;\\n    float variance = moments.y - (moments.x * moments.x);\\n    variance = max(variance, 0.00002);\\n    float d = distance - moments.x;\\n    float p_max = variance / (variance + d * d);\\n    return p_max;\\n}\\n#endif\\nfloat shadow_computeShadow_coeff(sampler2D shadowMap, vec3 projCoords) {\\n    vec2 uv = projCoords.xy;\\n    vec4 shadowTexel = texture2D(shadowMap, uv);\\n    #if defined(USE_ESM)\\n        float esm_coeff = esm(projCoords, shadowTexel);\\n        float coeff = esm_coeff * esm_coeff;\\n    #endif\\n    #if defined(USE_VSM)\\n        float vsm_coeff = vsm_shadow_chebyshevUpperBound(projCoords, shadowTexel);\\n        float coeff = vsm_coeff;\\n    #endif\\n    return 1.0 - (1.0 - coeff) * shadow_opacity;\\n}\\nfloat shadow_computeShadow() {\\n    vec3 projCoords = shadow_vLightSpacePos.xyz / shadow_vLightSpacePos.w;\\n    projCoords = projCoords * 0.5 + 0.5;\\n    if(projCoords.z >= 1.0 || projCoords.x < 0.0 || projCoords.x > 1.0 || projCoords.y < 0.0 || projCoords.y > 1.0) return 1.0;\\n    return shadow_computeShadow_coeff(shadow_shadowMap, projCoords);\\n}\\nvec3 shadow_blend(vec3 color, float coeff) {\\n    color = color * coeff + shadow_color * shadow_opacity * (1.0 - coeff);\\n    return color;\\n}",fbo_picking_vert:"\\n#ifdef ENABLE_PICKING\\n#if HAS_PICKING_ID == 1\\nattribute float aPickingId;\\n#elif HAS_PICKING_ID == 2\\nuniform float uPickingId;\\n#endif\\nvarying float vPickingId;\\nvarying float vFbo_picking_viewZ;\\nvarying float vFbo_picking_visible;\\n#endif\\nvarying float vFbo_picking_fragDepth;\\nvoid fbo_picking_setData(float viewPosZ, bool visible) {\\n    #ifdef ENABLE_PICKING\\n    #if HAS_PICKING_ID == 1\\n       vPickingId = aPickingId;\\n    #elif HAS_PICKING_ID == 2\\n        vPickingId = uPickingId;\\n    #endif\\n        vFbo_picking_viewZ = viewPosZ;\\n    #endif\\n    vFbo_picking_visible = visible ? 1.0 : 0.0;\\n    vFbo_picking_fragDepth = viewPosZ + 1.0;\\n}",common_pack_float:"const float COMMON_FLOAT_MAX =  1.70141184e38;\\nconst float COMMON_FLOAT_MIN = 1.17549435e-38;\\nfloat common_packFloat(vec4 val){\\n    vec4 scl = floor(255.0 * val + 0.5);\\n    float sgn = (scl.a < 128.0) ? 1.0 : -1.0;\\n    float exn = mod(scl.a * 2.0, 256.0) + floor(scl.b / 128.0) - 127.0;\\n    float man = 1.0 +\\n        (scl.r / 8388608.0) +\\n        (scl.g / 32768.0) +\\n        mod(scl.b, 128.0) / 128.0;\\n    return sgn * man * pow(2.0, exn);\\n}\\nvec4 common_unpackFloat(highp float v) {\\n    highp float av = abs(v);\\n    if(av < COMMON_FLOAT_MIN) {\\n        return vec4(0.0, 0.0, 0.0, 0.0);\\n    } else if(v > COMMON_FLOAT_MAX) {\\n        return vec4(127.0, 128.0, 0.0, 0.0) / 255.0;\\n    } else if(v < -COMMON_FLOAT_MAX) {\\n        return vec4(255.0, 128.0, 0.0, 0.0) / 255.0;\\n    }\\n    highp vec4 c = vec4(0,0,0,0);\\n    highp float e = floor(log2(av));\\n    highp float m = av * pow(2.0, -e) - 1.0;\\n    c[1] = floor(128.0 * m);\\n    m -= c[1] / 128.0;\\n    c[2] = floor(32768.0 * m);\\n    m -= c[2] / 32768.0;\\n    c[3] = floor(8388608.0 * m);\\n    highp float ebias = e + 127.0;\\n    c[0] = floor(ebias / 2.0);\\n    ebias -= c[0] * 2.0;\\n    c[1] += floor(ebias) * 128.0;\\n    c[0] += 128.0 * step(0.0, -v);\\n    return c / 255.0;\\n}\\nvec4 common_encodeDepth(const in float depth) {\\n    float alpha = 1.0;\\n    vec4 pack = vec4(0.0);\\n    pack.a = alpha;\\n    const vec3 code = vec3(1.0, 255.0, 65025.0);\\n    pack.rgb = vec3(code * depth);\\n    pack.gb = fract(pack.gb);\\n    pack.rg -= pack.gb * (1.0 / 256.0);\\n    pack.b -= mod(pack.b, 4.0 / 255.0);\\n    return pack;\\n}\\nfloat common_decodeDepth(const in vec4 pack) {\\n    return pack.r + pack.g / 255.0;\\n}",invert_matrix:"mat4 invert_matrix(mat4 matrix) {\\n    #if __VERSION__ == 300\\n        return inverse(matrix);\\n    #else\\n        vec4 vector1 = matrix[0], vector2 = matrix[1], vector3 = matrix[2], vector4 = matrix[3];\\n        float a00 = vector1.x, a01 = vector1.y, a02 = vector1.z, a03 = vector1.w;\\n        float a10 = vector2.x, a11 = vector2.y, a12 = vector2.z, a13 = vector2.w;\\n        float a20 = vector3.x, a21 = vector3.y, a22 = vector3.z, a23 = vector3.w;\\n        float a30 = vector4.x, a31 = vector4.y, a32 = vector4.z, a33 = vector4.w;\\n        float b00 = a00 * a11 - a01 * a10;\\n        float b01 = a00 * a12 - a02 * a10;\\n        float b02 = a00 * a13 - a03 * a10;\\n        float b03 = a01 * a12 - a02 * a11;\\n        float b04 = a01 * a13 - a03 * a11;\\n        float b05 = a02 * a13 - a03 * a12;\\n        float b06 = a20 * a31 - a21 * a30;\\n        float b07 = a20 * a32 - a22 * a30;\\n        float b08 = a20 * a33 - a23 * a30;\\n        float b09 = a21 * a32 - a22 * a31;\\n        float b10 = a21 * a33 - a23 * a31;\\n        float b11 = a22 * a33 - a23 * a32;\\n        float det = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06;\\n        det = 1.0 / det;\\n        mat4 m = mat4(\\n            (a11 * b11 - a12 * b10 + a13 * b09) * det,\\n            (a02 * b10 - a01 * b11 - a03 * b09) * det,\\n            (a31 * b05 - a32 * b04 + a33 * b03) * det,\\n            (a22 * b04 - a21 * b05 - a23 * b03) * det,\\n            (a12 * b08 - a10 * b11 - a13 * b07) * det,\\n            (a00 * b11 - a02 * b08 + a03 * b07) * det,\\n            (a32 * b02 - a30 * b05 - a33 * b01) * det,\\n            (a20 * b05 - a22 * b02 + a23 * b01) * det,\\n            (a10 * b10 - a11 * b08 + a13 * b06) * det,\\n            (a01 * b08 - a00 * b10 - a03 * b06) * det,\\n            (a30 * b04 - a31 * b02 + a33 * b00) * det,\\n            (a21 * b02 - a20 * b04 - a23 * b00) * det,\\n            (a11 * b07 - a10 * b09 - a12 * b06) * det,\\n            (a00 * b09 - a01 * b07 + a02 * b06) * det,\\n            (a31 * b01 - a30 * b03 - a32 * b00) * det,\\n            (a20 * b03 - a21 * b01 + a22 * b00) * det\\n        );\\n        return m;\\n    #endif\\n}\\nmat4 transpose_matrix(mat4 matrix) {\\n    #if __VERSION__ == 300\\n        return transpose(matrix);\\n    #else\\n        vec4 vector1 = matrix[0], vector2 = matrix[1], vector3 = matrix[2], vector4 = matrix[3];\\n        float a01 = vector1.y, a02 = vector1.z, a03 = vector1.w;\\n        float a12 = vector2.z, a13 = vector2.w;\\n        float a23 = vector3.w;\\n        mat4 m = mat4(\\n            vector1.x,\\n            vector2.x,\\n            vector3.x,\\n            vector4.x,\\n            a01,\\n            vector2.y,\\n            vector3.y,\\n            vector4.y,\\n            a02,\\n            a12,\\n            vector3.z,\\n            vector4.z,\\n            a03,\\n            a13,\\n            a23,\\n            vector4.w\\n        );\\n        return m;\\n    #endif\\n}",get_output:"#include <invert_matrix>\\n#include <draco_decode_vert>\\n#ifdef HAS_INSTANCE\\n    #include <instance_vert>\\n    #ifdef HAS_INSTANCE_COLOR\\n        varying vec4 vInstanceColor;\\n    #endif\\n#endif\\n#ifdef HAS_SKIN\\n    uniform int skinAnimation;\\n    #include <skin_vert>\\n#endif\\n#include <mask_vert>\\n#ifdef HAS_MORPH\\n    attribute vec3 POSITION0;\\n    attribute vec3 POSITION1;\\n    attribute vec3 POSITION2;\\n    attribute vec3 POSITION3;\\n    attribute vec3 POSITION4;\\n    attribute vec3 POSITION5;\\n    attribute vec3 POSITION6;\\n    attribute vec3 POSITION7;\\n    #ifdef HAS_MORPHNORMALS\\n        attribute vec3 NORMAL0;\\n        attribute vec3 NORMAL1;\\n        attribute vec3 NORMAL2;\\n        attribute vec3 NORMAL3;\\n    #endif\\n    uniform vec4 morphWeights1;\\n    uniform vec4 morphWeights2;\\n#endif\\n#ifdef HAS_TERRAIN_ALTITUDE\\nattribute float aTerrainAltitude;\\n#endif\\nmat4 getPositionMatrix() {\\n    mat4 worldMatrix;\\n    #ifdef HAS_INSTANCE\\n        #ifdef HAS_INSTANCE_COLOR\\n            vInstanceColor = instance_getInstanceColor();\\n        #endif\\n        mat4 attributeMatrix = instance_getAttributeMatrix();\\n        #ifdef HAS_SKIN\\n            if (skinAnimation == 1) {\\n                worldMatrix = attributeMatrix * positionMatrix * skin_getSkinMatrix();\\n            } else {\\n                worldMatrix = attributeMatrix * positionMatrix;\\n            }\\n        #else\\n            worldMatrix = attributeMatrix * positionMatrix;\\n        #endif\\n    #else\\n        #ifdef HAS_SKIN\\n            if (skinAnimation == 1) {\\n                worldMatrix = skin_getSkinMatrix() * positionMatrix;\\n            } else {\\n                worldMatrix = positionMatrix;\\n            }\\n        #else\\n            worldMatrix = positionMatrix;\\n        #endif\\n    #endif\\n    return worldMatrix;\\n}\\n#ifdef HAS_MIN_ALTITUDE\\nuniform float minAltitude;\\n#endif\\nvec4 getPosition(vec3 aPosition) {\\n    vec3 position = decode_getPosition(aPosition);\\n    #ifdef HAS_MORPH\\n        vec4 POSITION = vec4(position + morphWeights1[0] * POSITION0 + morphWeights1[1] * POSITION1 + morphWeights1[2] * POSITION2 + morphWeights1[3] * POSITION3\\n        + morphWeights2[0] * POSITION4 + morphWeights2[1] * POSITION5 + morphWeights2[2] * POSITION6 + morphWeights2[3] * POSITION7\\n        , 1.0);\\n    #else\\n        vec4 POSITION = vec4(position, 1.0);\\n    #endif\\n    #ifdef HAS_TERRAIN_ALTITUDE\\n        POSITION.z += aTerrainAltitude * 100.0;\\n    #endif\\n    #ifdef HAS_MIN_ALTITUDE\\n        POSITION.z += minAltitude * 100.0;\\n    #endif\\n    return POSITION;\\n}\\nvec3 appendMorphNormal(vec3 NORMAL) {\\n    #ifdef HAS_MORPHNORMALS\\n        vec3 normal = NORMAL + morphWeights1[0] * NORMAL0 + morphWeights1[1] * NORMAL1 + morphWeights1[2] * NORMAL2 + morphWeights1[3] * NORMAL3;\\n    #else\\n        vec3 normal = NORMAL;\\n    #endif\\n    return normal;\\n}",instance_vert:"attribute vec4 instance_vectorA;\\nattribute vec4 instance_vectorB;\\nattribute vec4 instance_vectorC;\\n#ifdef HAS_INSTANCE_TERRAIN_ALTITUDE\\nattribute float aTerrainAltitude;\\nuniform float terrainAltitudeScale;\\n#endif\\nmat4 instance_getAttributeMatrix() {\\n    mat4 mat =  mat4(\\n        instance_vectorA.x, instance_vectorB.x, instance_vectorC.x, 0.0,\\n        instance_vectorA.y, instance_vectorB.y, instance_vectorC.y, 0.0,\\n        instance_vectorA.z, instance_vectorB.z, instance_vectorC.z, 0.0,\\n        instance_vectorA.w, instance_vectorB.w, instance_vectorC.w, 1.0\\n    );\\n    #ifdef HAS_INSTANCE_TERRAIN_ALTITUDE\\n        mat4 terrainMat = mat4(\\n            1., 0., 0., 0.,\\n            0., 1., 0., 0.,\\n            0., 0., 1., 0.,\\n            0., 0., aTerrainAltitude * terrainAltitudeScale, 1.\\n        );\\n        mat = terrainMat * mat;\\n    #endif\\n    return mat;\\n}\\n#ifdef HAS_INSTANCE_HIGHLIGHT\\n    attribute vec4 highlight_color;\\n#endif\\n#ifdef HAS_INSTANCE_COLOR\\n   \\n    attribute vec4 instance_color;\\n    vec4 instance_getInstanceColor() {\\n        vec4 color = instance_color;\\n        #ifdef HAS_INSTANCE_HIGHLIGHT\\n            color = instance_color * highlight_color;\\n        #endif\\n        return color;\\n    }\\n#endif",skin_vert:"attribute vec4 WEIGHTS_0;\\nattribute vec4 JOINTS_0;\\nuniform sampler2D jointTexture;\\nuniform vec2 jointTextureSize;\\nuniform float numJoints;\\n#define ROW0_U ((0.5 + 0.0) / 4.)\\n#define ROW1_U ((0.5 + 1.0) / 4.)\\n#define ROW2_U ((0.5 + 2.0) / 4.)\\n#define ROW3_U ((0.5 + 3.0) / 4.)\\nmat4 skin_getBoneMatrix(float jointNdx) {\\n    float v = (jointNdx + 0.5) / numJoints;\\n    return mat4(\\n        texture2D(jointTexture, vec2(ROW0_U, v)),\\n        texture2D(jointTexture, vec2(ROW1_U, v)),\\n        texture2D(jointTexture, vec2(ROW2_U, v)),\\n        texture2D(jointTexture, vec2(ROW3_U, v)));\\n}\\nmat4 skin_getSkinMatrix() {\\n        mat4 skinMatrix = skin_getBoneMatrix(JOINTS_0[0]) * WEIGHTS_0[0] +\\n                        skin_getBoneMatrix(JOINTS_0[1]) * WEIGHTS_0[1] +\\n                        skin_getBoneMatrix(JOINTS_0[2]) * WEIGHTS_0[2] +\\n                        skin_getBoneMatrix(JOINTS_0[3]) * WEIGHTS_0[3];\\n        return skinMatrix;\\n}",heatmap_render_vert:"#ifdef HAS_HEATMAP\\nvarying vec2 heatmap_vTexCoord;\\nvoid heatmap_compute(mat4 matrix, vec3 position) {\\n    vec4 pos = matrix * vec4(position.xy, 0., 1.);\\n    heatmap_vTexCoord = (1. + pos.xy / pos.w) / 2.;\\n}\\n#endif",heatmap_render_frag:"#ifdef HAS_HEATMAP\\nuniform sampler2D heatmap_inputTexture;\\nuniform sampler2D heatmap_colorRamp;\\nuniform float heatmap_heatmapOpacity;\\nvarying vec2 heatmap_vTexCoord;\\nvec4 heatmap_getColor(vec4 color) {\\n    float t = texture2D(heatmap_inputTexture, heatmap_vTexCoord).r;\\n    vec4 heatmapColor = texture2D(heatmap_colorRamp, vec2(t, 0.5)) * heatmap_heatmapOpacity;\\n    return color * (1.0 - heatmapColor.a) + heatmapColor * heatmapColor.a;\\n}\\n#endif",line_extrusion_vert:"#ifdef IS_LINE_EXTRUSION\\n    #define ALTITUDE_SCALE 32767.0;\\n    #define EXTRUDE_SCALE 63.0;\\n    attribute vec2 aExtrude;\\n    #ifdef HAS_LINE_WIDTH\\n        attribute float aLineWidth;\\n    #else\\n        uniform float lineWidth;\\n    #endif\\n    #ifdef HAS_LINE_HEIGHT\\n        attribute float aLineHeight;\\n    #else\\n        uniform float lineHeight;\\n    #endif\\n    uniform float linePixelScale;\\n    vec3 getLineExtrudePosition(vec3 position) {\\n        #ifdef HAS_LINE_WIDTH\\n            float lineWidth = aLineWidth / 2.0;\\n        #endif\\n        #ifdef HAS_LINE_HEIGHT\\n            float lineHeight = aLineHeight / 10.0;\\n        #endif\\n        float halfwidth = lineWidth / 2.0;\\n        float outset = halfwidth;\\n        vec2 dist = outset * aExtrude / EXTRUDE_SCALE;\\n        position.z *= lineHeight / ALTITUDE_SCALE;\\n        return position + vec3(dist, 0.0) * linePixelScale;\\n    }\\n#endif",gl2_vert:"#if __VERSION__ == 300\\n    #define texture2D texture\\n    #define varying out\\n    #define attribute in\\n#endif",gl2_frag:"#if __VERSION__ == 300\\n    #define varying in\\n    #define gl_FragDepthEXT gl_FragDepth\\n    #define texture2D texture\\n    #define textureCube texture\\n    #define texture2DProj textureProj\\n    #define texture2DLodEXT textureLod\\n    #define texture2DProjLodEXT textureProjLod\\n    #define textureCubeLodEXT textureLod\\n    #define texture2DGradEXT textureGrad\\n    #define texture2DProjGradEXT textureProjGrad\\n    #define textureCubeGradEXT textureGrad\\n    out vec4 glFragColor;\\n#else\\n    vec4 glFragColor;\\n#endif",hsv_frag:"\\nconst mediump vec4 HSV_K0 = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);\\nconst mediump vec4 HSV_K1 = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);\\nconst mediump float HSV_E = 1.0e-10;\\nvec3 hsv_rgb2hsv(vec3 c) {\\n    vec4 K = HSV_K0;\\n    vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));\\n    vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));\\n    float d = q.x - min(q.w, q.y);\\n    float e = HSV_E;\\n    return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);\\n}\\nvec3 hsv_hsv2rgb(vec3 c) {\\n    vec4 K = HSV_K1;\\n    vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);\\n    return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);\\n}\\nvec4 hsv_apply(vec4 c, vec3 hsvOffset) {\\n    vec3 hsv = hsv_rgb2hsv(c.rgb);\\n    hsv += hsv * hsvOffset;\\n    hsv = clamp(hsv, 0.0, 1.0);\\n    return vec4(hsv_hsv2rgb(hsv), c.a);\\n}\\nvec3 hsv_apply(vec3 c, vec3 hsvOffset) {\\n    vec3 hsv = hsv_rgb2hsv(c.rgb);\\n    hsv += hsv * hsvOffset;\\n    hsv = clamp(hsv, 0.0, 1.0);\\n    return hsv_hsv2rgb(hsv);\\n}\\nmat4 contrastMatrix(float contrast)\\n{\\n    float t = (1.0 - contrast) / 2.0;\\n    return mat4(\\n        contrast, 0., 0., 0.,\\n        0., contrast, 0., 0.,\\n        0., 0., contrast, 0.,\\n        t, t, t, 1\\n    );\\n}",snow_frag:"#ifdef HAS_SNOW\\n    float lerp(float a, float b, float w) {\\n        return a + w * (b - a);\\n    }\\n    vec3 snow(vec4 sceneColor, vec3 normalColor, float height) {\\n        float snowIntense = normalColor.b;\\n        vec3 fixedC = vec3(1.0, 1.0, 1.0);\\n        if (height < 1.0) {\\n            float r = lerp(0.5, fixedC.x, snowIntense);\\n            float g = lerp(0.5, fixedC.y, snowIntense);\\n            float b = lerp(0.5, fixedC.z, snowIntense);\\n            return vec3(r, g, b);\\n        } else {\\n            float r = lerp(sceneColor.r, fixedC.x, snowIntense);\\n            float g = lerp(sceneColor.g, fixedC.y, snowIntense);\\n            float b = lerp(sceneColor.b, fixedC.z, snowIntense);\\n            return vec3(r, g, b);\\n        }\\n    }\\n#endif",draco_decode_vert:"#if defined(HAS_TANGENT)\\n    attribute vec4 aTangent;\\n#elif defined(HAS_NORMAL)\\n    #ifdef HAS_DRACO_NORMAL\\n        attribute vec2 aNormal;\\n        uniform float gltf_u_dec_normal_rangeConstant;\\n    #else\\n        attribute vec3 aNormal;\\n    #endif\\n#endif\\n#ifdef HAS_DRACO_POSITION\\n    uniform float gltf_u_dec_position_normConstant;\\n    uniform vec3 minValues_pos;\\n    vec3 decodeDracoPosition(vec3 aPosition) {\\n        return minValues_pos + aPosition * gltf_u_dec_position_normConstant;\\n    }\\n#endif\\n#ifdef HAS_DRACO_TEXCOORD\\n    uniform vec2 minValues_tex;\\n    uniform float gltf_u_dec_texcoord_0_normConstant;\\n    vec2 decodeDracoTexcoord(vec2 aTexCoord) {\\n        return minValues_tex + aTexCoord * gltf_u_dec_texcoord_0_normConstant;\\n    }\\n#endif\\n#ifdef HAS_WEB3D_quantized_attributes_TEXCOORD\\n    uniform mat3 decodeMatrix;\\n#endif\\n#ifdef HAS_DRACO_NORMAL\\n    float czm_signNotZero(float value) {\\n        return value >= 0.0 ? 1.0 : -1.0;\\n    }\\n    vec2 czm_signNotZero(vec2 value) {\\n        return vec2(czm_signNotZero(value.x), czm_signNotZero(value.y));\\n    }\\n    vec3 decodeDracoNormal(vec2 encoded, float range)\\n    {\\n        if (encoded.x == 0.0 && encoded.y == 0.0) {\\n            return vec3(0.0, 0.0, 0.0);\\n        }\\n        encoded = encoded / range * 2.0 - 1.0;\\n        vec3 v = vec3(encoded.x, encoded.y, 1.0 - abs(encoded.x) - abs(encoded.y));\\n        if (v.z < 0.0) {\\n            v.xy = (1.0 - abs(v.yx)) * czm_signNotZero(v.xy);\\n        }\\n        return normalize(v);\\n    }\\n    vec3 decode_getNormal(vec2 aNormal) {\\n        return decodeDracoNormal(aNormal, gltf_u_dec_normal_rangeConstant).zxy;\\n    }\\n#endif\\n#ifdef HAS_COMPRESSED_INT16\\n    #ifdef HAS_COMPRESSED_INT16_POSITION\\n      uniform vec2 compressedPositionRange;\\n    #endif\\n    #ifdef HAS_COMPRESSED_INT16_TEXCOORD_0\\n      uniform vec2 compressedTexcoordRange_0;\\n    #endif\\n    #ifdef HAS_COMPRESSED_INT16_TEXCOORD_1\\n      uniform vec2 compressedTexcoordRange_1;\\n    #endif\\n    #ifdef HAS_COMPRESSED_INT16_NORMAL\\n      uniform vec2 compressedNormalRange;\\n    #endif\\n    #ifdef HAS_COMPRESSED_INT16_RATIO\\n      uniform float compressed_ratio;\\n    #endif\\n    float int16ToFloat32(float value, vec2 range) {\\n        float v = (value >= 32768.0) ? -(65536.0 - value) / 32768.0 : value / 32767.0;\\n        return (v + 1.0) * (range.y - range.x) / 2.0 + range.x;\\n    }\\n#endif\\nvec3 decode_getPosition(vec3 aPosition) {\\n    vec3 position = aPosition;\\n    #if defined(HAS_COMPRESSED_INT16) && defined(HAS_COMPRESSED_INT16_POSITION)\\n        float x = int16ToFloat32(aPosition.x, compressedPositionRange);\\n        float y = int16ToFloat32(aPosition.y, compressedPositionRange);\\n        float z = int16ToFloat32(aPosition.z, compressedPositionRange);\\n        #ifdef HAS_COMPRESSED_INT16_RATIO\\n          position = vec3(x / compressed_ratio, y / compressed_ratio, z);\\n        #else\\n          position = vec3(x, y, z);\\n        #endif\\n    #endif\\n    #ifdef HAS_DRACO_POSITION\\n        return decodeDracoPosition(position);\\n    #else\\n        return position;\\n    #endif\\n}\\nvec2 decode_getTexcoord(vec2 aTexCoord) {\\n    vec2 texcoord = aTexCoord;\\n    #if defined(HAS_COMPRESSED_INT16) && (defined(HAS_COMPRESSED_INT16_TEXCOORD_0) || defined(HAS_COMPRESSED_INT16_TEXCOORD_1))\\n        float x = int16ToFloat32(aTexCoord.x, compressedTexcoordRange_0);\\n        float y = int16ToFloat32(aTexCoord.y, compressedTexcoordRange_0);\\n        texcoord = vec2(x, y);\\n    #endif\\n    #ifdef HAS_DRACO_TEXCOORD\\n        return decodeDracoTexcoord(texcoord);\\n    #elif defined(HAS_WEB3D_quantized_attributes_TEXCOORD)\\n        vec3 web3dTexcoord = decodeMatrix * vec3(texcoord, 1.0);\\n        return vec2(web3dTexcoord.x, web3dTexcoord.y);\\n    #else\\n        return texcoord;\\n    #endif\\n}\\nvec3 decode_getNormal(vec3 aNormal) {\\n    #ifdef HAS_COMPRESSED_INT16_NORMAL\\n        aNormal.x = int16ToFloat32(aNormal.x, compressedNormalRange);\\n        aNormal.y = int16ToFloat32(aNormal.y, compressedNormalRange);\\n        aNormal.z = int16ToFloat32(aNormal.z, compressedNormalRange);\\n    #endif\\n    return aNormal;\\n}",highlight_vert:"#if defined(HAS_HIGHLIGHT_COLOR)\\n    attribute vec4 aHighlightColor;\\n    varying vec4 vHighlightColor;\\n#endif\\n#if defined(HAS_HIGHLIGHT_OPACITY)\\n    attribute float aHighlightOpacity;\\n    varying float vHighlightOpacity;\\n#endif\\nvoid highlight_setVarying() {\\n    #if defined(HAS_HIGHLIGHT_COLOR)\\n        vHighlightColor = aHighlightColor / 255.0;\\n    #endif\\n    #if defined(HAS_HIGHLIGHT_OPACITY)\\n        vHighlightOpacity = aHighlightOpacity / 255.0;\\n    #endif\\n}",highlight_frag:"#if defined(HAS_HIGHLIGHT_COLOR)\\n\\tvarying vec4 vHighlightColor;\\n#endif\\n#if defined(HAS_HIGHLIGHT_OPACITY)\\n    varying float vHighlightOpacity;\\n#endif\\nvec4 highlight_blendColor(vec4 color) {\\n\\tvec4 outColor;\\n\\t#if defined(HAS_HIGHLIGHT_COLOR)\\n\\t\\tcolor.rgb = color.rgb * (1.0 - vHighlightColor.a) + vHighlightColor.rgb * vHighlightColor.a;\\n\\t\\t#ifndef HAS_HIGHLIGHT_COLOR_POINT\\n        \\tcolor.a = color.a * (1.0 - vHighlightColor.a) + vHighlightColor.a;\\n        #endif\\n        outColor = color;\\n\\t#else\\n\\t\\toutColor = color;\\n\\t#endif\\n\\t#if defined(HAS_HIGHLIGHT_OPACITY)\\n\\t\\toutColor *= vHighlightOpacity;\\n\\t#endif\\n\\treturn outColor;\\n}",mask_vert:"#ifdef HAS_MASK_EXTENT\\n    uniform vec4 mask_extent;\\n    uniform sampler2D mask_colorExtent;\\n    uniform sampler2D mask_modeExtent;\\n    uniform float mask_maskMode;\\n    uniform float mask_hasFlatOut;\\n    uniform mat4 viewMatrix;\\n    uniform float mask_heightRatio;\\n    uniform float mask_heightOffset;\\n    varying vec4 vWorldPosition;\\n    varying vec2 vUVInExtent;\\n    varying float vHeightRatio;\\n    varying float vHeightOffset;\\n    const float CLIPINSIDE_MODE = 0.2;\\n    const float FLATINSIDE_MODE = 0.3;\\n    const float FLATOUTSIDE_MODE = 0.4;\\n    const float ELEVATE_MODE = 0.7;\\n    float random (vec2 st) {\\n        return fract(sin(dot(st.xy,vec2(12.9898,78.233)))*43758.5453123) * 0.1;\\n    }\\n    bool isInExtent(vec4 color) {\\n        return length(color.rgb) > 0.0;\\n    }\\n    float getFlatHeight(float maskMode, float flatHeight, float height) {\\n      if (maskMode <= ELEVATE_MODE && maskMode > 0.6) {\\n          return flatHeight + height;\\n      } else {\\n        return flatHeight;\\n      }\\n    }\\n    vec4 getNoErrorPosition(vec4 position, vec4 wPosition) {\\n      vec4 realPos = modelViewMatrix * position;      vec4 pos = viewMatrix * wPosition;      vec4 tempPos = viewMatrix * modelMatrix * position;      float deltaX = realPos.x - tempPos.x;\\n      float deltaY = realPos.y - tempPos.y;\\n      float deltaZ = realPos.z - tempPos.z;\\n      pos.x = pos.x + deltaX;\\n      pos.y = pos.y + deltaY;\\n      pos.z = pos.z + deltaZ;\\n      return pos;\\n    }\\n    vec4 getMaskPosition(vec4 position, mat4 modelMatrix) {\\n        vWorldPosition = modelMatrix * position;\\n        float w = mask_extent.z - mask_extent.x;\\n        float h = mask_extent.y - mask_extent.w;\\n        vec2 uvInExtent = vec2((vWorldPosition.x - mask_extent.x) / abs(w), 1.0 - (vWorldPosition.y - mask_extent.w) / h);\\n        vec4 extentColor = texture2D(mask_colorExtent, uvInExtent);\\n        vec3 maskOptionColor = texture2D(mask_modeExtent, uvInExtent).rgb;\\n        float maskMode = maskOptionColor.r;\\n        float flatHeight = maskOptionColor.g / mask_heightRatio + mask_heightOffset;\\n        float height = getFlatHeight(maskMode, flatHeight, vWorldPosition.z);\\n        vec4 wPosition = vec4(vWorldPosition.x, vWorldPosition.y, height, vWorldPosition.w);\\n        vUVInExtent = uvInExtent;\\n        vHeightRatio = mask_heightRatio;\\n        vHeightOffset = mask_heightOffset;\\n        if (maskMode <= FLATOUTSIDE_MODE && maskMode > FLATINSIDE_MODE) {\\n            return modelViewMatrix * position;;\\n        } else if (mask_hasFlatOut == 1.0) {\\n            return getNoErrorPosition(position, wPosition);\\n        }\\n        if (isInExtent(extentColor) == true && maskMode <= FLATINSIDE_MODE && maskMode > CLIPINSIDE_MODE) {\\n            return getNoErrorPosition(position, wPosition);\\n        } if (isInExtent(extentColor) == true && maskMode <= ELEVATE_MODE && maskMode > 0.6) {\\n            return getNoErrorPosition(position, wPosition);\\n        } else {\\n            return modelViewMatrix * position;\\n        }\\n    }\\n#endif",mask_frag:"#ifdef HAS_MASK_EXTENT\\n    uniform sampler2D mask_colorExtent;\\n    uniform sampler2D mask_modeExtent;\\n    uniform float mask_hasClipOut;\\n    varying float vHeightRatio;\\n    varying float vHeightOffset;\\n    varying vec2 vUVInExtent;\\n    varying vec4 vWorldPosition;\\n    const float CLIPINSIDE_MODE = 0.1;\\n    const float CLIPOUTSIDE_MODE = 0.2;\\n    const float FLATINSIDE_MODE = 0.3;\\n    const float FLATOUTSIDE_MODE = 0.4;\\n    const float COLOR_MODE = 0.5;\\n    const float VIDEO_MODE = 0.6;\\n    bool isInExtent(vec4 color) {\\n        return length(color.rgb) > 0.0;\\n    }\\n    vec4 setMask(vec4 glFragColor) {\\n        vec4 extentColor = texture2D(mask_colorExtent, vUVInExtent);\\n        vec4 modeColor = texture2D(mask_modeExtent, vUVInExtent);\\n        float maskMode = modeColor.r;\\n        float minHeight = modeColor.b / vHeightRatio + vHeightOffset;\\n        float maxHeight = modeColor.a / vHeightRatio + vHeightOffset;\\n        if (maskMode > CLIPINSIDE_MODE && maskMode <= CLIPOUTSIDE_MODE) {\\n            if (minHeight == 0.0 && maxHeight == 0.0) {\\n                return glFragColor;\\n            } else if (vWorldPosition.z >= minHeight && vWorldPosition.z <= maxHeight) {\\n                return glFragColor;\\n            } else {\\n              discard;\\n            }\\n        } else if (mask_hasClipOut == 1.0) {\\n            discard;\\n        }\\n        if (isInExtent(extentColor) == true && maskMode <= CLIPINSIDE_MODE && maskMode > 0.0) {\\n            if (minHeight == 0.0 && maxHeight == 0.0) {\\n                discard;\\n            } else if (vWorldPosition.z >= minHeight && vWorldPosition.z <= maxHeight) {\\n                discard;\\n            } else {\\n              return glFragColor;\\n            }\\n        } else if (isInExtent(extentColor) == true && maskMode <= VIDEO_MODE && maskMode > FLATOUTSIDE_MODE) {\\n            if (minHeight == 0.0 && maxHeight == 0.0) {\\n                glFragColor = vec4(mix(extentColor.rgb, glFragColor.rgb, 1.0 - extentColor.a), glFragColor.a);\\n            } else if (vWorldPosition.z >= minHeight && vWorldPosition.z <= maxHeight) {\\n                glFragColor = vec4(mix(extentColor.rgb, glFragColor.rgb, 1.0 - extentColor.a), glFragColor.a);\\n            }\\n        }\\n        return glFragColor;\\n    }\\n#endif",computeTexcoord_frag:"#ifdef HAS_KHR_TEXTURE_TRANSFORM\\n    uniform vec2 khr_offset;\\n    uniform float khr_rotation;\\n    uniform vec2 khr_scale;\\n    vec2 khr_tex_transformTexCoord(vec2 texCoords, vec2 offset, float rotation, vec2 scale) {\\n        rotation = -rotation;\\n        mat3 transform = mat3(\\n        cos(rotation) * scale.x, sin(rotation) * scale.x, 0.0, -sin(rotation) * scale.y, cos(rotation) * scale.y, 0.0, offset.x, offset.y, 1.0);\\n        vec2 transformedTexCoords = (transform * vec3(fract(texCoords), 1.0)).xy;\\n        return transformedTexCoords;\\n    }\\n#endif\\nvarying highp vec2 vTexCoord;\\n#ifdef HAS_I3S_UVREGION\\n    varying vec4 vUvRegion;\\n#endif\\nvec2 computeTexCoord(vec2 texCoord) {\\n    #ifdef HAS_I3S_UVREGION\\n        vec2 atlasScale = vUvRegion.zw - vUvRegion.xy;\\n        vec2 uvAtlas = fract(texCoord) * atlasScale + vUvRegion.xy;\\n        return uvAtlas;\\n    #elif defined(HAS_KHR_TEXTURE_TRANSFORM)\\n        return khr_tex_transformTexCoord(texCoord, khr_offset, khr_rotation, khr_scale);\\n    #else\\n        return texCoord;\\n    #endif\\n}",terrain_normal_frag:"#ifdef HAS_TERRAIN_NORMAL\\n    uniform sampler2D terrainHeightTexture;\\n    uniform vec2 terrainHeightMapResolution;\\n    uniform vec2 terrainResolution;\\n    uniform vec4 terrainUnpackFactors;\\n    float getHeight(vec2 uv) {\\n        vec4 color = texture2D(terrainHeightTexture, uv) * 255.0;\\n        color.a = -1.0;\\n        return dot(color, terrainUnpackFactors) / 4.0;\\n    }\\n    vec3 convertTerrainHeightToNormalMap(vec2 uv) {\\n        uv.y = 1.0 - uv.y;\\n        vec2 epsilon = 1.0 / terrainHeightMapResolution;\\n        float a = getHeight(uv + vec2(-epsilon.x, -epsilon.y));\\n        float b = getHeight(uv + vec2(0, -epsilon.y));\\n        float c = getHeight(uv + vec2(epsilon.x, -epsilon.y));\\n        float d = getHeight(uv + vec2(-epsilon.x, 0));\\n        float e = getHeight(uv + vec2(epsilon.x, 0));\\n        float f = getHeight(uv + vec2(-epsilon.x, epsilon.y));\\n        float g = getHeight(uv + vec2(0, epsilon.y));\\n        float h = getHeight(uv + vec2(epsilon.x, epsilon.y));\\n        vec2 dxy = vec2(\\n            (c + e + e + h) - (a + d + d + f),\\n            (f + g + g + h) - (a + b + b + c)\\n        );\\n        return normalize(vec3(dxy / epsilon, terrainResolution ));\\n    }\\n#endif",vertex_color_vert:"#ifdef HAS_VERTEX_COLOR\\nattribute float aVertexColorType;\\nuniform vec4 vertexColorsOfType[VERTEX_TYPES_COUNT];\\nvarying vec4 vertexColor_color;\\nvoid vertexColor_update() {\\n    vertexColor_color = vertexColorsOfType[int(aVertexColorType)];\\n}\\n#endif\\n//: topPolygonFill  bottomPolygonFill",vertex_color_frag:"#ifdef HAS_VERTEX_COLOR\\nvarying vec4 vertexColor_color;\\nvec4 vertexColor_get() {\\n\\treturn vertexColor_color;\\n}\\n#endif",excavate_vert:"#ifdef HAS_EXCAVATE_ANALYSIS\\n  uniform vec4 excavateExtent;\\n  varying vec2 vCoordinateTexcoord;\\n  varying float vHeight;\\n  float getWorldHeight() {\\n    vec4 wPosition = modelMatrix * getPosition(aPosition);\\n    return wPosition.z;\\n  }\\n  vec2 getCoordinateTexcoord() {\\n    mat4 localPositionMatrix = getPositionMatrix();\\n    vec4 wPosition = modelMatrix * localPositionMatrix * getPosition(aPosition);\\n    float x = (wPosition.x - excavateExtent.x) / (excavateExtent.z - excavateExtent.x);\\n    float y = (wPosition.y - excavateExtent.y) / (excavateExtent.w - excavateExtent.y);\\n    return vec2(x, y);\\n  }\\n#endif",excavate_frag:"#ifdef HAS_EXCAVATE_ANALYSIS\\n  uniform sampler2D heightmap;\\n  uniform float excavateHeight;\\n  varying vec2 vCoordinateTexcoord;\\n  varying float vHeight;\\n  const vec2 range = vec2(-100.0, 1000.0);\\n  float decodeHeight(const in vec4 pack) {\\n      return pack.r + pack.g / 255.0;\\n  }\\n  vec4 excavateColor(vec4 fragColor) {\\n      float samplerHeight = decodeHeight(texture2D(heightmap, vCoordinateTexcoord));\\n      float realHeight = samplerHeight * (range.y - range.x) + range.x;\\n      if(realHeight < range.x || realHeight > range.y) {\\n          realHeight = 0.0;\\n      }\\n      if(vHeight > realHeight) {\\n          discard;\\n      }\\n      return fragColor;\\n  }\\n#endif",srgb_frag:"vec3 linearTosRGB(const in vec3 color) {\\n    return vec3( color.r < 0.0031308 ? color.r * 12.92 : 1.055 * pow(color.r, 1.0/2.4) - 0.055, color.g < 0.0031308 ? color.g * 12.92 : 1.055 * pow(color.g, 1.0/2.4) - 0.055, color.b < 0.0031308 ? color.b * 12.92 : 1.055 * pow(color.b, 1.0/2.4) - 0.055);\\n}\\nvec3 sRGBToLinear(const in vec3 color) {\\n    return vec3( color.r < 0.04045 ? color.r * (1.0 / 12.92) : pow((color.r + 0.055) * (1.0 / 1.055), 2.4), color.g < 0.04045 ? color.g * (1.0 / 12.92) : pow((color.g + 0.055) * (1.0 / 1.055), 2.4), color.b < 0.04045 ? color.b * (1.0 / 12.92) : pow((color.b + 0.055) * (1.0 / 1.055), 2.4));\\n}"};var A={register(e,n){if(p[e])throw new Error(\`Key of ${lE}e} is already registered in ShaderLib.\`);p[e]=n},compile:e=>b(e)};const y=/^[ \\t]*#include +<([\\w\\d.]+)>/gm;function b(e){return e.replace(y,w)}function w(e,n){const t=p[n];if(!t)throw new Error("Can not resolve #include <"+n+">");return b(t)}const E=[[.263385,-.0252475],[-.38545,.054485],[-.139795,-.5379925],[-.2793775,.6875475],[.7139025,.4710925],[.90044,-.16422],[.4481775,-.82799],[-.9253375,-.2910625],[.3468025,1.02292],[-1.13742,.33522],[-.7676225,-.9123175],[-.2005775,-1.1774125],[-.926525,.96876],[1.12909,-.7500325],[.9603,1.14625]],I=E.length,T=[0,0];for(let e=0;e<E.length;e++)T[0]+=E[e][0],T[1]+=E[e][1];T[0]/=I,T[1]/=I;!function(e,n,t){var r=n[0],o=n[1],i=n[2],a=n[3],s=r+r,c=o+o,f=i+i,l=r*s,h=r*c,d=r*f,v=o*c,u=o*f,_=i*f,m=a*s,g=a*c,x=a*f;e[0]=1-(v+_),e[1]=h+x,e[2]=d-g,e[3]=0,e[4]=h-x,e[5]=1-(l+_),e[6]=u+m,e[7]=0,e[8]=d+g,e[9]=u-m,e[10]=1-(l+v),e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1}([],function(e,n,t,r){var o=.5*Math.PI/180;n*=o,t*=o,r*=o;var i=Math.sin(n),a=Math.cos(n),s=Math.sin(t),c=Math.cos(t),f=Math.sin(r),l=Math.cos(r);return e[0]=i*c*l-a*s*f,e[1]=a*s*l+i*c*f,e[2]=a*c*f-i*s*l,e[3]=a*c*l+i*s*f,e}([],90,0,0),[0,0,0]),function(){const e=[0,0,0],n=90*Math.PI/180,t=[0,0,0,0],r=new Array(16)}(),A.compile("#define SHADER_NAME SKYBOX\\n#if __VERSION__ == 100\\n#ifdef GL_EXT_shader_texture_lod\\n#extension GL_EXT_shader_texture_lod : enable\\n#define textureCubeLod(tex, uv, lod) textureCubeLodEXT(tex, uv, lod)\\n#else\\n#define textureCubeLod(tex, uv, lod) textureCube(tex, uv, lod)\\n#endif\\n#else\\n#define textureCubeLod(tex, uv, lod) textureLod(tex, uv, lod)\\n#endif\\nprecision highp float;\\n#define saturate(x)        clamp(x, 0.0, 1.0)\\n#include <gl2_frag>\\n#include <hsv_frag>\\nuniform vec3 hsv;\\nvarying vec3 vWorldPos;\\n#ifdef USE_AMBIENT\\nuniform vec3 diffuseSPH[9];\\n#else\\nuniform samplerCube cubeMap;\\nuniform float bias;\\nuniform float size;\\n#endif\\nuniform float environmentExposure;\\nuniform float backgroundIntensity;\\nvec4 c(const in samplerCube d, const in vec3 e, const in float f, const in float h) {\\n  vec3 i = e;\\n  return textureCubeLod(d, i, h);\\n}\\nvec3 j(const in vec3 k, const in vec3 l[9]) {\\n  float x = k.x;\\n  float y = k.y;\\n  float z = k.z;\\n  vec3 m = (l[0] + l[1] * x + l[2] * y + l[3] * z + l[4] * z * x + l[5] * y * z + l[6] * y * x + l[7] * (3. * z * z - 1.) + l[8] * (x * x - y * y));\\n  return max(m, vec3(.0));\\n}\\nfloat n(const in vec2 o) {\\n  vec3 u = fract(vec3(o.xyx) * .1031);\\n  u += dot(u, u.yzx + 19.19);\\n  return fract((u.x + u.y) * u.z);\\n}\\n#if defined(TONE_MAPPING)\\nconst float v = 1.;\\nvec3 A(vec3 B) {\\n  vec3 a = B * (B + .0245786) - .000090537;\\n  vec3 b = B * (.983729 * B + .4329510) + .238081;\\n  return a / b;\\n}\\nvec3 C(vec3 D) {\\n  const mat3 E = mat3(vec3(.59719, .07600, .02840), vec3(.35458, .90834, .13383), vec3(.04823, .01566, .83777));\\n  const mat3 F = mat3(vec3(1.60475, -.10208, -.00327), vec3(-.53108, 1.10813, -.07276), vec3(-.07367, -.00605, 1.07602));\\n  D *= v / .6;\\n  D = E * D;\\n  D = A(D);\\n  D = F * D;\\n  return saturate(D);\\n}\\nvec3 G(vec3 D) {\\n  return C(D);\\n}\\nvec4 H(in vec4 I) {\\n  return vec4(mix(pow(I.rgb, vec3(.41666)) * 1.055 - vec3(.055), I.rgb * 12.92, vec3(lessThanEqual(I.rgb, vec3(.0031308)))), I.a);\\n}\\nvec4 J(vec4 I) {\\n  return (H(I));\\n}\\n#endif\\nvoid main() {\\n  vec4 K;\\n#ifdef USE_AMBIENT\\nvec3 k = normalize(vWorldPos + mix(-.5 / 255., .5 / 255., n(gl_FragCoord.xy)) * 2.);\\n  K = vec4(j(k, diffuseSPH), 1.);\\n#else\\nK = c(cubeMap, vWorldPos, size, bias);\\n#endif\\nK.rgb *= environmentExposure;\\n  K.rgb *= backgroundIntensity;\\n  glFragColor = K;\\n  if(length(hsv) > .0) {\\n    glFragColor.rgb = hsv_apply(clamp(glFragColor.rgb, .0, 1.), hsv);\\n  }\\n#if defined(TONE_MAPPING)\\nglFragColor.rgb = G(glFragColor.rgb);\\n  glFragColor = J(glFragColor);\\n#endif\\n#if __VERSION__ == 100\\ngl_FragColor = glFragColor;\\n#endif\\n}"),function(){const e=[[-1,-1,-1,1],[1,-1,-1,1],[1,1,-1,1],[-1,1,-1,1],[-1,-1,1,1],[1,-1,1,1],[1,1,1,1],[-1,1,1,1]],n=new Array(16)}(),function(){let e=new Array(4);const n=new Array(3),t=[0,0,0,0],r=[0,1,0],o=new Array(3);let i=new Array(16),a=new Array(16);const s=new Array(16),c=[1,1,1],f=[0,0,0]}();const O=new Uint8Array(4);new Float32Array(O.buffer);class S{constructor(e=257){this.gridSize=e;const n=e-1;if(n&n-1)throw new Error(\`Expected grid size to be 2^n+1, got ${lE}e}.\`);this.numTriangles=n*n*2-2,this.numParentTriangles=this.numTriangles-n*n,this.indices=new Uint32Array(this.gridSize*this.gridSize),this.coords=new Uint16Array(4*this.numTriangles);for(let e=0;e<this.numTriangles;e++){let t=e+2,r=0,o=0,i=0,a=0,s=0,c=0;for(1&t?i=a=s=n:r=o=c=n;(t>>=1)>1;){const e=r+i>>1,n=o+a>>1;1&t?(i=r,a=o,r=s,o=c):(r=i,o=a,i=s,a=c),s=e,c=n}const f=4*e;this.coords[f+0]=r,this.coords[f+1]=o,this.coords[f+2]=i,this.coords[f+3]=a}}createTile(e){return new C(e,this)}}class C{constructor(e,n){const t=n.gridSize;if(e.length!==t*t)throw new Error(\`Expected terrain data of length ${lE}t*t} (${lE}t} x ${lE}t}), got ${lE}e.length}.\`);this.terrain=e,this.martini=n,this.errors=new Float32Array(e.length),this.update()}update(){const{numTriangles:e,numParentTriangles:n,coords:t,gridSize:r}=this.martini,{terrain:o,errors:i}=this;for(let a=e-1;a>=0;a--){const e=4*a,s=t[e+0],c=t[e+1],f=t[e+2],l=t[e+3],h=s+f>>1,d=c+l>>1,v=h+d-c,u=d+s-h,_=(o[c*r+s]+o[l*r+f])/2,m=d*r+h,g=Math.abs(_-o[m]);if(i[m]=Math.max(i[m],g),a<n){const e=(c+u>>1)*r+(s+v>>1),n=(l+u>>1)*r+(f+v>>1);i[m]=Math.max(i[m],i[e],i[n])}}}getMesh(e=0){const{gridSize:n,indices:t}=this.martini,{errors:r}=this;let o=0,i=0;const a=n-1;function s(a,c,f,l,h,d){const v=a+f>>1,u=c+l>>1;Math.abs(a-h)+Math.abs(c-d)>1&&r[u*n+v]>e?(s(h,d,a,c,v,u),s(f,l,h,d,v,u)):(t[c*n+a]=t[c*n+a]||++o,t[l*n+f]=t[l*n+f]||++o,t[d*n+h]=t[d*n+h]||++o,i++)}t.fill(0),s(0,0,a,a,a,0),s(a,a,0,0,0,a);const c=new Uint16Array(2*o),f=new Uint32Array(3*i);let l=0;function h(o,i,a,s,d,v){const u=o+a>>1,_=i+s>>1;if(Math.abs(o-d)+Math.abs(i-v)>1&&r[_*n+u]>e)h(d,v,o,i,u,_),h(a,s,d,v,u,_);else{const e=t[i*n+o]-1,r=t[s*n+a]-1,h=t[v*n+d]-1;c[2*e]=o,c[2*e+1]=i,c[2*r]=a,c[2*r+1]=s,c[2*h]=d,c[2*h+1]=v,f[l++]=e,f[l++]=r,f[l++]=h}}return h(0,0,a,a,a,0),h(a,a,0,0,0,a),{vertices:c,triangles:f}}getMeshWithSkirts(e=0,n){const{gridSize:t,indices:r}=this.martini,{errors:o}=this;let i=0,a=0;const s=t-1;let c,f,l=0;const h=[],d=[],v=[],u=[];function _(n,m,g,x,p,A){const y=n+g>>1,b=m+x>>1;Math.abs(n-p)+Math.abs(m-A)>1&&o[b*t+y]>e?(_(p,A,n,m,y,b),_(g,x,p,A,y,b)):(c=m*t+n,f=x*t+g,l=A*t+p,0===r[c]&&(0===n?h.push(i):n===s&&d.push(i),0===m?v.push(i):m===s&&u.push(i),r[c]=++i),0===r[f]&&(0===g?h.push(i):g===s&&d.push(i),0===x?v.push(i):x===s&&u.push(i),r[f]=++i),0===r[l]&&(0===p?h.push(i):p===s&&d.push(i),0===A?v.push(i):A===s&&u.push(i),r[l]=++i),a++)}let m;r.fill(0),_(0,0,s,s,s,0),_(s,s,0,0,0,s),m=n?2*(i+3*h.length-2+3*d.length-2+3*v.length-2+3*u.length-2):2*(i+h.length+d.length+v.length+u.length);const g=3*(a+2*(h.length-1)+2*(d.length-1)+2*(v.length-1)+2*(u.length-1)),x=new Uint16Array(m),p=new Uint32Array(g);let A=0;function y(n,i,a,s,c,f){const l=n+a>>1,h=i+s>>1;if(Math.abs(n-c)+Math.abs(i-f)>1&&o[h*t+l]>e)y(c,f,n,i,l,h),y(a,s,c,f,l,h);else{const e=r[i*t+n]-1,o=r[s*t+a]-1,l=r[f*t+c]-1;x[2*e]=n,x[2*e+1]=i,x[2*o]=a,x[2*o+1]=s,x[2*l]=c,x[2*l+1]=f,p[A++]=e,p[A++]=o,p[A++]=l}}y(0,0,s,s,s,0),y(s,s,0,0,0,s),h.sort(((e,n)=>x[2*e+1]-x[2*n+1])),d.sort(((e,n)=>x[2*n+1]-x[2*e+1])),v.sort(((e,n)=>x[2*n]-x[2*e])),u.sort(((e,n)=>x[2*e]-x[2*n]));let b,w,E,I,T=2*i,O=0;function S(e){O=e.length;for(let t=0;t<O-1;t++)b=e[t],w=e[t+1],E=T/2,I=(T+(n?6:2))/2,x[T++]=2*b,x[T++]=2*b+1,n&&(x[T++]=2*b,x[T++]=2*b+1,x[T++]=2*w,x[T++]=2*w+1),n?(p[A++]=E+1,p[A++]=E,p[A++]=E+2,p[A++]=E,p[A++]=I,p[A++]=E+2):(p[A++]=b,p[A++]=E,p[A++]=w,p[A++]=E,p[A++]=I,p[A++]=w);x[T++]=2*e[O-1],x[T++]=2*e[O-1]+1}S(h);const C=T;S(d);const M=T;S(v);const H=T;S(u);return{vertices:x,triangles:p,numVerticesWithoutSkirts:i,numTrianglesWithoutSkirts:a,leftSkirtIndex:C,rightSkirtIndex:M,bottomSkirtIndex:H,topSkirtIndex:T}}}const M={};let H;const k={width:100,height:10};let N,P=!1;try{const e=new OffscreenCanvas(1,1);e.getContext("2d").fillText("hello",0,0),P=!0}catch(e){P=!1}function D(){if(!H){const{width:e,height:n}=k;P?H=new OffscreenCanvas(e,n):(H=document.createElement("canvas"),H.width=e,H.height=n)}return H}class R{constructor(e,n={}){if(!Array.isArray(e))return void console.error("colors is not array");if(e.length<2)return void console.error("colors.length should >1");this.colors=e;let t=1/0,r=-1/0;for(let n=0,o=e.length;n<o;n++){const o=e[n][0];t=Math.min(o,t),r=Math.max(o,r)}this.min=t,this.max=r,this.valueOffset=this.max-this.min,this.options=Object.assign({},k,n),this.T()}getImageData(){return this.imgData}T(){const e=D(),{width:n,height:t}=this.options;e.width=n,e.height=t;const r=e.getContext("2d");r.clearRect(0,0,e.width,e.height);const o=r.createLinearGradient(0,0,e.width,0),{colors:i,valueOffset:a}=this;for(let e=0,n=i.length;e<n;e++){const[n,t]=i[e],r=(n-this.min)/a;o.addColorStop(r,t)}r.fillStyle=o,r.fillRect(0,0,e.width,e.height),this.imgData=r.getImageData(0,0,e.width,e.height)}getColor(e){e=Math.max(this.min,e);const n=((e=Math.min(e,this.max))-this.min)/this.valueOffset;let t=Math.round(n*this.imgData.width);t=Math.min(t,this.imgData.width-1);const r=4*t;return[this.imgData.data[r],this.imgData.data[r+1],this.imgData.data[r+2],this.imgData.data[r+3]]}}let U=null,L=null;const F=[0,0,0],z=[256,256];function W(){try{U||(U=new OffscreenCanvas(1,1))}catch(e){console.error(e)}}const G={},V={},j={width:64,height:64,elementsPerHeight:3,heightOffset:-1e3,exaggeration:1,heightScale:.001,elementMultiplier:256,stride:4,skirtHeight:.002,skirtOffset:.01},X={cesium_request_token:{Accept:"application/json,*/*;q=0.01","Accept-Encoding":"gzip, deflate, br"},tianditu:{"Accept-Encoding":"gzip, deflate, br"},cesium:{"Accept-Encoding":"gzip, deflate, br",Accept:"application/vnd.quantized-mesh,application/octet-stream;q=0.9,*/*;q=0.01"},mapbox:{Accept:"image/webp,*/*"}};X["cesium-ion"]=X.cesium;const K=32767;let B=null,q=null;function Z(e,n){const t=function(e){if(e.length<1e3)return null;const n=new Zlib.Inflate(e);return n?n.decompress():null}(new Uint8Array(e));if(!t)throw new Error((r=new Uint8Array(e),Y.decode(r)));var r;const o=function(e){const n=e,t=j.width,r=j.height,o=new Uint8Array(t*r*j.stride);let i,a,s,c,f;for(let e=0;e<r;e++)for(let l=0;l<t;l++){c=parseInt(149*e/(r-1)),f=parseInt(149*l/(t-1)),a=2*(150*c+f),i=n[a]+256*n[a+1],(i>1e4||i<-2e3)&&(i=0),s=4*(e*t+l);const h=(i+1e3)/j.heightScale,d=j.elementMultiplier;o[s]=h/(d*d),o[s+1]=(h-o[s]*d*d)/d,o[s+2]=h-o[s]*d*d-o[s+1]*d,o[s+3]=255}return o}(t),i=function(e,n){const t=n,r=n,o=t+1,i=r+1,a=j.elementsPerHeight,s=j.heightOffset,c=j.heightScale,f=j.elementMultiplier,l=j.skirtHeight,h=new Float32Array(o*i);let d=0,v=1/0,u=-1/0;for(let n=0;n<o;n++){const o=n>=r?r-1:n;for(let n=0;n<i;n++){let r=0;const i=o*(4*t)+4*(n>=t?t-1:n);for(let n=0;n<a;n++)r=r*f+e[i+n];r=1*(r*c+s),r-=l,h[d]=r,r<v&&(v=r),r>u&&(u=r),d++}}return{data:h,min:v,max:u}}(o,n-1);return i.width=i.height=n,i}const Y=new TextDecoder("utf-8");function J(e){return e>>1^-(1&e)}const $=[];function Q(e){let n=0;const t=3*Float64Array.BYTES_PER_ELEMENT,r=3*Uint16Array.BYTES_PER_ELEMENT;let o=Uint16Array.BYTES_PER_ELEMENT;const i=new DataView(e);n+=t;const a=i.getFloat32(n,!0);n+=Float32Array.BYTES_PER_ELEMENT;const s=i.getFloat32(n,!0);n+=Float32Array.BYTES_PER_ELEMENT,n+=t;const c=i.getFloat64(n,!0);n+=Float64Array.BYTES_PER_ELEMENT,n+=t;const f=i.getUint32(n,!0);n+=Uint32Array.BYTES_PER_ELEMENT;const l=new Uint16Array(e,n,3*f);n+=f*r,f>65536&&(o=Uint32Array.BYTES_PER_ELEMENT);!function(e,n,t){const r=e.length;let o=0,i=0,a=0;for(let s=0;s<r;++s)o+=J(e[s]),i+=J(n[s]),e[s]=o,n[s]=i,t&&(a+=J(t[s]),t[s]=a)}(l.subarray(0,f),l.subarray(f,2*f),l.subarray(2*f,3*f)),n%o!=0&&(n+=o-n%o);const h=i.getUint32(n,!0);n+=Uint32Array.BYTES_PER_ELEMENT;const d=f>65536?new Uint32Array(e,n,3*h):new Uint16Array(e,n,3*h);let v=0;const u=d.length;for(let e=0;e<u;++e){const n=d[e];d[e]=v-n,0===n&&++v}const _={minimumHeight:a,maximumHeight:s,quantizedVertices:l,indices:d}.quantizedVertices,m=_.length/3,g=_.subarray(0,m),x=_.subarray(m,2*m),p=_.subarray(2*m,3*m),A=$;for(let e=0;e<m;++e){const n=g[e],t=x[e],r=n/K,o=t/K,i=(y=a,b=s,(1-(w=p[e]/K))*y+w*b);A[3*e]=r,A[3*e+1]=1-o,A[3*e+2]=i}var y,b,w;return{positions:A,radius:c,min:a,max:s,indices:d}}const ee=[],ne=[],te=[],re=[],oe=[];class ie{constructor(e,n,t,r,o){this.p0=[],this.p1=[],this.p2=[],this.normal=[],this.min=[],this.max=[],this.set(e,n,t,r,o)}set(e,n,t,r,o){this.radius=o;let i=3*n,a=3*n+1,s=3*n+2;this.p0[0]=e[i]*o,this.p0[1]=e[a]*o,this.p0[2]=e[s],i=3*t,a=3*t+1,s=3*t+2,this.p1[0]=e[i]*o,this.p1[1]=e[a]*o,this.p1[2]=e[s],i=3*r,a=3*r+1,s=3*r+2,this.p2[0]=e[i]*o,this.p2[1]=e[a]*o,this.p2[2]=e[s],this.min[0]=Math.min(this.p0[0],this.p1[0],this.p2[0]),this.min[1]=Math.min(this.p0[1],this.p1[1],this.p2[1]),this.max[0]=Math.max(this.p0[0],this.p1[0],this.p2[0]),this.max[1]=Math.max(this.p0[1],this.p1[1],this.p2[1]);const c=_(ee,this.p1,this.p0),f=_(ne,this.p2,this.p1);this.normal=v(this.normal,u(this.normal,c,f))}contains(e,n){if(e<this.min[0]||e>this.max[0]||n<this.min[1]||n>this.max[1])return!1;x(te,this.p0[0],this.p0[1]),x(re,this.p1[0],this.p1[1]),x(oe,this.p2[0],this.p2[1]);const t=fe(te[0],te[1],re[0],re[1],oe[0],oe[1]);return fe(e,n,te[0],te[1],oe[0],oe[1])+fe(e,n,te[0],te[1],re[0],re[1])+fe(e,n,re[0],re[1],oe[0],oe[1])-t<=1e-4}getHeight(e,n){const t=this.normal;return this.p0[2]-((e-this.p0[0])*t[0]+(n-this.p0[1])*t[1])/t[2]}}let ae=null;function se(e,n,t){if(ae&&ae.contains(n,t))return ae.getHeight(n,t);for(let r=0;r<e.length;r++)if(e[r].contains(n,t))return ae=e[r],e[r].getHeight(n,t);return 0}const ce=[];function fe(e,n,t,r,o,i){return.5*Math.abs(e*r+t*i+o*n-e*i-t*n-o*r)}function le(e,n,t,r,o,i){"cesium-ion"===t&&(n.Authorization="Bearer "+B),function(e,n,t){const r={method:"GET",referrer:t,headers:n},o=c.getArrayBuffer(e,r),i=o.xhr;return V[e]=i,o.then((n=>(delete V[e],n)))}(e,n,origin).then((e=>{if(!e||e.message)i(e?{empty:!0,originalError:e}:{error:{canceled:!0}});else{const n=e.data;let a=null;if("tianditu"===t){const e=Z(n,r);de(o,e,r,null,!0,i)}else if("cesium-ion"===t||"cesium"===t){a=Q(n);const e=function(e,n){const{positions:t,min:r,max:o,indices:i,radius:a}=e,s=[];let c=0;for(let e=0;e<i.length;e+=3){let n=ce[c];n?n.set(t,i[e],i[e+1],i[e+2],2*a):n=ce[c]=new ie(t,i[e],i[e+1],i[e+2],2*a),c++,s.push(n)}const f=new Float32Array(n*n);c=0;for(let e=0;e<n;e++)for(let t=0;t<n;t++)f[c++]=se(s,t/n*a*2,e/n*a*2);return{data:f,min:r,max:o,width:n,height:n}}(a,r);de(o,e,r,null,!0,i)}else"mapbox"===t&&(a=function(e){const n=new self.Blob([new Uint8Array(e)]);return self.createImageBitmap(n)}(n),a.then((e=>{const n=ue(ve(e),r);de(o,n,r,e,!0,i)})))}})).catch((n=>{delete V[e],i({empty:!0,originalError:n})}))}function he(e,n){const t=Math.floor(10*(e+1e4)),r=t>>16,o=t>>8&255,i=255&t;return n?(n[0]=r,n[1]=o,n[2]=i,n):[r,o,i]}function de(e,n,t,r,o,i){const a=function(e,n,t){let r=M[t];r||(r=M[t]=new S(t));const o=r.createTile(n).getMeshWithSkirts(e,!0),{triangles:i,vertices:a,leftSkirtIndex:s,rightSkirtIndex:c,bottomSkirtIndex:f,topSkirtIndex:l}=o;let{numVerticesWithoutSkirts:h,numTrianglesWithoutSkirts:d}=o;h||(h=a.length/2,d=i.length/3);const v=a.length/2,u=new Float32Array(3*v),_=new Float32Array(2*v);let m=1/0,g=-1/0;const x=t-1;for(let e=0;e<v;e++){const r=a[2*e],o=a[2*e+1];if(e>=h){const n=r/2*3;let t,o=.001;(e-(e<s/2?h:e<c/2?s/2:e<f/2?c/2:f/2))%3==0?(t=Math.min(0,m),o=0):t=u[n+2],u[3*e]=u[n],u[3*e+1]=u[n+1],u[3*e+2]=t,_[2*e]=u[n]/x+o,_[2*e+1]=-u[n+1]/x+o}else{const i=n[o*t+r];u[3*e]=1*r,u[3*e+1]=1*-o,u[3*e+2]=i,_[2*e]=r/x,_[2*e+1]=o/x,i<m&&(m=i),i>g&&(g=i)}}return{positions:u,texcoords:_,triangles:i,leftSkirtIndex:s,rightSkirtIndex:c,bottomSkirtIndex:f,topSkirtIndex:l,numTrianglesWithoutSkirts:d,numVerticesWithoutSkirts:h,minHeight:Math.min(0,m),maxHeight:g,terrainWidth:t}}(e/2,n.data,t),s=[a.positions.buffer,a.texcoords.buffer,a.triangles.buffer];r||(r=function(e){if(W(),!U)return;const{width:n,height:t,data:r}=e;if(n&&t&&r)try{let e=U.getContext("2d",{willReadFrequently:!0});const o=e.createImageData(n,t);for(let e=0,n=r.length;e<n;e++){const n=r[e],[t,i,a]=he(n,F),s=4*e;o.data[s]=t,o.data[s+1]=i,o.data[s+2]=a,o.data[s+3]=255}return U.width=n,U.height=t,e=U.getContext("2d",{willReadFrequently:!0}),_e(e),e.putImageData(o,0,0),U.transferToImageBitmap()}catch(e){console.log(e)}}(n)),r&&s.push(r);const c={mesh:a};c.image=r,c.data=n,s.push(n.data.buffer),i(c,s)}function ve(e){const{width:n,height:t}=e;return U||(U=new OffscreenCanvas(1,1),L=U.getContext("2d",{willReadFrequently:!0})),U.width=n,U.height=t,L.drawImage(e,0,0,n,t),L.getImageData(0,0,n,t)}function ue(e,n){const{data:t,width:r}=e;let o=1/0,i=-1/0;const a=new Float32Array(n*n),s=Math.round(r/n);for(let e=0;e<n;e++)for(let c=0;c<n;c++){const f=e+c*n;let l=0,h=0;const d=e,v=c;for(let e=0;e<s;e++)for(let n=0;n<s;n++){let o=d*s+e,i=v*s+n;i>r-1&&(i=r-1),o>r-1&&(o=r-1);const a=o+i*r,c=t[4*a],f=t[4*a+1],u=t[4*a+2];0===t[4*a+3]?h+=1:l+=.1*(256*c*256+256*f+u)-1e4}l/=s*s-h||1,l>i&&(i=l),l<o&&(o=l),a[f]=l}return{data:a,width:n,height:n,min:o,max:i}}function _e(e){const n=e.canvas,{width:t,height:r}=n;e.clearRect(0,0,t,r)}function me(e,n,t){if(!n||!Array.isArray(n)||n.length<2)return;if(!e||!e.image)return null;let{width:r,height:o}=e.image;(t=t||z)[0]===r&&t[1]===o||(r=t[0],o=t[1]),r*=2,o*=2;try{if(W(),!U)return;const t=U;t.width=r,t.height=o;const i=t.getContext("2d",{willReadFrequently:!0});_e(i),i.drawImage(e.image,0,0,r,o);const a=i.getImageData(0,0,r,o);return function(e,n){const t=JSON.stringify(n);G[t]||(G[t]=new R(n));const r=G[t],o=e.data;for(let e=0,n=o.length;e<n;e+=4){const n=o[e],t=o[e+1],i=o[e+2];let a=0;0!==o[e+3]&&(a=.1*(256*n*256+256*t+i)-1e4,a=Math.max(a,0));const[s,c,f]=r.getColor(a);o[e]=s,o[e+1]=c,o[e+2]=f,o[e+3]=255}}(a,n),new Uint8Array(a.data)}catch(e){console.error(e)}}e.initialize=function(){},e.onmessage=function(e,n){const t=e.data;if("addLayer"===t.command||"removeLayer"===t.command)N=e.workerId,self.postMessage({type:"<response>",actorId:t.actorId,workerId:N,params:"ok",callback:e.callback});else if("fetchTerrain"===t.command){const e=(t.params||{}).colors,r=(t.params||{}).tileSize;!function(e,n){const{url:t,origin:r,type:o,accessToken:i,terrainWidth:a,error:s,tileImage:c}=e;if(c&&c.close){const e=ue(ve(c),a);return void de(s,e,a,c,0,n)}const f=e.headers||X[o];if("tianditu"===o)le(t,f,o,a,s,n);else if("cesium-ion"===o){const c=e.cesiumIonTokenURL+i;B?le(t,f,o,a,s,n):(q||(q=fetch(c,{responseType:"json",method:"GET",referrer:r,headers:{Accept:"application/json,*/*;q=0.01","Accept-Encoding":"gzip, deflate, br"}}).then((e=>e.json())).then((e=>{B=e.accessToken,q=null}))),q.then((()=>{le(t,f,o,a,s,n)})))}else("cesium"===o||"mapbox"===o)&&le(t,f,o,a,s,n)}(t.params,((t,o)=>{const i=me(t,e,r);i&&(t.colorsTexture=i,(o=o||[]).push(i.buffer)),n(t.error,t,o)}))}else"abortTerrain"===t.command&&(r=t.params.url,V[r]&&(V[r].abort(),delete V[r]));var r}}`;!function(t){BC().ispace_gltf_loader_bundle=t}(jC),va("@ispace/terrain",hE),"undefined"!=typeof console&&console.log("@ispace/gl v0.108.4");var cE={exports:{}},uE={exports:{}},fE=function(t){return!(!t||"string"==typeof t)&&(t instanceof Array||Array.isArray(t)||t.length>=0&&(t.splice instanceof Function||Object.getOwnPropertyDescriptor(t,t.length-1)&&"String"!==t.constructor.name))},dE=Array.prototype.concat,gE=Array.prototype.slice,pE=uE.exports=function(t){for(var e=[],n=0,i=t.length;n<i;n++){var o=t[n];fE(o)?e=dE.call(e,gE.call(o)):e.push(o)}return e};pE.wrap=function(t){return function(){return t(pE(arguments))}};var AE={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},mE=uE.exports,yE=Object.hasOwnProperty,_E=Object.create(null);for(var vE in AE)yE.call(AE,vE)&&(_E[AE[vE]]=vE);var xE=cE.exports={to:{},get:{}};function bE(t,e,n){return Math.min(Math.max(e,t),n)}function wE(t){var e=Math.round(t).toString(16).toUpperCase();return e.length<2?"0"+e:e}xE.get=function(t){var e,n;switch(t.substring(0,3).toLowerCase()){case"hsl":e=xE.get.hsl(t),n="hsl";break;case"hwb":e=xE.get.hwb(t),n="hwb";break;default:e=xE.get.rgb(t),n="rgb"}return e?{model:n,value:e}:null},xE.get.rgb=function(t){if(!t)return null;var e,n,i,o=[0,0,0,1];if(e=t.match(/^#([a-f0-9]{6})([a-f0-9]{2})?$/i)){for(i=e[2],e=e[1],n=0;n<3;n++){var s=2*n;o[n]=parseInt(e.slice(s,s+2),16)}i&&(o[3]=parseInt(i,16)/255)}else if(e=t.match(/^#([a-f0-9]{3,4})$/i)){for(i=(e=e[1])[3],n=0;n<3;n++)o[n]=parseInt(e[n]+e[n],16);i&&(o[3]=parseInt(i+i,16)/255)}else if(e=t.match(/^rgba?\(\s*([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/)){for(n=0;n<3;n++)o[n]=parseInt(e[n+1],0);e[4]&&(o[3]=e[5]?.01*parseFloat(e[4]):parseFloat(e[4]))}else{if(!(e=t.match(/^rgba?\(\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/)))return(e=t.match(/^(\w+)$/))?"transparent"===e[1]?[0,0,0,0]:yE.call(AE,e[1])?((o=AE[e[1]])[3]=1,o):null:null;for(n=0;n<3;n++)o[n]=Math.round(2.55*parseFloat(e[n+1]));e[4]&&(o[3]=e[5]?.01*parseFloat(e[4]):parseFloat(e[4]))}for(n=0;n<3;n++)o[n]=bE(o[n],0,255);return o[3]=bE(o[3],0,1),o},xE.get.hsl=function(t){if(!t)return null;var e=t.match(/^hsla?\(\s*([+-]?(?:\d{0,3}\.)?\d+)(?:deg)?\s*,?\s*([+-]?[\d\.]+)%\s*,?\s*([+-]?[\d\.]+)%\s*(?:[,|\/]\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/);if(e){var n=parseFloat(e[4]);return[(parseFloat(e[1])%360+360)%360,bE(parseFloat(e[2]),0,100),bE(parseFloat(e[3]),0,100),bE(isNaN(n)?1:n,0,1)]}return null},xE.get.hwb=function(t){if(!t)return null;var e=t.match(/^hwb\(\s*([+-]?\d{0,3}(?:\.\d+)?)(?:deg)?\s*,\s*([+-]?[\d\.]+)%\s*,\s*([+-]?[\d\.]+)%\s*(?:,\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/);if(e){var n=parseFloat(e[4]);return[(parseFloat(e[1])%360+360)%360,bE(parseFloat(e[2]),0,100),bE(parseFloat(e[3]),0,100),bE(isNaN(n)?1:n,0,1)]}return null},xE.to.hex=function(){var t=mE(arguments);return"#"+wE(t[0])+wE(t[1])+wE(t[2])+(t[3]<1?wE(Math.round(255*t[3])):"")},xE.to.rgb=function(){var t=mE(arguments);return t.length<4||1===t[3]?"rgb("+Math.round(t[0])+", "+Math.round(t[1])+", "+Math.round(t[2])+")":"rgba("+Math.round(t[0])+", "+Math.round(t[1])+", "+Math.round(t[2])+", "+t[3]+")"},xE.to.rgb.percent=function(){var t=mE(arguments),e=Math.round(t[0]/255*100),n=Math.round(t[1]/255*100),i=Math.round(t[2]/255*100);return t.length<4||1===t[3]?"rgb("+e+"%, "+n+"%, "+i+"%)":"rgba("+e+"%, "+n+"%, "+i+"%, "+t[3]+")"},xE.to.hsl=function(){var t=mE(arguments);return t.length<4||1===t[3]?"hsl("+t[0]+", "+t[1]+"%, "+t[2]+"%)":"hsla("+t[0]+", "+t[1]+"%, "+t[2]+"%, "+t[3]+")"},xE.to.hwb=function(){var t=mE(arguments),e="";return t.length>=4&&1!==t[3]&&(e=", "+t[3]),"hwb("+t[0]+", "+t[1]+"%, "+t[2]+"%"+e+")"},xE.to.keyword=function(t){return _E[t.slice(0,3)]};var TE=cE.exports,ME={exports:{}},CE={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},SE={};for(var PE in CE)CE.hasOwnProperty(PE)&&(SE[CE[PE]]=PE);var IE=ME.exports={rgb:{channels:3,labels:"rgb"},hsl:{channels:3,labels:"hsl"},hsv:{channels:3,labels:"hsv"},hwb:{channels:3,labels:"hwb"},cmyk:{channels:4,labels:"cmyk"},xyz:{channels:3,labels:"xyz"},lab:{channels:3,labels:"lab"},lch:{channels:3,labels:"lch"},hex:{channels:1,labels:["hex"]},keyword:{channels:1,labels:["keyword"]},ansi16:{channels:1,labels:["ansi16"]},ansi256:{channels:1,labels:["ansi256"]},hcg:{channels:3,labels:["h","c","g"]},apple:{channels:3,labels:["r16","g16","b16"]},gray:{channels:1,labels:["gray"]}};for(var OE in IE)if(IE.hasOwnProperty(OE)){if(!("channels"in IE[OE]))throw new Error("missing channels property: "+OE);if(!("labels"in IE[OE]))throw new Error("missing channel labels property: "+OE);if(IE[OE].labels.length!==IE[OE].channels)throw new Error("channel and label counts mismatch: "+OE);var EE=IE[OE].channels,kE=IE[OE].labels;delete IE[OE].channels,delete IE[OE].labels,Object.defineProperty(IE[OE],"channels",{value:EE}),Object.defineProperty(IE[OE],"labels",{value:kE})}function RE(t,e){return Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2)+Math.pow(t[2]-e[2],2)}IE.rgb.hsl=function(t){var e,n,i=t[0]/255,o=t[1]/255,s=t[2]/255,a=Math.min(i,o,s),l=Math.max(i,o,s),h=l-a;return l===a?e=0:i===l?e=(o-s)/h:o===l?e=2+(s-i)/h:s===l&&(e=4+(i-o)/h),(e=Math.min(60*e,360))<0&&(e+=360),n=(a+l)/2,[e,100*(l===a?0:n<=.5?h/(l+a):h/(2-l-a)),100*n]},IE.rgb.hsv=function(t){var e,n,i,o,s,a=t[0]/255,l=t[1]/255,h=t[2]/255,c=Math.max(a,l,h),u=c-Math.min(a,l,h),f=function(t){return(c-t)/6/u+.5};return 0===u?o=s=0:(s=u/c,e=f(a),n=f(l),i=f(h),a===c?o=i-n:l===c?o=1/3+e-i:h===c&&(o=2/3+n-e),o<0?o+=1:o>1&&(o-=1)),[360*o,100*s,100*c]},IE.rgb.hwb=function(t){var e=t[0],n=t[1],i=t[2];return[IE.rgb.hsl(t)[0],100*(1/255*Math.min(e,Math.min(n,i))),100*(i=1-1/255*Math.max(e,Math.max(n,i)))]},IE.rgb.cmyk=function(t){var e,n=t[0]/255,i=t[1]/255,o=t[2]/255;return[100*((1-n-(e=Math.min(1-n,1-i,1-o)))/(1-e)||0),100*((1-i-e)/(1-e)||0),100*((1-o-e)/(1-e)||0),100*e]},IE.rgb.keyword=function(t){var e=SE[t];if(e)return e;var n,i=1/0;for(var o in CE)if(CE.hasOwnProperty(o)){var s=RE(t,CE[o]);s<i&&(i=s,n=o)}return n},IE.keyword.rgb=function(t){return CE[t]},IE.rgb.xyz=function(t){var e=t[0]/255,n=t[1]/255,i=t[2]/255;return[100*(.4124*(e=e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92)+.3576*(n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92)+.1805*(i=i>.04045?Math.pow((i+.055)/1.055,2.4):i/12.92)),100*(.2126*e+.7152*n+.0722*i),100*(.0193*e+.1192*n+.9505*i)]},IE.rgb.lab=function(t){var e=IE.rgb.xyz(t),n=e[0],i=e[1],o=e[2];return i/=100,o/=108.883,n=(n/=95.047)>.008856?Math.pow(n,1/3):7.787*n+16/116,[116*(i=i>.008856?Math.pow(i,1/3):7.787*i+16/116)-16,500*(n-i),200*(i-(o=o>.008856?Math.pow(o,1/3):7.787*o+16/116))]},IE.hsl.rgb=function(t){var e,n,i,o,s,a=t[0]/360,l=t[1]/100,h=t[2]/100;if(0===l)return[s=255*h,s,s];e=2*h-(n=h<.5?h*(1+l):h+l-h*l),o=[0,0,0];for(var c=0;c<3;c++)(i=a+1/3*-(c-1))<0&&i++,i>1&&i--,o[c]=255*(s=6*i<1?e+6*(n-e)*i:2*i<1?n:3*i<2?e+(n-e)*(2/3-i)*6:e);return o},IE.hsl.hsv=function(t){var e=t[0],n=t[1]/100,i=t[2]/100,o=n,s=Math.max(i,.01);return n*=(i*=2)<=1?i:2-i,o*=s<=1?s:2-s,[e,100*(0===i?2*o/(s+o):2*n/(i+n)),100*((i+n)/2)]},IE.hsv.rgb=function(t){var e=t[0]/60,n=t[1]/100,i=t[2]/100,o=Math.floor(e)%6,s=e-Math.floor(e),a=255*i*(1-n),l=255*i*(1-n*s),h=255*i*(1-n*(1-s));switch(i*=255,o){case 0:return[i,h,a];case 1:return[l,i,a];case 2:return[a,i,h];case 3:return[a,l,i];case 4:return[h,a,i];case 5:return[i,a,l]}},IE.hsv.hsl=function(t){var e,n,i,o=t[0],s=t[1]/100,a=t[2]/100,l=Math.max(a,.01);return i=(2-s)*a,n=s*l,[o,100*(n=(n/=(e=(2-s)*l)<=1?e:2-e)||0),100*(i/=2)]},IE.hwb.rgb=function(t){var e,n,i,o,s,a,l,h=t[0]/360,c=t[1]/100,u=t[2]/100,f=c+u;switch(f>1&&(c/=f,u/=f),i=6*h-(e=Math.floor(6*h)),1&e&&(i=1-i),o=c+i*((n=1-u)-c),e){default:case 6:case 0:s=n,a=o,l=c;break;case 1:s=o,a=n,l=c;break;case 2:s=c,a=n,l=o;break;case 3:s=c,a=o,l=n;break;case 4:s=o,a=c,l=n;break;case 5:s=n,a=c,l=o}return[255*s,255*a,255*l]},IE.cmyk.rgb=function(t){var e=t[1]/100,n=t[2]/100,i=t[3]/100;return[255*(1-Math.min(1,t[0]/100*(1-i)+i)),255*(1-Math.min(1,e*(1-i)+i)),255*(1-Math.min(1,n*(1-i)+i))]},IE.xyz.rgb=function(t){var e,n,i,o=t[0]/100,s=t[1]/100,a=t[2]/100;return n=-.9689*o+1.8758*s+.0415*a,i=.0557*o+-.204*s+1.057*a,e=(e=3.2406*o+-1.5372*s+-.4986*a)>.0031308?1.055*Math.pow(e,1/2.4)-.055:12.92*e,n=n>.0031308?1.055*Math.pow(n,1/2.4)-.055:12.92*n,i=i>.0031308?1.055*Math.pow(i,1/2.4)-.055:12.92*i,[255*(e=Math.min(Math.max(0,e),1)),255*(n=Math.min(Math.max(0,n),1)),255*(i=Math.min(Math.max(0,i),1))]},IE.xyz.lab=function(t){var e=t[0],n=t[1],i=t[2];return n/=100,i/=108.883,e=(e/=95.047)>.008856?Math.pow(e,1/3):7.787*e+16/116,[116*(n=n>.008856?Math.pow(n,1/3):7.787*n+16/116)-16,500*(e-n),200*(n-(i=i>.008856?Math.pow(i,1/3):7.787*i+16/116))]},IE.lab.xyz=function(t){var e,n,i;e=t[1]/500+(n=(t[0]+16)/116),i=n-t[2]/200;var o=Math.pow(n,3),s=Math.pow(e,3),a=Math.pow(i,3);return n=o>.008856?o:(n-16/116)/7.787,e=s>.008856?s:(e-16/116)/7.787,i=a>.008856?a:(i-16/116)/7.787,[e*=95.047,n*=100,i*=108.883]},IE.lab.lch=function(t){var e,n=t[0],i=t[1],o=t[2];return(e=360*Math.atan2(o,i)/2/Math.PI)<0&&(e+=360),[n,Math.sqrt(i*i+o*o),e]},IE.lch.lab=function(t){var e,n=t[1];return e=t[2]/360*2*Math.PI,[t[0],n*Math.cos(e),n*Math.sin(e)]},IE.rgb.ansi16=function(t){var e=t[0],n=t[1],i=t[2],o=1 in arguments?arguments[1]:IE.rgb.hsv(t)[2];if(0===(o=Math.round(o/50)))return 30;var s=30+(Math.round(i/255)<<2|Math.round(n/255)<<1|Math.round(e/255));return 2===o&&(s+=60),s},IE.hsv.ansi16=function(t){return IE.rgb.ansi16(IE.hsv.rgb(t),t[2])},IE.rgb.ansi256=function(t){var e=t[0],n=t[1],i=t[2];return e===n&&n===i?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(n/255*5)+Math.round(i/255*5)},IE.ansi16.rgb=function(t){var e=t%10;if(0===e||7===e)return t>50&&(e+=3.5),[e=e/10.5*255,e,e];var n=.5*(1+~~(t>50));return[(1&e)*n*255,(e>>1&1)*n*255,(e>>2&1)*n*255]},IE.ansi256.rgb=function(t){if(t>=232){var e=10*(t-232)+8;return[e,e,e]}var n;return t-=16,[Math.floor(t/36)/5*255,Math.floor((n=t%36)/6)/5*255,n%6/5*255]},IE.rgb.hex=function(t){var e=(((255&Math.round(t[0]))<<16)+((255&Math.round(t[1]))<<8)+(255&Math.round(t[2]))).toString(16).toUpperCase();return"000000".substring(e.length)+e},IE.hex.rgb=function(t){var e=t.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);if(!e)return[0,0,0];var n=e[0];3===e[0].length&&(n=n.split("").map((function(t){return t+t})).join(""));var i=parseInt(n,16);return[i>>16&255,i>>8&255,255&i]},IE.rgb.hcg=function(t){var e,n=t[0]/255,i=t[1]/255,o=t[2]/255,s=Math.max(Math.max(n,i),o),a=Math.min(Math.min(n,i),o),l=s-a;return e=l<=0?0:s===n?(i-o)/l%6:s===i?2+(o-n)/l:4+(n-i)/l+4,e/=6,[360*(e%=1),100*l,100*(l<1?a/(1-l):0)]},IE.hsl.hcg=function(t){var e=t[1]/100,n=t[2]/100,i=1,o=0;return(i=n<.5?2*e*n:2*e*(1-n))<1&&(o=(n-.5*i)/(1-i)),[t[0],100*i,100*o]},IE.hsv.hcg=function(t){var e=t[2]/100,n=t[1]/100*e,i=0;return n<1&&(i=(e-n)/(1-n)),[t[0],100*n,100*i]},IE.hcg.rgb=function(t){var e=t[1]/100,n=t[2]/100;if(0===e)return[255*n,255*n,255*n];var i,o=[0,0,0],s=t[0]/360%1*6,a=s%1,l=1-a;switch(Math.floor(s)){case 0:o[0]=1,o[1]=a,o[2]=0;break;case 1:o[0]=l,o[1]=1,o[2]=0;break;case 2:o[0]=0,o[1]=1,o[2]=a;break;case 3:o[0]=0,o[1]=l,o[2]=1;break;case 4:o[0]=a,o[1]=0,o[2]=1;break;default:o[0]=1,o[1]=0,o[2]=l}return[255*(e*o[0]+(i=(1-e)*n)),255*(e*o[1]+i),255*(e*o[2]+i)]},IE.hcg.hsv=function(t){var e=t[1]/100,n=e+t[2]/100*(1-e),i=0;return n>0&&(i=e/n),[t[0],100*i,100*n]},IE.hcg.hsl=function(t){var e=t[1]/100,n=t[2]/100*(1-e)+.5*e,i=0;return n>0&&n<.5?i=e/(2*n):n>=.5&&n<1&&(i=e/(2*(1-n))),[t[0],100*i,100*n]},IE.hcg.hwb=function(t){var e=t[1]/100,n=e+t[2]/100*(1-e);return[t[0],100*(n-e),100*(1-n)]},IE.hwb.hcg=function(t){var e=1-t[2]/100,n=e-t[1]/100,i=0;return n<1&&(i=(e-n)/(1-n)),[t[0],100*n,100*i]},IE.apple.rgb=function(t){return[t[0]/65535*255,t[1]/65535*255,t[2]/65535*255]},IE.rgb.apple=function(t){return[t[0]/255*65535,t[1]/255*65535,t[2]/255*65535]},IE.gray.rgb=function(t){return[t[0]/100*255,t[0]/100*255,t[0]/100*255]},IE.gray.hsl=IE.gray.hsv=function(t){return[0,0,t[0]]},IE.gray.hwb=function(t){return[0,100,t[0]]},IE.gray.cmyk=function(t){return[0,0,0,t[0]]},IE.gray.lab=function(t){return[t[0],0,0]},IE.gray.hex=function(t){var e=255&Math.round(t[0]/100*255),n=((e<<16)+(e<<8)+e).toString(16).toUpperCase();return"000000".substring(n.length)+n},IE.rgb.gray=function(t){return[(t[0]+t[1]+t[2])/3/255*100]};var LE=ME.exports,DE=LE;function FE(t){var e=function(){for(var t={},e=Object.keys(DE),n=e.length,i=0;i<n;i++)t[e[i]]={distance:-1,parent:null};return t}(),n=[t];for(e[t].distance=0;n.length;)for(var i=n.pop(),o=Object.keys(DE[i]),s=o.length,a=0;a<s;a++){var l=o[a],h=e[l];-1===h.distance&&(h.distance=e[i].distance+1,h.parent=i,n.unshift(l))}return e}function NE(t,e){return function(n){return e(t(n))}}function HE(t,e){for(var n=[e[t].parent,t],i=DE[e[t].parent][t],o=e[t].parent;e[o].parent;)n.unshift(e[o].parent),i=NE(DE[e[o].parent][o],i),o=e[o].parent;return i.conversion=n,i}var BE=LE,zE=function(t){for(var e=FE(t),n={},i=Object.keys(e),o=i.length,s=0;s<o;s++){var a=i[s];null!==e[a].parent&&(n[a]=HE(a,e))}return n},GE={};Object.keys(BE).forEach((function(t){GE[t]={},Object.defineProperty(GE[t],"channels",{value:BE[t].channels}),Object.defineProperty(GE[t],"labels",{value:BE[t].labels});var e=zE(t);Object.keys(e).forEach((function(n){var i=e[n];GE[t][n]=function(t){var e=function(e){if(null==e)return e;arguments.length>1&&(e=Array.prototype.slice.call(arguments));var n=t(e);if("object"==typeof n)for(var i=n.length,o=0;o<i;o++)n[o]=Math.round(n[o]);return n};return"conversion"in t&&(e.conversion=t.conversion),e}(i),GE[t][n].raw=function(t){var e=function(e){return null==e?e:(arguments.length>1&&(e=Array.prototype.slice.call(arguments)),t(e))};return"conversion"in t&&(e.conversion=t.conversion),e}(i)}))}));var jE=TE,UE=GE,VE=[].slice,WE=["keyword","gray","hex"],ZE={};Object.keys(UE).forEach((function(t){ZE[VE.call(UE[t].labels).sort().join("")]=t}));var qE={};function XE(t,e){if(!(this instanceof XE))return new XE(t,e);if(e&&e in WE&&(e=null),e&&!(e in UE))throw new Error("Unknown model: "+e);var n,i;if(null==t)this.model="rgb",this.color=[0,0,0],this.valpha=1;else if(t instanceof XE)this.model=t.model,this.color=t.color.slice(),this.valpha=t.valpha;else if("string"==typeof t){var o=jE.get(t);if(null===o)throw new Error("Unable to parse color from string: "+t);this.model=o.model,this.color=o.value.slice(0,i=UE[this.model].channels),this.valpha="number"==typeof o.value[i]?o.value[i]:1}else if(t.length){this.model=e||"rgb";var s=VE.call(t,0,i=UE[this.model].channels);this.color=YE(s,i),this.valpha="number"==typeof t[i]?t[i]:1}else if("number"==typeof t)t&=16777215,this.model="rgb",this.color=[t>>16&255,t>>8&255,255&t],this.valpha=1;else{this.valpha=1;var a=Object.keys(t);"alpha"in t&&(a.splice(a.indexOf("alpha"),1),this.valpha="number"==typeof t.alpha?t.alpha:0);var l=a.sort().join("");if(!(l in ZE))throw new Error("Unable to parse color from object: "+JSON.stringify(t));this.model=ZE[l];var h=UE[this.model].labels,c=[];for(n=0;n<h.length;n++)c.push(t[h[n]]);this.color=YE(c)}if(qE[this.model])for(i=UE[this.model].channels,n=0;n<i;n++){var u=qE[this.model][n];u&&(this.color[n]=u(this.color[n]))}this.valpha=Math.max(0,Math.min(1,this.valpha)),Object.freeze&&Object.freeze(this)}function JE(t,e,n){return(t=Array.isArray(t)?t:[t]).forEach((function(t){(qE[t]||(qE[t]=[]))[e]=n})),t=t[0],function(i){var o;return arguments.length?(n&&(i=n(i)),(o=this[t]()).color[e]=i,o):(o=this[t]().color[e],n&&(o=n(o)),o)}}function QE(t){return function(e){return Math.max(0,Math.min(t,e))}}function YE(t,e){for(var n=0;n<e;n++)"number"!=typeof t[n]&&(t[n]=0);return t}XE.prototype={toString:function(){return this.string()},toJSON:function(){return this[this.model]()},string:function(t){var e=this.model in jE.to?this:this.rgb(),n=1===(e=e.round("number"==typeof t?t:1)).valpha?e.color:e.color.concat(this.valpha);return jE.to[e.model](n)},percentString:function(t){var e=this.rgb().round("number"==typeof t?t:1),n=1===e.valpha?e.color:e.color.concat(this.valpha);return jE.to.rgb.percent(n)},array:function(){return 1===this.valpha?this.color.slice():this.color.concat(this.valpha)},object:function(){for(var t={},e=UE[this.model].channels,n=UE[this.model].labels,i=0;i<e;i++)t[n[i]]=this.color[i];return 1!==this.valpha&&(t.alpha=this.valpha),t},unitArray:function(){var t=this.rgb().color;return t[0]/=255,t[1]/=255,t[2]/=255,1!==this.valpha&&t.push(this.valpha),t},unitObject:function(){var t=this.rgb().object();return t.r/=255,t.g/=255,t.b/=255,1!==this.valpha&&(t.alpha=this.valpha),t},round:function(t){return t=Math.max(t||0,0),new XE(this.color.map(function(t){return function(e){return function(t,e){return Number(t.toFixed(e))}(e,t)}}(t)).concat(this.valpha),this.model)},alpha:function(t){return arguments.length?new XE(this.color.concat(Math.max(0,Math.min(1,t))),this.model):this.valpha},red:JE("rgb",0,QE(255)),green:JE("rgb",1,QE(255)),blue:JE("rgb",2,QE(255)),hue:JE(["hsl","hsv","hsl","hwb","hcg"],0,(function(t){return(t%360+360)%360})),saturationl:JE("hsl",1,QE(100)),lightness:JE("hsl",2,QE(100)),saturationv:JE("hsv",1,QE(100)),value:JE("hsv",2,QE(100)),chroma:JE("hcg",1,QE(100)),gray:JE("hcg",2,QE(100)),white:JE("hwb",1,QE(100)),wblack:JE("hwb",2,QE(100)),cyan:JE("cmyk",0,QE(100)),magenta:JE("cmyk",1,QE(100)),yellow:JE("cmyk",2,QE(100)),black:JE("cmyk",3,QE(100)),x:JE("xyz",0,QE(100)),y:JE("xyz",1,QE(100)),z:JE("xyz",2,QE(100)),l:JE("lab",0,QE(100)),a:JE("lab",1),b:JE("lab",2),keyword:function(t){return arguments.length?new XE(t):UE[this.model].keyword(this.color)},hex:function(t){return arguments.length?new XE(t):jE.to.hex(this.rgb().round().color)},rgbNumber:function(){var t=this.rgb().color;return(255&t[0])<<16|(255&t[1])<<8|255&t[2]},luminosity:function(){for(var t=this.rgb().color,e=[],n=0;n<t.length;n++){var i=t[n]/255;e[n]=i<=.03928?i/12.92:Math.pow((i+.055)/1.055,2.4)}return.2126*e[0]+.7152*e[1]+.0722*e[2]},contrast:function(t){var e=this.luminosity(),n=t.luminosity();return e>n?(e+.05)/(n+.05):(n+.05)/(e+.05)},level:function(t){var e=this.contrast(t);return e>=7.1?"AAA":e>=4.5?"AA":""},isDark:function(){var t=this.rgb().color;return(299*t[0]+587*t[1]+114*t[2])/1e3<128},isLight:function(){return!this.isDark()},negate:function(){for(var t=this.rgb(),e=0;e<3;e++)t.color[e]=255-t.color[e];return t},lighten:function(t){var e=this.hsl();return e.color[2]+=e.color[2]*t,e},darken:function(t){var e=this.hsl();return e.color[2]-=e.color[2]*t,e},saturate:function(t){var e=this.hsl();return e.color[1]+=e.color[1]*t,e},desaturate:function(t){var e=this.hsl();return e.color[1]-=e.color[1]*t,e},whiten:function(t){var e=this.hwb();return e.color[1]+=e.color[1]*t,e},blacken:function(t){var e=this.hwb();return e.color[2]+=e.color[2]*t,e},grayscale:function(){var t=this.rgb().color,e=.3*t[0]+.59*t[1]+.11*t[2];return XE.rgb(e,e,e)},fade:function(t){return this.alpha(this.valpha-this.valpha*t)},opaquer:function(t){return this.alpha(this.valpha+this.valpha*t)},rotate:function(t){var e=this.hsl(),n=e.color[0];return e.color[0]=n=(n=(n+t)%360)<0?360+n:n,e},mix:function(t,e){if(!t||!t.rgb)throw new Error('Argument to "mix" was not a Color instance, but rather an instance of '+typeof t);var n=t.rgb(),i=this.rgb(),o=void 0===e?.5:e,s=2*o-1,a=n.alpha()-i.alpha(),l=((s*a==-1?s:(s+a)/(1+s*a))+1)/2,h=1-l;return XE.rgb(l*n.red()+h*i.red(),l*n.green()+h*i.green(),l*n.blue()+h*i.blue(),n.alpha()*o+i.alpha()*(1-o))}},Object.keys(UE).forEach((function(t){if(-1===WE.indexOf(t)){var e=UE[t].channels;XE.prototype[t]=function(){if(this.model===t)return new XE(this);if(arguments.length)return new XE(arguments,t);var n,i="number"==typeof arguments[e]?e:this.valpha;return new XE((n=UE[this.model][t].raw(this.color),Array.isArray(n)?n:[n]).concat(i),t)},XE[t]=function(n){return"number"==typeof n&&(n=YE(VE.call(arguments),e)),new XE(n,t)}}}));var KE=km(XE);let $E;const tk={width:100,height:10};let ek=!1;try{const t=new OffscreenCanvas(1,1);t.getContext("2d").fillText("hello",0,0),ek=!0}catch(t){ek=!1}function nk(){if(!$E){const{width:t,height:e}=tk;ek?$E=new OffscreenCanvas(t,e):($E=document.createElement("canvas"),$E.width=t,$E.height=e)}return $E}class ColorIn{constructor(t,e={}){if(!Array.isArray(t))return void console.error("colors is not array");if(t.length<2)return void console.error("colors.length should >1");this.colors=t;let n=1/0,i=-1/0;for(let e=0,o=t.length;e<o;e++){const o=t[e][0];n=Math.min(o,n),i=Math.max(o,i)}this.min=n,this.max=i,this.valueOffset=this.max-this.min,this.options=Object.assign({},tk,e),this._initImgData()}getImageData(){return this.imgData}_initImgData(){const t=nk(),{width:e,height:n}=this.options;t.width=e,t.height=n;const i=t.getContext("2d");i.clearRect(0,0,t.width,t.height);const o=i.createLinearGradient(0,0,t.width,0),{colors:s,valueOffset:a}=this;for(let t=0,e=s.length;t<e;t++){const[e,n]=s[t];o.addColorStop((e-this.min)/a,n)}i.fillStyle=o,i.fillRect(0,0,t.width,t.height),this.imgData=i.getImageData(0,0,t.width,t.height)}getColor(t){t=Math.max(this.min,t),t=Math.min(t,this.max);let e=Math.round((t-this.min)/this.valueOffset*this.imgData.width);e=Math.min(e,this.imgData.width-1);const n=4*e;return[this.imgData.data[n],this.imgData.data[n+1],this.imgData.data[n+2],this.imgData.data[n+3]]}}var ik;function rk(t){return null==t}function ok(t){return!rk(t)}function sk(t){return""===t}function ak(t,e){var n,i,o;if(mk(t)){var s,a=t.stops&&"object"==typeof t.stops[0][0],l=a||ok(t.property),h=a||!l,c=t.type||e||"exponential";if("exponential"===c)s=ck;else if("interval"===c)s=hk;else if("categorical"===c)s=lk;else if("identity"===c)s=dk;else if("color-interpolate"===c)s=fk;else{if("calculate-expression"!==c)throw new Error('Unknown function type "'+c+'"');s=gk}if(a){var u={},f=[];for(let e=0;e<t.stops.length;e++){var g=t.stops[e];void 0===u[g[0].zoom]&&(u[g[0].zoom]={zoom:g[0].zoom,type:t.type,property:t.property,default:t.default,stops:[]}),u[g[0].zoom].stops.push([g[0].value,g[1]])}for(let t in u)f.push([u[t].zoom,ak(u[t])]);n=function(e,n){const i=ck({stops:f,base:t.base},e)(e,n);return"function"==typeof i?i(e,n):i},i=!1,o=!1}else h?(n=function(e){const n=s(t,e);return"function"==typeof n?n(e):n},i=!0,o=!1):(n=function(e,n){const i=s(t,n?n[t.property]:null);return"function"==typeof i?i(e,n):i},i=!1,o=!0)}else n=function(){return t},i=!0,o=!0;return n.isZoomConstant=o,n.isFeatureConstant=i,n}function lk(t,e){for(let n=0;n<t.stops.length;n++)if(e===t.stops[n][0])return t.stops[n][1];return t.default}function hk(t,e){for(var n=0;n<t.stops.length&&!(e<t.stops[n][0]);n++);return t.stops[Math.max(n-1,0)][1]}function ck(t,e){for(var n=ok(t.base)&&!sk(t.base)?t.base:1,i=0;!(i>=t.stops.length||e<=t.stops[i][0]);)i++;return 0===i?t.stops[i][1]:i===t.stops.length?t.stops[i-1][1]:pk(e,n,t.stops[i-1][0],t.stops[i][0],t.stops[i-1][1],t.stops[i][1])}"function"==typeof Map&&(ik=new Map);const uk={width:100,height:1};function fk(t,e){const n=t.stops;if(n&&n.length>1){let t;if(ik){const e=JSON.stringify(n);if(!ik.has(e)){const t=new ColorIn(n,uk);ik.set(e,t)}t=ik.get(e)}else t=new ColorIn(n,uk);const[i,o,s,a]=t.getColor(e);return[i/255,o/255,s/255,a/255]}return n&&1===n.length?n[0][1]:null}function dk(t,e){return function(t,e,n){return ok(t)?t:ok(e)?e:ok(n)?n:null}(e,t.default)}function gk(t,e){const n=String(t.property),i=t.expression,o=e;function s(e){return rk(e)||sk(e)||isNaN(e)?t.default:e}if(!ok(e)||sk(e)||isNaN(e)||e<0)return s(t.default);{const e=function t(e,n,i){const o=Number(i),s=String(n);return Array.isArray(e)?e.map((e=>t(e,s,o))):e===s?o:e}(i,n,o);return s(function e(n){if(!Array.isArray(n)){if("number"==typeof n)return n;throw new Error("Invalid expression format")}{const i=n[0];if(!["+","-","*","/"].includes(i))throw new Error(`Unknown operator: ${i}`);const o=n.slice(1).map((t=>e(t)));switch(i){case"+":return o.reduce(((t,e)=>t+e),0);case"-":return o.reduce(((t,e)=>t-e));case"*":return o.reduce(((t,e)=>t*e),1);case"/":return o.some((t=>0===t))?t.default:o.reduce(((t,e)=>t/e));default:throw new Error(`Unsupported operator: ${i}`)}}}(e))}}function pk(t,e,n,i,o,s){return"function"==typeof o?function(){var a=o.apply(void 0,arguments),l=s.apply(void 0,arguments);return pk(t,e,n,i,a,l)}:o.length?function(t,e,n,i,o,s){var a=[];for(let l=0;l<o.length;l++)a[l]=Ak(t,e,n,i,o[l],s[l]);return a}(t,e,n,i,o,s):Ak(t,e,n,i,o,s)}function Ak(t,e,n,i,o,s){var a,l=i-n,h=t-n;return o*(1-(a=1===e?h/l:(Math.pow(e,h)-1)/(Math.pow(e,l)-1)))+s*a}function mk(t){return t&&"object"==typeof t&&(t.stops||t.property&&"identity"===t.type||t.expression&&"calculate-expression"===t.type)}function yk(t){for(const e in t)if(mk(t[e]))return!0;return!1}function _k(t){return bk(t,"exponential")}function vk(t){return bk(t,"interval")}function xk(t,e){if(!t)return null;var n=!1;if(Array.isArray(t)){var i,o=[];for(let s=0;s<t.length;s++)(i=xk(t[s],e))?(o.push(i),n=!0):o.push(t[s]);return n?o:t}var s,a={__fn_types_loaded:!0},l=[];for(s in t)t.hasOwnProperty(s)&&l.push(s);const h=function(t){Object.defineProperty(a,t,{get:function(){return this["__fn_"+t]||(this["__fn_"+t]=_k(this["_"+t])),this["__fn_"+t].apply(this,e())},set:function(e){this["_"+t]=e},configurable:!0,enumerable:!0})};for(let e=0,i=l.length;e<i;e++)mk(t[s=l[e]])?(n=!0,a["_"+s]=t[s],h(s)):a[s]=t[s];return n?a:t}function bk(t,e){if(!mk(t))return function(){return t};let n=!0,i=!0;const o=(t=JSON.parse(JSON.stringify(t))).stops;if(o)for(let t=0;t<o.length;t++)if(mk(o[t][1])){const s=bk(o[t][1],e);n=n&&s.isZoomConstant,i=i&&s.isFeatureConstant,o[t]=[o[t][0],s]}const s=ak(t,e);return s.isZoomConstant=n&&s.isZoomConstant,s.isFeatureConstant=i&&s.isFeatureConstant,s}
/*!
  * Contains code from jquery.easing
  * BSD License
  * https://github.com/gdsmith/jquery.easing/
  */var wk=Math.pow,Tk=Math.sqrt,Mk=Math.sin,Ck=Math.cos,Sk=Math.PI,Pk=1.70158,Ik=1.525*Pk,Ok=Pk+1,Ek=2*Sk/3,kk=2*Sk/4.5;function Rk(t){var e=7.5625,n=2.75;return t<1/n?e*t*t:t<2/n?e*(t-=1.5/n)*t+.75:t<2.5/n?e*(t-=2.25/n)*t+.9375:e*(t-=2.625/n)*t+.984375}function Lk(t,e){switch(t=t.toLowerCase()){case"swing":return function(t){return Dk(t)}(e);case"easeinquad":return Dk(e);case"easeoutquad":return function(t){return 1-(1-t)*(1-t)}(e);case"easeinoutquad":return function(t){return t<.5?2*t*t:1-wk(-2*t+2,2)/2}(e);case"easeincubic":return function(t){return t*t*t}(e);case"easeoutcubic":return function(t){return 1-wk(1-t,3)}(e);case"easeinoutcubic":return function(t){return t<.5?4*t*t*t:1-wk(-2*t+2,3)/2}(e);case"easeinquart":return function(t){return t*t*t*t}(e);case"easeoutquart":return function(t){return 1-wk(1-t,4)}(e);case"easeinoutquart":return function(t){return t<.5?8*t*t*t*t:1-wk(-2*t+2,4)/2}(e);case"easeinquint":return function(t){return t*t*t*t*t}(e);case"easeoutquint":return function(t){return 1-wk(1-t,5)}(e);case"easeinoutquint":return function(t){return t<.5?16*t*t*t*t*t:1-wk(-2*t+2,5)/2}(e);case"easeinsine":return function(t){return 1-Ck(t*Sk/2)}(e);case"easeoutsine":return function(t){return Mk(t*Sk/2)}(e);case"easeinoutsine":return function(t){return-(Ck(Sk*t)-1)/2}(e);case"easeinexpo":return function(t){return 0===t?0:wk(2,10*t-10)}(e);case"easeoutexpo":return function(t){return 1===t?1:1-wk(2,-10*t)}(e);case"easeinoutexpo":return function(t){return 0===t?0:1===t?1:t<.5?wk(2,20*t-10)/2:(2-wk(2,-20*t+10))/2}(e);case"easeincirc":return function(t){return 1-Tk(1-wk(t,2))}(e);case"easeoutcirc":return function(t){return Tk(1-wk(t-1,2))}(e);case"easeinoutcirc":return function(t){return t<.5?(1-Tk(1-wk(2*t,2)))/2:(Tk(1-wk(-2*t+2,2))+1)/2}(e);case"easeinelastic":return function(t){return 0===t?0:1===t?1:-wk(2,10*t-10)*Mk((10*t-10.75)*Ek)}(e);case"easeoutelastic":return function(t){return 0===t?0:1===t?1:wk(2,-10*t)*Mk((10*t-.75)*Ek)+1}(e);case"easeinoutelastic":return function(t){return 0===t?0:1===t?1:t<.5?-wk(2,20*t-10)*Mk((20*t-11.125)*kk)/2:wk(2,-20*t+10)*Mk((20*t-11.125)*kk)/2+1}(e);case"easeinback":return function(t){return Ok*t*t*t-Pk*t*t}(e);case"easeoutback":return function(t){return 1+Ok*wk(t-1,3)+Pk*wk(t-1,2)}(e);case"easeinoutback":return function(t){return t<.5?wk(2*t,2)*(2*(Ik+1)*t-Ik)/2:(wk(2*t-2,2)*((Ik+1)*(2*t-2)+Ik)+2)/2}(e);case"easeinbounce":return function(t){return 1-Rk(1-t)}(e);case"easeoutbounce":return function(t){return Rk(t)}(e);case"easeinoutbounce":return function(t){return t<.5?(1-Rk(1-2*t))/2:(1+Rk(2*t-1))/2}
/*!
      Feature Filter by

      (c) mapbox 2016 and ispace 2018
      www.mapbox.com | www.ispace.org
      License: MIT, header required.
  */(e)}throw new Error("Unsupported easing function:"+t)}function Dk(t){return t*t}const Fk=["Unknown","Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"];function Nk(t){return new Function("f",`var p = (f && f.properties || {}); return ${Hk(t)}`)}function Hk(t){if(!t)return"true";const e=t[0];if(t.length<=1)return"any"===e?"false":"true";const n="=="===e?zk(t[1],t[2],"===",!1):"!="===e?zk(t[1],t[2],"!==",!1):"<"===e||">"===e||"<="===e||">="===e?zk(t[1],t[2],e,!0):"any"===e?jk(t.slice(1),"||"):"all"===e?jk(t.slice(1),"&&"):"none"===e?Wk(jk(t.slice(1),"||")):"in"===e?Uk(t[1],t.slice(2)):"!in"===e?Wk(Uk(t[1],t.slice(2))):"has"===e?Vk(t[1]):"!has"===e?Wk(Vk(t[1])):"contains"===e?function(t,e,n){const i=Bk(t);return void 0!==n?`(${i} + '').indexOf("${e}") === ${n}`:`(${i} + '').indexOf("${e}") >= 0`}(t[1],t[2],t[3]):"true";return`(${n})`}function Bk(t){return"$"===t[0]?"f."+t.substring(1):"p["+JSON.stringify(t)+"]"}function zk(t,e,n,i){if("object"==typeof(o=t)&&o&&t.op)return function(t,e,n,i){const o=t.property,s=t.op;let a=Bk(o);return"length"!==s?(console.error(`not support ${s} op`),"false"):(a=`((${a}+='').length)`,Gk(a,o,e,n,i))}(t,e,n,i);var o;return Gk(Bk(t),t,e,n,i)}function Gk(t,e,n,i,o){const s="$type"===e?Fk.indexOf(n):JSON.stringify(n);return(o?`typeof ${t}=== typeof ${s}&&`:"")+t+i+s}function jk(t,e){return t.map(Hk).join(e)}function Uk(t,e){"$type"===t&&(e=e.map((t=>Fk.indexOf(t))));const n=JSON.stringify(e.sort(Zk)),i=Bk(t);return e.length<=200?`${n}.indexOf(${i}) !== -1`:`function(v, a, i, j) {\n        while (i <= j) { var m = (i + j) >> 1;\n            if (a[m] === v) return true; if (a[m] > v) j = m - 1; else i = m + 1;\n        }\n    return false; }(${i}, ${n},0,${e.length-1})`}function Vk(t){return"$id"===t?'"id" in f':`${JSON.stringify(t)} in p`}function Wk(t){return`!(${t})`}function Zk(t,e){return t<e?-1:t>e?1:0}function qk(t){if(!Array.isArray(t))return qk([t]);const e=[];for(let n=0;n<t.length;n++){let i;i=!0===t[n].filter?function(){return!0}:Nk(t[n].filter),e.push(Xk({},t[n],{filter:i}))}return e}function Xk(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)t[e]=n[e]}return t}function Jk(){}const Qk=Jk.prototype;Qk.getType=function(){return Object.getPrototypeOf(this).constructor.type},Qk.isVisible=function(){throw new Error("to be implemented.")},Qk.prepareRender=function(){throw new Error("to be implemented.")},Qk.updateCollision=function(){throw new Error("to be implemented.")},Qk.supportRenderMode=function(){throw new Error("to be implemented.")},Qk.startFrame=function(){throw new Error("to be implemented.")},Qk.endFrame=function(){throw new Error("to be implemented.")},Qk.paintTile=function(){throw new Error("to be implemented.")},Qk.getShadowMeshes=function(){throw new Error("to be implemented.")},Qk.updateSceneConfig=function(){throw new Error("to be implemented.")},Qk.updateDataConfig=function(){throw new Error("to be implemented.")},Qk.updateSymbol=function(){throw new Error("to be implemented.")},Qk.pick=function(){throw new Error("to be implemented.")},Qk.resize=function(){throw new Error("to be implemented.")},Qk.deleteTile=function(){throw new Error("to be implemented.")},Qk.remove=function(){throw new Error("to be implemented.")},Qk.needToRedraw=function(){throw new Error("to be implemented.")},Qk.needToRetireFrames=function(){throw new Error("to be implemented.")},Qk.outline=function(){throw new Error("to be implemented.")},Qk.outlineAll=function(){throw new Error("to be implemented.")},Qk.needPolygonOffset=function(){throw new Error("to be implemented.")},Qk.constructor=Jk;const Yk=Object.prototype.hasOwnProperty;function Kk(t){t.registerPlugin(this)}function $k(t,e,n=2){const i=e&&e.length,o=i?e[0]*n:t.length;let s=tR(t,0,o,n,!0);const a=[];if(!s||s.next===s.prev)return a;let l,h,c;if(i&&(s=function(t,e,n,i){const o=[];for(let n=0,s=e.length;n<s;n++){const a=tR(t,e[n]*i,n<s-1?e[n+1]*i:t.length,i,!1);a===a.next&&(a.steiner=!0),o.push(uR(a))}o.sort(aR);for(let t=0;t<o.length;t++)n=lR(o[t],n);return n}(t,e,s,n)),t.length>80*n){l=1/0,h=1/0;let e=-1/0,i=-1/0;for(let s=n;s<o;s+=n){const n=t[s],o=t[s+1];n<l&&(l=n),o<h&&(h=o),n>e&&(e=n),o>i&&(i=o)}c=Math.max(e-l,i-h),c=0!==c?32767/c:0}return nR(s,a,n,l,h,c,0),a}function tR(t,e,n,i,o){let s;if(o===function(t,e,n,i){let o=0;for(let s=e,a=n-i;s<n;s+=i)o+=(t[a]-t[s])*(t[s+1]+t[a+1]),a=s;return o}(t,e,n,i)>0)for(let o=e;o<n;o+=i)s=bR(o/i|0,t[o],t[o+1],s);else for(let o=n-i;o>=e;o-=i)s=bR(o/i|0,t[o],t[o+1],s);return s&&AR(s,s.next)&&(wR(s),s=s.next),s}function eR(t,e){if(!t)return t;e||(e=t);let n,i=t;do{if(n=!1,i.steiner||!AR(i,i.next)&&0!==pR(i.prev,i,i.next))i=i.next;else{if(wR(i),i=e=i.prev,i===i.next)break;n=!0}}while(n||i!==e);return e}function nR(t,e,n,i,o,s,a){if(!t)return;!a&&s&&function(t,e,n,i){let o=t;do{0===o.z&&(o.z=cR(o.x,o.y,e,n,i)),o.prevZ=o.prev,o.nextZ=o.next,o=o.next}while(o!==t);o.prevZ.nextZ=null,o.prevZ=null,function(t){let e,n=1;do{let i,o=t;t=null;let s=null;for(e=0;o;){e++;let a=o,l=0;for(let t=0;t<n&&(l++,a=a.nextZ,a);t++);let h=n;for(;l>0||h>0&&a;)0!==l&&(0===h||!a||o.z<=a.z)?(i=o,o=o.nextZ,l--):(i=a,a=a.nextZ,h--),s?s.nextZ=i:t=i,i.prevZ=s,s=i;o=a}s.nextZ=null,n*=2}while(e>1)}(o)}(t,i,o,s);let l=t;for(;t.prev!==t.next;){const h=t.prev,c=t.next;if(s?rR(t,i,o,s):iR(t))e.push(h.i,t.i,c.i),wR(t),t=c.next,l=c.next;else if((t=c)===l){a?1===a?nR(t=oR(eR(t),e),e,n,i,o,s,2):2===a&&sR(t,e,n,i,o,s):nR(eR(t),e,n,i,o,s,1);break}}}function iR(t){const e=t.prev,n=t,i=t.next;if(pR(e,n,i)>=0)return!1;const o=e.x,s=n.x,a=i.x,l=e.y,h=n.y,c=i.y,u=Math.min(o,s,a),f=Math.min(l,h,c),g=Math.max(o,s,a),A=Math.max(l,h,c);let m=i.next;for(;m!==e;){if(m.x>=u&&m.x<=g&&m.y>=f&&m.y<=A&&dR(o,l,s,h,a,c,m.x,m.y)&&pR(m.prev,m,m.next)>=0)return!1;m=m.next}return!0}function rR(t,e,n,i){const o=t.prev,s=t,a=t.next;if(pR(o,s,a)>=0)return!1;const l=o.x,h=s.x,c=a.x,u=o.y,f=s.y,g=a.y,A=Math.min(l,h,c),m=Math.min(u,f,g),w=Math.max(l,h,c),T=Math.max(u,f,g),M=cR(A,m,e,n,i),C=cR(w,T,e,n,i);let P=t.prevZ,I=t.nextZ;for(;P&&P.z>=M&&I&&I.z<=C;){if(P.x>=A&&P.x<=w&&P.y>=m&&P.y<=T&&P!==o&&P!==a&&dR(l,u,h,f,c,g,P.x,P.y)&&pR(P.prev,P,P.next)>=0)return!1;if(P=P.prevZ,I.x>=A&&I.x<=w&&I.y>=m&&I.y<=T&&I!==o&&I!==a&&dR(l,u,h,f,c,g,I.x,I.y)&&pR(I.prev,I,I.next)>=0)return!1;I=I.nextZ}for(;P&&P.z>=M;){if(P.x>=A&&P.x<=w&&P.y>=m&&P.y<=T&&P!==o&&P!==a&&dR(l,u,h,f,c,g,P.x,P.y)&&pR(P.prev,P,P.next)>=0)return!1;P=P.prevZ}for(;I&&I.z<=C;){if(I.x>=A&&I.x<=w&&I.y>=m&&I.y<=T&&I!==o&&I!==a&&dR(l,u,h,f,c,g,I.x,I.y)&&pR(I.prev,I,I.next)>=0)return!1;I=I.nextZ}return!0}function oR(t,e){let n=t;do{const i=n.prev,o=n.next.next;!AR(i,o)&&mR(i,n,n.next,o)&&vR(i,o)&&vR(o,i)&&(e.push(i.i,n.i,o.i),wR(n),wR(n.next),n=t=o),n=n.next}while(n!==t);return eR(n)}function sR(t,e,n,i,o,s){let a=t;do{let t=a.next.next;for(;t!==a.prev;){if(a.i!==t.i&&gR(a,t)){let l=xR(a,t);return a=eR(a,a.next),l=eR(l,l.next),nR(a,e,n,i,o,s,0),void nR(l,e,n,i,o,s,0)}t=t.next}a=a.next}while(a!==t)}function aR(t,e){let n=t.x-e.x;if(0===n&&(n=t.y-e.y,0===n)){n=(t.next.y-t.y)/(t.next.x-t.x)-(e.next.y-e.y)/(e.next.x-e.x)}return n}function lR(t,e){const n=function(t,e){let n=e;const i=t.x,o=t.y;let s,a=-1/0;if(AR(t,n))return n;do{if(AR(t,n.next))return n.next;if(o<=n.y&&o>=n.next.y&&n.next.y!==n.y){const t=n.x+(o-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(t<=i&&t>a&&(a=t,s=n.x<n.next.x?n:n.next,t===i))return s}n=n.next}while(n!==e);if(!s)return null;const l=s,h=s.x,c=s.y;let u=1/0;n=s;do{if(i>=n.x&&n.x>=h&&i!==n.x&&fR(o<c?i:a,o,h,c,o<c?a:i,o,n.x,n.y)){const e=Math.abs(o-n.y)/(i-n.x);vR(n,t)&&(e<u||e===u&&(n.x>s.x||n.x===s.x&&hR(s,n)))&&(s=n,u=e)}n=n.next}while(n!==l);return s}(t,e);if(!n)return e;const i=xR(n,t);return eR(i,i.next),eR(n,n.next)}function hR(t,e){return pR(t.prev,t,e.prev)<0&&pR(e.next,t,t.next)<0}function cR(t,e,n,i,o){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-n)*o|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-i)*o|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function uR(t){let e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function fR(t,e,n,i,o,s,a,l){return(o-a)*(e-l)>=(t-a)*(s-l)&&(t-a)*(i-l)>=(n-a)*(e-l)&&(n-a)*(s-l)>=(o-a)*(i-l)}function dR(t,e,n,i,o,s,a,l){return!(t===a&&e===l)&&fR(t,e,n,i,o,s,a,l)}function gR(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){let n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&mR(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&(vR(t,e)&&vR(e,t)&&function(t,e){let n=t,i=!1;const o=(t.x+e.x)/2,s=(t.y+e.y)/2;do{n.y>s!=n.next.y>s&&n.next.y!==n.y&&o<(n.next.x-n.x)*(s-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==t);return i}(t,e)&&(pR(t.prev,t,e.prev)||pR(t,e.prev,e))||AR(t,e)&&pR(t.prev,t,t.next)>0&&pR(e.prev,e,e.next)>0)}function pR(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function AR(t,e){return t.x===e.x&&t.y===e.y}function mR(t,e,n,i){const o=_R(pR(t,e,n)),s=_R(pR(t,e,i)),a=_R(pR(n,i,t)),l=_R(pR(n,i,e));return o!==s&&a!==l||(!(0!==o||!yR(t,n,e))||(!(0!==s||!yR(t,i,e))||(!(0!==a||!yR(n,t,i))||!(0!==l||!yR(n,e,i)))))}function yR(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function _R(t){return t>0?1:t<0?-1:0}function vR(t,e){return pR(t.prev,t,t.next)<0?pR(t,e,t.next)>=0&&pR(t,t.prev,e)>=0:pR(t,e,t.prev)<0||pR(t,t.next,e)<0}function xR(t,e){const n=TR(t.i,t.x,t.y),i=TR(e.i,e.x,e.y),o=t.next,s=e.prev;return t.next=e,e.prev=t,n.next=o,o.prev=n,i.next=n,n.prev=i,s.next=i,i.prev=s,i}function bR(t,e,n,i){const o=TR(t,e,n);return i?(o.next=i.next,o.prev=i,i.next.prev=o,i.next=o):(o.prev=o,o.next=o),o}function wR(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function TR(t,e,n){return{i:t,x:e,y:n,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function MR(t,e,n,i,o){CR(t,e,n||0,i||t.length-1,o||PR)}function CR(t,e,n,i,o){for(;i>n;){if(i-n>600){var s=i-n+1,a=e-n+1,l=Math.log(s),h=.5*Math.exp(2*l/3),c=.5*Math.sqrt(l*h*(s-h)/s)*(a-s/2<0?-1:1);CR(t,e,Math.max(n,Math.floor(e-a*h/s+c)),Math.min(i,Math.floor(e+(s-a)*h/s+c)),o)}var u=t[e],f=n,g=i;for(SR(t,n,e),o(t[i],u)>0&&SR(t,n,i);f<g;){for(SR(t,f,g),f++,g--;o(t[f],u)<0;)f++;for(;o(t[g],u)>0;)g--}0===o(t[n],u)?SR(t,n,g):SR(t,++g,i),g<=e&&(n=g+1),e<=g&&(i=g-1)}}function SR(t,e,n){var i=t[e];t[e]=t[n],t[n]=i}function PR(t,e){return t<e?-1:t>e?1:0}Jk.extend=function(t,e){const n=function(){this.init&&this.init()},i=Object.create(Qk);i.constructor=n,n.prototype=i,n.type=t;for(const t in e)Yk.call(e,t)&&(n.prototype[t]=e[t]);return n.registerAt=Kk.bind(n),n};class RBush{constructor(t=9){this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()}all(){return this._all(this.data,[])}search(t){let e=this.data;const n=[];if(!zR(t,e))return n;const i=this.toBBox,o=[];for(;e;){for(let s=0;s<e.children.length;s++){const a=e.children[s],l=e.leaf?i(a):a;zR(t,l)&&(e.leaf?n.push(a):BR(t,l)?this._all(a,n):o.push(a))}e=o.pop()}return n}collides(t){let e=this.data;if(!zR(t,e))return!1;const n=[];for(;e;){for(let i=0;i<e.children.length;i++){const o=e.children[i],s=e.leaf?this.toBBox(o):o;if(zR(t,s)){if(e.leaf||BR(t,s))return!0;n.push(o)}}e=n.pop()}return!1}load(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(let e=0;e<t.length;e++)this.insert(t[e]);return this}let e=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===e.height)this._splitRoot(this.data,e);else{if(this.data.height<e.height){const t=this.data;this.data=e,e=t}this._insert(e,this.data.height-e.height-1,!0)}else this.data=e;return this}insert(t){return t&&this._insert(t,this.data.height-1),this}clear(){return this.data=GR([]),this}remove(t,e){if(!t)return this;let n=this.data;const i=this.toBBox(t),o=[],s=[];let a,l,h;for(;n||o.length;){if(n||(n=o.pop(),l=o[o.length-1],a=s.pop(),h=!0),n.leaf){const i=IR(t,n.children,e);if(-1!==i)return n.children.splice(i,1),o.push(n),this._condense(o),this}h||n.leaf||!BR(n,i)?l?(a++,n=l.children[a],h=!1):n=null:(o.push(n),s.push(a),a=0,l=n,n=n.children[0])}return this}toBBox(t){return t}compareMinX(t,e){return t.minX-e.minX}compareMinY(t,e){return t.minY-e.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}_all(t,e){const n=[];for(;t;)t.leaf?e.push(...t.children):n.push(...t.children),t=n.pop();return e}_build(t,e,n,i){const o=n-e+1;let s,a=this._maxEntries;if(o<=a)return s=GR(t.slice(e,n+1)),OR(s,this.toBBox),s;i||(i=Math.ceil(Math.log(o)/Math.log(a)),a=Math.ceil(o/Math.pow(a,i-1))),s=GR([]),s.leaf=!1,s.height=i;const l=Math.ceil(o/a),h=l*Math.ceil(Math.sqrt(a));jR(t,e,n,h,this.compareMinX);for(let o=e;o<=n;o+=h){const e=Math.min(o+h-1,n);jR(t,o,e,l,this.compareMinY);for(let n=o;n<=e;n+=l){const o=Math.min(n+l-1,e);s.children.push(this._build(t,n,o,i-1))}}return OR(s,this.toBBox),s}_chooseSubtree(t,e,n,i){for(;i.push(e),!e.leaf&&i.length-1!==n;){let n,i=1/0,o=1/0;for(let s=0;s<e.children.length;s++){const a=e.children[s],l=DR(a),h=NR(t,a)-l;h<o?(o=h,i=l<i?l:i,n=a):h===o&&l<i&&(i=l,n=a)}e=n||e.children[0]}return e}_insert(t,e,n){const i=n?t:this.toBBox(t),o=[],s=this._chooseSubtree(i,this.data,e,o);for(s.children.push(t),kR(s,i);e>=0&&o[e].children.length>this._maxEntries;)this._split(o,e),e--;this._adjustParentBBoxes(i,o,e)}_split(t,e){const n=t[e],i=n.children.length,o=this._minEntries;this._chooseSplitAxis(n,o,i);const s=this._chooseSplitIndex(n,o,i),a=GR(n.children.splice(s,n.children.length-s));a.height=n.height,a.leaf=n.leaf,OR(n,this.toBBox),OR(a,this.toBBox),e?t[e-1].children.push(a):this._splitRoot(n,a)}_splitRoot(t,e){this.data=GR([t,e]),this.data.height=t.height+1,this.data.leaf=!1,OR(this.data,this.toBBox)}_chooseSplitIndex(t,e,n){let i,o=1/0,s=1/0;for(let a=e;a<=n-e;a++){const e=ER(t,0,a,this.toBBox),l=ER(t,a,n,this.toBBox),h=HR(e,l),c=DR(e)+DR(l);h<o?(o=h,i=a,s=c<s?c:s):h===o&&c<s&&(s=c,i=a)}return i||n-e}_chooseSplitAxis(t,e,n){const i=t.leaf?this.compareMinX:RR,o=t.leaf?this.compareMinY:LR;this._allDistMargin(t,e,n,i)<this._allDistMargin(t,e,n,o)&&t.children.sort(i)}_allDistMargin(t,e,n,i){t.children.sort(i);const o=this.toBBox,s=ER(t,0,e,o),a=ER(t,n-e,n,o);let l=FR(s)+FR(a);for(let i=e;i<n-e;i++){const e=t.children[i];kR(s,t.leaf?o(e):e),l+=FR(s)}for(let i=n-e-1;i>=e;i--){const e=t.children[i];kR(a,t.leaf?o(e):e),l+=FR(a)}return l}_adjustParentBBoxes(t,e,n){for(let i=n;i>=0;i--)kR(e[i],t)}_condense(t){for(let e,n=t.length-1;n>=0;n--)0===t[n].children.length?n>0?(e=t[n-1].children,e.splice(e.indexOf(t[n]),1)):this.clear():OR(t[n],this.toBBox)}}function IR(t,e,n){if(!n)return e.indexOf(t);for(let i=0;i<e.length;i++)if(n(t,e[i]))return i;return-1}function OR(t,e){ER(t,0,t.children.length,e,t)}function ER(t,e,n,i,o){o||(o=GR(null)),o.minX=1/0,o.minY=1/0,o.maxX=-1/0,o.maxY=-1/0;for(let s=e;s<n;s++){const e=t.children[s];kR(o,t.leaf?i(e):e)}return o}function kR(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function RR(t,e){return t.minX-e.minX}function LR(t,e){return t.minY-e.minY}function DR(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function FR(t){return t.maxX-t.minX+(t.maxY-t.minY)}function NR(t,e){return(Math.max(e.maxX,t.maxX)-Math.min(e.minX,t.minX))*(Math.max(e.maxY,t.maxY)-Math.min(e.minY,t.minY))}function HR(t,e){const n=Math.max(t.minX,e.minX),i=Math.max(t.minY,e.minY),o=Math.min(t.maxX,e.maxX),s=Math.min(t.maxY,e.maxY);return Math.max(0,o-n)*Math.max(0,s-i)}function BR(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function zR(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function GR(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function jR(t,e,n,i,o){const s=[e,n];for(;s.length;){if((n=s.pop())-(e=s.pop())<=i)continue;const a=e+Math.ceil((n-e)/i/2)*i;MR(t,a,e,n,o),s.push(e,a,a,n)}}
/*!
   * @ispace/vt v0.107.5
   * LICENSE : undefined
   * (c) 2016-2026 ispace.org
   */const UR="${",VR=`function(t){let e;const n={width:100,height:10};let r=!1;try{const t=new OffscreenCanvas(1,1);t.getContext("2d").fillText("hello",0,0),r=!0}catch(t){r=!1}function i(){if(!e){const{width:t,height:i}=n;r?e=new OffscreenCanvas(t,i):(e=document.createElement("canvas"),e.width=t,e.height=i)}return e}class o{constructor(t,e={}){if(!Array.isArray(t))return void console.error("colors is not array");if(t.length<2)return void console.error("colors.length should >1");this.colors=t;let r=1/0,i=-1/0;for(let e=0,n=t.length;e<n;e++){const n=t[e][0];r=Math.min(n,r),i=Math.max(n,i)}this.min=r,this.max=i,this.valueOffset=this.max-this.min,this.options=Object.assign({},n,e),this._initImgData()}getImageData(){return this.imgData}_initImgData(){const t=i(),{width:e,height:n}=this.options;t.width=e,t.height=n;const r=t.getContext("2d");r.clearRect(0,0,t.width,t.height);const o=r.createLinearGradient(0,0,t.width,0),{colors:s,valueOffset:a}=this;for(let t=0,e=s.length;t<e;t++){const[e,n]=s[t],r=(e-this.min)/a;o.addColorStop(r,n)}r.fillStyle=o,r.fillRect(0,0,t.width,t.height),this.imgData=r.getImageData(0,0,t.width,t.height)}getColor(t){t=Math.max(this.min,t);const e=((t=Math.min(t,this.max))-this.min)/this.valueOffset;let n=Math.round(e*this.imgData.width);n=Math.min(n,this.imgData.width-1);const r=4*n;return[this.imgData.data[r],this.imgData.data[r+1],this.imgData.data[r+2],this.imgData.data[r+3]]}}var s;function a(t){return null==t}function l(t){return!a(t)}function u(t){return""===t}function h(t,e){var n,r,i;if(w(t)){var o,s=t.stops&&"object"==typeof t.stops[0][0],a=s||l(t.property),u=s||!a,d=t.type||e||"exponential";if("exponential"===d)o=p;else if("interval"===d)o=f;else if("categorical"===d)o=c;else if("identity"===d)o=y;else if("color-interpolate"===d)o=g;else{if("calculate-expression"!==d)throw new Error('Unknown function type "'+d+'"');o=x}if(s){var m={},v=[];for(let e=0;e<t.stops.length;e++){var M=t.stops[e];void 0===m[M[0].zoom]&&(m[M[0].zoom]={zoom:M[0].zoom,type:t.type,property:t.property,default:t.default,stops:[]}),m[M[0].zoom].stops.push([M[0].value,M[1]])}for(let t in m)v.push([m[t].zoom,h(m[t])]);n=function(e,n){const r=p({stops:v,base:t.base},e)(e,n);return"function"==typeof r?r(e,n):r},r=!1,i=!1}else u?(n=function(e){const n=o(t,e);return"function"==typeof n?n(e):n},r=!0,i=!1):(n=function(e,n){const r=o(t,n?n[t.property]:null);return"function"==typeof r?r(e,n):r},r=!1,i=!0)}else n=function(){return t},r=!0,i=!0;return n.isZoomConstant=i,n.isFeatureConstant=r,n}function c(t,e){for(let n=0;n<t.stops.length;n++)if(e===t.stops[n][0])return t.stops[n][1];return t.default}function f(t,e){for(var n=0;n<t.stops.length&&!(e<t.stops[n][0]);n++);return t.stops[Math.max(n-1,0)][1]}function p(t,e){for(var n=l(t.base)&&!u(t.base)?t.base:1,r=0;!(r>=t.stops.length||e<=t.stops[r][0]);)r++;return 0===r?t.stops[r][1]:r===t.stops.length?t.stops[r-1][1]:m(e,n,t.stops[r-1][0],t.stops[r][0],t.stops[r-1][1],t.stops[r][1])}"function"==typeof Map&&(s=new Map);const d={width:100,height:1};function g(t,e){const n=t.stops;if(n&&n.length>1){let t;if(s){const e=JSON.stringify(n);if(!s.has(e)){const t=new o(n,d);s.set(e,t)}t=s.get(e)}else t=new o(n,d);const[r,i,a,l]=t.getColor(e);return[r/255,i/255,a/255,l/255]}return n&&1===n.length?n[0][1]:null}function y(t,e){return n=e,r=t.default,l(n)?n:l(r)?r:l(i)?i:null;var n,r,i}function x(t,e){const n=String(t.property),r=t.expression,i=e;function o(e){return a(e)||u(e)||isNaN(e)?t.default:e}if(!l(e)||u(e)||isNaN(e)||e<0)return o(t.default);{const e=function t(e,n,r){const i=Number(r),o=String(n);return Array.isArray(e)?e.map((e=>t(e,o,i))):e===o?i:e}(r,n,i);return o(function e(n){if(!Array.isArray(n)){if("number"==typeof n)return n;throw new Error("Invalid expression format")}{const r=n[0];if(!["+","-","*","/"].includes(r))throw new Error(\`Unknown operator: ${UR}r}\`);const i=n.slice(1).map((t=>e(t)));switch(r){case"+":return i.reduce(((t,e)=>t+e),0);case"-":return i.reduce(((t,e)=>t-e));case"*":return i.reduce(((t,e)=>t*e),1);case"/":return i.some((t=>0===t))?t.default:i.reduce(((t,e)=>t/e));default:throw new Error(\`Unsupported operator: ${UR}r}\`)}}}(e))}}function m(t,e,n,r,i,o){return"function"==typeof i?function(){var s=i.apply(void 0,arguments),a=o.apply(void 0,arguments);return m(t,e,n,r,s,a)}:i.length?function(t,e,n,r,i,o){var s=[];for(let a=0;a<i.length;a++)s[a]=v(t,e,n,r,i[a],o[a]);return s}(t,e,n,r,i,o):v(t,e,n,r,i,o)}function v(t,e,n,r,i,o){var s,a=r-n,l=t-n;return i*(1-(s=1===e?l/a:(Math.pow(e,l)-1)/(Math.pow(e,a)-1)))+o*s}function w(t){return t&&"object"==typeof t&&(t.stops||t.property&&"identity"===t.type||t.expression&&"calculate-expression"===t.type)}function M(t){return b(t,"interval")}function b(t,e){if(!w(t))return function(){return t};let n=!0,r=!0;const i=(t=JSON.parse(JSON.stringify(t))).stops;if(i)for(let t=0;t<i.length;t++)if(w(i[t][1])){const o=b(i[t][1],e);n=n&&o.isZoomConstant,r=r&&o.isFeatureConstant,i[t]=[i[t][0],o]}const o=h(t,e);return o.isZoomConstant=n&&o.isZoomConstant,o.isFeatureConstant=r&&o.isFeatureConstant,o}let P=0;const _="function"==typeof Object.assign;function I(t,...e){if(_)return Object.assign(t,...e),t;for(let n=0;n<e.length;n++){const r=e[n];for(const e in r)t[e]=r[e]}return t}function A(t){return!k(t)&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}function S(t){return"number"==typeof t&&!isNaN(t)}function T(t){return!k(t)&&("function"==typeof t||null!==t.constructor&&t.constructor===Function)}function F(t){return!Array.isArray(t)&&"object"==typeof t&&!!t}function k(t){return null==t}function L(t){return w(t)&&t.property}const B="function"==typeof fetch&&"function"==typeof AbortController,C={jsonp:function(t,e){const n="_ispace_jsonp_"+P++;t.match(/\\?/)?t+="&callback="+n:t+="?callback="+n;let r=document.createElement("script");return r.type="text/javascript",r.src=t,window[n]=function(t){e(null,t),document.getElementsByTagName("head")[0].removeChild(r),r=null,delete window[n]},document.getElementsByTagName("head")[0].appendChild(r),this},get:function(t,e,n){if(T(e)){const t=n;n=e,e=t}(e=e||{}).method&&(e.method=e.method.toUpperCase());const r="POST"===e.method;if(B){const r=new AbortController,i=e;i.signal=r.signal,i.referrerPolicy=i.referrerPolicy||"origin",i.method=i.method||"GET";const o=new Request(t,i);return e.returnJSON&&o.headers.set("Accept","application/json"),fetch(o).then((r=>{const i=this._parseResponse(r,e.returnJSON,e.responseType);i.message?(i.url=t,n(i)):i.then((t=>{"arraybuffer"===e.responseType?n(null,{data:t,cacheControl:r.headers.get("Cache-Control"),expires:r.headers.get("Expires"),contentType:r.headers.get("Content-Type")}):n(null,t)})).catch((e=>{e.code&&e.code===DOMException.ABORT_ERR||(console.error("Fetch error:",t,e),n(e))}))})).catch((e=>{e.code&&e.code===DOMException.ABORT_ERR||(console.error("Fetch error:",t,e),n(e))})),r}{const i=C._getClient(n);if(i.open(e.method||"GET",t,!0),e){for(const t in e.headers)i.setRequestHeader(t,e.headers[t]);i.withCredentials="include"===e.credentials,e.responseType&&(i.responseType=e.responseType)}return i.send(r?e.body:null),i}},_parseResponse:(t,e,n)=>200!==t.status?{status:t.status,statusText:t.statusText,message:\`incorrect http request with status code(${UR}t.status}): ${UR}t.statusText}\`}:"arraybuffer"===n?t.arrayBuffer():e?t.json():t.text(),_wrapCallback:function(t,e){return function(){if(4===t.readyState)if(200===t.status)if("arraybuffer"===t.responseType){0===t.response.byteLength?e({status:200,statusText:t.statusText,message:"http status 200 returned without content."}):e(null,{data:t.response,cacheControl:t.getResponseHeader("Cache-Control"),expires:t.getResponseHeader("Expires"),contentType:t.getResponseHeader("Content-Type")})}else e(null,t.responseText);else e({status:t.status,statusText:t.statusText,message:\`incorrect http request with status code(${UR}t.status}): ${UR}t.statusText}\`})}},_getClient:function(t){let e;try{e=new XMLHttpRequest}catch(t){try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(t){try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(t){}}}return e.onreadystatechange=C._wrapCallback(e,t),e},getArrayBuffer(t,e,n){if(T(e)){const t=n;n=e,e=t}return e||(e={}),e.responseType="arraybuffer",C.get(t,e,n)}};function Y(t,e,n,r,i=3){let o=r;const s=n-e>>1;let a,l=n-e;const u=t[e],h=t[e+1],c=t[n],f=t[n+1];for(let r=e+i;r<n;r+=i){const e=V(t[r],t[r+1],u,h,c,f);if(e>o)a=r,o=e;else if(e===o){const t=Math.abs(r-s);t<l&&(a=r,l=t)}}o>r&&(a-e>i&&Y(t,e,a,r,i),t[a+2]=o,n-a>i&&Y(t,a,n,r,i))}function V(t,e,n,r,i,o){let s=i-n,a=o-r;if(0!==s||0!==a){const l=((t-n)*s+(e-r)*a)/(s*s+a*a);l>1?(n=i,r=o):l>0&&(n+=s*l,r+=a*l)}return s=t-n,a=e-r,s*s+a*a}function O(t,e,n,r,i,o){const s={id:null==t?null:t,type:e,geometry:n,tags:r,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};i&&(s.layer=i);return function(t,e){const n=t.geometry,r=t.type;if("Point"===r||"MultiPoint"===r||"LineString"===r)X(t,n,e);else if("Polygon"===r)X(t,n[0],e);else if("MultiLineString"===r)for(const r of n)X(t,r,e);else if("MultiPolygon"===r)for(const r of n)X(t,r[0],e)}(s,o?4:3),s}function X(t,e,n){for(let r=0;r<e.length;r+=n)t.minX=Math.min(t.minX,e[r]),t.minY=Math.min(t.minY,e[r+1]),t.maxX=Math.max(t.maxX,e[r]),t.maxY=Math.max(t.maxY,e[r+1])}function N(t,e,n,r){if(r.layer=e,"FeatureCollection"===n.type)for(let e=0;e<n.features.length;e++)E(t,n.features[e],r,e);else"Feature"===n.type?E(t,n,r):E(t,{geometry:n},r)}function E(t,e,n,r){if(!e.geometry)return;const i=e.geometry.coordinates,o=e.geometry.type,s=Math.pow(n.tolerance/((1<<n.maxZoom)*n.extent),2);let a=[],l=e.id;if(n.promoteId?l=e.properties[n.promoteId]:n.generateId&&(l=r||0),"Point"===o)z(i,a,n);else if("MultiPoint"===o)for(const t of i)z(t,a,n);else if("LineString"===o)$(i,a,s,!1,n);else if("MultiLineString"===o){if(n.lineMetrics){for(const r of i)a=[],$(r,a,s,!1,n),t.push(O(l,"LineString",a,e.properties,n.layer,n.hasAltitude));return}D(i,a,s,!1,n)}else if("Polygon"===o)D(i,a,s,!0,n);else{if("MultiPolygon"!==o){if("GeometryCollection"===o){for(const i of e.geometry.geometries)E(t,{id:l,geometry:i,properties:e.properties},n,r);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const t of i){const e=[];D(t,e,s,!0,n),a.push(e)}}t.push(O(l,o,a,e.properties,n.layer,n.hasAltitude))}function z(t,e,n){e.push(q(t[0]),j(t[1],n.projection),0),n.hasAltitude&&(t.length>2?e.push(t[2]):e.push(0))}function $(t,e,n,r,i){let o,s,a=0;for(let n=0;n<t.length;n++){const l=q(t[n][0]),u=j(t[n][1],i.projection);e.push(l,u,0),i.hasAltitude&&(t[n].length>2?e.push(t[n][2]):e.push(0)),n>0&&(a+=r?(o*u-l*s)/2:Math.sqrt(Math.pow(l-o,2)+Math.pow(u-s,2))),o=l,s=u}const l=i.hasAltitude?4:3,u=e.length-l;e[2]=1,Y(e,0,u,n,l),e[u+2]=1,e.size=Math.abs(a),e.start=0,e.end=e.size}function D(t,e,n,r,i){for(let o=0;o<t.length;o++){const s=[];$(t[o],s,n,r,i),e.push(s)}}function q(t){return t/360+.5}function j(t,e){if("EPSG:4326"===e)return(90-t)/360;const n=Math.sin(t*Math.PI/180),r=.5-.25*Math.log((1+n)/(1-n))/Math.PI;return r<0?0:r>1?1:r}function Z(t,e,n,r,i,o,s,a){if(r/=e,o>=(n/=e)&&s<r)return t;if(s<n||o>=r)return null;const l=[];for(const e of t){const t=e.geometry;let o=e.type;const s=0===i?e.minX:e.minY,u=0===i?e.maxX:e.maxY;if(s>=n&&u<r){l.push(e);continue}if(u<n||s>=r)continue;let h=[];if("Point"===o||"MultiPoint"===o)G(t,h,n,r,i,a.hasAltitude);else if("LineString"===o)U(t,h,n,r,i,!1,a.lineMetrics,a.hasAltitude);else if("MultiLineString"===o)J(t,h,n,r,i,!1,a.hasAltitude);else if("Polygon"===o)J(t,h,n,r,i,!0,a.hasAltitude);else if("MultiPolygon"===o)for(const e of t){const t=[];J(e,t,n,r,i,!0,a.hasAltitude),t.length&&h.push(t)}if(h.length){if(a.lineMetrics&&"LineString"===o){for(const t of h)l.push(O(e.id,o,t,e.tags,e.layer,a.hasAltitude));continue}"LineString"!==o&&"MultiLineString"!==o||(1===h.length?(o="LineString",h=h[0]):o="MultiLineString"),"Point"!==o&&"MultiPoint"!==o||(o=3===h.length?"Point":"MultiPoint"),l.push(O(e.id,o,h,e.tags,e.layer,a.hasAltitude))}}return l.length?l:null}function G(t,e,n,r,i,o){const s=o?4:3;for(let a=0;a<t.length;a+=s){const s=t[a+i];s>=n&&s<=r&&(H(e,t[a],t[a+1],t[a+2]),o&&e.push(t[a+3]))}}function U(t,e,n,r,i,o,s,a){let l=R(t);const u=0===i?W:K;let h,c,f=t.start;const p=a?4:3,d=o?t.length:t.length-p;for(let g=0;g<d;g+=p){const y=t[g],x=t[g+1],m=t[g+2];let v,w,M,b;o&&g===d-p?(v=t[0],w=t[1]):(v=t[g+p],w=t[g+p+1]),a&&(M=t[g+3],b=o&&g===d-p?t[3]:t[g+p+3]);const P=0===i?y:x,_=0===i?v:w;let I=!1;s&&(h=Math.sqrt(Math.pow(y-v,2)+Math.pow(x-w,2))),P<n?_>n&&(c=u(l,y,x,v,w,n),a&&l.push(Q(M,b,c)),s&&(l.start=f+h*c)):P>r?_<r&&(c=u(l,y,x,v,w,r),a&&l.push(Q(M,b,c)),s&&(l.start=f+h*c)):(H(l,y,x,m),a&&l.push(M)),_<n&&P>=n&&(c=u(l,y,x,v,w,n),a&&l.push(Q(M,b,c)),I=!0),_>r&&P<=r&&(c=u(l,y,x,v,w,r),a&&l.push(Q(M,b,c)),I=!0),!o&&I&&(s&&(l.end=f+h*c),e.push(l),l=R(t)),s&&(f+=h)}let g=t.length-p;if(!o){const e=t[g],o=t[g+1],s=t[g+2],u=0===i?e:o;if(u>=n&&u<=r&&H(l,e,o,s),u>=n&&u<=r&&a){const e=t[g+3];l.push(e)}}g=l.length-p,o&&g>=p&&(l[g]!==l[0]||l[g+1]!==l[1])&&(H(l,l[0],l[1],l[2]),a&&l.push(l[3])),l.length&&e.push(l)}function R(t){const e=[];return e.size=t.size,e.start=t.start,e.end=t.end,e}function J(t,e,n,r,i,o,s){for(const a of t)U(a,e,n,r,i,o,!1,s)}function H(t,e,n,r){t.push(e,n,r)}function W(t,e,n,r,i,o){const s=(o-e)/(r-e);return H(t,o,n+(i-n)*s,1),s}function K(t,e,n,r,i,o){const s=(o-n)/(i-n);return H(t,e+(r-e)*s,o,1),s}function Q(t,e,n){return t+(e-t)*n}function tt(t,e,n){const r=[];for(let i=0;i<t.length;i++){const o=t[i],s=o.type;let a;if("Point"===s||"MultiPoint"===s||"LineString"===s)a=et(o.geometry,e,n);else if("MultiLineString"===s||"Polygon"===s){a=[];for(const t of o.geometry)a.push(et(t,e,n))}else if("MultiPolygon"===s){a=[];for(const t of o.geometry){const r=[];for(const i of t)r.push(et(i,e,n));a.push(r)}}r.push(O(o.id,s,a,o.tags,o.layer,n))}return r}function et(t,e,n){const r=[];r.size=t.size,void 0!==t.start&&(r.start=t.start,r.end=t.end);const i=n?4:3;for(let o=0;o<t.length;o+=i)r.push(t[o]+e,t[o+1],t[o+2]),n&&r.push(t[o+3]);return r}function nt(t,e,n){if(t.transformed)return t;const r=1<<t.z,i=t.x,o=t.y,s=n?3:2;for(const a of t.features){const t=a.geometry,l=a.type;if(a.geometry=[],1===l)for(let l=0;l<t.length;l+=s)a.geometry.push(rt(t[l],t[l+1],e,r,i,o)),n&&a.geometry[a.geometry.length-1].push(t[l+2]);else for(let l=0;l<t.length;l++){const u=[];for(let a=0;a<t[l].length;a+=s)u.push(rt(t[l][a],t[l][a+1],e,r,i,o)),n&&u[u.length-1].push(t[l][a+2]);a.geometry.push(u)}}return t.transformed=!0,t}function rt(t,e,n,r,i,o){return[Math.round(n*(t*r-i)),Math.round(n*(e*r-o))]}function it(t,e,n,r,i){const o=e===i.maxZoom?0:i.tolerance/((1<<e)*i.extent),s={features:[],numPoints:0,numSimplified:0,numFeatures:t.length,source:null,x:n,y:r,z:e,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const e of t)ot(s,e,o,i);return s}function ot(t,e,n,r){const i=e.geometry,o=e.type,s=[],a=r.hasAltitude?4:3;if(t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),"Point"===o||"MultiPoint"===o)for(let e=0;e<i.length;e+=a)s.push(i[e],i[e+1]),r.hasAltitude&&s.push(i[e+3]),t.numPoints++,t.numSimplified++;else if("LineString"===o)at(s,i,t,n,!1,!1,r);else if("MultiLineString"===o||"Polygon"===o)for(let e=0;e<i.length;e++)at(s,i[e],t,n,"Polygon"===o,0===e,r);else if("MultiPolygon"===o)for(let e=0;e<i.length;e++){const o=i[e];for(let e=0;e<o.length;e++)at(s,o[e],t,n,!0,0===e,r)}if(s.length){let n=e.tags||null;if("LineString"===o&&r.lineMetrics){n={};for(const t in e.tags)n[t]=e.tags[t];n.mapbox_clip_start=i.start/i.size,n.mapbox_clip_end=i.end/i.size}const a={geometry:s,type:"Polygon"===o||"MultiPolygon"===o?3:"LineString"===o||"MultiLineString"===o?2:1,tags:n};e.layer&&(a.layer=e.layer),null!==e.id&&(a.id=e.id),t.features.push(a)}}function st(t,e,n){return 0===t[e+2]&&t[e+3]>0&&n}function at(t,e,n,r,i,o,s){const a=r*r,{hasAltitude:l,disableFilter:u}=s,h=l?4:3;if(!u&&r>0&&e.size<(i?a:r))return void(n.numPoints+=e.length/h);const c=[];for(let t=0;t<e.length;t+=h)(0===r||e[t+2]>a||st(e,t,l))&&(n.numSimplified++,c.push(e[t],e[t+1]),l&&c.push(e[t+3])),n.numPoints++;i&&function(t,e,n){const r=n?3:2;let i=0;for(let e=0,n=t.length,o=n-r;e<n;o=e,e+=r)i+=(t[e]-t[o])*(t[e+1]+t[o+1]);if(i>0===e){const e=r,i=r-1,o=r-2;for(let s=0,a=t.length;s<a/2;s+=r){const r=t[s],l=t[s+1];let u;n&&(u=t[s+2]),t[s]=t[a-e-s],t[s+1]=t[a-i-s],n&&(t[s+2]=t[a-o-s]),t[a-e-s]=r,t[a-i-s]=l,n&&(t[a-o-s]=u)}}}(c,o,l),t.push(c)}C.getJSON=function(t,e,n){if(T(e)){const t=n;n=e,e=t}const r=function(t,e){const r="string"==typeof e?JSON.parse(e):e||null;n(t,r)};return e&&e.jsonp?C.jsonp(t,r):((e=e||{}).returnJSON=!0,C.get(t,e,r))};const lt={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,hasAltitude:!1,disableFilter:!1,debug:0};class ut{constructor(t,e){const n=(e=this.options=function(t,e){for(const n in e)t[n]=e[n];return t}(Object.create(lt),e)).debug;if(n&&console.time("preprocess data"),e.maxZoom<0||e.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(e.promoteId&&e.generateId)throw new Error("promoteId and generateId cannot be used together.");let r=function(t,e){const n=[];if(Array.isArray(t)){for(let r=0;r<t.length;r++)N(n,t[r].layer,t[r].data,e);return n}if("FeatureCollection"===t.type)for(let r=0;r<t.features.length;r++)E(n,t.features[r],e,r);else"Feature"===t.type?E(n,t,e):E(n,{geometry:t},e);return n}(t,e);this.tiles={},this.tileCoords=[],n&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",e.indexMaxZoom,e.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),r=function(t,e){const n=e.buffer/e.extent;let r=t;const i=Z(t,1,-1-n,n,0,-1,2,e),o=Z(t,1,1-n,2+n,0,-1,2,e);return(i||o)&&(r=Z(t,1,-n,1+n,0,-1,2,e)||[],i&&(r=tt(i,1,e.hasAltitude).concat(r)),o&&(r=r.concat(tt(o,-1,e.hasAltitude)))),r}(r,e),r.length&&this.splitTile(r,0,0,0),n&&(r.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(t,e,n,r,i,o,s){const a=[t,e,n,r],l=this.options,u=l.debug;for(;a.length;){r=a.pop(),n=a.pop(),e=a.pop(),t=a.pop();const h=1<<e,c=ht(e,n,r);let f=this.tiles[c];if(!f&&(u>1&&console.time("creation"),f=this.tiles[c]=it(t,e,n,r,l),this.tileCoords.push({z:e,x:n,y:r}),u)){u>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",e,n,r,f.numFeatures,f.numPoints,f.numSimplified),console.timeEnd("creation"));const t=\`z${UR}e}\`;this.stats[t]=(this.stats[t]||0)+1,this.total++}if(f.source=t,null==i){if(e===l.indexMaxZoom||f.numPoints<=l.indexMaxPoints)continue}else{if(e===l.maxZoom||e===i)continue;if(null!=i){const t=i-e;if(n!==o>>t||r!==s>>t)continue}}if(f.source=null,0===t.length)continue;u>1&&console.time("clipping");const p=.5*l.buffer/l.extent,d=.5-p,g=.5+p,y=1+p;let x=null,m=null,v=null,w=null,M=Z(t,h,n-p,n+g,0,f.minX,f.maxX,l),b=Z(t,h,n+d,n+y,0,f.minX,f.maxX,l);t=null,M&&(x=Z(M,h,r-p,r+g,1,f.minY,f.maxY,l),m=Z(M,h,r+d,r+y,1,f.minY,f.maxY,l),M=null),b&&(v=Z(b,h,r-p,r+g,1,f.minY,f.maxY,l),w=Z(b,h,r+d,r+y,1,f.minY,f.maxY,l),b=null),u>1&&console.timeEnd("clipping"),a.push(x||[],e+1,2*n,2*r),a.push(m||[],e+1,2*n,2*r+1),a.push(v||[],e+1,2*n+1,2*r),a.push(w||[],e+1,2*n+1,2*r+1)}}getTile(t,e,n){t=+t,e=+e,n=+n;const r=this.options,{extent:i,debug:o}=r,{hasAltitude:s,wrapX:a}=r;if(t<0||t>24)return null;if(a){const n=1<<t;e=e+n&n-1}const l=ht(t,e,n);if(this.tiles[l])return nt(this.tiles[l],i,s);o>1&&console.log("drilling down to z%d-%d-%d",t,e,n);let u,h=t,c=e,f=n;for(;!u&&h>0;)h--,c>>=1,f>>=1,u=this.tiles[ht(h,c,f)];return u&&u.source?(o>1&&(console.log("found parent tile z%d-%d-%d",h,c,f),console.time("drilling down")),this.splitTile(u.source,h,c,f,t,e,n),o>1&&console.timeEnd("drilling down"),this.tiles[l]?nt(this.tiles[l],i,s):null):null}}function ht(t,e,n){return 32*((1<<t)*n+e)+t}function ct(t,e,n,r,i,o,s){const a=n&&Array.isArray(n[0]);for(let l=0,u=n.length;l<u;l++){t[e]=(a?n[l][0]:n[l].x)*r,t[e+1]=(a?n[l][1]:n[l].y)*r,s!==Float32Array&&(t[e]=Math.round(t[e]),t[e+1]=Math.round(t[e+1]));let h=i||0;Array.isArray(i)&&(h=i[l]),h=h?Math.round(r*h):0,t[e+2]=h,e+=3,o&&0!==l&&l!==u-1&&(t[e]=t[e-3],t[e+1]=t[e-2],t[e+2]=t[e-1],e+=3)}return t.trySetLength&&t.trySetLength(e),e}function ft(t,e,n,r){const i=t[3*e],o=t[3*e+1],s=t[3*n],a=t[3*n+1];return i===s&&(i<0||i>r)||o===a&&(o<0||o>r)}var pt="undefined"!=typeof Float32Array?Float32Array:Array;function dt(t,e,n,r){return t[0]=e,t[1]=n,t[2]=r,t}function gt(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function yt(t,e,n,r,i){return t[0]=e,t[1]=n,t[2]=r,t[3]=i,t}function xt(t,e,n){return t[0]=e[0]/n[0],t[1]=e[1]/n[1],t[2]=e[2]/n[2],t[3]=e[3]/n[3],t}function mt(t,e,n){return t[0]=e,t[1]=n,t}function vt(t,e){var n=e[0]-t[0],r=e[1]-t[1];return Math.hypot(n,r)}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)}),function(){var t,e=(t=new pt(3),pt!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t)}(),function(){var t,e=(t=new pt(4),pt!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}(),function(){var t,e=(t=new pt(2),pt!=Float32Array&&(t[0]=0,t[1]=0),t)}();const wt=Math.PI/180,Mt=6378137*Math.PI/180,bt=85.0511287798;function Pt(t,e,n){if("EPSG:3857"===n)return function(t,e){const n=bt,r=e[0],i=Math.max(Math.min(n,e[1]),-n);let o;o=0===i?0:Math.log(Math.tan((90+i)*wt/2))/wt;return t[0]=r*Mt,t[1]=o*Mt,t}(t,e);if("EPSG:4326"===n||"EPSG:4490"===n||"identity"===n)return _t(t,e);if("baidu"===n)return _t(t,e);throw new Error("unsupported projection:"+n)}function _t(t,e){return t[0]=e[0],t[1]=e[1],t}function It(t,e,n,r,i,o,s,a,l,u,h,c,f,p,d){0===t?function(t,e,n,r,i,o,s,a,l,u){const h=1/(100*o[0]),c=1/(100*o[1]),f=u&&u[0]||0,p=u&&u[1]||0,d=[0,0];for(let i=t;i<e;i+=3){const t=i/3*2,e=r[i]-f,o=r[i+1]-p;n[t]=d[0]+e/s*h/a,n[t+1]=d[1]-o/s*c/l}}(e,n,r,i,0,s,a,l,u,d):1===t&&function(t,e,n,r,i,o,s,a,l,u,h){if(!t)return;let c,f,p,d;0===t[4]?(c=t[0],f=t[1],p=t[2],d=t[3]):(c=t[1],f=t[2],p=t[3],d=t[0]);const g=vt(c,f),y=vt(f,p),x=[],m=[],v=[];for(let t=e;t<n;t+=3){const e=t/3*2;mt(x,(o.x/l+i[t]/s)*a,o.y/l*a+(h?i[t+1]:-i[t+1])/s*a),"EPSG:4326"!==u&&"EPSG:4490"!==u||Pt(x,x,"EPSG:3857"),At(m,x,c,f),At(v,x,d,c),r[e]=vt(c,m)/g,r[e+1]=vt(c,v)/y}}(h,e,n,r,i,o,a,c,f,p,!!d)}function At(t,e,n,r){const i=n[0]-r[0],o=n[1]-r[1];let s=(e[0]-n[0])*(n[0]-r[0])+(e[1]-n[1])*(n[1]-r[1]);return s/=i*i+o*o,t[0]=n[0]+s*i,t[1]=n[1]+s*o,t}function St(t,e,n,r,i){const o=3*e[n-1],s=3*e[n-1]+1,a=t[o],l=t[s];return u=r,h=i,c=a,f=l,Math.sqrt((c-u)*(c-u)+(f-h)*(f-h));var u,h,c,f}function Tt(t,e,n=2){const r=e&&e.length,i=r?e[0]*n:t.length;let o=Ft(t,0,i,n,!0);const s=[];if(!o||o.next===o.prev)return s;let a,l,u;if(r&&(o=function(t,e,n,r){const i=[];for(let n=0,o=e.length;n<o;n++){const s=Ft(t,e[n]*r,n<o-1?e[n+1]*r:t.length,r,!1);s===s.next&&(s.steiner=!0),i.push(zt(s))}i.sort(Ot);for(let t=0;t<i.length;t++)n=Xt(i[t],n);return n}(t,e,o,n)),t.length>80*n){a=1/0,l=1/0;let e=-1/0,r=-1/0;for(let o=n;o<i;o+=n){const n=t[o],i=t[o+1];n<a&&(a=n),i<l&&(l=i),n>e&&(e=n),i>r&&(r=i)}u=Math.max(e-a,r-l),u=0!==u?32767/u:0}return Lt(o,s,n,a,l,u,0),s}function Ft(t,e,n,r,i){let o;if(i===function(t,e,n,r){let i=0;for(let o=e,s=n-r;o<n;o+=r)i+=(t[s]-t[o])*(t[o+1]+t[s+1]),s=o;return i}(t,e,n,r)>0)for(let i=e;i<n;i+=r)o=Wt(i/r|0,t[i],t[i+1],o);else for(let i=n-r;i>=e;i-=r)o=Wt(i/r|0,t[i],t[i+1],o);return o&&Zt(o,o.next)&&(Kt(o),o=o.next),o}function kt(t,e){if(!t)return t;e||(e=t);let n,r=t;do{if(n=!1,r.steiner||!Zt(r,r.next)&&0!==jt(r.prev,r,r.next))r=r.next;else{if(Kt(r),r=e=r.prev,r===r.next)break;n=!0}}while(n||r!==e);return e}function Lt(t,e,n,r,i,o,s){if(!t)return;!s&&o&&function(t,e,n,r){let i=t;do{0===i.z&&(i.z=Et(i.x,i.y,e,n,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==t);i.prevZ.nextZ=null,i.prevZ=null,function(t){let e,n=1;do{let r,i=t;t=null;let o=null;for(e=0;i;){e++;let s=i,a=0;for(let t=0;t<n&&(a++,s=s.nextZ,s);t++);let l=n;for(;a>0||l>0&&s;)0!==a&&(0===l||!s||i.z<=s.z)?(r=i,i=i.nextZ,a--):(r=s,s=s.nextZ,l--),o?o.nextZ=r:t=r,r.prevZ=o,o=r;i=s}o.nextZ=null,n*=2}while(e>1)}(i)}(t,r,i,o);let a=t;for(;t.prev!==t.next;){const l=t.prev,u=t.next;if(o?Ct(t,r,i,o):Bt(t))e.push(l.i,t.i,u.i),Kt(t),t=u.next,a=u.next;else if((t=u)===a){s?1===s?Lt(t=Yt(kt(t),e),e,n,r,i,o,2):2===s&&Vt(t,e,n,r,i,o):Lt(kt(t),e,n,r,i,o,1);break}}}function Bt(t){const e=t.prev,n=t,r=t.next;if(jt(e,n,r)>=0)return!1;const i=e.x,o=n.x,s=r.x,a=e.y,l=n.y,u=r.y,h=Math.min(i,o,s),c=Math.min(a,l,u),f=Math.max(i,o,s),p=Math.max(a,l,u);let d=r.next;for(;d!==e;){if(d.x>=h&&d.x<=f&&d.y>=c&&d.y<=p&&Dt(i,a,o,l,s,u,d.x,d.y)&&jt(d.prev,d,d.next)>=0)return!1;d=d.next}return!0}function Ct(t,e,n,r){const i=t.prev,o=t,s=t.next;if(jt(i,o,s)>=0)return!1;const a=i.x,l=o.x,u=s.x,h=i.y,c=o.y,f=s.y,p=Math.min(a,l,u),d=Math.min(h,c,f),g=Math.max(a,l,u),y=Math.max(h,c,f),x=Et(p,d,e,n,r),m=Et(g,y,e,n,r);let v=t.prevZ,w=t.nextZ;for(;v&&v.z>=x&&w&&w.z<=m;){if(v.x>=p&&v.x<=g&&v.y>=d&&v.y<=y&&v!==i&&v!==s&&Dt(a,h,l,c,u,f,v.x,v.y)&&jt(v.prev,v,v.next)>=0)return!1;if(v=v.prevZ,w.x>=p&&w.x<=g&&w.y>=d&&w.y<=y&&w!==i&&w!==s&&Dt(a,h,l,c,u,f,w.x,w.y)&&jt(w.prev,w,w.next)>=0)return!1;w=w.nextZ}for(;v&&v.z>=x;){if(v.x>=p&&v.x<=g&&v.y>=d&&v.y<=y&&v!==i&&v!==s&&Dt(a,h,l,c,u,f,v.x,v.y)&&jt(v.prev,v,v.next)>=0)return!1;v=v.prevZ}for(;w&&w.z<=m;){if(w.x>=p&&w.x<=g&&w.y>=d&&w.y<=y&&w!==i&&w!==s&&Dt(a,h,l,c,u,f,w.x,w.y)&&jt(w.prev,w,w.next)>=0)return!1;w=w.nextZ}return!0}function Yt(t,e){let n=t;do{const r=n.prev,i=n.next.next;!Zt(r,i)&&Gt(r,n,n.next,i)&&Jt(r,i)&&Jt(i,r)&&(e.push(r.i,n.i,i.i),Kt(n),Kt(n.next),n=t=i),n=n.next}while(n!==t);return kt(n)}function Vt(t,e,n,r,i,o){let s=t;do{let t=s.next.next;for(;t!==s.prev;){if(s.i!==t.i&&qt(s,t)){let a=Ht(s,t);return s=kt(s,s.next),a=kt(a,a.next),Lt(s,e,n,r,i,o,0),void Lt(a,e,n,r,i,o,0)}t=t.next}s=s.next}while(s!==t)}function Ot(t,e){let n=t.x-e.x;if(0===n&&(n=t.y-e.y,0===n)){n=(t.next.y-t.y)/(t.next.x-t.x)-(e.next.y-e.y)/(e.next.x-e.x)}return n}function Xt(t,e){const n=function(t,e){let n=e;const r=t.x,i=t.y;let o,s=-1/0;if(Zt(t,n))return n;do{if(Zt(t,n.next))return n.next;if(i<=n.y&&i>=n.next.y&&n.next.y!==n.y){const t=n.x+(i-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(t<=r&&t>s&&(s=t,o=n.x<n.next.x?n:n.next,t===r))return o}n=n.next}while(n!==e);if(!o)return null;const a=o,l=o.x,u=o.y;let h=1/0;n=o;do{if(r>=n.x&&n.x>=l&&r!==n.x&&$t(i<u?r:s,i,l,u,i<u?s:r,i,n.x,n.y)){const e=Math.abs(i-n.y)/(r-n.x);Jt(n,t)&&(e<h||e===h&&(n.x>o.x||n.x===o.x&&Nt(o,n)))&&(o=n,h=e)}n=n.next}while(n!==a);return o}(t,e);if(!n)return e;const r=Ht(n,t);return kt(r,r.next),kt(n,n.next)}function Nt(t,e){return jt(t.prev,t,e.prev)<0&&jt(e.next,t,t.next)<0}function Et(t,e,n,r,i){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-n)*i|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-r)*i|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function zt(t){let e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function $t(t,e,n,r,i,o,s,a){return(i-s)*(e-a)>=(t-s)*(o-a)&&(t-s)*(r-a)>=(n-s)*(e-a)&&(n-s)*(o-a)>=(i-s)*(r-a)}function Dt(t,e,n,r,i,o,s,a){return!(t===s&&e===a)&&$t(t,e,n,r,i,o,s,a)}function qt(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){let n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&Gt(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&(Jt(t,e)&&Jt(e,t)&&function(t,e){let n=t,r=!1;const i=(t.x+e.x)/2,o=(t.y+e.y)/2;do{n.y>o!=n.next.y>o&&n.next.y!==n.y&&i<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next}while(n!==t);return r}(t,e)&&(jt(t.prev,t,e.prev)||jt(t,e.prev,e))||Zt(t,e)&&jt(t.prev,t,t.next)>0&&jt(e.prev,e,e.next)>0)}function jt(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function Zt(t,e){return t.x===e.x&&t.y===e.y}function Gt(t,e,n,r){const i=Rt(jt(t,e,n)),o=Rt(jt(t,e,r)),s=Rt(jt(n,r,t)),a=Rt(jt(n,r,e));return i!==o&&s!==a||(!(0!==i||!Ut(t,n,e))||(!(0!==o||!Ut(t,r,e))||(!(0!==s||!Ut(n,t,r))||!(0!==a||!Ut(n,e,r)))))}function Ut(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function Rt(t){return t>0?1:t<0?-1:0}function Jt(t,e){return jt(t.prev,t,t.next)<0?jt(t,e,t.next)>=0&&jt(t,t.prev,e)>=0:jt(t,e,t.prev)<0||jt(t,t.next,e)<0}function Ht(t,e){const n=Qt(t.i,t.x,t.y),r=Qt(e.i,e.x,e.y),i=t.next,o=e.prev;return t.next=e,e.prev=t,n.next=i,i.prev=n,r.next=n,n.prev=r,o.next=r,r.prev=o,r}function Wt(t,e,n,r){const i=Qt(t,e,n);return r?(i.next=r.next,i.prev=r,r.next.prev=i,r.next=i):(i.prev=i,i.next=i),i}function Kt(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function Qt(t,e,n){return{i:t,x:e,y:n,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}const te="__fea_idx";new Float32Array([-1e12])[0];const ee="ispace_ombb";function ne(){return function(){if("undefined"!=typeof undefinedThis)return globalThis;if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof undefined)return global;throw new Error("unable to locate global object")}().ispace_vt_packers}const{PackUtil:re,ArrayPool:ie}=ne();function oe(t,e,n,r,i,o,s,a,l,u,h,c,f,p,d,g,y){const x=e.getLength(),m=i/3;for(let n=2,r=x;n<r;n+=3)t[i+n-2]=e[n-2],t[i+n-1]=e[n-1],t[i+n-0]=e[n]-s;i+=x;for(let n=2,r=x;n<r;n+=3)t[i+n-2]=e[n-2],t[i+n-1]=e[n-1],t[i+n-0]=e[n]-a;i+=x,t.trySetLength(i+x),t.copyWithin(i,i-2*x,i-x),i+=x,t.trySetLength(i+x),t.copyWithin(i,i-2*x,i-x),i+=x,(n=n||[]).push(x/3);const v=n.getLength();for(let e=0;e<v;e++){se(m+(n[e-1]||0),m+n[e],t,x/3,l,r,u,h,c,f,o,p,d,g,y)}return i}function se(t,e,n,r,i,o,s,a,l,u,h,c,f,p,d){const g=o.getLength();let y,x;for(let s=t,a=e;s<a-1;s++)if(y=s,x=s+1,i===1/0||!ft(n,y,x,i))if((s-t)%2==1&&(y+=2*r,x+=2*r),d){let t=o.currentIndex;o[t++]=y+r,o[t++]=x,o[t++]=y,o[t++]=x+r,o[t++]=x,o[t++]=y+r,o.currentIndex=t}else{let t=o.currentIndex;o[t++]=y+r,o[t++]=y,o[t++]=x,o[t++]=x,o[t++]=x+r,o[t++]=y+r,o.currentIndex=t}s&&function(t,e,n,r,i,o,s,a,l,u,h,c){let f,p=0,d=0,g=0,y=0;const x=c?[1,3,4]:[2,3,4];for(let c=o.getLength()-1;c>=s;c--){const s=o[c],m=3*s+1,v=3*s+2,w=i[3*s],M=i[m],b=i[v];p||d||(p=Math.max(i[v],i[3*o[c-3]+2]),d=Math.min(i[v],i[3*o[c-3]+2]),f=p-d);let P=g;const _=c%6;0===t?(5===_&&(y=St(i,o,c,w,M)),P=_===x[0]||_===x[1]||_===x[2]?g:g+y):1===t&&(_===x[0]||_===x[1]||_===x[2]?P=0:5===_?(y=St(i,o,c,w,M),P=y):P=y);const I=P/u*(1/(100*h))/a;let A;A=1===e?b===p?1:0:"bottom"===n?b===p?f/100/l:0:b===p?0:-f/100/l,r[2*s]=I,r[2*s+1]=A,0===_&&(g+=y)}}(a,l,u,h,n,o,g,c[0],c[1],f,p,d)}function ae(t){const e=[t[0]];let n=t[0];for(let r=1;r<t.length;r++)Array.isArray(t[r])?t[r][0]===n[0]&&t[r][1]===n[1]&&t[r][2]===n[2]||e.push(t[r]):t[r].x===n.x&&t[r].y===n.y&&t[r].z===n.z||e.push(t[r]),n=t[r];return e}var le="undefined"!=typeof Float32Array?Float32Array:Array;function ue(){var t=new le(3);return le!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function he(t,e,n){var r=new le(3);return r[0]=t,r[1]=e,r[2]=n,r}function ce(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function fe(t,e,n,r){return t[0]=e,t[1]=n,t[2]=r,t}function pe(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t}function de(t,e){var n=e[0],r=e[1],i=e[2],o=n*n+r*r+i*i;return o>0&&(o=1/Math.sqrt(o),t[0]=e[0]*o,t[1]=e[1]*o,t[2]=e[2]*o),t}function ge(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function ye(t,e,n){var r=e[0],i=e[1],o=e[2],s=n[0],a=n[1],l=n[2];return t[0]=i*l-o*a,t[1]=o*s-r*l,t[2]=r*a-i*s,t}var xe=function(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t};function me(){var t=new le(4);return le!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function ve(t,e){var n=e[0]+e[4]+e[8],r=void 0;if(n>0)r=Math.sqrt(n+1),t[3]=.5*r,r=.5/r,t[0]=(e[5]-e[7])*r,t[1]=(e[6]-e[2])*r,t[2]=(e[1]-e[3])*r;else{var i=0;e[4]>e[0]&&(i=1),e[8]>e[3*i+i]&&(i=2);var o=(i+1)%3,s=(i+2)%3;r=Math.sqrt(e[3*i+i]-e[3*o+o]-e[3*s+s]+1),t[i]=.5*r,r=.5/r,t[3]=(e[3*o+s]-e[3*s+o])*r,t[o]=(e[3*o+i]+e[3*i+o])*r,t[s]=(e[3*s+i]+e[3*i+s])*r}return t}!function(){var t=ue()}(),function(){var t,e=(t=new le(4),le!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}();var we,Me=function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t},be=function(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],s=n*n+r*r+i*i+o*o;return s>0&&(s=1/Math.sqrt(s),t[0]=n*s,t[1]=r*s,t[2]=i*s,t[3]=o*s),t};ue(),he(1,0,0),he(0,1,0),me(),me(),we=new le(9),le!=Float32Array&&(we[1]=0,we[2]=0,we[3]=0,we[5]=0,we[6]=0,we[7]=0),we[0]=1,we[4]=1,we[8]=1;\n/*!\n     * Contains code from google filament\n     * https://github.com/google/filament/\n     * License Apache-2.0\n     */\nconst Pe=8,_e=[],Ie=[],Ae=[],Se=[];function Te(t,e,n){const r=ye(Ie,e,n),i=function(t,e,n,r,i,o,s,a,l,u){return t[0]=e,t[1]=n,t[2]=r,t[3]=i,t[4]=o,t[5]=s,t[6]=a,t[7]=l,t[8]=u,t}(_e,n[0],n[1],n[2],...r,...e);t=ve(t,i),t=function(t){return t[3]<0?Me(t,t,-1):t}(t=be(t,t));const o=1/((1<<2*Pe-1)-1);if(t[3]<o){t[3]=o;const e=Math.sqrt(1-o*o);t[0]*=e,t[1]*=e,t[2]*=e}const s=n[3]>0?ye(Ae,n,e):ye(Ae,e,n);return ge(ye(Se,n,e),s)<0&&Me(t,t,-1),t}const Fe=[];const ke=[],Le=[],Be=[],Ce=[],Ye=[],Ve=[],Oe=[];function Xe(t,e,n,r,i,o){fe(Ce,t[3*e],t[3*e+1],t[3*e+2]),fe(Ye,t[3*n],t[3*n+1],t[3*n+2]),fe(Ve,t[3*r],t[3*r+1],t[3*r+2]);const s=xe(ke,Ve,Ye),a=xe(Le,Ce,Ye),l=ye(Be,s,a);de(Oe,l),i[3*e]=i[3*e]||0,i[3*n]=i[3*n]||0,i[3*r]=i[3*r]||0,i[3*e+1]=i[3*e+1]||0,i[3*n+1]=i[3*n+1]||0,i[3*r+1]=i[3*r+1]||0,i[3*e+2]=i[3*e+2]||0,i[3*n+2]=i[3*n+2]||0,i[3*r+2]=i[3*r+2]||0,i[3*e]+=Oe[0],i[3*n]+=Oe[0],i[3*r]+=Oe[0],i[3*e+1]+=Oe[1],i[3*n+1]+=Oe[1],i[3*r+1]+=Oe[1],i[3*e+2]+=Oe[2],i[3*n+2]+=Oe[2],i[3*r+2]+=Oe[2],o[e]+=1,o[n]+=1,o[r]+=1}\n/*!\n     * Contains code from THREE.JS\n     * https://github.com/mrdoob/three.js/\n     * License MIT\n     * \n     * Generate tangents per vertex.\n     */function Ne(t,e,n){return t[0]=e[n],t[1]=e[n+1],t[2]=e[n+2],t}function Ee(t,e,n){return t[0]=e[n],t[1]=e[n+1],t}const{StyleUtil:ze,PackUtil:$e,ArrayPool:De}=ne(),qe=De.getInstance();function je(t,e,n,r,i,o,s,a,l,u,h,c,f,p,d,g){void 0===e.top&&(e.top=!0),void 0===e.side&&(e.side=!0),qe.reset();const{altitudeScale:y,altitudeProperty:x,defaultAltitude:m,heightProperty:v,minHeightProperty:P,defaultHeight:_,tangent:I,uv:A,topUVMode:T,sideUVMode:F,sideVerticalUVMode:k,top:B,side:C,textureYOrigin:Y,topThickness:V}=e,O=function(t,e,{altitudeScale:n,altitudeProperty:r,defaultAltitude:i,heightProperty:o,minHeightProperty:s,defaultHeight:a},{center:l,side:u,top:h,topThickness:c,uvOrigin:f,uv:p,uvSize:d,topUVMode:g,sideUVMode:y,sideVerticalUVMode:x,textureYOrigin:m,tileRatio:v,centimeterToPoint:w,verticalCentimeterToPoint:M,positionType:b,res:P,glScale:_,projectionCode:I},A,T){let F=e/t[0].extent;e===1/0&&(F=1);const k=e===1/0,L=T.get(),B=T.get(),C=T.get(),Y=T.getProxy(),V=T.get(),O=T.get(),X=T.get(),N=!!p,E=!!h,z=!!u,$=N?T.get():null;function D(t,n,r,i,o,s){let a=n;if(E){const u=Tt(Y,r,3);if(0===u.length)return n;let h=Y.getLength(),p=V.currentIndex;for(let t=0;t<h;t++)V[p++]=Y[t];if(V.currentIndex=p,n+=Y.getLength(),s)for(let e=2,n=u.length;e<n;e+=3)u[e]+=t/3,u[e-1]+=t/3,u[e-2]+=t/3;else{let e;for(let n=2,r=u.length;n<r;n+=3)e=u[n-1],u[n-1]=u[n]+t/3,u[n]=e+t/3,u[n-2]+=t/3}h=u.length,p=O.currentIndex;for(let t=0;t<h;t++)O[p++]=u[t];O.currentIndex=p,N&&It(g||0,t,n,$,V,f,w,v,d[0],d[1],o,P,_,I,l),c>0&&!z&&(n=oe(V,Y,r,O,n,$,0,c,e,N,y||0,x||0,m,d,v,M,i<0?!s:s)),X.setLength(n/3),X.fill(1,a/3,n/3)}if(z){E&&(c=0),a=n,n=oe(V,Y,r,O,n,$,c,i,e,N,y||0,x||0,m,d,v,M,i<0?!s:s),X.setLength(n/3);const t=Y.getLength()/3;X.fill(1,a/3,a/3+t),X.fill(0,a/3+t,a/3+2*t),X.fill(1,a/3+2*t,a/3+3*t),X.fill(0,a/3+3*t,n/3)}return n}let q=-1/0,j=1/0,Z=0;const G=[-1,-1,e+1,e+1];let U=0,R=t.length;S(A)&&(U=A,R=A+1);let J=0,H=!1;const W=T.getProxy();let K=!1;for(;U<R;U++){const l=t[U],u=l.id;S(u)&&(Math.abs(u)>J&&(J=Math.abs(u)),u<0&&(H=!0));const h=l.geometry,c=l.properties[ee];let f=Array.isArray(c&&c[0]&&c[0][0])?c[0]:c;const{altitude:p,height:d}=re.getFeaAltitudeAndHeight(l,n,r,i,o,a,s);d<0?(K=!0,j=Math.min(p,j),q=Math.max(p-d,q)):(q=Math.max(p,q),j=Math.min(p-d,j));const g=V.getLength();let y=0,x=Z;W.setLength(0),Y.setLength(0);const m=re.calculateSignedArea(h[0])<0;for(let t=0,n=h.length;t<n;t++){let r=h[t];m&&(r=r.reverse()),r=ae(r);const i=re.calculateSignedArea(r)<0;if(!i&&t>0&&(y++,f=c&&c[y],Z=D(x,Z,W,d*F,f,k),Y.setLength(0),W.setLength(0),x=Z),e!==1/0&&(r=re.clipPolygon(r,G)),!r.length){t===n-1&&(Z=D(x,Z,W,d*F,f,k));continue}const o=r.length;if(Array.isArray(r[0])?r[0][0]===r[o-1][0]&&r[0][1]===r[o-1][1]||r.push([r[0][0],r[0][1]]):r[0].x===r[o-1].x&&r[0].y===r[o-1].y||r.push(r[0]),i){let t=W.currentIndex;W[t++]=Y.getLength()/3,W.currentIndex=t}ct(Y,Y.getLength(),r,F,p,!1,b),t===n-1&&(Z=D(x,Z,W,d*F,f,k))}const v=V.getLength()-g,w=(te+"").trim();for(let t=0;t<v/3;t++){let t=B.currentIndex;B[t++]=void 0===l[w]?U:l[w],B.currentIndex=t,t=L.currentIndex,L[t++]=U,L.currentIndex=t,S(u)&&(t=C.currentIndex,C[t++]=u,C.currentIndex=t)}}const Q=re.getUnsignedArrayType(B.getLength()?B[B.getLength()-1]:0),tt={hasNegativeHeight:K,maxAltitude:q===-1/0?0:q,minAltitude:j===1/0?0:j,vertices:V,verticeTypes:X,indices:O,pickingIds:ie.createTypedArray(B,Q),featureIndexes:L};if(C.getLength()){const t=H?re.getPosArrayType(J):re.getUnsignedArrayType(J);tt.featureIds=ie.createTypedArray(C,t)}else tt.featureIds=[];return $&&($.setLength(V.getLength()/3*2),tt.uvs=$),tt}(t,n,{altitudeScale:y,altitudeProperty:x,defaultAltitude:m||0,heightProperty:v,minHeightProperty:P,defaultHeight:_||0},{center:g,top:B,side:C,topThickness:10*V||0,uv:A||I,uvSize:[i,i],uvOrigin:r,topUVMode:T,sideUVMode:F,sideVerticalUVMode:k,textureYOrigin:Y,tileRatio:a,centimeterToPoint:l,verticalCentimeterToPoint:u,positionType:d,res:o,glScale:s,projectionCode:f},p,qe),X=[],N=O.vertices.getLength()/3,E=$e.getIndexArrayType(N),z=De.createTypedArray(O.indices,E);delete O.indices,X.push(z.buffer,O.pickingIds.buffer);const $=Math.max(Math.abs(O.maxAltitude),Math.abs(O.minAltitude)),D=$e.getPosArrayType(Math.max(512,$));O.vertices=De.createTypedArray(O.vertices,D);const q=I?qe.getProxy():new Float32Array(3*N);q.setLength&&q.setLength(3*N);const j=function(t,e,n){const r=n||[];r.setLength&&r.setLength(t.length);const i=Fe;i.length<t.length/3&&(i.length=t.length/3),i.fill(0,0,t.length/3);const o=void 0===e.length?e:e.length;for(let n=0;n<o/3;n++)void 0===e.length?Xe(t,3*n,3*n+1,3*n+2,r,i):Xe(t,e[3*n],e[3*n+1],e[3*n+2],r,i);for(let t=0;t<r.length;t+=3){const e=i[t/3];0!==e?(r[t]/=e,r[t+1]/=e,r[t+2]/=e):(r[t]=0,r[t+1]=0,r[t+2]=0)}return r}(O.vertices,z,q);let Z=!0;const G=j.getLength?j.getLength():j.length;for(let t=0;t<G;t++){j[t]=-j[t];const e=j[t]%1;1-Math.abs(e)>1e-6?Z=!1:0!==e&&(j[t]=Math.round(j[t]))}if(O.normals=j,I){let t=qe.get();t.setLength(4*N),t=function(t,e,n,r,i){const o=t.length/3,s=i||new Array(4*o),a=[],l=[];for(let t=0;t<o;t++)a[t]=[0,0,0],l[t]=[0,0,0];const u=[0,0,0],h=[0,0,0],c=[0,0,0],f=[0,0],p=[0,0],d=[0,0],g=[0,0,0],y=[0,0,0];function x(e,r,i){Ne(u,t,3*e),Ne(h,t,3*r),Ne(c,t,3*i),Ee(f,n,2*e),Ee(p,n,2*r),Ee(d,n,2*i);const o=h[0]-u[0],s=c[0]-u[0],x=h[1]-u[1],m=c[1]-u[1],v=h[2]-u[2],w=c[2]-u[2],M=p[0]-f[0],b=d[0]-f[0],P=p[1]-f[1],_=d[1]-f[1],I=1/(M*_-b*P);fe(g,(_*o-P*s)*I,(_*x-P*m)*I,(_*v-P*w)*I),fe(y,(M*s-b*o)*I,(M*m-b*x)*I,(M*w-b*v)*I),pe(a[e],a[e],g),pe(a[r],a[r],g),pe(a[i],a[i],g),pe(l[e],l[e],y),pe(l[r],l[r],y),pe(l[i],l[i],y)}for(let t=0,e=r.length;t<e;t+=3)x(r[t+0],r[t+1],r[t+2]);const m=[],v=[],w=[],M=[];let b,P,_;function I(t){Ne(w,e,3*t),ce(M,w),P=a[t],ce(m,P),xe(m,m,function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}(w,w,ge(w,P))),de(m,m),ye(v,M,P),_=ge(v,l[t]),b=_<0?-1:1,s[4*t]=m[0],s[4*t+1]=m[1],s[4*t+2]=m[2],s[4*t+3]=b}for(let t=0,e=r.length;t<e;t+=3)I(r[t+0]),I(r[t+1]),I(r[t+2]);return s}(O.vertices,O.normals,O.uvs,z,t),t=function(t,e){const n=e.getLength(),r=new Float32Array(n),i=[],o=[],s=[];for(let a=0;a<n;a+=4){const n=a/4*3;dt(o,t[n]||0,t[n+1]||0,t[n+2]||0),yt(i,e[a]||0,e[a+1]||0,e[a+2]||0,e[a+3]||0),Te(s,o,i),gt(r.subarray(a,a+4),s)}return r}(O.normals,t),O.tangents=t,X.push(t.buffer),delete O.normals}if(O.normals&&(Z&&(O.normals=De.createTypedArray(O.normals,Int8Array)),X.push(O.normals.buffer)),O.uvs){const t=O.uvs;O.uvs=De.createTypedArray(t,Float32Array),X.push(O.uvs.buffer)}const U=function(t,e,n,r){const i={},o={},s=r.getLength();if(L(e.polygonFill)){let a=M(e.polygonFill);const l=new Uint8Array(4*s);l.fill(255);for(let e=0;e<s;e++){const o=t[r[e]],s=o.properties||{};s.$layer=o.layer,s.$type=o.type;let u=a(n,s);w(u)&&(i.aColor=1,a=M(u),u=a(n,s)),delete s.$layer,delete s.$type,ze.normalizeColor(Ze,u),l[4*e]=Ze[0],l[4*e+1]=Ze[1],l[4*e+2]=Ze[2],l[4*e+3]=Ze[3]}o.aColor=l}if(L(e.polygonOpacity)){let a=b(e.polygonOpacity,"exponential");const l=new Uint8Array(s);l.fill(255);for(let e=0;e<s;e++){const o=t[r[e]],s=o.properties||{};s.$layer=o.layer,s.$type=o.type;let u=a(n,s);w(u)&&(i.aOpacity=1,a=M(u),u=a(n,s)),delete s.$layer,delete s.$type,l[e]=255*u}o.aOpacity=l}return o.dynamicAttributes=i,o}(t,h,c,O.featureIndexes),R=function(t,e,n,r,i){const o=[[],[]],s=L(r.topPolygonFill),a=L(r.bottomPolygonFill),l=[255,255,255,255],u=e.getLength();if(s||a){let h=s&&M(r.topPolygonFill),c=a&&M(r.bottomPolygonFill),f=null,p=null,d=null,g=null;for(let r=0;r<u;r++){if(1===t[r]&&!s||0===t[r]&&!a)continue;const u=1===t[r];if(u&&e[r]===f){t[r]=d;continue}if(!u&&e[r]===p){t[r]=g;continue}const y=n[e[r]],x=y.properties||{};x.$layer=y.layer,x.$type=y.type;let m=u?h:c,v=m(i,x);w(v)&&(m=M(v),v=m(i,x)),delete x.$layer,delete x.$type,ze.normalizeColor(Ze,v),xt(Ze,Ze,l);let b=Ge(o,Ze);b<0&&(b=o.length,o.push(gt([],Ze))),t[r]=b,u?(f=e[r],d=b):(p=e[r],g=b)}}return o.slice(2)}(O.verticeTypes,O.featureIndexes,t,h,c),J={data:{data:{aVertexColorType:R.length<=252?De.createTypedArray(O.verticeTypes,Uint8Array):De.createTypedArray(O.verticeTypes,Uint16Array),aPosition:O.vertices,aNormal:O.normals,aTexCoord0:O.uvs,aTangent:O.tangents,aPickingId:O.pickingIds},indices:z,properties:{maxAltitude:O.maxAltitude/100,minAltitude:O.minAltitude/100,hasNegativeHeight:O.hasNegativeHeight},dynamicAttributes:U.dynamicAttributes,vertexColors:R},buffers:X};return O.featureIds.length?(J.data.featureIds=O.featureIds,X.push(J.data.featureIds.buffer)):J.data.featureIds=[],U.aColor&&(J.data.data.aColor=U.aColor,J.buffers.push(U.aColor.buffer)),U.aOpacity&&(J.data.data.aOpacity=U.aOpacity,J.buffers.push(U.aOpacity.buffer)),J.buffers.push(J.data.data.aPosition.buffer),J.data.pickingIdIndiceMap=$e.generatePickingIndiceIndex(J.data.data.aPickingId,J.data.indices),J}const Ze=[];function Ge(t,e){for(let i=0;i<t.length;i++)if(n=e,r=t[i],n[0]===r[0]&&n[1]===r[1]&&n[2]===r[2]&&n[3]===r[3])return i;var n,r;return-1}const{PackUtil:Ue,StyleUtil:Re,FilterUtil:Je}=ne();function He(t,e,n,r,{altitudeScale:i,altitudeProperty:o,defaultAltitude:s,heightProperty:a,minHeightProperty:l,defaultHeight:u,bottom:h}){const c=h,f=e/t[0].extent,p=2*function(t,e){let n=0;for(let e=0,r=t.length;e<r;e++){const r=t[e];if(S(r.geometry[0][0]))n+=3*r.geometry.length;else for(let t=0,e=r.geometry.length;t<e;t++){let e=3*r.geometry[t].length;3===r.type&&(e-=3),n+=e}}return n}(t)+3*t.length*2,d=[],g=new Int16Array(p),y=new Uint8Array(g.length/3*4);w(n)&&(n=Je.compileFilter(n));const x=[];function m(t,n,r){const i=n-t,o=g.subarray(t,n),s=g.subarray(n,n+i);s.set(o);for(let t=2,e=s.length;t<e;t+=3)s[t]=o[t]-r;const a=t/3,l=i/3;let u,h;for(let t=a,n=l+a;t<n;t++)t<n-1?(u=t,h=t+1):(u=t,h=a),ft(g,u,h,e)||(x.push(u,h),c&&x.push(u+l,h+l),We(g,u,e)||x.push(u,u+l));return n+i}let v=0,M=-1/0,b=1/0;const P=(te+"").trim(),_=[];for(let e=0,h=t.length;e<h;e++){const h=t[e],c=h.geometry;if(n){let t;t="function"==typeof n?n(h&&h.properties):n,Re.normalizeColor(_,t)}else dt(_,255,255,255);const p=v/3*4,{altitude:w,height:I}=Ue.getFeaAltitudeAndHeight(h,i,o,s,a,u,l);I<0?(b=Math.min(w,b),M=Math.max(w-I,M)):(b=Math.min(w-I,b),M=Math.max(w,M));let A=v;for(let t=0,e=c.length;t<e;t++){let e=c[t];const n=e.length;e[0][0]===e[n-1][0]&&e[0][1]===e[n-1][1]&&(e=e.slice(0,n-1)),v=ct(g,A,e,f,w),v=m(A,v,I*f),A=v}const S=A/3*4;for(let t=p;t<S;t+=4)y[t]=_[0],y[t+1]=_[1],y[t+2]=_[2],y[t+3]=255*(r||1);const T=x.length-d.length;for(let t=0;t<T;t++)d.push(h[P])}const I=x.reduce(((t,e)=>Math.max(t,e)),0),A=new(Ue.getIndexArrayType(I))(x),T=Ue.getUnsignedArrayType(t.length),F=Math.max(Math.abs(M,Math.abs(b)));return{aPosition:new(Ue.getPosArrayType(Math.max(512,F)))(g),indices:A,aPickingId:new T(d),aColor:y,maxAltitude:M===-1/0?0:M/100,minAltitude:b===1/0?0:b/100}}function We(t,e,n){const r=t[3*e],i=t[3*e+1];return r<0||r>n||i<0||i>n}function Ke(t,e,n,r){const i=He(t,e,n.lineColor,n.lineOpacity,r),{minAltitude:o,maxAltitude:s}=i;delete i.minAltitude,delete i.maxAltitude;const a=[i.aPosition.buffer,i.indices.buffer,i.aPickingId.buffer],l=i.indices;return delete i.indices,{data:{data:i,properties:{minAltitude:o,maxAltitude:s},indices:l},buffers:a}}\n/*!\n        Feature Filter by\n\n        (c) mapbox 2016 and ispace 2018\n        www.mapbox.com | www.ispace.org\n        License: MIT, header required.\n    */const Qe=["Unknown","Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"];function tn(t){if(!t)return"true";const e=t[0];if(t.length<=1)return"any"===e?"false":"true";return\`(${UR}"=="===e?nn(t[1],t[2],"===",!1):"!="===e?nn(t[1],t[2],"!==",!1):"<"===e||">"===e||"<="===e||">="===e?nn(t[1],t[2],e,!0):"any"===e?on(t.slice(1),"||"):"all"===e?on(t.slice(1),"&&"):"none"===e?ln(on(t.slice(1),"||")):"in"===e?sn(t[1],t.slice(2)):"!in"===e?ln(sn(t[1],t.slice(2))):"has"===e?an(t[1]):"!has"===e?ln(an(t[1])):"contains"===e?function(t,e,n){const r=en(t);return void 0!==n?\`(${UR}r} + '').indexOf("${UR}e}") === ${UR}n}\`:\`(${UR}r} + '').indexOf("${UR}e}") >= 0\`}(t[1],t[2],t[3]):"true"})\`}function en(t){return"$"===t[0]?"f."+t.substring(1):"p["+JSON.stringify(t)+"]"}function nn(t,e,n,r){if("object"==typeof(i=t)&&i&&t.op)return function(t,e,n,r){const i=t.property,o=t.op;let s=en(i);return"length"!==o?(console.error(\`not support ${UR}o} op\`),"false"):(s=\`((${UR}s}+='').length)\`,rn(s,i,e,n,r))}(t,e,n,r);var i;return rn(en(t),t,e,n,r)}function rn(t,e,n,r,i){const o="$type"===e?Qe.indexOf(n):JSON.stringify(n);return(i?\`typeof ${UR}t}=== typeof ${UR}o}&&\`:"")+t+r+o}function on(t,e){return t.map(tn).join(e)}function sn(t,e){"$type"===t&&(e=e.map((t=>Qe.indexOf(t))));const n=JSON.stringify(e.sort(un)),r=en(t);return e.length<=200?\`${UR}n}.indexOf(${UR}r}) !== -1\`:\`function(v, a, i, j) {\\n        while (i <= j) { var m = (i + j) >> 1;\\n            if (a[m] === v) return true; if (a[m] > v) j = m - 1; else i = m + 1;\\n        }\\n    return false; }(${UR}r}, ${UR}n},0,${UR}e.length-1})\`}function an(t){return"$id"===t?'"id" in f':\`${UR}JSON.stringify(t)} in p\`}function ln(t){return\`!(${UR}t})\`}function un(t,e){return t<e?-1:t>e?1:0}let hn=!1;try{const t=new OffscreenCanvas(1,1);t.getContext("2d").fillText("hello",0,0),hn=!0}catch(t){hn=!1}var cn=hn;const{VectorPack:fn,PolygonPack:pn,NativeLinePack:dn,LinePack:gn,PointPack:yn,NativePointPack:xn,LineExtrusionPack:mn,CirclePack:vn,RoundTubePack:wn,SquareTubePack:Mn,FilterUtil:bn,PackUtil:Pn,StyleUtil:_n,TextUtil:In,DEFAULT_TEX_WIDTH:An,GlyphRequestor:Sn}=ne(),Tn="__original_properties",Fn="__fn-type_properties";class kn{constructor(t,e,n,r,i){this.id=t,this.options=e,this.upload=n,this._compileStyle(e.style),this.requests={},this._cache=r,this._styleCounter=1,this.loadings=i}updateStyle(t,e){this.options.style=t,this._styleCounter=t.styleCounter,this._compileStyle(t),e()}updateOptions(t,e){this.options=I(this.options,t),e()}loadTile(t,e){const n=this.loadings,r=t.tileInfo.url,i=this.options.debugTile;if(i){const{x:n,y:r,z:o}=t.tileInfo;let s=!1;for(let t=0;t<i.length;t++)if(n===i[t].x&&r===i[t].y&&o===i[t].z){s=!0;break}if(!s)return void e()}if(n[r])return void n[r].push({context:t,callback:e,ref:this});n[r]=[{context:t,callback:e,ref:this}];const o=this.options.featureIdProperty;this.requests[r]=this.getTileFeatures(t,((e,i,s,a)=>{const l=n[r];if(delete n[r],this.checkIfCanceled(r))return delete this.requests[r],void this._callWaitings(l,null,{canceled:!0});if(delete this.requests[r],(this.options.debug||o)&&i)for(let e=0;e<i.length;e++)if(this.options.debug&&(i[e]._debug_info={index:e,id:i[e].id,tileId:t.tileInfo.id}),o){const t=F(o)?o[i[e].layer]:o,n=i[e].properties;i[e].id=n&&n[t]||null}if(e)this._callWaitings(l,e);else if(i&&i.length){if(l)for(let t=0;t<l.length;t++)this._onTileLoad.call(l[t].ref,l[t].context,l[t].callback,r,s,i,a)}else this._callWaitings(l)}))}_onTileLoad(t,e,n,r,i,o){this._createTileData(r,i,t).then((n=>{n.canceled?e(null,{canceled:!0}):(n.data.styleCounter=t.styleCounter,o&&I(n.data,o),e(null,n.data,n.buffers))})).catch((t=>{e(t)}))}abortTile(t,e){delete this.requests[t],this._cancelLoadings(t),e()}_cancelLoadings(t){const e=this.loadings[t];if(e)for(let t=0;t<e.length;t++)e[t].callback(null,{canceled:!0});delete this.loadings[t]}_callWaitings(t,e,n){if(t)for(let r=0;r<t.length;r++)t[r].callback(e,n)}checkIfCanceled(t){return!this.requests[t]}onRemove(){this.loadings={},delete this._cache,this.requests={}}fetchIconGlyphs(t,e,n){if(this.options.workerGlyph&&cn){const r=[];if(t&&Object.keys(t).length){const e=new Promise((e=>{this.upload("fetchIconGlyphs",{icons:t},null,((t,n)=>{e({err:t,iconData:n})}))}));r.push(e)}if(e&&Object.keys(e).length){const t=new Promise((t=>{if(!this._glyphRequestor){const t=this.options.style&&this.options.style.renderPlugin&&this.options.style.renderPlugin.sdfURL;this._glyphRequestor=new Sn(null,null,null,t)}this._glyphRequestor.getGlyphs(e,((e,n)=>{t({err:e,glyphData:n})}))}));r.push(t)}Promise.all(r).then((t=>{const e={icons:null,glyphs:null};for(let r=0;r<t.length;r++){if(t[r].err)return void n(t[r].err);t[r].iconData?e.icons=t[r].iconData.icons:t[r].glyphData&&(e.glyphs=t[r].glyphData.glyphs)}return e})).then((t=>{n(null,t)}))}else this.upload("fetchIconGlyphs",{icons:t,glyphs:e},null,n)}_createTileData(t,e,n){if(!e.length)return Promise.resolve({data:null,buffers:[]});const{glScale:r,tileInfo:i}=n,o=!this.options.style.style.length&&!this.options.style.featureStyle.length;let s=this.pluginConfig.slice(0);o&&(s=this._updateLayerPluginConfig(t)),this.featurePlugins&&function(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];if(n)for(let e=0,r=n.length;e<r;e++)t.push(n[e])}t.length}(s,this.featurePlugins);const a={};for(let t=0;t<s.length;t++)Xn(e,n.tileInfo.z,s[t],a);const l=[],u=[];for(let t=0;t<e.length;t++){const n=e[t],r=a[t];if(r){u.fill(null);let t=0;for(const e in r){let i=0;const o=r[e].values();for(const t of o){let r=u[i];r||(r=$n(n),u[i]=r),r.properties[e]=t,i++}i>t&&(t=i)}for(let e=0;e<t;e++)l.push(u[e])}else l.push(n)}const h=(e=l)[0].extent,c=i.z,f={x:i.extent2d.xmin*r,y:i.extent2d.ymax*r},p=[],d=[],g=[],y=this.options,x=[],m={},v=[Promise.resolve(n.styleCounter)];let w=0,M=-1;const b=[];let P=!1;for(let t=0;t<s.length;t++){M++;const r=s[t];r.type!==w&&(M=0,w=r.type);const a=0===r.type?p:d;if(r.symbol&&!1===r.symbol.visible){a[M]=null;continue}jn(r.symbol,b,t),P=P||b[t]&&b[t].size>0;const{tileFeatures:l,tileFeaIndexes:u}=this._filterFeatures(c,r.type,r.filter,e,m,t);if(!l.length){a[M]=null;continue}const y=u[u.length-1],_=Pn.getIndexArrayType(y);a[M]={styledFeatures:new _(u)},g.push({idx:t,typeIdx:M}),x.push(a[M].styledFeatures.buffer);const A=I({},n,{extent:h,zoom:c,tilePoint:f});if(this.options.debugTile){const t=this.options.debugTile;for(let e=0;e<t.length;e++){const{x:n,y:r,z:o}=t[e];if(i.x===n&&i.y===r&&i.z===o){A.debugIndex=t[e].index;break}}}let S=this._createTileGeometry(l,r,A);o&&(S=S.then((t=>{if(!t)return null;if(t.data)t.data.layer=l[0].layer;else if(Array.isArray(t))for(let e=0;e<t.length;e++)t[e]&&t[e].data&&(t[e].data.layer=l[0].layer);return t}))),v.push(S)}return Promise.all(v).then((([n,...r])=>{if(n!==this._styleCounter)return{canceled:!0};function i(t,e){if(void 0!==t.data.ref)return;const n=s[g[e].idx],r=n.renderPlugin.dataConfig;if(t.data.type=r.type,t.data.filter=n.filter.def,r.altitudeOffset&&(t.data.properties.minAltitude+=r.altitudeOffset,t.data.properties.maxAltitude+=r.altitudeOffset),t.buffers&&t.buffers.length)for(let e=0;e<t.buffers.length;e++)x.push(t.buffers[e])}for(let t=0;t<r.length;t++){if(!r[t])continue;const e=r[t],n=0===s[g[t].idx].type?p:d;if(Array.isArray(e)){const r=[];for(let n=0;n<e.length;n++)e[n]&&(i(e[n],t),(void 0===e[n].data.ref||e[e[n].data.ref])&&r.push(e[n].data));r.length&&(n[g[t].typeIdx].data=r)}else i(e,t),n[g[t].typeIdx].data=e.data}const o={},a=t;if(y.features||y.schema||P){let t,n=!1;for(let r=0,i=e.length;r<i;r++)if(t=e[r],a[t.layer].properties||(a[t.layer].properties=Cn(t.properties)),t&&(y.features||P&&m[r]))if("id"===y.features)o[r]=t.id;else{y.pickingGeometry||delete t.geometry,delete t.extent,delete t.properties.$layer,delete t.properties.$type,delete t.__index;const e=t.originalFeature;if(e){const e=t.properties,n=I({},t.originalFeature);delete e[Tn],n.customProps=I({},e),t=n}const i=I({},t);if(P&&m[r]&&(!y.features||"transient"===y.features)){const i=m[r];for(let r=0;r<i.length;r++){const i=b[r];i&&i.forEach((r=>{const i=e?e.properties:t.properties;i[Fn]||(i[Fn]=new Set),i[Fn].add(r),n=!0}))}}o[r]=i}if(n)for(const t in o){const e=o[t],n=e.properties[Fn];if(n){delete e.properties[Fn],"transient"===y.features&&(e.fnTypeProps=I({},e.properties));for(const t in e.properties)n.has(t)||("transient"===y.features?delete e.fnTypeProps[t]:delete e.properties[t])}}}return{data:{styleCounter:n,schema:a,data:p,featureData:d,extent:h,features:o},buffers:x}})).catch((t=>{console.error(t)}))}_createTileGeometry(t,e,n){let r=t;const i=e.renderPlugin.dataConfig,o=e.symbol,s=this.options.tileSize,{extent:a,glScale:l,zScale:u,zoom:h,tilePoint:c,centimeterToPoint:f,verticalCentimeterToPoint:p}=n,d=a/s,g=i.type,y=n.debugIndex;let x=I({},i,{EXTENT:a,zoom:h,debugIndex:y,features:this.options.features});if("3d-extrusion"===g){Yn(o)&&(i.uv=1);const t=this.options.projectionCode,e=o.material&&o.material.textureWidth||An;return Promise.all([Promise.resolve(je(r,i,a,c,e,n.tileInfo.res,l,a/this.options.tileSize,f,p,o,h,t,y))])}if("3d-wireframe"===g)return Promise.all([Promise.resolve(Ke(r,a,o,i))]);if("point"===g){x=I(x,{requestor:this.fetchIconGlyphs.bind(this),altitudeToTileScale:u*a/this.options.tileSize/l,pluginType:e.renderPlugin.type});let t=o;return Array.isArray(o)||(t=[o]),t=t.map(((t,e)=>(t&&(t.index={index:e},t.isIconText=function(t){return t.markerType||t.markerFile}(t)),t))).filter((t=>!!t)),Promise.all(t.map((t=>{const e=fn.genFnTypes(t);let n=r;return yn.needMerge(t,e,h)&&(n=yn.mergeLineFeatures(r,t,e,h)),new yn(n,t,x).load(d)})))}if("native-point"===g){const t=u*a/this.options.tileSize/l;return x.altitudeToTileScale=t,Vn(r,o,x,xn,d)}if("line"===g)return x=I(x,{requestor:this.fetchIconGlyphs.bind(this),tileRatio:d}),Vn(r,o,x,gn,1,!0);if("native-line"===g)return Vn(r,o,x,dn,1,!0);if("fill"===g)return x=I(x,{requestor:this.fetchIconGlyphs.bind(this)}),Vn(r,o,x,pn);if("line-extrusion"===g){delete o.lineGradientProperty,o.lineJoin="miter",o.lineCap="butt";const t=Yn(o);if(t&&(i.uv=1),x=I(x,{tileSize:s,zScale:u,glScale:l}),o.mergeOnProperty){const t=fn.genFnTypes(o);r=gn.mergeLineFeatures(r,o,t,x.zoom)}if(t){const t=[];if(!1!==i.top){const e=I({},x);e.side=!1,t.push(new mn(r,o,e))}return!1!==i.side&&(x.side=!0,x.top=!1,t.push(new mn(r,o,x))),Promise.all(t.map((t=>t.load())))}return Promise.all([new mn(r,o,x).load()])}if("circle"===g)return Vn(r,o,x,vn);if("round-tube"===g||"square-tube"===g){const t="round-tube"===g?wn:Mn;return x=I(x,{requestor:this.fetchIconGlyphs.bind(this),radialSegments:"round-tube"===g?i.radialSegments||8:4,centimeterToPoint:f,verticalCentimeterToPoint:p,tileRatio:d,isTube:!0}),Vn(r,o,x,t)}return Promise.resolve([])}_filterFeatures(t,e,n,r,i,o){const s=(te+"").trim(),a=[],l=[],u=r.length;for(let h=0;h<u;h++)if((1===e||void 0===r[h].id||!this.styledFeatures[r[h].id])&&((!n.def||"default"===n.def)&&!i[h]||!0===n.def||n.def&&(void 0!==n.def.condition||Array.isArray(n.def))&&n(r[h],t))){const t=r[h];if(void 0===t[s]&&(t[s]=h),i[h]||(i[h]=[]),i[h].push(o),l.push(t),a.push(h),1===e)break}return{tileFeatures:l,tileFeaIndexes:a}}_compileStyle(t){const{style:e,featureStyle:n}=t,r={};n.forEach((t=>{Array.isArray(t.id)?(t.id.forEach((t=>{r[t]=1})),t.filter=["in","$id",...t.id]):(r[t.id]=1,t.filter=["==","$id",t.id])}));const i=bn.compileStyle(e);for(let t=0;t<e.length;t++)i[t].filter&&(i[t].filter.def=e[t].filter?e[t].filter.value||e[t].filter:void 0),i[t].type=0;const o=[],s=bn.compileStyle(n);for(let t=0;t<n.length;t++)s[t].type=1,s[t].filter.def=n[t].filter?n[t].filter.value||n[t].filter:void 0,s[t].renderPlugin&&o.push(s[t]);this.pluginConfig=i,this.featurePlugins=o,this.styledFeatures=r}_updateLayerPluginConfig(t){let e=this._layerPlugins;this._layerPlugins||(e=this._layerPlugins={});const n=["","Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon"],r=[];for(const o in t){const s=o;if(!e[o]){const r=[];for(let e=0;e<t[o].types.length;e++){const a=t[o].types[e],l=["all",["==","$layer",s],["==","$type",n[a]]],u={filter:(i=l,new Function("f",\`var p = (f && f.properties || {}); return ${UR}tn(i)}\`)),renderPlugin:Ln(a),symbol:Bn(a)};u.filter.def=l,u.type=0,r.push(u)}e[s]=r}r.push(...e[s])}var i;return r}}function Ln(t){switch(t){case 1:return{type:"native-point",dataConfig:{type:"native-point",only2D:!0}};case 2:return{type:"native-line",dataConfig:{type:"native-line",only2D:!0}};case 3:return{type:"fill",dataConfig:{type:"fill",only2D:!0}}}return null}function Bn(t){switch(t){case 1:return{markerFill:"#f00",markerSize:10};case 2:return{lineColor:"#fff"};case 3:return{polygonFill:"#00f",polygonOpacity:.4}}return null}function Cn(t){if(Array.isArray(t)||!F(t))return{};const e={};for(const n in t){const r=t[n];A(r)?e[n]="string":S(r)?e[n]="number":!0===r||!1===r?e[n]="boolean":Array.isArray(r)?e[n]="array":e[n]="object"}return e}function Yn(t){if(!t)return 0;let e=0;for(const n in t){if(("normalTexture"===n||"bumpTexture"===n)&&t[n])return 2;if(n.indexOf("Texture")>0&&t[n])e=1;else if(F(t[n])){const r=Yn(t[n]);if(2===r)return r;1===r&&(e=1)}}return e}function Vn(t,e,n,r,i,o){const s={},a=Array.isArray(e)?e:[e];let l=-1;for(let t=0;t<a.length;t++)s[t]=On(a[t]),!s[t]&&a[t]&&-1===l&&(l=t);const u=[];for(let e=0;e<a.length;e++){if(!a[e])continue;a[e].index={index:e};let h=t;if(o&&a[e].mergeOnProperty){const r=fn.genFnTypes(a[e]);h=gn.mergeLineFeatures(t,a[0],r,n.zoom)}s[e]||e===l?u.push(new r(h,a[e],n).load(i)):u.push({data:{ref:l,symbolIndex:{index:e}}})}return Promise.all(u)}function On(t){if(!t)return 0;for(const e in t)if(L(t[e]))return 1;return 0}function Xn(t,e,n,r){const i=n.customProperties;if(!i)return t;if(i)for(let t=0;t<i.length;t++)i[t].fn=bn.compileFilter(i[t].filter);for(let n=0;n<i.length;n++)for(let o=0,s=t.length;o<s;o++)if(i[n].fn(t[o],e))for(const t in i[n].properties){const e=i[n].properties[t];k(e)||(r[o]||(r[o]={}),r[o][t]||(r[o][t]=new Set),r[o][t].add(e))}}const Nn={get:(t,e)=>e in t?t[e]:t.originalFeature[e],has:(t,e)=>e in t||e in t.originalFeature},En={get:function(t,e){return e in t?t[e]:t[Tn][e]},has:(t,e)=>e in t||e in t[Tn]},zn={};function $n(t){const e={};e.originalFeature=t;const n=new Proxy(e,Nn);return n.properties=new Proxy({},En),n.properties[Tn]=t.properties||zn,n}function Dn(t,e,n){t[e]||(t[e]=new Set),t[e].add(n)}const qn=[];function jn(t,e,n){if(!t)return qn;for(const r in t){if(!t[r]||!_n.checkIfZoomFnTypeSymbol(r))continue;if(L(t[r]))Dn(e,n,t[r].property);else{if("lineGradientProperty"===r){Dn(e,n,t[r]);continue}if("textName"===r)if(A(t[r])){const i=In.resolveVarNames(t[r]);if(i)for(let t=0;t<i.length;t++)Dn(e,n,i[t])}else if(bn.isExpression(t[r])){const i=[];In.resolveExpVarNames(i,t[r]);for(let t=0;t<i.length;t++)Dn(e,n,i[t])}}const i=t[r].stops;if(i&&i.length)for(let t=0;t<i.length;t++)L(i[t][1])&&Dn(e,t,i[t][1].property)}return e[n]}function Zn(t,e){Gn(t.geometry,e)}function Gn(t,e){if(t)switch(t.type){case"Point":Un(t.coordinates,e);break;case"MultiPoint":case"LineString":Rn(t.coordinates,e);break;case"MultiLineString":!function(t,e){for(let n=0,r=t.length;n<r;n++)Rn(t[n],e)}(t.coordinates,e);break;case"Polygon":Jn(t.coordinates,e);break;case"MultiPolygon":!function(t,e){for(let n=0,r=t.length;n<r;n++)Jn(t[n],e)}(t.coordinates,e);break;case"GeometryCollection":const n=t.geometries.length;for(let r=0;r<n;r++)Gn(t.geometries[r],e)}}function Un(t,e){e[0]=Math.min(e[0],t[0]),e[1]=Math.min(e[1],t[1]),e[2]=Math.max(e[2],t[0]),e[3]=Math.max(e[3],t[1])}function Rn(t,e){for(let n=0,r=t.length;n<r;n++)Un(t[n],e)}function Jn(t,e){t.length&&Rn(t[0],e)}function Hn(t,e,n,r,i){Wn(t,e,n||0,r||t.length-1,i||Qn)}function Wn(t,e,n,r,i){for(;r>n;){if(r-n>600){var o=r-n+1,s=e-n+1,a=Math.log(o),l=.5*Math.exp(2*a/3),u=.5*Math.sqrt(a*l*(o-l)/o)*(s-o/2<0?-1:1);Wn(t,e,Math.max(n,Math.floor(e-s*l/o+u)),Math.min(r,Math.floor(e+(o-s)*l/o+u)),i)}var h=t[e],c=n,f=r;for(Kn(t,n,e),i(t[r],h)>0&&Kn(t,n,r);c<f;){for(Kn(t,c,f),c++,f--;i(t[c],h)<0;)c++;for(;i(t[f],h)>0;)f--}0===i(t[n],h)?Kn(t,n,f):Kn(t,++f,r),f<=e&&(n=f+1),e<=f&&(r=f-1)}}function Kn(t,e,n){var r=t[e];t[e]=t[n],t[n]=r}function Qn(t,e){return t<e?-1:t>e?1:0}class tr{constructor(t=9){this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()}all(){return this._all(this.data,[])}search(t){let e=this.data;const n=[];if(!cr(t,e))return n;const r=this.toBBox,i=[];for(;e;){for(let o=0;o<e.children.length;o++){const s=e.children[o],a=e.leaf?r(s):s;cr(t,a)&&(e.leaf?n.push(s):hr(t,a)?this._all(s,n):i.push(s))}e=i.pop()}return n}collides(t){let e=this.data;if(!cr(t,e))return!1;const n=[];for(;e;){for(let r=0;r<e.children.length;r++){const i=e.children[r],o=e.leaf?this.toBBox(i):i;if(cr(t,o)){if(e.leaf||hr(t,o))return!0;n.push(i)}}e=n.pop()}return!1}load(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(let e=0;e<t.length;e++)this.insert(t[e]);return this}let e=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===e.height)this._splitRoot(this.data,e);else{if(this.data.height<e.height){const t=this.data;this.data=e,e=t}this._insert(e,this.data.height-e.height-1,!0)}else this.data=e;return this}insert(t){return t&&this._insert(t,this.data.height-1),this}clear(){return this.data=fr([]),this}remove(t,e){if(!t)return this;let n=this.data;const r=this.toBBox(t),i=[],o=[];let s,a,l;for(;n||i.length;){if(n||(n=i.pop(),a=i[i.length-1],s=o.pop(),l=!0),n.leaf){const r=er(t,n.children,e);if(-1!==r)return n.children.splice(r,1),i.push(n),this._condense(i),this}l||n.leaf||!hr(n,r)?a?(s++,n=a.children[s],l=!1):n=null:(i.push(n),o.push(s),s=0,a=n,n=n.children[0])}return this}toBBox(t){return t}compareMinX(t,e){return t.minX-e.minX}compareMinY(t,e){return t.minY-e.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}_all(t,e){const n=[];for(;t;)t.leaf?e.push(...t.children):n.push(...t.children),t=n.pop();return e}_build(t,e,n,r){const i=n-e+1;let o,s=this._maxEntries;if(i<=s)return o=fr(t.slice(e,n+1)),nr(o,this.toBBox),o;r||(r=Math.ceil(Math.log(i)/Math.log(s)),s=Math.ceil(i/Math.pow(s,r-1))),o=fr([]),o.leaf=!1,o.height=r;const a=Math.ceil(i/s),l=a*Math.ceil(Math.sqrt(s));pr(t,e,n,l,this.compareMinX);for(let i=e;i<=n;i+=l){const e=Math.min(i+l-1,n);pr(t,i,e,a,this.compareMinY);for(let n=i;n<=e;n+=a){const i=Math.min(n+a-1,e);o.children.push(this._build(t,n,i,r-1))}}return nr(o,this.toBBox),o}_chooseSubtree(t,e,n,r){for(;r.push(e),!e.leaf&&r.length-1!==n;){let n,r=1/0,s=1/0;for(let a=0;a<e.children.length;a++){const l=e.children[a],u=ar(l),h=(i=t,o=l,(Math.max(o.maxX,i.maxX)-Math.min(o.minX,i.minX))*(Math.max(o.maxY,i.maxY)-Math.min(o.minY,i.minY))-u);h<s?(s=h,r=u<r?u:r,n=l):h===s&&u<r&&(r=u,n=l)}e=n||e.children[0]}var i,o;return e}_insert(t,e,n){const r=n?t:this.toBBox(t),i=[],o=this._chooseSubtree(r,this.data,e,i);for(o.children.push(t),ir(o,r);e>=0&&i[e].children.length>this._maxEntries;)this._split(i,e),e--;this._adjustParentBBoxes(r,i,e)}_split(t,e){const n=t[e],r=n.children.length,i=this._minEntries;this._chooseSplitAxis(n,i,r);const o=this._chooseSplitIndex(n,i,r),s=fr(n.children.splice(o,n.children.length-o));s.height=n.height,s.leaf=n.leaf,nr(n,this.toBBox),nr(s,this.toBBox),e?t[e-1].children.push(s):this._splitRoot(n,s)}_splitRoot(t,e){this.data=fr([t,e]),this.data.height=t.height+1,this.data.leaf=!1,nr(this.data,this.toBBox)}_chooseSplitIndex(t,e,n){let r,i=1/0,o=1/0;for(let s=e;s<=n-e;s++){const e=rr(t,0,s,this.toBBox),a=rr(t,s,n,this.toBBox),l=ur(e,a),u=ar(e)+ar(a);l<i?(i=l,r=s,o=u<o?u:o):l===i&&u<o&&(o=u,r=s)}return r||n-e}_chooseSplitAxis(t,e,n){const r=t.leaf?this.compareMinX:or,i=t.leaf?this.compareMinY:sr;this._allDistMargin(t,e,n,r)<this._allDistMargin(t,e,n,i)&&t.children.sort(r)}_allDistMargin(t,e,n,r){t.children.sort(r);const i=this.toBBox,o=rr(t,0,e,i),s=rr(t,n-e,n,i);let a=lr(o)+lr(s);for(let r=e;r<n-e;r++){const e=t.children[r];ir(o,t.leaf?i(e):e),a+=lr(o)}for(let r=n-e-1;r>=e;r--){const e=t.children[r];ir(s,t.leaf?i(e):e),a+=lr(s)}return a}_adjustParentBBoxes(t,e,n){for(let r=n;r>=0;r--)ir(e[r],t)}_condense(t){for(let e,n=t.length-1;n>=0;n--)0===t[n].children.length?n>0?(e=t[n-1].children,e.splice(e.indexOf(t[n]),1)):this.clear():nr(t[n],this.toBBox)}}function er(t,e,n){if(!n)return e.indexOf(t);for(let r=0;r<e.length;r++)if(n(t,e[r]))return r;return-1}function nr(t,e){rr(t,0,t.children.length,e,t)}function rr(t,e,n,r,i){i||(i=fr(null)),i.minX=1/0,i.minY=1/0,i.maxX=-1/0,i.maxY=-1/0;for(let o=e;o<n;o++){const e=t.children[o];ir(i,t.leaf?r(e):e)}return i}function ir(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function or(t,e){return t.minX-e.minX}function sr(t,e){return t.minY-e.minY}function ar(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function lr(t){return t.maxX-t.minX+(t.maxY-t.minY)}function ur(t,e){const n=Math.max(t.minX,e.minX),r=Math.max(t.minY,e.minY),i=Math.min(t.maxX,e.maxX),o=Math.min(t.maxY,e.maxY);return Math.max(0,i-n)*Math.max(0,o-r)}function hr(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function cr(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function fr(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function pr(t,e,n,r,i){const o=[e,n];for(;o.length;){if((n=o.pop())-(e=o.pop())<=r)continue;const s=e+Math.ceil((n-e)/r/2)*r;Hn(t,s,e,n,i),o.push(e,s,s,n)}}class dr{constructor(t=[],e=gr){if(this.data=t,this.length=this.data.length,this.compare=e,this.length>0)for(let t=(this.length>>1)-1;t>=0;t--)this._down(t)}push(t){this.data.push(t),this.length++,this._up(this.length-1)}pop(){if(0===this.length)return;const t=this.data[0],e=this.data.pop();return this.length--,this.length>0&&(this.data[0]=e,this._down(0)),t}peek(){return this.data[0]}_up(t){const{data:e,compare:n}=this,r=e[t];for(;t>0;){const i=t-1>>1,o=e[i];if(n(r,o)>=0)break;e[t]=o,t=i}e[t]=r}_down(t){const{data:e,compare:n}=this,r=this.length>>1,i=e[t];for(;t<r;){let r=1+(t<<1),o=e[r];const s=r+1;if(s<this.length&&n(e[s],o)<0&&(r=s,o=e[s]),n(o,i)>=0)break;e[t]=o,t=r}e[t]=i}}function gr(t,e){return t<e?-1:t>e?1:0}function yr(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var xr={exports:{}},mr=function(t,e,n,r){var i=t[0],o=t[1],s=!1;void 0===n&&(n=0),void 0===r&&(r=e.length);for(var a=(r-n)/2,l=0,u=a-1;l<a;u=l++){var h=e[n+2*l+0],c=e[n+2*l+1],f=e[n+2*u+0],p=e[n+2*u+1];c>o!=p>o&&i<(f-h)*(o-c)/(p-c)+h&&(s=!s)}return s},vr=function(t,e,n,r){var i=t[0],o=t[1],s=!1;void 0===n&&(n=0),void 0===r&&(r=e.length);for(var a=r-n,l=0,u=a-1;l<a;u=l++){var h=e[l+n][0],c=e[l+n][1],f=e[u+n][0],p=e[u+n][1];c>o!=p>o&&i<(f-h)*(o-c)/(p-c)+h&&(s=!s)}return s};xr.exports=function(t,e,n,r){return e.length>0&&Array.isArray(e[0])?vr(t,e,n,r):mr(t,e,n,r)};var wr=xr.exports.nested=vr;xr.exports.flat=mr;const Mr=11102230246251565e-32,br=134217729,Pr=(3+8*Mr)*Mr;function _r(t,e,n,r,i){let o,s,a,l,u=e[0],h=r[0],c=0,f=0;h>u==h>-u?(o=u,u=e[++c]):(o=h,h=r[++f]);let p=0;if(c<t&&f<n)for(h>u==h>-u?(s=u+o,a=o-(s-u),u=e[++c]):(s=h+o,a=o-(s-h),h=r[++f]),o=s,0!==a&&(i[p++]=a);c<t&&f<n;)h>u==h>-u?(s=o+u,l=s-o,a=o-(s-l)+(u-l),u=e[++c]):(s=o+h,l=s-o,a=o-(s-l)+(h-l),h=r[++f]),o=s,0!==a&&(i[p++]=a);for(;c<t;)s=o+u,l=s-o,a=o-(s-l)+(u-l),u=e[++c],o=s,0!==a&&(i[p++]=a);for(;f<n;)s=o+h,l=s-o,a=o-(s-l)+(h-l),h=r[++f],o=s,0!==a&&(i[p++]=a);return 0===o&&0!==p||(i[p++]=o),p}function Ir(t){return new Float64Array(t)}const Ar=33306690738754716e-32,Sr=22204460492503146e-32,Tr=11093356479670487e-47,Fr=Ir(4),kr=Ir(8),Lr=Ir(12),Br=Ir(16),Cr=Ir(4);function Yr(t,e,n,r,i,o){const s=(e-o)*(n-i),a=(t-i)*(r-o),l=s-a;if(0===s||0===a||s>0!=a>0)return l;const u=Math.abs(s+a);return Math.abs(l)>=Ar*u?l:-function(t,e,n,r,i,o,s){let a,l,u,h,c,f,p,d,g,y,x,m,v,w,M,b,P,_;const I=t-i,A=n-i,S=e-o,T=r-o;w=I*T,f=br*I,p=f-(f-I),d=I-p,f=br*T,g=f-(f-T),y=T-g,M=d*y-(w-p*g-d*g-p*y),b=S*A,f=br*S,p=f-(f-S),d=S-p,f=br*A,g=f-(f-A),y=A-g,P=d*y-(b-p*g-d*g-p*y),x=M-P,c=M-x,Fr[0]=M-(x+c)+(c-P),m=w+x,c=m-w,v=w-(m-c)+(x-c),x=v-b,c=v-x,Fr[1]=v-(x+c)+(c-b),_=m+x,c=_-m,Fr[2]=m-(_-c)+(x-c),Fr[3]=_;let F=function(t,e){let n=e[0];for(let r=1;r<t;r++)n+=e[r];return n}(4,Fr),k=Sr*s;if(F>=k||-F>=k)return F;if(c=t-I,a=t-(I+c)+(c-i),c=n-A,u=n-(A+c)+(c-i),c=e-S,l=e-(S+c)+(c-o),c=r-T,h=r-(T+c)+(c-o),0===a&&0===l&&0===u&&0===h)return F;if(k=Tr*s+Pr*Math.abs(F),F+=I*h+T*a-(S*u+A*l),F>=k||-F>=k)return F;w=a*T,f=br*a,p=f-(f-a),d=a-p,f=br*T,g=f-(f-T),y=T-g,M=d*y-(w-p*g-d*g-p*y),b=l*A,f=br*l,p=f-(f-l),d=l-p,f=br*A,g=f-(f-A),y=A-g,P=d*y-(b-p*g-d*g-p*y),x=M-P,c=M-x,Cr[0]=M-(x+c)+(c-P),m=w+x,c=m-w,v=w-(m-c)+(x-c),x=v-b,c=v-x,Cr[1]=v-(x+c)+(c-b),_=m+x,c=_-m,Cr[2]=m-(_-c)+(x-c),Cr[3]=_;const L=_r(4,Fr,4,Cr,kr);w=I*h,f=br*I,p=f-(f-I),d=I-p,f=br*h,g=f-(f-h),y=h-g,M=d*y-(w-p*g-d*g-p*y),b=S*u,f=br*S,p=f-(f-S),d=S-p,f=br*u,g=f-(f-u),y=u-g,P=d*y-(b-p*g-d*g-p*y),x=M-P,c=M-x,Cr[0]=M-(x+c)+(c-P),m=w+x,c=m-w,v=w-(m-c)+(x-c),x=v-b,c=v-x,Cr[1]=v-(x+c)+(c-b),_=m+x,c=_-m,Cr[2]=m-(_-c)+(x-c),Cr[3]=_;const B=_r(L,kr,4,Cr,Lr);w=a*h,f=br*a,p=f-(f-a),d=a-p,f=br*h,g=f-(f-h),y=h-g,M=d*y-(w-p*g-d*g-p*y),b=l*u,f=br*l,p=f-(f-l),d=l-p,f=br*u,g=f-(f-u),y=u-g,P=d*y-(b-p*g-d*g-p*y),x=M-P,c=M-x,Cr[0]=M-(x+c)+(c-P),m=w+x,c=m-w,v=w-(m-c)+(x-c),x=v-b,c=v-x,Cr[1]=v-(x+c)+(c-b),_=m+x,c=_-m,Cr[2]=m-(_-c)+(x-c),Cr[3]=_;const C=_r(B,Lr,4,Cr,Br);return Br[C-1]}(t,e,n,r,i,o,u)}function Vr(t,e,n){e=Math.max(0,void 0===e?2:e),n=n||0;var r=function(t){for(var e=t[0],n=t[0],r=t[0],i=t[0],o=0;o<t.length;o++){var s=t[o];s[0]<e[0]&&(e=s),s[0]>r[0]&&(r=s),s[1]<n[1]&&(n=s),s[1]>i[1]&&(i=s)}var a=[e,n,r,i],l=a.slice();for(o=0;o<t.length;o++)wr(t[o],a)||l.push(t[o]);return function(t){t.sort(Ur);for(var e=[],n=0;n<t.length;n++){for(;e.length>=2&&$r(e[e.length-2],e[e.length-1],t[n])<=0;)e.pop();e.push(t[n])}for(var r=[],i=t.length-1;i>=0;i--){for(;r.length>=2&&$r(r[r.length-2],r[r.length-1],t[i])<=0;)r.pop();r.push(t[i])}return r.pop(),e.pop(),e.concat(r)}(l)}(t),i=new tr(16);i.toBBox=function(t){return{minX:t[0],minY:t[1],maxX:t[0],maxY:t[1]}},i.compareMinX=function(t,e){return t[0]-e[0]},i.compareMinY=function(t,e){return t[1]-e[1]},i.load(t);for(var o,s=[],a=0;a<r.length;a++){var l=r[a];i.remove(l),o=qr(l,o),s.push(o)}var u=new tr(16);for(a=0;a<s.length;a++)u.insert(Dr(s[a]));for(var h=e*e,c=n*n;s.length;){var f=s.shift(),p=f.p,d=f.next.p,g=jr(p,d);if(!(g<c)){var y=g/h;(l=Or(i,f.prev.p,p,d,f.next.next.p,y,u))&&Math.min(jr(l,p),jr(l,d))<=y&&(s.push(f),s.push(qr(l,f)),i.remove(l),u.remove(f),u.insert(Dr(f)),u.insert(Dr(f.next)))}}f=o;var x=[];do{x.push(f.p),f=f.next}while(f!==o);return x.push(f.p),x}function Or(t,e,n,r,i,o,s){for(var a=new dr([],Xr),l=t.data;l;){for(var u=0;u<l.children.length;u++){var h=l.children[u],c=l.leaf?Zr(h,n,r):Nr(n,r,h);c>o||a.push({node:h,dist:c})}for(;a.length&&!a.peek().node.children;){var f=a.pop(),p=f.node,d=Zr(p,e,n),g=Zr(p,r,i);if(f.dist<d&&f.dist<g&&zr(n,p,s)&&zr(r,p,s))return p}(l=a.pop())&&(l=l.node)}return null}function Xr(t,e){return t.dist-e.dist}function Nr(t,e,n){if(Er(t,n)||Er(e,n))return 0;var r=Gr(t[0],t[1],e[0],e[1],n.minX,n.minY,n.maxX,n.minY);if(0===r)return 0;var i=Gr(t[0],t[1],e[0],e[1],n.minX,n.minY,n.minX,n.maxY);if(0===i)return 0;var o=Gr(t[0],t[1],e[0],e[1],n.maxX,n.minY,n.maxX,n.maxY);if(0===o)return 0;var s=Gr(t[0],t[1],e[0],e[1],n.minX,n.maxY,n.maxX,n.maxY);return 0===s?0:Math.min(r,i,o,s)}function Er(t,e){return t[0]>=e.minX&&t[0]<=e.maxX&&t[1]>=e.minY&&t[1]<=e.maxY}function zr(t,e,n){for(var r,i,o,s,a=Math.min(t[0],e[0]),l=Math.min(t[1],e[1]),u=Math.max(t[0],e[0]),h=Math.max(t[1],e[1]),c=n.search({minX:a,minY:l,maxX:u,maxY:h}),f=0;f<c.length;f++)if(r=c[f].p,i=c[f].next.p,o=t,r!==(s=e)&&i!==o&&$r(r,i,o)>0!=$r(r,i,s)>0&&$r(o,s,r)>0!=$r(o,s,i)>0)return!1;return!0}function $r(t,e,n){return Yr(t[0],t[1],e[0],e[1],n[0],n[1])}function Dr(t){var e=t.p,n=t.next.p;return t.minX=Math.min(e[0],n[0]),t.minY=Math.min(e[1],n[1]),t.maxX=Math.max(e[0],n[0]),t.maxY=Math.max(e[1],n[1]),t}function qr(t,e){var n={p:t,prev:null,next:null,minX:0,minY:0,maxX:0,maxY:0};return e?(n.next=e.next,n.prev=e,e.next.prev=n,e.next=n):(n.prev=n,n.next=n),n}function jr(t,e){var n=t[0]-e[0],r=t[1]-e[1];return n*n+r*r}function Zr(t,e,n){var r=e[0],i=e[1],o=n[0]-r,s=n[1]-i;if(0!==o||0!==s){var a=((t[0]-r)*o+(t[1]-i)*s)/(o*o+s*s);a>1?(r=n[0],i=n[1]):a>0&&(r+=o*a,i+=s*a)}return(o=t[0]-r)*o+(s=t[1]-i)*s}function Gr(t,e,n,r,i,o,s,a){var l,u,h,c,f=n-t,p=r-e,d=s-i,g=a-o,y=t-i,x=e-o,m=f*f+p*p,v=f*d+p*g,w=d*d+g*g,M=f*y+p*x,b=d*y+g*x,P=m*w-v*v,_=P,I=P;0===P?(u=0,_=1,c=b,I=w):(c=m*b-v*M,(u=v*b-w*M)<0?(u=0,c=b,I=w):u>_&&(u=_,c=b+v,I=w)),c<0?(c=0,-M<0?u=0:-M>m?u=_:(u=-M,_=m)):c>I&&(c=I,-M+v<0?u=0:-M+v>m?u=_:(u=-M+v,_=m));var A=(1-(h=0===c?0:c/I))*i+h*s-((1-(l=0===u?0:u/_))*t+l*n),S=(1-h)*o+h*a-((1-l)*e+l*r);return A*A+S*S}function Ur(t,e){return t[0]===e[0]?t[1]-e[1]:t[0]-e[0]}const{PackUtil:Rr}=ne();class Jr{constructor(t,e){this.x=t,this.y=e}clone(){return new Jr(this.x,this.y)}normalize(){const t=this.length();this.x/=t,this.y/=t}negate(){this.x=-this.x,this.y=-this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}diff(t){return new Jr(this.x-t.x,this.y-t.y)}distance(t){const e=this.x-t.x,n=this.y-t.y;return Math.sqrt(e*e+n*n)}dot(t){return this.x*t.x+this.y*t.y}equals(t){return this.x===t.x&&this.y===t.y}orthogonal(){return new Jr(this.y,-this.x)}}function Hr(t,e,n,r){const i=e.x*r.y-e.y*r.x,o=n.x-t.x,s=n.y-t.y,a=(o*r.y-s*r.x)/i;return new Jr(t.x+a*e.x,t.y+a*e.y)}const Wr=[],Kr=[];function Qr(t){if(S(t[0]&&t[0].x)){const e=[];let n=0;for(let r=0;r<t.length;r++)Kr[n]?(Kr[n][0]=t[r].x,Kr[n][1]=t[r].y):Kr[n]=[t[r].x,t[r].y],e.push(Kr[n]),n++;t=e}try{const e=Vr(t,1/0);let n=[1/0,1/0],r=[-1/0,-1/0];for(let t=0;t<e.length;t++)e[t][0]<n[0]&&(n[0]=e[t][0]),e[t][0]>r[0]&&(r[0]=e[t][0]),e[t][1]<n[1]&&(n[1]=e[t][1]),e[t][1]>r[1]&&(r[1]=e[t][1]);const i=[];let o=[],s=0;for(let t=0;t<e.length;t++)t===e.length-1&&e[t][0]===e[0][0]&&e[t][1]===e[0][1]||(Pt(i,e[t],"EPSG:3857"),Wr[s]?(Wr[s].x=i[0],Wr[s].y=i[1]):Wr[s]=new Jr(i[0],i[1]),o.push(Wr[s]),s++);Rr.calculateSignedArea(o)<0&&(o=o.reverse());const a=function(t){let e,n=Number.MAX_VALUE;const r=function(t,r,i,o,s,a,l,u){var h=Hr(t,r,s,a),c=Hr(i,o,s,a),f=Hr(l,u,t,r),p=Hr(l,u,i,o),d=h.distance(c)*h.distance(f);0!==d&&d<n&&(e=[h,f,p,c],n=d)};var i=[];for(let e=0;e<t.length;e++)i.push(t[(e+1)%t.length].diff(t[e])),i[e].normalize();var o,s,a,l,u=new Jr(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),h=new Jr(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let e=0;e<t.length;e++){var c=t[e];c.x<u.x&&(u.x=c.x,o=e),c.x>h.x&&(h.x=c.x,s=e),c.y<u.y&&(u.y=c.y,l=e),c.y>h.y&&(h.y=c.y,a=e)}var f=new Jr(0,-1),p=new Jr(0,1),d=new Jr(-1,0),g=new Jr(1,0);for(let e=0;e<t.length;e++){var y=[Math.acos(f.dot(i[o])),Math.acos(p.dot(i[s])),Math.acos(d.dot(i[a])),Math.acos(g.dot(i[l]))];switch(y.indexOf(Math.min.apply(Math,y))){case 0:(p=(f=i[o].clone()).clone()).negate(),(g=(d=f.orthogonal()).clone()).negate(),o=(o+1)%t.length;break;case 1:(f=(p=i[s].clone()).clone()).negate(),(g=(d=f.orthogonal()).clone()).negate(),s=(s+1)%t.length;break;case 2:(g=(d=i[a].clone()).clone()).negate(),(p=(f=g.orthogonal()).clone()).negate(),a=(a+1)%t.length;break;case 3:(d=(g=i[l].clone()).clone()).negate(),(p=(f=g.orthogonal()).clone()).negate(),l=(l+1)%t.length}r(t[o],f,t[s],p,t[a],d,t[l],g)}return e}(o);if(!a||4!==a.length)return null;const l=a[0].distance(a[1]),u=a[1].distance(a[2]),h=a.map((t=>[t.x,t.y]));return h.push(+(u>l)),h}catch(t){return null}}const ti=[];function ei(t,e){const n=Array.isArray(t&&t[0]&&t[0][0]);for(let r=0;r<t.length;r++)n?t[r]=ei(t[r]):(Pt(ti,t[r],e),t[r][0]=ti[0],t[r][1]=ti[1]);return t}const{PackUtil:ni}=ne();class ri extends kn{constructor(t,e,n,r,i,o){super(t,e,n,r,i),(e=e||{}).extent||(e.extent=8192),this.setData(e.data,o)}setData(t,e){if(delete this.index,function(t){if(!t)return!0;if(Array.isArray(t)&&!t.length)return!0;if(t.features&&!t.features.length)return!0;return!1}(t))return this.empty=!0,void e();const n={maxZoom:24,tolerance:this.options.simplifyTolerance,extent:this.options.extent,buffer:S(this.options.tileBuffer)?this.options.tileBuffer:64,hasAltitude:!!this.options.hasAltitude,debug:0,lineMetrics:!0,indexMaxZoom:5,indexMaxPoints:1e5,disableFilter:!0};if(this.options.projection&&(n.projection=this.options.projection,"EPSG:4490"===n.projection&&(n.projection="EPSG:4326")),A(t)&&"{"!=t.substring(0,1)||t.url){const r=t.url?t.url:t;C.getJSON(r,t.url?t:{},((t,i)=>{if(t&&(console.error("Failed to fetch geojson:"+r),e(t)),!i)return void e(null,{extent:null,idMap:{}});let o=i;if(this.options.convertFn){o=new Function("data",this.options.convertFn+"\\nreturn convert(data)")(o)}const s=Array.isArray(o)?o:o.features;this._genOMBB(s);const{sample1000:a,idMap:l}=this._generateId(s);this._generate(a,l,o,n,e)}))}else{"string"==typeof t&&(t=JSON.parse(t));const r=Array.isArray(t)?t:t.features,i=r&&r.length;this._genOMBB(r);let o=r;if(r&&i>1e3){o=[];for(let t=0;t<i;t++)ii(r[t],o,t,i)}this._generate(o,null,t,n,e)}}_genOMBB(t){if(this.options.generateOMBB&&t)for(let e=0;e<t.length;e++){const n=t[e];if(n&&n.geometry&&n.geometry.coordinates)if("Polygon"===n.geometry.type){const t=n.geometry.coordinates[0];if(!t)continue;const e=Qr(t,t.length);n.properties=n.properties||{},n.properties[ee]=e}else if("MultiPolygon"===n.geometry.type){const t=n.geometry.coordinates;for(let e=0;e<t.length;e++){if(!t[e])continue;const r=t[e][0];if(!r)continue;const i=Qr(r,r.length);n.properties=n.properties||{},n.properties[ee]=n.properties[ee]||[],n.properties[ee][e]=i}}}}_generate(t,e,n,r,i){try{const o=t&&t.length?function(t){let e=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY];switch(t.type){case"FeatureCollection":const n=t.features.length;for(let r=0;r<n;r++)Zn(t.features[r],e);break;case"Feature":Zn(t,e);break;default:Gn(t,e)}return e}({type:"FeatureCollection",features:t}):null;this.index=function(t,e){return new ut(t,e)}(n,this.options.geojsonvt||r),i(null,{extent:o,idMap:e})}catch(t){console.warn(t),i({error:t.message})}}_generateId(t){const e=[],n={};let r=0;const i=this.options.featureIdProperty;if(t){const o=t.length;t.forEach(((t,s)=>{!function(t,o,s){if(t&&("Feature"!==t.type||t.geometry)){if(S(t.id)||(t.id=r++),i){let e=i;F(i)&&(e=i[t.layer||"0"]),t.id=t.properties[e]}n[t.id]=I({},t),t.geometry?(n[t.id].geometry=I({},t.geometry),n[t.id].geometry.coordinates=null):t.coordinates&&(n[t.id].coordinates=null),ii(t,e,o,s)}}(t,s,o)}))}return{sample1000:e,idMap:n}}getTileFeatures(t,e){const n=t.tileInfo,r=[];if(!this.index)return this.empty?(setTimeout((function(){e(null,r,[])}),1),1):(setTimeout((function(){e({loading:!0})}),1),1);const i=this.index.getTile(n.z,n.x,n.y);if(!i||0===i.features.length)return setTimeout((function(){e(null,r,[])}),1),1;const o=[];for(let t=0,e=i.features.length;t<e;t++){const e=i.features[t];let n=e.layer;void 0===n&&(n="0"),o[n]={types:{}};o[n].types[e.type]=1,e.tags=e.tags||{},e.geometry.converted||(ni.convertGeometry(e),e.geometry.converted=1),r.push({type:e.type,layer:n,id:e.id,geometry:e.geometry,properties:e.tags,extent:this.options.extent})}for(const t in o)o[t].types=Object.keys(o[t].types).map((t=>+t));return setTimeout((function(){e(null,r,o)}),1),1}onRemove(){super.onRemove(),delete this.index}}function ii(t,e,n,r){const i=Math.floor(r/998);(0===n||n===r-1||(0===i||n%i==0)&&e.length<999)&&e.push(t)}var oi={\n/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */\nread:function(t,e,n,r,i){var o,s,a=8*i-r-1,l=(1<<a)-1,u=l>>1,h=-7,c=n?i-1:0,f=n?-1:1,p=t[e+c];for(c+=f,o=p&(1<<-h)-1,p>>=-h,h+=a;h>0;o=256*o+t[e+c],c+=f,h-=8);for(s=o&(1<<-h)-1,o>>=-h,h+=r;h>0;s=256*s+t[e+c],c+=f,h-=8);if(0===o)o=1-u;else{if(o===l)return s?NaN:1/0*(p?-1:1);s+=Math.pow(2,r),o-=u}return(p?-1:1)*s*Math.pow(2,o-r)},write:function(t,e,n,r,i,o){var s,a,l,u=8*o-i-1,h=(1<<u)-1,c=h>>1,f=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,p=r?0:o-1,d=r?1:-1,g=e<0||0===e&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(a=isNaN(e)?1:0,s=h):(s=Math.floor(Math.log(e)/Math.LN2),e*(l=Math.pow(2,-s))<1&&(s--,l*=2),(e+=s+c>=1?f/l:f*Math.pow(2,1-c))*l>=2&&(s++,l/=2),s+c>=h?(a=0,s=h):s+c>=1?(a=(e*l-1)*Math.pow(2,i),s+=c):(a=e*Math.pow(2,c-1)*Math.pow(2,i),s=0));i>=8;t[n+p]=255&a,p+=d,a/=256,i-=8);for(s=s<<i|a,u+=i;u>0;t[n+p]=255&s,p+=d,s/=256,u-=8);t[n+p-d]|=128*g}},si=li,ai=oi;function li(t){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(t)?t:new Uint8Array(t||0),this.pos=0,this.type=0,this.length=this.buf.length}li.Varint=0,li.Fixed64=1,li.Bytes=2,li.Fixed32=5;var ui=4294967296,hi=1/ui,ci="undefined"==typeof TextDecoder?null:new TextDecoder("utf8");function fi(t){return t.type===li.Bytes?t.readVarint()+t.pos:t.pos+1}function pi(t,e,n){return n?4294967296*e+(t>>>0):4294967296*(e>>>0)+(t>>>0)}function di(t,e,n){var r=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(7*Math.LN2));n.realloc(r);for(var i=n.pos-1;i>=t;i--)n.buf[i+r]=n.buf[i]}function gi(t,e){for(var n=0;n<t.length;n++)e.writeVarint(t[n])}function yi(t,e){for(var n=0;n<t.length;n++)e.writeSVarint(t[n])}function xi(t,e){for(var n=0;n<t.length;n++)e.writeFloat(t[n])}function mi(t,e){for(var n=0;n<t.length;n++)e.writeDouble(t[n])}function vi(t,e){for(var n=0;n<t.length;n++)e.writeBoolean(t[n])}function wi(t,e){for(var n=0;n<t.length;n++)e.writeFixed32(t[n])}function Mi(t,e){for(var n=0;n<t.length;n++)e.writeSFixed32(t[n])}function bi(t,e){for(var n=0;n<t.length;n++)e.writeFixed64(t[n])}function Pi(t,e){for(var n=0;n<t.length;n++)e.writeSFixed64(t[n])}function _i(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16)+16777216*t[e+3]}function Ii(t,e,n){t[n]=e,t[n+1]=e>>>8,t[n+2]=e>>>16,t[n+3]=e>>>24}function Ai(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16)+(t[e+3]<<24)}li.prototype={destroy:function(){this.buf=null},readFields:function(t,e,n){for(n=n||this.length;this.pos<n;){var r=this.readVarint(),i=r>>3,o=this.pos;this.type=7&r,t(i,e,this),this.pos===o&&this.skip(r)}return e},readMessage:function(t,e){return this.readFields(t,e,this.readVarint()+this.pos)},readFixed32:function(){var t=_i(this.buf,this.pos);return this.pos+=4,t},readSFixed32:function(){var t=Ai(this.buf,this.pos);return this.pos+=4,t},readFixed64:function(){var t=_i(this.buf,this.pos)+_i(this.buf,this.pos+4)*ui;return this.pos+=8,t},readSFixed64:function(){var t=_i(this.buf,this.pos)+Ai(this.buf,this.pos+4)*ui;return this.pos+=8,t},readFloat:function(){var t=ai.read(this.buf,this.pos,!0,23,4);return this.pos+=4,t},readDouble:function(){var t=ai.read(this.buf,this.pos,!0,52,8);return this.pos+=8,t},readVarint:function(t){var e,n,r=this.buf;return e=127&(n=r[this.pos++]),n<128?e:(e|=(127&(n=r[this.pos++]))<<7,n<128?e:(e|=(127&(n=r[this.pos++]))<<14,n<128?e:(e|=(127&(n=r[this.pos++]))<<21,n<128?e:function(t,e,n){var r,i,o=n.buf;if(i=o[n.pos++],r=(112&i)>>4,i<128)return pi(t,r,e);if(i=o[n.pos++],r|=(127&i)<<3,i<128)return pi(t,r,e);if(i=o[n.pos++],r|=(127&i)<<10,i<128)return pi(t,r,e);if(i=o[n.pos++],r|=(127&i)<<17,i<128)return pi(t,r,e);if(i=o[n.pos++],r|=(127&i)<<24,i<128)return pi(t,r,e);if(i=o[n.pos++],r|=(1&i)<<31,i<128)return pi(t,r,e);throw new Error("Expected varint not more than 10 bytes")}(e|=(15&(n=r[this.pos]))<<28,t,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var t=this.readVarint();return t%2==1?(t+1)/-2:t/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var t=this.readVarint()+this.pos,e=this.pos;return this.pos=t,t-e>=12&&ci?function(t,e,n){return ci.decode(t.subarray(e,n))}(this.buf,e,t):function(t,e,n){var r="",i=e;for(;i<n;){var o,s,a,l=t[i],u=null,h=l>239?4:l>223?3:l>191?2:1;if(i+h>n)break;1===h?l<128&&(u=l):2===h?128==(192&(o=t[i+1]))&&(u=(31&l)<<6|63&o)<=127&&(u=null):3===h?(o=t[i+1],s=t[i+2],128==(192&o)&&128==(192&s)&&((u=(15&l)<<12|(63&o)<<6|63&s)<=2047||u>=55296&&u<=57343)&&(u=null)):4===h&&(o=t[i+1],s=t[i+2],a=t[i+3],128==(192&o)&&128==(192&s)&&128==(192&a)&&((u=(15&l)<<18|(63&o)<<12|(63&s)<<6|63&a)<=65535||u>=1114112)&&(u=null)),null===u?(u=65533,h=1):u>65535&&(u-=65536,r+=String.fromCharCode(u>>>10&1023|55296),u=56320|1023&u),r+=String.fromCharCode(u),i+=h}return r}(this.buf,e,t)},readBytes:function(){var t=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,t);return this.pos=t,e},readPackedVarint:function(t,e){if(this.type!==li.Bytes)return t.push(this.readVarint(e));var n=fi(this);for(t=t||[];this.pos<n;)t.push(this.readVarint(e));return t},readPackedSVarint:function(t){if(this.type!==li.Bytes)return t.push(this.readSVarint());var e=fi(this);for(t=t||[];this.pos<e;)t.push(this.readSVarint());return t},readPackedBoolean:function(t){if(this.type!==li.Bytes)return t.push(this.readBoolean());var e=fi(this);for(t=t||[];this.pos<e;)t.push(this.readBoolean());return t},readPackedFloat:function(t){if(this.type!==li.Bytes)return t.push(this.readFloat());var e=fi(this);for(t=t||[];this.pos<e;)t.push(this.readFloat());return t},readPackedDouble:function(t){if(this.type!==li.Bytes)return t.push(this.readDouble());var e=fi(this);for(t=t||[];this.pos<e;)t.push(this.readDouble());return t},readPackedFixed32:function(t){if(this.type!==li.Bytes)return t.push(this.readFixed32());var e=fi(this);for(t=t||[];this.pos<e;)t.push(this.readFixed32());return t},readPackedSFixed32:function(t){if(this.type!==li.Bytes)return t.push(this.readSFixed32());var e=fi(this);for(t=t||[];this.pos<e;)t.push(this.readSFixed32());return t},readPackedFixed64:function(t){if(this.type!==li.Bytes)return t.push(this.readFixed64());var e=fi(this);for(t=t||[];this.pos<e;)t.push(this.readFixed64());return t},readPackedSFixed64:function(t){if(this.type!==li.Bytes)return t.push(this.readSFixed64());var e=fi(this);for(t=t||[];this.pos<e;)t.push(this.readSFixed64());return t},skip:function(t){var e=7&t;if(e===li.Varint)for(;this.buf[this.pos++]>127;);else if(e===li.Bytes)this.pos=this.readVarint()+this.pos;else if(e===li.Fixed32)this.pos+=4;else{if(e!==li.Fixed64)throw new Error("Unimplemented type: "+e);this.pos+=8}},writeTag:function(t,e){this.writeVarint(t<<3|e)},realloc:function(t){for(var e=this.length||16;e<this.pos+t;)e*=2;if(e!==this.length){var n=new Uint8Array(e);n.set(this.buf),this.buf=n,this.length=e}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(t){this.realloc(4),Ii(this.buf,t,this.pos),this.pos+=4},writeSFixed32:function(t){this.realloc(4),Ii(this.buf,t,this.pos),this.pos+=4},writeFixed64:function(t){this.realloc(8),Ii(this.buf,-1&t,this.pos),Ii(this.buf,Math.floor(t*hi),this.pos+4),this.pos+=8},writeSFixed64:function(t){this.realloc(8),Ii(this.buf,-1&t,this.pos),Ii(this.buf,Math.floor(t*hi),this.pos+4),this.pos+=8},writeVarint:function(t){(t=+t||0)>268435455||t<0?function(t,e){var n,r;t>=0?(n=t%4294967296|0,r=t/4294967296|0):(r=~(-t/4294967296),4294967295^(n=~(-t%4294967296))?n=n+1|0:(n=0,r=r+1|0));if(t>=0x10000000000000000||t<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");e.realloc(10),function(t,e,n){n.buf[n.pos++]=127&t|128,t>>>=7,n.buf[n.pos++]=127&t|128,t>>>=7,n.buf[n.pos++]=127&t|128,t>>>=7,n.buf[n.pos++]=127&t|128,t>>>=7,n.buf[n.pos]=127&t}(n,0,e),function(t,e){var n=(7&t)<<4;if(e.buf[e.pos++]|=n|((t>>>=3)?128:0),!t)return;if(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),!t)return;if(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),!t)return;if(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),!t)return;if(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),!t)return;e.buf[e.pos++]=127&t}(r,e)}(t,this):(this.realloc(4),this.buf[this.pos++]=127&t|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=t>>>7&127))))},writeSVarint:function(t){this.writeVarint(t<0?2*-t-1:2*t)},writeBoolean:function(t){this.writeVarint(Boolean(t))},writeString:function(t){t=String(t),this.realloc(4*t.length),this.pos++;var e=this.pos;this.pos=function(t,e,n){for(var r,i,o=0;o<e.length;o++){if((r=e.charCodeAt(o))>55295&&r<57344){if(!i){r>56319||o+1===e.length?(t[n++]=239,t[n++]=191,t[n++]=189):i=r;continue}if(r<56320){t[n++]=239,t[n++]=191,t[n++]=189,i=r;continue}r=i-55296<<10|r-56320|65536,i=null}else i&&(t[n++]=239,t[n++]=191,t[n++]=189,i=null);r<128?t[n++]=r:(r<2048?t[n++]=r>>6|192:(r<65536?t[n++]=r>>12|224:(t[n++]=r>>18|240,t[n++]=r>>12&63|128),t[n++]=r>>6&63|128),t[n++]=63&r|128)}return n}(this.buf,t,this.pos);var n=this.pos-e;n>=128&&di(e,n,this),this.pos=e-1,this.writeVarint(n),this.pos+=n},writeFloat:function(t){this.realloc(4),ai.write(this.buf,t,this.pos,!0,23,4),this.pos+=4},writeDouble:function(t){this.realloc(8),ai.write(this.buf,t,this.pos,!0,52,8),this.pos+=8},writeBytes:function(t){var e=t.length;this.writeVarint(e),this.realloc(e);for(var n=0;n<e;n++)this.buf[this.pos++]=t[n]},writeRawMessage:function(t,e){this.pos++;var n=this.pos;t(e,this);var r=this.pos-n;r>=128&&di(n,r,this),this.pos=n-1,this.writeVarint(r),this.pos+=r},writeMessage:function(t,e,n){this.writeTag(t,li.Bytes),this.writeRawMessage(e,n)},writePackedVarint:function(t,e){e.length&&this.writeMessage(t,gi,e)},writePackedSVarint:function(t,e){e.length&&this.writeMessage(t,yi,e)},writePackedBoolean:function(t,e){e.length&&this.writeMessage(t,vi,e)},writePackedFloat:function(t,e){e.length&&this.writeMessage(t,xi,e)},writePackedDouble:function(t,e){e.length&&this.writeMessage(t,mi,e)},writePackedFixed32:function(t,e){e.length&&this.writeMessage(t,wi,e)},writePackedSFixed32:function(t,e){e.length&&this.writeMessage(t,Mi,e)},writePackedFixed64:function(t,e){e.length&&this.writeMessage(t,bi,e)},writePackedSFixed64:function(t,e){e.length&&this.writeMessage(t,Pi,e)},writeBytesField:function(t,e){this.writeTag(t,li.Bytes),this.writeBytes(e)},writeFixed32Field:function(t,e){this.writeTag(t,li.Fixed32),this.writeFixed32(e)},writeSFixed32Field:function(t,e){this.writeTag(t,li.Fixed32),this.writeSFixed32(e)},writeFixed64Field:function(t,e){this.writeTag(t,li.Fixed64),this.writeFixed64(e)},writeSFixed64Field:function(t,e){this.writeTag(t,li.Fixed64),this.writeSFixed64(e)},writeVarintField:function(t,e){this.writeTag(t,li.Varint),this.writeVarint(e)},writeSVarintField:function(t,e){this.writeTag(t,li.Varint),this.writeSVarint(e)},writeStringField:function(t,e){this.writeTag(t,li.Bytes),this.writeString(e)},writeFloatField:function(t,e){this.writeTag(t,li.Fixed32),this.writeFloat(e)},writeDoubleField:function(t,e){this.writeTag(t,li.Fixed64),this.writeDouble(e)},writeBooleanField:function(t,e){this.writeVarintField(t,Boolean(e))}};var Si=yr(si),Ti=Fi;function Fi(t,e){this.x=t,this.y=e}Fi.prototype={clone:function(){return new Fi(this.x,this.y)},add:function(t){return this.clone()._add(t)},sub:function(t){return this.clone()._sub(t)},multByPoint:function(t){return this.clone()._multByPoint(t)},divByPoint:function(t){return this.clone()._divByPoint(t)},mult:function(t){return this.clone()._mult(t)},div:function(t){return this.clone()._div(t)},rotate:function(t){return this.clone()._rotate(t)},rotateAround:function(t,e){return this.clone()._rotateAround(t,e)},matMult:function(t){return this.clone()._matMult(t)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(t){return this.x===t.x&&this.y===t.y},dist:function(t){return Math.sqrt(this.distSqr(t))},distSqr:function(t){var e=t.x-this.x,n=t.y-this.y;return e*e+n*n},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(t){return Math.atan2(this.y-t.y,this.x-t.x)},angleWith:function(t){return this.angleWithSep(t.x,t.y)},angleWithSep:function(t,e){return Math.atan2(this.x*e-this.y*t,this.x*t+this.y*e)},_matMult:function(t){var e=t[0]*this.x+t[1]*this.y,n=t[2]*this.x+t[3]*this.y;return this.x=e,this.y=n,this},_add:function(t){return this.x+=t.x,this.y+=t.y,this},_sub:function(t){return this.x-=t.x,this.y-=t.y,this},_mult:function(t){return this.x*=t,this.y*=t,this},_div:function(t){return this.x/=t,this.y/=t,this},_multByPoint:function(t){return this.x*=t.x,this.y*=t.y,this},_divByPoint:function(t){return this.x/=t.x,this.y/=t.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var t=this.y;return this.y=this.x,this.x=-t,this},_rotate:function(t){var e=Math.cos(t),n=Math.sin(t),r=e*this.x-n*this.y,i=n*this.x+e*this.y;return this.x=r,this.y=i,this},_rotateAround:function(t,e){var n=Math.cos(t),r=Math.sin(t),i=e.x+n*(this.x-e.x)-r*(this.y-e.y),o=e.y+r*(this.x-e.x)+n*(this.y-e.y);return this.x=i,this.y=o,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},Fi.convert=function(t){return t instanceof Fi?t:Array.isArray(t)?new Fi(t[0],t[1]):t};var ki=Ti,Li=Bi;function Bi(t,e,n,r,i){this.properties={},this.extent=n,this.type=0,this._pbf=t,this._geometry=-1,this._keys=r,this._values=i,t.readFields(Ci,this,e)}function Ci(t,e,n){1==t?e.id=n.readVarint():2==t?function(t,e){var n=t.readVarint()+t.pos;for(;t.pos<n;){var r=e._keys[t.readVarint()],i=e._values[t.readVarint()];e.properties[r]=i}}(n,e):3==t?e.type=n.readVarint():4==t&&(e._geometry=n.pos)}function Yi(t){for(var e,n,r=0,i=0,o=t.length,s=o-1;i<o;s=i++)e=t[i],r+=((n=t[s]).x-e.x)*(e.y+n.y);return r}Bi.types=["Unknown","Point","LineString","Polygon"],Bi.prototype.loadGeometry=function(){var t=this._pbf;t.pos=this._geometry;for(var e,n=t.readVarint()+t.pos,r=1,i=0,o=0,s=0,a=[];t.pos<n;){if(i<=0){var l=t.readVarint();r=7&l,i=l>>3}if(i--,1===r||2===r)o+=t.readSVarint(),s+=t.readSVarint(),1===r&&(e&&a.push(e),e=[]),e.push(new ki(o,s));else{if(7!==r)throw new Error("unknown command "+r);e&&e.push(e[0].clone())}}return e&&a.push(e),a},Bi.prototype.bbox=function(){var t=this._pbf;t.pos=this._geometry;for(var e=t.readVarint()+t.pos,n=1,r=0,i=0,o=0,s=1/0,a=-1/0,l=1/0,u=-1/0;t.pos<e;){if(r<=0){var h=t.readVarint();n=7&h,r=h>>3}if(r--,1===n||2===n)(i+=t.readSVarint())<s&&(s=i),i>a&&(a=i),(o+=t.readSVarint())<l&&(l=o),o>u&&(u=o);else if(7!==n)throw new Error("unknown command "+n)}return[s,l,a,u]},Bi.prototype.toGeoJSON=function(t,e,n){var r,i,o=this.extent*Math.pow(2,n),s=this.extent*t,a=this.extent*e,l=this.loadGeometry(),u=Bi.types[this.type];function h(t){for(var e=0;e<t.length;e++){var n=t[e],r=180-360*(n.y+a)/o;t[e]=[360*(n.x+s)/o-180,360/Math.PI*Math.atan(Math.exp(r*Math.PI/180))-90]}}switch(this.type){case 1:var c=[];for(r=0;r<l.length;r++)c[r]=l[r][0];h(l=c);break;case 2:for(r=0;r<l.length;r++)h(l[r]);break;case 3:for(l=function(t){var e=t.length;if(e<=1)return[t];for(var n,r,i=[],o=0;o<e;o++){var s=Yi(t[o]);0!==s&&(void 0===r&&(r=s<0),r===s<0?(n&&i.push(n),n=[t[o]]):n.push(t[o]))}n&&i.push(n);return i}(l),r=0;r<l.length;r++)for(i=0;i<l[r].length;i++)h(l[r][i])}1===l.length?l=l[0]:u="Multi"+u;var f={type:"Feature",geometry:{type:u,coordinates:l},properties:this.properties};return"id"in this&&(f.id=this.id),f};var Vi=Li,Oi=Xi;function Xi(t,e){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=t,this._keys=[],this._values=[],this._features=[],t.readFields(Ni,this,e),this.length=this._features.length}function Ni(t,e,n){15===t?e.version=n.readVarint():1===t?e.name=n.readString():5===t?e.extent=n.readVarint():2===t?e._features.push(n.pos):3===t?e._keys.push(n.readString()):4===t&&e._values.push(function(t){var e=null,n=t.readVarint()+t.pos;for(;t.pos<n;){var r=t.readVarint()>>3;e=1===r?t.readString():2===r?t.readFloat():3===r?t.readDouble():4===r?t.readVarint64():5===r?t.readVarint():6===r?t.readSVarint():7===r?t.readBoolean():null}return e}(n))}Xi.prototype.feature=function(t){if(t<0||t>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[t];var e=this._pbf.readVarint()+this._pbf.pos;return new Vi(this._pbf,e,this.extent,this._keys,this._values)};var Ei=Oi,zi=function(t,e){this.layers=t.readFields($i,{},e)};function $i(t,e,n){if(3===t){var r=new Ei(n,n.readVarint()+n.pos);r.length&&(e[r.name]=r)}}var Di=zi;const qi=2,ji=new TextDecoder("utf-8");class Zi extends kn{constructor(t,e,n,r,i,o){super(t,e,n,r,i),e=e||{},o()}getTileFeatures(t,e){const n=t.tileInfo.url,r=t.fetchOptions||{},{altitudePropertyName:i,disableAltitudeWarning:o}=t,s=this._cache.get(n);if(s&&s.cacheIndex===t.workerCacheIndex){const{err:t,data:r}=s;return setTimeout((()=>{this._readTile(n,i,o,t,r,e)}),1)}const{tileArrayBuffer:a}=t;return a?setTimeout((()=>{this._readTile(n,i,o,null,a,e)}),1):(r.referrer=t.referrer,C.getArrayBuffer(n,r,((r,s)=>{this._cache&&(r?r.loading||this._cache.add(n,{err:r,data:s&&s.data,cacheIndex:t.workerCacheIndex}):s&&s.data&&this._cache.add(n,{err:null,data:s.data,cacheIndex:t.workerCacheIndex}),this._readTile(n,i,o,r,s&&s.data,e))})))}_readTile(t,e,n,r,i,o){if(r)return void o(r);let s;try{s=new Di(new Si(i))}catch(r){const e=ji.decode(i);return r.message+="\\n"+t+"\\n"+e,void o(r.message,[],[])}const a=[];if(!s.layers)return void o(null,a,[]);const l={};let u;for(const t in s.layers)if(h=s.layers,c=t,Object.prototype.hasOwnProperty.call(h,c)){l[t]={types:{}};const i=l[t].types;for(let o=0,l=s.layers[t].length;o<l;o++)try{u=s.layers[t].feature(o),i[u.type]=1;const r={type:u.type,layer:t,geometry:u.loadGeometry(),properties:u.properties,extent:u.extent};void 0!==u.id&&(r.id=u.id);let l=r.properties[ee];l&&(A(l)&&(l=JSON.parse(l)),r.properties[ee]=ei(l,"EPSG:3857"));const h=e&&r.properties[e];if(h){const t=Gi(h),e=[];Ui(r.geometry,t,e),e.length&&!n&&(console.warn("feature.geometry is not consistent with altitude values:"),console.warn(JSON.stringify(r,null,2)))}a.push(r)}catch(r){console.warn("error when load vt geometry:",r)}}var h,c;for(const t in l)l[t].types=Object.keys(l[t].types).map((t=>+t));o(null,a,l,{byteLength:i.byteLength})}abortTile(t,e){const n=this.requests[t];delete this.requests[t],n&&n.abort&&n.abort(),this._cancelLoadings(t),e()}onRemove(){super.onRemove();for(const t in this.requests){const e=this.requests[t];e&&e.abort&&e.abort()}this.requests={}}}function Gi(t){const e=atob(t),n=new Uint8Array(e.length);for(let t=0;t<e.length;t++)n[t]=e.charCodeAt(t);return new Float32Array(n.buffer)}function Ui(t,e,n,r){r||(r={index:0});for(let i=0;i<t.length;i++)if(Array.isArray(t[i]))Ui(t[i],e,n,r);else{const o=r.index;k(e[o])?n.push(qi):t[i].z=100*e[o],r.index++}}const{LRUCache:Ri}=ne();let Ji=0;const Hi=new Ri(128);class Wi{constructor(t){this._layers={},this._callbacks={},this.workerId=t}addLayer({actorId:t,mapId:e,layerId:n,params:r},i){if(this._getLayerById(e,n))return;const o=this._genKey(e,n),s=r.type,a=r.options,l=this.send.bind(this,t);this._layers[o]="GeoJSONVectorTileLayer"===s?new ri(n,a,l,Hi,{},i):new Zi(n,a,l,Hi,{},i)}removeLayer({mapId:t,layerId:e},n){const r=this._getLayerById(t,e),i=this._genKey(t,e);delete this._layers[i],r&&r.onRemove(n)}loadTile({mapId:t,layerId:e,params:n},r){const i=this._getLayerById(t,e);i&&i.loadTile(n,r)}abortTile({mapId:t,layerId:e,params:n},r){const i=this._getLayerById(t,e);i&&i.abortTile&&i.abortTile(n.url,r)}removeTile({mapId:t,layerId:e,params:n},r){const i=this._getLayerById(t,e);i&&i.removeTile(n,r)}updateStyle({mapId:t,layerId:e,params:n},r){const i=this._getLayerById(t,e);i&&i.updateStyle(n,r)}updateOptions({mapId:t,layerId:e,params:n},r){const i=this._getLayerById(t,e);i&&i.updateOptions(n,r)}setData({mapId:t,layerId:e,params:n},r){const i=this._getLayerById(t,e);i&&i.setData(n.data,r)}receive(t){const e=t.callback,n=this._callbacks[e];delete this._callbacks[e],n&&t.error?n(new Error(t.error)):n&&n(null,t.data)}send(t,e,n,r,i){const o=i?\`${UR}t}-${UR}Ji++}\`:null;i&&(this._callbacks[o]=i),postMessage({type:"<request>",workerId:this.workerId,actorId:t,command:e,params:n,callback:String(o)},r||[])}_genKey(t,e){return\`${UR}t}-${UR}e}\`}_getLayerById(t,e){const n=this._genKey(t,e);return this._layers[n]}_resetCache(){Hi.reset()}}t.initialize=function(){},t.onmessage=function(t,e){const n=t.data;if(this.dispatcher||(this.dispatcher=new Wi(t.workerId)),"<response>"===t.type)this.dispatcher.workerId===t.workerId&&this.dispatcher.receive(t);else{const r=n.command;this.dispatcher[r]({actorId:t.actorId,mapId:n.mapId,layerId:n.layerId,params:n.params},((t,n,i)=>{t&&404!==t.status&&204!==t.status&&!t.loading&&console.error(r,t),e(t,n,i)}))}}}`;function WR(t){const e=function(){return"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:void 0};if(e().ispace_vt_packers)return;function n(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var i=o;function o(t,e){this.x=t,this.y=e}o.prototype={clone:function(){return new o(this.x,this.y)},add:function(t){return this.clone()._add(t)},sub:function(t){return this.clone()._sub(t)},multByPoint:function(t){return this.clone()._multByPoint(t)},divByPoint:function(t){return this.clone()._divByPoint(t)},mult:function(t){return this.clone()._mult(t)},div:function(t){return this.clone()._div(t)},rotate:function(t){return this.clone()._rotate(t)},rotateAround:function(t,e){return this.clone()._rotateAround(t,e)},matMult:function(t){return this.clone()._matMult(t)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(t){return this.x===t.x&&this.y===t.y},dist:function(t){return Math.sqrt(this.distSqr(t))},distSqr:function(t){var e=t.x-this.x,n=t.y-this.y;return e*e+n*n},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(t){return Math.atan2(this.y-t.y,this.x-t.x)},angleWith:function(t){return this.angleWithSep(t.x,t.y)},angleWithSep:function(t,e){return Math.atan2(this.x*e-this.y*t,this.x*t+this.y*e)},_matMult:function(t){var e=t[2]*this.x+t[3]*this.y;return this.x=t[0]*this.x+t[1]*this.y,this.y=e,this},_add:function(t){return this.x+=t.x,this.y+=t.y,this},_sub:function(t){return this.x-=t.x,this.y-=t.y,this},_mult:function(t){return this.x*=t,this.y*=t,this},_div:function(t){return this.x/=t,this.y/=t,this},_multByPoint:function(t){return this.x*=t.x,this.y*=t.y,this},_divByPoint:function(t){return this.x/=t.x,this.y/=t.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var t=this.y;return this.y=this.x,this.x=-t,this},_rotate:function(t){var e=Math.cos(t),n=Math.sin(t),i=n*this.x+e*this.y;return this.x=e*this.x-n*this.y,this.y=i,this},_rotateAround:function(t,e){var n=Math.cos(t),i=Math.sin(t),o=e.y+i*(this.x-e.x)+n*(this.y-e.y);return this.x=e.x+n*(this.x-e.x)-i*(this.y-e.y),this.y=o,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},o.convert=function(t){return t instanceof o?t:Array.isArray(t)?new o(t[0],t[1]):t};var s=n(i);const a={Point:1,LineString:2,Polygon:3,MultiPoint:4,MultiLineString:5,MultiPolygon:6};function l(t,e={}){var n=[];if("FeatureCollection"===t.type)for(var i=0;i<t.features.length;i++)h(n,t.features[i],e,i);else h(n,"Feature"===t.type?t:{geometry:t},e);return n}function h(t,e,n,i){if(e.geometry&&e.geometry.geometry){var o=e.geometry.coordinates,s=e.geometry.type,a=[],l=e.id;if(n.promoteId?l=e.properties[n.promoteId]:n.generateId&&(l=i||0),"Point"===s)c(o,a);else if("MultiPoint"===s)for(var A=0;A<o.length;A++)c(o[A],a);else if("LineString"===s)f([o],a);else if("MultiLineString"===s){if(n.lineMetrics){for(A=0;A<o.length;A++)u(o[A],a=[]),t.push(g(l,"LineString",a,e.properties));return}f(o,a)}else if("Polygon"===s)f(o,a);else{if("MultiPolygon"!==s){if("GeometryCollection"===s){for(A=0;A<e.geometry.geometries.length;A++)h(t,{id:l,geometry:e.geometry.geometries[A],properties:e.properties},n,i);return}return void console.warn(`Input data type(${s}) is not a valid GeoJSON geometry type.`)}for(A=0;A<o.length;A++){var m=[];f(o[A],m),a.push(m)}}t.push(g(l,s,a,e.properties))}}function c(t,e){const n=new s(t[0],t[1]);n.z=100*(t[2]||0),e.push([n])}function u(t,e){for(let n=0;n<t.length;n++){const i=new s(t[n][0],t[n][1]);i.z=100*(t[n][2]||0),e.push(i)}}function f(t,e,n,i){for(var o=0;o<t.length;o++){var s=[];u(t[o],s),e.push(s)}}function g(t,e,n,i){return{id:void 0===t?null:t,type:a[e],geometry:n,properties:i}}function A(t,e,n){n=n||{},this.w=t||64,this.h=e||64,this.autoResize=!!n.autoResize,this.shelves=[],this.freebins=[],this.stats={},this.bins={},this.maxId=0}function m(t,e,n){this.x=0,this.y=t,this.w=this.free=e,this.h=n}function w(t,e,n,i,o,s,a){this.id=t,this.x=e,this.y=n,this.w=i,this.h=o,this.maxw=s||i,this.maxh=a||o,this.refcount=0
/*!
  	 * Codes from mapbox-gl-js
  	 * github.com/mapbox/mapbox-gl-js
  	 * MIT License
  	 */}function T(t,{width:e,height:n},i,o){if(o){if(o.length!==e*n*i)throw new RangeError("mismatched image size")}else o=new Uint8Array(e*n*i);return t.width=e,t.height=n,t.data=o,t}function M(t,{width:e,height:n},i){if(e===t.width&&n===t.height)return;const o=T({},{width:e,height:n},i);C(t,o,{x:0,y:0},{x:0,y:0},{width:Math.min(t.width,e),height:Math.min(t.height,n)},i),t.width=e,t.height=n,t.data=o.data}function C(t,e,n,i,o,s){if(0===o.width||0===o.height)return e;if(o.width>t.width||o.height>t.height||n.x>t.width-o.width||n.y>t.height-o.height)throw new RangeError("out of range source coordinates for image copy");if(o.width>e.width||o.height>e.height||i.x>e.width-o.width||i.y>e.height-o.height)throw new RangeError("out of range destination coordinates for image copy");const a=t.data,l=e.data;if(a===l)return e;for(let h=0;h<o.height;h++){const c=((n.y+h)*t.width+n.x)*s,u=((i.y+h)*e.width+i.x)*s;for(let t=0;t<o.width*s;t++)l[u+t]=a[c+t]}return e}A.prototype.pack=function(t,e){t=[].concat(t),e=e||{};for(var n,i,o,s=[],a=0;a<t.length;a++)if(i=t[a].h||t[a].height,(n=t[a].w||t[a].width)&&i){if(!(o=this.packOne(n,i,t[a].id)))continue;e.inPlace&&(t[a].x=o.x,t[a].y=o.y,t[a].id=o.id),s.push(o)}return this.shrink(),s},A.prototype.packOne=function(t,e,n){var i,o,s,a,l,h,c,u,f={freebin:-1,shelf:-1,waste:1/0},g=0;if("string"==typeof n||"number"==typeof n){if(i=this.getBin(n))return this.ref(i),i;"number"==typeof n&&(this.maxId=Math.max(n,this.maxId))}else n=++this.maxId;for(a=0;a<this.freebins.length;a++){if(e===(i=this.freebins[a]).maxh&&t===i.maxw)return this.allocFreebin(a,t,e,n);e>i.maxh||t>i.maxw||e<=i.maxh&&t<=i.maxw&&(s=i.maxw*i.maxh-t*e)<f.waste&&(f.waste=s,f.freebin=a)}for(a=0;a<this.shelves.length;a++)if(g+=(o=this.shelves[a]).h,!(t>o.free)){if(e===o.h)return this.allocShelf(a,t,e,n);e>o.h||e<o.h&&(s=(o.h-e)*t)<f.waste&&(f.freebin=-1,f.waste=s,f.shelf=a)}return-1!==f.freebin?this.allocFreebin(f.freebin,t,e,n):-1!==f.shelf?this.allocShelf(f.shelf,t,e,n):e<=this.h-g&&t<=this.w?(o=new m(g,this.w,e),this.allocShelf(this.shelves.push(o)-1,t,e,n)):this.autoResize?(l=h=this.h,((c=u=this.w)<=l||t>c)&&(u=2*Math.max(t,c)),(l<c||e>l)&&(h=2*Math.max(e,l)),this.resize(u,h),this.packOne(t,e,n)):null},A.prototype.allocFreebin=function(t,e,n,i){var o=this.freebins.splice(t,1)[0];return o.id=i,o.w=e,o.h=n,o.refcount=0,this.bins[i]=o,this.ref(o),o},A.prototype.allocShelf=function(t,e,n,i){var o=this.shelves[t].alloc(e,n,i);return this.bins[i]=o,this.ref(o),o},A.prototype.shrink=function(){if(this.shelves.length>0){for(var t=0,e=0,n=0;n<this.shelves.length;n++){var i=this.shelves[n];e+=i.h,t=Math.max(i.w-i.free,t)}this.resize(t,e)}},A.prototype.getBin=function(t){return this.bins[t]},A.prototype.ref=function(t){if(1==++t.refcount){var e=t.h;this.stats[e]=1+(0|this.stats[e])}return t.refcount},A.prototype.unref=function(t){return 0===t.refcount?0:(0==--t.refcount&&(this.stats[t.h]--,delete this.bins[t.id],this.freebins.push(t)),t.refcount)},A.prototype.clear=function(){this.shelves=[],this.freebins=[],this.stats={},this.bins={},this.maxId=0},A.prototype.resize=function(t,e){this.w=t,this.h=e;for(var n=0;n<this.shelves.length;n++)this.shelves[n].resize(t);return!0},m.prototype.alloc=function(t,e,n){if(t>this.free||e>this.h)return null;var i=this.x;return this.x+=t,this.free-=t,new w(n,i,this.y,t,e,t,this.h)},m.prototype.resize=function(t){return this.free+=t-this.w,this.w=t,!0};class _{constructor(t,e){T(this,t,1,e)}resize(t){M(this,t,1)}clone(){return new _({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,e,n,i,o){C(t,e,n,i,o,1)}}class v{constructor(t,e){T(this,t,4,e)}resize(t){M(this,t,4)}clone(){return new v({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,e,n,i,o){C(t,e,n,i,o,4)}}function P(t){let e=0;for(let n,i,o=0,s=t.length,a=s-1;o<s;a=o++)if(n=t[o],i=t[a],void 0!==n.x)e+=(i.x-n.x)*(n.y+i.y);else{if(n[2]||i[2])return 1;e+=(i[0]-n[0])*(n[1]+i[1])}return e}function I(t,e,n,i,o){const s=t[e*i],a=t[e*i+1],l=t[n*i],h=t[n*i+1];return s===l&&(s<0||s>o)&&a!==h||a===h&&(a<0||a>o)&&s!==l}function O(t,e,n){let i=n;return e&&t&&(i=+t[e]),isNaN(i)&&(i=n||0),100*i}function E(t,e,n,i,o,s,a){e||0===e||(e=1);const l=O(t.properties,n,i),h=l*e;let c=(s?100*s:0)||l;return o?c=O(t.properties,o,s):a&&(c=l-O(t.properties,a,s)),c*=e,{altitude:h,height:c}}function D(t,e){return e<1/0&&(t.x<0||t.x>e||t.y<0||t.y>e)}function N(t){return null==t}function H(t,e,n){if(t===n||t===e)return t;const i=n-e;return((t-e)%i+i)%i+e}function U(t,e){if(!e)return null;const n=new Map;for(let i=0;i<e.length;i++){const o=e[i],s=t[o];let a=n.get(s);a||(a=[],n.set(s,a)),a.push(o)}return n}function W(t){return!(t&t-1)&&0!==t}
/*!
  	 * Codes from mapbox-gl-js
  	 * github.com/mapbox/mapbox-gl-js
  	 * MIT License
  	 */class k{constructor(t,e,{pixelRatio:n}){this.paddedRect=t,this.pixelRatio=n||1,this.padding=e}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.pixelRatio,(this.paddedRect.h-2*this.padding)/this.pixelRatio]}}class F{constructor(t){this.glyphMap=t,this.build()}build(){const t=this.glyphMap,e=Object.keys(t).length,n={},i=new A(0,0,{autoResize:!0}),o=[],s=e>1?1:0;for(const e in t){const i=t[e],a={x:0,y:0,w:i.data.width+2*s,h:i.data.height+2*s};o.push(a),n[e]=new k(a,s,i)}if(i.pack(o,{inPlace:!0}),!W(i.w)||!W(i.h)){const t=q(i.w),e=q(i.h);i.resize(t,e)}const a=new v({width:i.w,height:i.h});for(const e in t){const i=t[e],o=n[e].paddedRect;v.copy(i.data,a,{x:0,y:0},{x:o.x+s,y:o.y+s},i.data)}this.image=a,this.positions=n}}function q(t){return Math.pow(2,Math.ceil(Math.log(t)/Math.LN2))}
/*!
  	 * Codes from mapbox-gl-js
  	 * github.com/mapbox/mapbox-gl-js
  	 * MIT License
  	 * TODO potpack
  	 */class R{constructor(t){this.glyphMap=t,this.build()}build(){const t=this.glyphMap,e={},n=new A(0,0,{autoResize:!0}),i=[];for(const n in t){const o=t[n],s=e[n]={};for(const t in o){const e=o[+t];if(!e||0===e.bitmap.width||0===e.bitmap.height)continue;const n={x:0,y:0,w:e.bitmap.width+2,h:e.bitmap.height+2};i.push(n),s[t]={rect:n,metrics:e.metrics}}}n.pack(i,{inPlace:!0});const o=new _({width:n.w,height:n.h});for(const n in t){const i=t[n];for(const t in i){const s=i[+t];if(!s||0===s.bitmap.width||0===s.bitmap.height)continue;const a=e[n][t].rect;_.copy(s.bitmap,o,{x:0,y:0},{x:a.x+1,y:a.y+1},s.bitmap)}}this.image=o,this.positions=e}}function X(t){return t<65536?Uint16Array:Uint32Array}function J(t){return(t=Math.abs(t))<128?Int8Array:t<32768?Int16Array:Float32Array}function Q(t){return t<256?Uint8Array:t<65536?Uint16Array:Float32Array}function Y(t,e){const n=t.getLength?t.getLength():t.length;if(t instanceof e)return t.slice(0,n);const i=new e(n);t=t._origin||t;for(let e=0;e<n;e++)i[e]=t[e]||0;return i}function K(t){const e=t.type,n=[];if(1===e||4===e)for(let e=0;e<t.geometry.length;e++)c(t.geometry[e],n);else if(2===e)f(t.geometry,n);else if(3===e)f(t.geometry,n);else if(5===e)f(t.geometry,n);else if(6===e)for(let e=0;e<t.geometry.length;e++){const i=[];f(t.geometry[e],i),n.push(i)}return t.geometry=n,t}let $;const tt={width:100,height:10};let et=!1;try{new OffscreenCanvas(1,1).getContext("2d").fillText("hello",0,0),et=!0}catch(t){et=!1}class B{constructor(t,e={}){if(!Array.isArray(t))return void console.error("colors is not array");if(t.length<2)return void console.error("colors.length should >1");this.colors=t;let n=1/0,i=-1/0;for(let e=0,o=t.length;e<o;e++){const o=t[e][0];n=Math.min(o,n),i=Math.max(o,i)}this.min=n,this.max=i,this.valueOffset=this.max-this.min,this.options=Object.assign({},tt,e),this._initImgData()}getImageData(){return this.imgData}_initImgData(){const t=function(){if(!$){const{width:t,height:e}=tt;et?$=new OffscreenCanvas(t,e):($=document.createElement("canvas"),$.width=t,$.height=e)}return $}(),{width:e,height:n}=this.options;t.width=e,t.height=n;const i=t.getContext("2d");i.clearRect(0,0,t.width,t.height);const o=i.createLinearGradient(0,0,t.width,0),{colors:s,valueOffset:a}=this;for(let t=0,e=s.length;t<e;t++){const[e,n]=s[t];o.addColorStop((e-this.min)/a,n)}i.fillStyle=o,i.fillRect(0,0,t.width,t.height),this.imgData=i.getImageData(0,0,t.width,t.height)}getColor(t){t=Math.max(this.min,t);const e=((t=Math.min(t,this.max))-this.min)/this.valueOffset;let n=Math.round(e*this.imgData.width);n=Math.min(n,this.imgData.width-1);const i=4*n;return[this.imgData.data[i],this.imgData.data[i+1],this.imgData.data[i+2],this.imgData.data[i+3]]}}var nt;function it(t){return null==t}function rt(t){return!it(t)}function ot(t){return""===t}function st(t,e){var n,i,o;if(Gt(t)){var s,a=t.stops&&"object"==typeof t.stops[0][0],l=a||rt(t.property),h=a||!l,c=t.type||e||"exponential";if("exponential"===c)s=ft;else if("interval"===c)s=ut;else if("categorical"===c)s=at;else if("identity"===c)s=xt;else if("color-interpolate"===c)s=vt;else{if("calculate-expression"!==c)throw new Error('Unknown function type "'+c+'"');s=bt}if(a){var u={},f=[];for(let e=0;e<t.stops.length;e++){var g=t.stops[e];void 0===u[g[0].zoom]&&(u[g[0].zoom]={zoom:g[0].zoom,type:t.type,property:t.property,default:t.default,stops:[]}),u[g[0].zoom].stops.push([g[0].value,g[1]])}for(let t in u)f.push([u[t].zoom,st(u[t])]);n=function(e,n){const i=ft({stops:f,base:t.base},e)(e,n);return"function"==typeof i?i(e,n):i},i=!1,o=!1}else h?(n=function(e){const n=s(t,e);return"function"==typeof n?n(e):n},i=!0,o=!1):(n=function(e,n){const i=s(t,n?n[t.property]:null);return"function"==typeof i?i(e,n):i},i=!1,o=!0)}else n=function(){return t},i=!0,o=!0;return n.isZoomConstant=o,n.isFeatureConstant=i,n}function at(t,e){for(let n=0;n<t.stops.length;n++)if(e===t.stops[n][0])return t.stops[n][1];return t.default}function ut(t,e){for(var n=0;n<t.stops.length&&!(e<t.stops[n][0]);n++);return t.stops[Math.max(n-1,0)][1]}function ft(t,e){for(var n=rt(t.base)&&!ot(t.base)?t.base:1,i=0;!(i>=t.stops.length||e<=t.stops[i][0]);)i++;return 0===i?t.stops[i][1]:i===t.stops.length?t.stops[i-1][1]:Ct(e,n,t.stops[i-1][0],t.stops[i][0],t.stops[i-1][1],t.stops[i][1])}"function"==typeof Map&&(nt=new Map);const gt={width:100,height:1};function vt(t,e){const n=t.stops;if(n&&n.length>1){let t;if(nt){const e=JSON.stringify(n);if(!nt.has(e)){const t=new B(n,gt);nt.set(e,t)}t=nt.get(e)}else t=new B(n,gt);const[i,o,s,a]=t.getColor(e);return[i/255,o/255,s/255,a/255]}return n&&1===n.length?n[0][1]:null}function xt(t,e){return i=t.default,rt(n=e)?n:rt(i)?i:rt(o)?o:null;var n,i,o}function bt(t,e){const n=String(t.property),i=t.expression,o=e;function s(e){return it(e)||ot(e)||isNaN(e)?t.default:e}if(!rt(e)||ot(e)||isNaN(e)||e<0)return s(t.default);{const e=function t(e,n,i){const o=Number(i),s=String(n);return Array.isArray(e)?e.map((e=>t(e,s,o))):e===s?o:e}(i,n,o);return s(function e(n){if(!Array.isArray(n)){if("number"==typeof n)return n;throw new Error("Invalid expression format")}{const i=n[0];if(!["+","-","*","/"].includes(i))throw new Error(`Unknown operator: ${i}`);const o=n.slice(1).map((t=>e(t)));switch(i){case"+":return o.reduce(((t,e)=>t+e),0);case"-":return o.reduce(((t,e)=>t-e));case"*":return o.reduce(((t,e)=>t*e),1);case"/":return o.some((t=>0===t))?t.default:o.reduce(((t,e)=>t/e));default:throw new Error(`Unsupported operator: ${i}`)}}}(e))}}function Ct(t,e,n,i,o,s){return"function"==typeof o?function(){var a=o.apply(void 0,arguments),l=s.apply(void 0,arguments);return Ct(t,e,n,i,a,l)}:o.length?function(t,e,n,i,o,s){var a=[];for(let l=0;l<o.length;l++)a[l]=Ot(t,e,n,i,o[l],s[l]);return a}(t,e,n,i,o,s):Ot(t,e,n,i,o,s)}function Ot(t,e,n,i,o,s){var a,l=i-n,h=t-n;return o*(1-(a=1===e?h/l:(Math.pow(e,h)-1)/(Math.pow(e,l)-1)))+s*a}function Gt(t){return t&&"object"==typeof t&&(t.stops||t.property&&"identity"===t.type||t.expression&&"calculate-expression"===t.type)}function $t(t){return oe(t,"exponential")}function ne(t){return oe(t,"interval")}function re(t,e){if(!t)return null;var n=!1;if(Array.isArray(t)){var i,o=[];for(let s=0;s<t.length;s++)(i=re(t[s],e))?(o.push(i),n=!0):o.push(t[s]);return n?o:t}var s,a={__fn_types_loaded:!0},l=[];for(s in t)t.hasOwnProperty(s)&&l.push(s);const h=function(t){Object.defineProperty(a,t,{get:function(){return this["__fn_"+t]||(this["__fn_"+t]=$t(this["_"+t])),this["__fn_"+t].apply(this,e())},set:function(e){this["_"+t]=e},configurable:!0,enumerable:!0})};for(let e=0,i=l.length;e<i;e++)Gt(t[s=l[e]])?(n=!0,a["_"+s]=t[s],h(s)):a[s]=t[s];return n?a:t}function oe(t,e){if(!Gt(t))return function(){return t};let n=!0,i=!0;const o=(t=JSON.parse(JSON.stringify(t))).stops;if(o)for(let t=0;t<o.length;t++)if(Gt(o[t][1])){const s=oe(o[t][1],e);n=n&&s.isZoomConstant,i=i&&s.isFeatureConstant,o[t]=[o[t][0],s]}const s=st(t,e);return s.isZoomConstant=n&&s.isZoomConstant,s.isFeatureConstant=i&&s.isFeatureConstant,s}var ae={exports:{}},he={exports:{}},ce=function(t){return!(!t||"string"==typeof t)&&(t instanceof Array||Array.isArray(t)||t.length>=0&&(t.splice instanceof Function||Object.getOwnPropertyDescriptor(t,t.length-1)&&"String"!==t.constructor.name))},ue=Array.prototype.concat,fe=Array.prototype.slice,ge=he.exports=function(t){for(var e=[],n=0,i=t.length;n<i;n++){var o=t[n];ce(o)?e=ue.call(e,fe.call(o)):e.push(o)}return e};ge.wrap=function(t){return function(){return t(ge(arguments))}};var pe={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},Ae=he.exports,me=Object.hasOwnProperty,ye=Object.create(null);for(var _e in pe)me.call(pe,_e)&&(ye[pe[_e]]=_e);var ve=ae.exports={to:{},get:{}};function xe(t,e,n){return Math.min(Math.max(e,t),n)}function be(t){var e=Math.round(t).toString(16).toUpperCase();return e.length<2?"0"+e:e}ve.get=function(t){var e,n;switch(t.substring(0,3).toLowerCase()){case"hsl":e=ve.get.hsl(t),n="hsl";break;case"hwb":e=ve.get.hwb(t),n="hwb";break;default:e=ve.get.rgb(t),n="rgb"}return e?{model:n,value:e}:null},ve.get.rgb=function(t){if(!t)return null;var e,n,i,o=[0,0,0,1];if(e=t.match(/^#([a-f0-9]{6})([a-f0-9]{2})?$/i)){for(i=e[2],e=e[1],n=0;n<3;n++){var s=2*n;o[n]=parseInt(e.slice(s,s+2),16)}i&&(o[3]=parseInt(i,16)/255)}else if(e=t.match(/^#([a-f0-9]{3,4})$/i)){for(i=(e=e[1])[3],n=0;n<3;n++)o[n]=parseInt(e[n]+e[n],16);i&&(o[3]=parseInt(i+i,16)/255)}else if(e=t.match(/^rgba?\(\s*([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/)){for(n=0;n<3;n++)o[n]=parseInt(e[n+1],0);e[4]&&(o[3]=e[5]?.01*parseFloat(e[4]):parseFloat(e[4]))}else{if(!(e=t.match(/^rgba?\(\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/)))return(e=t.match(/^(\w+)$/))?"transparent"===e[1]?[0,0,0,0]:me.call(pe,e[1])?((o=pe[e[1]])[3]=1,o):null:null;for(n=0;n<3;n++)o[n]=Math.round(2.55*parseFloat(e[n+1]));e[4]&&(o[3]=e[5]?.01*parseFloat(e[4]):parseFloat(e[4]))}for(n=0;n<3;n++)o[n]=xe(o[n],0,255);return o[3]=xe(o[3],0,1),o},ve.get.hsl=function(t){if(!t)return null;var e=t.match(/^hsla?\(\s*([+-]?(?:\d{0,3}\.)?\d+)(?:deg)?\s*,?\s*([+-]?[\d\.]+)%\s*,?\s*([+-]?[\d\.]+)%\s*(?:[,|\/]\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/);if(e){var n=parseFloat(e[4]);return[(parseFloat(e[1])%360+360)%360,xe(parseFloat(e[2]),0,100),xe(parseFloat(e[3]),0,100),xe(isNaN(n)?1:n,0,1)]}return null},ve.get.hwb=function(t){if(!t)return null;var e=t.match(/^hwb\(\s*([+-]?\d{0,3}(?:\.\d+)?)(?:deg)?\s*,\s*([+-]?[\d\.]+)%\s*,\s*([+-]?[\d\.]+)%\s*(?:,\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/);if(e){var n=parseFloat(e[4]);return[(parseFloat(e[1])%360+360)%360,xe(parseFloat(e[2]),0,100),xe(parseFloat(e[3]),0,100),xe(isNaN(n)?1:n,0,1)]}return null},ve.to.hex=function(){var t=Ae(arguments);return"#"+be(t[0])+be(t[1])+be(t[2])+(t[3]<1?be(Math.round(255*t[3])):"")},ve.to.rgb=function(){var t=Ae(arguments);return t.length<4||1===t[3]?"rgb("+Math.round(t[0])+", "+Math.round(t[1])+", "+Math.round(t[2])+")":"rgba("+Math.round(t[0])+", "+Math.round(t[1])+", "+Math.round(t[2])+", "+t[3]+")"},ve.to.rgb.percent=function(){var t=Ae(arguments),e=Math.round(t[0]/255*100),n=Math.round(t[1]/255*100),i=Math.round(t[2]/255*100);return t.length<4||1===t[3]?"rgb("+e+"%, "+n+"%, "+i+"%)":"rgba("+e+"%, "+n+"%, "+i+"%, "+t[3]+")"},ve.to.hsl=function(){var t=Ae(arguments);return t.length<4||1===t[3]?"hsl("+t[0]+", "+t[1]+"%, "+t[2]+"%)":"hsla("+t[0]+", "+t[1]+"%, "+t[2]+"%, "+t[3]+")"},ve.to.hwb=function(){var t=Ae(arguments),e="";return t.length>=4&&1!==t[3]&&(e=", "+t[3]),"hwb("+t[0]+", "+t[1]+"%, "+t[2]+"%"+e+")"},ve.to.keyword=function(t){return ye[t.slice(0,3)]};var we=ae.exports,Me={exports:{}},Ee={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},ke={};for(var Re in Ee)Ee.hasOwnProperty(Re)&&(ke[Ee[Re]]=Re);var Le=Me.exports={rgb:{channels:3,labels:"rgb"},hsl:{channels:3,labels:"hsl"},hsv:{channels:3,labels:"hsv"},hwb:{channels:3,labels:"hwb"},cmyk:{channels:4,labels:"cmyk"},xyz:{channels:3,labels:"xyz"},lab:{channels:3,labels:"lab"},lch:{channels:3,labels:"lch"},hex:{channels:1,labels:["hex"]},keyword:{channels:1,labels:["keyword"]},ansi16:{channels:1,labels:["ansi16"]},ansi256:{channels:1,labels:["ansi256"]},hcg:{channels:3,labels:["h","c","g"]},apple:{channels:3,labels:["r16","g16","b16"]},gray:{channels:1,labels:["gray"]}};for(var Fe in Le)if(Le.hasOwnProperty(Fe)){if(!("channels"in Le[Fe]))throw new Error("missing channels property: "+Fe);if(!("labels"in Le[Fe]))throw new Error("missing channel labels property: "+Fe);if(Le[Fe].labels.length!==Le[Fe].channels)throw new Error("channel and label counts mismatch: "+Fe);var He=Le[Fe].channels,Ge=Le[Fe].labels;delete Le[Fe].channels,delete Le[Fe].labels,Object.defineProperty(Le[Fe],"channels",{value:He}),Object.defineProperty(Le[Fe],"labels",{value:Ge})}Le.rgb.hsl=function(t){var e,n,i=t[0]/255,o=t[1]/255,s=t[2]/255,a=Math.min(i,o,s),l=Math.max(i,o,s),h=l-a;return l===a?e=0:i===l?e=(o-s)/h:o===l?e=2+(s-i)/h:s===l&&(e=4+(i-o)/h),(e=Math.min(60*e,360))<0&&(e+=360),n=(a+l)/2,[e,100*(l===a?0:n<=.5?h/(l+a):h/(2-l-a)),100*n]},Le.rgb.hsv=function(t){var e,n,i,o,s,a=t[0]/255,l=t[1]/255,h=t[2]/255,c=Math.max(a,l,h),u=c-Math.min(a,l,h),f=function(t){return(c-t)/6/u+.5};return 0===u?o=s=0:(s=u/c,e=f(a),n=f(l),i=f(h),a===c?o=i-n:l===c?o=1/3+e-i:h===c&&(o=2/3+n-e),o<0?o+=1:o>1&&(o-=1)),[360*o,100*s,100*c]},Le.rgb.hwb=function(t){var e=t[0],n=t[1],i=t[2];return[Le.rgb.hsl(t)[0],1/255*Math.min(e,Math.min(n,i))*100,100*(i=1-1/255*Math.max(e,Math.max(n,i)))]},Le.rgb.cmyk=function(t){var e,n=t[0]/255,i=t[1]/255,o=t[2]/255;return[100*((1-n-(e=Math.min(1-n,1-i,1-o)))/(1-e)||0),100*((1-i-e)/(1-e)||0),100*((1-o-e)/(1-e)||0),100*e]},Le.rgb.keyword=function(t){var e=ke[t];if(e)return e;var n,i,o,s=1/0;for(var a in Ee)if(Ee.hasOwnProperty(a)){var l=(i=t,o=Ee[a],Math.pow(i[0]-o[0],2)+Math.pow(i[1]-o[1],2)+Math.pow(i[2]-o[2],2));l<s&&(s=l,n=a)}return n},Le.keyword.rgb=function(t){return Ee[t]},Le.rgb.xyz=function(t){var e=t[0]/255,n=t[1]/255,i=t[2]/255;return[100*(.4124*(e=e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92)+.3576*(n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92)+.1805*(i=i>.04045?Math.pow((i+.055)/1.055,2.4):i/12.92)),100*(.2126*e+.7152*n+.0722*i),100*(.0193*e+.1192*n+.9505*i)]},Le.rgb.lab=function(t){var e=Le.rgb.xyz(t),n=e[0],i=e[1],o=e[2];return i/=100,o/=108.883,n=(n/=95.047)>.008856?Math.pow(n,1/3):7.787*n+16/116,[116*(i=i>.008856?Math.pow(i,1/3):7.787*i+16/116)-16,500*(n-i),200*(i-(o=o>.008856?Math.pow(o,1/3):7.787*o+16/116))]},Le.hsl.rgb=function(t){var e,n,i,o,s,a=t[0]/360,l=t[1]/100,h=t[2]/100;if(0===l)return[s=255*h,s,s];e=2*h-(n=h<.5?h*(1+l):h+l-h*l),o=[0,0,0];for(var c=0;c<3;c++)(i=a+1/3*-(c-1))<0&&i++,i>1&&i--,o[c]=255*(s=6*i<1?e+6*(n-e)*i:2*i<1?n:3*i<2?e+(n-e)*(2/3-i)*6:e);return o},Le.hsl.hsv=function(t){var e=t[0],n=t[1]/100,i=t[2]/100,o=n,s=Math.max(i,.01);return n*=(i*=2)<=1?i:2-i,o*=s<=1?s:2-s,[e,100*(0===i?2*o/(s+o):2*n/(i+n)),(i+n)/2*100]},Le.hsv.rgb=function(t){var e=t[0]/60,n=t[1]/100,i=t[2]/100,o=Math.floor(e)%6,s=e-Math.floor(e),a=255*i*(1-n),l=255*i*(1-n*s),h=255*i*(1-n*(1-s));switch(i*=255,o){case 0:return[i,h,a];case 1:return[l,i,a];case 2:return[a,i,h];case 3:return[a,l,i];case 4:return[h,a,i];case 5:return[i,a,l]}},Le.hsv.hsl=function(t){var e,n,i,o=t[0],s=t[1]/100,a=t[2]/100,l=Math.max(a,.01);return i=(2-s)*a,n=s*l,[o,100*(n=(n/=(e=(2-s)*l)<=1?e:2-e)||0),100*(i/=2)]},Le.hwb.rgb=function(t){var e,n,i,o,s,a,l,h=t[0]/360,c=t[1]/100,u=t[2]/100,f=c+u;switch(f>1&&(c/=f,u/=f),i=6*h-(e=Math.floor(6*h)),1&e&&(i=1-i),o=c+i*((n=1-u)-c),e){default:case 6:case 0:s=n,a=o,l=c;break;case 1:s=o,a=n,l=c;break;case 2:s=c,a=n,l=o;break;case 3:s=c,a=o,l=n;break;case 4:s=o,a=c,l=n;break;case 5:s=n,a=c,l=o}return[255*s,255*a,255*l]},Le.cmyk.rgb=function(t){var e=t[1]/100,n=t[2]/100,i=t[3]/100;return[255*(1-Math.min(1,t[0]/100*(1-i)+i)),255*(1-Math.min(1,e*(1-i)+i)),255*(1-Math.min(1,n*(1-i)+i))]},Le.xyz.rgb=function(t){var e,n,i,o=t[0]/100,s=t[1]/100,a=t[2]/100;return n=-.9689*o+1.8758*s+.0415*a,i=.0557*o+-.204*s+1.057*a,e=(e=3.2406*o+-1.5372*s+-.4986*a)>.0031308?1.055*Math.pow(e,1/2.4)-.055:12.92*e,n=n>.0031308?1.055*Math.pow(n,1/2.4)-.055:12.92*n,i=i>.0031308?1.055*Math.pow(i,1/2.4)-.055:12.92*i,[255*(e=Math.min(Math.max(0,e),1)),255*(n=Math.min(Math.max(0,n),1)),255*(i=Math.min(Math.max(0,i),1))]},Le.xyz.lab=function(t){var e=t[0],n=t[1],i=t[2];return n/=100,i/=108.883,e=(e/=95.047)>.008856?Math.pow(e,1/3):7.787*e+16/116,[116*(n=n>.008856?Math.pow(n,1/3):7.787*n+16/116)-16,500*(e-n),200*(n-(i=i>.008856?Math.pow(i,1/3):7.787*i+16/116))]},Le.lab.xyz=function(t){var e,n,i;e=t[1]/500+(n=(t[0]+16)/116),i=n-t[2]/200;var o=Math.pow(n,3),s=Math.pow(e,3),a=Math.pow(i,3);return n=o>.008856?o:(n-16/116)/7.787,e=s>.008856?s:(e-16/116)/7.787,i=a>.008856?a:(i-16/116)/7.787,[e*=95.047,n*=100,i*=108.883]},Le.lab.lch=function(t){var e,n=t[0],i=t[1],o=t[2];return(e=360*Math.atan2(o,i)/2/Math.PI)<0&&(e+=360),[n,Math.sqrt(i*i+o*o),e]},Le.lch.lab=function(t){var e,n=t[1];return e=t[2]/360*2*Math.PI,[t[0],n*Math.cos(e),n*Math.sin(e)]},Le.rgb.ansi16=function(t){var e=t[0],n=t[1],i=t[2],o=1 in arguments?arguments[1]:Le.rgb.hsv(t)[2];if(0===(o=Math.round(o/50)))return 30;var s=30+(Math.round(i/255)<<2|Math.round(n/255)<<1|Math.round(e/255));return 2===o&&(s+=60),s},Le.hsv.ansi16=function(t){return Le.rgb.ansi16(Le.hsv.rgb(t),t[2])},Le.rgb.ansi256=function(t){var e=t[0],n=t[1],i=t[2];return e===n&&n===i?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(n/255*5)+Math.round(i/255*5)},Le.ansi16.rgb=function(t){var e=t%10;if(0===e||7===e)return t>50&&(e+=3.5),[e=e/10.5*255,e,e];var n=.5*(1+~~(t>50));return[(1&e)*n*255,(e>>1&1)*n*255,(e>>2&1)*n*255]},Le.ansi256.rgb=function(t){if(t>=232){var e=10*(t-232)+8;return[e,e,e]}var n;return t-=16,[Math.floor(t/36)/5*255,Math.floor((n=t%36)/6)/5*255,n%6/5*255]},Le.rgb.hex=function(t){var e=(((255&Math.round(t[0]))<<16)+((255&Math.round(t[1]))<<8)+(255&Math.round(t[2]))).toString(16).toUpperCase();return"000000".substring(e.length)+e},Le.hex.rgb=function(t){var e=t.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);if(!e)return[0,0,0];var n=e[0];3===e[0].length&&(n=n.split("").map((function(t){return t+t})).join(""));var i=parseInt(n,16);return[i>>16&255,i>>8&255,255&i]},Le.rgb.hcg=function(t){var e,n=t[0]/255,i=t[1]/255,o=t[2]/255,s=Math.max(Math.max(n,i),o),a=Math.min(Math.min(n,i),o),l=s-a;return e=l<=0?0:s===n?(i-o)/l%6:s===i?2+(o-n)/l:4+(n-i)/l+4,e/=6,[360*(e%=1),100*l,100*(l<1?a/(1-l):0)]},Le.hsl.hcg=function(t){var e,n=t[1]/100,i=t[2]/100,o=0;return(e=i<.5?2*n*i:2*n*(1-i))<1&&(o=(i-.5*e)/(1-e)),[t[0],100*e,100*o]},Le.hsv.hcg=function(t){var e=t[2]/100,n=t[1]/100*e,i=0;return n<1&&(i=(e-n)/(1-n)),[t[0],100*n,100*i]},Le.hcg.rgb=function(t){var e=t[1]/100,n=t[2]/100;if(0===e)return[255*n,255*n,255*n];var i,o=[0,0,0],s=t[0]/360%1*6,a=s%1,l=1-a;switch(Math.floor(s)){case 0:o[0]=1,o[1]=a,o[2]=0;break;case 1:o[0]=l,o[1]=1,o[2]=0;break;case 2:o[0]=0,o[1]=1,o[2]=a;break;case 3:o[0]=0,o[1]=l,o[2]=1;break;case 4:o[0]=a,o[1]=0,o[2]=1;break;default:o[0]=1,o[1]=0,o[2]=l}return[255*(e*o[0]+(i=(1-e)*n)),255*(e*o[1]+i),255*(e*o[2]+i)]},Le.hcg.hsv=function(t){var e=t[1]/100,n=e+t[2]/100*(1-e),i=0;return n>0&&(i=e/n),[t[0],100*i,100*n]},Le.hcg.hsl=function(t){var e=t[1]/100,n=t[2]/100*(1-e)+.5*e,i=0;return n>0&&n<.5?i=e/(2*n):n>=.5&&n<1&&(i=e/(2*(1-n))),[t[0],100*i,100*n]},Le.hcg.hwb=function(t){var e=t[1]/100,n=e+t[2]/100*(1-e);return[t[0],100*(n-e),100*(1-n)]},Le.hwb.hcg=function(t){var e=1-t[2]/100,n=e-t[1]/100,i=0;return n<1&&(i=(e-n)/(1-n)),[t[0],100*n,100*i]},Le.apple.rgb=function(t){return[t[0]/65535*255,t[1]/65535*255,t[2]/65535*255]},Le.rgb.apple=function(t){return[t[0]/255*65535,t[1]/255*65535,t[2]/255*65535]},Le.gray.rgb=function(t){return[t[0]/100*255,t[0]/100*255,t[0]/100*255]},Le.gray.hsl=Le.gray.hsv=function(t){return[0,0,t[0]]},Le.gray.hwb=function(t){return[0,100,t[0]]},Le.gray.cmyk=function(t){return[0,0,0,t[0]]},Le.gray.lab=function(t){return[t[0],0,0]},Le.gray.hex=function(t){var e=255&Math.round(t[0]/100*255),n=((e<<16)+(e<<8)+e).toString(16).toUpperCase();return"000000".substring(n.length)+n},Le.rgb.gray=function(t){return[(t[0]+t[1]+t[2])/3/255*100]};var Ue=Me.exports,We=Ue;function qe(t,e){return function(n){return e(t(n))}}function Je(t,e){for(var n=[e[t].parent,t],i=We[e[t].parent][t],o=e[t].parent;e[o].parent;)n.unshift(e[o].parent),i=qe(We[e[o].parent][o],i),o=e[o].parent;return i.conversion=n,i}var Qe=Ue,Ye={};Object.keys(Qe).forEach((function(t){Ye[t]={},Object.defineProperty(Ye[t],"channels",{value:Qe[t].channels}),Object.defineProperty(Ye[t],"labels",{value:Qe[t].labels});var e=function(t){for(var e=function(t){var e=function(){for(var t={},e=Object.keys(We),n=e.length,i=0;i<n;i++)t[e[i]]={distance:-1,parent:null};return t}(),n=[t];for(e[t].distance=0;n.length;)for(var i=n.pop(),o=Object.keys(We[i]),s=o.length,a=0;a<s;a++){var l=o[a],h=e[l];-1===h.distance&&(h.distance=e[i].distance+1,h.parent=i,n.unshift(l))}return e}(t),n={},i=Object.keys(e),o=i.length,s=0;s<o;s++){var a=i[s];null!==e[a].parent&&(n[a]=Je(a,e))}return n}(t);Object.keys(e).forEach((function(n){var i=e[n];Ye[t][n]=function(t){var e=function(e){if(null==e)return e;arguments.length>1&&(e=Array.prototype.slice.call(arguments));var n=t(e);if("object"==typeof n)for(var i=n.length,o=0;o<i;o++)n[o]=Math.round(n[o]);return n};return"conversion"in t&&(e.conversion=t.conversion),e}(i),Ye[t][n].raw=function(t){var e=function(e){return null==e?e:(arguments.length>1&&(e=Array.prototype.slice.call(arguments)),t(e))};return"conversion"in t&&(e.conversion=t.conversion),e}(i)}))}));var Ke=we,tn=Ye,nn=[].slice,rn=["keyword","gray","hex"],on={};Object.keys(tn).forEach((function(t){on[nn.call(tn[t].labels).sort().join("")]=t}));var un={};function pn(t,e){if(!(this instanceof pn))return new pn(t,e);if(e&&e in rn&&(e=null),e&&!(e in tn))throw new Error("Unknown model: "+e);var n,i;if(null==t)this.model="rgb",this.color=[0,0,0],this.valpha=1;else if(t instanceof pn)this.model=t.model,this.color=t.color.slice(),this.valpha=t.valpha;else if("string"==typeof t){var o=Ke.get(t);if(null===o)throw new Error("Unable to parse color from string: "+t);this.model=o.model,this.color=o.value.slice(0,i=tn[this.model].channels),this.valpha="number"==typeof o.value[i]?o.value[i]:1}else if(t.length){this.model=e||"rgb";var s=nn.call(t,0,i=tn[this.model].channels);this.color=xn(s,i),this.valpha="number"==typeof t[i]?t[i]:1}else if("number"==typeof t)t&=16777215,this.model="rgb",this.color=[t>>16&255,t>>8&255,255&t],this.valpha=1;else{this.valpha=1;var a=Object.keys(t);"alpha"in t&&(a.splice(a.indexOf("alpha"),1),this.valpha="number"==typeof t.alpha?t.alpha:0);var l=a.sort().join("");if(!(l in on))throw new Error("Unable to parse color from object: "+JSON.stringify(t));this.model=on[l];var h=tn[this.model].labels,c=[];for(n=0;n<h.length;n++)c.push(t[h[n]]);this.color=xn(c)}if(un[this.model])for(i=tn[this.model].channels,n=0;n<i;n++){var u=un[this.model][n];u&&(this.color[n]=u(this.color[n]))}this.valpha=Math.max(0,Math.min(1,this.valpha)),Object.freeze&&Object.freeze(this)}function yn(t,e,n){return(t=Array.isArray(t)?t:[t]).forEach((function(t){(un[t]||(un[t]=[]))[e]=n})),t=t[0],function(i){var o;return arguments.length?(n&&(i=n(i)),(o=this[t]()).color[e]=i,o):(o=this[t]().color[e],n&&(o=n(o)),o)}}function vn(t){return function(e){return Math.max(0,Math.min(t,e))}}function xn(t,e){for(var n=0;n<e;n++)"number"!=typeof t[n]&&(t[n]=0);return t}pn.prototype={toString:function(){return this.string()},toJSON:function(){return this[this.model]()},string:function(t){var e=this.model in Ke.to?this:this.rgb(),n=1===(e=e.round("number"==typeof t?t:1)).valpha?e.color:e.color.concat(this.valpha);return Ke.to[e.model](n)},percentString:function(t){var e=this.rgb().round("number"==typeof t?t:1),n=1===e.valpha?e.color:e.color.concat(this.valpha);return Ke.to.rgb.percent(n)},array:function(){return 1===this.valpha?this.color.slice():this.color.concat(this.valpha)},object:function(){for(var t={},e=tn[this.model].channels,n=tn[this.model].labels,i=0;i<e;i++)t[n[i]]=this.color[i];return 1!==this.valpha&&(t.alpha=this.valpha),t},unitArray:function(){var t=this.rgb().color;return t[0]/=255,t[1]/=255,t[2]/=255,1!==this.valpha&&t.push(this.valpha),t},unitObject:function(){var t=this.rgb().object();return t.r/=255,t.g/=255,t.b/=255,1!==this.valpha&&(t.alpha=this.valpha),t},round:function(t){return t=Math.max(t||0,0),new pn(this.color.map(function(t){return function(e){return function(t,e){return Number(t.toFixed(e))}(e,t)}}(t)).concat(this.valpha),this.model)},alpha:function(t){return arguments.length?new pn(this.color.concat(Math.max(0,Math.min(1,t))),this.model):this.valpha},red:yn("rgb",0,vn(255)),green:yn("rgb",1,vn(255)),blue:yn("rgb",2,vn(255)),hue:yn(["hsl","hsv","hsl","hwb","hcg"],0,(function(t){return(t%360+360)%360})),saturationl:yn("hsl",1,vn(100)),lightness:yn("hsl",2,vn(100)),saturationv:yn("hsv",1,vn(100)),value:yn("hsv",2,vn(100)),chroma:yn("hcg",1,vn(100)),gray:yn("hcg",2,vn(100)),white:yn("hwb",1,vn(100)),wblack:yn("hwb",2,vn(100)),cyan:yn("cmyk",0,vn(100)),magenta:yn("cmyk",1,vn(100)),yellow:yn("cmyk",2,vn(100)),black:yn("cmyk",3,vn(100)),x:yn("xyz",0,vn(100)),y:yn("xyz",1,vn(100)),z:yn("xyz",2,vn(100)),l:yn("lab",0,vn(100)),a:yn("lab",1),b:yn("lab",2),keyword:function(t){return arguments.length?new pn(t):tn[this.model].keyword(this.color)},hex:function(t){return arguments.length?new pn(t):Ke.to.hex(this.rgb().round().color)},rgbNumber:function(){var t=this.rgb().color;return(255&t[0])<<16|(255&t[1])<<8|255&t[2]},luminosity:function(){for(var t=this.rgb().color,e=[],n=0;n<t.length;n++){var i=t[n]/255;e[n]=i<=.03928?i/12.92:Math.pow((i+.055)/1.055,2.4)}return.2126*e[0]+.7152*e[1]+.0722*e[2]},contrast:function(t){var e=this.luminosity(),n=t.luminosity();return e>n?(e+.05)/(n+.05):(n+.05)/(e+.05)},level:function(t){var e=this.contrast(t);return e>=7.1?"AAA":e>=4.5?"AA":""},isDark:function(){var t=this.rgb().color;return(299*t[0]+587*t[1]+114*t[2])/1e3<128},isLight:function(){return!this.isDark()},negate:function(){for(var t=this.rgb(),e=0;e<3;e++)t.color[e]=255-t.color[e];return t},lighten:function(t){var e=this.hsl();return e.color[2]+=e.color[2]*t,e},darken:function(t){var e=this.hsl();return e.color[2]-=e.color[2]*t,e},saturate:function(t){var e=this.hsl();return e.color[1]+=e.color[1]*t,e},desaturate:function(t){var e=this.hsl();return e.color[1]-=e.color[1]*t,e},whiten:function(t){var e=this.hwb();return e.color[1]+=e.color[1]*t,e},blacken:function(t){var e=this.hwb();return e.color[2]+=e.color[2]*t,e},grayscale:function(){var t=this.rgb().color,e=.3*t[0]+.59*t[1]+.11*t[2];return pn.rgb(e,e,e)},fade:function(t){return this.alpha(this.valpha-this.valpha*t)},opaquer:function(t){return this.alpha(this.valpha+this.valpha*t)},rotate:function(t){var e=this.hsl(),n=e.color[0];return n=(n=(n+t)%360)<0?360+n:n,e.color[0]=n,e},mix:function(t,e){if(!t||!t.rgb)throw new Error('Argument to "mix" was not a Color instance, but rather an instance of '+typeof t);var n=t.rgb(),i=this.rgb(),o=void 0===e?.5:e,s=2*o-1,a=n.alpha()-i.alpha(),l=((s*a==-1?s:(s+a)/(1+s*a))+1)/2,h=1-l;return pn.rgb(l*n.red()+h*i.red(),l*n.green()+h*i.green(),l*n.blue()+h*i.blue(),n.alpha()*o+i.alpha()*(1-o))}},Object.keys(tn).forEach((function(t){if(-1===rn.indexOf(t)){var e=tn[t].channels;pn.prototype[t]=function(){if(this.model===t)return new pn(this);if(arguments.length)return new pn(arguments,t);var n,i="number"==typeof arguments[e]?e:this.valpha;return new pn((n=tn[this.model][t].raw(this.color),Array.isArray(n)?n:[n]).concat(i),t)},pn[t]=function(n){return"number"==typeof n&&(n=xn(nn.call(arguments),e)),new pn(n,t)}}}));var Tn=n(pn);function Mn(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)t[e]=n[e]}return t}function Pn(t){return null==t}function On(t){return"number"==typeof t&&!isNaN(t)}function En(t){return"object"==typeof t&&!!t}function Ln(t){return!Pn(t)&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}function Dn(t){return!Pn(t)&&("function"==typeof t||null!==t.constructor&&t.constructor===Function)}const Fn=Object.prototype.hasOwnProperty;function Nn(t,e){return Fn.call(t,e)}const Hn=Math.PI/180;function Bn(t){return t&&Gt(t)&&t.property}function zn(t){const{verticalCentimeterToPoint:e,tileRatio:n}=t;return e*n}function Gn(t){return"centimeter"===t||"cm"===t?1:"millimeter"===t||"mm"===t?.1:100}const Vn={};function Wn(t,e){if(!Array.isArray(e)){if(e&&void 0!==e.r&&void 0!==e.g&&void 0!==e.b)return t[0]=255*e.r,t[1]=255*e.g,t[2]=255*e.b,t[3]=void 0!==e.a?255*e.a:255,t;e=Vn[e]=Vn[e]||Tn(e).unitArray()}for(let n=0;n<e.length;n++)t[n]=255*e[n];return 3===e.length&&(t[3]=255),t}const qn={textFill:1,textSize:1,textOpacity:1,textDx:1,textDy:1,markerWidth:1,markerHeight:1,markerOpacity:1,markerDx:1,markerDy:1,lineWidth:1,lineColor:1,lineOpacity:1,polygonFill:1,polygonOpacity:1,polygonPatternFileWidth:1,polygonPatternFileOrigin:1,rotationX:1,rotationY:1,rotationZ:1,scaleX:1,scaleY:1,scaleZ:1,translationX:1,translationY:1,translationZ:1},Jn={textName:1,markerTextFitPadding:1,markerTextFit:1,lineGradientProperty:1};var Yn=Object.freeze({__proto__:null,checkIfIdentityZoomDependent:function(t,e,n){if(Array.isArray(n)||(n=Object.values(n)),!n||!n.length)return!1;if(!qn[t])return!1;for(let t=0;t<n.length;t++){const i=n[t]&&(n[t].feature||n[t]);if(!i)continue;const o=i.properties&&i.properties[e];if(o&&Gt(o)&&!$t(o).isZoomConstant)return!0}return!1},checkIfZoomFnTypeSymbol:function(t){return!!qn[t]||!!Jn[t]},evaluate:function(t,e,n){return Dn(t)?t(void 0!==n?n:null,e):t},extend:Mn,getAltitudeToLocal:zn,getTubeSizeScale:Gn,hasOwn:Nn,isFnTypeSymbol:Bn,isFunction:Dn,isInteger:function(t){return(0|t)===t},isNil:Pn,isNumber:On,isObject:En,isString:Ln,join:function(t,e){return t.join?t.join(e||","):Array.prototype.join.call(t,e||",")},normalizeColor:Wn,now:function(){return Date.now()},toDegree:function(t){return t/Hn},toRadian:function(t){return t*Hn}});class dt{constructor(t,e,n,i){this.feature=t,this.symbol=e,this.fnTypes=n,this.options=i}getPolygonResource(){let t=this.symbol.polygonPatternFile;const{polygonPatternFileFn:e}=this.fnTypes;return this._getResource(t,e)}getLineResource(){let t=this.symbol.linePatternFile;const{linePatternFileFn:e}=this.fnTypes;return this._getResource(t,e)}_getResource(t,e){if(e){t=e(this.options.zoom,this.feature.properties)}return t}}function Kn(t,e,n,i){const o=Math.abs(i)>>15,s=o>>1,a=o%2;let l=i%Math.pow(2,15);const h=e+(s<<14)*Math.sign(e),c=n+(a<<14)*Math.sign(n);return t[0]=h,t[1]=c,l=Math.round(l),t[2]=0===l?i<0?-1:0:l,t}const $n=Math.pow(2,14),ei=Math.pow(2,15),ri=["Unknown","Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"];
/*!
  	    Feature Filter by

  	    (c) mapbox 2016 and ispace 2018
  	    www.mapbox.com | www.ispace.org
  	    License: MIT, header required.
  	*/function oi(t){if(!0===t||!1===t)return!0;if(!Array.isArray(t)||0===t.length)return!1;switch(t[0]){case"has":case"!has":return 2===t.length&&("string"==typeof t[1]||t[1].property&&t[1].op);case"in":case"!in":return t.length>=2&&("string"==typeof t[1]||t[1].property&&t[1].op);case"==":case"!=":case">":case">=":case"<":case"<=":return 3===t.length&&("string"==typeof t[1]||t[1].property&&t[1].op);case"none":case"any":case"all":for(const e of t.slice(1))if(!oi(e)&&"boolean"!=typeof e)return!1;return!0;case"contains":return!0;default:return!1}}function ai(t){if(!t)return"true";const e=t[0];if(t.length<=1)return"any"===e?"false":"true";const n="=="===e?ci(t[1],t[2],"===",!1):"!="===e?ci(t[1],t[2],"!==",!1):"<"===e||">"===e||"<="===e||">="===e?ci(t[1],t[2],e,!0):"any"===e?fi(t.slice(1),"||"):"all"===e?fi(t.slice(1),"&&"):"none"===e?pi(fi(t.slice(1),"||")):"in"===e?di(t[1],t.slice(2)):"!in"===e?pi(di(t[1],t.slice(2))):"has"===e?gi(t[1]):"!has"===e?pi(gi(t[1])):"contains"===e?function(t,e,n){const i=li(t);return void 0!==n?`(${i} + '').indexOf("${e}") === ${n}`:`(${i} + '').indexOf("${e}") >= 0`}(t[1],t[2],t[3]):"true";return`(${n})`}function li(t){return"$"===t[0]?"f."+t.substring(1):"p["+JSON.stringify(t)+"]"}function ci(t,e,n,i){return"object"==typeof(o=t)&&o&&t.op?function(t,e,n,i){const o=t.property,s=t.op;let a=li(o);return"length"!==s?(console.error(`not support ${s} op`),"false"):(a=`((${a}+='').length)`,ui(a,o,e,n,i))}(t,e,n,i):ui(li(t),t,e,n,i);var o}function ui(t,e,n,i,o){const s="$type"===e?ri.indexOf(n):JSON.stringify(n);return(o?`typeof ${t}=== typeof ${s}&&`:"")+t+i+s}function fi(t,e){return t.map(ai).join(e)}function di(t,e){"$type"===t&&(e=e.map((t=>ri.indexOf(t))));const n=JSON.stringify(e.sort(Ai)),i=li(t);return e.length<=200?`${n}.indexOf(${i}) !== -1`:`function(v, a, i, j) {\n        while (i <= j) { var m = (i + j) >> 1;\n            if (a[m] === v) return true; if (a[m] > v) j = m - 1; else i = m + 1;\n        }\n    return false; }(${i}, ${n},0,${e.length-1})`}function gi(t){return"$id"===t?'"id" in f':`${JSON.stringify(t)} in p`}function pi(t){return`!(${t})`}function Ai(t,e){return t<e?-1:t>e?1:0}
/*!
  	 * a compact version of mapbox-gl-style-spec
  	 * based on mapbox-gl-style-spec@13.28.0
  	 * https://github.com/mapbox/mapbox-gl-js/tree/main/src/style-spec
  	 * LICENSE : ISC
  	 */var yi="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},_i={exports:{}};function vi(t,...e){for(const n of e)for(const e in n)t[e]=n[e];return t}
/*! https://mths.be/punycode v1.3.2 by @mathias */!function(t,e){!function(n){var i=e&&!e.nodeType&&e,o=t&&!t.nodeType&&t,s="object"==typeof yi&&yi;s.global!==s&&s.window!==s&&s.self!==s||(n=s);var a,l,h=2147483647,c=36,u=26,f=38,g=700,A=/^xn--/,m=/[^\x20-\x7E]/,w=/[\x2E\u3002\uFF0E\uFF61]/g,T={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},M=c-1,C=Math.floor,P=String.fromCharCode;function I(t){throw RangeError(T[t])}function O(t,e){for(var n=t.length,i=[];n--;)i[n]=e(t[n]);return i}function E(t,e){var n=t.split("@"),i="";return n.length>1&&(i=n[0]+"@",t=n[1]),i+O((t=t.replace(w,".")).split("."),e).join(".")}function D(t){for(var e,n,i=[],o=0,s=t.length;o<s;)(e=t.charCodeAt(o++))>=55296&&e<=56319&&o<s?56320==(64512&(n=t.charCodeAt(o++)))?i.push(((1023&e)<<10)+(1023&n)+65536):(i.push(e),o--):i.push(e);return i}function N(t){return O(t,(function(t){var e="";return t>65535&&(e+=P((t-=65536)>>>10&1023|55296),t=56320|1023&t),e+P(t)})).join("")}function H(t,e){return t+22+75*(t<26)-((0!=e)<<5)}function U(t,e,n){var i=0;for(t=n?C(t/g):t>>1,t+=C(t/e);t>M*u>>1;i+=c)t=C(t/M);return C(i+(M+1)*t/(t+f))}function W(t){var e,n,i,o,s,a,l,f,g,A,m,w=[],T=t.length,M=0,P=128,O=72;for((n=t.lastIndexOf("-"))<0&&(n=0),i=0;i<n;++i)t.charCodeAt(i)>=128&&I("not-basic"),w.push(t.charCodeAt(i));for(o=n>0?n+1:0;o<T;){for(s=M,a=1,l=c;o>=T&&I("invalid-input"),((f=(m=t.charCodeAt(o++))-48<10?m-22:m-65<26?m-65:m-97<26?m-97:c)>=c||f>C((h-M)/a))&&I("overflow"),M+=f*a,!(f<(g=l<=O?1:l>=O+u?u:l-O));l+=c)a>C(h/(A=c-g))&&I("overflow"),a*=A;O=U(M-s,e=w.length+1,0==s),C(M/e)>h-P&&I("overflow"),P+=C(M/e),M%=e,w.splice(M++,0,P)}return N(w)}function q(t){var e,n,i,o,s,a,l,f,g,A,m,w,T,M,O,E=[];for(w=(t=D(t)).length,e=128,n=0,s=72,a=0;a<w;++a)(m=t[a])<128&&E.push(P(m));for(i=o=E.length,o&&E.push("-");i<w;){for(l=h,a=0;a<w;++a)(m=t[a])>=e&&m<l&&(l=m);for(l-e>C((h-n)/(T=i+1))&&I("overflow"),n+=(l-e)*T,e=l,a=0;a<w;++a)if((m=t[a])<e&&++n>h&&I("overflow"),m==e){for(f=n,g=c;!(f<(A=g<=s?1:g>=s+u?u:g-s));g+=c)E.push(P(H(A+(O=f-A)%(M=c-A),0))),f=C(O/M);E.push(P(H(f,0))),s=U(n,T,i==o),n=0,++i}++n,++e}return E.join("")}if(a={version:"1.3.2",ucs2:{decode:D,encode:N},decode:W,encode:q,toASCII:function(t){return E(t,(function(t){return m.test(t)?"xn--"+q(t):t}))},toUnicode:function(t){return E(t,(function(t){return A.test(t)?W(t.slice(4).toLowerCase()):t}))}},i&&o)if(t.exports==i)o.exports=a;else for(l in a)a.hasOwnProperty(l)&&(i[l]=a[l]);else n.punycode=a}(yi)}(_i,_i.exports);class Ft extends Error{constructor(t,e){super(e),this.message=e,this.key=t}}var xi=Ft;class Rt{constructor(t,e=[]){this.parent=t,this.bindings={};for(const[t,n]of e)this.bindings[t]=n}concat(t){return new Rt(this,t)}get(t){if(this.bindings[t])return this.bindings[t];if(this.parent)return this.parent.get(t);throw new Error(`${t} not found in scope.`)}has(t){return!!this.bindings[t]||!!this.parent&&this.parent.has(t)}}var bi=Rt;const wi={kind:"null"},Ti={kind:"number"},Mi={kind:"string"},Si={kind:"boolean"},Pi={kind:"color"},Ii={kind:"object"},ki={kind:"value"},Ri={kind:"collator"},Di={kind:"formatted"},Fi={kind:"resolvedImage"};function Hi(t,e){return{kind:"array",itemType:t,N:e}}function zi(t){if("array"===t.kind){const e=zi(t.itemType);return"number"==typeof t.N?`array<${e}, ${t.N}>`:"value"===t.itemType.kind?"array":`array<${e}>`}return t.kind}const Gi=[wi,Ti,Mi,Si,Pi,Di,Ii,Hi(ki),Fi];function Ui(t,e){if("error"===e.kind)return null;if("array"===t.kind){if("array"===e.kind&&(0===e.N&&"value"===e.itemType.kind||!Ui(t.itemType,e.itemType))&&("number"!=typeof t.N||t.N===e.N))return null}else{if(t.kind===e.kind)return null;if("value"===t.kind)for(const t of Gi)if(!Ui(t,e))return null}return`Expected ${zi(t)} but found ${zi(e)} instead.`}function Wi(t,e){return e.some((e=>e.kind===t.kind))}function Zi(t,e){return e.some((e=>"null"===e?null===t:"array"===e?Array.isArray(t):"object"===e?t&&!Array.isArray(t)&&"object"==typeof t:e===typeof t))}var qi,Ji={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function Qi(t){return(t=Math.round(t))<0?0:t>255?255:t}function Yi(t){return t<0?0:t>1?1:t}function Ki(t){return Qi("%"===t[t.length-1]?parseFloat(t)/100*255:parseInt(t))}function $i(t){return Yi("%"===t[t.length-1]?parseFloat(t)/100:parseFloat(t))}function tr(t,e,n){return n<0?n+=1:n>1&&(n-=1),6*n<1?t+(e-t)*n*6:2*n<1?e:3*n<2?t+(e-t)*(2/3-n)*6:t}try{qi={}.parseCSSColor=function(t){var e,n=t.replace(/ /g,"").toLowerCase();if(n in Ji)return Ji[n].slice();if("#"===n[0])return 4===n.length?(e=parseInt(n.substr(1),16))>=0&&e<=4095?[(3840&e)>>4|(3840&e)>>8,240&e|(240&e)>>4,15&e|(15&e)<<4,1]:null:7===n.length&&(e=parseInt(n.substr(1),16))>=0&&e<=16777215?[(16711680&e)>>16,(65280&e)>>8,255&e,1]:null;var i=n.indexOf("("),o=n.indexOf(")");if(-1!==i&&o+1===n.length){var s=n.substr(0,i),a=n.substr(i+1,o-(i+1)).split(","),l=1;switch(s){case"rgba":if(4!==a.length)return null;l=$i(a.pop());case"rgb":return 3!==a.length?null:[Ki(a[0]),Ki(a[1]),Ki(a[2]),l];case"hsla":if(4!==a.length)return null;l=$i(a.pop());case"hsl":if(3!==a.length)return null;var h=(parseFloat(a[0])%360+360)%360/360,c=$i(a[1]),u=$i(a[2]),f=u<=.5?u*(c+1):u+c-u*c,g=2*u-f;return[Qi(255*tr(g,f,h+1/3)),Qi(255*tr(g,f,h)),Qi(255*tr(g,f,h-1/3)),l];default:return null}}return null}}catch(t){}class sn{constructor(t,e,n,i=1){this.r=t,this.g=e,this.b=n,this.a=i}static parse(t){if(!t)return;if(t instanceof sn)return t;if("string"!=typeof t)return;const e=qi(t);return e?new sn(e[0]/255*e[3],e[1]/255*e[3],e[2]/255*e[3],e[3]):void 0}toString(){const[t,e,n,i]=this.toArray();return`rgba(${Math.round(t)},${Math.round(e)},${Math.round(n)},${i})`}toArray(){const{r:t,g:e,b:n,a:i}=this;return 0===i?[0,0,0,0]:[255*t/i,255*e/i,255*n/i,i]}toArray01(){const{r:t,g:e,b:n,a:i}=this;return 0===i?[0,0,0,0]:[t/i,e/i,n/i,i]}toArray01PremultipliedAlpha(){const{r:t,g:e,b:n,a:i}=this;return[t,e,n,i]}}sn.black=new sn(0,0,0,1),sn.white=new sn(1,1,1,1),sn.transparent=new sn(0,0,0,0),sn.red=new sn(1,0,0,1),sn.blue=new sn(0,0,1,1);var er=sn;class an{constructor(t,e,n){this.sensitivity=t?e?"variant":"case":e?"accent":"base",this.locale=n,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(t,e){return this.collator.compare(t,e)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class ln{constructor(t,e,n,i,o){this.text=t.normalize?t.normalize():t,this.image=e,this.scale=n,this.fontStack=i,this.textColor=o}}class hn{constructor(t){this.sections=t}static fromString(t){return new hn([new ln(t,null,null,null,null)])}isEmpty(){return 0===this.sections.length||!this.sections.some((t=>0!==t.text.length||t.image&&0!==t.image.name.length))}static factory(t){return t instanceof hn?t:hn.fromString(t)}toString(){return 0===this.sections.length?"":this.sections.map((t=>t.text)).join("")}serialize(){const t=["format"];for(const e of this.sections){if(e.image){t.push(["image",e.image.name]);continue}t.push(e.text);const n={};e.fontStack&&(n["text-font"]=["literal",e.fontStack.split(",")]),e.scale&&(n["font-scale"]=e.scale),e.textColor&&(n["text-color"]=["rgba"].concat(e.textColor.toArray())),t.push(n)}return t}}class cn{constructor(t){this.name=t.name,this.available=t.available}toString(){return this.name}static fromString(t){return t?new cn({name:t,available:!1}):null}serialize(){return["image",this.name]}}function nr(t,e,n,i){return"number"==typeof t&&t>=0&&t<=255&&"number"==typeof e&&e>=0&&e<=255&&"number"==typeof n&&n>=0&&n<=255?void 0===i||"number"==typeof i&&i>=0&&i<=1?null:`Invalid rgba value [${[t,e,n,i].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${("number"==typeof i?[t,e,n,i]:[t,e,n]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function or(t){if(null===t)return!0;if("string"==typeof t)return!0;if("boolean"==typeof t)return!0;if("number"==typeof t)return!0;if(t instanceof er)return!0;if(t instanceof an)return!0;if(t instanceof hn)return!0;if(t instanceof cn)return!0;if(Array.isArray(t)){for(const e of t)if(!or(e))return!1;return!0}if("object"==typeof t){for(const e in t)if(!or(t[e]))return!1;return!0}return!1}function sr(t){if(null===t)return wi;if("string"==typeof t)return Mi;if("boolean"==typeof t)return Si;if("number"==typeof t)return Ti;if(t instanceof er)return Pi;if(t instanceof an)return Ri;if(t instanceof hn)return Di;if(t instanceof cn)return Fi;if(Array.isArray(t)){const e=t.length;let n;for(const e of t){const t=sr(e);if(n){if(n===t)continue;n=ki;break}n=t}return Hi(n||ki,e)}return Ii}function ar(t){const e=typeof t;return null===t?"":"string"===e||"number"===e||"boolean"===e?String(t):t instanceof er||t instanceof hn||t instanceof cn?t.toString():JSON.stringify(t)}class gn{constructor(t,e){this.type=t,this.value=e}static parse(t,e){if(2!==t.length)return e.error(`'literal' expression requires exactly one argument, but found ${t.length-1} instead.`);if(!or(t[1]))return e.error("invalid value");const n=t[1];let i=sr(n);const o=e.expectedType;return"array"!==i.kind||0!==i.N||!o||"array"!==o.kind||"number"==typeof o.N&&0!==o.N||(i=o),new gn(i,n)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return"array"===this.type.kind||"object"===this.type.kind?["literal",this.value]:this.value instanceof er?["rgba"].concat(this.value.toArray()):this.value instanceof hn?this.value.serialize():this.value}}var lr=gn,hr=class{constructor(t){this.name="ExpressionEvaluationError",this.message=t}toJSON(){return this.message}};const cr={string:Mi,number:Ti,boolean:Si,object:Ii};class _n{constructor(t,e){this.type=t,this.args=e}static parse(t,e){if(t.length<2)return e.error("Expected at least one argument.");let n,i=1;const o=t[0];if("array"===o){let o,s;if(t.length>2){const n=t[1];if("string"!=typeof n||!(n in cr)||"object"===n)return e.error('The item type argument of "array" must be one of string, number, boolean',1);o=cr[n],i++}else o=ki;if(t.length>3){if(null!==t[2]&&("number"!=typeof t[2]||t[2]<0||t[2]!==Math.floor(t[2])))return e.error('The length argument to "array" must be a positive integer literal',2);s=t[2],i++}n=Hi(o,s)}else n=cr[o];const s=[];for(;i<t.length;i++){const n=e.parse(t[i],i,ki);if(!n)return null;s.push(n)}return new _n(n,s)}evaluate(t){for(let e=0;e<this.args.length;e++){const n=this.args[e].evaluate(t);if(!Ui(this.type,sr(n)))return n;if(e===this.args.length-1)throw new hr(`Expected value to be of type ${zi(this.type)}, but found ${zi(sr(n))} instead.`)}return null}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every((t=>t.outputDefined()))}serialize(){const t=this.type,e=[t.kind];if("array"===t.kind){const n=t.itemType;if("string"===n.kind||"number"===n.kind||"boolean"===n.kind){e.push(n.kind);const i=t.N;("number"==typeof i||this.args.length>1)&&e.push(i)}}return e.concat(this.args.map((t=>t.serialize())))}}var fr=_n;class bn{constructor(t){this.type=Di,this.sections=t}static parse(t,e){if(t.length<2)return e.error("Expected at least one argument.");const n=t[1];if(!Array.isArray(n)&&"object"==typeof n)return e.error("First argument must be an image or text section.");const i=[];let o=!1;for(let n=1;n<=t.length-1;++n){const s=t[n];if(o&&"object"==typeof s&&!Array.isArray(s)){o=!1;let t=null;if(s["font-scale"]&&(t=e.parse(s["font-scale"],1,Ti),!t))return null;let n=null;if(s["text-font"]&&(n=e.parse(s["text-font"],1,Hi(Mi)),!n))return null;let a=null;if(s["text-color"]&&(a=e.parse(s["text-color"],1,Pi),!a))return null;const l=i[i.length-1];l.scale=t,l.font=n,l.textColor=a}else{const s=e.parse(t[n],1,ki);if(!s)return null;const a=s.type.kind;if("string"!==a&&"value"!==a&&"null"!==a&&"resolvedImage"!==a)return e.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");o=!0,i.push({content:s,scale:null,font:null,textColor:null})}}return new bn(i)}evaluate(t){return new hn(this.sections.map((e=>{const n=e.content.evaluate(t);return sr(n)===Fi?new ln("",n,null,null,null):new ln(ar(n),null,e.scale?e.scale.evaluate(t):null,e.font?e.font.evaluate(t).join(","):null,e.textColor?e.textColor.evaluate(t):null)})))}eachChild(t){for(const e of this.sections)t(e.content),e.scale&&t(e.scale),e.font&&t(e.font),e.textColor&&t(e.textColor)}outputDefined(){return!1}serialize(){const t=["format"];for(const e of this.sections){t.push(e.content.serialize());const n={};e.scale&&(n["font-scale"]=e.scale.serialize()),e.font&&(n["text-font"]=e.font.serialize()),e.textColor&&(n["text-color"]=e.textColor.serialize()),t.push(n)}return t}}class An{constructor(t){this.type=Fi,this.input=t}static parse(t,e){if(2!==t.length)return e.error("Expected two arguments.");const n=e.parse(t[1],1,Mi);return n?new An(n):e.error("No image name provided.")}evaluate(t){const e=this.input.evaluate(t),n=cn.fromString(e);return n&&t.availableImages&&(n.available=t.availableImages.indexOf(e)>-1),n}eachChild(t){t(this.input)}outputDefined(){return!1}serialize(){return["image",this.input.serialize()]}}const gr={"to-boolean":Si,"to-color":Pi,"to-number":Ti,"to-string":Mi};class wn{constructor(t,e){this.type=t,this.args=e}static parse(t,e){if(t.length<2)return e.error("Expected at least one argument.");const n=t[0];if(("to-boolean"===n||"to-string"===n)&&2!==t.length)return e.error("Expected one argument.");const i=gr[n],o=[];for(let n=1;n<t.length;n++){const i=e.parse(t[n],n,ki);if(!i)return null;o.push(i)}return new wn(i,o)}evaluate(t){if("boolean"===this.type.kind)return Boolean(this.args[0].evaluate(t));if("color"===this.type.kind){let e,n;for(const i of this.args){if(e=i.evaluate(t),n=null,e instanceof er)return e;if("string"==typeof e){const n=t.parseColor(e);if(n)return n}else if(Array.isArray(e)&&(n=e.length<3||e.length>4?`Invalid rbga value ${JSON.stringify(e)}: expected an array containing either three or four numeric values.`:nr(e[0],e[1],e[2],e[3]),!n))return new er(e[0]/255,e[1]/255,e[2]/255,e[3])}throw new hr(n||`Could not parse color from value '${"string"==typeof e?e:String(JSON.stringify(e))}'`)}if("number"===this.type.kind){let e=null;for(const n of this.args){if(e=n.evaluate(t),null===e)return 0;const i=Number(e);if(!isNaN(i))return i}throw new hr(`Could not convert ${JSON.stringify(e)} to number.`)}return"formatted"===this.type.kind?hn.fromString(ar(this.args[0].evaluate(t))):"resolvedImage"===this.type.kind?cn.fromString(ar(this.args[0].evaluate(t))):ar(this.args[0].evaluate(t))}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every((t=>t.outputDefined()))}serialize(){if("formatted"===this.type.kind)return new bn([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if("resolvedImage"===this.type.kind)return new An(this.args[0]).serialize();const t=[`to-${this.type.kind}`];return this.eachChild((e=>{t.push(e.serialize())})),t}}var mr=wn;const yr=["Unknown","Point","LineString","Polygon"];var _r=class{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null}id(){return this.feature&&void 0!==this.feature.id?this.feature.id:null}geometryType(){return this.feature?"number"==typeof this.feature.type?yr[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const t=this.featureDistanceData.center,e=this.featureDistanceData.scale,{x:n,y:i}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(n*e-t[0])+this.featureDistanceData.bearing[1]*(i*e-t[1])}return 0}parseColor(t){let e=this._parseColorCache[t];return e||(e=this._parseColorCache[t]=er.parse(t)),e}};class In{constructor(t,e,n,i){this.name=t,this.type=e,this._evaluate=n,this.args=i}evaluate(t){return this._evaluate(t,this.args)}eachChild(t){this.args.forEach(t)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map((t=>t.serialize())))}static parse(t,e){const n=t[0],i=In.definitions[n];if(!i)return e.error(`Unknown expression "${n}". If you wanted a literal array, use ["literal", [...]].`,0);const o=Array.isArray(i)?i[0]:i.type,s=Array.isArray(i)?[[i[1],i[2]]]:i.overloads,a=s.filter((([e])=>!Array.isArray(e)||e.length===t.length-1));let l=null;for(const[i,s]of a){l=new to(e.registry,e.path,null,e.scope);const a=[];let h=!1;for(let e=1;e<t.length;e++){const n=t[e],o=Array.isArray(i)?i[e-1]:i.type,s=l.parse(n,1+a.length,o);if(!s){h=!0;break}a.push(s)}if(!h)if(Array.isArray(i)&&i.length!==a.length)l.error(`Expected ${i.length} arguments, but found ${a.length} instead.`);else{for(let t=0;t<a.length;t++){const e=Array.isArray(i)?i[t]:i.type,n=a[t];l.concat(t+1).checkSubtype(e,n.type)}if(0===l.errors.length)return new In(n,o,s,a)}}if(1===a.length)e.errors.push(...l.errors);else{const n=(a.length?a:s).map((([t])=>{return e=t,Array.isArray(e)?`(${e.map(zi).join(", ")})`:`(${zi(e.type)}...)`;var e})).join(" | "),i=[];for(let n=1;n<t.length;n++){const o=e.parse(t[n],1+i.length);if(!o)return null;i.push(zi(o.type))}e.error(`Expected arguments of type ${n}, but found (${i.join(", ")}) instead.`)}return null}static register(t,e){In.definitions=e;for(const n in e)t[n]=In}}var vr=In;class kn{constructor(t,e,n){this.type=Ri,this.locale=n,this.caseSensitive=t,this.diacriticSensitive=e}static parse(t,e){if(2!==t.length)return e.error("Expected one argument.");const n=t[1];if("object"!=typeof n||Array.isArray(n))return e.error("Collator options argument must be an object.");const i=e.parse(void 0!==n["case-sensitive"]&&n["case-sensitive"],1,Si);if(!i)return null;const o=e.parse(void 0!==n["diacritic-sensitive"]&&n["diacritic-sensitive"],1,Si);if(!o)return null;let s=null;return n.locale&&(s=e.parse(n.locale,1,Mi),!s)?null:new kn(i,o,s)}evaluate(t){return new an(this.caseSensitive.evaluate(t),this.diacriticSensitive.evaluate(t),this.locale?this.locale.evaluate(t):null)}eachChild(t){t(this.caseSensitive),t(this.diacriticSensitive),this.locale&&t(this.locale)}outputDefined(){return!1}serialize(){const t={};return t["case-sensitive"]=this.caseSensitive.serialize(),t["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(t.locale=this.locale.serialize()),["collator",t]}}const br=8192;function Ir(t,e){t[0]=Math.min(t[0],e[0]),t[1]=Math.min(t[1],e[1]),t[2]=Math.max(t[2],e[0]),t[3]=Math.max(t[3],e[1])}function Or(t,e){return!(t[0]<=e[0]||t[2]>=e[2]||t[1]<=e[1]||t[3]>=e[3])}function Er(t,e){const n=(180+t[0])/360,i=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+t[1]*Math.PI/360)))/360;const o=Math.pow(2,e.z);return[Math.round(n*o*br),Math.round(i*o*br)]}function kr(t,e,n){const i=t[0]-e[0],o=t[1]-e[1],s=t[0]-n[0],a=t[1]-n[1];return i*a-s*o==0&&i*s<=0&&o*a<=0}function Rr(t,e){let n=!1;for(let a=0,l=e.length;a<l;a++){const l=e[a];for(let e=0,a=l.length;e<a-1;e++){if(kr(t,l[e],l[e+1]))return!1;(o=l[e])[1]>(i=t)[1]!=(s=l[e+1])[1]>i[1]&&i[0]<(s[0]-o[0])*(i[1]-o[1])/(s[1]-o[1])+o[0]&&(n=!n)}}var i,o,s;return n}function Lr(t,e){for(let n=0;n<e.length;n++)if(Rr(t,e[n]))return!0;return!1}function Dr(t,e,n,i){const o=i[0]-n[0],s=i[1]-n[1],a=(t[0]-n[0])*s-o*(t[1]-n[1]),l=(e[0]-n[0])*s-o*(e[1]-n[1]);return a>0&&l<0||a<0&&l>0}function Fr(t,e,n,i){return 0!=(o=[i[0]-n[0],i[1]-n[1]])[0]*(s=[e[0]-t[0],e[1]-t[1]])[1]-o[1]*s[0]&&!(!Dr(t,e,n,i)||!Dr(n,i,t,e));var o,s}function Nr(t,e,n){for(const i of n)for(let n=0;n<i.length-1;++n)if(Fr(t,e,i[n],i[n+1]))return!0;return!1}function Br(t,e){for(let n=0;n<t.length;++n)if(!Rr(t[n],e))return!1;for(let n=0;n<t.length-1;++n)if(Nr(t[n],t[n+1],e))return!1;return!0}function zr(t,e){for(let n=0;n<e.length;n++)if(Br(t,e[n]))return!0;return!1}function Gr(t,e,n){const i=[];for(let o=0;o<t.length;o++){const s=[];for(let i=0;i<t[o].length;i++){const a=Er(t[o][i],n);Ir(e,a),s.push(a)}i.push(s)}return i}function Ur(t,e,n){const i=[];for(let o=0;o<t.length;o++){const s=Gr(t[o],e,n);i.push(s)}return i}function Wr(t,e,n,i){if(t[0]<n[0]||t[0]>n[2]){const e=.5*i;let o=t[0]-n[0]>e?-i:n[0]-t[0]>e?i:0;0===o&&(o=t[0]-n[2]>e?-i:n[2]-t[0]>e?i:0),t[0]+=o}Ir(e,t)}function Zr(t,e,n,i){const o=Math.pow(2,i.z)*br,s=[i.x*br,i.y*br],a=[];if(!t)return a;for(const i of t)for(const t of i){const i=[t.x+s[0],t.y+s[1]];Wr(i,e,n,o),a.push(i)}return a}function qr(t,e,n,i){const o=Math.pow(2,i.z)*br,s=[i.x*br,i.y*br],a=[];if(!t)return a;for(const n of t){const t=[];for(const i of n){const n=[i.x+s[0],i.y+s[1]];Ir(e,n),t.push(n)}a.push(t)}if(e[2]-e[0]<=o/2){(l=e)[0]=l[1]=1/0,l[2]=l[3]=-1/0;for(const t of a)for(const i of t)Wr(i,e,n,o)}var l;return a}class Zn{constructor(t,e){this.type=Si,this.geojson=t,this.geometries=e}static parse(t,e){if(2!==t.length)return e.error(`'within' expression requires exactly one argument, but found ${t.length-1} instead.`);if(or(t[1])){const e=t[1];if("FeatureCollection"===e.type)for(let t=0;t<e.features.length;++t){const n=e.features[t].geometry.type;if("Polygon"===n||"MultiPolygon"===n)return new Zn(e,e.features[t].geometry)}else if("Feature"===e.type){const t=e.geometry.type;if("Polygon"===t||"MultiPolygon"===t)return new Zn(e,e.geometry)}else if("Polygon"===e.type||"MultiPolygon"===e.type)return new Zn(e,e)}return e.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(t){if(null!=t.geometry()&&null!=t.canonicalID()){if("Point"===t.geometryType())return function(t,e){const n=[1/0,1/0,-1/0,-1/0],i=[1/0,1/0,-1/0,-1/0],o=t.canonicalID();if(!o)return!1;if("Polygon"===e.type){const s=Gr(e.coordinates,i,o),a=Zr(t.geometry(),n,i,o);if(!Or(n,i))return!1;for(const t of a)if(!Rr(t,s))return!1}if("MultiPolygon"===e.type){const s=Ur(e.coordinates,i,o),a=Zr(t.geometry(),n,i,o);if(!Or(n,i))return!1;for(const t of a)if(!Lr(t,s))return!1}return!0}(t,this.geometries);if("LineString"===t.geometryType())return function(t,e){const n=[1/0,1/0,-1/0,-1/0],i=[1/0,1/0,-1/0,-1/0],o=t.canonicalID();if(!o)return!1;if("Polygon"===e.type){const s=Gr(e.coordinates,i,o),a=qr(t.geometry(),n,i,o);if(!Or(n,i))return!1;for(const t of a)if(!Br(t,s))return!1}if("MultiPolygon"===e.type){const s=Ur(e.coordinates,i,o),a=qr(t.geometry(),n,i,o);if(!Or(n,i))return!1;for(const t of a)if(!zr(t,s))return!1}return!0}(t,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}var Jr=Zn;function Qr(t){if(t instanceof vr){if("get"===t.name&&1===t.args.length)return!1;if("feature-state"===t.name)return!1;if("has"===t.name&&1===t.args.length)return!1;if("properties"===t.name||"geometry-type"===t.name||"id"===t.name)return!1;if(/^filter-/.test(t.name))return!1}if(t instanceof Jr)return!1;let e=!0;return t.eachChild((t=>{e&&!Qr(t)&&(e=!1)})),e}function Yr(t){if(t instanceof vr&&"feature-state"===t.name)return!1;let e=!0;return t.eachChild((t=>{e&&!Yr(t)&&(e=!1)})),e}function Kr(t,e){if(t instanceof vr&&e.indexOf(t.name)>=0)return!1;let n=!0;return t.eachChild((t=>{n&&!Kr(t,e)&&(n=!1)})),n}class Qn{constructor(t,e){this.type=e.type,this.name=t,this.boundExpression=e}static parse(t,e){if(2!==t.length||"string"!=typeof t[1])return e.error("'var' expression requires exactly one string literal argument.");const n=t[1];return e.scope.has(n)?new Qn(n,e.scope.get(n)):e.error(`Unknown variable "${n}". Make sure "${n}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(t){return this.boundExpression.evaluate(t)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}var $r=Qn;class ti{constructor(t,e=[],n,i=new bi,o=[]){this.registry=t,this.path=e,this.key=e.map((t=>`[${t}]`)).join(""),this.scope=i,this.errors=o,this.expectedType=n}parse(t,e,n,i,o={}){return e?this.concat(e,n,i)._parse(t,o):this._parse(t,o)}_parse(t,e){function n(t,e,n){return"assert"===n?new fr(e,[t]):"coerce"===n?new mr(e,[t]):t}if(null!==t&&"string"!=typeof t&&"boolean"!=typeof t&&"number"!=typeof t||(t=["literal",t]),Array.isArray(t)){if(0===t.length)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const i=t[0];if("string"!=typeof i)return this.error(`Expression name must be a string, but found ${typeof i} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const o=this.registry[i];if(o){let i=o.parse(t,this);if(!i)return null;if(this.expectedType){const t=this.expectedType,o=i.type;if("string"!==t.kind&&"number"!==t.kind&&"boolean"!==t.kind&&"object"!==t.kind&&"array"!==t.kind||"value"!==o.kind)if("color"!==t.kind&&"formatted"!==t.kind&&"resolvedImage"!==t.kind||"value"!==o.kind&&"string"!==o.kind){if(this.checkSubtype(t,o))return null}else i=n(i,t,e.typeAnnotation||"coerce");else i=n(i,t,e.typeAnnotation||"assert")}if(!(i instanceof lr)&&"resolvedImage"!==i.type.kind&&no(i)){const e=new _r;try{i=new lr(i.type,i.evaluate(e))}catch(t){return this.error(t.message),null}}return i}return this.error(`Unknown expression "${i}". If you wanted a literal array, use ["literal", [...]].`,0)}return this.error(void 0===t?"'undefined' value invalid. Use null instead.":"object"==typeof t?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof t} instead.`)}concat(t,e,n){const i="number"==typeof t?this.path.concat(t):this.path,o=n?this.scope.concat(n):this.scope;return new ti(this.registry,i,e||null,o,this.errors)}error(t,...e){const n=`${this.key}${e.map((t=>`[${t}]`)).join("")}`;this.errors.push(new xi(n,t))}checkSubtype(t,e){const n=Ui(t,e);return n&&this.error(n),n}}var to=ti;function no(t){if(t instanceof $r)return no(t.boundExpression);if(t instanceof vr&&"error"===t.name)return!1;if(t instanceof kn)return!1;if(t instanceof Jr)return!1;const e=t instanceof mr||t instanceof fr;let n=!0;return t.eachChild((t=>{n=e?n&&no(t):n&&t instanceof lr})),!!n&&Qr(t)&&Kr(t,["zoom","heatmap-density","line-progress","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center"])}function io(t,e){const n=t.length-1;let i,o,s=0,a=n,l=0;for(;s<=a;)if(l=Math.floor((s+a)/2),i=t[l],o=t[l+1],i<=e){if(l===n||e<o)return l;s=l+1}else{if(!(i>e))throw new hr("Input is not a number.");a=l-1}return 0}class si{constructor(t,e,n){this.type=t,this.input=e,this.labels=[],this.outputs=[];for(const[t,e]of n)this.labels.push(t),this.outputs.push(e)}static parse(t,e){if(t.length-1<4)return e.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if((t.length-1)%2!=0)return e.error("Expected an even number of arguments.");const n=e.parse(t[1],1,Ti);if(!n)return null;const i=[];let o=null;e.expectedType&&"value"!==e.expectedType.kind&&(o=e.expectedType);for(let n=1;n<t.length;n+=2){const s=1===n?-1/0:t[n],a=t[n+1],l=n,h=n+1;if("number"!=typeof s)return e.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',l);if(i.length&&i[i.length-1][0]>=s)return e.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',l);const c=e.parse(a,h,o);if(!c)return null;o=o||c.type,i.push([s,c])}return new si(o,n,i)}evaluate(t){const e=this.labels,n=this.outputs;if(1===e.length)return n[0].evaluate(t);const i=this.input.evaluate(t);if(i<=e[0])return n[0].evaluate(t);const o=e.length;return i>=e[o-1]?n[o-1].evaluate(t):n[io(e,i)].evaluate(t)}eachChild(t){t(this.input);for(const e of this.outputs)t(e)}outputDefined(){return this.outputs.every((t=>t.outputDefined()))}serialize(){const t=["step",this.input.serialize()];for(let e=0;e<this.labels.length;e++)e>0&&t.push(this.labels[e]),t.push(this.outputs[e].serialize());return t}}var ro=si,oo=so;function so(t,e,n,i){this.cx=3*t,this.bx=3*(n-t)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*e,this.by=3*(i-e)-this.cy,this.ay=1-this.cy-this.by,this.p1x=t,this.p1y=e,this.p2x=n,this.p2y=i}function ao(t,e,n){return t*(1-n)+e*n}so.prototype={sampleCurveX:function(t){return((this.ax*t+this.bx)*t+this.cx)*t},sampleCurveY:function(t){return((this.ay*t+this.by)*t+this.cy)*t},sampleCurveDerivativeX:function(t){return(3*this.ax*t+2*this.bx)*t+this.cx},solveCurveX:function(t,e){if(void 0===e&&(e=1e-6),t<0)return 0;if(t>1)return 1;for(var n=t,i=0;i<8;i++){var o=this.sampleCurveX(n)-t;if(Math.abs(o)<e)return n;var s=this.sampleCurveDerivativeX(n);if(Math.abs(s)<1e-6)break;n-=o/s}var a=0,l=1;for(n=t,i=0;i<20&&(o=this.sampleCurveX(n),!(Math.abs(o-t)<e));i++)t>o?a=n:l=n,n=.5*(l-a)+a;return n},solve:function(t,e){return this.sampleCurveY(this.solveCurveX(t,e))}};var lo=Object.freeze({__proto__:null,number:ao,color:function(t,e,n){return new er(ao(t.r,e.r,n),ao(t.g,e.g,n),ao(t.b,e.b,n),ao(t.a,e.a,n))},array:function(t,e,n){return t.map(((t,i)=>ao(t,e[i],n)))}});const co=.95047,uo=1.08883,fo=4/29,mo=6/29,yo=3*mo*mo,_o=mo*mo*mo,vo=Math.PI/180,xo=180/Math.PI;function bo(t){return t>_o?Math.pow(t,1/3):t/yo+fo}function wo(t){return t>mo?t*t*t:yo*(t-fo)}function Mo(t){return 255*(t<=.0031308?12.92*t:1.055*Math.pow(t,1/2.4)-.055)}function Co(t){return(t/=255)<=.04045?t/12.92:Math.pow((t+.055)/1.055,2.4)}function So(t){const e=Co(t.r),n=Co(t.g),i=Co(t.b),o=bo((.4124564*e+.3575761*n+.1804375*i)/co),s=bo((.2126729*e+.7151522*n+.072175*i)/1);return{l:116*s-16,a:500*(o-s),b:200*(s-bo((.0193339*e+.119192*n+.9503041*i)/uo)),alpha:t.a}}function Po(t){let e=(t.l+16)/116,n=isNaN(t.a)?e:e+t.a/500,i=isNaN(t.b)?e:e-t.b/200;return e=1*wo(e),n=co*wo(n),i=uo*wo(i),new er(Mo(3.2404542*n-1.5371385*e-.4985314*i),Mo(-.969266*n+1.8760108*e+.041556*i),Mo(.0556434*n-.2040259*e+1.0572252*i),t.alpha)}function Io(t,e,n){const i=e-t;return t+n*(i>180||i<-180?i-360*Math.round(i/360):i)}const Oo={forward:So,reverse:Po,interpolate:function(t,e,n){return{l:ao(t.l,e.l,n),a:ao(t.a,e.a,n),b:ao(t.b,e.b,n),alpha:ao(t.alpha,e.alpha,n)}}},Eo={forward:function(t){const{l:e,a:n,b:i}=So(t),o=Math.atan2(i,n)*xo;return{h:o<0?o+360:o,c:Math.sqrt(n*n+i*i),l:e,alpha:t.a}},reverse:function(t){const e=t.h*vo,n=t.c;return Po({l:t.l,a:Math.cos(e)*n,b:Math.sin(e)*n,alpha:t.alpha})},interpolate:function(t,e,n){return{h:Io(t.h,e.h,n),c:ao(t.c,e.c,n),l:ao(t.l,e.l,n),alpha:ao(t.alpha,e.alpha,n)}}};var Ro=Object.freeze({__proto__:null,lab:Oo,hcl:Eo});class Ci{constructor(t,e,n,i,o){this.type=t,this.operator=e,this.interpolation=n,this.input=i,this.labels=[],this.outputs=[];for(const[t,e]of o)this.labels.push(t),this.outputs.push(e)}static interpolationFactor(t,e,n,i){let o=0;if("exponential"===t.name)o=Lo(e,t.base,n,i);else if("linear"===t.name)o=Lo(e,1,n,i);else if("cubic-bezier"===t.name){const s=t.controlPoints;o=new oo(s[0],s[1],s[2],s[3]).solve(Lo(e,1,n,i))}return o}static parse(t,e){let[n,i,o,...s]=t;if(!Array.isArray(i)||0===i.length)return e.error("Expected an interpolation type expression.",1);if("linear"===i[0])i={name:"linear"};else if("exponential"===i[0]){const t=i[1];if("number"!=typeof t)return e.error("Exponential interpolation requires a numeric base.",1,1);i={name:"exponential",base:t}}else{if("cubic-bezier"!==i[0])return e.error(`Unknown interpolation type ${String(i[0])}`,1,0);{const t=i.slice(1);if(4!==t.length||t.some((t=>"number"!=typeof t||t<0||t>1)))return e.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);i={name:"cubic-bezier",controlPoints:t}}}if(t.length-1<4)return e.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if((t.length-1)%2!=0)return e.error("Expected an even number of arguments.");if(o=e.parse(o,2,Ti),!o)return null;const a=[];let l=null;"interpolate-hcl"===n||"interpolate-lab"===n?l=Pi:e.expectedType&&"value"!==e.expectedType.kind&&(l=e.expectedType);for(let t=0;t<s.length;t+=2){const n=s[t],i=s[t+1],o=t+3,h=t+4;if("number"!=typeof n)return e.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',o);if(a.length&&a[a.length-1][0]>=n)return e.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',o);const c=e.parse(i,h,l);if(!c)return null;l=l||c.type,a.push([n,c])}return"number"===l.kind||"color"===l.kind||"array"===l.kind&&"number"===l.itemType.kind&&"number"==typeof l.N?new Ci(l,n,i,o,a):e.error(`Type ${zi(l)} is not interpolatable.`)}evaluate(t){const e=this.labels,n=this.outputs;if(1===e.length)return n[0].evaluate(t);const i=this.input.evaluate(t);if(i<=e[0])return n[0].evaluate(t);const o=e.length;if(i>=e[o-1])return n[o-1].evaluate(t);const s=io(e,i),a=Ci.interpolationFactor(this.interpolation,i,e[s],e[s+1]),l=n[s].evaluate(t),h=n[s+1].evaluate(t);return"interpolate"===this.operator?lo[this.type.kind.toLowerCase()](l,h,a):"interpolate-hcl"===this.operator?Eo.reverse(Eo.interpolate(Eo.forward(l),Eo.forward(h),a)):Oo.reverse(Oo.interpolate(Oo.forward(l),Oo.forward(h),a))}eachChild(t){t(this.input);for(const e of this.outputs)t(e)}outputDefined(){return this.outputs.every((t=>t.outputDefined()))}serialize(){let t;t="linear"===this.interpolation.name?["linear"]:"exponential"===this.interpolation.name?1===this.interpolation.base?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);const e=[this.operator,t,this.input.serialize()];for(let t=0;t<this.labels.length;t++)e.push(this.labels[t],this.outputs[t].serialize());return e}}function Lo(t,e,n,i){const o=i-n,s=t-n;return 0===o?0:1===e?s/o:(Math.pow(e,s)-1)/(Math.pow(e,o)-1)}var Fo=Ci;class Oi{constructor(t,e){this.type=t,this.args=e}static parse(t,e){if(t.length<2)return e.error("Expectected at least one argument.");let n=null;const i=e.expectedType;i&&"value"!==i.kind&&(n=i);const o=[];for(const i of t.slice(1)){const t=e.parse(i,1+o.length,n,void 0,{typeAnnotation:"omit"});if(!t)return null;n=n||t.type,o.push(t)}const s=i&&o.some((t=>Ui(i,t.type)));return new Oi(s?ki:n,o)}evaluate(t){let e,n=null,i=0;for(const o of this.args){if(i++,n=o.evaluate(t),n&&n instanceof cn&&!n.available&&(e||(e=n),n=null,i===this.args.length))return e;if(null!==n)break}return n}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every((t=>t.outputDefined()))}serialize(){const t=["coalesce"];return this.eachChild((e=>{t.push(e.serialize())})),t}}var Ho=Oi;class Ei{constructor(t,e){this.type=e.type,this.bindings=[].concat(t),this.result=e}evaluate(t){return this.result.evaluate(t)}eachChild(t){for(const e of this.bindings)t(e[1]);t(this.result)}static parse(t,e){if(t.length<4)return e.error(`Expected at least 3 arguments, but found ${t.length-1} instead.`);const n=[];for(let i=1;i<t.length-1;i+=2){const o=t[i];if("string"!=typeof o)return e.error(`Expected string, but found ${typeof o} instead.`,i);if(/[^a-zA-Z0-9_]/.test(o))return e.error("Variable names must contain only alphanumeric characters or '_'.",i);const s=e.parse(t[i+1],i+1);if(!s)return null;n.push([o,s])}const i=e.parse(t[t.length-1],t.length-1,e.expectedType,n);return i?new Ei(n,i):null}outputDefined(){return this.result.outputDefined()}serialize(){const t=["let"];for(const[e,n]of this.bindings)t.push(e,n.serialize());return t.push(this.result.serialize()),t}}var Bo=Ei;class Li{constructor(t,e,n){this.type=t,this.index=e,this.input=n}static parse(t,e){if(3!==t.length)return e.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const n=e.parse(t[1],1,Ti),i=e.parse(t[2],2,Hi(e.expectedType||ki));if(!n||!i)return null;return new Li(i.type.itemType,n,i)}evaluate(t){const e=this.index.evaluate(t),n=this.input.evaluate(t);if(e<0)throw new hr(`Array index out of bounds: ${e} < 0.`);if(e>=n.length)throw new hr(`Array index out of bounds: ${e} > ${n.length-1}.`);if(e!==Math.floor(e))throw new hr(`Array index must be an integer, but found ${e} instead.`);return n[e]}eachChild(t){t(this.index),t(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}var zo=Li;class Ni{constructor(t,e){this.type=Si,this.needle=t,this.haystack=e}static parse(t,e){if(3!==t.length)return e.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const n=e.parse(t[1],1,ki),i=e.parse(t[2],2,ki);return n&&i?Wi(n.type,[Si,Mi,Ti,wi,ki])?new Ni(n,i):e.error(`Expected first argument to be of type boolean, string, number or null, but found ${zi(n.type)} instead`):null}evaluate(t){const e=this.needle.evaluate(t),n=this.haystack.evaluate(t);if(null==n)return!1;if(!Zi(e,["boolean","string","number","null"]))throw new hr(`Expected first argument to be of type boolean, string, number or null, but found ${zi(sr(e))} instead.`);if(!Zi(n,["string","array"]))throw new hr(`Expected second argument to be of type array or string, but found ${zi(sr(n))} instead.`);return n.indexOf(e)>=0}eachChild(t){t(this.needle),t(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}var Go=Ni;class Vi{constructor(t,e,n){this.type=Ti,this.needle=t,this.haystack=e,this.fromIndex=n}static parse(t,e){if(t.length<=2||t.length>=5)return e.error(`Expected 3 or 4 arguments, but found ${t.length-1} instead.`);const n=e.parse(t[1],1,ki),i=e.parse(t[2],2,ki);if(!n||!i)return null;if(!Wi(n.type,[Si,Mi,Ti,wi,ki]))return e.error(`Expected first argument to be of type boolean, string, number or null, but found ${zi(n.type)} instead`);if(4===t.length){const o=e.parse(t[3],3,Ti);return o?new Vi(n,i,o):null}return new Vi(n,i)}evaluate(t){const e=this.needle.evaluate(t),n=this.haystack.evaluate(t);if(!Zi(e,["boolean","string","number","null"]))throw new hr(`Expected first argument to be of type boolean, string, number or null, but found ${zi(sr(e))} instead.`);if(!Zi(n,["string","array"]))throw new hr(`Expected second argument to be of type array or string, but found ${zi(sr(n))} instead.`);if(this.fromIndex){const i=this.fromIndex.evaluate(t);return n.indexOf(e,i)}return n.indexOf(e)}eachChild(t){t(this.needle),t(this.haystack),this.fromIndex&&t(this.fromIndex)}outputDefined(){return!1}serialize(){if(null!=this.fromIndex&&void 0!==this.fromIndex){const t=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),t]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}var jo=Vi;class Bi{constructor(t,e,n,i,o,s){this.inputType=t,this.type=e,this.input=n,this.cases=i,this.outputs=o,this.otherwise=s}static parse(t,e){if(t.length<5)return e.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if(t.length%2!=1)return e.error("Expected an even number of arguments.");let n,i;e.expectedType&&"value"!==e.expectedType.kind&&(i=e.expectedType);const o={},s=[];for(let a=2;a<t.length-1;a+=2){let l=t[a];const h=t[a+1];Array.isArray(l)||(l=[l]);const c=e.concat(a);if(0===l.length)return c.error("Expected at least one branch label.");for(const t of l){if("number"!=typeof t&&"string"!=typeof t)return c.error("Branch labels must be numbers or strings.");if("number"==typeof t&&Math.abs(t)>Number.MAX_SAFE_INTEGER)return c.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if("number"==typeof t&&Math.floor(t)!==t)return c.error("Numeric branch labels must be integer values.");if(n){if(c.checkSubtype(n,sr(t)))return null}else n=sr(t);if(void 0!==o[String(t)])return c.error("Branch labels must be unique.");o[String(t)]=s.length}const u=e.parse(h,a,i);if(!u)return null;i=i||u.type,s.push(u)}const a=e.parse(t[1],1,ki);if(!a)return null;const l=e.parse(t[t.length-1],t.length-1,i);return l?"value"!==a.type.kind&&e.concat(1).checkSubtype(n,a.type)?null:new Bi(n,i,a,o,s,l):null}evaluate(t){const e=this.input.evaluate(t);return(sr(e)===this.inputType&&this.outputs[this.cases[e]]||this.otherwise).evaluate(t)}eachChild(t){t(this.input),this.outputs.forEach(t),t(this.otherwise)}outputDefined(){return this.outputs.every((t=>t.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const t=["match",this.input.serialize()],e=Object.keys(this.cases).sort(),n=[],i={};for(const t of e){const e=i[this.cases[t]];void 0===e?(i[this.cases[t]]=n.length,n.push([this.cases[t],[t]])):n[e][1].push(t)}const o=t=>"number"===this.inputType.kind?Number(t):t;for(const[e,i]of n)t.push(1===i.length?o(i[0]):i.map(o)),t.push(this.outputs[e].serialize());return t.push(this.otherwise.serialize()),t}}var Uo=Bi;class ji{constructor(t,e,n){this.type=t,this.branches=e,this.otherwise=n}static parse(t,e){if(t.length<4)return e.error(`Expected at least 3 arguments, but found only ${t.length-1}.`);if(t.length%2!=0)return e.error("Expected an odd number of arguments.");let n;e.expectedType&&"value"!==e.expectedType.kind&&(n=e.expectedType);const i=[];for(let o=1;o<t.length-1;o+=2){const s=e.parse(t[o],o,Si);if(!s)return null;const a=e.parse(t[o+1],o+1,n);if(!a)return null;i.push([s,a]),n=n||a.type}const o=e.parse(t[t.length-1],t.length-1,n);return o?new ji(n,i,o):null}evaluate(t){for(const[e,n]of this.branches)if(e.evaluate(t))return n.evaluate(t);return this.otherwise.evaluate(t)}eachChild(t){for(const[e,n]of this.branches)t(e),t(n);t(this.otherwise)}outputDefined(){return this.branches.every((([t,e])=>e.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const t=["case"];return this.eachChild((e=>{t.push(e.serialize())})),t}}var Vo=ji;class Xi{constructor(t,e,n,i){this.type=t,this.input=e,this.beginIndex=n,this.endIndex=i}static parse(t,e){if(t.length<=2||t.length>=5)return e.error(`Expected 3 or 4 arguments, but found ${t.length-1} instead.`);const n=e.parse(t[1],1,ki),i=e.parse(t[2],2,Ti);if(!n||!i)return null;if(!Wi(n.type,[Hi(ki),Mi,ki]))return e.error(`Expected first argument to be of type array or string, but found ${zi(n.type)} instead`);if(4===t.length){const o=e.parse(t[3],3,Ti);return o?new Xi(n.type,n,i,o):null}return new Xi(n.type,n,i)}evaluate(t){const e=this.input.evaluate(t),n=this.beginIndex.evaluate(t);if(!Zi(e,["string","array"]))throw new hr(`Expected first argument to be of type array or string, but found ${zi(sr(e))} instead.`);if(this.endIndex){const i=this.endIndex.evaluate(t);return e.slice(n,i)}return e.slice(n)}eachChild(t){t(this.input),t(this.beginIndex),this.endIndex&&t(this.endIndex)}outputDefined(){return!1}serialize(){if(null!=this.endIndex&&void 0!==this.endIndex){const t=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),t]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}var Wo=Xi;function Zo(t,e){return"=="===t||"!="===t?"boolean"===e.kind||"string"===e.kind||"number"===e.kind||"null"===e.kind||"value"===e.kind:"string"===e.kind||"number"===e.kind||"value"===e.kind}function qo(t,e,n,i){return 0===i.compare(e,n)}function Xo(t,e,n){const i="=="!==t&&"!="!==t;return class r{constructor(t,e,n){this.type=Si,this.lhs=t,this.rhs=e,this.collator=n,this.hasUntypedArgument="value"===t.type.kind||"value"===e.type.kind}static parse(t,e){if(3!==t.length&&4!==t.length)return e.error("Expected two or three arguments.");const n=t[0];let o=e.parse(t[1],1,ki);if(!o)return null;if(!Zo(n,o.type))return e.concat(1).error(`"${n}" comparisons are not supported for type '${zi(o.type)}'.`);let s=e.parse(t[2],2,ki);if(!s)return null;if(!Zo(n,s.type))return e.concat(2).error(`"${n}" comparisons are not supported for type '${zi(s.type)}'.`);if(o.type.kind!==s.type.kind&&"value"!==o.type.kind&&"value"!==s.type.kind)return e.error(`Cannot compare types '${zi(o.type)}' and '${zi(s.type)}'.`);i&&("value"===o.type.kind&&"value"!==s.type.kind?o=new fr(s.type,[o]):"value"!==o.type.kind&&"value"===s.type.kind&&(s=new fr(o.type,[s])));let a=null;if(4===t.length){if("string"!==o.type.kind&&"string"!==s.type.kind&&"value"!==o.type.kind&&"value"!==s.type.kind)return e.error("Cannot use collator to compare non-string types.");if(a=e.parse(t[3],3,Ri),!a)return null}return new r(o,s,a)}evaluate(o){const s=this.lhs.evaluate(o),a=this.rhs.evaluate(o);if(i&&this.hasUntypedArgument){const e=sr(s),n=sr(a);if(e.kind!==n.kind||"string"!==e.kind&&"number"!==e.kind)throw new hr(`Expected arguments for "${t}" to be (string, string) or (number, number), but found (${e.kind}, ${n.kind}) instead.`)}if(this.collator&&!i&&this.hasUntypedArgument){const t=sr(s),n=sr(a);if("string"!==t.kind||"string"!==n.kind)return e(o,s,a)}return this.collator?n(o,s,a,this.collator.evaluate(o)):e(o,s,a)}eachChild(t){t(this.lhs),t(this.rhs),this.collator&&t(this.collator)}outputDefined(){return!0}serialize(){const e=[t];return this.eachChild((t=>{e.push(t.serialize())})),e}}}const Yo=Xo("==",(function(t,e,n){return e===n}),qo),Ko=Xo("!=",(function(t,e,n){return e!==n}),(function(t,e,n,i){return!qo(0,e,n,i)})),$o=Xo("<",(function(t,e,n){return e<n}),(function(t,e,n,i){return i.compare(e,n)<0})),es=Xo(">",(function(t,e,n){return e>n}),(function(t,e,n,i){return i.compare(e,n)>0})),ns=Xo("<=",(function(t,e,n){return e<=n}),(function(t,e,n,i){return i.compare(e,n)<=0})),rs=Xo(">=",(function(t,e,n){return e>=n}),(function(t,e,n,i){return i.compare(e,n)>=0}));class ir{constructor(t,e,n,i,o,s){this.type=Mi,this.number=t,this.locale=e,this.currency=n,this.unit=i,this.minFractionDigits=o,this.maxFractionDigits=s}static parse(t,e){if(3!==t.length)return e.error("Expected two arguments.");const n=e.parse(t[1],1,Ti);if(!n)return null;const i=t[2];if("object"!=typeof i||Array.isArray(i))return e.error("NumberFormat options argument must be an object.");let o=null;if(i.locale&&(o=e.parse(i.locale,1,Mi),!o))return null;let s=null;if(i.currency&&(s=e.parse(i.currency,1,Mi),!s))return null;let a=null;if(i.unit&&(a=e.parse(i.unit,1,Mi),!a))return null;let l=null;if(i["min-fraction-digits"]&&(l=e.parse(i["min-fraction-digits"],1,Ti),!l))return null;let h=null;return i["max-fraction-digits"]&&(h=e.parse(i["max-fraction-digits"],1,Ti),!h)?null:new ir(n,o,s,a,l,h)}evaluate(t){return new Intl.NumberFormat(this.locale?this.locale.evaluate(t):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(t):void 0,unit:this.unit?this.unit.evaluate(t):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(t):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(t):void 0}).format(this.number.evaluate(t))}eachChild(t){t(this.number),this.locale&&t(this.locale),this.currency&&t(this.currency),this.unit&&t(this.unit),this.minFractionDigits&&t(this.minFractionDigits),this.maxFractionDigits&&t(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const t={};return this.locale&&(t.locale=this.locale.serialize()),this.currency&&(t.currency=this.currency.serialize()),this.unit&&(t.unit=this.unit.serialize()),this.minFractionDigits&&(t["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(t["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),t]}}class rr{constructor(t){this.type=Ti,this.input=t}static parse(t,e){if(2!==t.length)return e.error(`Expected 1 argument, but found ${t.length-1} instead.`);const n=e.parse(t[1],1);return n?"array"!==n.type.kind&&"string"!==n.type.kind&&"value"!==n.type.kind?e.error(`Expected argument of type string or array, but found ${zi(n.type)} instead.`):new rr(n):null}evaluate(t){const e=this.input.evaluate(t);if("string"==typeof e)return e.length;if(Array.isArray(e))return e.length;throw new hr(`Expected value to be of type string or array, but found ${zi(sr(e))} instead.`)}eachChild(t){t(this.input)}outputDefined(){return!1}serialize(){const t=["length"];return this.eachChild((e=>{t.push(e.serialize())})),t}}const os={"==":Yo,"!=":Ko,">":es,"<":$o,">=":rs,"<=":ns,array:fr,at:zo,boolean:fr,case:Vo,coalesce:Ho,collator:kn,format:bn,image:An,in:Go,"index-of":jo,interpolate:Fo,"interpolate-hcl":Fo,"interpolate-lab":Fo,length:rr,let:Bo,literal:lr,match:Uo,number:fr,"number-format":ir,object:fr,slice:Wo,step:ro,string:fr,"to-boolean":mr,"to-color":mr,"to-number":mr,"to-string":mr,var:$r,within:Jr};function as(t,[e,n,i,o]){e=e.evaluate(t),n=n.evaluate(t),i=i.evaluate(t);const s=o?o.evaluate(t):1,a=nr(e,n,i,s);if(a)throw new hr(a);return new er(e/255*s,n/255*s,i/255*s,s)}function ls(t,e){return t in e}function hs(t,e){const n=e[t];return void 0===n?null:n}function cs(t){return{type:t}}vr.register(os,{error:[{kind:"error"},[Mi],(t,[e])=>{throw new hr(e.evaluate(t))}],typeof:[Mi,[ki],(t,[e])=>zi(sr(e.evaluate(t)))],"to-rgba":[Hi(Ti,4),[Pi],(t,[e])=>e.evaluate(t).toArray()],rgb:[Pi,[Ti,Ti,Ti],as],rgba:[Pi,[Ti,Ti,Ti,Ti],as],has:{type:Si,overloads:[[[Mi],(t,[e])=>ls(e.evaluate(t),t.properties())],[[Mi,Ii],(t,[e,n])=>ls(e.evaluate(t),n.evaluate(t))]]},get:{type:ki,overloads:[[[Mi],(t,[e])=>hs(e.evaluate(t),t.properties())],[[Mi,Ii],(t,[e,n])=>hs(e.evaluate(t),n.evaluate(t))]]},"feature-state":[ki,[Mi],(t,[e])=>hs(e.evaluate(t),t.featureState||{})],properties:[Ii,[],t=>t.properties()],"geometry-type":[Mi,[],t=>t.geometryType()],id:[ki,[],t=>t.id()],zoom:[Ti,[],t=>t.globals.zoom],pitch:[Ti,[],t=>t.globals.pitch||0],"distance-from-center":[Ti,[],t=>t.distanceFromCenter()],"heatmap-density":[Ti,[],t=>t.globals.heatmapDensity||0],"line-progress":[Ti,[],t=>t.globals.lineProgress||0],"sky-radial-progress":[Ti,[],t=>t.globals.skyRadialProgress||0],accumulated:[ki,[],t=>void 0===t.globals.accumulated?null:t.globals.accumulated],"+":[Ti,cs(Ti),(t,e)=>{let n=0;for(const i of e)n+=i.evaluate(t);return n}],"*":[Ti,cs(Ti),(t,e)=>{let n=1;for(const i of e)n*=i.evaluate(t);return n}],"-":{type:Ti,overloads:[[[Ti,Ti],(t,[e,n])=>e.evaluate(t)-n.evaluate(t)],[[Ti],(t,[e])=>-e.evaluate(t)]]},"/":[Ti,[Ti,Ti],(t,[e,n])=>e.evaluate(t)/n.evaluate(t)],"%":[Ti,[Ti,Ti],(t,[e,n])=>e.evaluate(t)%n.evaluate(t)],ln2:[Ti,[],()=>Math.LN2],pi:[Ti,[],()=>Math.PI],e:[Ti,[],()=>Math.E],"^":[Ti,[Ti,Ti],(t,[e,n])=>Math.pow(e.evaluate(t),n.evaluate(t))],sqrt:[Ti,[Ti],(t,[e])=>Math.sqrt(e.evaluate(t))],log10:[Ti,[Ti],(t,[e])=>Math.log(e.evaluate(t))/Math.LN10],ln:[Ti,[Ti],(t,[e])=>Math.log(e.evaluate(t))],log2:[Ti,[Ti],(t,[e])=>Math.log(e.evaluate(t))/Math.LN2],sin:[Ti,[Ti],(t,[e])=>Math.sin(e.evaluate(t))],cos:[Ti,[Ti],(t,[e])=>Math.cos(e.evaluate(t))],tan:[Ti,[Ti],(t,[e])=>Math.tan(e.evaluate(t))],asin:[Ti,[Ti],(t,[e])=>Math.asin(e.evaluate(t))],acos:[Ti,[Ti],(t,[e])=>Math.acos(e.evaluate(t))],atan:[Ti,[Ti],(t,[e])=>Math.atan(e.evaluate(t))],min:[Ti,cs(Ti),(t,e)=>Math.min(...e.map((e=>e.evaluate(t))))],max:[Ti,cs(Ti),(t,e)=>Math.max(...e.map((e=>e.evaluate(t))))],abs:[Ti,[Ti],(t,[e])=>Math.abs(e.evaluate(t))],round:[Ti,[Ti],(t,[e])=>{const n=e.evaluate(t);return n<0?-Math.round(-n):Math.round(n)}],floor:[Ti,[Ti],(t,[e])=>Math.floor(e.evaluate(t))],ceil:[Ti,[Ti],(t,[e])=>Math.ceil(e.evaluate(t))],"filter-==":[Si,[Mi,ki],(t,[e,n])=>t.properties()[e.value]===n.value],"filter-id-==":[Si,[ki],(t,[e])=>t.id()===e.value],"filter-type-==":[Si,[Mi],(t,[e])=>t.geometryType()===e.value],"filter-<":[Si,[Mi,ki],(t,[e,n])=>{const i=t.properties()[e.value],o=n.value;return typeof i==typeof o&&i<o}],"filter-id-<":[Si,[ki],(t,[e])=>{const n=t.id(),i=e.value;return typeof n==typeof i&&n<i}],"filter->":[Si,[Mi,ki],(t,[e,n])=>{const i=t.properties()[e.value],o=n.value;return typeof i==typeof o&&i>o}],"filter-id->":[Si,[ki],(t,[e])=>{const n=t.id(),i=e.value;return typeof n==typeof i&&n>i}],"filter-<=":[Si,[Mi,ki],(t,[e,n])=>{const i=t.properties()[e.value],o=n.value;return typeof i==typeof o&&i<=o}],"filter-id-<=":[Si,[ki],(t,[e])=>{const n=t.id(),i=e.value;return typeof n==typeof i&&n<=i}],"filter->=":[Si,[Mi,ki],(t,[e,n])=>{const i=t.properties()[e.value],o=n.value;return typeof i==typeof o&&i>=o}],"filter-id->=":[Si,[ki],(t,[e])=>{const n=t.id(),i=e.value;return typeof n==typeof i&&n>=i}],"filter-has":[Si,[ki],(t,[e])=>e.value in t.properties()],"filter-has-id":[Si,[],t=>null!==t.id()&&void 0!==t.id()],"filter-type-in":[Si,[Hi(Mi)],(t,[e])=>e.value.indexOf(t.geometryType())>=0],"filter-id-in":[Si,[Hi(ki)],(t,[e])=>e.value.indexOf(t.id())>=0],"filter-in-small":[Si,[Mi,Hi(ki)],(t,[e,n])=>n.value.indexOf(t.properties()[e.value])>=0],"filter-in-large":[Si,[Mi,Hi(ki)],(t,[e,n])=>function(t,e,n,i){for(;n<=i;){const o=n+i>>1;if(e[o]===t)return!0;e[o]>t?i=o-1:n=o+1}return!1}(t.properties()[e.value],n.value,0,n.value.length-1)],all:{type:Si,overloads:[[[Si,Si],(t,[e,n])=>e.evaluate(t)&&n.evaluate(t)],[cs(Si),(t,e)=>{for(const n of e)if(!n.evaluate(t))return!1;return!0}]]},any:{type:Si,overloads:[[[Si,Si],(t,[e,n])=>e.evaluate(t)||n.evaluate(t)],[cs(Si),(t,e)=>{for(const n of e)if(n.evaluate(t))return!0;return!1}]]},"!":[Si,[Si],(t,[e])=>!e.evaluate(t)],"is-supported-script":[Si,[Mi],(t,[e])=>{const n=t.globals&&t.globals.isSupportedScript;return!n||n(e.evaluate(t))}],upcase:[Mi,[Mi],(t,[e])=>e.evaluate(t).toUpperCase()],downcase:[Mi,[Mi],(t,[e])=>e.evaluate(t).toLowerCase()],concat:[Mi,cs(ki),(t,e)=>e.map((e=>ar(e.evaluate(t)))).join("")],"resolved-locale":[Mi,[Ri],(t,[e])=>e.evaluate(t).resolvedLocale()]});var us=os;function fs(t){return{result:"success",value:t}}function ps(t){return{result:"error",value:t}}function As(t){return!!t.expression&&t.expression.interpolated}function ms(t){return t instanceof Number?"number":t instanceof String?"string":t instanceof Boolean?"boolean":Array.isArray(t)?"array":null===t?"null":typeof t}function ys(t){return"object"==typeof t&&null!==t&&!Array.isArray(t)}function _s(t){return t}function vs(t,e){const n="color"===e.type,i=t.stops&&"object"==typeof t.stops[0][0],o=i||!(i||void 0!==t.property),s=t.type||(As(e)?"exponential":"interval");if(n&&((t=vi({},t)).stops&&(t.stops=t.stops.map((t=>[t[0],er.parse(t[1])]))),t.default=er.parse(t.default?t.default:e.default)),t.colorSpace&&"rgb"!==t.colorSpace&&!Ro[t.colorSpace])throw new Error(`Unknown color space: ${t.colorSpace}`);let a,l,h;if("exponential"===s)a=Ss;else if("interval"===s)a=Cs;else if("categorical"===s){a=ws,l=Object.create(null);for(const e of t.stops)l[e[0]]=e[1];h=typeof t.stops[0][0]}else{if("identity"!==s)throw new Error(`Unknown function type "${s}"`);a=Ps}if(i){const n={},i=[];for(let e=0;e<t.stops.length;e++){const o=t.stops[e],s=o[0].zoom;void 0===n[s]&&(n[s]={zoom:s,type:t.type,property:t.property,default:t.default,stops:[]},i.push(s)),n[s].stops.push([o[0].value,o[1]])}const o=[];for(const t of i)o.push([n[t].zoom,vs(n[t],e)]);const s={name:"linear"};return{kind:"composite",interpolationType:s,interpolationFactor:Fo.interpolationFactor.bind(void 0,s),zoomStops:o.map((t=>t[0])),evaluate:({zoom:n},i)=>Ss({stops:o,base:t.base},e,n).evaluate(n,i)}}if(o){const n="exponential"===s?{name:"exponential",base:void 0!==t.base?t.base:1}:null;return{kind:"camera",interpolationType:n,interpolationFactor:Fo.interpolationFactor.bind(void 0,n),zoomStops:t.stops.map((t=>t[0])),evaluate:({zoom:n})=>a(t,e,n,l,h)}}return{kind:"source",evaluate(n,i){const o=i&&i.properties?i.properties[t.property]:void 0;return void 0===o?bs(t.default,e.default):a(t,e,o,l,h)}}}function bs(t,e,n){return void 0!==t?t:void 0!==e?e:void 0!==n?n:void 0}function ws(t,e,n,i,o){return bs(typeof n===o?i[n]:void 0,t.default,e.default)}function Cs(t,e,n){if("number"!==ms(n))return bs(t.default,e.default);const i=t.stops.length;if(1===i)return t.stops[0][1];if(n<=t.stops[0][0])return t.stops[0][1];if(n>=t.stops[i-1][0])return t.stops[i-1][1];const o=io(t.stops.map((t=>t[0])),n);return t.stops[o][1]}function Ss(t,e,n){const i=void 0!==t.base?t.base:1;if("number"!==ms(n))return bs(t.default,e.default);const o=t.stops.length;if(1===o)return t.stops[0][1];if(n<=t.stops[0][0])return t.stops[0][1];if(n>=t.stops[o-1][0])return t.stops[o-1][1];const s=io(t.stops.map((t=>t[0])),n),a=function(t,e,n,i){const o=i-n,s=t-n;return 0===o?0:1===e?s/o:(Math.pow(e,s)-1)/(Math.pow(e,o)-1)}(n,i,t.stops[s][0],t.stops[s+1][0]),l=t.stops[s][1],h=t.stops[s+1][1];let c=lo[e.type]||_s;if(t.colorSpace&&"rgb"!==t.colorSpace){const e=Ro[t.colorSpace];c=(t,n)=>e.reverse(e.interpolate(e.forward(t),e.forward(n),a))}return"function"==typeof l.evaluate?{evaluate(...t){const e=l.evaluate.apply(void 0,t),n=h.evaluate.apply(void 0,t);if(void 0!==e&&void 0!==n)return c(e,n,a)}}:c(l,h,a)}function Ps(t,e,n){return"color"===e.type?n=er.parse(n):"formatted"===e.type?n=hn.fromString(n.toString()):"resolvedImage"===e.type?n=cn.fromString(n.toString()):ms(n)===e.type||"enum"===e.type&&e.values[n]||(n=void 0),bs(n,t.default,e.default)}class Tr{constructor(t,e){this.expression=t,this._warningHistory={},this._evaluator=new _r,this._defaultValue=e?function(t){return"color"===t.type&&(ys(t.default)||Array.isArray(t.default))?new er(0,0,0,0):"color"===t.type?er.parse(t.default)||null:void 0===t.default?null:t.default}(e):null,this._enumValues=e&&"enum"===e.type?e.values:null}evaluateWithoutErrorHandling(t,e,n,i,o,s,a,l){return this._evaluator.globals=t,this._evaluator.feature=e,this._evaluator.featureState=n,this._evaluator.canonical=i||null,this._evaluator.availableImages=o||null,this._evaluator.formattedSection=s,this._evaluator.featureTileCoord=a||null,this._evaluator.featureDistanceData=l||null,this.expression.evaluate(this._evaluator)}evaluate(t,e,n,i,o,s,a,l){this._evaluator.globals=t,this._evaluator.feature=e||null,this._evaluator.featureState=n||null,this._evaluator.canonical=i||null,this._evaluator.availableImages=o||null,this._evaluator.formattedSection=s||null,this._evaluator.featureTileCoord=a||null,this._evaluator.featureDistanceData=l||null;try{const t=this.expression.evaluate(this._evaluator);if(null==t||"number"==typeof t&&t!=t)return this._defaultValue;if(this._enumValues&&!(t in this._enumValues))throw new hr(`Expected value to be one of ${Object.keys(this._enumValues).map((t=>JSON.stringify(t))).join(", ")}, but found ${JSON.stringify(t)} instead.`);return t}catch(t){return this._warningHistory[t.message]||(this._warningHistory[t.message]=!0,"undefined"!=typeof console&&console.warn(t.message)),this._defaultValue}}}function Is(t){return Array.isArray(t)&&t.length>0&&"string"==typeof t[0]&&t[0]in us}function Os(t,e){const n=new to(us,[],e?function(t){const e={color:Pi,string:Mi,number:Ti,enum:Mi,boolean:Si,formatted:Di,resolvedImage:Fi};return"array"===t.type?Hi(e[t.value]||ki,t.length):e[t.type]}(e):void 0),i=n.parse(t,void 0,void 0,void 0,e&&"string"===e.type?{typeAnnotation:"coerce"}:void 0);return i?fs(new Tr(i,e)):ps(n.errors)}class Mr{constructor(t,e){this.kind=t,this._styleExpression=e,this.isStateDependent="constant"!==t&&!Yr(e.expression)}evaluateWithoutErrorHandling(t,e,n,i,o,s){return this._styleExpression.evaluateWithoutErrorHandling(t,e,n,i,o,s)}evaluate(t,e,n,i,o,s){return this._styleExpression.evaluate(t,e,n,i,o,s)}}class Pr{constructor(t,e,n,i){this.kind=t,this.zoomStops=n,this._styleExpression=e,this.isStateDependent="camera"!==t&&!Yr(e.expression),this.interpolationType=i}evaluateWithoutErrorHandling(t,e,n,i,o,s){return this._styleExpression.evaluateWithoutErrorHandling(t,e,n,i,o,s)}evaluate(t,e,n,i,o,s){return this._styleExpression.evaluate(t,e,n,i,o,s)}interpolationFactor(t,e,n){return this.interpolationType?Fo.interpolationFactor(this.interpolationType,t,e,n):0}}function Es(t,e){if("error"===(t=Os(t,e)).result)return t;const n=t.value.expression,i=Qr(n);if(!i&&!function(t){return"data-driven"===t["property-type"]}(e))return ps([new xi("","data expressions not supported")]);const o=Kr(n,["zoom","pitch","distance-from-center"]);if(!o&&!function(t){return!!t.expression&&t.expression.parameters.indexOf("zoom")>-1}(e))return ps([new xi("","zoom expressions not supported")]);const s=ks(n);if(!s&&!o)return ps([new xi("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')]);if(s instanceof xi)return ps([s]);if(s instanceof Fo&&!As(e))return ps([new xi("",'"interpolate" expressions cannot be used with this property')]);if(!s)return fs(new Mr(i?"constant":"source",t.value));return fs(new Pr(i?"camera":"composite",t.value,s.labels,s instanceof Fo?s.interpolation:void 0))}class Cr{constructor(t,e){this._parameters=t,this._specification=e,vi(this,vs(this._parameters,this._specification))}static deserialize(t){return new Cr(t._parameters,t._specification)}static serialize(t){return{_parameters:t._parameters,_specification:t._specification}}}function ks(t){let e=null;if(t instanceof Bo)e=ks(t.result);else if(t instanceof Ho){for(const n of t.args)if(e=ks(n),e)break}else(t instanceof ro||t instanceof Fo)&&t.input instanceof vr&&"zoom"===t.input.name&&(e=t);return e instanceof xi||t.eachChild((t=>{const n=ks(t);n instanceof xi?e=n:!e&&n?e=new xi("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):e&&n&&e!==n&&(e=new xi("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))})),e}function Rs(t){if(Array.isArray(t))return t.map(Rs);if(t instanceof Object&&!(t instanceof Number||t instanceof String||t instanceof Boolean)){const e={};for(const n in t)e[n]=Rs(t[n]);return e}return function(t){return t instanceof Number||t instanceof String||t instanceof Boolean?t.valueOf():t}(t)}function Ls(t,e="fill"){if(null==t)return{filter:()=>!0,needGeometry:!1,needFeature:!1};const n=t;let i=!0;try{i=function(t){if(!Ns(t))return t;let e=Rs(t);return Fs(e),e=Ds(e),e}(n)}catch(t){console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.\nThis is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md\nand paste the contents of this message in the report.\nThank you!\nFilter Expression:\n${JSON.stringify(n,null,2)}\n        `)}const o=Os(i,null);let s=null;if("error"===o.result)throw new Error(o.value.map((t=>`${t.key}: ${t.message}`)).join(", "));s=(t,e,n)=>o.value.evaluate(t,e,{},n);let a=null,l=null;if(i!==n){const t=Os(n,null);if("error"===t.result)throw new Error(t.value.map((t=>`${t.key}: ${t.message}`)).join(", "));a=(e,n,i,o,s)=>t.value.evaluate(e,n,{},i,void 0,void 0,o,s),l=!Qr(t.value.expression)}return{filter:s,dynamicFilter:a||void 0,needGeometry:Gs(i),needFeature:!!l}}function Ds(t){if(!Array.isArray(t))return t;const e=function(t){if(zs.has(t[0]))for(let e=1;e<t.length;e++)if(Ns(t[e]))return!0;return t}(t);return!0===e?e:e.map((t=>Ds(t)))}function Fs(t){let e=!1;const n=[];if("case"===t[0]){for(let i=1;i<t.length-1;i+=2)e=e||Ns(t[i]),n.push(t[i+1]);n.push(t[t.length-1])}else if("match"===t[0]){e=e||Ns(t[1]);for(let e=2;e<t.length-1;e+=2)n.push(t[e+1]);n.push(t[t.length-1])}else if("step"===t[0]){e=e||Ns(t[1]);for(let e=1;e<t.length-1;e+=2)n.push(t[e+1])}e&&(t.length=0,t.push("any",...n));for(let e=1;e<t.length;e++)Fs(t[e])}function Ns(t){if(!Array.isArray(t))return!1;if(function(t){return"pitch"===t||"distance-from-center"===t}(t[0]))return!0;for(let e=1;e<t.length;e++)if(Ns(t[e]))return!0;return!1}const zs=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function Gs(t){if(!Array.isArray(t))return!1;if("within"===t[0])return!0;for(let e=1;e<t.length;e++)if(Gs(t[e]))return!0;return!1}const Us={StyleExpression:Tr,isExpression:Is,isExpressionFilter:function t(e){if(!0===e||!1===e)return!0;if(!Array.isArray(e)||0===e.length)return!1;switch(e[0]){case"has":return e.length>=2&&"$id"!==e[1]&&"$type"!==e[1];case"in":return e.length>=3&&("string"!=typeof e[1]||Array.isArray(e[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return 3!==e.length||Array.isArray(e[1])||Array.isArray(e[2]);case"any":case"all":for(const n of e.slice(1))if(!t(n)&&"boolean"!=typeof n)return!1;return!0;default:return!0}},createExpression:Os,createPropertyExpression:Es,normalizePropertyExpression:function(t,e){if(ys(t))return new Cr(t,e);if(Is(t)){const n=Es(t,e);if("error"===n.result)throw new Error(n.value.map((t=>`${t.key}: ${t.message}`)).join(", "));return n.value}{let n=t;return"string"==typeof t&&"color"===e.type&&(n=er.parse(t)),{kind:"constant",evaluate:()=>n}}},ZoomConstantExpression:Mr,ZoomDependentExpression:Pr,StylePropertyFunction:Cr},{isExpression:Ws,createExpression:Xs}=Us,Qs={};function Ys(t){if(!Array.isArray(t))return Ys([t]);const e=[];for(let n=0;n<t.length;n++){let i;i=!0===t[n].filter?function(){return!0}:Ks(t[n].filter),e.push(Mn({},t[n],{filter:i}))}return e}function Ks(t){if(!0===t)return function(){return!0};if(t&&t.condition){if("any"===t.type){const e=t.condition,n=[];for(let t=0;t<e.length;t++)n.push(Ks(e[t]));return(t,e)=>{for(let i=0;i<n.length;i++)if(n[i](t,e))return!0;return!1}}const e=Ks(t.condition);if(Pn(t.layer))return e;const n=e=>e.layer===t.layer;return(t,i)=>n(t)&&e(t,i)}if(oi(t))return new Function("f",`var p = (f && f.properties || {}); return ${ai(t)}`);{let e=Ls(t);e=e&&e.filter;const n=(t,n)=>(Qs.zoom=n,e&&e(Qs,t));return n}}const $s={type:"number","property-type":"data-driven",expression:{parameters:["zoom","feature"]}};function ta(t,e){$s.type=e||"number";const n=Xs(t,$s);if("success"!==n.result)throw new Error(`Invalid maplibre spec expression: ${JSON.stringify(t)} (${n.value})`);return n.value}function ea(t){return Ws(t)}const na={lineWidth:1,lineStrokeWidth:1,lineDx:1,lineDy:1,lineOpacity:1,linePatternAnimSpeed:1,markerWidth:1,markerHeight:1,markerDx:1,markerDy:1,markerSpacing:1,markerOpacity:1,markerRotation:1,textWrapWidth:1,textSpacing:1,textSize:1,textHaloRadius:1,textHaloOpacity:1,textDx:1,textDy:1,textOpacity:1,textRotation:1,polygonOpacity:1};function ia(t){return na[t]}const ra={markerPlacement:1,markerFile:1,mergeOnProperty:1,markerTextFit:1,markerType:1,markerHorizontalAlignment:1,markerVerticalAlignment:1,markerRotationAlignment:1,markerPitchAlignment:1,markerFillPatternFile:1,markerLinePatternFile:1,textName:1,textPlacement:1,textFaceName:1,textStyle:1,textHorizontalAlignment:1,textVerticalAlignment:1,textRotationAlignment:1,textPitchAlignment:1,lineJoin:1,lineCap:1,linePatternFile:1,polygonPatternFile:1},oa={lineDasharray:1,markerLineDasharray:1,uvScale:1,uvOffset:1};function sa(t){return ra[t]?"string":ia(t)?"number":oa[t]?"array":"color"}var aa=Object.freeze({__proto__:null,compileFilter:Ks,compileStyle:function(t=[]){return Ys(t=t.map((t=>{const e=Mn({},t);return e.filter&&e.filter.value&&(e.filter=e.filter.value),e})))},createExpression:ta,getExpressionType:sa,isExpression:ea,isInterpolated:ia});const la="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope,ha=function(t){return class extends t{pushIn(...t){const e=t.length;for(let n=0;n<e;n++)this[this.currentIndex++]=t[n]}fill(t,e,n){super.fill(t,e,n),n>this.currentIndex&&(this.currentIndex=n)}set(t,e){t>=this.currentIndex&&(this.currentIndex=t+1),this[t]=e}getLength(){return this.currentIndex}setLength(t){this.currentIndex=t,super.length<t&&(super.length=t)}trySetLength(t){t>this.currentIndex&&this.setLength(t)}reset(){this.currentIndex=0}slice(t,e){const n=super.slice(t,e);return n.currentIndex=e-t,n}}},ca=ha(Array),ua={get:function(t,e){return"length"===e?t.getLength():t[e]}};class is extends Array{setLength(t){this.length=t,this.currentIndex=t}trySetLength(t){this.length=t,this.currentIndex=t}getLength(){return this.length}}let fa;class ss{static createTypedArray(t,e){return Y(t,e)}static getInstance(){return fa}static ensureCapacity(t,e){if(!t.BYTES_PER_ELEMENT)return t;if(t.length>=e)return t;const n=new t.constructor(e+Math.ceil(.5*e)),i=t.getLength();for(let e=0;e<i;e++)n[e]=t[e];return n.currentIndex=t.currentIndex,n}static getArray(t){let e;if(t){const n=ha(t);e=new n(1048576/n.BYTES_PER_ELEMENT)}else e=new ca;return e.push=(...t)=>{e.pushIn(...t)},e}static getProxyArray(){const t=new ca,e=new Proxy(t,ua);return e.push=(...e)=>{t.pushIn(...e)},e._origin=t,e}constructor(){this._arrays=[],this._index=0,this._proxiedArrays=[],this._proxiedIndex=0,this._typedArrays={}}getProxy(){if(!la){const t=new is;return t.currentIndex=0,t}const t=this._proxiedArrays[this._proxiedIndex]=this._proxiedArrays[this._proxiedIndex]||ss.getProxyArray();return t.reset(),this._proxiedIndex++,t}get(t){if(!la){const t=new is;return t.currentIndex=0,t}if(t){const e=t.name;let n=this._typedArrays[e];n||(n=this._typedArrays[e]={arrays:[],index:0});const i=n.index,o=n.arrays[i]=n.arrays[i]||ss.getArray(t);return o.reset(),n.index++,o}const e=this._arrays[this._index]=this._arrays[this._index]||ss.getArray();return e.reset(),this._index++,e}reset(){this._index=0,this._proxiedIndex=0;for(const t in this._typedArrays)this._typedArrays[t].index=0}}fa=new ss;const da="__fea_idx",pa=[],Aa={},ma={},ya={},_a=[],va=ss.getInstance();let xa=!1;const ba=Math.pow(2,17);class gs{static isAtlasLoaded(t,e={}){const{iconAtlas:n}=e;return!!(!t||n&&n.positions[t])}static genFnTypes(t){const e={};for(const n in t)if(ea(t[n])){const i=(n+"_Fn_0").trim(),o=(n+"Fn").trim(),s=sa(n);e[i]=ta(t[n],s),e[o]=(t,n)=>{let o;Aa.zoom=t,ma.properties=n;try{o=e[i].evaluateWithoutErrorHandling(Aa,ma,ya,null,_a)}catch(t){return null}return o}}else if(Bn(t[n])){const i=(n+"_Fn_0").trim(),o=(n+"Fn").trim();ia(n)?(e[i]=$t(t[n]),e[o]=(t,n)=>{const o=e[i](t,n);return Bn(o)?$t(o)(t,n):o}):(e[i]=ne(t[n]),e[o]=(t,n)=>{const o=e[i](t,n);return Bn(o)?ne(o)(t,n):o})}return e}constructor(t,e,n){this.options=n;const i=[];this.symbolDef=e,this.symbol=re(e,(()=>(i[0]=n.zoom,i))),this.styledVectors=[],this.properties={},this._fnTypes=n.fnTypes||gs.genFnTypes(this.symbolDef),Bn(this.symbolDef.visible)&&(this._visibleFn=$t(this.symbolDef.visible)),n.atlas&&(this.iconAtlas=n.atlas.iconAtlas,this.glyphAtlas=n.atlas.glyphAtlas),this.maxAltitude=0,this.features=this._check(t)}needAltitudeAttribute(){const t=Math.max(Math.abs(this.maxPosZ),Math.abs(this.minPosZ));return this.options.forceAltitudeAttribute||t>=ba||this.options.positionType===Float32Array}getPositionFormat(){return this.needAltitudeAttribute()?[{type:Int16Array,width:2,name:"aPosition"},{type:Float32Array,width:1,name:"aAltitude"}]:[{type:Float32Array,width:3,name:"aPosition"}]}fillPosition(t,e,n,i){if(e<this._minX&&(this._minX=e),e>this._maxX&&(this._maxX=e),n<this._minY&&(this._minY=n),n>this._maxY&&(this._maxY=n),this.needAltitudeAttribute()){let o=t.aPosition.currentIndex;t.aPosition[o++]=e,t.aPosition[o++]=n,t.aPosition.currentIndex=o,o=t.aAltitude.currentIndex,t.aAltitude[o++]=i,t.aAltitude.currentIndex=o}else{Kn(pa,e,n,i);let o=t.aPosition.currentIndex;t.aPosition[o++]=pa[0],t.aPosition[o++]=pa[1],t.aPosition[o++]=pa[2],t.aPosition.currentIndex=o}}_check(t){if(!t.length)return t;const e=(da+"").trim();let n,i=0,o=t[i];for(;!o.geometry;)i++,o=t[i];if(Array.isArray(o.geometry)&&o.properties){let e=o.geometry[0];for(;Array.isArray(e);)e=e[0];e&&!Pn(e.x)&&(n=t)}if(!n)if(n=[],Array.isArray(o.geometry))for(let e=0;e<t.length;e++){const i=Mn({},t[e]);n.push(K(i))}else for(let i=0;i<t.length;i++){const o=t[i],s=l(o);for(let t=0;t<s.length;t++){const i=s[t];i[e]=o[e],n.push(i)}}if(this.options.altitudeProperty)for(let t=0;t<n.length;t++){const e=n[t];if(!e||!e.geometry||1!==e.type&&4!==e.type)continue;const i=this.getAltitude(e.properties);if(i)for(let t=0;t<e.geometry.length;t++){const n=e.geometry[t];if(n&&n.length)for(let t=0;t<n.length;t++)n[t].z=(n[t].z||0)+i}}if(this.maxPosZ=0,this.minPosZ=0,!this.options.forceAltitudeAttribute){const t="line"===this.symbolDef.textPlacement;let e=-1/0,i=1/0,o=!1;const{textPitchAlignmentFn:s}=this._fnTypes;!s&&t&&"map"===this.symbolDef.textPitchAlignment&&(o=!0);const a=[];for(let l=0;l<n.length;l++){const[h,c]=Ta(a,n[l]&&n[l].geometry);if(c>e&&(e=c),h<i&&(i=h),t&&!o&&s&&n[l].properties){const t=s(null,n[l].properties);"map"===t&&(o=t)}}this.hasMapPitchAlign=o,this.maxPosZ=e===-1/0?0:e,this.minPosZ=i===1/0?0:i}const s=this.options.order;if(s){const t=[];for(let e=0;e<s.length;e++)s[e]&&t.push(Ks(s[e]));n=n.sort(((e,n)=>{const i=t.length;let o=-1,s=-1;for(let a=0;a<i&&(t[a](e)&&(o=a),t[a](n)&&(s=a),!(o>=0&&o<i&&s>=0&&s<i));a++);return o-s}))}return n}load(t=1){const e=(da+"").trim(),n="_debug_info".trim(),i=this._fnTypes,o=this.styledVectors;this.count=0;const s=this.features;if(!s||!s.length)return Promise.resolve(null);const a={},l={},h={zoom:this.options.zoom,isVector3D:!!this.options.center},c=[],u=re(this.symbolDef,(()=>(c[0]=h.zoom,c)));let f=0,g=s.length;const A=this.options.debugIndex;try{for(;f<g;f++){const t=s[f];if(!t||!t.geometry)continue;if(On(A)&&t[n].index!==A)continue;t.properties||(t.properties={}),t.properties.$layer=t.layer,t.properties.$type=t.type;const c=this.createStyledVector(t,u,i,h,a,l);c&&c.feature.geometry&&(c.featureIdx=void 0===t[e]?f:t[e],this.count++,o.push(c))}}catch(t){return Promise.reject(t)}return this.options.atlas?Promise.resolve(this.pack(t)):this.loadAtlas(a,l).then((()=>this.pack(t)))}loadAtlas(t,e){return new Promise(((n,i)=>{this.fetchAtlas(t,e,((t,e)=>{if(t)i(t);else{if(e){const{icons:t,glyphs:n}=e;if(t&&Object.keys(t).length){for(const e in t){const n=t[e],{width:i,height:o,data:s}=n.data;n.data=new v({width:i,height:o},s)}this.iconAtlas=new F(t)}if(n&&Object.keys(n).length){for(const t in n){const e=n[t];for(const t in e){const n=e[t],{width:i,height:o,data:s}=n.bitmap;n.bitmap=new _({width:i,height:o},s)}}this.glyphAtlas=new R(n)}}n({glyphAtlas:this.glyphAtlas,iconAtlas:this.iconAtlas})}}))}))}fetchAtlas(t,e,n){Object.keys(t).length>0||Object.keys(e).length>0?this.options.requestor(t,e,n):n()}pack(t){if(!this.count)return null;if(null==t)throw new Error("layout scale is undefined");const e=this.createDataPack(this.styledVectors,t);if(!e)return null;this.properties.minAltitude=this.minPosZ/100,this.properties.maxAltitude=this.maxPosZ/100,e.properties=this.properties,this.empty&&(e.empty=!0);const n=e.buffers;delete e.buffers;const i={data:e,buffers:n};if(this.iconAtlas){const t=i.data.iconAtlas=wa(this.iconAtlas);if(t.glyphMap)for(const e in t.glyphMap){n.push(t.glyphMap[e].data.data.buffer)}n.push(i.data.iconAtlas.image.data.buffer)}return this.glyphAtlas&&(i.data.glyphAtlas=wa(this.glyphAtlas),n.push(i.data.glyphAtlas.image.data.buffer)),i}createStyledVector(t,e,n,i){return new dt(t,e,n,i)}createDataPack(t,e){if(!t||!t.length)return null;this.maxIndex=0,this.maxPos=0,this._minX=this._minY=1/0,this._maxX=this._maxY=-1/0,this.dynamicAttrs={};const n=this.data={};this._arrayPool=va,va.reset();let i=this.elements=va.get();const o=this._dataFormat=this.getFormat(Array.isArray(t[0])?t[0][0].symbol:t[0].symbol),s=this.needAltitudeAttribute()?2:3;for(let t=0;t<o.length;t++)n[o[t].name]=va.get(o[t].type);let a=va.get(),l=0;const h=va.get();let c=0,u=!1,f=!0;const g=new Set;for(let i=0,o=t.length;i<o;i++){if(!t[i].feature.geometry)continue;const o=Array.isArray(t[i])?t[i][0].feature.id:t[i].feature.id;f&&(void 0!==ma.id?g&&(g.has(ma.id)?f=!1:g.add(ma.id)):f=!1),On(o)&&(Math.abs(o)>c&&(c=Math.abs(o)),o<0&&(u=!0));const A=this.data.aPosition.getLength();if(Array.isArray(t[i]))for(let n=0;n<t[i].length;n++)this._placeVector(t[i][n],e);else this._placeVector(t[i],e);const m=(n.aPosition.getLength()-A)/s;for(let e=0;e<m;e++)a.push(t[i].featureIdx),On(o)&&h.push(o);l=Math.max(l,t[i].featureIdx)}if(this.countOutOfAngle>0&&!xa&&(xa=!0,console.warn("text anchor along line is ignored as anchor's line angle is bigger than textMaxAngle.")),this.hasElements()&&!i.getLength())return null;const A=this.options.center?Float32Array:Q(l);a=ss.createTypedArray(a,A),o[0].type=this.options.positionType?this.options.positionType:J(this.maxPos);const m=this.options.center;if(m&&(m[0]||m[1])){const t=n.aPosition,e=t.getLength();for(let n=0;n<e;n+=s)t[n]-=m[0],t[n+1]-=m[1]}const w=function(t,e){const n={};for(let i=0;i<t.length;i++){const o=t[i],s=o.type,a=o.name;n[a]=s===Array?e[a]:Y(e[a],s)}return n}(o,n);w.aPickingId=a;const T=[];for(const t in w)T.push(w[t].buffer);const M=X(this.maxIndex);i=ss.createTypedArray(i,M),T.push(i.buffer);const C={data:w,isIdUnique:f,is2D:0===this.maxPosZ&&0===this.minPosZ,indices:this.hasElements()?i:null,positionSize:s,positionBounding:[this._minX,this._minY,this._maxX,this._maxY],buffers:T,symbolIndex:this.symbolDef.index||{index:0},dynamicAttributes:this.dynamicAttrs};if(this._packMarkerPlacement&&(C.markerPlacement=this._packMarkerPlacement),this._packTextPlacement&&(C.textPlacement=this._packTextPlacement),h.getLength()){const t=u?J(c):Q(c);C.featureIds=ss.createTypedArray(h,t),T.push(C.featureIds.buffer)}else C.featureIds=[];return C.pickingIdIndiceMap=U(a,C.indices),C}_placeVector(t,e){this._visibleFn&&!this._visibleFn(this.options.zoom,t.feature.properties)||this.placeVector(t,e,this.formatWidth)}addElements(t,e,n){this.maxIndex=Math.max(this.maxIndex,t,e,n);let i=this.elements.currentIndex;this.elements[i++]=t,this.elements[i++]=e,this.elements[i++]=n,this.elements.currentIndex=i}hasElements(){return!0}getAltitude(t){const{altitudeProperty:e,defaultAltitude:n,altitudeScale:i}=this.options;let o=O(t,e,n);return i&&(o*=i),this.maxAltitude=Math.max(this.maxAltitude,Math.abs(o)),o}getIconAtlasMaxValue(){const t=this.iconAtlas.positions;let e=0;for(const n in t)if(Nn(t,n)){const{tl:i,displaySize:o}=t[n],s=Math.max(i[0],i[1],o[0]-1,o[1]-1);s>e&&(e=s)}return e}ensureDataCapacity(t,e){const n=this._dataFormat;for(let i=0;i<n.length;i++){const o=this.data[n[i].name];if(!o)continue;const s=n[i].width*t,a=o.getLength();this.data[n[i].name]=ss.ensureCapacity(o,a+s*e)}}}function wa(t){let e=t.positions,n=t.image&&t.image.format||"alpha";if(t instanceof F){e={};for(const n in t.positions){const i=t.positions[n];e[n]={paddedRect:i.paddedRect,pixelRatio:i.pixelRatio,tl:i.tl,br:i.br,displaySize:i.displaySize}}n="rgba"}const i=t.image;return{image:{width:i.width,height:i.height,data:i.data,format:n},glyphMap:t.glyphMap,positions:e}}function Ta(t,e){if(!e)return 0;let n=-1/0,i=1/0;const o=[];if(Array.isArray(e))for(let t=0;t<e.length;t++)if(Array.isArray(e[t])){const[s,a]=Ta(o,e[t]);a>n&&(n=a),s<i&&(i=s)}else{const o=Math.abs(e[t].z||0);o>n&&(n=o),o<i&&(i=o)}else{const t=Math.abs(e.z||0);t>n&&(n=t),t<i&&(i=t)}return t[0]=i,t[1]=n,t}const Ca="___fn_in_stops";function Sa(t,e,n,i){const o="__fn_textSize".trim();let s=t.textSize;if(Pn(e.textSize))return[16,16];t[o]&&(s=t[o]);const a=[];if(a[0]=Dn(s)?s(i,n):s,Gt(a[0])){const e=a[0].__fn_key=a[0].__fn_key||JSON.stringify(a[0]);t[Ca]||(t[Ca]={}),t[Ca][e]||(t[Ca][e]=$t(a[0]));a[0]=(0,t[Ca][e])(i,n)}return a[1]=a[0],a}function Pa(t){const e=t.stops;let n=-1/0;for(let t=0;t<e.length;t++){let i=e[t][1];En(e[t][1])&&(i=Pa(e[t][1])),i>n&&(n=i)}return n}const Oa=["{","}"],Ea="";function ka(t){return t||"Open Sans Regular"}const La=/\{[\w-]+(?:\|[\w-]+)*\}/g;function Da(t,e){if(!Ln(t))return t;function n(t){if(!e)return Ea;const n=e[t];return Pn(n)?Ea:Array.isArray(n)?n.join():n}const[i,o]=Oa,s=Na(t);for(let e=0,a=s.length;e<a;e++){const a=s[e],l=`${i}${a}${o}`;if(a.indexOf("|")>0){const e=a.split("|");let i=!1;for(let o=0;o<e.length;o++){const s=n(e[o]);if(s!==Ea){t=Ha(t,l,s),i=!0;break}}i||(t=Ha(t,l,Ea))}else t=Ha(t,l,n(a))}return t}function Na(t){t+=Ea;const[e,n]=Oa,i=[];let o=!1,s=Ea;for(let a=0,l=t.length;a<l;a++){const l=t[a];o||l!==e||(o=!0),l===e&&o&&(s=Ea),o&&l!==e&&l!==n&&(s+=l),l===n&&s&&(o=!1,i.push(s),s=Ea)}return i}function Ha(t,e,n){if(!t)return t;if(t.replaceAll)return t.replaceAll(e,n);for(;t.indexOf(e)>-1;)t=t.replace(e,n);return t}var Ba=Object.freeze({__proto__:null,EMPTY_STRING:Ea,getSDFFont:ka,replaceAll:Ha,resolveExpVarNames:function t(e,n){if(2!==n.length||"get"!==n[0])for(let i=0;i<n.length;i++)2===n[i].length&&"get"===n[i][0]?e.push(n[i][1]):Array.isArray(n[i])&&t(e,n[i]);else e.push(n[1])},resolveText:Da,resolveText_bak:function(t,e){return Ln(t)?t.replace(La,(function(t){if(!e)return"";if((t=t.substring(1,t.length-1)).indexOf("|")>0){const n=t.split("|");for(let t=0;t<n.length;t++){const i=e[n[t]];if(!Pn(i))return i}return""}const n=e[t];return Pn(n)?"":Array.isArray(n)?n.join():n})):t},resolveVarNames:function(t){return t.match(La)},templateKeys:Na});const za={"Latin-1 Supplement":t=>t>=128&&t<=255,Arabic:t=>t>=1536&&t<=1791,"Arabic Supplement":t=>t>=1872&&t<=1919,"Arabic Extended-A":t=>t>=2208&&t<=2303,"Hangul Jamo":t=>t>=4352&&t<=4607,"Unified Canadian Aboriginal Syllabics":t=>t>=5120&&t<=5759,Khmer:t=>t>=6016&&t<=6143,"Unified Canadian Aboriginal Syllabics Extended":t=>t>=6320&&t<=6399,"General Punctuation":t=>t>=8192&&t<=8303,"Letterlike Symbols":t=>t>=8448&&t<=8527,"Number Forms":t=>t>=8528&&t<=8591,"Miscellaneous Technical":t=>t>=8960&&t<=9215,"Control Pictures":t=>t>=9216&&t<=9279,"Optical Character Recognition":t=>t>=9280&&t<=9311,"Enclosed Alphanumerics":t=>t>=9312&&t<=9471,"Geometric Shapes":t=>t>=9632&&t<=9727,"Miscellaneous Symbols":t=>t>=9728&&t<=9983,"Miscellaneous Symbols and Arrows":t=>t>=11008&&t<=11263,"CJK Radicals Supplement":t=>t>=11904&&t<=12031,"Kangxi Radicals":t=>t>=12032&&t<=12255,"Ideographic Description Characters":t=>t>=12272&&t<=12287,"CJK Symbols and Punctuation":t=>t>=12288&&t<=12351,Hiragana:t=>t>=12352&&t<=12447,Katakana:t=>t>=12448&&t<=12543,Bopomofo:t=>t>=12544&&t<=12591,"Hangul Compatibility Jamo":t=>t>=12592&&t<=12687,Kanbun:t=>t>=12688&&t<=12703,"Bopomofo Extended":t=>t>=12704&&t<=12735,"CJK Strokes":t=>t>=12736&&t<=12783,"Katakana Phonetic Extensions":t=>t>=12784&&t<=12799,"Enclosed CJK Letters and Months":t=>t>=12800&&t<=13055,"CJK Compatibility":t=>t>=13056&&t<=13311,"CJK Unified Ideographs Extension A":t=>t>=13312&&t<=19903,"Yijing Hexagram Symbols":t=>t>=19904&&t<=19967,"CJK Unified Ideographs":t=>t>=19968&&t<=40959,"Yi Syllables":t=>t>=40960&&t<=42127,"Yi Radicals":t=>t>=42128&&t<=42191,"Hangul Jamo Extended-A":t=>t>=43360&&t<=43391,"Hangul Syllables":t=>t>=44032&&t<=55215,"Hangul Jamo Extended-B":t=>t>=55216&&t<=55295,"Private Use Area":t=>t>=57344&&t<=63743,"CJK Compatibility Ideographs":t=>t>=63744&&t<=64255,"Arabic Presentation Forms-A":t=>t>=64336&&t<=65023,"Vertical Forms":t=>t>=65040&&t<=65055,"CJK Compatibility Forms":t=>t>=65072&&t<=65103,"Small Form Variants":t=>t>=65104&&t<=65135,"Arabic Presentation Forms-B":t=>t>=65136&&t<=65279,"Halfwidth and Fullwidth Forms":t=>t>=65280&&t<=65519};function Ga(t){return!(za.Arabic(t)||za["Arabic Supplement"](t)||za["Arabic Extended-A"](t)||za["Arabic Presentation Forms-A"](t)||za["Arabic Presentation Forms-B"](t))}function ja(t){return!(t<11904||!(za["Bopomofo Extended"](t)||za.Bopomofo(t)||za["CJK Compatibility Forms"](t)||za["CJK Compatibility Ideographs"](t)||za["CJK Compatibility"](t)||za["CJK Radicals Supplement"](t)||za["CJK Strokes"](t)||za["CJK Symbols and Punctuation"](t)||za["CJK Unified Ideographs Extension A"](t)||za["CJK Unified Ideographs"](t)||za["Enclosed CJK Letters and Months"](t)||za["Halfwidth and Fullwidth Forms"](t)||za.Hiragana(t)||za["Ideographic Description Characters"](t)||za["Kangxi Radicals"](t)||za["Katakana Phonetic Extensions"](t)||za.Katakana(t)||za["Vertical Forms"](t)||za["Yi Radicals"](t)||za["Yi Syllables"](t)))}function Ua(t){return!(746!==t&&747!==t&&(t<4352||!(za["Bopomofo Extended"](t)||za.Bopomofo(t)||za["CJK Compatibility Forms"](t)&&!(t>=65097&&t<=65103)||za["CJK Compatibility Ideographs"](t)||za["CJK Compatibility"](t)||za["CJK Radicals Supplement"](t)||za["CJK Strokes"](t)||!(!za["CJK Symbols and Punctuation"](t)||t>=12296&&t<=12305||t>=12308&&t<=12319||12336===t)||za["CJK Unified Ideographs Extension A"](t)||za["CJK Unified Ideographs"](t)||za["Enclosed CJK Letters and Months"](t)||za["Hangul Compatibility Jamo"](t)||za["Hangul Jamo Extended-A"](t)||za["Hangul Jamo Extended-B"](t)||za["Hangul Jamo"](t)||za["Hangul Syllables"](t)||za.Hiragana(t)||za["Ideographic Description Characters"](t)||za.Kanbun(t)||za["Kangxi Radicals"](t)||za["Katakana Phonetic Extensions"](t)||za.Katakana(t)&&12540!==t||!(!za["Halfwidth and Fullwidth Forms"](t)||65288===t||65289===t||65293===t||t>=65306&&t<=65310||65339===t||65341===t||65343===t||t>=65371&&t<=65503||65507===t||t>=65512&&t<=65519)||!(!za["Small Form Variants"](t)||t>=65112&&t<=65118||t>=65123&&t<=65126)||za["Unified Canadian Aboriginal Syllabics"](t)||za["Unified Canadian Aboriginal Syllabics Extended"](t)||za["Vertical Forms"](t)||za["Yijing Hexagram Symbols"](t)||za["Yi Syllables"](t)||za["Yi Radicals"](t))))}function Wa(t){return!(Ua(t)||function(t){return!!(za["Latin-1 Supplement"](t)&&(167===t||169===t||174===t||177===t||188===t||189===t||190===t||215===t||247===t)||za["General Punctuation"](t)&&(8214===t||8224===t||8225===t||8240===t||8241===t||8251===t||8252===t||8258===t||8263===t||8264===t||8265===t||8273===t)||za["Letterlike Symbols"](t)||za["Number Forms"](t)||za["Miscellaneous Technical"](t)&&(t>=8960&&t<=8967||t>=8972&&t<=8991||t>=8996&&t<=9e3||9003===t||t>=9085&&t<=9114||t>=9150&&t<=9165||9167===t||t>=9169&&t<=9179||t>=9186&&t<=9215)||za["Control Pictures"](t)&&9251!==t||za["Optical Character Recognition"](t)||za["Enclosed Alphanumerics"](t)||za["Geometric Shapes"](t)||za["Miscellaneous Symbols"](t)&&!(t>=9754&&t<=9759)||za["Miscellaneous Symbols and Arrows"](t)&&(t>=11026&&t<=11055||t>=11088&&t<=11097||t>=11192&&t<=11243)||za["CJK Symbols and Punctuation"](t)||za.Katakana(t)||za["Private Use Area"](t)||za["CJK Compatibility Forms"](t)||za["Small Form Variants"](t)||za["Halfwidth and Fullwidth Forms"](t)||8734===t||8756===t||8757===t||t>=9984&&t<=10087||t>=10102&&t<=10131||65532===t||65533===t)}(t))}function Za(t){return t>=1424&&t<=2303||za["Arabic Presentation Forms-A"](t)||za["Arabic Presentation Forms-B"](t)}const qa=[[9,9],[32,32],[5760,5760],[8192,8198],[8200,8202],[8287,12288],[6158,6158],[8203,8205]];function Xa(t){for(const e of qa)if(t>=e[0]&&t<=e[1])return!0;return!1}const Ja={"!":"","#":"",$:"","%":"","&":"","(":"",")":"","*":"","+":"",",":"","-":"",".":"","/":"",":":"",";":"","<":"","=":"",">":"","?":"","@":"","[":"","\\":"","]":"","^":"",_:"","`":"","{":"","|":"","}":"","~":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":""};function Qa(t,e,n,i,o,s,a,l,h,c){let u=t.trim();2===c&&(u=function(t){let e="";const n=Array.from(t);for(let t=0;t<n.length;t++){const i=n[t+1].codePointAt(0)||null,o=n[t-1].codePointAt(0)||null;i&&Wa(i)&&!Ja[n[t+1]]||o&&Wa(o)&&!Ja[n[t-1]]||!Ja[n[t]]?e+=n[t]:e+=Ja[n[t]]}return e}(u));const f=[],g={positionedGlyphs:f,text:u,top:l[1],bottom:l[1],left:l[0],right:l[0],writingMode:c};let A;return A=function(t,e){const n=[];let i=0;for(let o=0;o<e.length;o++){const s=e[o];n.push(t.substring(i,s)),i=s}return i<t.length&&n.push(t.substring(i,t.length)),n}(u,function(t,e,n,i){if(!n)return[];if(!t)return[];const o=[],s=function(t,e,n,i){let o=0;for(let n=0;n<t.length;n++){const s=i[t.codePointAt(n)];s&&(o+=s.metrics.advance+e)}return o/Math.max(1,Math.ceil(o/n))}(t,e,n,i);let a=0;for(let n=0;n<t.length;n++){const l=t.codePointAt(n),h=i[l];h&&(h&&!Ya[l]&&(a+=h.metrics.advance+e),n<t.length-1&&($a[l]||ja(l))&&o.push(il(n+1,a,s,o,nl(l,t.codePointAt(n+1)),!1)))}return rl(il(t.length,a,s,o,0,!0))}(u,a,n,e)),function(t,e,n,i,o,s,a,l,h,c){let u=0,f=0,g=0;const A=t.positionedGlyphs;for(let t=0;t<n.length;t++){let o=n[t];if(o=o.trim(),!o.length){f-=i;continue}const s=A.length;for(let t=0;t<o.length;t++){const n=o.codePointAt(t),i=e[n];i&&(Ua(n)&&1!==a?(32!==n&&A.push({glyph:n,x:u,y:0,vertical:!0}),u+=h+l):(32!==n&&A.push({glyph:n,x:u,y:f,vertical:!1}),u+=i.metrics.advance+l))}if(A.length!==s){g=Math.max(u-l,g),sl(A,e,s,A.length-1,.5)}u=0,f-=i}const{horizontalAlign:m,verticalAlign:w}=ol(o,void 0);!function(t,e,n,i,o,s,a){const l=(.5-n)*o,h=-(-i*a+.5)*s;if(l||h)for(let e=0;e<t.length;e++)t[e].x+=l,t[e].y+=h}(A,0,m,w,g,i,n.length);const T=n.length*i;t.top+=-w*T,t.bottom=t.top+T,t.left+=-m*g,t.right=t.left+g}(g,e,A,i,o,0,c,a,h),!!f.length&&g}const Ya={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},$a={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function el(t,e,n,i){const o=Math.pow(t-e,2);return i?t<e?o/2:2*o:o+Math.abs(n)*n}function nl(t,e){let n=0;return 10===t&&(n-=1e4),40!==t&&65288!==t||(n+=50),41!==e&&65289!==e||(n+=50),n}function il(t,e,n,i,o,s){let a=null,l=el(e,n,o,s);for(let t=0;t<i.length;t++){const h=i[t],c=el(e-h.x,n,o,s)+h.badness;c<=l&&(a=h,l=c)}return{index:t,x:e,priorBreak:a,badness:l}}function rl(t){return t?rl(t.priorBreak).concat(t.index):[]}function ol(t,e){let n=.5,i=.5;switch(t){case"right":case"top-right":case"bottom-right":n=e?1:0;break;case"left":case"top-left":case"bottom-left":n=e?0:1}switch(t){case"bottom":case"bottom-right":case"bottom-left":i=e?1:0;break;case"top":case"top-right":case"top-left":i=e?0:1}return{horizontalAlign:n,verticalAlign:i}}function sl(t,e,n,i,o){const s=e[t[i].glyph];if(s){const e=(t[i].x+s.metrics.advance)*o;if(!e)return;for(let o=n;o<=i;o++)t[o].x-=e}}function al(t){if(!function(t){for(const e of t)if(Za(e.charCodeAt(0)))return!0;return!1}(t))return t;const e=[],n=[],i=[];let o=0,s=0,a=1,l=1;for(const h of t){const t=h.codePointAt(0);Xa(t)?(i.push(h),o++):(a=Za(t)?-1:1,l!==a?(s=o,n.length&&(l>0&&n.reverse(),e.push(...n)),i.length&&(e.splice(s,0,...i),i.length=0),l=a,n.length=0):i.length&&(n.push(...i),i.length=0),n.push(h),o++)}return i.length&&n.push(...i),n.length&&(l>0&&n.reverse(),e.push(...n)),e.reverse().join("")}const ll=/\{ *([\w_]+) *\}/g;class Js{constructor(t,e,n,i,o){this.feature=t,this.symbolDef=e,this.symbol=n,this.options=o,this._thisReplacer=this._replacer.bind(this),this._fnTypes=i}_replacer(t,e){return this.feature.properties[e]||""}getShape(t,e){if(this._shape)return this._shape;const{textHorizontalAlignmentFn:n,textVerticalAlignmentFn:i,markerHorizontalAlignmentFn:o,markerVerticalAlignmentFn:s,textWrapWidthFn:a}=this._fnTypes,l={},h=this.symbol,c=this.getIconAndGlyph(),u=this.feature.properties;if(c&&c.glyph){const{font:t,text:o}=c.glyph;if(""===o)return null;const s=this.textSize[0]/24,f=24,g=h.textKeepUpright,A="map"===h.textRotationAlignment&&"line"===h.textPlacement&&!h.isIconText,m=e.glyphMap[t],w=hl(n?n(null,u):h.textHorizontalAlignment,i?i(null,u):h.textVerticalAlignment),T=1.2*f,M=function(t){for(let e=0;e<t.length;e++)if(!Ga(t.charAt(e).charCodeAt(0)))return!1;return!0}(o),C=M&&h.textLetterSpacing/s||0,P=[h.textDx/s||0,h.textDy/s||0],I=((a?a(null,u):h.textWrapWidth)||10*f)/s,O={};O.horizontal=Qa(o,m,I,T,w,0,C,P,f,1),M&&A&&g&&(O.vertical=Qa(o,m,I,T,w,0,C,P,f,2)),l.textShape=O}if(c&&c.icon){if(!t||!t.positions[c.icon.url])return null;const e=hl(o?o(null,u):h.markerHorizontalAlignment,s?s(null,u):h.markerVerticalAlignment),n=function(t,e,n){let{horizontalAlign:i,verticalAlign:o}=ol(e,n);n?i=1-i:o=1-o;const s=-2048*i,a=-2048*o;return{image:t,top:a,bottom:a+2048,left:s,right:s+2048}}(t.positions[c.icon.url],e,this.options.isVector3D);this.iconSize||(this.iconSize=n.image.displaySize),l.iconShape=n}return this._shape=l,l}getIconAndGlyph(){if(this.iconGlyph)return this.iconGlyph;const{markerFileFn:t,markerTypeFn:e,markerPathFn:n,markerWidthFn:i,markerHeightFn:o,markerFillFn:s,markerFillPatternFileFn:a,markerFillOpacityFn:l,markerTextFitFn:h,markerTextFitPaddingFn:c,markerLineColorFn:u,markerLineWidthFn:f,markerLineOpacityFn:g,markerLineDasharrayFn:A,markerLinePatternFileFn:m,markerPathWidthFn:w,markerPathHeightFn:T,textNameFn:M,textFaceNameFn:C}=this._fnTypes,{zoom:P}=this.options,I={},O=this.symbol,E=this.symbolDef,D=this.feature.properties,N=t?t(null,D):O.markerFile,H=e?e(null,D):O.markerType,U=N||H||O.markerPath,W=!Pn(this.symbolDef.textName);let q,X;if(U){q=function(t,e,n,i,o,s){if(Pn(e.markerWidth)&&Pn(e.markerHeight))return null;const a="__fn_markerWidth".trim(),l="__fn_markerHeight".trim();let h=e.markerWidth||0,c=e.markerHeight||0;return En(h)&&("identity"!==h.type?h=Pa(h):(h=t.markerWidth,t[a]&&(h=t[a](i,n)),En(h)&&(h="identity"===h.type?o(i,n):Pa(h)))),En(c)&&("identity"!==c.type?c=Pa(c):(c=t.markerHeight,t[l]&&(c=t[l](i,n)),En(c)&&(c="identity"===c.type?s(i,n):Pa(c)))),[h,c]}(O,this.symbolDef,D,P,i,o)||[0,0];let t=O.markerTextFit;if(h&&(t=h(P,D)),t&&E.textName&&"none"!==t){const e=E.textSize;let n=E.textName;Gt(n)&&(n=$t(n)(P,D));const i=Da(n,D);if(i){const n="__fn_textSize".trim(),o="__fn_textSize_0".trim();Gt(e)&&!E[n]&&(E[o]=$t(e),E[n]=(t,e)=>{const n=E[o](t,e);return Gt(n)?$t(n)(t,e):n});const s=Sa(E,E,D,P);if("width"!==t&&"both"!==t||(q[0]=s[0]*i.length),"height"!==t&&"both"!==t||(q[1]=s[1]),s[0]&&s[1]){let t=O.markerTextFitPadding||[0,0,0,0];c&&(t=c(P,D)),q[0]+=t[1]+t[3],q[1]+=t[0]+t[2]}}else q[0]=q[1]=-1}}if(W&&(X=Sa(O,this.symbolDef,D,P)),!X&&!q)return I;if(q&&(q[0]=Math.ceil(q[0]),q[1]=Math.ceil(q[1])),X&&(X[0]=Math.ceil(X[0]),X[1]=Math.ceil(X[1])),this.iconSize=q,this.textSize=X,U&&q[0]>=0&&q[1]>=0){let t;if(H){const e={};if(e.markerType=H,"path"===H&&(e.markerPath=n?n(null,D):O.markerPath,e.markerPathWidth=w?w(null,D):O.markerPathWidth,e.markerPathHeight=T?T(null,D):O.markerPathHeight),i){const t=i(null,D);Pn(t)||(e.markerWidth=t)}else O.markerWidth>=0&&(e.markerWidth=O.markerWidth);if(o){const t=o(null,D);Pn(t)||(e.markerHeight=t)}else O.markerHeight>=0&&(e.markerHeight=O.markerHeight);if(s){const t=s(null,D);Pn(t)||(e.markerFill=t)}else O.markerFill&&(e.markerFill=O.markerFill);if(a){const t=a(null,D);Pn(t)||(e.markerFillPatternFile=t)}else O.markerFillPatternFile&&(e.markerFillPatternFile=O.markerFillPatternFile);if(l){const t=l(null,D);Pn(t)||(e.markerFillOpacity=t)}else O.markerFillOpacity>=0&&(e.markerFillOpacity=O.markerFillOpacity);if(u){const t=u(null,D);Pn(t)||(e.markerLineColor=t)}else O.markerLineColor&&(e.markerLineColor=O.markerLineColor);if(f){const t=f(null,D);Pn(t)||(e.markerLineWidth=t)}else O.markerLineWidth>=0&&(e.markerLineWidth=O.markerLineWidth);if(g){const t=g(null,D);Pn(t)||(e.markerLineOpacity=t)}else O.markerLineOpacity>=0&&(e.markerLineOpacity=O.markerLineOpacity);if(A){const t=A(null,D);Pn(t)||(e.markerLineDasharray=t)}else O.markerLineDasharray&&(e.markerLineDasharray=O.markerLineDasharray);if(m){const t=m(null,D);Pn(t)||(e.markerLinePatternFile=t)}else O.markerLinePatternFile&&(e.markerLinePatternFile=O.markerLinePatternFile);t="vector://"+JSON.stringify(e)}else t=N?N.replace(ll,this._thisReplacer):O.markerPath?function(t,e,n){if(!t.markerPath)return null;let i=1;const o=function(t){const e={stroke:{stroke:t.markerLineColor,"stroke-width":t.markerLineWidth,"stroke-opacity":t.markerLineOpacity,"stroke-dasharray":null,"stroke-linecap":"butt","stroke-linejoin":"round"},fill:{fill:t.markerFill,"fill-opacity":t.markerFillOpacity}};return 0===e.stroke["stroke-width"]&&(e.stroke["stroke-opacity"]=0),e}(t);On(t.markerOpacity)&&(i=t.markerOpacity),On(t.opacity)&&(i*=t.opacity);const s={};if(o){for(const t in o.stroke)Nn(o.stroke,t)&&(Pn(o.stroke[t])||(s[t]=o.stroke[t]));for(const t in o.fill)Nn(o.fill,t)&&(Pn(o.fill[t])||(s[t]=o.fill[t]))}const a=Array.isArray(t.markerPath)?t.markerPath:[t.markerPath];let l;const h=[];for(let t=0;t<a.length;t++)l=Ln(a[t])?{path:a[t]}:a[t],l=Mn({},l,s),l.d=l.path,delete l.path,h.push(l);const c=['<svg version="1.1"','xmlns="http://www.w3.org/2000/svg"'];i<1&&c.push('opacity="'+i+'"'),t.markerPathWidth&&t.markerPathHeight&&c.push('viewBox="0 0 '+t.markerPathWidth+" "+t.markerPathHeight+'"'),c.push('preserveAspectRatio="none"'),e&&c.push('width="'+e+'"'),n&&c.push('height="'+n+'"'),c.push("><defs></defs>");for(let t=0;t<h.length;t++){let e="<path ";for(const n in h[t])Nn(h[t],n)&&(e+=" "+n+'="'+h[t][n]+'"');e+="></path>",c.push(e)}return c.push("</svg>"),"data:image/svg+xml;base64,"+btoa(c.join(" "))}(O,q[0],q[1]):null;I.icon={url:t,iconSize:q,textSize:X}}if(W){const t=M?M(this.options.zoom,D):O.textName;if(t||0===t){const e=ka(C?C(null,D):O.textFaceName);let n=Da(t,D);n&&n.length&&(n=al(n),I.glyph={font:e,text:n})}}return this.iconGlyph=I,I}}function hl(t,e){e&&"middle"!==e||(e="center"),t&&"middle"!==t||(t="center");let n="center"!==e?e:"";return n+="center"!==t?(n.length?"-":"")+t:"",n
/*!
  	 * From mapbox-gl-js
  	 * MIT License
  	 * https://github.com/mapbox/mapbox-gl-js
  	 */}function cl(t,e,n,i,o){const a=[];let l;for(let h=0;h<t.length;h++){const c=t[h];let u,f=!1;for(let t=0;t<c.length-1;t++){let h=c[t],g=c[t+1];h.x<e&&g.x<e||(h.x<e?(l=h,h=new s(e,h.y+(e-h.x)/(g.x-h.x)*(g.y-h.y))._round(),h.z=l.z+(e-l.x)/(g.x-l.x)*(g.z-l.z),f=!0):g.x<e&&(l=g,g=new s(e,h.y+(e-h.x)/(g.x-h.x)*(g.y-h.y))._round(),g.z=h.z+(e-h.x)/(l.x-h.x)*(l.z-h.z),f=!0),h.y<n&&g.y<n||(h.y<n?(l=h,h=new s(h.x+(n-h.y)/(g.y-h.y)*(g.x-h.x),n)._round(),h.z=l.z+(n-l.y)/(g.y-l.y)*(g.z-l.z),f=!0):g.y<n&&(l=g,g=new s(h.x+(n-h.y)/(g.y-h.y)*(g.x-h.x),n)._round(),g.z=h.z+(n-h.y)/(l.y-h.y)*(l.z-h.z),f=!0),h.x>=i&&g.x>=i||(h.x>=i?(l=h,h=new s(i,h.y+(i-h.x)/(g.x-h.x)*(g.y-h.y))._round(),h.z=l.z+(i-l.x)/(g.x-l.x)*(g.z-l.z),f=!0):g.x>=i&&(l=g,g=new s(i,h.y+(i-h.x)/(g.x-h.x)*(g.y-h.y))._round(),g.z=h.z+(i-h.x)/(l.x-h.x)*(l.z-h.z),f=!0),h.y>=o&&g.y>=o||(h.y>=o?(l=h,h=new s(h.x+(o-h.y)/(g.y-h.y)*(g.x-h.x),o)._round(),h.z=l.z+(o-l.y)/(g.y-l.y)*(g.z-l.z),f=!0):g.y>=o&&(l=g,g=new s(h.x+(o-h.y)/(g.y-h.y)*(g.x-h.x),o)._round(),g.z=h.z+(o-h.y)/(l.y-h.y)*(l.z-h.z),f=!0),u&&h.equals(u[u.length-1])||(u=[h],a.push(u)),f&&(u.clipped=!0),u.push(g)))))}}return a}class eo extends s{constructor(t,e,n,i){super(t,e),this.angle=n,void 0!==i&&(this.segment=i)}clone(){return new eo(this.x,this.y,this.angle,this.segment)}}
/*!
  	 * From mapbox-gl-js
  	 * MIT License
  	 * https://github.com/mapbox/mapbox-gl-js
  	 */function ul(t,e,n,i,o){if(void 0===e.segment)return!0;let s=e,a=e.segment+1,l=0;for(;l>-n/2;){if(a--,a<0)return!1;l-=t[a].dist(s),s=t[a]}l+=t[a].dist(t[a+1]),a++;const h=[];let c=0;for(;l<n/2;){const e=t[a],n=t[a+1];if(!n)return!1;let s=t[a-1].angleTo(e)-e.angleTo(n);for(s=Math.abs((s+3*Math.PI)%(2*Math.PI)-Math.PI),h.push({distance:l,angleDelta:s}),c+=s;l-h[0].distance>i;)c-=h.shift().angleDelta;if(c>o)return!1;a++,l+=e.dist(n)}return!0}function fl(t,e,n,i,o,s,a,l,h,c,u){const f=function(t,e,n){return t?.6*e*n:0}(i,s,a),g=function(t,e){return Math.max(t?t.right-t.left:0,0)}(i),A=0===t[0].x||t[0].x===h||0===t[0].y||t[0].y===h;return e-g*a<e/4&&(e=g*a+e/4),dl(t,A?e/2*l%e:(g/2+2*s)*a*l%e,e,f,n,g*a,A,!1,h,c,u)}function dl(t,e,n,i,o,s,a,l,h,c,u){let f=0;const g=s/2,A=function(t){let e=0;for(let n=0;n<t.length-1;n++)e+=t[n].dist(t[n+1]);return e}(t);let m=0,w=e-n,T=[];for(let e=0;e<t.length-1;e++){const a=t[e],l=t[e+1],M=a.dist(l),C=l.angleTo(a);for(;w+n<m+M;){w+=n;const P=(w-m)/M,I=gl(a.x,l.x,P),O=gl(a.y,l.y,P),E=gl(a.z||0,l.z||0,P);if(I>=0&&I<h&&O>=0&&O<h&&w-g>=0&&w+g<=A){const n=new eo(I,O,C,e);n.z=E,c&&(n.axis=[a.y-O,I-a.x],n.angleR=E===(a.z||0)?0:Math.atan(.9*(E-(a.z||0))*u/a.dist(n))),n.line=t,n._round(),!i||ul(t,n,s,i,o)?T.push(n):i&&f++}}m+=M}return l||T.length||a||(T=dl(t,m/2,n,i,o,s,a,!0,h,c,u)),T.countOutOfAngle=f,T}function gl(t,e,n){return t*(1-n)+e*n}var pl={exports:{}};pl.exports=function(){function t(n,i,o,s,a){for(;s>o;){if(s-o>600){var l=s-o+1,h=i-o+1,c=Math.log(l),u=.5*Math.exp(2*c/3),f=.5*Math.sqrt(c*u*(l-u)/l)*(h-l/2<0?-1:1);t(n,i,Math.max(o,Math.floor(i-h*u/l+f)),Math.min(s,Math.floor(i+(l-h)*u/l+f)),a)}var g=n[i],A=o,m=s;for(e(n,o,i),a(n[s],g)>0&&e(n,o,s);A<m;){for(e(n,A,m),A++,m--;a(n[A],g)<0;)A++;for(;a(n[m],g)>0;)m--}0===a(n[o],g)?e(n,o,m):e(n,++m,s),m<=i&&(o=m+1),i<=m&&(s=m-1)}}function e(t,e,n){var i=t[e];t[e]=t[n],t[n]=i}function n(t,e){return t<e?-1:t>e?1:0}return function(e,i,o,s,a){t(e,i,o||0,s||e.length-1,a||n)}}();var Al=n(pl.exports);function ml(t,e){const n=t.length;if(n<=1)return[t];const i=[];let o,s;for(let e=0;e<n;e++){const n=P(t[e]);0!==n&&(t[e].area=Math.abs(n),void 0===s&&(s=n<0),s===n<0?(o&&i.push(o),o=[t[e]]):o.push(t[e]))}if(o&&i.push(o),e>1)for(let t=0;t<i.length;t++)i[t].length<=e||(Al(i[t],e,1,i[t].length-1,yl),i[t]=i[t].slice(0,e));return i}function yl(t,e){return e.area-t.area}class ho{constructor(t=[],e=_l){if(this.data=t,this.length=this.data.length,this.compare=e,this.length>0)for(let t=(this.length>>1)-1;t>=0;t--)this._down(t)}push(t){this.data.push(t),this.length++,this._up(this.length-1)}pop(){if(0===this.length)return;const t=this.data[0],e=this.data.pop();return this.length--,this.length>0&&(this.data[0]=e,this._down(0)),t}peek(){return this.data[0]}_up(t){const{data:e,compare:n}=this,i=e[t];for(;t>0;){const o=t-1>>1,s=e[o];if(n(i,s)>=0)break;e[t]=s,t=o}e[t]=i}_down(t){const{data:e,compare:n}=this,i=this.length>>1,o=e[t];for(;t<i;){let i=1+(t<<1),s=e[i];const a=i+1;if(a<this.length&&n(e[a],s)<0&&(i=a,s=e[a]),n(s,o)>=0)break;e[t]=s,t=i}e[t]=o}}function _l(t,e){return t<e?-1:t>e?1:0}function vl(t,e,n){const i=e.distSqr(n);if(0===i)return t.distSqr(e);const o=((t.x-e.x)*(n.x-e.x)+(t.y-e.y)*(n.y-e.y))/i;return t.distSqr(o<0?e:o>1?n:n.sub(e)._mult(o)._add(e))}function xl(t,e=1,n=!1){let i=1/0,o=1/0,a=-1/0,l=-1/0;const h=t[0];for(let t=0;t<h.length;t++){const e=h[t];(!t||e.x<i)&&(i=e.x),(!t||e.y<o)&&(o=e.y),(!t||e.x>a)&&(a=e.x),(!t||e.y>l)&&(l=e.y)}const c=Math.min(a-i,l-o);let u=c/2;const f=new ho([],bl);if(0===c)return new s(i,o);for(let e=i;e<a;e+=c)for(let n=o;n<l;n+=c)f.push(new wl(e+u,n+u,u,t));let g=function(t){let e=0,n=0,i=0;const o=t[0];for(let t=0,s=o.length,a=s-1;t<s;a=t++){const s=o[t],l=o[a],h=s.x*l.y-l.x*s.y;n+=(s.x+l.x)*h,i+=(s.y+l.y)*h,e+=3*h}return new wl(n/e,i/e,0,t)}(t),A=f.length;for(;f.length;){const i=f.pop();(i.d>g.d||!g.d)&&(g=i,n&&console.log("found best %d after %d probes",Math.round(1e4*i.d)/1e4,A)),i.max-g.d<=e||(u=i.h/2,f.push(new wl(i.p.x-u,i.p.y-u,u,t)),f.push(new wl(i.p.x+u,i.p.y-u,u,t)),f.push(new wl(i.p.x-u,i.p.y+u,u,t)),f.push(new wl(i.p.x+u,i.p.y+u,u,t)),A+=4)}return n&&(console.log(`num probes: ${A}`),console.log(`best distance: ${g.d}`)),g.p}function bl(t,e){return e.max-t.max}function wl(t,e,n,i){this.p=new s(t,e),this.h=n,this.d=function(t,e){let n=!1,i=1/0;for(let o=0;o<e.length;o++){const s=e[o];for(let e=0,o=s.length,a=o-1;e<o;a=e++){const o=s[e],l=s[a];o.y>t.y!=l.y>t.y&&t.x<(l.x-o.x)*(t.y-o.y)/(l.y-o.y)+o.x&&(n=!n),i=Math.min(i,vl(t,o,l))}}return(n?1:-1)*Math.sqrt(i)}(this.p,i),this.max=this.d+this.h*Math.SQRT2}function Tl(t,e,n,i,o,s,a,l,h,c){const{feature:u,iconSize:f,textSize:g,symbol:A}=t,m=f||g?24:0,w=o*(g?g[0]/m:1);if("line"===a){const t=[];t.countOutOfAngle=0;let o=u.geometry;s&&(o=cl(u.geometry,0,0,s,s));for(let a=0;a<o.length;a++){const u=fl(o[a],l,n,A.isIconText?null:i&&i.vertical||i&&i.horizontal||i,0,m,A.isIconText?1:w,1,s||1/0,h,c);if(A.textPlacement&&!A.isIconText)for(let t=0;t<u.length;t++)u[t].startIndex=e.length/3;if(t.push.apply(t,u),A.textPlacement&&!A.isIconText)for(let t=0;t<o[a].length;t++)e.push(o[a][t].x,o[a][t].y,o[a][t].z||0);t.countOutOfAngle+=u.countOutOfAngle||0}return t}return Ml(u,a,s)}function Ml(t,e,n,i,o){const s=[];if(3===t.type){const a=ml(t.geometry,0);for(let t=0;t<a.length;t++){const l=a[t];if("vertex"===e)for(let t=0;t<l.length;t++){const e=l[t];for(let a=0;a<e.length;a++)D(e[a],n)||(s.push(e[a]),i&&(0===a?Cl(e[a],e[a],e[t+1],o):Cl(e[a],e[a-1],e[a],o)))}else if("vertex-first"===e){const t=l[0];t&&t[0]&&!D(t[0],n)&&(s.push(t[0]),i&&Cl(t[0],t[0],t[1],o))}else if("vertex-last"===e||"vertex-firstlast"===e){const t=l[0];if("vertex-firstlast"===e&&t&&t[0]&&!D(t[0],n)&&(s.push(t[0]),i&&Cl(t[0],t[0],t[1],o)),t&&t[t.length-1]&&!D(t[t.length-1],n)){const e=t.length-1;s.push(t[e]),i&&Cl(t[e],t[e-1],t[e],o)}}else{const t=xl(l,16);D(t,n)||s.push(t)}}}else if(2===t.type)for(let a=0;a<t.geometry.length;a++){const l=t.geometry[a];if("vertex"===e)for(let t=0;t<l.length;t++)D(l[t],n)||(s.push(l[t]),i&&(0===t?Cl(l[t],l[t],l[t+1],o):Cl(l[t],l[t-1],l[t],o)));else if("vertex-last"===e||"vertex-firstlast"===e){if("vertex-firstlast"!==e||D(l[0],n)||(s.push(l[0]),i&&Cl(l[0],l[0],l[1],o)),l&&l[l.length-1]&&!D(l[l.length-1],n)){const t=l.length-1;s.push(l[t]),i&&Cl(l[t],l[t-1],l[t],o)}}else D(l[0],n)||(s.push(l[0]),i&&Cl(l[0],l[0],l[1],o))}else if(1===t.type)for(let e=0;e<t.geometry.length;e++){const o=t.geometry[e];for(let t=0;t<o.length;t++){const e=o[t];D(e,n)||(i&&(e.xRotation=0,e.yRotation=0,e.zRotation=0),s.push(e))}}return s}function Cl(t,e,n,i){if(t.xRotation||t.yRotation||t.zRotation)return t;const o=n.x-e.x,s=e.y-n.y,a=(n.z-e.z)*i,l=Math.atan2(s,o);t.zRotation=l;const h=Math.atan2(a,Math.sqrt(o*o+s*s));return t.xyRotation=h,t}function Sl(t,e){const n={},i={},o=[];let s=0;function a(e){o.push(t[e]),s++}function l(t,e,n){const s=i[t];return delete i[t],i[e]=s,o[s].geometry[0].pop(),o[s].geometry[0]=o[s].geometry[0].concat(n[0]),s}function h(t,e,i){const s=n[e];return delete n[e],n[t]=s,o[s].geometry[0].shift(),o[s].geometry[0]=i[0].concat(o[s].geometry[0]),s}function c(t,e,n){const i=n?e[0][e[0].length-1]:e[0][0];return`${t}:${i.x}:${i.y}`}for(let u=0;u<t.length;u++){const f=t[u],g=f.geometry;if(!g)continue;const A=f.properties[e]?f.properties[e].toString():null;if(!A){a(u);continue}const m=c(A,g),w=c(A,g,!0);if(m in i&&w in n&&i[m]!==n[w]){const t=h(m,w,g),e=l(m,w,o[t].geometry);delete n[m],delete i[w],i[c(A,o[e].geometry,!0)]=e,o[t].geometry=null}else m in i?l(m,w,g):w in n?h(m,w,g):(a(u),n[m]=s-1,i[w]=s-1)}return o.filter((t=>t.geometry))}const Pl="__index";function Il(t,e,n,i){const o=(Pl+"").trim(),s=function(t,e,n,i){const o=(Pl+"").trim(),{mergeOnPropertyFn:s}=n;if(!e.mergeOnProperty)return[];if(!N(a=e.mergeOnProperty)&&("string"==typeof a||null!==a.constructor&&a.constructor===String))return[{features:t,property:e.mergeOnProperty}];var a;const l=[],h={},c=[];for(let n=0;n<t.length;n++){t[n][o]=n;const a=t[n].properties=t[n].properties||{};a.$layer=t[n].layer,a.$type=t[n].type;const u=s?s(i,a):e.mergeOnProperty;N(u)?c.push(t[n]):(void 0===h[u]&&(h[u]=l.length,l.push({features:[],property:u})),l[h[u]].features.push(t[n]))}return c.length&&l.push({features:c}),l}(t,e,n,i);if(s.length){const t=[];for(let e=0;e<s.length;e++)t.push(s[e].property?Sl(s[e].features,s[e].property):s[e].features);if(1===t.length)return t[0];{let e=[];for(let n=0;n<t.length;n++)e=e.concat(t[n]);return e.sort(((t,e)=>t[o]-e[o])),e}}return[]}class Ao extends gs{static needMerge(t,e,n){if(!t)return!1;let i="line"===t.textPlacement||"line"===t.markerPlacement;return i||(e.textPlacementFn&&(i="line"===e.textPlacementFn(n)),e.markerPlacementFn&&(i="line"===e.markerPlacementFn(n))),t.mergeOnProperty&&i}static mergeLineFeatures(t,e,n,i){let o=e.textPlacement,s=e.markerPlacement;return n.textPlacementFn&&(o=n.textPlacementFn(i)),n.markerPlacementFn&&(s=n.markerPlacementFn(i)),"line"!==o&&"line"!==s?t:Il(t,e,n,i)}static splitPointSymbol(t,e=0){const n=[];if(Array.isArray(t)){const e=t;for(let t=0;t<e.length;t++)e[t]&&n.push(...Ao.splitPointSymbol(e[t],t));return n}let i=null,o=null;for(const e in t)0===e.indexOf("marker")?(i=i||{},i[e]=t[e]):0===e.indexOf("text")&&(o=o||{},o[e]=t[e]);return i&&(i.isIconText=!0,t.mergeOnProperty&&(i.mergeOnProperty=t.mergeOnProperty),n.push(i)),o&&(i&&(o.textPlacement=i.markerPlacement,o.textSpacing=i.markerSpacing,o.isIconText=!0),t.mergeOnProperty&&(o.mergeOnProperty=t.mergeOnProperty),n.push(o)),void 0!==t.visible&&(i&&(i.visible=t.visible),o&&(o.visible=t.visible)),i&&(i.markerTextFit&&o&&(i.text={},i.text.textName=o.textName,i.text.textSize=o.textSize),i.index={index:e,type:0}),o&&(o.index={index:e,type:1}),n}static isAtlasLoaded(t,e){const{icon:n,glyph:i}=t,{iconAtlas:o,glyphAtlas:s}=e;if(n&&(!o||!o.positions[n.url]))return!1;if(i){if(!s||!s.positions[i.font])return!1;const t=s.positions[i.font],{text:e}=i;for(const n of e)if(!t[n.codePointAt(0)])return!1}return!0}constructor(t,e,n){super(t,e,n),this._textPlacement=e.textPlacement,this._fnTypes.textPlacementFn&&(this._textPlacement=this._fnTypes.textPlacementFn(this.options.zoom))}createStyledVector(t,e,n,i,o,s){const a=new Js(t,this.symbolDef,e,n,i),l=a.getIconAndGlyph();if(l.icon&&!this.options.atlas){const{url:t,iconSize:e}=l.icon;o[t]||(o[t]=l.icon.iconSize),o[t][0]<e[0]&&(o[t][0]=e[0]),o[t][1]<e[1]&&(o[t][1]=e[1])}if(l.glyph&&!this.options.atlas){const{font:t,text:e}=l.glyph,n=s[t]=s[t]||{};for(const t of e)n[t.codePointAt(0)]=1;"line"===this._textPlacement&&(s.options={isCharsCompact:!1})}return this.options.allowEmptyPack||l.icon||l.glyph?a:null}getFormat(t){const e="text"===this.options.pluginType,n="line"===this._textPlacement&&!t.isIconText,i=this.getPackSDFFormat(t);i.push(...this._getTextFnTypeFormats()),n||i.push(...this._getMarkerFnTypeFormats());const{markerOpacityFn:o,textOpacityFn:s,markerPitchAlignmentFn:a,textPitchAlignmentFn:l,markerRotationAlignmentFn:h,textRotationAlignmentFn:c,markerRotationFn:u,textRotationFn:f,markerAllowOverlapFn:g,textAllowOverlapFn:A,markerIgnorePlacementFn:m,textIgnorePlacementFn:w}=this._fnTypes;return o?i.push({type:Uint8Array,width:2,name:"aColorOpacity"}):s&&i.push({type:Uint8Array,width:1,name:"aColorOpacity"}),(a||l)&&i.push({type:Uint8Array,width:e?1:2,name:"aPitchAlign"}),(h||c)&&i.push({type:Uint8Array,width:e?1:2,name:"aRotationAlign"}),(u||f)&&i.push({type:Uint16Array,width:e?1:2,name:"aRotation"}),(g||A||m||w)&&i.push({type:Uint8Array,width:1,name:"aOverlap"}),i}_is3DPitchText(){return this.hasMapPitchAlign}_getTextFnTypeFormats(){const{textFillFn:t,textSizeFn:e,textHaloFillFn:n,textHaloRadiusFn:i,textHaloOpacityFn:o,textDxFn:s,textDyFn:a}=this._fnTypes,l=[];return t&&l.push({type:Uint8Array,width:4,name:"aTextFill"}),e&&l.push({type:Uint8Array,width:1,name:"aTextSize"}),n&&l.push({type:Uint8Array,width:4,name:"aTextHaloFill"}),(i||o)&&l.push({type:Uint8Array,width:2,name:"aTextHalo"}),s&&l.push({type:Int8Array,width:1,name:"aTextDx"}),a&&l.push({type:Int8Array,width:1,name:"aTextDy"}),l}_getMarkerFnTypeFormats(){const{markerWidthFn:t,markerHeightFn:e,markerDxFn:n,markerDyFn:i,textDxFn:o,textDyFn:s}=this._fnTypes,a=[];return t&&a.push({type:this.options.markerWidthType||Uint8Array,width:1,name:"aMarkerWidth"}),e&&a.push({type:this.options.markerHeightType||Uint8Array,width:1,name:"aMarkerHeight"}),(n||o)&&a.push({type:Int8Array,width:1,name:"aMarkerDx"}),(i||s)&&a.push({type:Int8Array,width:1,name:"aMarkerDy"}),a}_prepareFnTypes(){this.iconAtlas||(this._fnTypes.markerWidthFn=this._fnTypes.markerHeightFn=this._fnTypes.markerDxFn=this._fnTypes.markerDyFn=this._fnTypes.markerPitchAlignmentFn=this._fnTypes.markerRotationAlignmentFn=this._fnTypes.markerRotationFn=this._fnTypes.markerAllowOverlapFn=this._fnTypes.markerIgnorePlacementFn=this._fnTypes.markerOpacityFn=null),this.glyphAtlas||(this._fnTypes.textFillFn=this._fnTypes.textSizeFn=this._fnTypes.textHaloFillFn=this._fnTypes.textHaloRadiusFn=this._fnTypes.textHaloOpacityFn=this._fnTypes.textDxFn=this._fnTypes.textDyFn=this._fnTypes.textPitchAlignmentFn=this._fnTypes.textRotationAlignmentFn=this._fnTypes.textRotationFn=this._fnTypes.textAllowOverlapFn=this._fnTypes.textIgnorePlacementFn=this._fnTypes.textOpacityFn=null)}createDataPack(){if(!this.iconAtlas&&!this.glyphAtlas){if(!this.options.allowEmptyPack)return null;this.empty=!0}this._prepareFnTypes(),this.countOutOfAngle=0,this.lineVertex=[];const t=super.createDataPack.apply(this,arguments);return t?(t.lineVertex=new Int16Array(this.lineVertex),t.buffers.push(t.lineVertex.buffer),t):null}placeVector(t,e){const n=t.getShape(this.iconAtlas,this.glyphAtlas);if(!n)return;const{iconShape:i,textShape:o}=n,a=!i||!i.image,l=!o||!o.horizontal&&!o.vertical;if(!this.options.allowEmptyPack&&a&&l)return;const h=this._getAnchors(t,o||i,e);if(this.countOutOfAngle+=h.countOutOfAngle||0,0===h.length)return;const c=this.data,u=this.needAltitudeAttribute()?2:3;let f=this.data.aPosition.getLength()/u;const g=t.feature.properties,A="line"===this._textPlacement&&!t.symbol.isIconText,m=!l,w=!a,T=m&&A&&function(t){let e=0;for(let n=0;n<t.length;n++)if(Ua(t.charAt(n).charCodeAt(0)))e=0;else if(e++,e>=1)return!1;return!0}(t.getIconAndGlyph().glyph.text)?1:0,{textFillFn:M,textSizeFn:C,textHaloFillFn:P,textHaloRadiusFn:I,textHaloOpacityFn:O,textDxFn:U,textDyFn:W,textPitchAlignmentFn:q,textRotationAlignmentFn:X,textRotationFn:J,textAllowOverlapFn:Q,textIgnorePlacementFn:Y,textOpacityFn:K,markerWidthFn:$,markerHeightFn:tt,markerDxFn:et,markerDyFn:nt,markerPitchAlignmentFn:it,markerRotationAlignmentFn:rt,markerRotationFn:ot,markerAllowOverlapFn:st,markerIgnorePlacementFn:at,markerOpacityFn:ut}=this._fnTypes;let ft,gt,vt,xt,bt,Ct=[0,0,0,0],Ot=14,$t=[0,0,0,0],ne=0,re=0,oe=0,ae=0,he=0,ce=0,ue=0,fe=0,ge=0,pe=0,Ae=0,me=0,ye=0,_e=0;if(m){const e=t.getIconAndGlyph().glyph.font;vt=function(t,e,n){const i=t.positionedGlyphs,o=[];for(let a=0;a<i.length;a++){const l=i[a],h=n[l.glyph];if(!h)continue;const c=h.rect;if(!c)continue;const u=4,f=h.metrics.advance/2,g=h.metrics.height/2,A=e?[l.x+f,0]:[0,0],m=e?[0,l.y-g]:[l.x+f,l.y-g],w=h.metrics.left-u-f+m[0],T=h.metrics.top-u+m[1],M=w+c.w,C=T+c.h,P=new s(w,T),I=new s(M,T),O=new s(w,C),E=new s(M,C);if(e&&l.vertical){const t=new s(-f,f),e=-Math.PI/2,n=new s(5,0);P._rotateAround(e,t)._add(n),I._rotateAround(e,t)._add(n),O._rotateAround(e,t)._add(n),E._rotateAround(e,t)._add(n)}o.push({tl:P,tr:I,bl:O,br:E,tex:c,writingMode:t.writingMode,glyphOffset:A})}return o}(o.horizontal,A,this.glyphAtlas.positions[e]),M&&(Ct=M(null,g),Gt(Ct)?this.dynamicAttrs.aTextFill=1:Ct=Wn([],Ct)),C&&(Ot=C(this.options.zoom,g),N(Ot)&&(Ot=14)),P&&($t=P(null,g),Gt($t)?this.dynamicAttrs.aTextHaloFill=1:$t=Wn([],$t)),I&&(ne=I(null,g)),O&&(re=255*O(null,g)),U&&(oe=U(null,g)||0),W&&(ae=W(null,g)||0),q&&(pe=+("map"===q(null,g))),X&&(me=+("map"===X(null,g))),J&&(_e=H(J(null,g),0,360)*Math.PI/180)}w&&(xt=i?function(t){const e=t.image,n=t.top-1/e.pixelRatio,i=t.left-1/e.pixelRatio,o=t.bottom+1/e.pixelRatio,a=t.right+1/e.pixelRatio;let l,h,c,u;return l=new s(i,n),h=new s(a,n),c=new s(a,o),u=new s(i,o),[{tl:l,tr:h,bl:u,br:c,tex:{x:e.tl[0],y:e.tl[1],w:e.displaySize[0],h:e.displaySize[1]},writingMode:void 0,glyphOffset:[0,0]}]}(i):function(){const t=new s(0,0),e=new s(0,0),n=new s(0,0);return[{tl:t,tr:e,bl:new s(0,0),br:n,tex:{x:0,y:0,w:0,h:0},writingMode:void 0,glyphOffset:[0,0]}]}(),$&&(he=$(null,g)),N(he)&&(he=xt[0].tex.w),tt&&(ce=tt(null,g)),N(ce)&&(ce=xt[0].tex.h),et&&(ue=et(null,g)),nt&&(fe=nt(null,g)),it&&(ge=+("map"===it(null,g))),rt&&(Ae=+("map"===rt(null,g))),ot&&(ye=H(ot(null,g),0,360)*Math.PI/180)),Gt(Ot)&&(this.dynamicAttrs.aTextSize=1),(Gt(ne)||Gt(re))&&(this.dynamicAttrs.aTextHalo=1),Gt(he)&&(this.dynamicAttrs.aMarkerWidth=1),Gt(ce)&&(this.dynamicAttrs.aMarkerHeight=1),(Gt(ue)||Gt(oe))&&(this.dynamicAttrs.aDxDy=1),(Gt(fe)||Gt(oe))&&(this.dynamicAttrs.aDxDy=1),(Gt(ge)||Gt(pe))&&(this.dynamicAttrs.aPitchAlign=1),(Gt(Ae)||Gt(me))&&(this.dynamicAttrs.aRotationAlign=1),(Gt(ye)||Gt(_e))&&(this.dynamicAttrs.aRotation=1),(st||Q)&&(st&&(ft=st(null,g)||0),!ft&&Q&&(ft=Q(null,g)||0)),(at||Y)&&(at&&(gt=at(null,g)||0),!gt&&Y&&(gt=Y(null,g)||0)),ut&&(bt=255*(ut(this.options.zoom,g)||0));let ve=0;K&&(ve=255*(K(this.options.zoom,g)||0));const xe=vt&&vt.length||0;this.ensureDataCapacity(4*(xe+(xt&&xt.length||0)),h.length);const be=this.options.EXTENT,{altitudeScale:we,altitudeProperty:Me,defaultAltitude:Ee}=this.options,{altitude:ke}=E(t.feature,we,Me,Ee),Re=this.needAltitudeAttribute(),Le=(t,e,n,i,o,s,a)=>{if(!e)return;const l=t?xe:1;for(let h=0;h<e.length;h++){const u=e[h],{tl:g,tr:m,bl:w,br:M,tex:C}=u;let P;this._fillPos(c,n,i,o,10*g.x,10*g.y,C.x,C.y+C.h,t,a),this._fillTextData(c,A,l,u.glyphOffset,s,T,s.axis,s.angleR),this._fillFnTypeData(c,Ct,Ot,$t,ne,re,oe,ae,he,ce,ue,fe,bt,ve,ge,pe,Ae,me,ye,_e,ft,gt),this._fillPos(c,n,i,o,10*m.x,10*m.y,C.x+C.w,C.y+C.h,t,a),this._fillTextData(c,A,l,u.glyphOffset,s,T,s.axis,s.angleR),this._fillFnTypeData(c,Ct,Ot,$t,ne,re,oe,ae,he,ce,ue,fe,bt,ve,ge,pe,Ae,me,ye,_e,ft,gt),this._fillPos(c,n,i,o,10*w.x,10*w.y,C.x,C.y,t,a),this._fillTextData(c,A,l,u.glyphOffset,s,T,s.axis,s.angleR),this._fillFnTypeData(c,Ct,Ot,$t,ne,re,oe,ae,he,ce,ue,fe,bt,ve,ge,pe,Ae,me,ye,_e,ft,gt),this._fillPos(c,n,i,o,10*M.x,10*M.y,C.x+C.w,C.y,t,a),this._fillTextData(c,A,l,u.glyphOffset,s,T,s.axis,s.angleR),this._fillFnTypeData(c,Ct,Ot,$t,ne,re,oe,ae,he,ce,ue,fe,bt,ve,ge,pe,Ae,me,ye,_e,ft,gt),this.addElements(f,f+1,f+2),this.addElements(f+1,f+2,f+3),f+=4,P=Re?Math.max(Math.abs(n),Math.abs(i)):Math.max(Math.abs(n),Math.abs(i),Math.abs(o)),P>this.maxPos&&(this.maxPos=P)}},Fe="text"===this.options.pluginType;for(let t=0;t<h.length;t++){const e=h[t],n=e.z||ke||0;if(be!==1/0&&D(e,be))continue;const i=e.x,o=e.y;w&&Le(!1,xt,i,o,n,e),m&&(Fe||Le(!0,vt,i,o,n,e,!0),Le(!0,vt,i,o,n,e,!1))}}_fillPos(t,e,n,i,o,s,a,l,h,c){this.fillPosition(t,e,n,i);let u=t.aShape.currentIndex;t.aShape[u++]=o,t.aShape[u++]=s,t.aShape.currentIndex=u,t.aTexCoord?(u=t.aTexCoord.currentIndex,t.aTexCoord[u++]=a,t.aTexCoord[u++]=l,t.aTexCoord.currentIndex=u):(u=t.aShape.currentIndex,"text"!==this.options.pluginType?(t.aShape[u++]=+!!h+(a<<1),t.aShape[u++]=+!!c+(l<<1)):(t.aShape[u++]=a,t.aShape[u++]=l),t.aShape.currentIndex=u)}_fillTextData(t,e,n,i,o,s,a,l){let h=t.aCount.currentIndex;if(t.aCount[h++]=n,t.aCount.currentIndex=h,e){h=t.aGlyphOffset.currentIndex,t.aGlyphOffset[h++]=i[0],t.aGlyphOffset[h++]=i[1],t.aGlyphOffset.currentIndex=h,this._is3DPitchText()&&(h=t.aPitchRotation.currentIndex,t.aPitchRotation[h++]=a[0],t.aPitchRotation[h++]=a[1],t.aPitchRotation[h++]=l,t.aPitchRotation.currentIndex=h);const e=o.startIndex;h=t.aSegment.currentIndex,t.aSegment[h++]=o.segment+e,t.aSegment[h++]=e,t.aSegment[h++]=o.line.length,t.aSegment.currentIndex=h,h=t.aVertical.currentIndex,t.aVertical[h++]=s,t.aVertical.currentIndex=h}}_fillFnTypeData(t,e,n,i,o,s,a,l,h,c,u,f,g,A,m,w,T,M,C,P,I,O){const{textFillFn:E,textSizeFn:D,textHaloFillFn:H,textHaloRadiusFn:U,textDxFn:W,textDyFn:q,textPitchAlignmentFn:X,textRotationAlignmentFn:J,textRotationFn:Q,textAllowOverlapFn:Y,textIgnorePlacementFn:K,textOpacityFn:$,textHaloOpacityFn:tt,markerWidthFn:et,markerHeightFn:nt,markerDxFn:it,markerDyFn:rt,markerPitchAlignmentFn:ot,markerRotationAlignmentFn:st,markerRotationFn:at,markerAllowOverlapFn:ut,markerIgnorePlacementFn:ft,markerOpacityFn:gt}=this._fnTypes;if(E){let n=t.aTextFill.currentIndex;t.aTextFill[n++]=e[0],t.aTextFill[n++]=e[1],t.aTextFill[n++]=e[2],t.aTextFill[n++]=e[3],t.aTextFill.currentIndex=n}if(D){let e=t.aTextSize.currentIndex;t.aTextSize[e++]=n,t.aTextSize.currentIndex=e}if(H){let e=t.aTextHaloFill.currentIndex;t.aTextHaloFill[e++]=i[0],t.aTextHaloFill[e++]=i[1],t.aTextHaloFill[e++]=i[2],t.aTextHaloFill[e++]=i[3],t.aTextHaloFill.currentIndex=e}if(U||tt){let e=t.aTextHalo.currentIndex;t.aTextHalo[e++]=o||0,t.aTextHalo.currentIndex=e,e=t.aTextHalo.currentIndex,t.aTextHalo[e++]=255*(N(s)?1:s),t.aTextHalo.currentIndex=e}if(W){let e=t.aTextDx.currentIndex;t.aTextDx[e++]=a,t.aTextDx.currentIndex=e}if(q){let e=t.aTextDy.currentIndex;t.aTextDy[e++]=l,t.aTextDy.currentIndex=e}if(et){let e=t.aMarkerWidth.currentIndex;t.aMarkerWidth[e++]=h,t.aMarkerWidth.currentIndex=e}if(nt){let e=t.aMarkerHeight.currentIndex;t.aMarkerHeight[e++]=c,t.aMarkerHeight.currentIndex=e}if(it){let e=t.aMarkerDx.currentIndex;t.aMarkerDx[e++]=u,t.aMarkerDx.currentIndex=e}if(rt){let e=t.aMarkerDy.currentIndex;t.aMarkerDy[e++]=f,t.aMarkerDy.currentIndex=e}const vt="text"===this.options.pluginType;if(!vt&&(gt||$)){gt||(g=255);let e=t.aColorOpacity.currentIndex;t.aColorOpacity[e++]=g,t.aColorOpacity.currentIndex=e,e=t.aColorOpacity.currentIndex,t.aColorOpacity[e++]=g=$?A:255,t.aColorOpacity.currentIndex=e}if(vt&&$){let e=t.aColorOpacity.currentIndex;t.aColorOpacity[e++]=A,t.aColorOpacity.currentIndex=e}if(X||ot)if(vt){let e=t.aPitchAlign.currentIndex;t.aPitchAlign[e++]=w,t.aPitchAlign.currentIndex=e}else{let e=t.aPitchAlign.currentIndex;t.aPitchAlign[e++]=m,t.aPitchAlign.currentIndex=e,e=t.aPitchAlign.currentIndex,t.aPitchAlign[e++]=w,t.aPitchAlign.currentIndex=e}if(st||J)if(vt){let e=t.aRotationAlign.currentIndex;t.aRotationAlign[e++]=M,t.aRotationAlign.currentIndex=e}else{let e=t.aRotationAlign.currentIndex;t.aRotationAlign[e++]=T,t.aRotationAlign.currentIndex=e,e=t.aRotationAlign.currentIndex,t.aRotationAlign[e++]=M,t.aRotationAlign.currentIndex=e}if(at||Q)if(vt){let e=t.aRotation.currentIndex;t.aRotation[e++]=9362*P,t.aRotation.currentIndex=e}else{let e=t.aRotation.currentIndex;t.aRotation[e++]=9362*C,t.aRotation.currentIndex=e,e=t.aRotation.currentIndex,t.aRotation[e++]=9362*P,t.aRotation.currentIndex=e}const xt=ut||Y,bt=ft||K;if(xt||bt){let e=t.aOverlap.currentIndex;t.aOverlap[e++]=(xt?8:0)+4*I+((bt?2:0)+O),t.aOverlap.currentIndex=e}o>0&&(this.properties.hasHalo=1)}_getAnchors(t,e,n){const{feature:i,symbol:o}=t,s=this._getPlacement(t,o),a=i.properties,{markerSpacingFn:l,textSpacingFn:h,textMaxAngleFn:c}=this._fnTypes,u=((l?l(null,a):o.markerSpacing)||(h?h(null,a):o.textSpacing)||250)*n;let f=c?c(this.options.zoom,a):o.textMaxAngle;N(f)&&(f=80),f*=Math.PI/180;const g=this.options.EXTENT,A=this.options.altitudeToTileScale,m=this._is3DPitchText();return Tl(t,this.lineVertex,f,e,n,g,s,u,m,A)}_getPlacement(t,e){let n;return n=this._fnTypes.markerPlacementFn?this._fnTypes.markerPlacementFn(this.options.zoom,t.feature.properties):e.markerPlacement||this._textPlacement,this._packMarkerPlacement||!e.markerPlacement&&!e.isIconText||(this._packMarkerPlacement=n),!this._textPlacement||e.isIconText||this._packTextPlacement||(this._packTextPlacement=n),n}getPackSDFFormat(t){if("line"!==this._textPlacement||t.isIconText)return[...this.getPositionFormat(),{type:Int16Array,width:4,name:"aShape"},{type:Uint8Array,width:1,name:"aCount"}];{const t=[...this.getPositionFormat(),{type:Int16Array,width:2,name:"aShape"},{type:Uint16Array,width:2,name:"aTexCoord"},{type:Uint8Array,width:1,name:"aCount"},{type:Int16Array,width:2,name:"aGlyphOffset"},{type:Uint16Array,width:3,name:"aSegment"},{type:Uint8Array,width:1,name:"aVertical"}];return this._is3DPitchText()&&t.push({type:Float32Array,width:3,name:"aPitchRotation"}),t}}}class To{constructor(t){this.x=t.x,this.y=t.y,this.z=t.z||0}clone(){return new To(this)}_unit(){return this._div(this.mag()),this}_div(t){return this.x/=t,this.y/=t,this.z/=t,this}_perp(){var t=this.y;return this.y=this.x,this.x=-t,this}mag(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}add(t){return this.clone()._add(t)}sub(t){return this.clone()._sub(t)}_add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}_sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z}mult(t){return this.clone()._mult(t)}_mult(t){return this.x*=t,this.y*=t,this.z*=t,this}dist(t){return Math.sqrt(this.distSqr(t))}distSqr(t){var e=t.x-this.x,n=t.y-this.y,i=t.z-this.z;return e*e+n*n+i*i}_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}angleTo(t){return Math.atan2(this.y-t.y,this.x-t.x)}}var Ol,El="undefined"!=typeof Float32Array?Float32Array:Array;function kl(t,e,n,i){return t[0]=e,t[1]=n,t[2]=i,t}function Rl(t,e){var n=e[0],i=e[1],o=e[2],s=n*n+i*i+o*o;return s>0&&(s=1/Math.sqrt(s)),t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s,t}function Ll(t,e,n){var i=e[0],o=e[1],s=e[2],a=n[0],l=n[1],h=n[2];return t[0]=o*h-s*l,t[1]=s*a-i*h,t[2]=i*l-o*a,t}function Fl(t,e,n,i,o){return t[0]=e,t[1]=n,t[2]=i,t[3]=o,t}function Nl(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t}function Hl(t,e,n){return t[0]=e,t[1]=n,t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)}),Ol=new El(3),El!=Float32Array&&(Ol[0]=0,Ol[1]=0,Ol[2]=0),function(){var t=new El(4);El!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0)}(),function(){var t=new El(2);El!=Float32Array&&(t[0]=0,t[1]=0)}();const Bl=63,zl=Math.cos(Math.PI/180*37.5),Gl=Math.pow(2,16)/1,jl=new s,Vl=new s,Wl=new s;class No extends gs{static mergeLineFeatures(t,e,n,i){return Il(t,e,n,i)}constructor(t,e,n){super(t,e,n);let i=!1;const{lineDasharrayFn:o,lineDashColorFn:s}=this._fnTypes;this.hasGradient=this.symbol.lineGradientProperty,o&&(i=function(t,e,n){for(let i=0;i<t.length;i++)if(n(e,t[i].properties))return!0;return!1}(t,this.options.zoom,o),i&&(this.dasharrayFn=o)),this.hasDasharray=Xl(this.symbol.lineDasharray)||i,this.hasDasharray&&s&&(this.dashColorFn=s)}createStyledVector(t,e,n,i,o){const s=new dt(t,e,n,i),a=s.getLineResource();return!this.options.atlas&&a&&(o[a]=[0,0]),s}getFormat(){const{lineWidthFn:t,lineStrokeWidthFn:e,lineStrokeColorFn:n,lineColorFn:i,lineOpacityFn:o,lineDxFn:s,lineDyFn:a,linePatternAnimSpeedFn:l,linePatternGapFn:h}=this._fnTypes,c=[...this.getPositionFormat()];if(c.push(this.iconAtlas||this.hasDasharray?{type:Int8Array,width:3,name:"aExtrude"}:{type:Int8Array,width:2,name:"aExtrude"}),c.push({type:this.options.positionType||Uint16Array,width:1,name:"aLinesofar"}),t&&c.push({type:Uint8Array,width:1,name:"aLineWidth"}),e&&c.push({type:Uint8Array,width:1,name:"aLineStrokeWidth"}),i&&c.push({type:Uint8Array,width:4,name:"aColor"}),n&&c.push({type:Uint8Array,width:4,name:"aStrokeColor"}),o&&c.push({type:Uint8Array,width:1,name:"aOpacity"}),this.dasharrayFn&&c.push({type:Uint8Array,width:4,name:"aDasharray"}),this.dashColorFn&&c.push({type:Uint8Array,width:4,name:"aDashColor"}),this.iconAtlas){const t=this.getIconAtlasMaxValue();c.push({type:t>255?Uint16Array:Uint8Array,width:4,name:"aTexInfo"})}return(s||a)&&c.push({type:Int8Array,width:2,name:"aLineDxDy"}),(l||h)&&c.push({type:Int8Array,width:2,name:"aLinePattern"}),c}placeVector(t){const{lineJoinFn:e,lineCapFn:n,lineWidthFn:i,lineHeightFn:o,lineStrokeWidthFn:s,lineStrokeColorFn:a,lineColorFn:l,lineOpacityFn:h,lineDxFn:c,lineDyFn:u,linePatternAnimSpeedFn:f,linePatternGapFn:g}=this._fnTypes,A=this.symbol,m=t.feature,w=m.properties;let T=A.lineJoin||"miter",M=A.lineCap||"butt";if(e&&(T=e(this.options.zoom,w)||"miter"),n&&(M=n(this.options.zoom,w)||"butt"),i){let t=i(this.options.zoom,w);Gt(t)&&(this.dynamicAttrs.aLineWidth=1,t=4),Pn(t)&&(t=4),this.feaLineWidth=+t}else this.feaLineWidth=+A.lineWidth;if(o){let t=o(this.options.zoom,w);Gt(t)&&(this.dynamicAttrs.aLineHeight=1),Pn(t)&&(t=this.feaLineWidth),this.feaLineHeight=+t}else this.feaLineHeight=+A.lineHeight||this.feaLineWidth;if(s){let t=s(this.options.zoom,w);Gt(t)&&(this.dynamicAttrs.aLineStrokeWidth=1,t=0),Pn(t)&&(t=0),this.feaLineStrokeWidth=t}else this.feaLineStrokeWidth=A.lineStrokeWidth||0;if(l&&(this.feaColor=l(this.options.zoom,w)||[255,255,255,255],Gt(this.feaColor)?(this.dynamicAttrs.aColor=1,this.feaColor=[0,0,0,0]):this.feaColor=Wn([],this.feaColor)),a&&(this.feaStrokeColor=a(this.options.zoom,w)||[0,0,0,255],Gt(this.feaStrokeColor)?(this.dynamicAttrs.aStrokeColor=1,this.feaStrokeColor=[0,0,0,0]):this.feaStrokeColor=Wn([],this.feaStrokeColor)),h){let t=h(this.options.zoom,w);Gt(t)&&(this.dynamicAttrs.aOpacity=1,t=1),Pn(t)&&(t=1),this.feaOpacity=255*t}if(this.dasharrayFn){let t=this.dasharrayFn(this.options.zoom,w)||[0,0,0,0];if(Gt(t)&&(this.dynamicAttrs.aDasharray=1,t=[0,0,0,0]),t.length<4){const e=t;1===t.length?t=[e[0],e[0],e[0],e[0]]:2===t.length?t=[e[0],e[1],e[0],e[1]]:3===t.length&&(t=[e[0],e[1],e[2],e[2]])}this.feaDash=t}if(this.dashColorFn){let t=(this.dashColorFn?this.dashColorFn(this.options.zoom,w):this.symbol.lineDashColor)||[0,0,0,0];Gt(t)&&(this.dynamicAttrs.aDashColor=1,t=[0,0,0,0]),t=Wn([],t),this.feaDashColor=t}if(this.iconAtlas){const e=t.getLineResource(),n=this.iconAtlas.glyphMap[e];if(this.feaTexInfo=this.feaTexInfo||[0,0,0,0],n){const{tl:t,displaySize:n}=this.iconAtlas.positions[e];this.feaTexInfo[0]=t[0]+1,this.feaTexInfo[1]=t[1]+1,this.feaTexInfo[2]=n[0]-3,this.feaTexInfo[3]=n[1]-3}else this.feaTexInfo[0]=this.feaTexInfo[1]=this.feaTexInfo[2]=this.feaTexInfo[3]=0}if(c){let t=c(this.options.zoom,w);Gt(t)&&(this.dynamicAttrs.aLineDxDy=1,t=0),Pn(t)&&(t=0),this.feaLineDx=t}if(u){let t=u(this.options.zoom,w);Gt(t)&&(this.dynamicAttrs.aLineDxDy=1,t=0),Pn(t)&&(t=0),this.feaLineDy=t}if(f){let t=f(this.options.zoom,w);Gt(t)&&(this.dynamicAttrs.aLinePatternAnimSpeed=1,t=0),Pn(t)&&(t=0),0!==t&&(this.properties.hasPatternAnim=1),this.feaPatternAnimSpeed=t}if(g){let t=g(this.options.zoom,w);Gt(t)&&(this.dynamicAttrs.aLinePatternGap=1,t=0),Pn(t)&&(t=0),this.feaLinePatternGap=t}const C=this.options.EXTENT;let P=m.geometry;if(C!==1/0){P=[];const t=[];for(let e=0;e<m.geometry.length;e++){t[0]=m.geometry[e];const n=cl(t,-1,-1,C+1,C+1);if(3===m.type&&n.length>1){const t=n[0],e=n[n.length-1];Kl(t[0],e[e.length-1])&&(n[0]=e.concat(t.slice(1)),n.length=n.length-1)}P.push(...n)}}const I=this.needAltitudeAttribute()?2:3;for(let t=0;t<P.length;t++){this.offset=this.data.aPosition.getLength()/I;this._addLine(P[t],m,T,M,2,1.05)}}_hasPattern(){return this.iconAtlas&&this.feaTexInfo[2]&&this.feaTexInfo[3]}_addLine(t,e,n,i,o,s){const a=this._hasPattern()||Xl(this.feaDash)||Xl(this.symbol.lineDasharray),l=this.options.isTube;l&&(t=t.map((t=>new To(t)))),this.overscaling=1;const h=this.options.EXTENT;if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.prevVertex=null,this.symbol.lineGradientProperty&&e.properties&&On(e.properties.mapbox_clip_start)&&On(e.properties.mapbox_clip_end)){this.clipStart=+e.properties.mapbox_clip_start,this.clipEnd=+e.properties.mapbox_clip_end;for(let e=0;e<t.length-1;e++)this.totalDistance+=t[e].dist(t[e+1]);this.updateScaledDistance()}const c=3===e.type&&!t.clipped;let u=t.length;for(;u>=2&&Kl(t[u-1],t[u-2]);)u--;let f=0;for(;f<u-1&&Kl(t[f],t[f+1]);)f++;if(u<(c?3:2))return;"bevel"===n&&(o=1.05);const g=this.overscaling<=16?15*h/(512*this.overscaling):0,A={vertexLength:0,primitiveLength:0,currentNormal:null};let m,w,T,M,C;this.e1=this.e2=-1,c&&(m=t[u-2],C=t[f].sub(m)._unit()._perp()),this.ensureDataCapacity(n,u,360,2);for(let e=f;e<u;e++){if(T=e===u-1?c?t[f+1]:void 0:t[e+1],T&&Kl(t[e],T))continue;C&&(M=C),m&&(w=m),m=t[e],T&&m.x===T.x&&m.y===T.y&&(m.x+=1e-4),C=T?T.sub(m)._unit()._perp():M,A.dir=w?m.sub(w)._unit():T.sub(m)._unit(),M=M||C,A.currentNormal=M;let h=M.add(C);0===h.x&&0===h.y||h._unit();const P=M.x*C.x+M.y*C.y,I=h.x*C.x+h.y*C.y,O=0!==I?1/I:1/0,E=2*Math.sqrt(2-2*I),D=I<zl&&w&&T,N=M.x*C.y-M.y*C.x>0;if(!l&&D&&e>f){const t=m.dist(w);if(t>2*g){const e=m.sub(m.sub(w)._mult(g/t)._round());e.z=m.z,this.updateDistance(w,e),this.addCurrentVertex(e,M,0,0,A),w=e}}const H=w&&T;A.middleVertex=H;let U=H?n:c?"butt":i;if(H&&"round"===U&&(O<s?U="miter":O<=2&&(U="fakeround")),"miter"===U&&O>o&&!l&&(U="bevel"),"bevel"===U&&(O>2&&(U="flipbevel"),O<o&&(U="miter")),w&&this.updateDistance(w,m),"miter"===U)l?(this.addCurrentVertex(m,M,0,0,A),A.dir=T.sub(m)._unit(),this.addCurrentVertex(m,C,0,0,A)):(h._mult(O),this.addCurrentVertex(m,h,0,0,A),a&&(A.currentNormal=C,A.dir=T.sub(m)._unit(),this.addCurrentVertex(m,h,0,0,A)));else if("flipbevel"===U){if(O>100)h=C.mult(-1);else{const t=O*M.add(C).mag()/M.sub(C).mag();h._perp()._mult(t*(N?-1:1))}this.addCurrentVertex(m,h,0,0,A),this.addCurrentVertex(m,h.mult(-1),0,0,A)}else if("bevel"===U||"fakeround"===U){const t=-Math.sqrt(O*O-1),e=N?t:0,n=N?0:t;if(w&&this.addCurrentVertex(m,M,e,n,A),"fakeround"===U){const t=Math.round(180*E/Math.PI/20);for(let e=1;e<t;e++){let n=e/t;if(.5!==n){const t=n-.5;n+=n*t*(n-1)*((1.0904+P*(P*(3.55645-1.43519*P)-3.2452))*t*t+(.848013+P*(.215638*P-1.06021)))}const i=C.sub(M)._mult(n)._add(M)._unit()._mult(N?-1:1);this.addHalfVertex(m,i.x,i.y,!1,N,0,A)}}T&&(A.currentNormal=C,A.dir=T.sub(m)._unit(),this.addCurrentVertex(m,C,-e,-n,A))}else if("butt"===U)this.addCurrentVertex(m,h,0,0,A);else if("square"===U){const t=w?1:-1;this.addCurrentVertex(m,h,t,t,A)}else"round"===U&&(w&&(this.addCurrentVertex(m,M,0,0,A),this.addCurrentVertex(m,M,1,1,A,!0)),T&&(this.addCurrentVertex(m,C,-1,-1,A,!0),this.addCurrentVertex(m,C,0,0,A)));if(!l&&D&&e<u-1){const t=m.dist(T);if(t>2*g){const e=m.add(T.sub(m)._mult(g/t)._round());e.z=m.z,this.updateDistance(m,e),this.addCurrentVertex(e,C,0,0,A),m=e}}}}ensureDataCapacity(t,e,n,i){const o="round"===t?Math.round(n/20)-1:0;super.ensureDataCapacity((6+o)*i,e)}addCurrentVertex(t,e,n,i,o,s=!1){const a=e.x+e.y*n,l=e.y-e.x*n,h=e.y*i-e.x,c=-e.y-e.x*i;let u=0,f=0;if(o.middleVertex){jl.x=a,jl.y=l;const t=o.currentNormal;if(u=Yl(t,jl,o.dir),0===n&&0===i)f=-u;else{const e=Vl;e.x=t.x,e.y=t.y,e._mult(-1),Wl.x=h,Wl.y=c,f=Yl(e,Wl,o.dir)}}this.addHalfVertex(t,a,l,s,!1,n,o,u),this.addHalfVertex(t,h,c,s,!0,-i,o,f),this.prevVertex&&Kl(t,this.prevVertex)||(this.prevVertex=t),this.distance>Gl/2&&0===this.totalDistance&&(this.distance=0,this.updateScaledDistance(),this.addCurrentVertex(t,e,n,i,o,s))}addHalfVertex({x:t,y:e,z:n},i,o,s,a,l,h,c){this.fillData(this.data,t,e,n||0,i,o,s,a,1*this.scaledDistance,c);const u=h.vertexLength++;this.e1>=0&&this.e2>=0&&(this.addElements(this.e1,this.e2,u),h.primitiveLength++),a?this.e2=u:this.e1=u}fillData(t,e,n,i,o,s,a,l,h,c){const{lineWidthFn:u,lineStrokeWidthFn:f,lineStrokeColorFn:g,lineColorFn:A,lineOpacityFn:m,lineDxFn:w,lineDyFn:T,linePatternAnimSpeedFn:M,linePatternGapFn:C}=this._fnTypes;this.fillPosition(t,e,n,i);let P=Bl*o;P=(Math.sign(P)||1)*((Math.floor(Math.abs(P))>>1<<1)+ +a);let I=Bl*s;I=(Math.sign(I)||1)*((Math.floor(Math.abs(I))>>1<<1)+ +l);let O=t.aExtrude.currentIndex;t.aExtrude[O++]=P,t.aExtrude[O++]=I,(this.iconAtlas||this.hasDasharray)&&(t.aExtrude[O++]=Bl*c),t.aExtrude.currentIndex=O,O=t.aLinesofar.currentIndex,t.aLinesofar[O++]=h,t.aLinesofar.currentIndex=O,u&&(O=t.aLineWidth.currentIndex,t.aLineWidth[O++]=Math.round(2*this.feaLineWidth),t.aLineWidth.currentIndex=O),f&&(O=t.aLineStrokeWidth.currentIndex,t.aLineStrokeWidth[O++]=Math.round(2*this.feaLineStrokeWidth),t.aLineStrokeWidth.currentIndex=O),A&&(O=t.aColor.currentIndex,t.aColor[O++]=this.feaColor[0],t.aColor[O++]=this.feaColor[1],t.aColor[O++]=this.feaColor[2],t.aColor[O++]=this.feaColor[3],t.aColor.currentIndex=O),g&&(O=t.aStrokeColor.currentIndex,t.aStrokeColor[O++]=this.feaStrokeColor[0],t.aStrokeColor[O++]=this.feaStrokeColor[1],t.aStrokeColor[O++]=this.feaStrokeColor[2],t.aStrokeColor[O++]=this.feaStrokeColor[3],t.aStrokeColor.currentIndex=O),m&&(O=t.aOpacity.currentIndex,t.aOpacity[O++]=this.feaOpacity,t.aOpacity.currentIndex=O),this.dasharrayFn&&(O=t.aDasharray.currentIndex,t.aDasharray[O++]=this.feaDash[0],t.aDasharray[O++]=this.feaDash[1],t.aDasharray[O++]=this.feaDash[2],t.aDasharray[O++]=this.feaDash[3],t.aDasharray.currentIndex=O),this.dashColorFn&&(O=t.aDashColor.currentIndex,t.aDashColor[O++]=this.feaDashColor[0],t.aDashColor[O++]=this.feaDashColor[1],t.aDashColor[O++]=this.feaDashColor[2],t.aDashColor[O++]=this.feaDashColor[3],t.aDashColor.currentIndex=O),this.iconAtlas&&(O=t.aTexInfo.currentIndex,t.aTexInfo[O++]=this.feaTexInfo[0],t.aTexInfo[O++]=this.feaTexInfo[1],t.aTexInfo[O++]=this.feaTexInfo[2],t.aTexInfo[O++]=this.feaTexInfo[3],t.aTexInfo.currentIndex=O),(w||T)&&(O=t.aLineDxDy.currentIndex,t.aLineDxDy[O++]=this.feaLineDx||0,t.aLineDxDy[O++]=this.feaLineDy||0,t.aLineDxDy.currentIndex=O),(M||C)&&(O=t.aLinePattern.currentIndex,t.aLinePattern[O++]=127*(this.feaPatternAnimSpeed||0),t.aLinePattern[O++]=10*(this.feaLinePatternGap||0),t.aLinePattern.currentIndex=O),this.maxPos=Math.max(this.maxPos,Math.abs(e)+1,Math.abs(n)+1)}addElements(t,e,n){super.addElements(this.offset+t,this.offset+e,this.offset+n)}_filterPolygonEdges(t){const e=this.options.EXTENT,n=this.elements;for(let i=0;i<n.length;i+=3)if(e===1/0||!ql(this.data.aPosition,n[i],n[i+1],3,e)&&!ql(this.data.aPosition,n[i+1],n[i+2],3,e)){let e=t.currentIndex;t[e++]=n[i],t[e++]=n[i+1],t[e++]=n[i+2],t.currentIndex=e}}_filterLine(t){if(t.length<=1)return t;const e=[],n=this.options.EXTENT;let i,o=!0;for(i=0;i<t.length-1;i++){const s=Zl(t[i],t[i+1],n);s&&o||(e.push(t[i]),o=s)}return o||e.push(t[i]),e}updateDistance(t,e){if(this.options.isTube){const n=t.dist(e),i=zn(this.options)*(e.z-t.z);this.distance+=Math.sqrt(n*n+i*i)}else this.distance+=t.dist(e);this.updateScaledDistance()}updateScaledDistance(){this.scaledDistance=this.totalDistance>0?(this.clipStart+(this.clipEnd-this.clipStart)*this.distance/this.totalDistance)*(Gl-1):this.distance}}function Zl(t,e,n){return n!==1/0&&(t.x<0&&e.x<0||t.x>n&&e.x>n||t.y<0&&e.y<0||t.y>n&&e.y>n)}function ql(t,e,n,i,o){if(o===1/0)return!1;const s=Math.floor(.5*t[e*i]),a=Math.floor(.5*t[e*i+1]),l=Math.floor(.5*t[n*i]),h=Math.floor(.5*t[n*i+1]);return s===l&&(s<0||s>o)&&a!==h||a===h&&(a<0||a>o)&&s!==l}function Xl(t){if(!Array.isArray(t))return!1;for(let e=0;e<t.length;e++)if(t[e])return!0;return!1}const Jl=[],Ql=[];function Yl(t,e,n){const i=t.mag(),o=e.mag();Hl(Jl,n.x,n.y),Hl(Ql,e.x,e.y);const s=(a=Jl)[0]*(l=Ql)[0]+a[1]*l[1];var a,l;return-Math.sign(s)*Math.sqrt(o*o-i*i)}function Kl(t,e){return t.equals(e)&&t.z===e.z}var $l="undefined"!=typeof Float32Array?Float32Array:Array;function th(t,e,n,i){return t[0]=e,t[1]=n,t[2]=i,t}var eh=function(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t};!function(){var t=new $l(3);$l!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0)}();const nh=[],ih=[],rh=[],oh=[],sh=[],ah=[],lh=[],hh=[];function ch(t,e,n,i,o,s){th(sh,t[3*e],t[3*e+1],t[3*e+2]),th(ah,t[3*n],t[3*n+1],t[3*n+2]),th(lh,t[3*i],t[3*i+1],t[3*i+2]);const a=eh(ih,lh,ah),l=eh(rh,sh,ah),h=function(t,e,n){var i=e[0],o=e[1],s=e[2],a=n[0],l=n[1],h=n[2];return t[0]=o*h-s*l,t[1]=s*a-i*h,t[2]=i*l-o*a,t}(oh,a,l);!function(t,e){var n=e[0],i=e[1],o=e[2],s=n*n+i*i+o*o;s>0&&(s=1/Math.sqrt(s),t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s)}(hh,h),o[3*e]=o[3*e]||0,o[3*n]=o[3*n]||0,o[3*i]=o[3*i]||0,o[3*e+1]=o[3*e+1]||0,o[3*n+1]=o[3*n+1]||0,o[3*i+1]=o[3*i+1]||0,o[3*e+2]=o[3*e+2]||0,o[3*n+2]=o[3*n+2]||0,o[3*i+2]=o[3*i+2]||0,o[3*e]+=hh[0],o[3*n]+=hh[0],o[3*i]+=hh[0],o[3*e+1]+=hh[1],o[3*n+1]+=hh[1],o[3*i+1]+=hh[1],o[3*e+2]+=hh[2],o[3*n+2]+=hh[2],o[3*i+2]+=hh[2],s[e]+=1,s[n]+=1,s[i]+=1}const uh=Math.pow(2,16)/1,fh=45*Math.PI/100;function dh(t,e,n=2){const i=e&&e.length,o=i?e[0]*n:t.length;let s=gh(t,0,o,n,!0);const a=[];if(!s||s.next===s.prev)return a;let l,h,c;if(i&&(s=function(t,e,n,i){const o=[];for(let n=0,s=e.length;n<s;n++){const a=gh(t,e[n]*i,n<s-1?e[n+1]*i:t.length,i,!1);a===a.next&&(a.steiner=!0),o.push(Mh(a))}o.sort(xh);for(let t=0;t<o.length;t++)n=bh(o[t],n);return n}(t,e,s,n)),t.length>80*n){l=1/0,h=1/0;let e=-1/0,i=-1/0;for(let s=n;s<o;s+=n){const n=t[s],o=t[s+1];n<l&&(l=n),o<h&&(h=o),n>e&&(e=n),o>i&&(i=o)}c=Math.max(e-l,i-h),c=0!==c?32767/c:0}return Ah(s,a,n,l,h,c,0),a}function gh(t,e,n,i,o){let s;if(o===function(t,e,n,i){let o=0;for(let s=e,a=n-i;s<n;s+=i)o+=(t[a]-t[s])*(t[s+1]+t[a+1]),a=s;return o}
/*!
  	 * from @turf/bboxClip
  	 * https://github.com/Turfjs/turf
  	 * MIT LICENSE
  	 */(t,e,n,i)>0)for(let o=e;o<n;o+=i)s=Fh(o/i|0,t[o],t[o+1],s);else for(let o=n-i;o>=e;o-=i)s=Fh(o/i|0,t[o],t[o+1],s);return s&&Oh(s,s.next)&&(Nh(s),s=s.next),s}function ph(t,e){if(!t)return t;e||(e=t);let n,i=t;do{if(n=!1,i.steiner||!Oh(i,i.next)&&0!==Ih(i.prev,i,i.next))i=i.next;else{if(Nh(i),i=e=i.prev,i===i.next)break;n=!0}}while(n||i!==e);return e}function Ah(t,e,n,i,o,s,a){if(!t)return;!a&&s&&function(t,e,n,i){let o=t;do{0===o.z&&(o.z=Th(o.x,o.y,e,n,i)),o.prevZ=o.prev,o.nextZ=o.next,o=o.next}while(o!==t);o.prevZ.nextZ=null,o.prevZ=null,function(t){let e,n=1;do{let i,o=t;t=null;let s=null;for(e=0;o;){e++;let a=o,l=0;for(let t=0;t<n&&(l++,a=a.nextZ,a);t++);let h=n;for(;l>0||h>0&&a;)0!==l&&(0===h||!a||o.z<=a.z)?(i=o,o=o.nextZ,l--):(i=a,a=a.nextZ,h--),s?s.nextZ=i:t=i,i.prevZ=s,s=i;o=a}s.nextZ=null,n*=2}while(e>1)}(o)}(t,i,o,s);let l=t;for(;t.prev!==t.next;){const h=t.prev,c=t.next;if(s?yh(t,i,o,s):mh(t))e.push(h.i,t.i,c.i),Nh(t),t=c.next,l=c.next;else if((t=c)===l){a?1===a?Ah(t=_h(ph(t),e),e,n,i,o,s,2):2===a&&vh(t,e,n,i,o,s):Ah(ph(t),e,n,i,o,s,1);break}}}function mh(t){const e=t.prev,n=t,i=t.next;if(Ih(e,n,i)>=0)return!1;const o=e.x,s=n.x,a=i.x,l=e.y,h=n.y,c=i.y,u=Math.min(o,s,a),f=Math.min(l,h,c),g=Math.max(o,s,a),A=Math.max(l,h,c);let m=i.next;for(;m!==e;){if(m.x>=u&&m.x<=g&&m.y>=f&&m.y<=A&&Sh(o,l,s,h,a,c,m.x,m.y)&&Ih(m.prev,m,m.next)>=0)return!1;m=m.next}return!0}function yh(t,e,n,i){const o=t.prev,s=t,a=t.next;if(Ih(o,s,a)>=0)return!1;const l=o.x,h=s.x,c=a.x,u=o.y,f=s.y,g=a.y,A=Math.min(l,h,c),m=Math.min(u,f,g),w=Math.max(l,h,c),T=Math.max(u,f,g),M=Th(A,m,e,n,i),C=Th(w,T,e,n,i);let P=t.prevZ,I=t.nextZ;for(;P&&P.z>=M&&I&&I.z<=C;){if(P.x>=A&&P.x<=w&&P.y>=m&&P.y<=T&&P!==o&&P!==a&&Sh(l,u,h,f,c,g,P.x,P.y)&&Ih(P.prev,P,P.next)>=0)return!1;if(P=P.prevZ,I.x>=A&&I.x<=w&&I.y>=m&&I.y<=T&&I!==o&&I!==a&&Sh(l,u,h,f,c,g,I.x,I.y)&&Ih(I.prev,I,I.next)>=0)return!1;I=I.nextZ}for(;P&&P.z>=M;){if(P.x>=A&&P.x<=w&&P.y>=m&&P.y<=T&&P!==o&&P!==a&&Sh(l,u,h,f,c,g,P.x,P.y)&&Ih(P.prev,P,P.next)>=0)return!1;P=P.prevZ}for(;I&&I.z<=C;){if(I.x>=A&&I.x<=w&&I.y>=m&&I.y<=T&&I!==o&&I!==a&&Sh(l,u,h,f,c,g,I.x,I.y)&&Ih(I.prev,I,I.next)>=0)return!1;I=I.nextZ}return!0}function _h(t,e){let n=t;do{const i=n.prev,o=n.next.next;!Oh(i,o)&&Eh(i,n,n.next,o)&&Lh(i,o)&&Lh(o,i)&&(e.push(i.i,n.i,o.i),Nh(n),Nh(n.next),n=t=o),n=n.next}while(n!==t);return ph(n)}function vh(t,e,n,i,o,s){let a=t;do{let t=a.next.next;for(;t!==a.prev;){if(a.i!==t.i&&Ph(a,t)){let l=Dh(a,t);return a=ph(a,a.next),l=ph(l,l.next),Ah(a,e,n,i,o,s,0),void Ah(l,e,n,i,o,s,0)}t=t.next}a=a.next}while(a!==t)}function xh(t,e){let n=t.x-e.x;return 0===n&&(n=t.y-e.y,0===n)&&(n=(t.next.y-t.y)/(t.next.x-t.x)-(e.next.y-e.y)/(e.next.x-e.x)),n}function bh(t,e){const n=function(t,e){let n=e;const i=t.x,o=t.y;let s,a=-1/0;if(Oh(t,n))return n;do{if(Oh(t,n.next))return n.next;if(o<=n.y&&o>=n.next.y&&n.next.y!==n.y){const t=n.x+(o-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(t<=i&&t>a&&(a=t,s=n.x<n.next.x?n:n.next,t===i))return s}n=n.next}while(n!==e);if(!s)return null;const l=s,h=s.x,c=s.y;let u=1/0;n=s;do{if(i>=n.x&&n.x>=h&&i!==n.x&&Ch(o<c?i:a,o,h,c,o<c?a:i,o,n.x,n.y)){const e=Math.abs(o-n.y)/(i-n.x);Lh(n,t)&&(e<u||e===u&&(n.x>s.x||n.x===s.x&&wh(s,n)))&&(s=n,u=e)}n=n.next}while(n!==l);return s}(t,e);if(!n)return e;const i=Dh(n,t);return ph(i,i.next),ph(n,n.next)}function wh(t,e){return Ih(t.prev,t,e.prev)<0&&Ih(e.next,t,t.next)<0}function Th(t,e,n,i,o){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-n)*o|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-i)*o|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function Mh(t){let e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function Ch(t,e,n,i,o,s,a,l){return(o-a)*(e-l)>=(t-a)*(s-l)&&(t-a)*(i-l)>=(n-a)*(e-l)&&(n-a)*(s-l)>=(o-a)*(i-l)}function Sh(t,e,n,i,o,s,a,l){return!(t===a&&e===l)&&Ch(t,e,n,i,o,s,a,l)}function Ph(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){let n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&Eh(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&(Lh(t,e)&&Lh(e,t)&&function(t,e){let n=t,i=!1;const o=(t.x+e.x)/2,s=(t.y+e.y)/2;do{n.y>s!=n.next.y>s&&n.next.y!==n.y&&o<(n.next.x-n.x)*(s-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==t);return i}(t,e)&&(Ih(t.prev,t,e.prev)||Ih(t,e.prev,e))||Oh(t,e)&&Ih(t.prev,t,t.next)>0&&Ih(e.prev,e,e.next)>0)}function Ih(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function Oh(t,e){return t.x===e.x&&t.y===e.y}function Eh(t,e,n,i){const o=Rh(Ih(t,e,n)),s=Rh(Ih(t,e,i)),a=Rh(Ih(n,i,t)),l=Rh(Ih(n,i,e));return o!==s&&a!==l||!(0!==o||!kh(t,n,e))||!(0!==s||!kh(t,i,e))||!(0!==a||!kh(n,t,i))||!(0!==l||!kh(n,e,i))}function kh(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function Rh(t){return t>0?1:t<0?-1:0}function Lh(t,e){return Ih(t.prev,t,t.next)<0?Ih(t,e,t.next)>=0&&Ih(t,t.prev,e)>=0:Ih(t,e,t.prev)<0||Ih(t,t.next,e)<0}function Dh(t,e){const n=Hh(t.i,t.x,t.y),i=Hh(e.i,e.x,e.y),o=t.next,s=e.prev;return t.next=e,e.prev=t,n.next=o,o.prev=n,i.next=n,n.prev=i,s.next=i,i.prev=s,i}function Fh(t,e,n,i){const o=Hh(t,e,n);return i?(o.next=i.next,o.prev=i,i.next.prev=o,i.next=o):(o.prev=o,o.next=o),o}function Nh(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function Hh(t,e,n){return{i:t,x:e,y:n,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}const Bh=[],zh=[];function Gh(t,e){var n,i,o,a,l,h,c;for(i=1;i<=8;i*=2){for(n=[],a=!(Uh(o=t[t.length-1],e)&i),l=0;l<t.length;l++){if((c=!(Uh(h=t[l],e)&i))!==a){const t=jh(o,h,i,e);n.push(void 0!==h.x?new s(t[0],t[1]):t)}c&&n.push(h),o=h,a=c}if(!(t=n).length)break}return n}function jh(t,e,n,i){return Bh[0]=void 0===t.x?t[0]:t.x,Bh[1]=void 0===t.y?t[1]:t.y,t=Bh,zh[0]=void 0===e.x?e[0]:e.x,zh[1]=void 0===e.y?e[1]:e.y,e=zh,8&n?[t[0]+(e[0]-t[0])*(i[3]-t[1])/(e[1]-t[1]),i[3]]:4&n?[t[0]+(e[0]-t[0])*(i[1]-t[1])/(e[1]-t[1]),i[1]]:2&n?[i[2],t[1]+(e[1]-t[1])*(i[2]-t[0])/(e[0]-t[0])]:1&n?[i[0],t[1]+(e[1]-t[1])*(i[0]-t[0])/(e[0]-t[0])]:null}function Uh(t,e){Bh[0]=void 0===t.x?t[0]:t.x,Bh[1]=void 0===t.y?t[1]:t.y;var n=0;return(t=Bh)[0]<e[0]?n|=1:t[0]>e[2]&&(n|=2),t[1]<e[1]?n|=4:t[1]>e[3]&&(n|=8),n}const Vh=[0,0,0,0],Wh=-9999999,Zh=[{type:Int16Array,width:3,name:"aPosition"}];class Va extends No{constructor(t,e,n){(e=Mn({},e)).lineJoin="miter",e.lineCap="butt",super(t,e,n),this.options.radialSegments%2==1&&this.options.radialSegments--}getFormat(){const{lineWidthFn:t,lineColorFn:e,lineOpacityFn:n,linePatternAnimSpeedFn:i,linePatternGapFn:o}=this._fnTypes,s=[...this.getPositionFormat(),{type:Int8Array,width:4,name:"aTubeNormal"},{type:this.options.positionType||Uint16Array,width:1,name:"aLinesofar"}];if(this.iconAtlas){s.push({type:Int8Array,width:1,name:"aNormalDistance"});const t=this.getIconAtlasMaxValue();s.push({type:t>255?Uint16Array:Uint8Array,width:4,name:"aTexInfo"})}return t&&s.push({type:Uint16Array,width:1,name:"aLineWidth"}),e&&s.push({type:Uint8Array,width:4,name:"aColor"}),n&&s.push({type:Uint8Array,width:1,name:"aOpacity"}),i&&s.push({type:Int8Array,width:1,name:"aLinePatternAnimSpeed"}),o&&s.push({type:Int8Array,width:1,name:"aLinePatternGap"}),s}ensureDataCapacity(t,e,n,i){return super.ensureDataCapacity(t,e,n,i*(this.options.radialSegments/2))}addHalfVertex(t,e,n,i,o,s,a,l){const{x:h,y:c,z:u}=t,f=1*this.scaledDistance,g=this.options.radialSegments/2,{x:A,y:m,z:w}=a.dir,T=function(t,e,n,i,o,s,a,l){kl(qh,n,i,o),kl(Xh,s,a,0),Ll(Jh,qh,Xh),Rl(Xh,Xh),Rl(Jh,Jh),Qh[e]||(Qh[e]=[]);const h=Qh[e];for(var c=0;c<e;c++){const t=Math.PI*c/e,n=1-Math.abs(t-0)/(Math.PI/2);h[c]=h[c]||[],Yh(Xh,Jh,h[c],1,t,n*(l?-1:1))}return h}(0,g,A,m,w,e,n,o);this.prevVertex&&this.fillTubeElements(o),this.fillData(this.data,h,c,u||0,T,o,f,l)}fillTubeElements(t){const e=this.options.radialSegments/2,n=this.needAltitudeAttribute()?2:3,i=this.data.aPosition.getLength()/n;for(let n=0;n<e;n++){const o=n+i-2*e;let s,a;n===e-1&&t?(s=n+i-2*e+1,a=n+i-2*e-2*e+1):(s=n+i+1,a=n+i+1-2*e),super.addElements(n+i-this.offset,s-this.offset,o-this.offset),super.addElements(o-this.offset,s-this.offset,a-this.offset)}}fillData(t,e,n,i,o,s,a,l){const{lineWidthFn:h,lineColorFn:c,lineOpacityFn:u,linePatternAnimSpeedFn:f,linePatternGapFn:g}=this._fnTypes,A=o.length;for(let s=0;s<A;s++){this.fillPosition(t,e,n,i),Nl(o[s],o[s],Bl);let A=t.aTubeNormal.currentIndex;for(let e=0;e<o[s].length;e++)t.aTubeNormal[A++]=o[s][e];if(t.aTubeNormal.currentIndex=A,A=t.aLinesofar.currentIndex,t.aLinesofar[A++]=a,t.aLinesofar.currentIndex=A,this.iconAtlas&&(A=t.aNormalDistance.currentIndex,t.aNormalDistance[A++]=Bl*l,t.aNormalDistance.currentIndex=A,A=t.aTexInfo.currentIndex,t.aTexInfo[A++]=this.feaTexInfo[0],t.aTexInfo[A++]=this.feaTexInfo[1],t.aTexInfo[A++]=this.feaTexInfo[2],t.aTexInfo[A++]=this.feaTexInfo[3],t.aTexInfo.currentIndex=A),h){const e=Gn(this.options.metric);let n=this.feaLineWidth*e;isNaN(n)&&(n=0),A=t.aLineWidth.currentIndex,t.aLineWidth[A++]=Math.round(n),t.aLineWidth.currentIndex=A}c&&(A=t.aColor.currentIndex,t.aColor[A++]=this.feaColor[0],t.aColor[A++]=this.feaColor[1],t.aColor[A++]=this.feaColor[2],t.aColor[A++]=this.feaColor[3],t.aColor.currentIndex=A),u&&(A=t.aOpacity.currentIndex,t.aOpacity[A++]=this.feaOpacity,t.aOpacity.currentIndex=A),f&&(A=t.aLinePatternAnimSpeed.currentIndex,t.aLinePatternAnimSpeed[A++]=127*(this.feaPatternAnimSpeed||0),t.aLinePatternAnimSpeed.currentIndex=A),g&&(A=t.aLinePatternGap.currentIndex,t.aLinePatternGap[A++]=10*(this.feaLinePatternGap||0),t.aLinePatternGap.currentIndex=A)}this.maxPos=Math.max(this.maxPos,Math.abs(e)+1,Math.abs(n)+1)}createDataPack(t,e){const n=super.createDataPack(t,e);return n&&(n.is2D=!1),n}}const qh=[],Xh=[],Jh=[],Qh={};function Yh(t,e,n,i,o,s){return Fl(n,i*(Math.cos(o)*t[0]+Math.sin(o)*e[0]),i*(Math.cos(o)*t[1]+Math.sin(o)*e[1]),i*(Math.cos(o)*t[2]+Math.sin(o)*e[2]),s),n}const Kh=[],$h=[],tc=[],ec=[],nc=[];class Ka{constructor(t){this.max=t,this.reset()}reset(){return this.data={},this.order=[],this}clear(){this.reset()}add(t,e){return this.has(t)?(this.order.splice(this.order.indexOf(t),1),this.data[t]=e,this.order.push(t)):(this.data[t]=e,this.order.push(t),this.order.length>this.max&&this.getAndRemove(this.order[0])),this}has(t){return t in this.data}keys(){return this.order}getAndRemove(t){if(!this.has(t))return null;const e=this.data[t];return delete this.data[t],this.order.splice(this.order.indexOf(t),1),e}get(t){return this.has(t)?this.data[t]:null}remove(t){return this.has(t)?(delete this.data[t],this.order.splice(this.order.indexOf(t),1),this):this}setMaxSize(t){for(this.max=t;this.order.length>this.max;)this.getAndRemove(this.order[0]);return this}}
/*!
  	 * based on @mapbox/tiny-sdf
  	 * https://github.com/mapbox/tiny-sdf
  	 * @License BSD 2-Clause
  	 */var ic=1e20;function rc(t,e,n,i,o,s,a){this.fontSize=t||24,this.buffer=void 0===e?3:e,this.cutoff=i||.25,this.fontFamily=o||"sans-serif",this.fontWeight=s||"normal",this.fontStyle=a||"normal",this.radius=n||8;var l=this.size=this.fontSize+2*this.buffer;this.canvas="undefined"==typeof document?new OffscreenCanvas(l,l):document.createElement("canvas"),this.canvas.width=this.canvas.height=l,this.ctx=this.canvas.getContext("2d",{willReadFrequently:!0}),this.ctx.font=this.fontStyle+" "+this.fontWeight+" "+this.fontSize+"px "+this.fontFamily,this.ctx.textBaseline="middle",this.ctx.fillStyle="black",this.gridOuter=new Float64Array(l*l),this.gridInner=new Float64Array(l*l),this.f=new Float64Array(l),this.z=new Float64Array(l+1),this.v=new Uint16Array(l),this.middle=Math.round(l/2*(navigator.userAgent.indexOf("Gecko/")>=0?1.2:1))}function oc(t,e,n,i,o,s){for(var a=0;a<e;a++)sc(t,a,e,n,i,o,s);for(var l=0;l<n;l++)sc(t,l*e,1,e,i,o,s)}function sc(t,e,n,i,o,s,a){var l,h,c,u;for(s[0]=0,a[0]=-ic,a[1]=ic,l=0;l<i;l++)o[l]=t[e+l*n];for(l=1,h=0,c=0;l<i;l++){do{c=(o[l]-o[u=s[h]]+l*l-u*u)/(l-u)/2}while(c<=a[h]&&--h>-1);s[++h]=l,a[h]=c,a[h+1]=ic}for(l=0,h=0;l<i;l++){for(;a[h+1]<l;)h++;t[e+l*n]=o[u=s[h]]+(l-u)*(l-u)}}rc.prototype.draw=function(t,e,n){this.ctx.clearRect(0,0,this.size,this.size),this.ctx.textBaseline="top",this.ctx.fillText(t,this.buffer,this.buffer);for(var i=this.ctx.getImageData(0,0,e,n),o=new Uint8ClampedArray(e*n),s=0;s<e*n;s++){var a=i.data[4*s+3]/255;this.gridOuter[s]=1===a?0:0===a?ic:Math.pow(Math.max(0,.5-a),2),this.gridInner[s]=1===a?ic:0===a?0:Math.pow(Math.max(0,a-.5),2)}for(oc(this.gridOuter,e,n,this.f,this.v,this.z),oc(this.gridInner,e,n,this.f,this.v,this.z),s=0;s<e*n;s++){var l=Math.sqrt(this.gridOuter[s])-Math.sqrt(this.gridInner[s]);o[s]=Math.round(255-255*(l/this.radius+this.cutoff))}return o};let ac=0;function lc(t){const e={width:t.bitmap.width,height:t.bitmap.height,data:new Uint8ClampedArray(t.bitmap.data)};return{charCode:t.charCode,bitmap:e,metrics:Mn({},t.metrics)}}var hc=Object.freeze({__proto__:null,calculateSignedArea:P,clipPolygon:Gh,convertGeometry:K,convertRTLText:al,generatePickingIndiceIndex:U,getFeaAltitudeAndHeight:E,getIndexArrayType:X,getPosArrayType:J,getUnsignedArrayType:Q,packPosition:Kn,unpackPosition:function(t,e,n,i){const o=(Math.sign(e)||1)*(Math.abs(e)%$n),s=(Math.sign(n)||1)*(Math.abs(n)%$n),a=Math.floor(Math.abs(e)/$n),l=Math.floor(Math.abs(n)/$n);return t[0]=o,t[1]=s,t[2]=Math.sign(i+1e-5)*(2*a+l)*ei+i,t}});const cc={},uc={},fc=[];var dc=Object.freeze({__proto__:null,loadSymbolFnTypes:function t(e,n){if(!e)return null;var i=!1;if(Array.isArray(e)){var o,s=[];for(let a=0;a<e.length;a++)(o=t(e[a],n))?(s.push(o),i=!0):s.push(e[a]);return i?s:e}var a={__fn_types_loaded:!0};const l=[];for(const t in e)Nn(e,t)&&l.push(t);const h=function(t){Object.defineProperty(a,t,{get:function(){return this["__fn_"+t]||(this["__fn_"+t]=$t(this["_"+t])),this["__fn_"+t].apply(this,n())},set:function(e){this["_"+t]=e},configurable:!0,enumerable:!0})},c={},u=function(t,e){Object.defineProperty(a,t,{get:function(){this["__fn_"+t]||(this["__fn_"+t]=ta(this["_"+t],e));const i=n()[0];c.zoom=i;try{return this["__fn_"+t].evaluateWithoutErrorHandling(c,cc,uc,null,fc)}catch(t){return null}},set:function(e){this["_"+t]=e},configurable:!0,enumerable:!0})};for(let t=0,n=l.length;t<n;t++){const n=l[t];if(Gt(e[n]))i=!0,a["_"+n]=e[n],h(n);else if(ea(e[n])){i=!0;const t=sa(n);a["_"+n]=e[n],u(n,t)}else a[n]=e[n]}return i?a:e}});const gc={polygonPatternFile:1,markerFile:1,markerPlacement:1,markerSpacing:1,textName:1,textFaceName:1,textPlacement:1,textSpacing:1,lineJoin:1,lineCap:1,linePatternFile:1},pc={visible:1,textHorizontalAlignment:1,textVerticalAlignment:1,textWrapWidth:1,markerHorizontalAlignment:1,markerVerticalAlignment:1},Ac={lineDasharray:1,topPolygonFill:1,bottomPolygonFill:1};Object.assign(pc,gc),Object.assign(Ac,gc),t.ArrayPool=ss,t.CirclePack=class extends gs{getFormat(){return Zh}placeVector(t,e){const n=this._getAnchors(t,e);if(0===n.length)return;const i=this.data,o=this.getAltitude(t.feature.properties);let s=i.aPosition.getLength()/Zh[0].width;for(let t=0;t<n.length;t++){const e=n[t];i.aPosition.push(2*e.x+0,2*e.y+0,o),i.aPosition.push(2*e.x+1,2*e.y+0,o),i.aPosition.push(2*e.x+1,2*e.y+1,o),i.aPosition.push(2*e.x+0,2*e.y+1,o),this.addElements(s,s+1,s+2),this.addElements(s,s+2,s+3),s+=4;const a=Math.max(Math.abs(2*e.x+1),Math.abs(2*e.y+1));a>this.maxPos&&(this.maxPos=a)}}_getAnchors(t,e){const{feature:n,symbol:i}=t,o=this._getPlacement(t,i),s=n.properties,{markerSpacingFn:a}=this._fnTypes,l=((a?a(null,s):i.markerSpacing)||250)*e;return Tl(t,null,null,e,this.options.EXTENT,o,l)}_getPlacement(t,e){return this._fnTypes.markerPlacementFn?this._fnTypes.markerPlacementFn(this.options.zoom,t.feature.properties):e.markerPlacement}},t.DEFAULT_TEX_WIDTH=23.25,t.FilterUtil=aa,t.FuncTypeUtil=dc,t.GlyphRequestor=class{constructor(t,e=15,n,i){this.entries={},this._cachedFont={},this._cache=new Ka(2048,(function(){})),this._framer=t,this._limit=e,this._isCompactChars=n,this._sdfURL=i}_isValidSDFURL(t){return t&&(t.indexOf("{stack}")>=0||t.indexOf("{fontstack}")>=0)&&t.indexOf("{range}")>0}getGlyphs(t,e){if(!t||!Object.keys(t).length)return void e(null,{glyphs:null});if(this._isValidSDFURL(this._sdfURL))return void this._requestRemoteSDF(t,e);const n=this.entries,i=t.options;let o=!0;i&&(o=!1!==i.isCharsCompact),o=o||this._isCompactChars;const s=(i,s,l)=>{let h=0,c=0;for(const e in t)if("options"!==e){n[e]=n[e]||{},s[e]=s[e]||{};for(const u in t[e]){if(c++,c<=i)continue;const t=o&&!Ua(+u),f=e+":"+u+":"+t;let g;if(this._cache.has(f)?g=this._cache.get(f):(g=this._tinySDF(n[e],e,u,t),this._cache.add(f,g),h++),g=lc(g),s[e][u]=g,l.push(g.bitmap.data.buffer),this._framer&&h>this._limit)return void this._framer(a(c,s,l))}}e(null,{glyphs:s,buffers:l})};function a(t,e,n){return()=>{s(t,e,n)}}s(0,{},[])}_requestRemoteSDF(t,e){const n=[];for(const e in t){if("options"===e)continue;const i=t[e];if(Array.isArray(i))for(const t of i)n.push(this._requestGlyph(e,t));else for(const t in i)n.push(this._requestGlyph(e,t))}Promise.all(n).then((t=>{e(null,t)}))}_requestGlyph(t,e){const n=this._sdfURL;if(!n)return Promise.resolve(null);let i=this.entries[t];i||(i=this.entries[t]={glyphs:{},requests:{},ranges:{}});let o=i.glyphs[e];if(o)return Promise.resolve({font:t,charCode:e,glyph:o});const s=256*Math.floor(e/256);if(s>65535)return Promise.reject(new Error("glyphs > 65535 not supported"));const a=`${s}-${s+255}`;if(i.ranges[a])return i.ranges[a].then((n=>{if(n&&n.glyphs&&n.glyphs[e]){const o=n.glyphs[e];return i.glyphs[e]=o,{font:t,charCode:e,glyph:o}}return{font:t,charCode:e,glyph:null}}));const l=n.replace("{stack}",encodeURIComponent(t)).replace("{fontstack}",encodeURIComponent(t)).replace("{range}",encodeURIComponent(a)),h=fetch(l).then((t=>{if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return t.json()})).then((t=>{if(t&&t.glyphs)for(const e in t.glyphs)i.glyphs[e]=t.glyphs[e];return t})).catch((t=>(console.error(`Failed to load SDF glyph from ${l}:`,t),null)));return i.ranges[a]=h,h.then((n=>{if(n&&n.glyphs&&n.glyphs[e]){return{font:t,charCode:e,glyph:n.glyphs[e]}}return{font:t,charCode:e,glyph:null}}))}_tinySDF(t,e,n,i){const o=e;let s=t.tinySDF;const a=i?-1:2;if(!s){let e="400";/bolder/i.test(o)?e="1000":/bold/i.test(o)?e="900":/medium/i.test(o)?e="500":/light/i.test(o)&&(e="200"),s=t.tinySDF=new rc(24,2,8,.25,o,e)}const l=String.fromCodePoint(n),h=s.ctx.measureText(l),c=Math.round(h.width),u=s.draw(l,c+4,28);if(ac<4){const t="undefined"!=typeof document&&document.getElementById("sdf-debug-"+ac++);t&&(t.width=c+4,t.height=s.canvas.height,t.getContext("2d").drawImage(s.canvas,0,0))}return{charCode:n,bitmap:{width:c+4,height:28,data:u},metrics:{width:c,height:24,left:1,top:-2,advance:c+2+a}}}},t.INVALID_TEX_COORD=Wh,t.LRUCache=Ka,t.LineExtrusionPack=class extends No{constructor(t,e,n){super(t,e,n),this._hasALineHeight=n.altitudeProperty}getFormat(){const{lineColorFn:t,lineWidthFn:e}=this._fnTypes,n=[{type:Math.max(Math.abs(this.maxPosZ),Math.abs(this.minPosZ))>=Math.pow(2,15)?Float32Array:Int16Array,width:3,name:"aPosition"},{type:Uint16Array,width:1,name:"aLinesofar"},{type:Uint8Array,width:1,name:"aUp"},{type:Int16Array,width:3,name:"aExtrudedPosition"},{type:Int8Array,width:2,name:"aExtrude"}];return t&&n.push({type:Uint8Array,width:4,name:"aColor"}),e&&n.push({type:Uint8Array,width:1,name:"aLineWidth"}),this._hasALineHeight&&n.push({type:Float32Array,width:1,name:"aLineHeight"}),n}placeVector(t){const e=t.feature;if(this._hasALineHeight){const{altitudeScale:t,altitudeProperty:n,defaultAltitude:i,heightProperty:o,defaultHeight:s,minHeightProperty:a}=this.options,{altitude:l,height:h}=E(e,t,n,i,o,s,a);this.feaAltitude=l,this.feaMinHeight=(l-h)/l*32767,l>this.maxAltitude&&(this.maxAltitude=l)}return super.placeVector(t)}needAltitudeAttribute(){return!1}_addLine(t,e,n,i,o,s){const a=this.data.aPosition.getLength()/3;super._addLine(t,e,n,i,o,s);const l=this.data.aPosition.getLength()/3,h=this.data.aPosition.getLength()/3-this.offset;if(!(3===e.type)&&h>0&&!1!==this.options.side){const t=!1!==this.options.top?1:0,e=t+4;let n=this.data.aPosition.getLength()/3;for(const t in this.data){const e=this.data[t],i=e.getLength()/n;let o=e.currentIndex;for(let t=0;t<i;t++)e[o++]=e[a*i+3*i+t];e.currentIndex=o}n=this.data.aPosition.getLength()/3;for(const t in this.data){const i=this.data[t],o=i.getLength()/n;let s=i.currentIndex;for(let t=0;t<o;t++)i[s++]=i[a*o+o*e+t];i.currentIndex=s}n=this.data.aPosition.getLength()/3;for(const t in this.data){const i=this.data[t],o=i.getLength()/n;let s=i.currentIndex;for(let t=0;t<o;t++)i[s++]=i[a*o+o*(e+3)+t];i.currentIndex=s}super.addElements(t+1,h+1,h),super.addElements(h,h+1,h+2);const i=this.data.aPosition.getLength()/3-this.offset;n=this.data.aPosition.getLength()/3;for(const t in this.data){const e=this.data[t],i=e.getLength()/n;let o=e.currentIndex;for(let t=0;t<i;t++)e[o++]=e[l*i-i+t];e.currentIndex=o}n=this.data.aPosition.getLength()/3;for(const t in this.data){const i=this.data[t],o=i.getLength()/n;let s=i.currentIndex;for(let t=0;t<o;t++)i[s++]=i[l*o-e*o-o+t];i.currentIndex=s}n=this.data.aPosition.getLength()/3;for(const t in this.data){const i=this.data[t],o=i.getLength()/n;let s=i.currentIndex;for(let t=0;t<o;t++)i[s++]=i[l*o-e*o-3*o+t];i.currentIndex=s}super.addElements(i,h-3,i+1),super.addElements(h-3,i+2,i+1)}}fillData(t,e,n,i,o,s,a,l,h){const c=!1!==this.options.top,u=!1!==this.options.side,f=this.feaLineWidth||this.symbol.lineWidth/2*(this.options.EXTENT/this.options.tileSize),g=Bl*o,A=Bl*s,m=f*o+e,w=f*s+n;this._fillTop(t,e,n,o,s,a,l,h,m,w,g,A),u&&(c&&this._fillTop(t,e,n,o,s,a,l,h,m,w,g,A),this._fillTop(t,e,n,o,s,a,l,h,m,w,g,A),this._fillBottom(t,e,n,o,s,a,l,h,m,w,g,A),this._fillBottom(t,e,n,o,s,a,l,h,m,w,g,A)),this.maxPos=Math.max(this.maxPos,Math.abs(e),Math.abs(n))}_fillTop(t,e,n,i,o,s,a,l,h,c,u,f){const{lineColorFn:g,lineWidthFn:A}=this._fnTypes;let m=t.aPosition.currentIndex;t.aPosition[m++]=e,t.aPosition[m++]=n,t.aPosition[m++]=32767,t.aPosition.currentIndex=m,m=t.aLinesofar.currentIndex,t.aLinesofar[m++]=l,t.aLinesofar.currentIndex=m,m=t.aUp.currentIndex,t.aUp[m++]=+a,t.aUp.currentIndex=m,m=t.aExtrudedPosition.currentIndex,t.aExtrudedPosition[m++]=h,t.aExtrudedPosition[m++]=c,t.aExtrudedPosition[m++]=1,t.aExtrudedPosition.currentIndex=m,m=t.aExtrude.currentIndex,t.aExtrude[m++]=u,t.aExtrude[m++]=f,t.aExtrude.push(u,f),g&&(m=t.aColor.currentIndex,t.aColor[m++]=this.feaColor[0],t.aColor[m++]=this.feaColor[1],t.aColor[m++]=this.feaColor[2],t.aColor[m++]=this.feaColor[3],t.aColor.currentIndex=m),A&&(m=t.aLineWidth.currentIndex,t.aLineWidth[m++]=Math.round(2*this.feaLineWidth),t.aLineWidth.currentIndex=m),this._hasALineHeight&&(m=t.aLineHeight.currentIndex,t.aLineHeight[m++]=this.feaAltitude,t.aLineHeight.currentIndex=m)}_fillBottom(t,e,n,i,o,s,a,l,h,c,u,f){const{lineColorFn:g,lineWidthFn:A}=this._fnTypes;let m=t.aPosition.currentIndex;t.aPosition[m++]=e,t.aPosition[m++]=n,t.aPosition[m++]=this.feaMinHeight||0,t.aPosition.currentIndex=m,m=t.aLinesofar.currentIndex,t.aLinesofar[m++]=l,t.aLinesofar.currentIndex=m,m=t.aUp.currentIndex,t.aUp[m++]=+a,t.aUp.currentIndex=m,m=t.aExtrudedPosition.currentIndex,t.aExtrudedPosition[m++]=h,t.aExtrudedPosition[m++]=c,t.aExtrudedPosition[m++]=1,t.aExtrudedPosition.currentIndex=m,m=t.aExtrude.currentIndex,t.aExtrude[m++]=u,t.aExtrude[m++]=f,t.aExtrude.push(u,f),g&&(m=t.aColor.currentIndex,t.aColor[m++]=this.feaColor[0],t.aColor[m++]=this.feaColor[1],t.aColor[m++]=this.feaColor[2],t.aColor[m++]=this.feaColor[3],t.aColor.currentIndex=m),A&&(m=t.aLineWidth.currentIndex,t.aLineWidth[m++]=Math.round(2*this.feaLineWidth),t.aLineWidth.currentIndex=m),this._hasALineHeight&&(m=t.aLineHeight.currentIndex,t.aLineHeight[m++]=this.feaAltitude,t.aLineHeight.currentIndex=m)}addElements(t,e,n){const i=!1!==this.options.top,o=!1!==this.options.side,s=(i?1:0)+(o?4:0);if(t*=s,e*=s,this.data.aUp[this.offset+(n*=s)+4]){if(i&&super.addElements(e,t,n),o){const t=i?1:0;super.addElements(e+t,n+t,n+t+2),super.addElements(e+t+1,n+t+1+2,e+t+1+2)}}else if(i&&super.addElements(t,n,e),o){const e=i?1:0;super.addElements(t+e,t+e+2,n+e),super.addElements(t+e+1+2,n+e+1+2,n+e+1)}}createDataPack(t,e){this.maxAltitude=0;const n=super.createDataPack(t,e);if(!n)return n;const{data:i,indices:o}=n;this.getFormat().reduce(((t,e)=>(t[e.name]={size:e.width},t)),{}).aPickingId={size:1};const{aExtrudedPosition:s,aPosition:a,aLinesofar:l,aUp:h,aExtrude:c,aColor:u,aLineHeight:f,aLineWidth:g}=i,A={},m=function(t,e,n){const i=[];i.setLength&&i.setLength(t.length);const o=nh;o.length<t.length/3&&(o.length=t.length/3),o.fill(0,0,t.length/3);const s=void 0===e.length?e:e.length;for(let n=0;n<s/3;n++)void 0===e.length?ch(t,3*n,3*n+1,3*n+2,i,o):ch(t,e[3*n],e[3*n+1],e[3*n+2],i,o);for(let t=0;t<i.length;t+=3){const e=o[t/3];0!==e?(i[t]/=e,i[t+1]/=e,i[t+2]/=e):(i[t]=0,i[t+1]=0,i[t+2]=0)}return i}(s,o);let w,T=!0;for(let t=0;t<m.length;t++)m[t]=-m[t],m[t]%1!=0&&(T=!1);if(!1!==this.options.top&&this.symbol.material&&function(t){for(const e in t)if(e.indexOf("Texture")>=0&&t[e])return!0;return!1}(this.symbol.material)&&(w=function(t,e,n){const i=[];for(let o=0;o<t.length;o+=3){const t=e[o/3];i.push(t/256,n[o/3]?1:0)}return i}(s,l,h)),A.aPosition=a,w&&(A.aTexCoord0=new Float32Array(w)),A.aNormal=T?new Int8Array(m):new Float32Array(m),A.aPickingId=i.aPickingId,A.aExtrude=c,u&&(A.aColor=u),g&&(A.aLineWidth=g),f){const t=J(this.maxAltitude);A.aLineHeight=new t(f)}const M=[];for(const t in A)M.push(A[t].buffer);return n.data=A,n.buffers=M,n}},t.LinePack=No,t.NativeLinePack=class extends gs{getFormat(){return[...this.getPositionFormat()]}placeVector(t){const e=t.feature,n=3===e.type,i=e.geometry,o=this.elements;n&&(this.elements=this._arrayPool.get());const s=this.needAltitudeAttribute()?2:3;for(let t=0;t<i.length;t++)this.offset=this.data.aPosition.getLength()/s,this._addLine(i[t],e),n&&(this._filterPolygonEdges(o),this.elements=this._arrayPool.get());n&&(this.elements=o)}_addLine(t,e){const n=3===e.type;let i=t.length;for(;i>=2&&t[i-1].equals(t[i-2]);)i--;let o,s,a,l=0;for(;l<i-1&&t[l].equals(t[l+1]);)l++;if(!(i<(n?3:2))){this.distance=0,this.vertexLength=0,this.primitiveLength=0,this.e1=this.e2=this.e3=-1,n&&(o=t[i-2]);for(let e=l;e<i;e++)a=n&&e===i-1?t[l+1]:t[e+1],a&&t[e].equals(a)||(o&&(s=o),o=t[e],s&&(this.distance+=o.dist(s)),this.addCurrentVertex(o,this.distance))}}addCurrentVertex(t,e){const n=this.vertexLength++;this.addLineVertex(this.data,t,e),n>=1&&this.addElements(n-1,n),e>uh&&(this.distance=0,this.addCurrentVertex(t,this.distance))}addLineVertex(t,e){const n=this.needAltitudeAttribute();this.fillPosition(t,e.x,e.y,e.z||0),this.maxPos=n?Math.max(this.maxPos,Math.abs(e.x),Math.abs(e.y)):Math.max(this.maxPos,Math.abs(e.x),Math.abs(e.y),Math.abs(e.z||0))}addElements(t,e){this.maxIndex=Math.max(this.maxIndex,this.offset+t,this.offset+e);let n=this.elements.currentIndex;this.elements[n++]=this.offset+t,this.elements[n++]=this.offset+e,this.elements.currentIndex=n}_filterPolygonEdges(t){const e=this.options.EXTENT,n=this.elements,i=n.getLength();for(let o=0;o<i;o+=2)if(!I(this.data.aPosition,n[o],n[o+1],3,e)){let e=t.currentIndex;t[e++]=n[o],t[e++]=n[o+1],t.currentIndex=e}}},t.NativePointPack=class extends gs{getFormat(){const{markerFillFn:t}=this._fnTypes;let e;return e="line"===this.symbol.markerRotationAlignment?[...this.getPositionFormat(),{type:Float32Array,width:1,name:"aXYRotation"},{type:Float32Array,width:1,name:"aZRotation"}]:[...this.getPositionFormat()],t&&e.push({type:Uint8Array,width:4,name:"aColor"}),e}placeVector(t){const e=t.feature.properties,{markerFillFn:n}=this._fnTypes;let i;n&&(i=n(this.options.zoom,e)||[255,255,255,255],Gt(i)?(this.dynamicAttrs.aColor=1,i=[0,0,0,0]):i=Wn([],i));const o=this.data,s="line"===this.symbol.markerRotationAlignment,a=this._getAnchors(t,this.symbol.markerSpacing||250,this.symbol.markerPlacement||"point",s),l=this.needAltitudeAttribute();for(let t=0;t<a.length;t++){const e=a[t];if(this.fillPosition(this.data,e.x,e.y,e.z),s){let t=o.aXYRotation.currentIndex;o.aXYRotation[t++]=e.xyRotation||0,o.aXYRotation.currentIndex=t,t=o.aZRotation.currentIndex,o.aZRotation[t++]=e.zRotation||0,o.aZRotation.currentIndex=t}if(i){let t=o.aColor.currentIndex;o.aColor[t++]=i[0],o.aColor[t++]=i[1],o.aColor[t++]=i[2],o.aColor[t++]=i[3],o.aColor.currentIndex=t}let n;n=l?Math.max(Math.abs(e.x),Math.abs(e.y)):Math.max(Math.abs(e.x),Math.abs(e.y),Math.abs(e.z||0)),n>this.maxPos&&(this.maxPos=n)}}_getAnchors(t,e,n,i){const o=t.feature,s=this.options.EXTENT;if("line"===n){const t=[];let n=o.geometry;s&&(n=cl(o.geometry,0,0,s,s));for(let i=0;i<n.length;i++){const o=fl(n[i],e,fh,null,0,24,1,1,s||1/0);t.push.apply(t,o)}return t}return Ml(o,n,s,i,this.options.altitudeToTileScale)}hasElements(){return!1}},t.PackUtil=hc,t.PointPack=Ao,t.PolygonPack=class extends gs{constructor(...t){super(...t),this.lineElements=[]}createStyledVector(t,e,n,i,o){const s=new dt(t,e,n,i),a=s.getPolygonResource();return!this.options.atlas&&a&&(o[a]=[0,0]),s}getFormat(){const t=[...this.getPositionFormat()],{polygonFillFn:e,polygonOpacityFn:n,uvScaleFn:i,uvOffsetFn:o,polygonPatternUVFn:s}=this._fnTypes;if(this.iconAtlas){const e=this.getIconAtlasMaxValue();t.push({type:e>255?Uint16Array:Uint8Array,width:4,name:"aTexInfo"})}return e&&t.push({type:Uint8Array,width:4,name:"aColor"}),n&&t.push({type:Uint8Array,width:1,name:"aOpacity"}),i&&t.push({type:Uint16Array,width:2,name:"aUVScale"}),o&&t.push({type:Uint8Array,width:2,name:"aUVOffset"}),s&&t.push({type:Float32Array,width:2,name:"aTexCoord"}),t}placeVector(t,e){const n=t.feature;this._addPolygon(n.geometry,n,e)}_addPolygon(t,e){let n,i,o,s;const{polygonFillFn:a,polygonOpacityFn:l,uvScaleFn:h,uvOffsetFn:c,uvOffsetInMeterFn:u,polygonPatternUVFn:f}=this._fnTypes,g=e.properties;a&&(n=a(this.options.zoom,g)||Fl([],255,255,255,255),Gt(n)?(this.dynamicAttrs.aColor=1,n=Vh):n=Wn([],n)),l&&(i=l(this.options.zoom,g),Gt(i)?(this.dynamicAttrs.aOpacity=1,i=255):(Pn(i)&&(i=1),i*=255)),h&&(o=h(this.options.zoom,g),Gt(o)?(o=[255,255],this.dynamicAttrs.aUVScale=1):(Pn(o)&&(o=[1,1]),o=[255*o[0],255*o[1]])),c&&(u&&u(null,g)?s=[0,0]:(s=c(this.options.zoom,g),Gt(s)?(s=[0,0],this.dynamicAttrs.aUVOffset=1):(Pn(s)&&(s=[0,0]),s=[255*s[0],255*s[1]])));const A=!!this.iconAtlas,m=ml(t,500),w=[0,0],T=[0,0];if(A){const{polygonPatternFileFn:t}=this._fnTypes,e=t?t(null,g):this.symbol.polygonPatternFile;if(this.iconAtlas.glyphMap[e]){const t=this.iconAtlas.positions[e],n=!W(t.displaySize[0])||!W(t.displaySize[1]);w[0]=t.tl[0]+(n?1:0),w[1]=t.tl[1]+(n?1:0),T[0]=t.displaySize[0]-1-(n?2:0),T[1]=t.displaySize[1]-1-(n?2:0)}}let M,C=0;f&&(M=f(this.options.zoom,g));const P=this.needAltitudeAttribute()?2:3,I=[-1,-1,e.extent+1,e.extent+1],O=this._flattened=this._flattened||this._arrayPool.getProxy(),E=this._holeIndices=this._holeIndices||this._arrayPool.getProxy();for(let t=0;t<m.length;t++){const e=m[t],a=this.data.aPosition.getLength()/P;O.setLength(0),E.setLength(0);for(let t=0;t<e.length;t++){let a=e[t];if(this.options.EXTENT!==1/0&&0===this.maxPosZ&&0===this.minPosZ&&(a=Gh(a,I)),0===a.length)continue;0!==t&&E.push(O.length/3),this.ensureDataCapacity(a.length);const l=this.data;for(let t=0;t<a.length;t++){const e=a[t].x,h=a[t].y,c=a[t].z||0;if(this.fillPosition(this.data,e,h,c),A){let t=l.aTexInfo.currentIndex;l.aTexInfo[t++]=w[0],l.aTexInfo[t++]=w[1],l.aTexInfo[t++]=T[0],l.aTexInfo[t++]=T[1],l.aTexInfo.currentIndex=t}if(void 0!==n){let t=l.aColor.currentIndex;l.aColor[t++]=n[0],l.aColor[t++]=n[1],l.aColor[t++]=n[2],l.aColor[t++]=n[3],l.aColor.currentIndex=t}if(void 0!==i){let t=l.aOpacity.currentIndex;l.aOpacity[t++]=i,l.aOpacity.currentIndex=t}if(void 0!==o){let t=l.aUVScale.currentIndex;l.aUVScale[t++]=o[0],l.aUVScale[t++]=o[1],l.aUVScale.currentIndex=t}if(void 0!==s){let t=l.aUVOffset.currentIndex;l.aUVOffset[t++]=s[0],l.aUVOffset[t++]=s[1],l.aUVOffset.currentIndex=t}if(f){let t=l.aTexCoord.currentIndex;if(M){const e=Pn(M[2*C])?M[0]:M[2*C],n=Pn(M[2*C]+1)?M[1]:M[2*C+1];l.aTexCoord[t++]=e,l.aTexCoord[t++]=n}else l.aTexCoord[t++]=Wh,l.aTexCoord[t++]=Wh;l.aTexCoord.currentIndex=t,C++}const u=Math.abs(e),g=Math.abs(h);u>this.maxPos&&(this.maxPos=u),g>this.maxPos&&(this.maxPos=g),O.push(e,h,c)}}let l=dh(O,E,3);if(O.length&&!l.length){const t=[];for(let e=0;e<O.length;e+=3)t[e]=O[e],t[e+1]=O[e+2],t[e+2]=O[e+1];if(l=dh(t,E,3),!l.length){for(let e=0;e<O.length;e+=3)t[e]=O[e+1],t[e+1]=O[e+2],t[e+2]=O[e];l=dh(t,E,3)}}for(let t=0;t<l.length;t+=3)this.addElements(a+l[t],a+l[t+1],a+l[t+2])}}ensureDataCapacity(t){super.ensureDataCapacity(1,t)}},t.RoundTubePack=Va,t.SYMBOLS_NEED_REBUILD_IN_VECTOR=Ac,t.SYMBOLS_NEED_REBUILD_IN_VT=pc,t.SquareTubePack=class extends Va{addHalfVertex(t,e,n,i,o,s,a,l){const{x:h,y:c,z:u}=t,f=1*this.scaledDistance,{x:g,y:A,z:m}=a.dir,w=function(t,e,n,i,o,s,a,l){kl($h,n,i,o),kl(tc,s,a,0),Ll(ec,$h,tc),Rl(tc,tc),Rl(ec,ec),Hl(Kh,t,e);const h=function(t){return Math.hypot(t[0],t[1])}(Kh)/t,c=Math.atan(e/t);let u=Math.PI/2+(Math.PI/2-c);return nc[0]||(nc[0]=[]),Yh(tc,ec,nc[0],h,u,l?1:-1),u+=2*c,nc[1]||(nc[1]=[]),Yh(tc,ec,nc[1],h,u,l?1:-1),nc}(this.feaLineWidth,this.feaLineHeight,g,A,m,e,n,o);this.prevVertex&&this.fillTubeElements(o),this.fillData(this.data,h,c,u||0,w,o,f,l)}ensureDataCapacity(t,e,n,i){return super.ensureDataCapacity(t,e,n,2*i)}},t.StyleUtil=Yn,t.StyledPoint=Js,t.StyledVector=dt,t.TEXT_MAX_ANGLE=80,t.TextUtil=Ba,t.VectorPack=gs,e().ispace_vt_packers=t}function ZR(){return function(){if("undefined"!=typeof globalThis)return globalThis;if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("unable to locate global object")}().ispace_vt_packers}WR({});let qR=0;function XR(){return qR++}const JR="function"==typeof Object.assign;function QR(t,...e){if(JR)return Object.assign(t,...e),t;for(let n=0;n<e.length;n++){const i=e[n];for(const e in i)t[e]=i[e]}return t}function YR(t){return!eL(t)&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}function KR(t){return"number"==typeof t&&!isNaN(t)}function $R(t){return!eL(t)&&("function"==typeof t||null!==t.constructor&&t.constructor===Function)}function tL(t){return!Array.isArray(t)&&"object"==typeof t&&!!t}function eL(t){return null==t}function nL(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];if(n)for(let e=0,i=n.length;e<i;e++)t.push(n[e])}return t.length}function iL(t){return mk(t)&&t.property}function rL(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function oL(t,e){return e.altitudeToPoint(100,t)/100/100}function sL(t,e,n){for(let i=0;i<t.length;i++){const o=t[i],s=QR({},o),{renderPlugin:a}=o,l=QR({},a);l.sceneConfig&&!Object.keys(l.sceneConfig).length&&delete l.sceneConfig;let h=-1;for(let t=n.length-1;t>=0;t--)if(PC(l,n[t])){h=t;break}h<0&&(h=n.length,n.push(l)),s.renderPlugin=h,e.push(s)}}const aL="function"==typeof fetch&&"function"==typeof AbortController,lL={jsonp:function(t,e){const n="_ispace_jsonp_"+XR();t.match(/\?/)?t+="&callback="+n:t+="?callback="+n;let i=document.createElement("script");return i.type="text/javascript",i.src=t,window[n]=function(t){e(null,t),document.getElementsByTagName("head")[0].removeChild(i),i=null,delete window[n]},document.getElementsByTagName("head")[0].appendChild(i),this},get:function(t,e,n){if($R(e)){const t=n;n=e,e=t}(e=e||{}).method&&(e.method=e.method.toUpperCase());const i="POST"===e.method;if(aL){const i=new AbortController,o=e;o.signal=i.signal,o.referrerPolicy=o.referrerPolicy||"origin",o.method=o.method||"GET";const s=new Request(t,o);return e.returnJSON&&s.headers.set("Accept","application/json"),fetch(s).then((i=>{const o=this._parseResponse(i,e.returnJSON,e.responseType);o.message?(o.url=t,n(o)):o.then((t=>{n(null,"arraybuffer"===e.responseType?{data:t,cacheControl:i.headers.get("Cache-Control"),expires:i.headers.get("Expires"),contentType:i.headers.get("Content-Type")}:t)})).catch((e=>{e.code&&e.code===DOMException.ABORT_ERR||(console.error("Fetch error:",t,e),n(e))}))})).catch((e=>{e.code&&e.code===DOMException.ABORT_ERR||(console.error("Fetch error:",t,e),n(e))})),i}{const o=lL._getClient(n);if(o.open(e.method||"GET",t,!0),e){for(const t in e.headers)o.setRequestHeader(t,e.headers[t]);o.withCredentials="include"===e.credentials,e.responseType&&(o.responseType=e.responseType)}return o.send(i?e.body:null),o}},_parseResponse:(t,e,n)=>200!==t.status?{status:t.status,statusText:t.statusText,message:`incorrect http request with status code(${t.status}): ${t.statusText}`}:"arraybuffer"===n?t.arrayBuffer():e?t.json():t.text(),_wrapCallback:function(t,e){return function(){4===t.readyState&&(200===t.status?"arraybuffer"===t.responseType?0===t.response.byteLength?e({status:200,statusText:t.statusText,message:"http status 200 returned without content."}):e(null,{data:t.response,cacheControl:t.getResponseHeader("Cache-Control"),expires:t.getResponseHeader("Expires"),contentType:t.getResponseHeader("Content-Type")}):e(null,t.responseText):e({status:t.status,statusText:t.statusText,message:`incorrect http request with status code(${t.status}): ${t.statusText}`}))}},_getClient:function(t){let e;try{e=new XMLHttpRequest}catch(t){try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(t){try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(t){}}}return e.onreadystatechange=lL._wrapCallback(e,t),e},getArrayBuffer(t,e,n){if($R(e)){const t=n;n=e,e=t}return e||(e={}),e.responseType="arraybuffer",lL.get(t,e,n)},getJSON:function(t,e,n){if($R(e)){const t=n;n=e,e=t}const i=function(t,e){const i="string"==typeof e?JSON.parse(e):e||null;n(t,i)};return e&&e.jsonp?lL.jsonp(t,i):((e=e||{}).returnJSON=!0,lL.get(t,e,i))}};let hL=class ee{constructor(t){this.max=t,this.reset()}reset(){return this.data={},this.order=[],this}clear(){this.reset()}add(t,e){return this.has(t)?(this.order.splice(this.order.indexOf(t),1),this.data[t]=e,this.order.push(t)):(this.data[t]=e,this.order.push(t),this.order.length>this.max&&this.getAndRemove(this.order[0])),this}has(t){return t in this.data}keys(){return this.order}getAndRemove(t){if(!this.has(t))return null;const e=this.data[t];return delete this.data[t],this.order.splice(this.order.indexOf(t),1),e}get(t){return this.has(t)?this.data[t]:null}remove(t){return this.has(t)?(delete this.data[t],this.order.splice(this.order.indexOf(t),1),this):this}setMaxSize(t){for(this.max=t;this.order.length>this.max;)this.getAndRemove(this.order[0]);return this}},cL=class te{constructor(t){this.options=t||{},this._requesting={},this._cache=new hL(256,(function(){}));const e=document.createElement("canvas");this.ctx=e.getContext("2d",{willReadFrequently:!0})}getIcons(t,e){if(!t||!Object.keys(t).length)return void e(null,{icons:null});const n=Object.keys(t),i={},o=[];let s=0,a=0;const l=this;function h(t,n){i[t]=l._getCache(t,n),i[t]&&"error"!==i[t]?o.push(i[t].data.data.buffer):delete i[t],a++,a===s&&e(null,{icons:i,buffers:o})}function c(t){const e=l._requesting[t.url];for(let n=0;n<e.length;n++)e[n].call(t,t.url,t.size);delete l._requesting[t.url]}function u(){const t=l.ctx;let e,n;try{e=this.width,n=this.height,this.size[0]=e,this.size[1]=n,l._ensureMaxSize(null,this.size),e=this.size[0],n=this.size[1];const i=t.canvas;i.width=e,i.height=n,t.imageSmoothingEnabled=!1,t.drawImage(this,0,0,e,n);const o=t.getImageData(0,0,i.width,i.height).data;l._addCache(this.url,o,i.width,i.height)}catch(t){console.warn(t)}c(this)}function f(t){console.warn(`failed loading icon(${this.index}) at "${this.url}"`),console.warn(t),l.options.iconErrorUrl?this.src=l.options.iconErrorUrl:(l._addCache(this.url),c(this))}const g=this.options.urlModifier;let A,m=!1;for(let e=0;e<n.length;e++){const a=n[e],l=t[a];this._ensureMaxSize(a,l);const c=this._getCache(a,l);if(c&&"error"!==c){i[a]=this._getCache(a,l);continue}if("error"===c)continue;let w,T=a;if(0===a.indexOf("vector://")&&(w=JSON.parse(a.substring(9)),"path"===w.markerType&&(T=hs.getMarkerPathBase64(w,w.markerWidth,w.markerHeight))),0===a.indexOf("vector://")&&"path"!==w.markerType){A=A||new ld([0,0]);const{markerFill:t,markerLineColor:e}=w;t&&Array.isArray(t)&&(w.markerFill=uL(t)),e&&Array.isArray(e)&&(w.markerLineColor=uL(e)),delete w.markerHorizontalAlignment,delete w.markerVerticalAlignment,delete w.markerDx,delete w.markerDy,delete w.markerPlacement,delete w.markerFile,w.markerWidth=l[0],w.markerHeight=l[1],A.setSymbol(w);const n=A["_getSprite".trim()]();if(n){const t=n.canvas,e=t.width,s=t.height,l=t.getContext("2d").getImageData(0,0,e,s).data;i[a]={data:{data:new Uint8ClampedArray(l),width:e,height:s},url:a},o.push(i[a].data.data.buffer),this._addCache(a,l,e,s)}}else{if(this._requesting[a]){m=!0,s++,this._requesting[a].push(h);continue}this._requesting[a]=[],this._requesting[a].push(h);const t=new Image;t.index=e,t.size=l,t.onload=u,t.onerror=f,t.onabort=f,t.url=a,t.crossOrigin="Anonymous",m=!0,s++,t.src=g&&g(T)||T}}m||e(null,{icons:i,buffers:o})}_hasCache(t,e,n){const i=this._cache.get(t);return i&&"error"!==i&&i.data.width>=e&&i.data.height>=n}_addCache(t,e,n,i){this._hasCache(t,n,i)||this._cache.add(t,e?{data:{data:e,width:n,height:i},url:t}:"error")}_getCache(t,e){if(!this._hasCache(t,e[0],e[1]))return null;const n=this._cache.get(t);return n?"error"===n?n:{data:{data:new Uint8ClampedArray(n.data.data),width:n.data.width,height:n.data.height},url:n.url}:null}_ensureMaxSize(t,e){if(!e[0]||!e[1])return;const n=this.options.maxSize||2048;let[i,o]=e;const s=i/o;if(t){const e=this._cache.get(t);if(e&&"error"!==e){const{width:t,height:n}=e.data;t>i&&(i=t),n>o&&(o=n)}}i>n&&(o=n/s,i=n),o>n&&(i=n*s,o=n),e[0]=Math.floor(i),e[1]=Math.floor(o)}};function uL(t){return 3===t.length&&t.push(1),t.reduce(((t,e,n)=>t+(n<3?255*e+",":e+")")),"rgba(")}const{GlyphRequestor:fL}=ZR(),dL=["GeoJSONVectorTileLayer"];let gL=class se extends Em.Actor{constructor(t,e){super(t);const n=e.getMap().id;this._layer=e,this._mapId=n,this._workerLayerId="vt_"+XR();const i=e.getJSONType();this._isDedicated=dL.indexOf(i)>=0,this._dedicatedVTWorkers={},this._iconRequestor=new cL({iconErrorUrl:e.options.iconErrorUrl,maxSize:e.options.maxIconSize,urlModifier:t=>{const n=e.getURLModifier();return n&&n(t)||t}});const o=!e.getRenderer().isEnableWorkAround("win-intel-gpu-crash");this._glyphRequestor=new fL((t=>{e.getMap().getRenderer().callInNextFrame(t)}),e.options.glyphSdfLimitPerFrame,o,e.options.style&&e.options.style.renderPlugin&&e.options.style.renderPlugin.sdfURL)}initialize(t){t(null)}addLayer(t){const e=this._layer,n=e.getWorkerOptions()||{},i=this._workerLayerId,o=e.getJSONType(),s={mapId:this._mapId,layerId:i,command:"addLayer",params:{type:o,options:JSON.parse(JSON.stringify(n))}};this._isDedicated?(void 0===this._dedicatedVTWorkers[i]&&(this._dedicatedVTWorkers[i]=this.getDedicatedWorker()),this.send(s,null,t,this._dedicatedVTWorkers[i])):this.broadcast(s,null,t)}abortTile(t,e){const n=this._workerLayerId,i={mapId:this._mapId,layerId:n,command:"abortTile",params:{url:t}};this._isDedicated?(void 0===this._dedicatedVTWorkers[n]&&(this._dedicatedVTWorkers[n]=this.getDedicatedWorker()),this.send(i,null,e,this._dedicatedVTWorkers[n])):this.broadcast(i,null,e)}removeLayer(t){const e=this._workerLayerId,n={mapId:this._mapId,layerId:e,command:"removeLayer"};this._isDedicated?(void 0!==this._dedicatedVTWorkers[e]&&this.send(n,null,t,this._dedicatedVTWorkers[e]),delete this._dedicatedVTWorkers[e]):this.broadcast(n,null,t)}updateStyle(t,e){const n=this._workerLayerId,i={mapId:this._mapId,layerId:n,command:"updateStyle",params:JSON.parse(JSON.stringify(t))};this._isDedicated?void 0!==this._dedicatedVTWorkers[n]&&this.send(i,null,e,this._dedicatedVTWorkers[n]):this.broadcast(i,null,e)}updateOptions(t,e){const n=this._workerLayerId,i={mapId:this._mapId,layerId:n,command:"updateOptions",params:JSON.parse(JSON.stringify(t))};this._isDedicated?void 0!==this._dedicatedVTWorkers[n]&&this.send(i,null,e,this._dedicatedVTWorkers[n]):this.broadcast(i,null,e)}loadTile(t,e){const n=QR({},t);n.tileInfo=function(t){const e={};for(const n in t)null!=t[n]&&(e[n]=t[n].toJSON?t[n].toJSON():t[n]);return e}(t.tileInfo);const i=this._workerLayerId,o={mapId:this._mapId,layerId:i,command:"loadTile",params:n},{x:s,y:a}=t.tileInfo,l=(s+a)%this.workers.length,h=[],c=n.tileArrayBuffer;c&&c instanceof ArrayBuffer&&h.push(c),this.send(o,h,e,void 0===this._dedicatedVTWorkers[i]?this.workers[l].id:this._dedicatedVTWorkers[i])}remove(){super.remove(),this._dedicatedVTWorkers={}}fetchIconGlyphs({icons:t,glyphs:e},n){this._glyphRequestor.getGlyphs(e,((e,i)=>{if(e)throw e;const o=i.buffers||[];this._iconRequestor.getIcons(t,((t,e)=>{if(t)throw t;e.buffers&&e.buffers.length&&o.push(...e.buffers),n(null,{icons:e.icons,glyphs:i.glyphs},o)}))}))}setData(t,e){const n=this._workerLayerId;this.send({mapId:this._mapId,layerId:n,command:"setData",params:{data:t}},null,e,this._dedicatedVTWorkers[n])}_getTileKey(t){return t.id}};const pL={},AL={collision:!0,fading:!1,fadingDuration:224,fadeInDelay:600,fadeOutDelay:100,uniquePlacement:!1,depthFunc:"always"};let mL=class le{constructor(t,e,n){this._regl=t,this._map=e,this._color=n||[0,1,0]}draw(t,e,n,i,o){if(this._command||this._init(),!this._data){this._data=this._regl.buffer(yL(i));this._textData=this._regl.buffer(_L(i,i/n))}if(i!==this._extent){const t=i/n;this._data(yL(i)),this._textData(_L(i,t))}this._extent=i;let s=this._debugInfoCanvas;if(!s){const t=this._map.getDevicePixelRatio()>1?2:1;s=this._debugInfoCanvas=document.createElement("canvas"),s.width=512*t,s.height=64*t;const e=s.getContext("2d");e.font="36px monospace",e.scale(t,t),this._texture=this._regl.texture({width:s.width,height:s.height,data:s})}const a=s.getContext("2d");a.clearRect(0,0,s.width,s.height),a.fillStyle=`rgba(${this._color.map((t=>255*t)).join()})`,a.fillText(t,20,36),this._texture({width:s.width,height:s.height,data:s}),this._command({transform:e,data:this._data,texData:this._texCoordData,debugLine:1,primitive:"lines",framebuffer:o||null,image:this._texture,count:8}),this._command({transform:e,data:this._textData,texData:this._texCoordData,debugLine:0,primitive:"triangle strip",framebuffer:o||null,image:this._texture,count:4})}delete(){this._texture&&(this._texture.destroy(),delete this._texture),this._texCoordData&&(this._texCoordData.destroy(),delete this._texCoordData),this._data&&(this._data.destroy(),this._textData.destroy(),delete this._data,delete this._textData),this._command&&(this._command.destroy(),delete this._command)}_init(){this._texCoordData=this._regl.buffer(new Uint8Array([0,0,0,1,1,0,1,1,0,0,0,1,1,0,1,1])),this._command=this._regl({vert:"\n                attribute vec2 aPosition;\n                attribute vec2 aTexCoord;\n                uniform mat4 transform;\n\n                varying vec2 vTexCoord;\n                void main()\n                {\n                    gl_Position = transform * vec4(aPosition, 0.0, 1.0);\n                    vTexCoord = aTexCoord;\n                }\n            ",frag:"\n                precision mediump float;\n                uniform sampler2D uImage;\n                uniform vec3 uColor;\n                uniform float uOpacity;\n                uniform float uDebugLine;\n\n                varying vec2 vTexCoord;\n\n                void main()\n                {\n                    if (uDebugLine == 1.) {\n                        gl_FragColor = vec4(uColor, 1.0) * uOpacity;\n                    } else {\n                        gl_FragColor = texture2D(uImage, vTexCoord) * uOpacity;\n                    }\n                    gl_FragColor *= gl_FragColor.a;\n                }\n            ",attributes:{aPosition:this._regl.prop("data"),aTexCoord:this._regl.prop("texData")},uniforms:{transform:this._regl.prop("transform"),uColor:this._color,uOpacity:1,uDebugLine:this._regl.prop("debugLine"),uImage:this._regl.prop("image")},count:this._regl.prop("count"),primitive:this._regl.prop("primitive"),depth:{enable:!1,mask:!1},blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"},stencil:{enable:!1},viewport:{x:0,y:0,width:()=>this._map.getRenderer().canvas.width,height:()=>this._map.getRenderer().canvas.height},framebuffer:this._regl.prop("framebuffer")})}};function yL(t){return new Uint16Array([0,0,0,t,0,t,t,t,t,t,t,0,t,0,0,0])}function _L(t,e){return new Uint16Array([0,t-64*e,0,t,512*e,t-64*e,512*e,t])}const vL=new Uint8Array([0,0,0,1,1,0,1,0,0,1,1,1]),xL=[];let bL=class de{constructor(t,e,n){this._regl=t,(this._geometry=new vb({aPosition:vL},null,vL.length/2,{positionSize:2})).generateBuffers(t),this._scene=new _w,this._meshes=[],this._counter=0,this._canvas=e,this._map=n,this._init(t)}start(){this._counter=0,this._scene.clear()}add(t,e,n){const i=this._getMesh(n);i.setUniform("ref",t),Fy(xL,e,e,1);const o=i.localTransform;py(o,xL),Oy(o,n,o),i.setLocalTransform(o),this._scene.addMesh(i)}render(t){this._renderer.render(this._shader,{projViewMatrix:this._map.projViewMatrix},this._scene,t)}_getMesh(){const t=this._counter++;return this._meshes[t]||(this._meshes[t]=new aw(this._geometry)),this._meshes[t]}_init(t){const e=this._canvas,n={viewport:{x:0,y:0,width:()=>e.width,height:()=>e.height},stencil:{enable:!0,mask:255,func:{cmp:"always",ref:(t,e)=>e.ref,mask:255},op:{fail:"replace",zfail:"replace",zpass:"replace"}},depth:{enable:!0,func:"always",mask:!1},colorMask:[!1,!1,!1,!1]};this._shader=new zw({vert:"\n#define SHADER_NAME TILE_STENCIL_VERT\nattribute vec2 aPosition;\nuniform mat4 projViewModelMatrix;\n\nvoid main()\n{\n    gl_Position = projViewModelMatrix * vec4(aPosition, 0.0, 1.0);\n}\n",frag:"\n#define SHADER_NAME TILE_STENCIL_FRAG\nvoid main()\n{\n    gl_FragColor = vec4(1.0, 0.0, 0.0, 0.1);\n}\n",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){const n=[];return cy(n,e.projViewMatrix,e.modelMatrix),n}}],extraCommandProps:n}),this._renderer=new cw(t)}remove(){this._geometry.dispose();for(let t=0;t<this._meshes.length;t++)this._meshes[t].dispose();this._meshes.length=0,this._shader.dispose()}};const wL="__fea_idx",TL=-999999,ML=new Float32Array([-1e12])[0],CL="ispace_ombb",SL=(wL+"").trim();function PL(t,e,n,i,o,s){const a={};if(function(t){if(!t)return!1;for(const e in t)if(null!=t[e])return!0;return!1}(t))for(let l=0,h=(e||t).length;l<h;l++){let h=e?t[e[l]]:t[l];"id"===o.options.features&&o.getFeature&&(h=o.getFeature(h),h.layer=n),o instanceof kp&&(h=RL(h,s)),a[e?e[l]:h[SL]]={feature:h,symbol:i}}return a}const IL="__original_properties",OL="__external_properties",EL={get:function(t,e){return e in t?t[e]:t[IL][e]||t[OL]&&t[OL][e]},has:function(t,e){return e in t||e in t[IL]||t[OL]&&e in t[OL]}},kL={};function RL(t,e){const n=t.properties;if(n&&n[IL])return t;e&&(t=QR({},t)),t.customProps=t.customProps||{};const i=t.customProps;return i.$layer=t.layer,i.$type=t.type,i[IL]=n||kL,t.properties=new Proxy(i,EL),t}function LL(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)t[e]=n[e]}return t}function DL(t,e,n){return Math.min(n,Math.max(e,t))}function FL(t,e,n){if(t===n||t===e)return t;const i=n-e;return((t-e)%i+i)%i+e}function NL(t){return null==t}function HL(t){const e=JSON.parse(JSON.stringify(t));if(Array.isArray(t))for(let n=0;n<t.length;n++){if(!e[n])continue;const{symbol:i}=e[n];if(!i)continue;const o=t[n].symbol;for(const t in o)i[t]||(i[t]=o[t])}else if(t){if(t.style){const n=HL(t.style);return e.style=n,e}if(t.symbol){const n=HL(t.symbol);return e.symbol=n,e}for(const n in t)e[n]||(e[n]=t[n])}return e}function BL(t,e,n,i,o,s){e in t||Object.defineProperty(t,e,{enumerable:!0,get:function(){const t=NL(n[i])||mk(n[i])?o:n[i];return s?s(t):t}})}const zL=[];function GL(t){for(let e=0;e<t.length;e++)zL[e]=t[e],zL[e]*=255;return 3===t.length&&(zL[3]=255),zL}function jL(t,e=4){return UL.bind(this,t,e)}function UL(t,e,n){if(Array.isArray(n))return 3===n.length&&4===e&&n.push(1),n;if(t&&t[n])return t[n];if(void 0!==n.r&&void 0!==n.g&&void 0!==n.b&&void 0!==n.a)return[n.r,n.g,n.b,n.a];const i=KE(n).unitArray();return 3===i.length&&4===e&&i.push(1),t&&(t[n]=i),i}function VL(t,e,n,i){if(t.fill)t.fill(e,n,i);else for(let o=n;o<i;o++)t[o]=e}function WL(t){return"number"==typeof t&&!isNaN(t)}function ZL(t){return t&&(t.markerFile||t.markerType)&&void 0!==t.textName}function qL(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function XL(t,e){if(e){let e=t[t.length-1];const n=[e];for(let i=t.length-2;i>=0;i--)t[i]!==e&&(n.push(t[i]),e=t[i]);return n}{let e=t[t[0]];const n=[e];for(let i=1;i<t.length;i++)t[i]!==e&&(n.push(t[i]),e=t[i]);return n}}const JL=new gh(0,0);function QL(t,e,n,i,o){const s=t.distanceToPointAtRes(e,e,i,n,JL);return o?s.y:s.x}const{FilterUtil:YL}=ZR(),KL=[],$L=[0,0,0,0],tD=new _e(0,0),eD=[],nD={color:$L,depth:1,stencil:0},iD=t=>t.isTerrainSkin(),rD=t=>t.isTerrainVector();let oD=class $e extends vm.TileLayerCanvasRenderer{supportRenderMode(){return!0}constructor(t){super(t),this._workerCacheIndex=0,this.ready=!1,this._styleCounter=1,this._requestingMVT={},this._plugins={},this._featurePlugins={}}getTileLevelValue(t,e){if(this.isBackTile(t.id)){const n=t.z,i=5;return n-e>=0?e+i-n:i+(e-n)}return 0}getWorkerConnection(){return this._workerConn}getStyleCounter(){return this._styleCounter}setStyle(){if(this._groundPainter&&this._groundPainter.update(),this._workerConn){this._styleCounter++,this._preservePrevTiles();const t=this.layer._getComputedStyle();t.styleCounter=this._styleCounter,this._workersyncing=!0,this._workerConn.updateStyle(t,(t=>{if(this._workersyncing=!1,t)throw new Error(t);this._needRetire=!0,this._initPlugins(),this.setToRedraw(),this.layer.fire("refreshstyle")}))}else this._initPlugins()}_preservePrevTiles(){if(this._prevTilesInView)for(const t in this._prevTilesInView){const e=this._prevTilesInView[t];e&&this.deleteTile(e)}this._prevTilesInView=this.tilesInView;const t=this.tileCache;for(const e in this._prevTilesInView){const n=this._prevTilesInView[e];n&&n.info&&t.getAndRemove(n.info.id)}t.reset(),this.tilesInView={},this.tilesLoading={},this._requestingMVT={},this._parentTiles=[],this._childTiles=[],this._tileZoom=void 0}updateOptions(t){this._workerConn&&this._workerConn.updateOptions(this.layer.getWorkerOptions(),(e=>{if(e)throw new Error(e);t&&(t.features||t.pickingGeometry||t.altitudeProperty)&&(this.clear(),this._clearPlugin(),this._initPlugins()),this.setToRedraw()}))}updateSceneConfig(t,e,n){const i=0===t?this._getStylePlugins():this._getFeaturePlugins();if(!i||!i[e])return;this._needRetire=!0;const o=this.layer._getComputedStyle(),s=this.layer._getTargetStyle(t,o);i[e].config=s[e].renderPlugin,i[e].updateSceneConfig({sceneConfig:n}),this.setToRedraw()}updateDataConfig(t,e,n,i){const o=0===t?this._getStylePlugins():this._getFeaturePlugins();o&&o[e]&&(this._needRetire=!0,o[e].updateDataConfig(n,i)?this.setStyle():this.setToRedraw())}updateSymbol(t,e,n){const i=0===t?this._getStylePlugins():this._getFeaturePlugins();if(!i||!i[e])return!1;const o=this.layer._getComputedStyle(),s=this.layer._getTargetStyle(t,o),a=i[e];a.style=s[e];const l=a.updateSymbol(n,s[e].symbol);return!l&&hD(n)&&this.setStyle(),this.setToRedraw(),l}testIfNeedRedraw(){const t=this._getFramePlugins();for(let e=0;e<t.length;e++)if(t[e]&&t[e].needToRedraw())return!0;return super.testIfNeedRedraw()}needRetireFrames(){if(this._needRetire)return!0;const t=this._getFramePlugins();for(let e=0;e<t.length;e++)if(t[e]&&t[e].needToRetireFrames())return!0;return!1}isAnimating(){const t=this.getMap().getRenderer(),e=t.getFrameTimestamp&&t.getFrameTimestamp()||t._frameTimestamp;if(this._highlightUpdated&&(this._highlightFrametime=e,delete this._highlightUpdated),this._highlightFrametime===e)return!0;const n=this._getFramePlugins();for(let t=0;t<n.length;t++)if(n[t]&&n[t].isAnimating())return!0;return!1}needToRefreshTerrainTileOnZooming(){const t=this._getFramePlugins();for(let e=0;e<t.length;e++)if(t[e]&&t[e].needToRefreshTerrainTileOnZooming())return!0;return!1}_isInGroupGLLayer(){return!!(this.canvas&&this.canvas.gl&&this.canvas.gl.wrap)}createContext(){const t=this.canvas.gl&&this.canvas.gl.wrap;if(t)this.gl=this.canvas.gl.wrap(),this.regl=this.canvas.gl.regl;else{const{gl:t,regl:e,attributes:n}=this._createREGLContext(this.canvas);this.gl=t,this.regl=e,this.glOptions=n}if(t&&(this.canvas.pickingFBO=this.canvas.pickingFBO||this.regl.framebuffer(this.canvas.width,this.canvas.height)),this.pickingFBO=this.canvas.pickingFBO||this.regl.framebuffer(this.canvas.width,this.canvas.height),this._debugPainter=new mL(this.regl,this.getMap()),this._prepareWorker(),this._groundPainter=new GroundPainter(this.regl,this.layer),!this.consumeTile){const t=this.getMap().VERSION;throw new Error(`Incompatible version of ispace: ${t}, upgrade ispace >= v1.0.0-rc.14`)}}_createREGLContext(t){const e=this.layer,n=e.options.glOptions||{alpha:!0,depth:!0,antialias:this.layer.options.antialias};n.preserveDrawingBuffer=!0,n.stencil=!0;const i=this._createGLContext(t,n);return{gl:i,attributes:n,regl:Dm({gl:i,attributes:n,extensions:["ANGLE_instanced_arrays","OES_element_index_uint","OES_standard_derivatives"],optionalExtensions:e.options.glExtensions||["OES_vertex_array_object","OES_texture_half_float","OES_texture_half_float_linear","OES_texture_float","OES_texture_float_linear","WEBGL_draw_buffers","EXT_shader_texture_lod","EXT_frag_depth"]})}}_prepareWorker(){this._workerConn||(this._workerConn=new gL("@ispace/vt",this.layer)),this._workerConn.addLayer(((t,e)=>{this.layer&&(this.ready=!0,this.layer.onWorkerReady(t,e),this.layer.fire("workerready"),this.setToRedraw())}))}_incrWorkerCacheIndex(){this._workerCacheIndex++}clearCanvas(){super.clearCanvas(),this.regl&&this.regl.clear({color:$L,depth:1,stencil:0})}isDrawable(){return!0}checkResources(){return KL}_drawTiles(t,e,n,i,o){if(super._drawTiles(t,e,n,i,o),this._prevTilesInView)if(Object.keys(this._prevTilesInView).length)for(const t in this._prevTilesInView){const e=this._prevTilesInView[t];e&&e.info&&e.info.id&&!this.tileCache.has(e.info.id)&&this._drawTile(e.info,e.image,o)}else this._deletePrevPlugins(),delete this._prevTilesInView}_deletePrevPlugins(){const t=this._styleCounter,e=[],n=[];for(const n in this._plugins)+n!==t&&(e.push(n),this._getStylePlugins(n).forEach((t=>{t.remove()})));for(const e in this._featurePlugins)+e!==t&&(n.push(e),this._getFeaturePlugins(e).forEach((t=>{t.remove()})));for(let t=0;t<e.length;t++)delete this._plugins[e[t]];for(let t=0;t<n.length;t++)delete this._featurePlugins[n[t]]}draw(t,e){this._currentTimestamp!==t&&(this._needRetire=!1,this._setPluginIndex());const n=this.layer;if(this.prepareCanvas(),!this.ready||!n.ready)return;let i=this._plugins[this._styleCounter];i||(this._initPlugins(),this._setPluginIndex(),i=this._getStylePlugins());const o=this._getFeaturePlugins();n.isDefaultRender()||i.length||o.length?(n.options.collision&&n.clearCollisionIndex(),this._frameTime=t,this._zScale=this._getCentiMeterScale(this.getMap().getGLRes()),this._parentContext=e||{},this._startFrame(t),super.draw(t),this._currentTimestamp!==t&&this._prepareRender(t),this._endFrame(t),this._currentTimestamp=t):this.completeRender()}_setPluginIndex(){this._getFramePlugins().forEach(((t,e)=>{t&&(t.renderIndex=e)}))}_prepareRender(){const t=this._getFramePlugins();this._pluginOffsets=this._pluginOffsets||[];let e=0;for(let n=t.length-1;n>=0;n--){const i=t[n];i.isVisible()&&i.hasMesh()&&(this._pluginOffsets[n]=e,i.needPolygonOffset()&&e++)}this._groundPainter.isEnable()&&e++,this._polygonOffsetIndex=e}getFrameTimestamp(){return this._frameTime}drawOnInteracting(t,e,n){this.draw(e,n)}drawOutline(t){(this._outline||this._outlineAll)&&(this._outlineAll?this.paintOutlineAll(t):this._outline.forEach((e=>{this[e[0]](t,...e[1])})))}getAnalysisMeshes(){return this.getShadowMeshes()}getShadowMeshes(){const t=[];return this._getAllPlugins().forEach((e=>{if(!e)return;if(!this._isVisible(e))return;const n=e.getShadowMeshes();if(Array.isArray(n))for(let e=0;e<n.length;e++)t.push(n[e])})),t}isForeground(t){return!(!this._vtCurrentTiles||!this._vtCurrentTiles[t.properties.tile.id])}getCurrentTiles(){return this._vtCurrentTiles}_getTileZoomDiff(t){const e=this.layer;let n=e._getTileZoom(this.getMap().getZoom());const i=e.getMinZoom(),o=e.getMaxZoom();return n=hs.clamp(n,i,o),n-t.properties.tile.z}isTileNearCamera(t){return this._getTileZoomDiff(t)<=1}isBackTile(t){return!(!this._vtBgTiles||!this._vtBgTiles[t])}loadTileQueue(t){this._workersyncing||super.loadTileQueue(t)}loadTile(t){const{url:e}=t,n=this._requestingMVT[e];if(n)n.keys[t.id]||(n.tiles.push(t),n.keys[t.id]=1);else{const n=this.getMap(),i=tD.set(t.extent2d.xmin,t.extent2d.ymax),o=n.pointAtResToCoord(new _e(i),t.res),s=[QL(n,1,o,t.res)/100,QL(n,1,o,t.res,1)/100],a=this.getCentimeterToPoint(t.z),l=this.getTileGLScale(t.z);this._requestingMVT[e]={keys:{},tiles:[t]},this._requestingMVT[e].keys[t.id]=1;const h=this.layer.options.fetchOptions,c=window&&window.location.href,u=this.layer.options.altitudePropertyName,f=this.layer.options.disableAltitudeWarning,g={tileInfo:{res:t.res,x:t.x,y:t.y,z:t.z,url:fD(t),id:t.id,extent2d:t.extent2d},glScale:l,disableAltitudeWarning:f,altitudePropertyName:u,zScale:this._zScale,centimeterToPoint:s,verticalCentimeterToPoint:a,fetchOptions:h,styleCounter:this._styleCounter,referrer:c,workerCacheIndex:this._workerCacheIndex,command:"loadTile"};this.loadTileArrayBuffer&&$R(this.loadTileArrayBuffer)?this.loadTileArrayBuffer(g.tileInfo.url,t,((t,n)=>{t?this._onReceiveMVTData(e,t):n&&n instanceof ArrayBuffer?(g.tileArrayBuffer=n,this._workerConn.loadTile(g,this._onReceiveMVTData.bind(this,e))):console.error("loadTileArrayBuffer return data is not ArrayBuffer:",n)}),g):this._workerConn.loadTile(g,this._onReceiveMVTData.bind(this,e))}return{}}getTileGLScale(t){const e=this.getMap();return this.layer.getSpatialReference().getResolution(t)/e.getGLRes()}getCentimeterToPoint(t){const e=this.getMap();return oL(this.layer.getSpatialReference().getResolution(t),e)}getRenderedFeatures(){const t=this.tileCache.keys();return this._getFeaturesByKeys(t)}getCurrentRenderedFeatures(){const t=this._vtCurrentTiles&&Object.keys(this._vtCurrentTiles);return this._getFeaturesByKeys(t)}_getFeaturesByKeys(t){const e=[];for(let n=0;n<t.length;n++){const i=this.tileCache.get(t[n]);if(!i||!i.info||!i.image)continue;const{info:o,image:s}=i,a=uD(s);e.push({tile:{id:o.id,x:o.x,y:o.y,z:o.z,url:o.url},current:!!this.tilesInView[o.id],features:a})}return e}_onReceiveMVTData(t,e,n){if(this.setToRedraw(),!this._requestingMVT[t])return;if(n&&n.canceled)return;const i=this.layer,o=i.isDefaultRender(),{tiles:s}=this._requestingMVT[t];if(delete this._requestingMVT[t],e){if(e.status&&(404===e.status||204===e.status))for(let t=0;t<s.length;t++){this.onTileError(pL,s[t])}return}if(!n){for(let t=0;t<s.length;t++){this.consumeTile({_empty:!0},s[t])}return}if(n.styleCounter!==this._styleCounter)return;let a=!1;const l=n.features,h=[];for(let t=0;t<n.data.length;t++){const e=n.data[t];if(!e||!e.data||!e.styledFeatures.length)continue;const{isUpdated:i,layer:o}=this._parseTileData(0,t,e,l,h);h.push(o),i&&(a=i)}for(let t=0;t<n.featureData.length;t++){const e=n.featureData[t];e&&e.data&&e.styledFeatures.length&&this._parseTileData(1,t,e,l)}a&&i._compileStyle();const c=this.layer.getDataSchema(s[0].z);if(this._updateSchema(c,n.schema),delete n.features,o&&n.data.length!==h.length){const t=n.data;n.data=[];for(let e=0;e<t.length;e++)t[e]&&t[e].features&&n.data.push(t[e])}n.layers=h;for(let t=0;t<s.length;t++){const e=s[t];if(0===t&&i.options.debugTileData){const{x:t,y:n,z:o}=e;console.log("tile",{layerId:i.getId(),x:t,y:n,z:o,layers:lD(Object.values(l))})}const o=0===t?n:sD(n);for(let t=0;t<o.data.length;t++){if(!o.data[t])continue;const n=o.data[t].features;for(const t in n)n[t].tile=e}e.extent=o.extent,this._receivedTileExtent||(this._receivedTileExtent=e.extent),o.features=Object.values(l),o.styleCounter=n.styleCounter,this.onTileLoad(o,e)}this.layer.fire("datareceived",{url:t})}_parseTileData(t,e,n,i){const{style:o,isUpdated:s}=this._updatePluginIfNecessary(t,e,n.data),a=this.layer,l=a.isDefaultRender(),h=PL(i,n.styledFeatures,e,o.symbol,a,!(!a.getData||!a.getData()));delete n.styledFeatures,n.features=h;let c=n.data;return Array.isArray(c)&&(c=c[0]),{isUpdated:s,layer:l?{layer:c.layer,type:c.type}:null}}_updateSchema(t,e){for(const n in e){t[n]||(t[n]={types:e[n].types,properties:{}});const i=e[n].properties,o=t[n].properties;for(const t in i)(!o[t]||o[t]&&"object"!==i[t]&&"object"===o[t])&&(o[t]=i[t])}}_updatePluginIfNecessary(t,e,n){Array.isArray(n)&&(n=n[0]);const i=this.layer;let o,s=!1;if(i.isDefaultRender()&&0===t){let t=this._layerPlugins;t||(t=this._layerPlugins={});const e=n.layer,i=n.type;t[e]||(t[e]=[]);const a=("plugin_"+i).trim();t[e][a]?o=t[e][a]:(o=this._getDefaultRenderPlugin(i),o.filter=n.filter,t[e].push(o),t[e][a]=o,s=!0)}else{const a=i._getComputedStyle(),l=i._getTargetStyle(t,a),h=this._getStylePlugins();if(o=l[e],!o.renderPlugin){s=!0;const{plugin:t,symbol:i,renderPlugin:a}=this._getDefaultRenderPlugin(n.type);h[e]=t,o.symbol=i,o.renderPlugin=a}}return{style:o,isUpdated:s}}_getFramePlugins(t){const e=t&&t.style;let n=this._getStylePlugins(e)||[];this.layer.isDefaultRender()&&this._layerPlugins&&(n=[],t?t.layers&&t.layers.forEach((t=>{if(!t)return;const e=("plugin_"+t.type).trim();n.push(this._layerPlugins[t.layer][e].plugin)})):Object.keys(this._layerPlugins).forEach((t=>{for(let e=0;e<this._layerPlugins[t].length;e++)n.push(this._layerPlugins[t][e].plugin)})));const i=this._getFeaturePlugins(e);return i&&i.length&&(n=n.slice(),nL(n,i)),n}_getAllPlugins(){if(this.layer.isDefaultRender()&&this._layerPlugins){const t=[];return Object.keys(this._layerPlugins).forEach((e=>{for(let n=0;n<this._layerPlugins[e].length;n++)t.push(this._layerPlugins[e][n].plugin)})),t}const t=[];for(const e in this._plugins)t.push(...this._plugins[e]);for(const e in this._featurePlugins)t.push(...this._featurePlugins[e]);return t}_getStylePlugins(t){return eL(t)&&(t=this._styleCounter),this._plugins[t]||KL}_getFeaturePlugins(t){return eL(t)&&(t=this._styleCounter),this._featurePlugins[t]||KL}_startFrame(t,e){const n=this._isRenderingTerrain(),i=this.layer.isDefaultRender()&&this._layerPlugins,o=this._parentContext;this._getAllPlugins().forEach(((s,a)=>{if(!s||e&&!e(s))return;if(!this._isVisible(a))return;const l={regl:this.regl,layer:this.layer,symbol:i?s.defaultSymbol:s.style&&s.style.symbol,gl:this.gl,isRenderingTerrain:n,sceneConfig:s.config?s.config.sceneConfig:null,dataConfig:s.config?s.config.dataConfig:null,pluginIndex:a,timestamp:t};o&&QR(l,o),s.startFrame(l)}))}_endFrame(t){const e=this._parentContext,n=e.renderMode,i=e&&e.renderTarget&&e.renderTarget.fbo,o=this.getMap().cameraPosition,s=this._getAllPlugins(),a=this._isRenderingTerrain(),l=!e.timestamp||e.isFinalRender;s.forEach(this.layer.options.collision&&!e.isPostProcess?e=>{if(!this._isVisible(e)||!e.hasMesh())return;if(n&&"default"!==n&&!e.supportRenderMode(n))return;if(a&&!rD(e))return;const i=this._getPluginContext(e,0,o,t);e.prepareRender(i),e.updateCollision(i)}:e=>{if(!this._isVisible(e)||!e.hasMesh())return;if(n&&"default"!==n&&!e.supportRenderMode(n))return;if(a&&!rD(e))return;const i=this._getPluginContext(e,0,o,t);e.prepareRender(i)});let h=!1;if(this._currentTimestamp!==e.timestamp&&!a){const e=this.layer.getPolygonOffset()+this.layer.getPolygonOffsetCount(),n=this._getPluginContext(null,e,o,t);n.offsetFactor=e,n.offsetUnits=e,this._groundPainter.paint(n)}s.forEach(((e,s)=>{if(!this._isVisitable(e))return;if(n&&"default"!==n&&!e.supportRenderMode(n))return;if(a&&!rD(e))return;this.regl.clear({stencil:255,framebuffer:i});const l=this._getPluginContext(e,this._pluginOffsets[s]||0,o,t);e.painter&&e.painter.isEnableTileStencil(l)&&this._drawTileStencil(i,e.painter);const c=e.endFrame(l);c&&c.redraw&&this.setToRedraw(),h=!0})),h&&this.layer.fire("canvasisdirty"),l&&this._drawDebug()}getPolygonOffsetCount(){return this._polygonOffsetIndex||0}_drawDebug(){if(this.layer.options.debug){const t=this._parentContext,e=[],n=this.getMap().projViewMatrix;for(const i in this.tilesInView){const o=this.tilesInView[i].info,s=this.tilesInView[i].image;if(s._empty)continue;const a=o.transform,l=s.extent,h=t&&t.renderTarget;if(a&&l){const t=this.getDebugInfo(o.id),i=cy(e,n,a),s=this.layer.getTileSize().width;this._debugPainter.draw(t,i,s,l,h&&h.fbo)}}}}_isVisitable(t){if(!t)return!0;const e=this._parentContext,n=this._isVisible(t),i=e&&e.states&&e.states.includesChanged,o=this._hasMesh(t.painter.scene.getMeshes());return n&&(i||o)?o?2:1:0}_getPluginContext(t,e,n,i){const o=this._isRenderingTerrain(),s=o&&t&&iD(t),a={regl:this.regl,layer:this.layer,gl:this.gl,isRenderingTerrain:o,isRenderingTerrainSkin:s,sceneConfig:t&&t.config.sceneConfig,pluginIndex:t&&t.renderIndex,polygonOffsetIndex:e,cameraPosition:n,timestamp:i},l=this._parentContext;return l&&QR(a,l),a}_hasMesh(t){if(!t)return!1;const e=this._parentContext&&this._parentContext.sceneFilter;return e?t.filter((t=>e(t)||t.properties.hlBloomMesh&&e(t.properties.hlBloomMesh))).length>0:t.length>0}_drawTileStencil(t,e){const n=e.isUniqueStencilRefPerTile(),i=this.getCurrentTileZoom();let o=this._stencilRenderer;o||(o=this._stencilRenderer=new bL(this.regl,this.canvas,this.getMap())),o.start();const{tiles:s}=this._stencilTiles;let{parentTiles:a,childTiles:l}=this._stencilTiles,h=1;l=l.sort(aD);for(let t=0;t<l.length;t++){const e=n?h:this.getTileLevelValue(l[t].info,i);this._addTileStencil(l[t].info,e),h++}a=a.sort(aD);for(let t=0;t<a.length;t++){const e=n?h:this.getTileLevelValue(a[t].info,i);this._addTileStencil(a[t].info,e),h++}const c=s.sort(aD);for(let t=c.length-1;t>=0;t--){const e=n?h:this.getTileLevelValue(c[t].info,i);this._addTileStencil(c[t].info,e),h++}o.render(t)}_addTileStencil(t,e){const n=tD.set(t.extent2d.xmin,t.extent2d.ymax),i=t.extent||this._receivedTileExtent||8192,o=t.transform=t.transform||this.calculateTileMatrix(n,t.z,i);t.stencilRef=e,this._stencilRenderer.add(e,i,o)}onDrawTileStart(t){super.onDrawTileStart(t);const{tiles:e,childTiles:n,parentTiles:i}=t;this._vtCurrentTiles={},this._vtBgTiles={};for(let t=0;t<e.length;t++)this._vtCurrentTiles[e[t].info.id]=1;for(let t=0;t<n.length;t++)this._vtBgTiles[n[t].info.id]=1;for(let t=0;t<i.length;t++)this._vtBgTiles[i[t].info.id]=1;this._stencilTiles=t}isEnableTileStencil(){if(this.layer.options.altitude)return!1;const t=this._getFramePlugins();for(let e=0;e<t.length;e++)if(t[e]&&t[e].painter&&!t[e].painter.isOnly2D())return!1;return!0}setTerrainHelper(t){this._terrainLayer=t}getTerrainHelper(){return this._terrainLayer}drawTileOnTerrain(...t){$e.prototype.drawTile.call(this,...t)}createTerrainTexture(t){const e=this.layer.getTileSize().width,n=2*e,i=2*e,o=t.texture({min:"linear",mag:"linear",type:"uint8",width:n,height:i});this._terrainDepthStencil||(this._terrainDepthStencil=t.renderbuffer({width:n,height:i,format:"depth24 stencil8"}));const s={width:n,height:i,colors:[o],colorFormat:"rgba",ignoreStatusCheck:!0};s.depthStencil=this._terrainDepthStencil;const a=t.framebuffer(s);return a.colorTex=o,a}deleteTerrainTexture(t){t.destroy(),t.colorTex&&(t.colorTex.destroy(),delete t.colorTex)}renderTerrainSkin(t,e,n){const i=this._currentTimestamp,o=this._parentContext,s=this.layer.getTileSize().width;this._startFrame(i);for(let e=0;e<n.length;e++){const i=n[e].texture;this._parentContext={renderTarget:{fbo:i}},nD.framebuffer=i,t.clear(nD),this._parentContext.viewport=cD(s),this._drawTerrainTile(n[e].tile,i)}this._endTerrainFrame(n),this._parentContext=o}_drawTerrainTile(t){const{info:e,image:n}=t;this.drawTile(e,n,iD)}_endTerrainFrame(t){const e=this._getAllPlugins(),n=this.getMap().cameraPosition,i=this._currentTimestamp||0;e.forEach(this.layer.options.collision?t=>{if(!this._isVisible(t)||!t.hasMesh())return;if(!iD(t)||!this.layer.options.awareOfTerrain)return;const e=this._getPluginContext(t,0,n,i);e.isRenderingTerrainSkin=!0,t.prepareRender(e),t.updateCollision(e)}:t=>{if(!this._isVisible(t)||!t.hasMesh())return;if(!iD(t)||!this.layer.options.awareOfTerrain)return;const e=this._getPluginContext(t,0,n,i);e.isRenderingTerrainSkin=!0,t.prepareRender(e)}),e.forEach(((e,n)=>{if(!this._isVisitable(e)||!iD(e))return;for(let e=0;e<t.length;e++){this.regl.clear({stencil:255,framebuffer:t[e].texture})}const i=this._getPluginContext(e,this._pluginOffsets[n]||0,[0,0,0],this._currentTimestamp);i.isRenderingTerrainSkin=!0,e.endFrame(i)}))}drawTile(t,e,n){if(!e.cache)return;const i=this._isRenderingTerrain(),o=e.cache,s=tD.set(t.extent2d.xmin,t.extent2d.ymax),a=t.extent||this._receivedTileExtent||8192,l=t.transform=t.transform||this.calculateTileMatrix(s,t.z,a),h=t.tileTranslationMatrix=t.tileTranslationMatrix||this.calculateTileTranslationMatrix(s,t.z),c=t.terrainTransform=t.terrainTransform||this.calculateTerrainTileMatrix(s,t.z,a),u=this._parentContext,f=[];nL(f,e.data),nL(f,e.featureData),this._getFramePlugins(e).forEach(((s,a)=>{if(!s||n&&!n(s))return;if(!f[a])return;if(!o[a])return;if(this.drawingParentTiles&&!s.painter.shouldDrawParentTile())return;const g=i&&iD(s),A={regl:this.regl,layer:this.layer,gl:this.gl,sceneConfig:s.config.sceneConfig,pluginIndex:a,tileCache:o[a],tileData:f[a],tileTransform:g?c:l,tileVectorTransform:l,tileTranslationMatrix:h,tileExtent:e.extent,timestamp:this._frameTime,tileInfo:t,tileZoom:this._tileZoom,bloom:this._parentContext&&this._parentContext.bloom,isRenderingTerrain:i,isRenderingTerrainSkin:g};g&&u&&u.renderTarget&&(A.renderTarget=u.renderTarget);const m=s.paintTile(A);!this._needRetire&&(m.retire||m.redraw)&&s.supportRenderMode("taa")&&(this._needRetire=!0),m.redraw&&this.setToRedraw()})),e&&e.style===this._styleCounter&&this._retirePrevTile(t),this.setCanvasUpdated()}_createOneTile(t,e){if(!e.loadTime||e._empty)return;let n=e.cache;n||(n=e.cache={});const i=this._isRenderingTerrain(),o=tD.set(t.extent2d.xmin,t.extent2d.ymax),s=t.transform=t.transform||this.calculateTileMatrix(o,t.z,e.extent),a=t.tileTranslationMatrix=t.tileTranslationMatrix||this.calculateTileTranslationMatrix(o,t.z),l=t.terrainTransform=t.terrainTransform||this.calculateTerrainTileMatrix(o,t.z,t.extent),h=[];nL(h,e.data),nL(h,e.featureData),this._getFramePlugins(e).forEach(((o,c)=>{if(!o)return;if(!h[c])return;const u=i&&iD(o),f=this.regl,g=this.gl;n[c]||(n[c]={});const A=o.createTile({regl:f,layer:this.layer,gl:g,sceneConfig:o.config.sceneConfig,pluginIndex:c,tileCache:n[c],tileData:h[c],tileTransform:u?l:s,tileVectorTransform:s,isRenderingTerrain:i,isRenderingTerrainSkin:u,tileTranslationMatrix:a,tileExtent:e.extent,timestamp:this._frameTime,tileInfo:t,tileZoom:this._tileZoom});n[c].geometry&&(e.data[c]=1),!this._needRetire&&A.retire&&o.supportRenderMode("taa")&&(this._needRetire=!0)}))}checkTileInQueue(t){return t.styleCounter===this._styleCounter}pick(t,e,n){const i=[];return this.layer.isVisible()?(this._getFramePlugins().forEach((o=>{if(!o)return;if(!1===(o.painter&&o.painter.sceneConfig).picking)return;if(!o.isVisible())return;const s=o.pick(t,e,n.tolerance);s&&(s.type=o.getType(),i.push(s))})),i):i}deleteTile(t){if(t){if(t.image&&!t.image._empty){const e=this._getStylePlugins(t.image&&t.image.style);e&&e.forEach(((e,n)=>{e&&e.deleteTile({pluginIndex:n,regl:this.regl,layer:this.layer,gl:this.gl,tileCache:t.image.cache?t.image.cache[n]:{},tileInfo:t.info,tileData:t.image})})),t.image.cache={}}t.info&&(delete t.info.completeTerrainQuery,delete t.info.terrainQueryStatus),super.deleteTile(t)}}abortTileLoading(t,e){const n=e?fD(e):"";e&&e.url&&(this._workerConn&&this._workerConn.abortTile(n),delete this._requestingMVT[e.url]),this.loadTileArrayBuffer&&$R(this.loadTileArrayBuffer)?this.loadTileArrayBuffer(n,e,(()=>{}),{command:"abortTile"}):super.abortTileLoading(t,e)}resizeCanvas(t){super.resizeCanvas(t);const e=this.canvas;e&&(!this.pickingFBO||this.pickingFBO.width===e.width&&this.pickingFBO.height===e.height||(this.pickingFBO.resize(e.width,e.height),this._getFramePlugins().forEach((t=>{t&&t.resize(e.width,e.height)}))))}onRemove(){this._stencilRenderer&&this._stencilRenderer.remove(),this._workerConn&&(this._workerConn.removeLayer((t=>{if(t)throw t})),this._workerConn.remove(),delete this._workerConn),this.pickingFBO&&(this.canvas.pickingFBO||this.pickingFBO.destroy(),delete this.pickingFBO),this._debugPainter&&(this._debugPainter.delete(),delete this._debugPainter),this._terrainDepthStencil&&(this._terrainDepthStencil.destroy(),delete this._terrainDepthStencil),this._groundPainter&&(this._groundPainter.dispose(),delete this._groundPainter),super.onRemove&&super.onRemove(),this._clearPlugin()}_clearPlugin(){this._getAllPlugins().forEach((t=>{t.remove()})),this.plugins={}}hitDetect(t){if(!this.gl||!this.layer.options.hitDetect)return!1;const e=this.gl,n=new Uint8Array(4);return e.readPixels(t.x,this.canvas.height-t.y,1,1,e.RGBA,e.UNSIGNED_BYTE,n),n[3]>0}_initPlugins(){const{style:t,featureStyle:e}=this.layer._getComputedStyle(),n=t.map(((t,e)=>{const n=t.renderPlugin;if(!n)return null;if(!n.type)throw new Error("invalid plugin type for style at "+e);const i=this._createRenderPlugin(n);return i.styleCounter=this._styleCounter,i.style=t,i})),i=[];e.forEach(((t,e)=>{const n=t.renderPlugin;if(!n)return null;if(!n.type)throw new Error("invalid plugin type for features at "+e);const o=this._createRenderPlugin(n);return o.style=t,o.styleCounter=this._styleCounter,i.push(o),o}));const o=this._styleCounter;return this._plugins[o]=n,this._featurePlugins[o]=i,this.layer.fire("pluginsinited"),(this._highlighted&&this._highlighted.size||this.layer._highlighted)&&(this.layer._highlighted&&this.layer._resumeHighlights(),this.getMap().getRenderer().callInNextFrame((()=>{this._getFramePlugins().forEach((t=>{t.highlight(this._highlighted)}))}))),n}_createRenderPlugin(t){const e=this.layer.constructor.getPlugins()[t.type];if(!e)throw new Error(`Plugin for (${t.type}) is not loaded.`);const n=new e;return n.config=t,n.config.sceneConfig||(n.config.sceneConfig={}),n}_createGLContext(t,e){const n=["webgl","experimental-webgl"];let i=null;for(let o=0;o<n.length;++o){try{i=t.getContext(n[o],e)}catch(t){}if(i)break}return i}_getCentiMeterScale(t){return oL(t,this.getMap())}debugFBO(t,e){const n=document.getElementById(t),i=e.width,o=e.height;n.width=i,n.height=o;const s=n.getContext("2d"),a=this.regl.read({framebuffer:e}),l=o/2|0,h=4*i;for(let t=0;t<a.length;t++)a[t]*=255;const c=new Uint8Array(4*i);for(let t=0;t<l;++t){const e=t*h,n=(o-t-1)*h;c.set(a.subarray(e,e+h)),a.copyWithin(e,n,n+h),a.set(c,n)}const u=new ImageData(i,o);u.data.set(a),s.putImageData(u,0,0)}_getDefaultRenderPlugin(t){let e;switch(t){case"native-line":e={type:"native-line",dataConfig:{type:"native-line",only2D:!0}};break;case"native-point":e={type:"native-point",dataConfig:{type:"native-point",only2D:!0}};break;case"fill":e={type:"fill",dataConfig:{type:"fill",only2D:!0},sceneConfig:{antialias:!0}};break;default:e=null}const n=function(t){switch(t){case"native-point":return{markerFill:"#f00",markerSize:6,markerOpacity:.5};case"native-line":return{lineColor:"#bbb",lineOpacity:.5};case"fill":return{polygonFill:"#76a6f0",polygonOpacity:.8}}return null}(t),i=this._createRenderPlugin(e);return i.defaultSymbol=n,{plugin:i,symbol:n,renderPlugin:e}}_isVisible(){return!0}isEnableWorkAround(t){return"win-intel-gpu-crash"===t&&this.layer.options.workarounds["win-intel-gpu-crash"]&&function(t){const e=t.getExtension("WEBGL_debug_renderer_info");if(e&&"undefined"!=typeof navigator){const n=t.getParameter(e.UNMASKED_RENDERER_WEBGL),i="Win32"===navigator.platform||"Win64"===navigator.platform;if(n&&n.toLowerCase().indexOf("intel")>=0&&i)return!0}return!1}(this.gl)}getZScale(){return this._zScale}outline(t,e){e&&(Array.isArray(e)||(e=[e]),this._outline||(this._outline=[]),this._outline.push(["paintOutline",[t,e]]),this.setToRedraw())}outlineFeatures(t){t&&(Array.isArray(t)||(t=[t]),this._outline||(this._outline=[]),this._outline.push(["paintOutline",[null,t]]),this.setToRedraw())}outlineBatch(t){this._outline||(this._outline=[]),this._outline.push(["paintBatchOutline",[t]]),this.setToRedraw()}outlineAll(){this._outlineAll=!0,this.setToRedraw()}paintOutlineAll(t){const e=this._getFramePlugins();for(let n=0;n<e.length;n++)e[n].outlineAll(t)}paintOutline(t,e,n){if(!eL(e)){const i=e,o=this._getFramePlugins();if(!o[i]||o[i].painter&&!o[i].painter.isVisible())return;return void o[i].outline(t,n)}const i=this._getFramePlugins();for(let e=0;e<n.length;e++){const o=n[e];for(let e=0;e<i.length;e++)i[e].style&&i[e].style.id===o&&i[e].outline(t,[o])}}paintBatchOutline(t,e){const n=this._getFramePlugins();!n[e]||n[e].painter&&!n[e].painter.isVisible()||n[e].outlineAll(t)}cancelOutline(){delete this._outline,delete this._outlineAll,this.setToRedraw()}setZIndex(){return this.setToRedraw(),this._needRetire=!0,super.setZIndex.apply(this,arguments)}consumeTile(t,e){if(t&&!t._empty){const[n,i]=this._findTileAltitude(t);e.minAltitude=n,e.maxAltitude=i}if(this._retirePrevTile(e),super.consumeTile(t,e),"transient"===this.layer.options.features&&t.data){for(let e=0;e<t.data.length;e++){if(!t.data[e])continue;const n=t.data[e].features;if(n)for(const t in n){const e=n[t]&&n[t].feature;e&&(e.fnTypeProps?e.customProps[IL]=e.fnTypeProps:n[t]=null)}}this.layer.fire("_transientfeature",{tileImage:t})}t&&t.features&&(t.features=[]),this._createOneTile(e,t)}_findTileAltitude(t){const e=t.data;let n=-1/0,i=1/0;for(let t=0;t<e.length;t++){if(!e[t])continue;const o=e[t].data;if(o)for(let t=0;t<o.length;t++){const e=o[t];if(!e||!e.properties)continue;const{maxAltitude:s,minAltitude:a}=e.properties;s>n&&(n=s),a<i&&(i=a)}}return eD[0]=i===1/0?0:i,eD[1]=n===-1/0?0:n,eD}onTileError(t,e){this._retirePrevTile(e),super.onTileError(t,e)}_retirePrevTile(t){const{id:e}=t;if(this._prevTilesInView&&this._prevTilesInView[e]){this.deleteTile(this._prevTilesInView[e]),delete this._prevTilesInView[e]}}highlight(t){if(this._highlighted||(this._highlighted=new Map),Array.isArray(t))for(let e=0;e<t.length;e++)eL(t[e].name)&&!eL(t[e].id)&&(t[e]=QR({},t[e]),t[e].name=t[e].id),this._highlighted.set(t[e].name,t[e]);else eL(t.name)&&!eL(t.id)&&((t=QR({},t)).name=t.id),this._highlighted.set(t.name,t);this._getFramePlugins().forEach((t=>{t.highlight(this._highlighted)})),this._highlightUpdated=!0}cancelHighlight(t){if(this._highlighted){if(Array.isArray(t))for(let e=0;e<t.length;e++)this._highlighted.delete(t[e]);else this._highlighted.delete(t);this._getFramePlugins().forEach((t=>{t.highlight(this._highlighted)})),this._highlightUpdated=!0}}cancelAllHighlight(){this._highlighted&&(delete this._highlighted,this._getFramePlugins().forEach((t=>{t.cancelAllHighlight()})),this._highlightUpdated=!0)}_getLayerOpacity(){const t=this.layer.options.opacity;return this._isInGroupGLLayer()?eL(t)?1:t:1}_isRenderingTerrain(){return!!this._terrainLayer&&this.layer.options.awareOfTerrain}};function sD(t){let e;Array.isArray(t.data)?(e=[],nL(e,t.data)):(e={},QR(e,t.data));const n=QR({},t);return n.data=e,n}function aD(t,e){return e.info.z-t.info.z}function lD(t){const e={};for(let n=0;n<t.length;n++){const i=t[n].layer||"default";e[i]||(e[i]=[]),e[i].push(t[n])}return e}function hD(t){if(Array.isArray(t)){const e=t;for(let t=0;t<e.length;t++)if(hD(e[t]))return!0}for(const e in t)if(mk(t[e])||YL.isExpression(t[e]))return!0;return!1}function cD(t){return{x:0,y:0,width:2*t,height:2*t}}function uD(t){if(!t.cache)return[];for(const e in t.cache){const n=t.cache[e];if(n.geometry)for(let t=0;t<n.geometry.length;t++){const e=n.geometry[t]&&n.geometry[t].geometry;if(e&&e.properties&&e.properties.features){const t=e.properties.features.empty;delete e.properties.features.empty;const n=Object.values(e.properties.features);return void 0!==t&&(e.properties.features.empty=t),n}}}return[]}function fD(t){return hs.getAbsoluteURL(t.url)}oD.include({calculateTileMatrix:function(){const t=new Array(3),e=new Array(3),n=new Array(3);return function(i,o,s){const a=this.getTileGLScale(o),l=i,h=this.layer.getTileSize().width,c=ay([]);return fy(c,c,Fy(t,a,a,this._zScale)),uy(c,c,Fy(e,l.x,l.y,0)),fy(c,c,Fy(n,h/s,-h/s,1)),c}}(),calculateTerrainTileMatrix:function(){const t=new Array(3);return function(e,n,i){const o=ay([]),s=i/2;return fy(o,o,Fy(t,1/s,-1/s,0)),uy(o,o,Fy(t,-s,-s,0)),o}}(),calculateTileTranslationMatrix:function(){const t=new Array(3);return function(e,n){const i=this.getTileGLScale(n),o=e,s=ay([]);return uy(s,s,Fy(t,o.x*i,o.y*i,0)),s}}()});const{PackUtil:dD}=ZR(),gD=new _e(0,0),pD=new gh(0,0),AD=[null,0],mD=[];let yD=class ht extends kp{static loadFrom(t,e){return fetch(t,e||{}).then((t=>t.json())).then((t=>ht.fromJSON(t)))}constructor(t,e){super(t,e),this._schema={},this.VERSION=ht.VERSION;this.setStyle(e&&e.style)}setURLModifier(t){this._urlModifier=t;const e=this.getRenderer();return e&&e.updateOptions(),this}getURLModifier(){return this._urlModifier}onAdd(){const t=this.getMap();this._prepareOptions();const e=this.getSpatialReference().toJSON().projection,n=t.getSpatialReference().toJSON().projection;if((e&&e.toLowerCase())!==(n&&n.toLowerCase()))throw new Error(`VectorTileLayer's projection(${e}) must be the same with map(${n}).`)}setFeatureState(t,e){if(eL(t.id))throw new Error("missing id in first parameter of setFeatureState.");this._featureStates||(this._featureStates={});const n=t.layer||"0";let i=this._featureStates[n];return this._featureStates[n]||(i=this._featureStates[n]=new Map),i.set(t.id,e),this._markFeatureState(),this}removeFeatureState(t,e){if(eL(t.id))throw new Error("missing id in first parameter of removeFeatureState.");if(!this._featureStates)return this;const n=this._featureStates[t.layer||"0"];if(!n)return this;if(e){const i=n.get(t.id);if(tL(e))for(const t in e)delete i[t];else delete i[e];n.set(t.id,i)}else n.delete(t.id);return this._markFeatureState(),this}getFeatureState(t){if(eL(t.id))throw new Error("missing id in first parameter of getFeatureState.");if(!this._featureStates)return null;return this._featureStates[t.layer||"0"].get(t.id)}_markFeatureState(){const t=this.getRenderer();if(!t)return;const e=t.getFrameTimestamp();this._featureStamp=e}_getFeatureStateStamp(){return this._featureStamp}_isFeatureStateDirty(t){return this._featureStamp&&this._featureStamp!==t}_prepareOptions(){const t=this.options,e=this.getMap().getProjection(),n="EPSG:4326"===e.code||"EPSG:4490"===e.code,i="EPSG:3857"===e.code;t.spatialReference||512===this.getTileSize().width&&(i?t.spatialReference="preset-vt-3857":n&&(t.spatialReference="preset-vt-4326")),t.tileSystem||(t.tms?i?t.tileSystem=[1,1,-6378137*Math.PI,-6378137*Math.PI]:n&&(t.tileSystem=[1,1,-180,-90]):n&&(t.tileSystem=[1,-1,-180,90]))}forceReload(){const t=this.getRenderer();return t&&t._incrWorkerCacheIndex(),super.forceReload()}onWorkerReady(){}onConfig(t){const e=this.getRenderer();e&&e.updateOptions(t)}getWorkerOptions(){return{debug:this.options.debug,debugTile:this.options.debugTile,altitudeProperty:this.options.altitudeProperty,tileSize:this.getTileSize().width,style:this.isDefaultRender()?{style:[],featureStyle:[]}:this._getComputedStyle(),features:this.options.debugTileData||this.options.features,schema:this.options.schema,pickingGeometry:this.options.pickingGeometry,projectionCode:this.getSpatialReference().getProjection().code,workerGlyph:this.options.workerGlyph&&!this.getURLModifier(),featureIdProperty:this.options.featureIdProperty}}setStyle(t){if(t&&(YR(t)||t.url)){const e=t,n=e.lastIndexOf("/"),i=n<0?".":e.substring(0,n);return this.ready=!1,lL.getJSON(t.url?t.url:t,t.url?t:{},((t,n)=>{if(t)throw this.setStyle([]),t;let o;n.style?(o=n,o.$root||(o.$root=i)):o={$root:i,style:n},this.options.style=e,this._setStyle(o)})),this}return this.options.style=t,this._setStyle(t),this}_tilePointToPoint(t,e,n,i){const o=i/this.getTileSize().width;return t.set(n.x+e.x/o,n.y-e.y/o)}queryTilePointTerrain(t,e,n,i,o){const s=this.getRenderer(),a=s&&s.getTerrainHelper();if(!s||!a)return AD[0]=null,AD[1]=0,AD;const l=this._tilePointToPoint(gD,t,n,i);return e&&a.queryTileTerrainByPointAtRes?a.queryTileTerrainByPointAtRes(l,o,e.id,e,mD):(AD[0]=null,AD[1]=0,AD)}queryTerrainTiles(t){const e=this.getRenderer(),n=e&&e.getTerrainHelper();return e&&n?n.getTerrainTiles(this,t):null}_setStyle(t){if(t&&t.$root){let e=t.$root;e&&"/"===e[e.length-1]&&(e=e.substring(0,e.length-1)),this._replacer=function(t){return"{$root}"===t?e:null}}this.ready=!0,t=t||[],Array.isArray(t)?t={style:t}:t.renderPlugin&&(t={style:[t]}),t=function(t){if(!t.plugins)return t;const{plugins:e,styles:n}=t;let{style:i,featureStyle:o}=n;i=i||[],o=o||[];const s=new Array(i.length);for(let t=0;t<i.length;t++)s[t]=QR({},i[t]),s[t].renderPlugin=e[i[t].renderPlugin];const a=new Array(o.length);for(let t=0;t<o.length;t++)a[t]=QR({},o[t]),a[t].renderPlugin=e[o[t].renderPlugin];const l={style:s,featureStyle:a};return t.$root&&(l.$root=t.$root),l}(t=HL(t)),this._originFeatureStyle=t.featureStyle||[],this._featureStyle=function(t){if(!t||!Array.isArray(t))return[];const e=[];for(let n=0;n<t.length;n++){const i=t[n].style;if(i&&Array.isArray(i)&&i.length)for(let o=0;o<i.length;o++){const s=QR({},t[n],i[o]);i[o]._renderIdx=e.length,delete s.style,e.push(s)}else e.push(QR({},t[n]))}return e}(t.featureStyle),this._vtStyle=t.style||[];const e=t.background||{};this._background={enable:e.enable||!1,color:vD(e.color)||[0,0,0,0],opacity:xD(e.opacity,1),patternFile:e.patternFile,depthRange:e.depthRange},this.validateStyle(),this._replacer&&this._parseStylePath(),this._compileStyle();const n=this.getRenderer();n&&n.setStyle(),this.fire("setstyle",{style:this.getStyle(),computedStyle:this.getComputedStyle()})}getPolygonOffsetCount(){const t=this.getRenderer();return t?t.getPolygonOffsetCount():0}getPolygonOffset(){return this._polygonOffset||0}setPolygonOffset(t,e){return this._polygonOffset=t,this._totalPolygonOffset=e,this}getTotalPolygonOffset(){return this._totalPolygonOffset}_convertTileFeatuers(t){for(let e=0,n=t.length;e<n;e++){const n=t[e];if(!n)continue;this._convertFeatures(n.features||[])}return t}_convertFeatures(t){if(!t||!t.length)return;const e=this._getTileConfig();let n;for(let i=0,o=t.length;i<o;i++){const{feature:o,tile:s}=t[i],a=o.geometry;if(!o||!s||!a)continue;if(a.type)continue;const{x:l,y:h,res:c,extent:u}=s;void 0===l&&void 0===h&&void 0===c||(n=e.getTilePointNW(l,h,c));const f=this._convertGeometry(o.type,a,n,u,c);o.geometry=f}}getCurrentRenderedFeatures(){const t=this.getRenderer();if(!t)return[];const e=t.getCurrentRenderedFeatures()||[];return this._convertTileFeatuers(e)}getRenderedFeatures(){const t=this.getRenderer();if(!t)return[];const e=t.getRenderedFeatures()||[];return this._convertTileFeatuers(e)}getRenderedFeaturesAsync(t={}){return new Promise(((e,n)=>{const i=this.getRenderer();if(i)if(qa){const n=i.getRenderedFeatures()||[],o=[];n.forEach((t=>{const e=t.features||[];e.length&&nL(o,e)}));const s=(t=Object.assign({},{countPerTime:1e4},t)).countPerTime,a=Math.ceil(o.length/s);let l=1;const h=()=>{const t=o.slice((l-1)*s,l*s);this._convertFeatures(t),l++};qa.runTaskAsync({count:a,run:h}).then((()=>{e(n)}))}else e(this.getRenderedFeatures());else e([])}))}outlineAll(){const t=this.getRenderer();return t?(t.outlineAll(),this):this}outline(t,e){const n=this.getRenderer();return n?(n.outline(t,e),this):this}outlineBatch(t){const e=this.getRenderer();return e?(e.outlineBatch(t),this):this}outlineFeatures(t){const e=this.getRenderer();return e?(e.outlineFeatures(t),this):this}cancelOutline(){const t=this.getRenderer();return t?(t.cancelOutline(),this):this}highlight(t){this._validateHighlight(t);const e=this.getRenderer();return e?(e.highlight(t),this):(this._highlighted||(this._highlighted=[]),this._highlighted.push(t),this)}_validateHighlight(t){if(Array.isArray(t))for(let e=0;e<t.length;e++)this._validateHighlight(t[e]);else{if(t.filter){if(!this.options.features)throw new Error("options.features must be turned on to support filter in highlight");if(!t.name)throw new Error("A name is required for highlight with filter")}if(eL(t.filter)&&eL(t.id))throw new Error("id or filter must be provided for highlight")}}_resumeHighlights(){if(this._highlighted){for(let t=0;t<this._highlighted.length;t++)this.highlight(this._highlighted[t]);delete this._highlighted}}cancelHighlight(t){const e=this.getRenderer();return e?(e.cancelHighlight(t),this):this}cancelAllHighlight(){const t=this.getRenderer();return t?(t.cancelAllHighlight(),this):this}_parseStylePath(){hs.convertStylePath(this._vtStyle,this._replacer),hs.convertStylePath(this._featureStyle,this._replacer)}updateSceneConfig(t,e){return YR(t)&&(t=this._getStyleIndex(t)),this._updateSceneConfig(0,t,e)}updateFeatureSceneConfig(t,e,n){return this._updateSceneConfig(1,t,n,e)}_updateSceneConfig(t,e,n,i){const o=this._getTargetStyle(t);if(!o)return this;let s,a=e;if(o[e].renderPlugin.sceneConfig||(o[e].renderPlugin.sceneConfig={}),QR(o[e].renderPlugin.sceneConfig,n),void 0!==i){bD(this._originFeatureStyle,e,i),a=this._originFeatureStyle[e].style[i]._renderIdx;const t=o[a].renderPlugin;t.sceneConfig||(t.sceneConfig={}),s=t.sceneConfig}else wD(o,e),s=o[e].renderPlugin.sceneConfig;if(QR(s,n),Array.isArray(this.options.style)){const t=this.options.style[e].renderPlugin;t.sceneConfig||(t.sceneConfig={}),QR(t.sceneConfig,n)}else{const o=this._getTargetStyle(t,this.options.style);let s;void 0!==i?(bD(o,e,i),s=o[e].style[i].renderPlugin):(wD(o,e),s=o[e].renderPlugin),s.sceneConfig||(s.sceneConfig={}),QR(s.sceneConfig,n)}const l=this.getRenderer();return l&&l.updateSceneConfig(t,a,n),0===t?this.fire("updatesceneconfig",{index:e,sceneConfig:n}):1===t&&this.fire("updatefeaturesceneconfig",{index:e,styleIdx:i,sceneConfig:n}),this}updateDataConfig(t,e){return YR(t)&&(t=this._getStyleIndex(t)),this._updateDataConfig(0,t,e)}updateFeatureDataConfig(t,e,n){return this._updateDataConfig(1,t,n,e)}_updateDataConfig(t,e,n,i){const o=this._getTargetStyle(t);if(!o)return this;let s,a=e;void 0!==i?(bD(this._originFeatureStyle,e,i),a=this._originFeatureStyle[e].style[i]._renderIdx,s=o[a].renderPlugin.dataConfig):(wD(o,e),s=o[e].renderPlugin.dataConfig);const l=QR({},s);if(QR(s,n),Array.isArray(this.options.style))QR(this.options.style[e].renderPlugin.dataConfig,n);else{const o=this._getTargetStyle(t,this.options.style);let s;void 0!==i?(bD(o,e,i),s=o[e].style[i].renderPlugin):(wD(o,e),s=o[e].renderPlugin),s.dataConfig||(s.dataConfig={}),QR(s.dataConfig,n)}const h=this.getRenderer();return h&&h.updateDataConfig(t,a,n,l),0===t?this.fire("updatedataconfig",{index:e,dataConfig:n}):1===t&&this.fire("updatefeaturedataconfig",{index:e,styleIdx:i,dataConfig:n}),this}updateSymbol(t,e){return YR(t)&&(t=this._getStyleIndex(t)),this._updateSymbol(0,t,e)}updateFeatureSymbol(t,e,n){return this._updateSymbol(1,t,n,e)}_updateSymbol(t,e,n,i){const o=this._getTargetStyle(t);if(!o)return this;let s=e;void 0!==i&&(bD(this._originFeatureStyle,e,i),s=this._originFeatureStyle[e].style[i]._renderIdx);const a=o[s];if(!a)throw new Error(`No style defined at ${e}`);const l=this,h=this._replacer;function c(n,o,s){if(!n)return!1;h&&(n=JSON.parse(JSON.stringify(n)),hs.parseSymbolPath(n,h));const a=Object.keys(n);let c=!1;for(let t=0;t<a.length;t++){const e=a[t];if(_D(o[e])||_D(n[e])){c=!0;break}}for(const t in n)rL(n,t)&&(!hs.isObject(n[t])||Array.isArray(n[t])||mk(n[t])?o[t]=n[t]:(o[t]||(o[t]={}),QR(o[t],n[t])));let u=l.options.style;if(YR(u))return c;Array.isArray(u)||(u=l._getTargetStyle(t,l.options.style));const f=JSON.parse(JSON.stringify(o));return void 0!==i?(bD(u,e,i),void 0===s?u[e].style[i].symbol=f:u[e].style[i].symbol[s]=f):(wD(u,e),void 0===s?u[e].symbol=f:u[e].symbol[s]=f),c}const u=this.getRenderer();if(!u)return c(),this._compileStyle(),this;let f=!1;const g=a.symbol;if(Array.isArray(n))for(let t=0;t<n.length;t++){const e=c(n[t],g[t],t);e&&(f=e)}else c(n,g);return this._compileStyle(),f?u.setStyle():(f=u.updateSymbol(t,s,n),f&&u.setStyle()),0===t?this.fire("updatesymbol",{index:e,symbol:n}):1===t&&this.fire("updatefeaturesymbol",{index:e,featureStyleIndex:i,symbol:n}),this}_getTargetStyle(t,e){return e?0===t?e.style:e.featureStyle:0===t?this._vtStyle:this._featureStyle}isDefaultRender(){return!!this._isDefaultRender&&this.options.defaultRendering}validateStyle(){this._isDefaultRender=!1;let t=this._vtStyle;this.options.style||(this._isDefaultRender=!0,t=this._vtStyle=[]),Array.isArray(t)||(t=this._vtStyle=[t]);for(let e=0;e<t.length;e++){let n=t[e].filter;if(n&&n.value&&(n=n.value),n||console.warn(`render plugin at ${e} doesn't define filter, its filter will be set to 'default' by default.`),void 0!==n&&"default"!==n&&!0!==n&&!Array.isArray(n)&&void 0===n.condition)throw new Error(`Invalid filter at ${e} : ${JSON.stringify(n)}`)}}getStyle(){return this.options.style?JSON.parse(JSON.stringify(this.options.style)):null}_getStyleIndex(t){const e=this._vtStyle;if(!e)return-1;for(let n=0;n<e.length;n++)if(e[n].name===t)return n;throw new Error(`No style defined with name: ${t}`)}getGroundConfig(){this._backgroundConfig||(this._backgroundConfig={enable:!0,renderPlugin:{type:"fill",sceneConfig:{}},symbol:{polygonFill:[0,0,0,0],polygonOpacity:1}});const t=this._getComputedStyle().background||{};return this._backgroundConfig.enable=t.enable,this._backgroundConfig.symbol.polygonFill=t.color,this._backgroundConfig.symbol.polygonOpacity=t.opacity,this._backgroundConfig.symbol.polygonPatternFile=t.patternFile,this._backgroundConfig.renderPlugin.sceneConfig.depthRange=t.depthRange,this._backgroundConfig}getComputedStyle(){return JSON.parse(JSON.stringify(this._getComputedStyle()))}_getComputedStyle(){return{background:this._background,style:this._vtStyle||[],featureStyle:this._featureStyle||[]}}identify(t,e={}){const n=this.getMap(),i=this.getRenderer();if(!n||!i)return[];const o=n.coordToContainerPoint(new gh(t));return this.identifyAtPoint(o,e)}identifyAtPoint(t,e={}){const n=this.getMap(),i=this.getRenderer();if(!n||!i)return[];const o=n.getDevicePixelRatio();let s=i.pick(t.x*o,t.y*o,e);return this.options.features&&"id"!==this.options.features&&(s=this._convertPickedFeature(s)),e&&e.filter?s.filter((t=>e.filter(t))):s}_convertPickedFeature(t){if(!this.getRenderer())return t;const e=this._getTileConfig(),n=this.getSpatialReference();for(let i=0;i<t.length;i++){let o=t[i];if(!o||!o.data)continue;const{tile:s}=o.data,{x:a,y:l,z:h,extent:c}=s,u=n.getResolution(h),f=e.getTilePointNW(a,l,u),g=o.data.feature&&o.data.feature.geometry;if(g){o.data=QR({},o.data),o.data.feature=QR({},o.data.feature);const t=o.data.feature.type;o.data.feature.type="Feature",o.data.feature.geometry=this._convertGeometry(t,g,f,c,u)}}return t}_convertGeometry(t,e,n,i,o){if(e.type&&e.coordinates)return e;let s,a;if(1===t)e.length<=1?(s="Point",a=this._convertGeometryCoords(e,n,i,o)||[]):(s="MultiPoint",a=this._convertGeometryCoords(e,n,i,o));else if(2===t)e.length<=1?(s="LineString",a=this._convertGeometryCoords(e,n,i,o)||[]):(s="MultiLineString",a=this._convertGeometryCoords(e,n,i,o));else if(3===t){a=[];let t=[],l=0;for(let s=0;s<e.length;s++)dD.calculateSignedArea(e[s])>0&&(l++,t&&t.length&&a.push(t),t=[]),t.push(this._convertGeometryCoords(e[s],n,i,o));t.length&&a.push(t),l<=1?(s="Polygon",a=a[0]):s="MultiPolygon"}return{type:s,coordinates:a}}_convertGeometryCoords(t,e,n,i){const o=n/this.getTileSize().width,s=this.getMap(),a=t=>{const n=[];tL(t)&&(t=[t]);for(let a=0,l=t.length;a<l;a++){const l=t[a];gD.x=e.x+l.x/o,gD.y=e.y-l.y/o,s.pointAtResToCoord(gD,i,pD),n.push(pD.toArray())}return 1===t.length?n[0]:n};if(tL(t))return a(t);const l=t.length;if(1===l)return a(t[0]);{let e=[];for(let n=0;n<l;n++)e.push(a(t[n]));return e}}getDataSchema(t){return this._schema||(this._schema={}),eL(t)||this._schema[t]||(this._schema[t]={}),eL(t)?this._schema:this._schema[t]}onRemove(){super.onRemove()}static fromJSON(t){return t&&"VectorTileLayer"===t.type?new ht(t.id,t.options):null}_compileStyle(){}static registerPlugin(t){ht.plugins||(ht.plugins={}),ht.plugins[t.type]=t}static getPlugins(){return ht.plugins||{}}static compressStyleJSON(t){return Array.isArray(t)&&t.length?function(t){Array.isArray(t)&&(t={style:t,featureStyle:[]});const e=[],n=[],i=[];sL(t.style,e,i),sL(t.featureStyle,n,i);const o={plugins:i,styles:{style:e,featureStyle:n}};return t.$root&&(o.$root=t.$root),o}(t):t}};function _D(t){return!(!t||!t.properties)}function vD(t){return t?(Array.isArray(t)||(t=KE(t).unitArray()),3===t.length&&t.push(1),t):null}function xD(t,e){return null==t?e:t}function bD(t,e,n){if(!t[e]||!t[e].style||!t[e].style[n])throw new Error(`No plugin defined at feature style of ${e} - ${n}`)}function wD(t,e){if(!t[e])throw new Error(`No plugin defined at style of ${e}`)}yD.prototype._getTileZoom=function(t){return t=Math.floor(t),kp.prototype._getTileZoom.call(this,t)},yD.registerJSONType("VectorTileLayer"),yD.mergeOptions({urlTemplate:null,renderer:"gl",altitudeProperty:"altitude",forceRenderOnZooming:!0,forceRenderOnMoving:!0,forceRenderOnRotating:!0,tileSize:[512,512],features:!1,schema:!1,cascadeTiles:!0,collision:!0,collisionBuffserSize:0,picking:!0,pickingPoint:!0,pickingGeometry:!1,glyphSdfLimitPerFrame:15,tileLimitPerFrame:1,loadingLimitOnInteracting:5,loadingLimit:0,antialias:!1,iconErrorUrl:null,collisionFrameLimit:1.5,defaultRendering:!0,textGamma:1,maxIconSize:254,workarounds:{"win-intel-gpu-crash":!1},pyramidMode:1,styleScale:1,enableAltitude:!0,fadeAnimation:!1,debugTileData:!1,fetchOptions:null,awareOfTerrain:!0,altitudeQueryTimeLimitPerFrame:3,workerGlyph:!0,featureIdProperty:null,currentTilesFirst:!0,tileStackStartDepth:3,tileStackDepth:2,altitudePropertyName:null,disableAltitudeWarning:!1}),yD.registerRenderer("gl",oD),yD.registerRenderer("canvas",null);const TD=new qn(1,1);let MD=class mt extends Wd{static registerPainter(t,e){mt.painters||(mt.painters={}),mt.painters[t]=e}static get3DPainterClass(t){return mt.painters[t]}setURLModifier(t){return this._urlModifier=t,this}getURLModifier(){return this._urlModifier}getEvents(){let t;return t=super.getEvents?super.getEvents():{},t.spatialreferencechange=this._onSpatialReferenceChange,t}onConfig(t){if(super.onConfig(t),void 0!==t.enableBloom){const e=this.getRenderer();e&&e.updateBloom(t.enableBloom)}}updateSymbol(t,e){if(!this.options.style)throw new Error("can't call update symbol when style is not set");const n=Array.isArray(this.options.style)?this.options.style:this.options.style.style;if(!n[t])throw new Error(`invalid style at ${t}`);return QR(n[t].symbol,e),this.setStyle(this.options.style),this}getPolygonOffsetCount(){return this.isEmpty()||this.options.altitude?0:1}getPolygonOffset(){return this.options.altitude?0:this._polygonOffset||0}setPolygonOffset(t,e){return this._polygonOffset=t,this._totalPolygonOffset=e,this}getTotalPolygonOffset(){return this._totalPolygonOffset}identify(t,e={}){const n=this.getMap(),i=this.getRenderer();if(!n||!i)return[];const o=n.coordToContainerPoint(new gh(t));return this.identifyAtPoint(o,e)}identifyAtPoint(t,e={}){const n=this.getMap(),i=this.getRenderer();if(!n||!i)return[];const o=this.getMap().getDevicePixelRatio(),s=i.pick(t.x*o,t.y*o,e);return e&&e.filter?s.filter((t=>e.filter(t))):s}getComputedStyle(){return{style:this.getStyle()||[]}}outlineAll(){const t=this.getRenderer();return t?(t.outlineAll(),this):this}outline(t){if(!Array.isArray(t)||!t.length)return this;const e=this.getRenderer();return e?(e.outline(t),this):this}cancelOutline(){const t=this.getRenderer();return t?(t.cancelOutline(),this):this}toJSON(){const t={type:this.getJSONType(),id:this.getId(),options:this.config(),geometries:[]},e=this.getGeometries();for(let n=0,i=e.length;n<i;n++){const i=e[n].toJSON();t.geometries.push(i)}return t}getTileSize(){return TD}_onSpatialReferenceChange(){const t=this.getRenderer();t&&t._onSpatialReferenceChange()}};MD.mergeOptions({picking:!0,pickingPoint:!0,renderer:"gl",collision:!1,collisionBufferSize:0,textGamma:1,geometryEvents:!0,styleScale:1,forceRenderOnZooming:!0,forceRenderOnMoving:!0,forceRenderOnRotating:!0,meshRenderOrder:0,enableBloom:!1,enableAltitude:!0,workarounds:{"win-intel-gpu-crash":!0}});const CD={redraw:!1,retire:!1},SD=[];let PD=1;function ID(t,e){const n=Jk.extend(t,{init:function(){this._meshCache={}},isVisible(){return this.painter&&this.painter.isVisible()},supportRenderMode:function(t){return this.painter.supportRenderMode(t)},hasMesh(){return this.painter&&this.painter.hasMesh()},startFrame:function(t){const n=t.sceneConfig;let i=this.painter;if(!i){i=this.painter=new e(t.regl,t.layer,t.symbol,n,t.pluginIndex,t.dataConfig)}this._meshCache||(this._meshCache={});const o=n.excludes;this._excludes?o!==this._excludes&&(this._excludesFunc=o?Nk(o):null,this._excludes=o):o&&(this._excludes=o),i.startFrame(t),this._frameCache={}},updateCollision:function(t){const e=this.painter;return e&&e.isVisible()?e.updateCollision(t):null},prepareRender:function(t){const e=this.painter;return e&&e.isVisible()?e.prepareRender(t):null},endFrame:function(t){const e=this.painter;return e&&e.isVisible()?e.render(t):null},getShadowMeshes(){const t=this.painter;return t&&t.getShadowMeshes&&t.getShadowMeshes()||SD},createTile:function(t){const{tileCache:e,tileData:n}=t;let i=!1;const o=this.painter;if(!o)return{retire:i};const s=this._getMeshKey(t);let a=e.geometry;if(!a){const s=n.features,l=n.data;if(!l||!l.length)return{retire:i};const h=l;if(this.painter.colorSymbol&&!function(t){if(!t)return!0;for(const e in t)return!1;return!0}(s))for(let t=0;t<l.length;t++){const e=this._generateColorArray(s,l[t].data.aPickingId,l[t].indices,l[t].data.aPosition,l[t].positionSize);l[t].data.aColor=e}a=e.geometry=o.createGeometries(h,s);for(let e=0;e<a.length;e++)a[e]&&a[e].geometry&&(i=!0,a[e].geometry.properties.features=s,this._fillCommonProps(a[e].geometry,t))}let l=this._getMesh(s);if(!l){const{meshes:e,retire:n}=this._createMeshes(a,t);i||(i=n),l=e}return{retire:i}},_createMeshes(t,e){const{tileInfo:n,tileExtent:i,tileTransform:o,tileTranslationMatrix:s,tileVectorTransform:a,tileZoom:l,sceneConfig:h}=e;let c=!1;const u=this.painter,f=u.createMeshes(t,o,{tileExtent:i,tilePoint:[n.extent2d.xmin,n.extent2d.ymax],tileZoom:l,tileTranslationMatrix:s,tileVectorTransform:a},e);if(f.length){for(let t=0;t<f.length;t++)f[t]&&(c=!0,this._fillMeshProps(f[t],o,e.timestamp,PD++,u.isEnableTileStencil()));h.animation&&(f._animationTime=e.timestamp);const t=this._getMeshKey(e);this._meshCache[t]=f}return{meshes:f,retire:c}},paintTile:function(t){const{tileCache:e,tileInfo:n,tileZoom:i,sceneConfig:o}=t,s=this.painter;if(!s)return CD;let a=e.geometry;if(!a)return CD;let l=!1;const h=this._getMeshKey(t);let c=this._getMesh(h);if(!c){const{meshes:e,retire:n}=this._createMeshes(a,t);l||(l=n),c=e}if(!c.length)return CD;const u=s.getTileLevelValue(n,i);c.forEach((t=>{t.properties.tile=n,t.properties.level=u}));let f=!1;if(!this._frameCache[h]){let e=null,n=o.animation;if(n){const i=t.sceneConfig.animationDuration||800,o=(t.timestamp-c._animationTime)/i;c._animationTime-c[0].properties.createTime<i&&o<1&&(!0!==n&&1!==n||(n="linear"),e="linear"===n?o:Lk(n,o),f=!0)}s.addMesh(c,e,t),this._frameCache[h]=1}return{redraw:f,retire:l}},_fillMeshProps:function(t,e,n,i,o){if(t.properties.tileTransform=e,t.properties.createTime=n,t.properties.meshKey=i,t.needUpdateShadow=!0,o){const e=t.defines||{};e.ENABLE_TILE_STENCIL=1,t.setDefines(e)}"stencilRef"in t.uniforms||Object.defineProperty(t.uniforms,"stencilRef",{enumerable:!0,get:function(){return t.properties.tile&&void 0!==t.properties.tile.stencilRef?t.properties.tile.stencilRef:t.properties.level}})},_fillCommonProps:function(t,e){const{layer:n,tileInfo:i}=e,o=n.getMap(),s=(n.getSpatialReference?n.getSpatialReference():o.getSpatialReference()).getResolution(i.z),a=e.tileExtent/n.getTileSize().width;t.properties.tileResolution=s,t.properties.tileRatio=a,t.properties.z=i.z,t.properties.tileExtent=e.tileExtent},updateSceneConfig:function(t){const e=this.painter;e&&e.updateSceneConfig(t.sceneConfig)},updateDataConfig:function(t,e){const n=this.painter;return!n||n.updateDataConfig(t,e)},updateSymbol:function(t,e){const n=this.painter;if(!n)return!1;if(n.shouldDeleteMeshOnUpdateSymbol(t)){if(this._meshCache)for(const t in this._meshCache)n.deleteMesh(this._meshCache[t],!0);delete this._meshCache,delete this._frameCache}return n.updateSymbol(t,e)},pick:function(t,e,n){return this.painter&&this.painter.pick?this.painter.pick(t,e,n):null},deleteTile:function(t){if(!this._meshCache)return;const e=this._getMeshKey(t),n=this._meshCache[e];n&&this.painter&&this.painter.deleteMesh(n),delete this._meshCache[e],this._frameCache&&delete this._frameCache[e]},remove:function(){const t=this.painter;if(t&&this._meshCache){for(const e in this._meshCache)t.deleteMesh(this._meshCache[e]);t.delete(),delete this.painter}delete this._meshCache,delete this._frameCache},resize:function(t,e){const n=this.painter;n&&n.resize(t,e)},needToRedraw:function(){return!!this.painter&&this.painter.needToRedraw()},needToRetireFrames:function(){return!!this.painter&&this.painter.needToRetireFrames()},isAnimating(){return!!this.painter&&this.painter.isAnimating()},needToRefreshTerrainTileOnZooming:function(){return!!this.painter&&this.painter.needToRefreshTerrainTileOnZooming()},isTerrainSkin:function(){return!!this.painter&&this.painter.isTerrainSkin()},isTerrainVector:function(){return!!this.painter&&this.painter.isTerrainVector()},_generateColorArray:function(t,e,n,i,o=3){if(!i||!t||!e.length)return null;const s=new Uint8Array(i.length/o*4);let a,l;const h=this.painter.colorSymbol,c={};let u;for(let n=0,i=e.length;n<i;n++){const i=e[n];if(a=t[i].symbol,l=c[i],!l)if(h){let e;e="function"==typeof h?h(t[i].feature&&t[i].feature.properties):h,e=KE(e),l=c[i]=e.array()}else l=c[i]=[255,255,255];u=4*n,s[u]=l[0],s[u+1]=l[1],s[u+2]=l[2],s[u+3]=255*(a[this.painter.opacitySymbol]||1)}return s},_getMeshKey:function(t){const e=t.tileInfo;return e.meshKey||(e.meshKey=PD++),e.meshKey},_getMesh:function(t){return this._meshCache[t]},_filterElements(t,e){if(Array.isArray(t))t.forEach(((t,n)=>{const{features:i}=t.properties;this._filterGeoElements(t,e[n],i)}));else{const{features:n}=t.properties;this._filterGeoElements(t,Array.isArray(e)?e[0]:e,n)}},_filterGeoElements(t,e,n){const i=e.featureIndexes||e.data.featureIndexes;if(i)if(this._excludesFunc){const o=e.indices;let s=null,a=!1;const l=[];for(let t=0;t<o.length;t++){null!==s&&s===o[t]||(a=this._excludesFunc(n[i[o[t]]].feature),s=o[t]),a||l.push(o[t])}t.setElements(new e.indices.constructor(l))}else t.setElements(e.indices)},outline(t,e){const n=this.painter;n&&n.outline(t,e)},outlineAll(t){const e=this.painter;e&&e.outlineAll(t)},needPolygonOffset(){const t=this.painter;return t&&t.needPolygonOffset()},highlight(t){const e=this.painter,n=this.style.name,i=this.renderIndex;if(t){const e=[];if(t.forEach(((t,o)=>{null!=t.plugin&&(Array.isArray(t.plugin)?t.plugin.length&&t.plugin.indexOf(n)<0&&t.plugin.indexOf(i)<0&&e.push(o):t.plugin!==n&&t.plugin!==i&&e.push(o))})),e.length){const n=new Map(t);for(let t=0;t<e.length;t++)n.delete(e[t]);t=n}}return e&&e.highlight(t)},cancelAllHighlight(){const t=this.painter;return t&&t.cancelAllHighlight()}});return n}function OD(t){return!t||(void 0!==t.empty||(t.empty=function(t){for(const e in t)return!1;return!0}(t)),t.empty)}const{StyleUtil:ED}=ZR(),kD="_fn_type_",RD="__current_fn_types";function LD(t,e,n,i){if(!OD(t.properties.features))for(let o=0;o<n.length;o++){const{symbolName:s}=n[o];(t[RD]=t[RD]||{})[s]=e[s],DD(t,e,n[o],i)}}function DD(t,e,n,i){const o=function(t){const e=t.properties;let n=e.aPickingId;return n||(n=e.aPickingId=new t.data.aPickingId.constructor(t.data.aPickingId)),n}(t),{attrName:s,symbolName:a,related:l}=n;let h=t.data[s];return h?WD(e[a])||function(t,e){if(!Array.isArray(t))return!1;for(let n=0;n<t.length;n++)if(WD(e[t[n]]))return!0;return!1}(l,e)?(WD(e[a])&&FD(t,e,n),h):(void 0===n.index&&(t.deleteData(s),ND(t,s)),null):WD(e[a])&&function(t,e){return!(t.startsWith("marker")&&!e.properties.iconAtlas)&&!(t.startsWith("text")&&!e.properties.glyphAtlas)}(a,t)?(h=t.data[s]=new n.type(n.width*o.length),function(t,e,n,i,o){const{attrName:s}=i,a=(kD+s+"Index").trim();FD(e,n,i);jD(e,e.properties[a],i,o)}(0,t,e,n,i),h):null}function FD(t,e,n){const{attrName:i,symbolName:o}=n,s=t.properties,a=(kD+i+"Index").trim(),l=(kD+i).trim();if(s[a]&&s[l])return;const h=function(t){if(!t)return GD;const e=[];for(let n=0;n<t.length;n++)mk(t[n][1])&&!_k(t[n][1]).isZoomConstant&&e.push(t[n][0]);return e}(e[o].stops),c="identity"===e[o].type&&ED.checkIfIdentityZoomDependent(o,e[o].property,s.features);if(!c&&!h.length)return void(void 0===n.index&&ND(t,i));const{features:u,aPickingId:f}=s,g=function(t,e,n,i,o){const s=[];let a=0,l=e[0];for(let h=1,c=e.length;h<c;h++)!t[l]||e[h]===l&&h!==c-1||((o||zD(t[l].feature,n,i))&&s.push(a,h===c-1?c:h),l=e[h],a=h);return s}(u,f,e[o].property,h,c);if(!g.length)return void(void 0===n.index&&ND(t,i));if(s[a]=g,s[l])return;const A=t.data[i];s[l]=A.BYTES_PER_ELEMENT?new A.constructor(A):new n.type(A.length)}function ND(t,e){const n=t.properties,i=(kD+e+"Index").trim(),o=(kD+e).trim();delete n[i],delete n[o]}function HD(t,e,n,i,o,s){if(!o)return;const a=o.geometry;if(a&&!OD(a.properties.features)){for(let l=0;l<i.length;l++){const h=i[l],c=h.attrName;if(!(BD(a,n,h)||e._isFeatureStateDirty&&e._isFeatureStateDirty(o.geometry._featureTimestamp))){const{aPickingId:t}=a.properties;if(!t||a._fnDataZoom===s)continue;const n=(kD+c+"Index").trim(),i=a.properties[n];if(!i)continue;jD(a,i,h,e);continue}const u=DD(a,n,h,e),f=h.define;if(u){const n=(kD+c+"Index").trim();if(jD(a,a.properties[n],h,e),e._getFeatureStateStamp&&(a._featureTimestamp=e._getFeatureStateStamp()),f){const t=o.defines;t[f]=1,o.setDefines(t)}a.generateBuffers(t)}else if(f){const t=o.defines;t[f]&&(delete t[f],o.setDefines(t))}}a._fnDataZoom=s}}function BD(t,e,n){const i=e[n.symbolName],o=t[RD];return!PC(i,o[n.symbolName])&&(o[n.symbolName]=i,!0)}function zD(t,e,n){for(let i=0;i<n.length;i++)if("$"===e[0]&&t[e.substring(1)]===n[i]||t.properties[e]===n[i])return!0;return!1}const GD=[];function jD(t,e,n,i){const{attrName:o,evaluate:s,index:a,width:l}=n,{aPickingId:h,features:c}=t.properties;let u;if(e){const n=(kD+o).trim();u=t.properties[n];const f=l,g=e.length;for(let n=0;n<g;n+=2){const o=e[n];let l=c[h[o]];l&&l.feature&&VD(u,l,s,o,e[n+1],f,a,t,i)}}else{if(u=t.data[o],function(t){return Array.isArray(t)||t.constructor===Float32Array||t.constructor===Float64Array||t.constructor===Uint8Array||t.constructor===Int8Array||t.constructor===Uint16Array||t.constructor===Int16Array||t.constructor===Uint32Array||t.constructor===Int32Array||t.constructor===Uint8ClampedArray}(u))u.dirty=!0;else{const e=(kD+o).trim();u=t.properties[e],u||(u=t.properties[e]=new n.type(n.width*h.length),u.dirty=!0)}const e=u.length/h.length,l=h.length;let f=0;for(let n=0;n<l;n++){if(h[n]===h[f]&&n<l-1)continue;let o=c[h[f]];o&&o.feature&&(VD(u,o,s,f,n===l-1?l:n,e,a,t,i),f=n)}}u.dirty&&(t.updateData(o,u),u.dirty=!1)}const UD={};function VD(t,e,n,i,o,s,a,l,h){const c=(e=e.feature).properties||{};if(void 0===c.$layer&&(e.properties||(e.properties=c),c.$layer=e.layer,c.$type=e.type),h.getFeatureState&&(UD.layer=e.layer,UD.id=e.id,e[OL]&&(e[OL]=null),!NL(e.id))){const t=h.getFeatureState(UD);e.properties[OL]=t}const u=n(c,l,t,i*s);if(Array.isArray(u)){let e=!1;for(let n=0;n<s;n++)if(t[i*s+n]!==u[n]){e=!0;break}if(e){for(let e=i*s;e<o*s;e+=s)t.set(u,e);t.dirty=!0}}else if(s>1)for(let e=i*s;e<o*s;e+=s)t[e+a]!==u&&(t[e+a]=u,t.dirty=!0);else t[i]!==u&&(VL(t,u,i,o),t.dirty=!0)}function WD(t){return ED.isFnTypeSymbol(t)}var ZD=qD;function qD(t,e){this.x=t,this.y=e}qD.prototype={clone:function(){return new qD(this.x,this.y)},add:function(t){return this.clone()._add(t)},sub:function(t){return this.clone()._sub(t)},multByPoint:function(t){return this.clone()._multByPoint(t)},divByPoint:function(t){return this.clone()._divByPoint(t)},mult:function(t){return this.clone()._mult(t)},div:function(t){return this.clone()._div(t)},rotate:function(t){return this.clone()._rotate(t)},rotateAround:function(t,e){return this.clone()._rotateAround(t,e)},matMult:function(t){return this.clone()._matMult(t)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(t){return this.x===t.x&&this.y===t.y},dist:function(t){return Math.sqrt(this.distSqr(t))},distSqr:function(t){var e=t.x-this.x,n=t.y-this.y;return e*e+n*n},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(t){return Math.atan2(this.y-t.y,this.x-t.x)},angleWith:function(t){return this.angleWithSep(t.x,t.y)},angleWithSep:function(t,e){return Math.atan2(this.x*e-this.y*t,this.x*t+this.y*e)},_matMult:function(t){var e=t[2]*this.x+t[3]*this.y;return this.x=t[0]*this.x+t[1]*this.y,this.y=e,this},_add:function(t){return this.x+=t.x,this.y+=t.y,this},_sub:function(t){return this.x-=t.x,this.y-=t.y,this},_mult:function(t){return this.x*=t,this.y*=t,this},_div:function(t){return this.x/=t,this.y/=t,this},_multByPoint:function(t){return this.x*=t.x,this.y*=t.y,this},_divByPoint:function(t){return this.x/=t.x,this.y/=t.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var t=this.y;return this.y=this.x,this.x=-t,this},_rotate:function(t){var e=Math.cos(t),n=Math.sin(t),i=n*this.x+e*this.y;return this.x=e*this.x-n*this.y,this.y=i,this},_rotateAround:function(t,e){var n=Math.cos(t),i=Math.sin(t),o=e.y+i*(this.x-e.x)+n*(this.y-e.y);return this.x=e.x+n*(this.x-e.x)-i*(this.y-e.y),this.y=o,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},qD.convert=function(t){return t instanceof qD?t:Array.isArray(t)?new qD(t[0],t[1]):t};var XD=function(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}(ZD);const JD=[];function QD(t,e,n,i,o){return g_(JD,e[0],e[1],e[2],1),S_(JD,JD,n),t[2]=JD[3],__(JD,JD,1/JD[3]),t[0]=(JD[0]+1)*i/2,t[1]=(1-JD[1])*o/2,t}const YD=[],KD=[],$D=[],tF=[-99999,-99999],eF=new _e(0,0),nF=[];function iF(t,e,n,i,o,s,a,l){const{res:h,extent:c,extent2d:u}=n.properties.tile,{xmin:f,ymax:g}=u,A=f+i.x*o,m=g-i.y*o;let w=null;if(l)for(let t=0;t<l.length;t++)if(rF(l[t],A,m,h)){w=l[t];break}if(!w)return tF;const T=eF.set(f,g),M=s.queryTilePointTerrain(i,w,T,c,h),C=null===M[0]?ML:M[0];if(C){let n=Fy(nF,i.x,i.y,0);return n[2]+=100*C,n=QD(t,n,a,e.width,e.height),n}return t[0]=i.x,t[1]=i.y,t}function rF(t,e,n,i){const o=eF.set(e,n)._multi(i/t.res);return t.extent2d.contains(o)}const{SYMBOLS_NEED_REBUILD_IN_VT:oF,StyleUtil:sF,FuncTypeUtil:aF}=ZR(),{loginIBLResOnCanvas:lF,logoutIBLResOnCanvas:hF,getIBLResOnCanvas:cF}=xC.PBRUtils,uF="__gl_textures",fF=[],dF=new _e(0,0),gF=new _e(0,0),pF=new Float32Array(1),AF=[],mF=t=>0===t.properties.level,yF=t=>t.properties.level>0;let _F=class fn{static getBloomSymbol(){return["bloom"]}constructor(t,e,n,i,o,s){this._is2D=!0,this.regl=t,this.layer=e,this.canvas=t._gl.canvas,this.sceneConfig=i||{},this.dataConfig=s||{},this.pluginIndex=o,this.scene=new _w,this.pickingFBO=e.getRenderer().pickingFBO,this.level0Filter=mF,this.levelNFilter=yF,this.loginTextureCache(),this.symbolDef=Array.isArray(n)?n.map((t=>HL(t))):[HL(n)],this._compileSymbols(),this.pickingViewport={x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1},this.sortByCommandKey=vF.bind(this),this.colorCache={},this._invisibleWhenCreated=this.symbolDef.map((t=>!(!t||!1!==t.visible)))}hasMesh(){const t=this.scene&&this.scene.getMeshes();return this.isVisible()&&t&&!!t.length}getMap(){return this.layer?this.layer.getMap():null}getTileLevelValue(t,e){const n=this.layer.getRenderer();return n.getTileLevelValue&&n.getTileLevelValue(t,e)||0}getAnalysisMeshes(){return this.getShadowMeshes?this.getShadowMeshes():AF}isVisible(){const{minZoom:t,maxZoom:e}=this.sceneConfig,n=this.getMap().getZoom();if(!NL(t)&&n<t)return!1;if(!NL(e)&&n>e)return!1;const i=this._visibleFn;if(i.length)for(let t=0;t<i.length;t++)if(i[t]&&!i[t].isFeatureConstant)return!0;const o=this.getSymbols();for(let t=0;t<o.length;t++){const e=o[t].visible;if(!1!==e&&0!==e)return!0}return!1}isMeshVisible(t){const e=t&&t.properties&&t.properties.symbolIndex;if(!e)return!1;const n=this._visibleFn,i=e.index;let o;if(n[i]){if(!n[i].isFeatureConstant)return!0;o=n[i](this.getMap().getZoom())}else o=this.getSymbol(e).visible;return!1!==o&&0!==o}isAnimating(){return!1}needToRedraw(){return this.isAnimating()||this._redraw}needToRetireFrames(){return this._needRetire}needToRefreshTerrainTileOnZooming(){return!0}isTerrainSkin(){return this.layer.options.awareOfTerrain}isTerrainVector(){return!1}isShadowIncludeChanged(t){const e=t&&t.isRenderingTerrain&&this.isTerrainSkin();return t&&t.states&&t.states.includesChanged.shadow||e&&this._includeKeys}fillIncludes(t,e,n){if(delete this._includeKeys,n&&n.isRenderingTerrain&&this.isTerrainSkin())return;const i=n&&n.includes;if(i){let o="";for(const s in i)i[s]&&(o+=s,n[s].uniformDeclares&&e.push(...n[s].uniformDeclares),n[s].defines&&LL(t,n[s].defines));this._includeKeys=o}}setIncludeUniformValues(t,e){if(e&&e.isRenderingTerrain&&this.isTerrainSkin())return;const n=e&&e.includes;if(n)for(const i in n)n[i]&&e[i].renderUniforms&&LL(t,e[i].renderUniforms)}createGeometries(t,e){if(!t.length)return AF;const n=[];for(let i=0;i<t.length;i++)if(t[i])if(void 0!==t[i].ref)n.push(n[t[i].ref]?{geometry:n[t[i].ref].geometry,symbolIndex:t[i].symbolIndex,ref:t[i].ref}:null);else{t[i]&&!t[i].is2D&&(this._is2D=!1);const o=this.createGeometry(t[i],e,i);if(o&&o.geometry){const s=o.geometry.properties,{feaIdToPickingIdMap:a,pickingIdToFeaIdMap:l,hasFeaIds:h}=this._getIdMap(t[i]);h&&(s.feaIdPickingMap=a,s.feaPickingIdMap=l),s.symbolIndex=o.symbolIndex,s.features=e,s.is2D=t[i].is2D,s.layer=this.layer,s.positionBounding=t[i].positionBounding,this.postCreateGeometry(o,n)}n.push(o)}return n}isOnly2D(){return this._is2D}postCreateGeometry(){}_getIdMap(t){if(!t)return{};if(Array.isArray(t)&&!(t=t[0]))return{};const e=t.featureIds,n={},i={},o=e&&e.length;if(o)for(let o=0;o<e.length;o++){const s=t.data.aPickingId[o];void 0===n[s]&&(n[s]=e[o],i[e[o]]||(i[e[o]]=[]),i[e[o]].push(t.data.aPickingId[o]))}return{hasFeaIds:o,pickingIdToFeaIdMap:n,feaIdToPickingIdMap:i}}createGeometry(){throw new Error("not implemented")}createMeshes(t,e,n,i){const o=this.layer.options.awareOfTerrain,s=[];for(let a=0;a<t.length;a++){if(!t[a])continue;if(o&&i&&i.isRenderingTerrain&&this.isTerrainVector()){const e=t[a],n=e&&e.geometry;this._updateTerrainAltitude(n,n.data,n.properties,n.positionSize||n.desc.positionSize,i)}let l=this.createMesh(t[a],e,n,i||{});Array.isArray(l)?(l=l.filter((t=>!!t)),s.push(...l)):l&&s.push(l)}return s}createMesh(){throw new Error("not implemented")}getAltitudeOffsetMatrix(){const t=100*(this.dataConfig.altitudeOffset||0),e=ay([]);return Fy(fF,0,0,t),uy(e,e,fF),e}isBloom(t){return!!this.getSymbol(t.properties.symbolIndex).bloom}forbiddenTerrainUpscale(){return!0}addMesh(t,e,n){if(n.isRenderingTerrain&&this.isTerrainSkin()&&this.forbiddenTerrainUpscale()){const t=this.getMap().getResolution();if(n.tileInfo.res/t>3)return}const i=n.isRenderingTerrain&&this.isTerrainVector(),o=this.getRenderFBO(n);t=t.filter((t=>this.isMeshVisible(t))),i&&(t=t.filter((t=>t.geometry&&t.geometry.data.aTerrainAltitude)));const s=void 0===this.sceneConfig.castShadow||!!this.sceneConfig.castShadow,a=!(!n||!n.bloom);t.forEach((t=>{const e=this.isBloom(t)&&a;t.bloom=e,t.castShadow=s;let l=!1;const h=t.defines||{};if(!!h.HAS_BLOOM!==e&&(l=!0,e?h.HAS_BLOOM=1:delete h.HAS_BLOOM),i){if(t.geometry.data.aTerrainAltitude){const e=t.geometry;this._updateTerrainAltitude(e,e.data,e.properties,e.desc.positionSize,n)}t.geometry.data.aTerrainAltitude&&!h.HAS_TERRAIN_ALTITUDE&&(h.HAS_TERRAIN_ALTITUDE=1,l=!0)}else h.HAS_TERRAIN_ALTITUDE&&(delete h.HAS_TERRAIN_ALTITUDE,l=!0);l&&t.setDefines(h),o?t.setUniform("targetFramebuffer",o):t.uniforms.targetFramebuffer&&(t.uniforms.targetFramebuffer=null),this._highlightMesh(t)})),this.scene.addMesh(t)}updateCollision(){}render(t){return this.pluginIndex=t.pluginIndex,this.polygonOffsetIndex=t.polygonOffsetIndex,this.paint(t),{redraw:this._redraw,drawCount:this._drawCount}}prepareRender(t){if(this._currentTimestamp===t.timestamp)return;if(!this.createFnTypeConfig)return;const e=this.scene.getMeshes();if(!e||!e.length)return;const n=t&&t.sceneFilter,i=this.getMap().getZoom();for(let o=0;o<e.length;o++){if(!e[o]||!e[o].geometry)continue;if(n&&!n(e[o]))continue;const{symbolIndex:s}=e[o].properties,a=this.getSymbolDef(s);if(!a)continue;this._currentTimestamp=t.timestamp;const l=this.getFnTypeConfig(s);HD(this.regl,this.layer,a,l,e[o],i)}}paint(t){const e=this.layer.getMap();if(!e)return{redraw:!1};this._renderContext=t;const n=this.getUniformValues(e,t);return this.callShader(n,t),{redraw:this._redraw}}setToRedraw(t){t&&(this._needRetire=t),this._redraw=!0}callShader(t,e){this.callCurrentTileShader(t,e),this.callBackgroundTileShader(t,e)}callCurrentTileShader(t,e){this.shader&&(this.shader.filter=e&&e.sceneFilter?[this.level0Filter,e.sceneFilter]:this.level0Filter),this.callRenderer(this.shader,t,e)}callBackgroundTileShader(t,e){this.shader&&(this.shader.filter=e&&e.sceneFilter?[this.levelNFilter,e.sceneFilter]:this.levelNFilter),this.scene.getMeshes().sort(xF),this.callRenderer(this.shader,t,e)}callRenderer(t,e,n){const i=this.scene.getMeshes(),o=[];i.forEach((t=>{t.properties.hlBloomMesh&&n&&n.bloom&&o.push(t.properties.hlBloomMesh),o.push(t)})),this._setLayerUniforms(e),this.scene.setMeshes(o),e.painterContext=n,this._drawCount+=this.renderer.render(t,e,this.scene,this.getRenderFBO(n)),this.scene.setMeshes(i)}_setLayerUniforms(t){const e=this.layer.options.altitude||0,n=this.layer.getRenderer();t.layerOpacity=n._getLayerOpacity(),t.minAltitude=e}getRenderFBO(t){return t&&t.renderTarget&&t.renderTarget.fbo}needPolygonOffset(){return!1}needRebuildOnGometryPropertiesChanged(){return!0}onFeatureChange(){}getPolygonOffset(){const t=this.layer;return{factor:()=>t.getPolygonOffset()+(this.polygonOffsetIndex||0),units:()=>t.getPolygonOffset()+(this.polygonOffsetIndex||0)}}getBlendFunc(){return{src:()=>this.sceneConfig.blendSrc||"one",dst:()=>this.sceneConfig.blendDst||"one minus src alpha"}}pick(t,e,n=3){if(!this.layer.options.picking||!1===this.sceneConfig.picking)return null;if(!this.pickingFBO||!this.picking)return null;const i=this.getMap(),o=this.getUniformValues(i);this._setLayerUniforms(o);for(let s=0;s<this.picking.length;s++){const a=this.picking[s];a.render(this.scene.getMeshes(),o,!0);let l={};a.getRenderedMeshes().length&&(l=a.pick(t,e,n,o,{viewMatrix:i.viewMatrix,projMatrix:i.projMatrix,returnPoint:this.layer.options.pickingPoint&&!1!==this.sceneConfig.pickingPoint,logDepthBufFC:2/(Math.log(i.cameraFar+1)/Math.LN2)}));const{meshId:h,pickingId:c,point:u}=l,f=(0===h||h)&&a.getMeshAt(h);if(!f||!f.geometry)continue;let g=f.geometry.properties;g.features||(g=f.properties),u&&u.length&&(u[0]=Math.round(1e5*u[0])/1e5,u[1]=Math.round(1e5*u[1])/1e5,u[2]=Math.round(1e5*u[2])/1e5);const A={data:this._convertProxyFeature(g&&g.features&&g.features[c]),point:u,coordinate:l.coordinate,plugin:this.pluginIndex};return NL(f.properties.nodeIndex)||(A.data||(A.data={}),A.data.nodeIndex=f.properties.nodeIndex),A}return null}_convertProxyFeature(t){const e=t&&t.feature;if(!e||!e.customProps)return t;const n=LL({},t);return n.feature=LL({},t.feature),delete n.feature.customProps,n.feature.properties=LL({},e.properties,e.properties[IL],e.properties[OL]),delete n.feature.properties[OL],delete n.feature.properties[IL],delete n.feature.properties.$layer,delete n.feature.properties.$type,n}updateSceneConfig(){}updateDataConfig(t){return LL(this.dataConfig,t),!0}deleteMesh(t,e){if(t)if(this.scene.removeMesh(t),Array.isArray(t))for(let n=0;n<t.length;n++){if(!t[n].isValid())continue;const i=t[n].geometry;!e&&i&&i.dispose(),t[n].material&&t[n].material.dispose(),t[n].dispose(),eE.deleteHighlightBloomMesh(t[n])}else{if(!t.isValid())return;!e&&t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose(),t.dispose(),eE.deleteHighlightBloomMesh(t)}}startFrame(t){this._inited||(this.init(t),this._inited=!0),this._currentTimestamp!==t.timestamp&&(this._redraw=!1,this._needRetire=!1,this._drawCount=0),this.scene.clear()}resize(){}delete(){if(this.scene.clear(),this.shader&&this.shader.dispose(),this.picking){for(let t=0;t<this.picking.length;t++)this.picking[t].dispose();delete this.picking}if(this._outlineShaders){for(let t=0;t<this._outlineShaders.length;t++)this._outlineShaders[t].dispose();delete this._outlineShaders}delete this._terrainAltitudeCache,this.logoutTextureCache()}updateSymbol(t,e){Array.isArray(t)||(t=[t],e=[e]);let n=!1;for(let i=0;i<t.length;i++)if(t[i]){const o=this._updateChildSymbol(i,t[i],e[i]);o&&(n=o)}return delete this._fnTypeConfigs,this.setToRedraw(!1),n}_isNeedRefreshStyle(t,e){for(const n in e)if(qL(e,n)){if(sF.isFnTypeSymbol(e[n])&&!this.layer.options.features&&(!t[n]||t[n].property!==e[n].property))return!0;if(oF[n]&&!PC(e[n],t[n]))return!0}return!1}_updateChildSymbol(t,e,n){if(!this._symbol)return!1;const i=this._isNeedRefreshStyle(this.symbolDef[t]||{},n);if(this._invisibleWhenCreated[t]&&!1!==n.visible)return this._invisibleWhenCreated[t]=!1,!0;this.symbolDef[t]=HL(n);const o=this._symbol[t];for(const t in o)delete o[t];const s=this.getMap(),a=[],l=aF.loadSymbolFnTypes(this.symbolDef[t],(()=>(a[0]=s.getZoom(),a)));for(const t in l){const e=Object.getOwnPropertyDescriptor(l,t);e.get?Object.defineProperty(o,t,{get:e.get,set:e.set,configurable:!0,enumerable:!0}):o[t]=l[t]}return mk(n.visible)&&(this._visibleFn[t]=_k(n.visible)),i}getSymbolDef(t){return this.symbolDef[t.index]}getSymbols(){return this._symbol}getSymbol(t){return this._symbol[t.index]}_compileSymbols(){const t=this.getMap(),e=[],n=()=>(e[0]=t.getZoom(),e);this._symbol=[],this._visibleFn=[];for(let t=0;t<this.symbolDef.length;t++)this._symbol[t]=aF.loadSymbolFnTypes(LL({},this.symbolDef[t]),n),this.symbolDef[t]&&mk(this.symbolDef[t].visible)&&(this._visibleFn[t]=_k(this.symbolDef[t].visible))}getFnTypeConfig(t){this._fnTypeConfigs||(this._fnTypeConfigs=[]);const e=t.index;if(!this._fnTypeConfigs[e]){const n=this.getSymbolDef(t),i=this.getMap();this._fnTypeConfigs[e]=this.createFnTypeConfig(i,n)}return this._fnTypeConfigs[e]}_deleteFnTypeConfigs(){delete this._fnTypeConfigs}loginTextureCache(){const t=(uF+"").trim(),e=this.getMap();e[t]||(e[t]={count:0}),e[t].count++}logoutTextureCache(){const t=(uF+"").trim(),e=this.getMap(),n=this._myTextures;if(n)for(const i in n)qL(n,i)&&e[t][i]&&(e[t][i].count--,e[t][i].count<=0&&delete e[t][i]);e[t].count--,e[t].count<=0&&(e[t]={})}getCachedTexture(t){const e=(uF+"").trim(),n=this.getMap()[e][t];return n?n.data:null}addCachedTexture(t,e){const n=(uF+"").trim(),i=this.getMap();let o=i[n][t];o?o.data=e:o=i[n][t]={data:e,count:0},this._myTextures||(this._myTextures={}),o.data.then||this._myTextures[t]||(o.count++,this._myTextures[t]=1)}disposeCachedTexture(t){let e;if(e="string"==typeof t?t:t.url,!this._myTextures||!this._myTextures[e])return;const n=(uF+"").trim();delete this._myTextures[e];const i=this.getMap();i[n][e]&&(i[n][e].count--,i[n][e].count<=0&&delete i[n][e])}shouldDeleteMeshOnUpdateSymbol(){return!1}isEnableTileStencil(){return!0}isUniqueStencilRefPerTile(){return this.isOnly2D()}supportRenderMode(t){return"taa"===t||"fxaa"===t}outline(t,e){const n={};for(let i=0;i<e.length;i++)NL(e[i])||n[e[i]]||(this._outlineOne(t,e[i]),n[e[i]]=1)}_outlineOne(t,e){if(!this.picking)return;if(this._outlineScene||(this._outlineScene=new _w),!this._outlineShaders&&(this._initOutlineShaders(),!this._outlineShaders))return void console.warn(`Plugin at ${this.pluginIndex} doesn't support outline.`);const n=this.getUniformValues(this.getMap(),this._renderContext);this._setLayerUniforms(n);const i=this._findMeshesHasFeaId(e);if(i.length)for(let o=0;o<i.length;o++){const s=i[o].geometry.properties.feaIdPickingMap;if(s){const a=s[e];if(a){const e={};this._outlineScene.setMeshes(i[o]);for(let i=0;i<a.length;i++){const o=a[i];if(!e[o]){e[o]=1,n.highlightPickingId=o;for(let e=0;e<this._outlineShaders.length;e++)this.renderer.render(this._outlineShaders[e],n,this._outlineScene,t)}}}}}}_findMeshesHasFeaId(t){const e=[],n=this.scene.getMeshes();for(let i=0;i<n.length;i++){const o=n[i],s=o.geometry.properties.feaIdPickingMap;s&&void 0!==s[t]&&e.push(o)}return e}outlineAll(t){if(!this.picking)return;if(!this._outlineShaders&&(this._initOutlineShaders(),!this._outlineShaders))return void console.warn(`Plugin at ${this.pluginIndex} doesn't support outline.`);const e=this.getUniformValues(this.getMap(),this._renderContext);this._setLayerUniforms(e),e.highlightPickingId=-1;for(let n=0;n<this._outlineShaders.length;n++)this.renderer.render(this._outlineShaders[n],e,this.scene,t)}_initOutlineShaders(){if(!this.picking)return;const t=this.layer.getRenderer().canvas;this._outlineShaders=[];for(let e=0;e<this.picking.length;e++){const n=this.picking[e].getPickingVert(),i={ENABLE_PICKING:1,HAS_PICKING_ID:1},o=this.picking[e].getUniformDeclares().slice(0);void 0!==o.uPickingId&&(i.HAS_PICKING_ID=2),this._outlineShaders[e]=new zw({vert:n,frag:"precision highp float;\nuniform float highlightPickingId;\nvarying float vPickingId;\nvoid main() {\n  if(highlightPickingId < .0 || floor(highlightPickingId + .5) == floor(vPickingId + .5)) {\n    gl_FragColor = vec4(1.);\n  } else {\n    discard;\n  }\n}",uniforms:o,defines:i,extraCommandProps:{viewport:{x:0,y:0,width:()=>t.width,height:()=>t.height},depth:{enable:!0,mask:!1,func:"always"},blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}}),this._outlineShaders[e].filter=this.picking[e].filter}}hasIBL(){const t=this.getMap().getLightManager();return!(!t||!t.getAmbientResource())}updateIBLDefines(t){const e=t.shaderDefines;let n=!1;this.hasIBL()?e[["HAS_IBL_LIGHTING"]]||(e.HAS_IBL_LIGHTING=1,n=!0):e[["HAS_IBL_LIGHTING"]]&&(delete e.HAS_IBL_LIGHTING,n=!0),n&&(t.shaderDefines=e)}getIBLRes(){const t=this.layer.getRenderer().canvas;return cF(t)}createIBLTextures(){const t=this.layer.getRenderer().canvas;lF(t,this.regl,this.getMap()),this.setToRedraw(!0),this.layer.fire("iblupdated")}disposeIBLTextures(){const t=this.layer.getRenderer().canvas;hF(t,this.getMap())}evaluateInFnTypeConfig(t,e,n,i,o){let s=this._fnCaches;s||(s=this._fnCaches={});const a=function(t){let e=0;const n=t&&t.length||0;if(!n)return e;let i;for(let o=0;o<n;o++)i=t.codePointAt(o),e=(e<<5)-e+i,e|=0;return e}(JSON.stringify(t));let l=s[a];return l||(l=s[a]=o?vk(t):_k(t)),l(n.getZoom(),i)}highlight(t){this._highlighted=t,this._highlightTimestamp=this.layer.getRenderer().getFrameTimestamp(),this.setToRedraw(!0)}cancelAllHighlight(){this._highlighted=null,this._highlightTimestamp=this.layer.getRenderer().getFrameTimestamp(),this.setToRedraw(!0)}_prepareFeatureIds(t,e){const{featureIds:n,pickingIdIndiceMap:i}=e;t.properties.aFeaIds=n,t.properties.pickingIdIndiceMap=i}_highlightMesh(t){if(t&&t.properties.isHalo)return;const e=t instanceof lw?t.properties:t.geometry.properties,{pickingIdIndiceMap:n}=e,i=this._highlighted?function(t,e,n){const i=t instanceof lw?t.properties:t.geometry.properties,{aPickingId:o,feaIdPickingMap:s,features:a}=i,l=new Map,h=n.keys();for(const t of h){const i=n.get(t);if(i)if(NL(i.id)){if(i.filter&&o){let t=null;for(let n=0;n<o.length;n++){o[n]!==t&&(t=o[n]);const s=a[t];i.filter(s&&s.feature,e)&&l.set(t,i)}}}else{const t=s[i.id];if(!t||!t.length)continue;for(let e=0;e<t.length;e++)l.set(t[e],i)}}return l}(t,this.layer,this._highlighted):null;eE.highlightMesh(this.regl,t,i,this._highlightTimestamp,n)}_updateTerrainAltitude(t,e,n,i,o){let s=n.aAnchor;if(!s){const{aPosition:t}=e;s=n.aAnchor=t.slice(0)}let a=n.aTerrainAltitude;a||(a=n.aTerrainAltitude=new Float32Array(s.length/i),a.fill(ML)),this._fillTerrainAltitude(a,s,o.tileInfo,0,a.length-1),e.aTerrainAltitude?a.dirty&&this._updateATerrainAltitude(t,a):e.aTerrainAltitude=a,a.dirty=!1}_updateATerrainAltitude(t,e){t&&t.updateData&&t.updateData("aTerrainAltitude",e)}_fillTerrainAltitude(t,e,n,i,o){const{res:s,extent:a,extent2d:l,id:h}=n,c=this.pluginIndex,u=h+"-"+c;if(n.completeTerrainQuery||(n.completeTerrainQuery=[]),n.completeTerrainQuery[c])return;if(!n.completeTerrainQuery[c]&&this._terrainAltitudeCache&&this._terrainAltitudeCache.has(u)){const e=this._terrainAltitudeCache.getAndRemove(u);return this._terrainAltitudeCache.add(u,e),t.set(e.altitudeData),n.terrainTileInfos=e.terrainTileInfos,t.dirty=!0,void(n.completeTerrainQuery[c]=!0)}const f=this.layer,g=f.getMap(),A=f.getRenderer(),m=A&&A.getTerrainHelper();let w=n.terrainTileInfos;w||(w=n.terrainTileInfos=this.layer.queryTerrainTiles(n)),n.terrainQueryStatus||(n.terrainQueryStatus=[]);let T=!1,M=[];for(let t=0;t<n.terrainTileInfos.length;t++)if(M[t]=+m.isTerrainTileLoaded(n.terrainTileInfos[t].id),M[t]&&n.terrainQueryStatus[c]&&!n.terrainQueryStatus[c][t]){T=!0;break}if(!T&&n.terrainQueryStatus[c])return;const C=f.constructor;if(g.isInteracting()){const t=A.getFrameTimestamp();C.altitudeQueryFrameTimestamp!==t&&(C.altitudeQueryFrameTimestamp=t,C.altitudeQueryFrameTime=0);if(C.altitudeQueryFrameTime>f.options.altitudeQueryTimeLimitPerFrame)return}const P=performance.now();n.terrainQueryStatus[c]=M;const{xmin:I,ymax:O}=l,E=dF.set(I,O),D=this.layer.getTileSize().width/n.extent,N=e.length/t.length;let H=t.queryResult;H||(H=t.queryResult=new Map);let U=!0;for(let n=i;n<=o;n++){let i=e[n*N];i<0?i=0:i>a&&(i=a);let o=e[n*N+1];o<0?o=0:o>a&&(o=a);const l=i+o*a;let h,c,u=H.get(l);if(u||0===u)t[n]!==u&&(t[n]=u,t.dirty=!0);else{for(let t=0;t<w.length;t++)if(rF(w[t],I+D*i,O-D*o,s)){h=w[t];break}h&&(m.getRenderer().isTileCached(h.id)||t[n]===ML)&&(gF.set(i,o),c=this.layer.queryTilePointTerrain(gF,h,E,a,s)),u=t[n],c&&(u=null===c[0]?ML:c[0],pF[0]=u,u=pF[0]),t[n]!==u&&(t[n]=u,t.dirty=!0),c&&c[1]?H.set(l,u):U=!1}}C.altitudeQueryFrameTime=(C.altitudeQueryFrameTime||0)+(performance.now()-P),n.completeTerrainQuery[c]=U,U&&(this._terrainAltitudeCache||(this._terrainAltitudeCache=new Xa(4*this.layer.options.maxCacheSize)),this._terrainAltitudeCache.add(u,{altitudeData:t,terrainTileInfos:w}))}shouldDrawParentTile(){return!0}};function vF(t,e){const n=t&&t.getCommandKey(this.regl)||"",i=e&&e.getCommandKey(this.regl)||"";return n.localeCompare(i)}function xF(t,e){return t.properties.level-e.properties.level}let bF=class gn extends _F{createGeometry(t,e){if(!t.data)return{geometry:null,symbolIndex:t.symbolIndex};t.iconAtlas&&t.iconAtlas.image&&(t.iconAtlas.image.dataType=t.type,t.iconAtlas.image.type="icon"),t.glyphAtlas&&t.glyphAtlas.image&&(t.glyphAtlas.image.type="glyph");const n=LL({},t.data),i={primitive:this.getPrimitive(),positionSize:t.positionSize};n.aAltitude&&(i.altitudeAttribute="aAltitude");const o=new vb(n,t.indices,0,i);return o.properties={features:e},t.iconAtlas&&(o.properties.iconAtlas=t.iconAtlas.image,o.properties.iconPositions=t.iconAtlas.positions),t.glyphAtlas&&(o.properties.glyphAtlas=t.glyphAtlas.image),OD(e)||(o.properties.aFeaIds=t.featureIds,this._prepareFeatureIds(o,t)),t.markerPlacement&&(o.properties.markerPlacement=t.markerPlacement),t.textPlacement&&(o.properties.textPlacement=t.textPlacement),LL(o.properties,t.properties),{geometry:o,symbolIndex:t.symbolIndex}}getRayCastData(t,e){const{features:n,aFeaIds:i}=t.geometry.properties;return n&&i?n[i[e]]:null}getPrimitive(){return"triangles"}getRenderFBO(t){return t&&t.renderTarget&&t.renderTarget.fbo}supportRenderMode(t){return"noAa"===t}drawDebugAtlas(t){if(document.getElementById("ispace_ICON_DEBUG")){const e=document.getElementById("ispace_ICON_DEBUG");let n;if(e.width=t.width,e.height=t.height,e.style.width=t.width+"px",e.style.height=t.height+"px","alpha"===t.format){n=new Uint8ClampedArray(4*t.data.length);for(let e=0;e<t.data.length;e++)n[4*e+3]=t.data[e]}else n=new Uint8ClampedArray(t.data);const i=e.getContext("2d");i.imageSmoothingEnabled=!1,i.putImageData(new ImageData(n,t.width,t.height),0,0)}}};var wF="#include <gl2_vert>\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\nuniform mat4 projViewModelMatrix;\nuniform mat4 positionMatrix;\n#include <fbo_picking_vert>\n#include <vt_position_vert>\nvoid main() {\n  vec3 c = unpackVTPosition();\n  gl_Position = projViewModelMatrix * positionMatrix * vec4(c, 1.);\n  fbo_picking_setData(gl_Position.w, true);\n}";function TF(t,e,n,i){if(i){const t=rb.resizeToPowerOfTwo(e.data,e.width,e.height);e.data=t}const o={width:e.width,height:e.height,data:e.data,format:e.format,mag:"linear",min:i?"linear mipmap linear":"linear",flipY:n,premultiplyAlpha:!0};if("icon"===e.type){const t="point"!==e.dataType?"repeat":"clamp";o.wrapS=t,o.wrapT=t}return t.texture(o)}const MF=[0,0],CF=[];function SF(t){if(!t.properties.iconPositions)return MF;let e,n=0;for(const i in t.properties.iconPositions)if(e=i,n++,n>1)return MF;if(!e)return MF;const i=t.properties.iconPositions[e],o=i.displaySize[1];return CF[0]=i.displaySize[0],CF[1]=o,CF}const{INVALID_TEX_COORD:PF}=ZR(),IF=ay([]),OF={polygonFill:[1,1,1,1],polygonOpacity:1,uvScale:[1,1],uvOffset:[0,0],patternWidth:[0,0],patternOffset:[0,0]},EF=[],kF=new gh(0,0),RF=new gh(0,0),LF=new gh(0,0),DF=[];let FF=class Cn extends bF{static getBloomSymbol(){return["polygonBloom"]}prepareSymbol(t){const e=t.polygonFill;Array.isArray(e)&&(3===e.length&&e.push(1),t.polygonFill=e.map((t=>255*t)))}supportRenderMode(t){return this.sceneConfig.antialias||void 0===this.sceneConfig.antialias?"fxaa"===t||"fxaaBeforeTaa"===t:super.supportRenderMode(t)}isBloom(t){return!!this.getSymbol(t.properties.symbolIndex)[Cn.getBloomSymbol()[0]]}forbiddenTerrainUpscale(){return!0}needPolygonOffset(){return!0}getAnalysisMeshes(){return this.isVisible()?this.scene.getMeshes().filter((t=>0===t.properties.level)):EF}createMesh(t,e,n){const i=this.getMap(),{tilePoint:o}=n,{geometry:s,symbolIndex:a,ref:l}=t,h=this.layer instanceof kp,c=this.layer.getTileSize().width,u=s.properties.tileExtent/c,f=s.properties.tileResolution,g=i.pointAtResToCoord(kF.set(o[0],o[1]),f),A={tileExtent:s.properties.tileExtent,tileRatio:u},m=this.getSymbol(a),w=this.getSymbolDef(a);if(mk(w.polygonPatternFileOrigin)&&this._preparePatternOrigin(w,t,h?[0,0]:o,f),(mk(w.polygonPatternFileWidth)||mk(w.polygonPatternFileWidth))&&this._preparePatternWidth(w,t,h?u:1,g,f),w.uvOffsetInMeter&&mk(w.uvOffset)&&this._preparePatternOffset(w,t,g,f),BL(A,"polygonFill",m,"polygonFill",OF.polygonFill,jL(this.colorCache)),BL(A,"polygonOpacity",m,"polygonOpacity",OF.polygonOpacity),BL(A,"uvScale",m,"uvScale",OF.uvScale),void 0===l){const t=this.getFnTypeConfig(a);LD(s,w,t,this.layer),s.generateBuffers(this.regl)}const T=s.properties.iconAtlas,M=2048;if(T&&s.data.aTexInfo){const t=[];Object.defineProperty(A,"uvOrigin",{enumerable:!0,get:()=>{const e=A.tileScale;if(s.data.aPatternOrigin)return t[0]=o[0]*e%M,t[1]=o[1]*e%M,t;const n=m.polygonPatternFileOrigin;return n?(kF.set(n[0],n[1]),i.coordToPointAtRes(kF,f,RF),Ev(t,o[0]-RF.x,o[1]-RF.y)):(t[0]=o[0]*e%M,t[1]=o[1]*e%M,t)}});const e=[];Object.defineProperty(A,"patternWidth",{enumerable:!0,get:()=>{if(s.data.aPatternWidth)return OF.patternWidth;const t=w.polygonPatternFileWidth,n=w.polygonPatternFileHeight;if(!t&&!n)return OF.patternWidth;const[i,o]=this._computePatternWidth(DF,t,n,h?u:1,g,f);return Ev(e,i,o)}}),Object.defineProperty(A,"uvOffset",{enumerable:!0,get:()=>s.data.aPatternOffset||w.uvOffsetInMeter?OF.uvOffset:m.uvOffset||OF.uvOffset});const n=[];Object.defineProperty(A,"patternOffset",{enumerable:!0,get:()=>{if(s.data.aPatternOffset)return OF.uvOffset;if(!w.uvOffsetInMeter)return OF.uvOffset;const t=w.uvOffset;if(!t)return OF.uvOffset;const e=QL(i,t[0],g,f),o=QL(i,t[1],g,f);return Ev(n,e,o)}}),Object.defineProperty(A,"tileScale",{enumerable:!0,get:function(){return w.polygonPatternFileWidth||w.polygonPatternFileHeight?1:s.properties.tileResolution/i.getResolution()}}),A.polygonPatternFile=TF(this.regl,T,!1,!1),A.atlasSize=[T.width,T.height],this.drawDebugAtlas(T)}const C=new Qb(A,OF),P=new aw(s,C,{castShadow:!1,picking:!0}),I={};return T&&s.data.aTexInfo&&(I.HAS_PATTERN=1),T&&s.data.aTexCoord&&(I.HAS_TEX_COORD=1,I.INVALID_TEX_COORD=PF+".0"),s.data.aAltitude&&(I.HAS_ALTITUDE=1),s.data.aColor&&(I.HAS_COLOR=1),s.data.aOpacity&&(I.HAS_OPACITY=1),s.data.aUVScale&&(I.HAS_UV_SCALE=1),s.data.aUVOffset&&(I.HAS_UV_OFFSET=1),s.data.aPatternOrigin&&(I.HAS_PATTERN_ORIGIN=1),s.data.aPatternWidth&&(I.HAS_PATTERN_WIDTH=1),s.data.aPatternOffset&&(I.HAS_PATTERN_OFFSET=1),h&&(I.IS_VT=1),P.setDefines(I),P.positionMatrix=this.getAltitudeOffsetMatrix(),P.setLocalTransform(e),P.properties.symbolIndex=a,P}_preparePatternWidth(t,e,n,i,o){if(!(e=e&&e.geometry))return;const s=e.properties.features;if(OD(s))return;const a=t.polygonPatternFileWidth,l=t.polygonPatternFileHeight,h=_k(t.polygonPatternFileOrigin);let c,u;mk(a)&&(c=_k(a)),mk(l)&&(u=_k(l));const{aPickingId:f,aPatternOrigin:g}=e.data,A=new Float32Array(2*f.length);let m,w,T;for(let t=0,e=f.length;t<e;t++){let e,M;if(f[t]===m){A[2*t]=w,A[2*t+1]=T;continue}const C=s[f[t]];if(e=c?c(null,C.feature.properties):a,M=u?u(null,C.feature.properties):l,m=f[t],e||M){let s=i;if(g){const t=h(null,C.feature.properties);t&&(s=LF.set(t[0],t[1]))}const[a,l]=this._computePatternWidth(DF,e,M,n,s,o);w=A[2*t]=a,T=A[2*t+1]=l}else w=A[2*t]=0,T=A[2*t+1]=0}e.data.aPatternWidth=A}_preparePatternOffset(t,e,n,i){if(!(e=e&&e.geometry))return;const o=e.properties.features;if(OD(o))return;const s=this.getMap();let a=mk(t.uvOffsetInMeter)&&vk(t.uvOffsetInMeter);const l=_k(t.uvOffset),h=_k(t.polygonPatternFileOrigin),{aPickingId:c,aPatternOrigin:u}=e.data,f=new Float32Array(2*c.length);let g,A,m;for(let t=0,e=c.length;t<e;t++){if(c[t]===g){f[2*t]=A,f[2*t+1]=m;continue}const e=o[c[t]],w=l(null,e.feature.properties);let T=!0;if(a&&(T=a(null,e.feature.properties)),g=c[t],w&&T){let o=n;if(u){const t=h(null,e.feature.properties);t&&(o=LF.set(t[0],t[1]))}const a=QL(s,w[0],o,i),l=QL(s,w[0],o,i);A=f[2*t]=a,m=f[2*t+1]=l}else A=f[2*t]=0,m=f[2*t+1]=0}e.data.aPatternOffset=f}_preparePatternOrigin(t,e,n,i){if(!(e=e&&e.geometry))return;const o=e.properties.features;if(OD(o))return;const s=this.getMap(),a=_k(t.polygonPatternFileOrigin),l=e.data.aPickingId,h=new Float32Array(2*l.length);let c,u,f;for(let t=0,e=l.length;t<e;t++){if(l[t]===c){h[2*t]=u,h[2*t+1]=f;continue}c=l[t];const e=a(null,o[c].feature.properties);e?(kF.set(e[0],e[1]),s.coordToPointAtRes(kF,i,RF),u=h[2*t]=RF.x,f=h[2*t+1]=RF.y):(u=h[2*t]=n[0],f=h[2*t+1]=n[1])}e.data.aPatternOrigin=h}createFnTypeConfig(t,e){const n=vk(e.polygonFill),i=_k(e.polygonOpacity),o=_k(e.uvScale),s=_k(e.uvOffset),a=new Uint8Array(1),l=new Uint16Array(2),h=new Uint8Array(2);return[{attrName:"aColor",symbolName:"polygonFill",type:Uint8Array,width:4,define:"HAS_COLOR",evaluate:(e,i)=>{let o=n(t.getZoom(),e);return mk(o)&&(o=this.evaluateInFnTypeConfig(o,i,t,e,!0)),Array.isArray(o)||(o=this.colorCache[o]=this.colorCache[o]||KE(o).unitArray()),o=GL(o),o}},{attrName:"aOpacity",symbolName:"polygonOpacity",type:Uint8Array,width:1,define:"HAS_OPACITY",evaluate:(e,n)=>{let o=i(t.getZoom(),e);return mk(o)&&(o=this.evaluateInFnTypeConfig(o,n,t,e)),a[0]=255*o,a[0]}},{attrName:"aUVScale",symbolName:"uvScale",type:Uint16Array,width:2,define:"HAS_UV_SCALE",evaluate:e=>{const n=o(t.getZoom(),e);return l[0]=255*n[0],l[1]=255*n[1],l}},{attrName:"aUVOffset",symbolName:"uvOffset",type:Uint8Array,width:2,define:"HAS_UV_OFFSET",evaluate:e=>{const n=s(t.getZoom(),e);return h[0]=255*n[0],h[1]=255*n[1],h}}]}paint(t){this.isShadowIncludeChanged(t)&&(this.shader.dispose(),this._createShader(t)),super.paint(t)}isEnableTileStencil(t){const e="VectorTileLayer"===this.layer.getJSONType(),n=this.layer instanceof kp;return!(t&&t.isRenderingTerrain&&this.isTerrainSkin())&&(e||n&&this.isOnly2D())}init(t){const e=this.canvas,n={x:(t,e)=>e.viewport?e.viewport.x:0,y:(t,e)=>e.viewport?e.viewport.y:0,width:(t,n)=>n.viewport?n.viewport.width:e?e.width:1,height:(t,n)=>n.viewport?n.viewport.height:e?e.height:1};this.renderer=new cw(this.regl);const i={viewport:n,stencil:{enable:(t,e)=>e.geometryProperties.is2D&&this.isEnableTileStencil(e.painterContext),func:{cmp:()=>this.isOnly2D()?"=":"<=",ref:(t,e)=>e.stencilRef},op:{fail:"keep",zfail:"keep",zpass:()=>{const t="VectorTileLayer"===this.layer.getJSONType(),e=this.isOnly2D();return t&&e?"zero":"replace"}}},depth:{enable:!0,range:this.sceneConfig.depthRange||[0,1],mask:(t,e)=>{if(!NL(this.sceneConfig.depthMask))return!!this.sceneConfig.depthMask;if(e.hasSSRGround)return!0;if(e.meshConfig.transparent)return!1;const n=e.polygonOpacity;return!(WL(n)&&n<1)},func:this.sceneConfig.depthFunc||"<="},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}};if(this._createShader(t,i),this.pickingFBO){const t=[],e=this.layer instanceof kp;this.picking=[new zM(this.renderer,{vert:wF,uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(e,n){return cy(t,n.projViewMatrix,n.modelMatrix),t}}],extraCommandProps:i,enableStencil:()=>e&&this.isOnly2D()},this.pickingFBO,this.getMap())]}}_createShader(t,e){const n=[],i=[{name:"projViewModelMatrix",type:"function",fn:function(t,e){return cy(n,e.projViewMatrix,e.modelMatrix),n}}],o={};this.fillIncludes(o,i,t),this.shader=new zw({vert:"#define SHADER_NAME FILL\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\n#ifdef HAS_COLOR\nattribute vec4 aColor;\nvarying vec4 vColor;\n#endif\n#ifdef HAS_OPACITY\nattribute float aOpacity;\nvarying float vOpacity;\n#endif\nuniform mat4 projViewModelMatrix;\nuniform mat4 positionMatrix;\n#ifndef IS_VT\nuniform mat4 modelMatrix;\n#endif\n#ifdef HAS_PATTERN\n#ifdef HAS_TEX_COORD\nattribute vec2 aTexCoord;\n#endif\nattribute vec4 aTexInfo;\nuniform vec2 patternWidth;\nuniform vec2 patternOffset;\nuniform vec2 uvOrigin;\nuniform vec2 uvScale;\n#ifdef IS_VT\nuniform float tileRatio;\nuniform float tileScale;\n#else\nuniform float glScale;\n#endif\n#ifdef HAS_UV_SCALE\nattribute vec2 aUVScale;\nvarying vec2 vUVScale;\n#endif\n#ifdef HAS_UV_OFFSET\nattribute vec2 aUVOffset;\nvarying vec2 vUVOffset;\n#endif\n#ifdef HAS_PATTERN_WIDTH\nattribute vec2 aPatternWidth;\n#endif\n#ifdef HAS_PATTERN_ORIGIN\nattribute vec2 aPatternOrigin;\n#endif\n#ifdef HAS_PATTERN_OFFSET\nattribute vec2 aPatternOffset;\n#endif\nvarying vec2 vTexCoord;\nvarying vec4 vTexInfo;\nvec2 c(vec2 d, vec2 e) {\n  \n#ifdef IS_VT\nfloat f = d.x / e.x;\n  float h = d.y / e.y;\n  return vec2(f, h);\n#else\nfloat i = glScale;\n#ifdef HAS_PATTERN_WIDTH\nfloat j = sign(length(aPatternWidth));\n  i = mix(glScale, 1., j);\n#endif\nvec2 k = uvOrigin;\n#ifdef HAS_PATTERN_ORIGIN\nk = aPatternOrigin;\n#endif\n#ifdef HAS_PATTERN_OFFSET\nvec2 l = aPatternOffset;\n#else\nvec2 l = patternOffset;\n#endif\nk += l;\n  float f = (d.x - k.x) * i / e.x;\n  float h = (d.y - k.y) * i / e.y;\n  return vec2(f, -h);\n#endif\n}\nvec2 m(vec4 n, vec2 o) {\n  \n#ifdef IS_VT\n#ifdef HAS_PATTERN_OFFSET\nvec2 l = aPatternOffset;\n#else\nvec2 l = patternOffset;\n#endif\nvec2 k = uvOrigin + l;\n#ifdef HAS_PATTERN_ORIGIN\nk = k - aPatternOrigin * tileScale;\n#endif\nfloat j = sign(length(patternWidth));\n  vec2 A = mix(o, patternWidth, j);\n#ifdef HAS_PATTERN_WIDTH\nA = aPatternWidth;\n#endif\nvec2 B = k * vec2(1., -1.) / A;\n  return mod(B, 1.) + c(n.xy * tileScale / tileRatio, A);\n#else\nvec2 A = o;\n#ifdef HAS_PATTERN_WIDTH\nfloat j = sign(length(aPatternWidth));\n  A = mix(o, aPatternWidth, j);\n#endif\nvec4 C = modelMatrix * n;\n  return c(C.xy, A);\n#endif\n}\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_vert>\n#endif\n#include <vt_position_vert>\n#include <highlight_vert>\nvoid main() {\n  vec3 D = unpackVTPosition();\n  vec4 n = vec4(D, 1.);\n  gl_Position = projViewModelMatrix * positionMatrix * n;\n#ifdef HAS_PATTERN\nvec2 o = aTexInfo.zw + 1.;\n  vTexInfo = vec4(aTexInfo.xy, o);\n#ifdef HAS_TEX_COORD\nif(aTexCoord.x == INVALID_TEX_COORD) {\n    vTexCoord = m(n, o);\n  } else {\n    vTexCoord = aTexCoord;\n  }\n#else\nvTexCoord = m(n, o);\n#endif\n#ifdef HAS_UV_SCALE\nvUVScale = aUVScale / 255.;\n#endif\n#ifdef HAS_UV_OFFSET\nvUVOffset = aUVOffset / 255.;\n#endif\n#endif\n#ifdef HAS_COLOR\nvColor = aColor / 255.;\n#endif\nhighlight_setVarying();\n#ifdef HAS_OPACITY\nvOpacity = aOpacity / 255.;\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nshadow_computeShadowPars(n);\n#endif\n}",frag:"#define SHADER_NAME FILL\nprecision mediump float;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_frag>\n#endif\n#ifdef HAS_PATTERN\n#ifdef HAS_UV_SCALE\nvarying vec2 vUVScale;\n#else\nuniform highp vec2 uvScale;\n#endif\n#ifdef HAS_UV_OFFSET\nvarying vec2 vUVOffset;\n#else\nuniform vec2 uvOffset;\n#endif\n#endif\n#ifdef HAS_PATTERN\nuniform sampler2D polygonPatternFile;\nuniform vec2 atlasSize;\nvarying vec2 vTexCoord;\nvarying vec4 vTexInfo;\nvec2 c() {\n  \n#ifdef HAS_UV_SCALE\nvec2 d = vUVScale;\n#else\nvec2 d = uvScale;\n#endif\n#ifdef HAS_UV_OFFSET\nvec2 e = vUVOffset;\n#else\nvec2 e = uvOffset;\n#endif\nvec2 f = mod(vTexCoord * d + e, 1.);\n  vec2 h = vTexInfo.xy;\n  vec2 i = vTexInfo.zw;\n  return (h + f * i) / atlasSize;\n}\n#endif\n#ifdef HAS_COLOR\nvarying vec4 vColor;\n#else\nuniform vec4 polygonFill;\n#endif\n#include <highlight_frag>\n#ifdef HAS_OPACITY\nvarying float vOpacity;\n#else\nuniform lowp float polygonOpacity;\n#endif\nuniform float layerOpacity;\nuniform float tileExtent;\nvoid main() {\n  \n#ifdef HAS_COLOR\nvec4 j = vColor;\n#else\nvec4 j = polygonFill;\n#endif\n#ifdef HAS_PATTERN\nif(vTexInfo.z * vTexInfo.w > 1.) {\n    vec2 f = c();\n    j = texture2D(polygonPatternFile, f);\n  }\n#endif\n#ifdef HAS_OPACITY\ngl_FragColor = j * vOpacity;\n#else\ngl_FragColor = j * polygonOpacity;\n#endif\ngl_FragColor *= layerOpacity;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nfloat k = shadow_computeShadow();\n  gl_FragColor.rgb = shadow_blend(gl_FragColor.rgb, k);\n#endif\ngl_FragColor = highlight_blendColor(gl_FragColor);\n}",uniforms:i,defines:o,extraCommandProps:e})}getUniformValues(t,e){const n=e&&e.isRenderingTerrainSkin,i={projViewMatrix:n?IF:t.projViewMatrix,glScale:e&&e.isRenderingTerrainSkin?1:1/t.getGLScale(),viewport:n&&e&&e.viewport,hasSSRGround:e&&e.hasSSRGround};return this.setIncludeUniformValues(i,e),i}_computePatternWidth(t,e,n,i,o,s){let a,l;const h=this.getMap();return e&&(a=QL(h,e,o,s)),n&&(l=QL(h,n,o,s,1)),a=a||l,l=l||a,t[0]=a,t[1]=l,t}};var NF="#define SHADER_NAME LINE\n#define AA_CLIP_LIMIT 2.0\n#define AA_LINE_WIDTH 16.0\n#define DEVICE_PIXEL_RATIO 1.0\n#define ANTIALIASING 1.0 / DEVICE_PIXEL_RATIO / 2.0\n#define EXTRUDE_SCALE 63.0\n#define EXTRUDE_MOD 64.0\n#define MAX_LINE_DISTANCE 65535.0\n#ifdef PICKING_MODE\n#include <gl2_vert>\n#endif\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\n#if defined(HAS_PATTERN) || defined(HAS_DASHARRAY)\nattribute vec3 aExtrude;\n#else\nattribute vec2 aExtrude;\n#endif\n#if defined(HAS_PATTERN) || defined(HAS_DASHARRAY) || defined(HAS_GRADIENT) || defined(HAS_TRAIL)\nattribute float aLinesofar;\nvarying highp float vLinesofar;\n#endif\nuniform float cameraToCenterDistance;\n#if defined(HAS_STROKE_WIDTH)\nattribute float aLineStrokeWidth;\n#else\nuniform float lineStrokeWidth;\n#endif\nuniform mat4 positionMatrix;\nuniform mat4 projViewModelMatrix;\nuniform mat4 modelMatrix;\nuniform float tileResolution;\nuniform float resolution;\nuniform float tileRatio;\nuniform float isRenderingTerrain;\n#if defined(HAS_LINE_DX) || defined(HAS_LINE_DY)\nattribute vec2 aLineDxDy;\n#endif\n#ifndef HAS_LINE_DX\nuniform float lineDx;\n#endif\n#ifndef HAS_LINE_DY\nuniform float lineDy;\n#endif\nuniform vec2 canvasSize;\nuniform float layerScale;\nvarying vec2 vNormal;\nvarying vec2 vWidth;\nvarying float vGammaScale;\n#ifndef ENABLE_TILE_STENCIL\nvarying vec2 vPosition;\n#endif\n#ifdef USE_LINE_OFFSET\nattribute vec2 aExtrudeOffset;\n#endif\n#ifdef HAS_LINE_WIDTH\nattribute float aLineWidth;\n#else\nuniform float lineWidth;\n#endif\n#ifndef PICKING_MODE\n#ifndef HAS_GRADIENT\n#ifdef HAS_COLOR\nattribute vec4 aColor;\nvarying vec4 vColor;\n#endif\n#ifdef HAS_PATTERN\n#if defined(HAS_PATTERN_ANIM) || defined(HAS_PATTERN_GAP)\nattribute vec2 aLinePattern;\n#endif\n#ifdef HAS_PATTERN_ANIM\nvarying float vLinePatternAnimSpeed;\n#endif\n#ifdef HAS_PATTERN_GAP\nvarying float vLinePatternGap;\n#endif\nattribute vec4 aTexInfo;\nvarying vec4 vTexInfo;\n#endif\n#ifdef HAS_DASHARRAY\n#ifdef HAS_DASHARRAY_ATTR\nattribute vec4 aDasharray;\nvarying vec4 vDasharray;\n#endif\n#ifdef HAS_DASHARRAY_COLOR\nattribute vec4 aDashColor;\nvarying vec4 vDashColor;\n#endif\n#endif\n#endif\n#ifdef HAS_STROKE_COLOR\nattribute vec4 aStrokeColor;\nvarying vec4 vStrokeColor;\n#endif\n#ifdef HAS_OPACITY\nattribute float aOpacity;\nvarying float vOpacity;\n#endif\n#ifdef HAS_GRADIENT\nattribute float aGradIndex;\nvarying float vGradIndex;\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_vert>\n#endif\n#include <highlight_vert>\n#else\n#include <fbo_picking_vert>\n#endif\nvarying vec3 vVertex;\n#include <vt_position_vert>\nvoid main() {\n  vec3 c = unpackVTPosition();\n  float d = mod(abs(aExtrude.x), 2.);\n  float e = mod(abs(aExtrude.y), 2.);\n  vNormal = vec2(d, e * 2. - 1.);\n  vec4 f = vec4(c, 1.);\n  vec4 h = projViewModelMatrix * positionMatrix * f;\n  if(isRenderingTerrain == 1.) {\n    vVertex = (positionMatrix * f).xyz;\n  } else {\n    vVertex = (modelMatrix * positionMatrix * f).xyz;\n  }\n#ifdef HAS_STROKE_WIDTH\nfloat i = aLineStrokeWidth / 2. * layerScale;\n#else\nfloat i = lineStrokeWidth;\n#endif\n#ifdef HAS_LINE_WIDTH\nfloat j = aLineWidth / 2. * layerScale;\n#else\nfloat j = lineWidth * layerScale;\n#endif\nfloat k = j / 2. + i;\n  float l = sign(i) * j / 2.;\n  float m = l + sign(l) * ANTIALIASING;\n  float n = k + sign(k) * ANTIALIASING;\n#ifdef USE_LINE_OFFSET\nvec2 o = lineOffset * (vNormal.y * (aExtrude.xy - aExtrudeOffset) + aExtrudeOffset);\n  vec2 u = (n * aExtrude.xy + o) / EXTRUDE_SCALE;\n#else\nvec2 v = aExtrude.xy / EXTRUDE_SCALE;\n  vec2 u = n * v;\n#endif\nfloat A = tileResolution / resolution;\n  vec4 B = vec4(c + vec3(u, .0) * tileRatio / A, 1.);\n  gl_Position = projViewModelMatrix * positionMatrix * B;\n#ifdef HAS_LINE_DX\nfloat C = aLineDxDy[0];\n#else\nfloat C = lineDx;\n#endif\n#ifdef HAS_LINE_DY\nfloat D = aLineDxDy[1];\n#else\nfloat D = lineDy;\n#endif\nfloat E = gl_Position.w;\n  gl_Position.xy += vec2(C, D) * 2. / canvasSize * E;\n#ifndef PICKING_MODE\nvWidth = vec2(n, m);\n  if(isRenderingTerrain == 1.) {\n    vGammaScale = 1.;\n  } else {\n    vGammaScale = E / cameraToCenterDistance;\n  }\n#ifndef ENABLE_TILE_STENCIL\nvPosition = c.xy;\n#ifdef USE_LINE_OFFSET\nvPosition += tileRatio * o / EXTRUDE_SCALE;\n#endif\n#endif\n#if defined(HAS_PATTERN) || defined(HAS_DASHARRAY) || defined(HAS_GRADIENT)\n#ifdef HAS_GRADIENT\nvLinesofar = aLinesofar / MAX_LINE_DISTANCE;\n  vGradIndex = aGradIndex;\n#else\nfloat F = aLinesofar - k * aExtrude.z / EXTRUDE_SCALE / A * tileRatio;\n  vLinesofar = F / tileRatio * A;\n#endif\n#endif\n#ifndef HAS_GRADIENT\n#ifdef HAS_COLOR\nvColor = aColor;\n#endif\n#ifdef HAS_DASHARRAY\n#ifdef HAS_DASHARRAY_ATTR\nvDasharray = aDasharray;\n#endif\n#ifdef HAS_DASHARRAY_COLOR\nvDashColor = aDashColor / 255.;\n#endif\n#endif\n#ifdef HAS_PATTERN\nvTexInfo = vec4(aTexInfo.xy, aTexInfo.zw + 1.);\n#ifdef HAS_PATTERN_ANIM\nvLinePatternAnimSpeed = aLinePattern[0] / 127.;\n#endif\n#ifdef HAS_PATTERN_GAP\nvLinePatternGap = aLinePattern[1] / 10.0;\n#endif\n#endif\n#endif\n#ifdef HAS_STROKE_COLOR\nvStrokeColor = aStrokeColor;\n#endif\n#ifdef HAS_OPACITY\nvOpacity = aOpacity / 255.;\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nshadow_computeShadowPars(B);\n#endif\nhighlight_setVarying();\n#else\nfbo_picking_setData(E, true);\n#endif\n}";const HF=ay([]),BF=[];let zF=class Rn extends bF{static getBloomSymbol(){return["lineBloom"]}isUniqueStencilRefPerTile(){return!1}prepareSymbol(t){const e=t.lineColor;Array.isArray(e)&&(3===e.length&&e.push(1),t.lineColor=e.map((t=>255*t)));const n=t.lineStrokeColor;Array.isArray(n)&&(3===n.length&&n.push(1),t.lineStrokeColor=n.map((t=>255*t)));const i=t.lineDashColor;Array.isArray(i)&&(3===i.length&&i.push(1),t.lineDashColor=i.map((t=>255*t)))}isAnimating(){if(this._hasPatternAnim)return!0;const t=this.getSymbols(),e=this.sceneConfig.trailAnimation;if(e&&e.enable)return!0;for(let e=0;e<t.length;e++)if(t[e].linePatternFile&&t[e].linePatternAnimSpeed)return!0;return!1}needToRedraw(){return!!super.needToRedraw()||!!this.isAnimating()}isBloom(t){return!!this.getSymbol(t.properties.symbolIndex)[Rn.getBloomSymbol()[0]]}needPolygonOffset(){return!0}createMesh(t,e){if(!t.geometry)return null;const{geometry:n,symbolIndex:i,ref:o}=t,s=this.getSymbolDef(i);void 0===o&&LD(n,s,this.getFnTypeConfig(i),this.layer);const a=this.getSymbol(i),l={tileResolution:n.properties.tileResolution,tileRatio:n.properties.tileRatio,tileExtent:n.properties.tileExtent,fogFactor:this.layer.options.fogFactor||0};this.setLineUniforms(a,l),BL(l,"lineColor",a,"lineColor","#fff",jL(this.colorCache)),BL(l,"linePatterGapColor",a,"linePatterGapColor",[0,0,0,0],jL(this.colorCache)),BL(l,"lineStrokeColor",a,"lineStrokeColor",[0,0,0,0],jL(this.colorCache)),BL(l,"lineDasharray",a,"lineDasharray",[0,0,0,0],(t=>{let e;if(t&&t.length){1===t.length?e=[t[0],t[0],t[0],t[0]]:2===t.length?e=[t[0],t[1],t[0],t[1]]:3===t.length?e=[t[0],t[1],t[2],t[2]]:4===t.length?e=t:t.length>4&&(e=t.slice(0,4))}return e||[0,0,0,0]})),BL(l,"lineDashColor",a,"lineDashColor",[0,0,0,0],jL(this.colorCache));const h=n.properties.iconAtlas,c=this.layer instanceof kp;h&&(l.linePatternFile=TF(this.regl,h,!1,!1),l.atlasSize=h?[h.width,h.height]:[0,0],l.flipY=c?-1:1,this.drawDebugAtlas(h)),void 0===o&&n.generateBuffers(this.regl);const u=new Qb(l),f=new aw(n,u,{castShadow:!1,picking:!0});f.setLocalTransform(e),f.positionMatrix=this.getAltitudeOffsetMatrix();const g={};return h&&(g.HAS_PATTERN=1),f.properties.symbolIndex=i,this._prepareDashDefines(f,g),n.data.aColor&&(g.HAS_COLOR=1),n.data.aStrokeColor&&(g.HAS_STROKE_COLOR=1),this.setMeshDefines(g,n,s),n.data.aAltitude&&(g.HAS_ALTITUDE=1),f.setDefines(g),f}addMesh(...t){delete this._hasPatternAnim;const e=t[0];Array.isArray(e)?e.forEach((t=>{this._prepareMesh(t)})):this._prepareMesh(e),super.addMesh(...t)}_prepareMesh(t){if(!t.geometry.aLineWidth&&t.material.get("lineWidth")<=0||!t.geometry.aOpacity&&t.material.get("lineOpacity")<=0)return;const e=t.defines;this._prepareDashDefines(t,e),t.setDefines(e),t.geometry.properties.hasPatternAnim&&(this._hasPatternAnim=1)}_prepareDashDefines(t,e){const n=t.geometry,i=this.getSymbol(t.properties.symbolIndex);n.data.aDasharray||Array.isArray(i.lineDasharray)&&i.lineDasharray.reduce(((t,e)=>t+e),0)>0?(e.HAS_DASHARRAY=1,n.data.aDasharray&&(e.HAS_DASHARRAY_ATTR=1),n.data.aDashColor&&(e.HAS_DASHARRAY_COLOR=1)):e.HAS_DASHARRAY&&delete e.HAS_DASHARRAY}setLineUniforms(t,e){BL(e,"lineWidth",t,"lineWidth",2),BL(e,"lineOpacity",t,"lineOpacity",1),BL(e,"lineStrokeWidth",t,"lineStrokeWidth",0),BL(e,"lineBlur",t,"lineBlur",.7),BL(e,"lineOffset",t,"lineOffset",0),BL(e,"lineDx",t,"lineDx",0),BL(e,"lineDy",t,"lineDy",0),BL(e,"linePatternAnimSpeed",t,"linePatternAnimSpeed",0),BL(e,"linePatternGap",t,"linePatternGap",0)}setMeshDefines(t,e,n){e.data.aOpacity&&(t.HAS_OPACITY=1),e.data.aLineWidth&&(t.HAS_LINE_WIDTH=1),e.data.aLineStrokeWidth&&(t.HAS_STROKE_WIDTH=1),WD(n.lineDx)&&(t.HAS_LINE_DX=1),WD(n.lineDy)&&(t.HAS_LINE_DY=1),WD(n.linePatternAnimSpeed)&&(t.HAS_PATTERN_ANIM=1),WD(n.linePatternGap)&&(t.HAS_PATTERN_GAP=1)}paint(t){this.isShadowIncludeChanged(t)&&(this.shader.dispose(),this.createShader(t)),super.paint(t)}createFnTypeConfig(t,e){const n=vk(e.lineColor),i=vk(e.aLinePatternAnimSpeed),o=vk(e.aLinePatternGap),s=this.createShapeFnTypeConfigs(t,e),a=new Int8Array(2);return[{attrName:"aColor",symbolName:"lineColor",type:Uint8Array,width:4,define:"HAS_COLOR",evaluate:(e,i)=>{let o=n(t.getZoom(),e);return mk(o)&&(o=this.evaluateInFnTypeConfig(o,i,t,e,!0)),Array.isArray(o)||(o=this.colorCache[o]=this.colorCache[o]||KE(o).unitArray()),o=GL(o),o}},{attrName:"aLinePattern",symbolName:"linePatternAnimSpeed",type:Int8Array,width:2,related:["linePatternGap"],define:"HAS_LINE_PATTERN",evaluate:(e,n,o,s)=>{let l=i(t.getZoom(),e);return NL(l)&&(l=0),0!==l&&(n.properties.hasPatternAnim=1),a[0]=l/127,a[1]=o[s+1],a}},{attrName:"aLinePattern",symbolName:"linePatternGap",type:Int8Array,width:2,related:["linePatternAnimSpeed"],define:"HAS_LINE_PATTERN",evaluate:(e,n,i,s)=>{let l=o(t.getZoom(),e);return NL(l)&&(l=0),a[1]=10*l,a[0]=i[s],a}}].concat(s)}createShapeFnTypeConfigs(t,e){const n=_k(e.lineWidth),i=_k(e.lineOpacity),o=_k(e.lineStrokeWidth),s=_k(e.lineDx),a=_k(e.lineDy),l=new Uint16Array(1),h=new Int8Array(1);return[{attrName:"aLineWidth",symbolName:"lineWidth",type:Uint8Array,width:1,define:"HAS_LINE_WIDTH",evaluate:(e,i)=>{let o=n(t.getZoom(),e);return mk(o)&&(o=this.evaluateInFnTypeConfig(o,i,t,e)),l[0]=Math.round(2*o),l[0]}},{attrName:"aLineStrokeWidth",symbolName:"lineStrokeWidth",type:Uint8Array,width:1,define:"HAS_STROKE_WIDTH",evaluate:e=>{const n=o(t.getZoom(),e);return l[0]=Math.round(2*n),l[0]}},{attrName:"aLineDxDy",symbolName:"lineDx",type:Int8Array,width:2,index:0,define:"HAS_LINE_DX",evaluate:e=>{const n=s(t.getZoom(),e);return h[0]=n,h[0]}},{attrName:"aLineDxDy",symbolName:"lineDy",type:Int8Array,width:2,index:1,define:"HAS_LINE_DY",evaluate:e=>{const n=a(t.getZoom(),e);return h[0]=n,h[0]}},{attrName:"aOpacity",symbolName:"lineOpacity",type:Uint8Array,width:1,define:"HAS_OPACITY",evaluate:(e,n)=>{let o=i(t.getZoom(),e);return mk(o)&&(o=this.evaluateInFnTypeConfig(o,n,t,e)),l[0]=255*o,l[0]}}]}updateSceneConfig(t){t.trailAnimation&&this.createShader(this._context)}init(t){this.renderer=new cw(this.regl),this.createShader(t),this.pickingFBO&&(this.picking=[new zM(this.renderer,{vert:"#define PICKING_MODE 1\n"+NF,uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){const n=[];return cy(n,e.projViewMatrix,e.modelMatrix),n}}],extraCommandProps:this.getExtraCommandProps()},this.pickingFBO,this.getMap())])}createShader(t){this._context=t;const e=[],n={};this.fillIncludes(n,e,t),this.sceneConfig.trailAnimation&&this.sceneConfig.trailAnimation.enable&&(n.HAS_TRAIL=1);const i=[];e.push({name:"projViewModelMatrix",type:"function",fn:function(t,e){return cy(i,e.projViewMatrix,e.modelMatrix),i}}),this.shader=new zw({vert:NF,frag:"#define SHADER_NAME LINE\n#define DEVICE_PIXEL_RATIO 1.0\nprecision highp float;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_frag>\n#endif\nuniform lowp float blendSrcIsOne;\nuniform lowp float lineBlur;\nuniform float isRenderingTerrain;\n#ifdef HAS_COLOR\nvarying vec4 vColor;\n#else\nuniform lowp vec4 lineColor;\n#endif\n#include <highlight_frag>\n#ifdef HAS_STROKE_COLOR\nvarying vec4 vStrokeColor;\n#else\nuniform lowp vec4 lineStrokeColor;\n#endif\n#ifdef HAS_OPACITY\nvarying float vOpacity;\n#else\nuniform lowp float lineOpacity;\n#endif\nuniform float layerOpacity;\n#ifdef HAS_PATTERN\nuniform sampler2D linePatternFile;\nuniform vec2 atlasSize;\nuniform float flipY;\n#ifdef HAS_PATTERN_ANIM\nvarying float vLinePatternAnimSpeed;\n#else\nuniform float linePatternAnimSpeed;\n#endif\n#ifdef HAS_PATTERN_GAP\nvarying float vLinePatternGap;\n#else\nuniform float linePatternGap;\n#endif\nuniform vec4 linePatterGapColor;\nvarying vec4 vTexInfo;\nvec2 c(vec2 d) {\n  vec2 e = mod(d, 1.);\n  vec2 f = vTexInfo.xy;\n  vec2 h = vTexInfo.zw;\n  return (f + e * h) / atlasSize;\n}\n#endif\nvarying vec2 vNormal;\nvarying vec2 vWidth;\nvarying float vGammaScale;\n#ifndef ENABLE_TILE_STENCIL\nvarying vec2 vPosition;\n#endif\nuniform float tileExtent;\n#ifdef HAS_DASHARRAY\n#ifdef HAS_DASHARRAY_ATTR\nvarying vec4 vDasharray;\n#else\nuniform vec4 lineDasharray;\n#endif\n#ifdef HAS_DASHARRAY_COLOR\nvarying vec4 vDashColor;\n#else\nuniform vec4 lineDashColor;\n#endif\n#endif\n#if defined(HAS_PATTERN) || defined(HAS_DASHARRAY) || defined(HAS_GRADIENT) || defined(HAS_TRAIL)\nvarying highp float vLinesofar;\n#endif\n#ifdef HAS_TRAIL\nuniform float trailSpeed;\nuniform float trailLength;\nuniform float trailCircle;\n#endif\n#if defined(HAS_TRAIL) || defined(HAS_PATTERN)\nuniform float currentTime;\n#endif\nfloat i(float j, float k) {\n  float l = k / 2.;\n  float m = abs(j - l);\n  float n = (.1 + 1. / DEVICE_PIXEL_RATIO) * vGammaScale;\n  return clamp(min(m + n, l - m) / n, .0, 1.);\n}\nvarying vec3 vVertex;\nuniform vec3 cameraPosition;\nuniform float cameraToCenterDistance;\nuniform float fogFactor;\nvoid main() {\n  \n#ifndef ENABLE_TILE_STENCIL\nfloat o = sign(tileExtent - min(tileExtent, abs(vPosition.x))) * sign(1. + sign(vPosition.x)) * sign(tileExtent - min(tileExtent, abs(vPosition.y))) * sign(1. + sign(vPosition.y));\n  if(o == .0) {\n    discard;\n  }\n#endif\n#if defined(HAS_PATTERN) || defined(HAS_DASHARRAY) || defined(HAS_GRADIENT) || defined(HAS_TRAIL)\nfloat u = vLinesofar;\n#endif\nfloat v = length(vNormal) * vWidth.s;\n#ifdef HAS_PATTERN\nvec2 h = vTexInfo.zw;\n  float A = sign(h.x * h.y);\n  float B = mix(lineBlur, .0, A);\n#else\nfloat B = lineBlur;\n#endif\nfloat n = (B + 1. / DEVICE_PIXEL_RATIO) * vGammaScale;\n  float C = clamp(min(v - (vWidth.t - n), vWidth.s - v) / n, .0, 1.);\n#ifdef HAS_COLOR\nvec4 D = vColor / 255.;\n#else\nvec4 D = lineColor;\n#endif\n#ifdef HAS_PATTERN\nif(A == 1.) {\n    \n#ifdef HAS_PATTERN_GAP\nfloat E = vLinePatternGap;\n#else\nfloat E = linePatternGap;\n#endif\n#ifdef HAS_PATTERN_ANIM\nfloat F = vLinePatternAnimSpeed;\n#else\nfloat F = linePatternAnimSpeed;\n#endif\nfloat G = h.x * vWidth.s * 2. / h.y;\n    float H = G * (1. + E);\n    u += mod(currentTime * -F * .2, H);\n    float I = mod(u / H, 1.);\n    float J = mod((flipY * vNormal.y + 1.) / 2., 1.);\n    vec4 K = texture2D(linePatternFile, c(vec2(I * (1. + E), J)));\n    float L = clamp(sign(1. / (1. + E) - I) + .000001, .0, 1.);\n    K = mix(linePatterGapColor, K, L);\n    D *= K;\n  }\n#endif\n#ifdef HAS_DASHARRAY\n#ifdef HAS_DASHARRAY_ATTR\nvec4 M = vDasharray;\n#else\nvec4 M = lineDasharray;\n#endif\n#ifdef HAS_DASHARRAY_COLOR\nvec4 N = vDashColor;\n#else\nvec4 N = lineDashColor;\n#endif\nfloat k = M[0] + M[1] + M[2] + M[3];\n  float j = mod(u, k);\n  float O = max(sign(M[0] - j), .0);\n  float P = j - M[0] - M[1];\n  float Q = max(sign(P), .0) * max(sign(M[2] - P), .0);\n  float R = O + Q;\n  float S = i(j, M[0]);\n  float T = i(P, M[2]);\n  float U = S * O + T * Q;\n  D = D * (1. - U) + N * U;\n#endif\n#ifdef HAS_STROKE_COLOR\nvec4 V = vStrokeColor / 255.;\n#else\nvec4 V = lineStrokeColor;\n#endif\nV = mix(D, V, sign(vWidth.t));\n  D = V * C + max(sign(vWidth.t - v), .0) * D * (1. - C);\n#ifdef HAS_TRAIL\nfloat W = mod(u - currentTime * trailSpeed * .1, trailCircle);\n  float X = W < trailLength ? mix(.0, 1., W / trailLength) : .0;\n  D *= X;\n#endif\n#ifdef HAS_OPACITY\nfloat Y = vOpacity;\n#else\nfloat Y = lineOpacity;\n#endif\ngl_FragColor = D * Y * layerOpacity;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nfloat Z = shadow_computeShadow();\n  gl_FragColor.rgb = shadow_blend(gl_FragColor.rgb, Z);\n#endif\nfloat ba;\n  if(isRenderingTerrain == 1.) {\n    ba = 1.;\n  } else {\n    ba = clamp(cameraToCenterDistance * 1.5 / distance(vVertex, cameraPosition), .0, 1.);\n  }\n  gl_FragColor *= ba;\n  gl_FragColor = highlight_blendColor(gl_FragColor);\n  if(fogFactor > .0) {\n    vec3 bb = vec3(vVertex[0] - cameraPosition[0], vVertex[1] - cameraPosition[1], vVertex[2] - cameraPosition[2]);\n    float bc = length(bb);\n    float bd = clamp(1. - (bc * 1.2) / fogFactor, .0, 1.);\n    gl_FragColor *= bd;\n  }\n}",uniforms:e,defines:n,extraCommandProps:this.getExtraCommandProps(t)})}isEnableTileStencil(t){return!(t&&t.isRenderingTerrain&&this.isTerrainSkin())}getExtraCommandProps(){const t=this.canvas;return{viewport:{x:(t,e)=>e.viewport?e.viewport.x:0,y:(t,e)=>e.viewport?e.viewport.y:0,width:(e,n)=>n.viewport?n.viewport.width:t?t.width:1,height:(e,n)=>n.viewport?n.viewport.height:t?t.height:1},stencil:{enable:(t,e)=>this.isEnableTileStencil(e.painterContext),mask:255,func:{cmp:()=>"<=",ref:(t,e)=>e.stencilRef},op:{fail:"keep",zfail:"keep",zpass:"replace"}},depth:{enable:!0,range:this.sceneConfig.depthRange||[0,1],mask:this.sceneConfig.depthMask||!1,func:this.sceneConfig.depthFunc||"<="},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}}}getUniformValues(t,e){const n=e&&e.isRenderingTerrainSkin,i=this.layer.getTileSize().width,o=n?HF:t.projViewMatrix,s=t.viewMatrix,a=t.cameraToCenterDistance,l=t.getResolution(),h=Ev(BF,t.width,t.height);n&&Ev(h,i,i);const c=this.getBlendFunc().src(),u=this.sceneConfig.trailAnimation||{},f={layerScale:this.layer.options.styleScale||1,projViewMatrix:o,viewMatrix:s,cameraToCenterDistance:a,resolution:l,canvasSize:h,trailSpeed:u.speed||1,trailLength:u.trailLength||500,trailCircle:u.trailCircle||1e3,currentTime:this.layer.getRenderer().getFrameTimestamp()||0,blendSrcIsOne:+!(1!==c&&"one"!==c),cameraPosition:t.cameraPosition,viewport:n&&e&&e.viewport,isRenderingTerrain:+!!n};return this.setIncludeUniformValues(f,e),f}};const GF={markerFile:{type:"identity",default:null,property:"_symbol_markerFile"},markerWidth:{type:"identity",default:null,property:"_symbol_markerWidth"},markerHeight:{type:"identity",default:null,property:"_symbol_markerHeight"},markerPathWidth:{type:"identity",default:20,property:"_symbol_markerPathWidth"},markerPathHeight:{type:"identity",default:20,property:"_symbol_markerPathHeight"},markerDx:{type:"identity",default:null,property:"_symbol_markerDx"},markerDy:{type:"identity",default:null,property:"_symbol_markerDy"},markerType:{type:"identity",default:null,property:"_symbol_markerType"},markerPath:{type:"identity",default:null,property:"_symbol_markerPath"},markerFill:{type:"identity",default:null,property:"_symbol_markerFill"},markerFillPatternFile:{type:"identity",default:null,property:"_symbol_markerFillPatternFile"},markerFillOpacity:{type:"identity",default:null,property:"_symbol_markerFillOpacity"},markerLineColor:{type:"identity",default:null,property:"_symbol_markerLineColor"},markerLineWidth:{type:"identity",default:null,property:"_symbol_markerLineWidth"},markerLineOpacity:{type:"identity",default:null,property:"_symbol_markerLineOpacity"},markerLineDasharray:{type:"identity",default:null,property:"_symbol_markerLineDasharray"},markerLinePatternFile:{type:"identity",default:null,property:"_symbol_markerLinePatternFile"},markerVerticalAlignment:{type:"identity",default:"top",property:"_symbol_markerVerticalAlignment"},markerHorizontalAlignment:{type:"identity",default:"middle",property:"_symbol_markerHorizontalAlignment"},markerOpacity:{type:"identity",default:1,property:"_symbol_markerOpacity"},markerPitchAlignment:{type:"identity",default:"viewport",property:"_symbol_markerPitchAlignment"},markerRotationAlignment:{type:"identity",default:"viewport",property:"_symbol_markerRotationAlignment"},markerRotation:{type:"identity",default:0,property:"_symbol_markerRotation"},markerAllowOverlap:{type:"identity",default:0,property:"_symbol_markerAllowOverlap"},markerIgnorePlacement:{type:"identity",default:0,property:"_symbol_markerIgnorePlacement"},markerTextFit:{type:"identity",default:null,property:"_symbol_markerTextFit"},markerSpacing:{type:"identity",default:250,property:"_symbol_markerSpacing"},markerTextFitPadding:{type:"identity",default:null,property:"_symbol_markerTextFitPadding"},markerPlacement:{type:"identity",default:"point",property:"_symbol_markerPlacement"}},jF={textName:{type:"identity",default:null,property:"_symbol_textName"},textFaceName:{type:"identity",default:null,property:"_symbol_textFaceName"},textWrapWidth:{type:"identity",default:null,property:"_symbol_textWrapWidth"},textHorizontalAlignment:{type:"identity",default:null,property:"_symbol_textHorizontalAlignment"},textVerticalAlignment:{type:"identity",default:null,property:"_symbol_textVerticalAlignment"},textFill:{type:"identity",default:null,property:"_symbol_textFill"},textSize:{type:"identity",default:null,property:"_symbol_textSize"},textHaloRadius:{type:"identity",default:null,property:"_symbol_textHaloRadius"},textHaloFill:{type:"identity",default:null,property:"_symbol_textHaloFill"},textHaloOpacity:{type:"identity",default:255,property:"_symbol_textHaloOpacity"},textDx:{type:"identity",default:0,property:"_symbol_textDx"},textDy:{type:"identity",default:0,property:"_symbol_textDy"},textOpacity:{type:"identity",default:1,property:"_symbol_textOpacity"},textPitchAlignment:{type:"identity",default:"viewport",property:"_symbol_textPitchAlignment"},textRotationAlignment:{type:"identity",default:"viewport",property:"_symbol_textRotationAlignment"},textRotation:{type:"identity",default:0,property:"_symbol_textRotation"},textAllowOverlap:{type:"identity",default:0,property:"_symbol_textAllowOverlap"},textIgnorePlacement:{type:"identity",default:0,property:"_symbol_textIgnorePlacement"},textSpacing:{type:"identity",default:250,property:"_symbol_textSpacing"},textPlacement:{type:"identity",default:"point",property:"_symbol_textPlacement"}},UF={lineWidth:{type:"identity",default:2,property:"_symbol_lineWidth"},lineStrokeWidth:{type:"identity",default:0,property:"_symbol_lineStrokeWidth"},lineColor:{type:"identity",default:[1,1,1,1],property:"_symbol_lineColor"},lineStrokeColor:{type:"identity",default:[0,0,0,0],property:"_symbol_lineStrokeColor"},lineDx:{type:"identity",default:0,property:"_symbol_lineDx"},lineDy:{type:"identity",default:0,property:"_symbol_lineDy"},linePatternFile:{type:"identity",default:null,property:"_symbol_linePatternFile"},linePatternAnimSpeed:{type:"identity",default:0,property:"_symbol_linePatternAnimSpeed"},linePatternGap:{type:"identity",default:0,property:"_symbol_linePatternGap"},lineOpacity:{type:"identity",default:1,property:"_symbol_lineOpacity"},lineJoin:{type:"identity",default:null,property:"_symbol_lineJoin"},lineCap:{type:"identity",default:null,property:"_symbol_lineCap"},lineDasharray:{type:"identity",default:null,property:"_symbol_lineDasharray"},lineDashColor:{type:"identity",default:null,property:"_symbol_lineDashColor"}},VF="_line_gradient_property",{PackUtil:WF}=ZR(),ZF=new _e(0,0),qF="_vector3dlayer_id",XF=(VF+"").trim();function JF(t,e,n){const i=(wL+"").trim(),o=t.getMap(),s=o.getGLRes();let a=t.getCoordinates();const l=[],h=[];let c=1;if(t instanceof ld||t instanceof Ad){t instanceof ld&&(a=[a]);for(let t=0;t<a.length;t++)o.coordToPointAtRes(a[t],s,ZF),l.push([ZF.x,ZF.y,a[t].z||0]),h.push([a[t].x,a[t].y])}else if(t instanceof cd||t instanceof yd){c=2,t instanceof cd&&(a=[a]);for(let t=0;t<a.length;t++){l[t]=[],h[t]=[];for(let e=0;e<a[t].length;e++)o.coordToPointAtRes(a[t][e],s,ZF),l[t].push([ZF.x,ZF.y,a[t][e].z||0]),h[t].push([a[t][e].x,a[t][e].y])}}else if(t instanceof od||t instanceof _d){c=3,t instanceof Md||t instanceof Pd||t instanceof Sd||t instanceof Id?a=[[t.getShell()]]:t instanceof od&&(a=[a]);let e=0;for(let t=0;t<a.length;t++){let n=!1;for(let i=0;i<a[t].length;i++){if(l[e]=[],h[e]=[],n)for(let n=a[t][i].length-1;n>=0;n--)o.coordToPointAtRes(a[t][i][n],s,ZF),l[e].push([ZF.x,ZF.y,a[t][i][n].z||0]),h[e].push([a[t][i][n].x,a[t][i][n].y]);else for(let n=0;n<a[t][i].length;n++)o.coordToPointAtRes(a[t][i][n],s,ZF),l[e].push([ZF.x,ZF.y,a[t][i][n].z||0]),h[e].push([a[t][i][n].x,a[t][i][n].y]);0===i&&(n=WF.calculateSignedArea(l[e])<0,n&&(l[e]=l[e].reverse(),h[e]=h[e].reverse())),e++}}}const u=t.getProperties()?Object.assign({},t.getProperties()):{},f=t._getInternalSymbol()||function(t){return t instanceof ld||t instanceof Ad?{markerType:"ellipse",markerWidth:8,markerHeight:0,markerFill:"#000"}:t instanceof cd||t instanceof yd?{lineColor:"#000",lineWidth:1}:t instanceof od||t instanceof _d?{polygonFill:"#fff",lineColor:"#000",lineWidth:1}:void 0}(t),g=n?Array.isArray(n)?n[0].id:n.id:e.id++;if(Array.isArray(f)&&f.length){const o=[],s=f.length;for(let a=0;a<s;a++){const A=a===s-1?u:QR({},u),m=QF(f[a],A);for(const t in f[a])rL(f[a],t)&&(A[("_symbol_"+t).trim()]=f[a][t]);m&&(f[a].lineGradientProperty=m);const w=n&&n[a]?n[a][i]:e.pickingId++,T={type:c,id:g,properties:A,visible:t.isVisible(),geometry:l,coordinates:h,extent:1/0};T[i]=w,o.push(T)}return o}if(f){const t=QF(f,u);for(const t in f)rL(f,t)&&(u[("_symbol_"+t).trim()]=f[t]);t&&(f.lineGradientProperty=t)}const A=n?n.id:e.pickingId++,m={type:c,id:g,properties:u,visible:t.isVisible(),geometry:l,coordinates:h,extent:1/0};return m[i]=A,m}function QF(t,e){const n=t.lineGradientProperty;return n&&(e[XF]=e[n],e.mapbox_clip_start=0,e.mapbox_clip_end=1,delete e[n]),n}let YF=class jn extends zF{postCreateGeometry(t){this.generateGradProperties(t)}startFrame(...t){super.startFrame(...t),this._updateMeshGradient()}_updateMeshGradient(){if(this._changedMeshes){for(let t=0;t<this._changedMeshes.length;t++){if(!this._changedMeshes[t]||!this._changedMeshes[t].isValid())continue;const{geometry:e,material:n}=this._changedMeshes[t],{symbolIndex:i}=e.properties;this.generateGradProperties({geometry:e,symbolIndex:i});const o=this._genGradientTexture(e.properties.gradients),s=n.get("lineGradientTexture");s&&s.destroy(),e.generateBuffers(this.regl),n.set("lineGradientTexture",o),n.set("lineGradientTextureHeight",o.height)}delete this._changedMeshes}}onFeatureChange(t,e){this._changedMeshes||(this._changedMeshes=[]);for(let n=0;n<e.length;n++){if(!e[n]||!e[n].isValid())continue;const i=e[n].geometry,{features:o}=i.properties;if(!o)continue;const s=t&&t[qF];o[s]&&(o[s].feature.properties[VF]=t.properties[VF],this._changedMeshes.push(e[n]),this.setToRedraw())}}needRebuildOnGometryPropertiesChanged(){return!1}generateGradProperties(t){const{symbolIndex:e,geometry:n}=t,{features:i}=n.properties,o=this.getSymbol(e).lineGradientProperty,s=n.properties.aPickingId||n.data.aPickingId,a=new Uint8Array(s.length),l=[],h=new Map;function c(t){let e=t&&t[o];Array.isArray(e)||(e=[0,"black",1,"black"]);let n,i=e.join();return h.has(i)?n=h.get(i):(n=l.length,h.set(i,n),l.push(e)),n}let u=s[0],f=i[u].feature.properties,g=c(f);for(let t=1;t<s.length;t++)s[t]!==u&&(u=s[t],f=i[u].feature.properties,g=c(f)),a[t]=g;if(n.data.aGradIndex){const t=n.data.aGradIndex;t&&t.buffer&&t.buffer.destroy&&t.buffer.destroy()}n.data.aGradIndex=a,n.properties.gradients=l}createMesh(t,e){const{geometry:n,symbolIndex:i,ref:o}=t,s=this.getSymbolDef(i);void 0===o&&LD(n,s,this.getFnTypeConfig(i),this.layer);const a={tileResolution:n.properties.tileResolution,tileRatio:n.properties.tileRatio,tileExtent:n.properties.tileExtent},l=this.getSymbol(i);this.setLineUniforms(l,a);const h=this._genGradientTexture(n.properties.gradients);a.lineGradientTexture=h,a.lineGradientTextureHeight=h.height,void 0===o&&n.generateBuffers(this.regl);const c=new Qb(a),u=new aw(n,c,{castShadow:!1,picking:!0});u.setLocalTransform(e);const f={HAS_GRADIENT:1};return n.data.aAltitude&&(f.HAS_ALTITUDE=1),this.setMeshDefines(f,n,s),u.setDefines(f),u.properties.symbolIndex=i,u}_genGradientTexture(t){return this.regl.texture({width:256,height:2*t.length,data:KF(t),format:"rgba",mag:"linear",min:"linear",flipY:!1})}createFnTypeConfig(t,e){return this.createShapeFnTypeConfigs(t,e)}createShader(t){this._context=t;const e=[],n={};this.fillIncludes(n,e,t),this.sceneConfig.trailAnimation&&this.sceneConfig.trailAnimation.enable&&(n.HAS_TRAIL=1);const i=[];e.push({name:"projViewModelMatrix",type:"function",fn:function(t,e){return cy(i,e.projViewMatrix,e.modelMatrix),i}}),this.shader=new zw({vert:NF,frag:"#define SHADER_NAME LINE_GRADIENT\n#define DEVICE_PIXEL_RATIO 1.0\n#define MAX_LINE_COUNT 128.0\nprecision mediump float;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_frag>\n#endif\n#ifdef HAS_OPACITY\nvarying float vOpacity;\n#else\nuniform lowp float lineOpacity;\n#endif\nuniform float layerOpacity;\nuniform lowp float lineBlur;\nuniform float lineGradientTextureHeight;\nuniform float tileExtent;\nuniform sampler2D lineGradientTexture;\nvarying vec2 vNormal;\nvarying vec2 vWidth;\nvarying float vGammaScale;\nvarying highp float vLinesofar;\nvarying float vGradIndex;\n#ifndef ENABLE_TILE_STENCIL\nvarying vec2 vPosition;\n#endif\n#ifdef HAS_TRAIL\nuniform float trailSpeed;\nuniform float trailLength;\nuniform float trailCircle;\nuniform float currentTime;\n#endif\n#include <highlight_frag>\nvoid main() {\n  \n#ifndef ENABLE_TILE_STENCIL\nfloat c = sign(tileExtent - min(tileExtent, abs(vPosition.x))) * sign(1. + sign(vPosition.x)) * sign(tileExtent - min(tileExtent, abs(vPosition.y))) * sign(1. + sign(vPosition.y));\n  if(c == .0) {\n    discard;\n  }\n#endif\nfloat d = length(vNormal) * vWidth.s;\n  float e = (lineBlur + 1. / DEVICE_PIXEL_RATIO) * vGammaScale;\n  float f = clamp(min(d - (vWidth.t - e), vWidth.s - d) / e, .0, 1.);\n  float h = vLinesofar;\n  vec4 i = texture2D(lineGradientTexture, vec2(h, (vGradIndex * 2. + .5) / lineGradientTextureHeight)) * f;\n  i *= max(sign(MAX_LINE_COUNT - vGradIndex), .0);\n#ifdef HAS_TRAIL\nfloat j = mod(h - currentTime * trailSpeed * .1, trailCircle);\n  float k = j < trailLength ? mix(.0, 1., j / trailLength) : .0;\n  i *= k;\n#endif\n#ifdef HAS_OPACITY\nfloat l = vOpacity;\n#else\nfloat l = lineOpacity;\n#endif\ngl_FragColor = i * l * layerOpacity;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nfloat m = shadow_computeShadow();\n  gl_FragColor.rgb = shadow_blend(gl_FragColor.rgb, m);\n#endif\ngl_FragColor = highlight_blendColor(gl_FragColor);\n}",uniforms:e,defines:n,extraCommandProps:this.getExtraCommandProps()})}};function KF(t){t.length>2048&&console.warn(`Gradients count is (${t.length}), it may be slow to render.`);const e=document.createElement("canvas"),n=e.getContext("2d");e.width=256,e.height=2*t.length;for(let e=0;e<t.length;e++){const i=t[e],o=n.createLinearGradient(0,0,256,0);for(let t=0;t<i.length;t+=2)o.addColorStop(+i[t],i[t+1]);n.fillStyle=o;const s=e%256;n.fillRect(0,2*s,256,2*s+2)}return n.canvas}let $F=class Xn{constructor(t){this._meshes=t||[],this.properties={}}set meshes(t){this._meshes=t}get meshes(){return this._meshes}};const tN=224,eN=100,nN=new Uint8Array(1),iN=[],rN={collides:0,boxes:[]},oN=[],sN=[];let aN=class ti extends bF{createGeometry(...t){const e=super.createGeometry(...t);if(!e||!e.geometry)return e;const{geometry:n}=e,i=t[0];n.properties.collideIds=i.featureIds&&i.featureIds.length&&i.isIdUnique?i.featureIds:i.data.aPickingId;return n.properties.uniqueCollideIds=XL(n.properties.collideIds,!(this.layer instanceof kp)),e}supportRenderMode(t){const e=this.sceneConfig.renderToPointRenderTarget;return e||void 0===e?"point"===t:"fxaa"===t||"fxaaAfterTaa"===t}addMesh(t,e,n){if(t&&!this.isEnableCollision()){let e=t;Array.isArray(e)||(oN[0]=t,e=oN);for(let t=0;t<e.length;t++){const n=e[t].defines;delete n.ENABLE_COLLISION,e[t].setDefines(n);const{elements:i,visElemts:o}=e[t].geometry.properties;o&&void 0!==o.count&&o.count!==i.length&&(e[t].geometry.setElements(i),o.count=i.length)}}return super.addMesh(t,e,n)}startMeshCollision(t){const{meshKey:e}=t.properties,{renderer:n}=this._cachedInstances,i=n.isForeground(t instanceof $F?t.meshes[0]:t);if(t.properties.isForeground=i,t instanceof $F&&t.meshes.length)for(let e=0;e<t.meshes.length;e++)t.meshes[e].properties.isForeground=i;this._startTime=performance.now(),this._canProceed=this._canProceedCollision(),this._meshCollisionStale=this._isCachedCollisionStale(e)}endMeshCollision(t){const e=this._collisionContext.tags[t];if(this._canProceed&&e&&this._meshCollisionStale){const t=this.getMap();this._anchorCoord0||(this._anchorCoord0=new gh(0,0),this._anchorCoord1=new gh(0,0)),e.anchor0=t.containerPointToCoord(this._containerAnchor0,this._anchorCoord0),e.anchor1=t.containerPointToCoord(this._containerAnchor1,this._anchorCoord1),e.anchor0.z=t.getZoom(),e.anchor0.width=t.width,e.anchor0.height=t.height,e.anchor0.pitch=t.getPitch()}this.getMap().collisionFrameTime+=performance.now()-this._startTime}_isCachedCollisionStale(t){const e=this.getMap(),n=e.getZoom(),i=e.getPitch(),[o,s]=this._getMeshAnchor(t);return!o||!s||o.z!==n||o.width!==e.width||o.height!==e.height||o.pitch!==i||o.distanceTo(this._containerAnchor0)>3||s.distanceTo(this._containerAnchor1)>3}_startCollision(){const t=this.getMap();this._coordCache={},this._containerAnchor0=new _e(t.width/3,t.height/2),this._containerAnchor1=new _e(2*t.width/3,t.height/2),delete this._canProceed,this._collisionContext||(this._collisionContext={tags:{}}),this._cachedInstances={layer:this.layer,renderer:this.layer.getRenderer(),frameTimestamp:this.layer.getRenderer().getFrameTimestamp(),map:this.getMap(),zoom:t.getZoom(),collisionTags:this._collisionContext.tags,isEnableUniquePlacement:this.isEnableUniquePlacement()}}_endCollision(){}_getCachedCollision(t,e){const n=this._collisionContext;return n.tags[t]&&n.tags[t][e]}_setCollisionCache(t,e,n){const i=this._collisionContext;i.tags[t]=i.tags[t]||[],i.tags[t][e]=n}_canProceedCollision(){const t=this.getMap();if(!t.isInteracting())return!0;return t.collisionFrameTime<=this.layer.options.collisionFrameLimit}_getMeshAnchor(t){const e="__meshAnchorKey".trim(),n=this._collisionContext.tags[t];if(n&&n.anchor0){const{anchor0:t,anchor1:i}=n,o=t[e]=t[e]||t.x+","+t.y,s=i[e]=i[e]||i.x+","+i.y;let a=this._coordCache[o],l=this._coordCache[s];if(!a||!l){const e=this.getMap();a=this._coordCache[o]=e.coordToContainerPoint(t),l=this._coordCache[s]=e.coordToContainerPoint(i)}return a.z=t.z,iN[0]=a,iN[1]=l,a.width=t.width,a.height=t.height,iN}return iN[0]=iN[1]=null,iN}updateBoxCollisionFading(t,e,n,i,o){const{layer:s,renderer:a,zoom:l,collisionTags:h,isEnableUniquePlacement:c}=this._cachedInstances,{meshKey:u,isForeground:f}=e.properties;if(c&&this._isReplacedPlacement(u,o))return!1;const g=n.length;let A=h[u]&&h[u][o];const m=A,w=this._zooming&&A;if((!w||0===A.collides)&&t){if(this._canProceed||w&&0===A.collides)if((this._meshCollisionStale||A&&A.z!==l)&&(A=null),A){if(A.boxes&&A.boxes.length){const{boxes:t,isAllowOverlap:e}=A;let n=0;if(!e){let e=0;for(let i=0;i<t.length;i++)if(!n){const o=this.isCollides(t[i]);if(-1===o)e++;else if(1===o){n=1;break}}e===t.length&&(n=-1)}A.collides=n}}else{A=m||{collides:0,boxes:[]},A.boxes.length=0,A.z=l;let t=0;for(let e=0;e<g;e++){const{mesh:s,allElements:a,boxCount:l,start:h,end:c}=n[e],u=this._isBoxVisible(s,a,l,h,c,i,o);u.isAllowOverlap&&(A.isAllowOverlap=1),0===t&&(t=u.collides),u.boxes&&A.boxes.push(...u.boxes)}A.collides=t,this._setCollisionCache(u,o,A)}}let T=t&&A&&0===A.collides,M=1,C=!1;if(this.sceneConfig.fading){const t=this._getBoxTimestamps(e);if(this._zoomingOut)t[o]=T?1:-1;else if(f&&delete e._fadeOutStartTime,M=this._getBoxFading(f,T,t,o),f?(M>0&&(T=!0),C=this.isBoxFading(e,o),C&&this.setToRedraw()):T||(this._markFadingCollided(t,o),M=0),T){const n=e._fadeOutStartTime;if(n&&1===M&&t[o]>0){let{fadeOutDelay:t,fadingDuration:e}=this.sceneConfig;NL(e)&&(e=tN),NL(t)&&(t=eN);const i=DL(1-(a.getFrameTimestamp()-n-t)/e,0,1);M*=i,i>0&&this.setToRedraw()}}}if(A&&s.options.debugCollision&&this.addCollisionDebugBox(A.boxes,A.collides?0:1),T||C){const{mesh:t,start:e}=n[0],i=this.getSymbol(t.properties.symbolIndex);!this._isIgnorePlacement(i,t,e)&&A&&A.boxes&&this._fillCollisionIndex(A.boxes,t)}if(T){const t=nN[0]=255*M;for(let e=0;e<g;e++){const{mesh:i,allElements:o,start:s,boxStart:a,end:l,boxIndex:h}=n[e];this.setCollisionOpacity(i,o,t,void 0===a?s:a,l,h)}}return T&&M>0}isMeshIterable(){return!0}setCollisionOpacity(t,e,n,i,o){this._updateOpacityData(t,n,e[i],e[o-1])}_updateOpacityData(t,e,n,i){const{aOpacity:o}=t.geometry.properties;if(!o)return;const s=n;if(o[s]!==e){const t=i;for(let n=s;n<=t;n++)o[n]=e;o.dirty=!0}}isBoxFading(t,e){const{frameTimestamp:n}=this._cachedInstances;let i=this.sceneConfig.fadingDuration;return NL(i)&&(i=tN),n-Math.abs(this._getBoxTimestamps(t)[e])<i}_isBoxVisible(t,e,n,i,o,s,a){const l=this.getSymbol(t.properties.symbolIndex),h=this._isIgnorePlacement(l,t,e[i]),c=this._isAllowOverlap(l,t,e[i]);if(!this.isEnableCollision()||h&&c)return rN;const u=this.isBoxCollides(t,e,n,i,o,s,a);return c&&(u.collides=0,u.isAllowOverlap=1),u}_isIgnorePlacement(t,e,n){if(!this.isEnableCollision())return!0;const i=e.geometry.properties.aOverlap;if(!i)return 1==+t[this.propIgnorePlacement];const o=i[n];return o<2?1==+t[this.propIgnorePlacement]:o%8%2}_isAllowOverlap(t,e,n){if(!this.isEnableCollision())return!0;const i=e.geometry.properties.aOverlap;if(!i)return 1==+t[this.propAllowOverlap];const o=i[n];return o<2?1==+t[this.propAllowOverlap]:(o>>2)%2}_fillCollisionIndex(t){if(Array.isArray(t[0]))for(let e=0;e<t.length;e++)this.insertCollisionBox(t[e]);else this.insertCollisionBox(t)}_getBoxFading(t,e,n,i){let{fadingDuration:o,fadeInDelay:s,fadeOutDelay:a}=this.sceneConfig;NL(o)&&(o=tN),NL(s)&&(s=600),NL(a)&&(a=eN);const{frameTimestamp:l}=this._cachedInstances;let h=n[i],c=e?1:0;if(!h)return e&&t&&(n[i]=l+s),0;if(l<Math.abs(h)&&(!e&&h>0||e&&h<0)){const t=l-o;n[i]=h=e?t:-t}return l-Math.abs(h)<o?c=h>0?(l-h)/o:1-(l+h)/o:e?(h<0&&(n[i]=h=l+s),c=(l-h)/o):(h>0&&(n[i]=h=-(l+a)),c=1-(l+h)/o),(c<0||c>1)&&(c=DL(c,0,1)),c}_getBoxTimestamps(t){this._boxTimestamps||(this._boxTimestamps={});const{meshKey:e}=t.properties;if(!this._boxTimestamps[e]){const{frameTimestamp:t}=this._cachedInstances;this._boxTimestamps[e]={timestamp:t}}return this._boxTimestamps[e]}_refreshTimeStamps(t){if(!this._prevTimestamp)return void(this._prevTimestamp=t);const e=this.scene.getMeshes();if(e&&e.length){for(let n=0;n<e.length;n++){const i=this._getBoxTimestamps(e[n]);i.timestamp<this._prevTimestamp?delete e[n]._fading_timestamps:i.timestamp=t}this._prevTimestamp=t}}_markFadingCollided(t,e){if(!t)return;const{frameTimestamp:n}=this._cachedInstances;let{fadingDuration:i}=this.sceneConfig;NL(i)&&(i=tN),t[e]=-(n-i-1)}deleteMesh(t,e){if(t){if(Array.isArray(t))for(let e=0;e<t.length;e++){const n=t[e].properties.meshKey;this._collisionContext&&delete this._collisionContext.tags[n],this._boxTimestamps&&delete this._boxTimestamps[n]}else{const e=t.properties.meshKey;this._collisionContext&&delete this._collisionContext.tags[e],this._boxTimestamps&&delete this._boxTimestamps[e]}super.deleteMesh(t,e)}}delete(t){this._collisionMesh&&(this._collisionMesh.geometry.dispose(),this._collisionShader.dispose(),this._collisionMesh.dispose(),delete this._collisionMesh,delete this._collisionShader,delete this._collisionRenderer),delete this._collisionContext,super.delete(t)}isCollides(t){const e=this.layer,n=e.getMap(),i=n.getDevicePixelRatio();if(__(sN,t,1/i),n.isOffscreen(sN))return-1;const o=e.getCollisionIndex(),s=this.sceneConfig.collisionBufferSize||e.options.collisionBufferSize||0;return s&&(t=uN(sN,t,s)),+o.collides(t)}insertCollisionBox(t){const e=this.layer,n=e.getCollisionIndex(),i=this.sceneConfig.collisionBufferSize||e.options.collisionBufferSize||0;let o=t;i&&(o=t._buffered=t._buffered||[],t=uN(o,t,i)),n.insertBox(o)}addCollisionDebugBox(t,e){if(t&&t.length)if(Array.isArray(t[0]))for(let n=0;n<t.length;n++){this._addCollisionBox(t[n],e)}else this._addCollisionBox(t,e)}_addCollisionBox(t,e){if(!t)return;const n=this._collisionBoxes=this._collisionBoxes||{aPosition:[],aVisible:[],indices:[]},i=this.sceneConfig.collisionBufferSize||this.layer.options.collisionBufferSize||0;i&&(t=uN(sN,t,i));const o=this.getMap(),s=o.getDevicePixelRatio();if(__(sN,t,1/s),o.isOffscreen(sN))return;const a=n.aPosition.length/2;n.aPosition.push(t[0],t[1],t[2],t[1],t[2],t[3],t[0],t[3]),n.aVisible.push(e,e,e,e),n.indices.push(a,a+1,a+1,a+2,a+2,a+3,a+3,a)}updateCollision(t){super.updateCollision(t),this._startCollision(),this._prepareZoomEndMeshes(),this._zoomEndMeshes&&this._zoomEndMeshes.length&&(this._updateZoomMeshesLevel(),this._zoomEndMeshes&&(this.setToRedraw(),this.scene.addMesh(this._zoomEndMeshes))),(this.getMap().isZooming()||this._zoomEndMeshes&&this._zoomEndMeshes.length)&&(this._updateUniquePlacements(),this._mergeUniquePlacements(this.scene.getMeshes()))}paint(t){const e=super.paint(t);return this._renderCollisionBox(t),!1===this._canProceed&&this.setToRedraw(),e}shouldIgnoreBackground(){return!this.getMap().isZooming()&&!this._zoomEndMeshes}_prepareZoomEndMeshes(){const t=this.getMap(),e=t.isZooming();if(!e&&this._zooming){const t=this.layer.getRenderer();this._zoomEndMeshes=this.scene.getMeshes().filter((e=>!t.isForeground(e)&&!e.properties.isLinePlacement))}else e&&!this._zooming&&(this._preRes=t.getResolution());if(e)this._clearTimeout&&(clearTimeout(this._clearTimeout),delete this._zoomingOut,delete this._clearTimeout),this._zoomingOut=this._preRes&&t.getResolution()>this._preRes;else if(this._zooming&&!this._clearTimeout){let{fadeOutDelay:t,fadingDuration:e}=this.sceneConfig;NL(t)&&(t=eN),NL(e)&&(e=tN),this._clearTimeout=setTimeout((()=>{delete this._zoomingOut,delete this._clearTimeout}),t+e+1)}this._zooming=e}_renderCollisionBox(t){if(!this._collisionBoxes||!this.layer.options.debugCollision)return;this._collisionRenderer||this._initCollisionShader();const{aPosition:e,aVisible:n,indices:i}=this._collisionBoxes;if(!this._collisionMesh){const t=new vb({aPosition:[],aVisible:[]},[],0,{positionSize:2,primitive:"lines"});this._collisionMesh=new aw(t),this._collisionScene=new _w,this._collisionScene.addMesh(this._collisionMesh)}const o=this._collisionMesh.geometry;o.updateData("aPosition",new Float32Array(e)),o.updateData("aVisible",new Uint8Array(n)),o.setElements(i),this._collisionRenderer.render(this._collisionShader,{size:[this.canvas.width,this.canvas.height]},this._collisionScene,this.getRenderFBO(t)),delete this._collisionBoxes}_initCollisionShader(){this._collisionRenderer=new cw(this.regl);const t=this.canvas;this._collisionShader=new zw({vert:"attribute vec2 aPosition;\nattribute float aVisible;\nuniform vec2 size;\nvarying vec4 vColor;\nvoid main() {\n  vec2 c = (aPosition / size - .5) * 2. * vec2(1., -1.);\n  gl_Position = vec4(c, .0, 1.);\n  vColor = mix(vec4(1., .0, .0, 1.5) * .5, vec4(.0, 1., .0, 1.) * .4, aVisible);\n}",frag:"precision mediump float;\nvarying vec4 vColor;\nvoid main() {\n  gl_FragColor = vec4(vColor.rgb, .5);\n}",uniforms:["size"],extraCommandProps:{viewport:{x:0,y:0,width:()=>t?t.width:1,height:()=>t?t.height:1},depth:{enable:!1},blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}})}_updateZoomMeshesLevel(){let{fadeOutDelay:t,fadingDuration:e}=this.sceneConfig;NL(t)&&(t=eN),NL(e)&&(e=tN);const n=this.layer.getRenderer(),i=n.getCurrentTileZoom(),o=n.getFrameTimestamp(),s=[];for(let a=0;a<this._zoomEndMeshes.length;a++){const l=this._zoomEndMeshes[a],h=l.properties.tile;!l._fadeOutStartTime&&n.isBackTile(h.id)&&(l._fadeOutStartTime=o);l.properties.level=h.z-i>0?2*(h.z-i)-1:2*(i-h.z),n.isForeground(l)||l._fadeOutStartTime&&o-l._fadeOutStartTime>t+e?delete l._fadeOutStartTime:s.push(l)}delete this._zoomEndMeshes,s.length&&(this._zoomEndMeshes=s)}isEnableCollision(){return this.layer.options.collision&&!!this.sceneConfig.collision}isEnableUniquePlacement(){return this.isEnableCollision()&&this.sceneConfig.uniquePlacement}isMeshUniquePlaced(t){return this.isMeshIterable(t)}_updateUniquePlacements(){if(!this.isEnableUniquePlacement())return;const t=this.scene.getMeshes(),e=(t,e,n,i)=>{const{start:o,end:s}=e[0],a=t.geometry.properties,l=a.elements;let h=a.uniquePlacements;if(h||(h=a.uniquePlacements=[]),void 0===h[i]){const e=this.getUniqueEntryKey(t,l[o],i);h[i]=e?{key:e,index:i,start:l[o],end:l[s-1]}:null}};for(let n=0;n<t.length;n++){const i=t[n];this.isMeshUniquePlaced(i)&&this.forEachBox(i,e)}}_mergeUniquePlacements(t){if(!this.isEnableUniquePlacement())return;const e=this.getMap().getZoom();let n=!this._mergedMeshes||this._mergedMehesZoom!==e;if(!n)for(let e=0;e<t.length;e++)if(!this._mergedMeshes[t[e].properties.meshKey]){n=!0;break}if(!n)return;this._mergedMehesZoom=e,this._replacedPlacements={},this._mergedMeshes={},t=t.sort(cN);const i=this.getMap().getGLScale(),o={};for(let e=0;e<t.length;e++){const n=t[e];if(!n.geometry)continue;const{meshKey:s}=n.properties;this._mergedMeshes[s]=1;const{uniquePlacements:a}=n.geometry.properties;if(a)for(let t=0;t<a.length;t++){if(!a[t])continue;const{key:e,index:s}=a[t],l=this._getBoxTimestamps(n),h=hN(e,i),c=o[h];if(c){const t=c.length,e=c[t-3].properties.meshKey,i=c[t-2],o=c[t-1];this._replacedPlacements[e]=this._replacedPlacements[e]||{},this._replacedPlacements[e][o]=1,this._updatePlacementStamps(l,s,i,o),c.push(n,l,s)}else o[h]=[n,l,s]}}for(const t in o){const e=o[t];if(e.length<=6)continue;const n=e.length,i=e[n-2][e[n-1]];if(e[1][e[2]]!==i)for(let t=0;t<n-6;t+=3)e[t+1][e[t+2]]=i}}_updatePlacementStamps(t,e,n,i){if(void 0!==n[i])if(void 0===t[e])t[e]=n[i];else{let o=t[e];Math.abs(n[i])>Math.abs(o)?t[e]=n[i]:n[i]=t[e]}else void 0!==t[e]&&(n[i]=t[e])}_isReplacedPlacement(t,e){return this._replacedPlacements&&this._replacedPlacements[t]&&this._replacedPlacements[t][e]}_getCollideBoxes(t,e){const{symbolIndex:n}=t.properties,i=n.type||0;let o=t.properties._collidesBoxes;o||(o=t.properties._collidesBoxes=[]);let s=o[n.index];s||(s=t.properties._collidesBoxes=[]),s[i]||(s[i]=[]),s=s[i];const a=e/6;if(!s[a]){const t=[];s[a]={boxes:t,collision:{boxes:t}}}return s[a]}_getMeshBoxes(t){let e=this._MeshBoxes;if(e||(e=this._MeshBoxes=[]),!e[t]){e[t]=[];for(let n=0;n<t;n++)e[t][n]={}}return e[t]}_isHalo0(t){if(!t||!t.geometry)return!0;const e=WD(this.getSymbolDef(t.geometry.properties.symbolIndex).textHaloRadius);return!(!t.geometry.properties.glyphAtlas||!t.material.get("isHalo")||e&&t.geometry.properties.hasHalo)&&(!(!e||t.geometry.properties.hasHalo)||!this.getSymbol(t.geometry.properties.symbolIndex).textHaloRadius)}};const lN=10;function hN(t,e){return Math.round(t[0]/e/lN)*Math.round(t[1]/e/lN)*(t[2]?Math.round(t[2]/lN):1)+"-"+t[3]}function cN(t,e){const n=e.properties.level-t.properties.level;return 0===n?t.properties.meshKey-e.properties.meshKey:n}function uN(t,e,n){return t[0]=e[0]-n,t[1]=e[1]-n,t[2]=e[2]+n,t[3]=e[3]+n,t}var fN="#include <gl2_vert>\n#define SHADER_NAME MARKER\n#define RAD 0.0174532925\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\nattribute vec4 aShape;\n#ifdef ENABLE_COLLISION\nattribute float aOpacity;\n#endif\n#ifdef HAS_OPACITY\nattribute vec2 aColorOpacity;\n#endif\n#ifdef HAS_TEXT_SIZE\nattribute float aTextSize;\n#else\nuniform float textSize;\n#endif\n#if defined(HAS_TEXT_DX) || defined(HAS_TEXT_DY) || defined(HAS_MARKER_DX) || defined(HAS_MARKER_DY)\nattribute vec4 aDxDy;\n#endif\n#ifndef HAS_MARKER_DX\nuniform float markerDx;\n#endif\n#ifndef HAS_MARKER_DY\nuniform float markerDy;\n#endif\n#ifndef HAS_TEXT_DX\nuniform float textDx;\n#endif\n#ifndef HAS_TEXT_DY\nuniform float textDy;\n#endif\n#ifdef HAS_MARKER_WIDTH\nattribute float aMarkerWidth;\n#else\nuniform float markerWidth;\n#endif\n#ifdef HAS_MARKER_HEIGHT\nattribute float aMarkerHeight;\n#else\nuniform float markerHeight;\n#endif\n#if defined(HAS_MARKER_PITCH_ALIGN) || defined(HAS_TEXT_PITCH_ALIGN)\nattribute vec2 aPitchAlign;\n#endif\n#ifndef HAS_MARKER_PITCH_ALIGN\nuniform float markerPitchWithMap;\n#endif\n#ifndef HAS_TEXT_PITCH_ALIGN\nuniform float textPitchWithMap;\n#endif\n#if defined(HAS_MARKER_ROTATION_ALIGN) || defined(HAS_TEXT_ROTATION_ALIGN)\nattribute vec2 aRotationAlign;\n#endif\n#ifndef HAS_MARKER_ROTATION_ALIGN\nuniform float markerRotateWithMap;\n#endif\n#ifndef HAS_TEXT_ROTATION_ALIGN\nuniform float textRotateWithMap;\n#endif\nuniform float flipY;\n#if defined(HAS_MARKER_ROTATION) || defined(HAS_TEXT_ROTATION)\nattribute vec2 aRotation;\n#endif\n#ifndef HAS_MARKER_ROTATION\nuniform float markerRotation;\n#endif\n#ifndef HAS_TEXT_ROTATION\nuniform float textRotation;\n#endif\n#ifdef HAS_PAD_OFFSET\nattribute vec2 aPadOffset;\n#endif\nuniform float cameraToCenterDistance;\nuniform mat4 positionMatrix;\nuniform mat4 projViewModelMatrix;\nuniform float textPerspectiveRatio;\nuniform float markerPerspectiveRatio;\nuniform float glyphSize;\nuniform vec2 iconSize;\nuniform vec2 canvasSize;\nuniform vec2 iconTexSize;\nuniform vec2 glyphTexSize;\nuniform float mapPitch;\nuniform float mapRotation;\nuniform float zoomScale;\nuniform float tileRatio;\nuniform float layerScale;\nuniform float isRenderingTerrain;\n#include <vt_position_vert>\nvarying float vIsText;\n#ifndef PICKING_MODE\nvarying vec2 vTexCoord;\nvarying float vOpacity;\nvarying float vGammaScale;\nvarying float vTextSize;\nvarying float vHalo;\n#ifdef HAS_TEXT_FILL\nattribute vec4 aTextFill;\nvarying vec4 vTextFill;\n#endif\n#ifdef HAS_TEXT_HALO_FILL\nattribute vec4 aTextHaloFill;\nvarying vec4 vTextHaloFill;\n#endif\n#if defined(HAS_TEXT_HALO_RADIUS) || defined(HAS_TEXT_HALO_OPACITY)\nattribute vec2 aTextHalo;\nvarying vec2 vTextHalo;\n#endif\n#include <highlight_vert>\n#else\n#include <fbo_picking_vert>\n#endif\nvoid main() {\n  vec3 c = unpackVTPosition();\n#ifdef HAS_TEXT_SIZE\nfloat d = aTextSize * layerScale;\n#else\nfloat d = textSize * layerScale;\n#endif\n#ifdef HAS_TEXT_DX\nfloat e = aDxDy.z;\n#else\nfloat e = textDx;\n#endif\n#ifdef HAS_TEXT_DY\nfloat f = aDxDy.w;\n#else\nfloat f = textDy;\n#endif\n#ifdef HAS_MARKER_WIDTH\nfloat h = aMarkerWidth;\n#else\nfloat h = markerWidth;\n#endif\n#ifdef HAS_MARKER_HEIGHT\nfloat i = aMarkerHeight;\n#else\nfloat i = markerHeight;\n#endif\n#ifdef HAS_MARKER_DX\nfloat j = aDxDy.x;\n#else\nfloat j = markerDx;\n#endif\n#ifdef HAS_MARKER_DY\nfloat k = aDxDy.y;\n#else\nfloat k = markerDy;\n#endif\nfloat l = mod(aShape.z, 2.);\n  float m;\n  if(l > .5) {\n    \n#ifdef HAS_TEXT_PITCH_ALIGN\nm = aPitchAlign.y;\n#else\nm = textPitchWithMap;\n#endif\n  } else {\n    \n#ifdef HAS_MARKER_PITCH_ALIGN\nm = aPitchAlign.x;\n#else\nm = markerPitchWithMap;\n#endif\n  }\n  float n;\n  if(l > .5) {\n    \n#ifdef HAS_TEXT_ROTATION_ALIGN\nn = aRotationAlign.y;\n#else\nn = textRotateWithMap;\n#endif\n  } else {\n    \n#ifdef HAS_MARKER_ROTATION_ALIGN\nn = aRotationAlign.x;\n#else\nn = markerRotateWithMap;\n#endif\n  }\n  gl_Position = projViewModelMatrix * positionMatrix * vec4(c, 1.);\n  float o = gl_Position.w;\n  float u;\n  if(isRenderingTerrain == 1. && m == 1.) {\n    u = 1.;\n  } else {\n    float v = (1. - cameraToCenterDistance / o) * markerPerspectiveRatio;\n    u = clamp(.5 + .5 * (1. - v), .0, 4.);\n  }\n  float A;\n  if(l > .5) {\n    \n#ifdef HAS_TEXT_ROTATION\nA = -aRotation.y / 9362. - mapRotation * n;\n#else\nA = -textRotation - mapRotation * n;\n#endif\n  } else {\n    \n#ifdef HAS_MARKER_ROTATION\nA = -aRotation.x / 9362. - mapRotation * n;\n#else\nA = -markerRotation - mapRotation * n;\n#endif\n  }\n  if(m == 1.) {\n    \n#ifdef REVERSE_MAP_ROTATION_ON_PITCH\nA += mapRotation;\n#else\nif(l > .5) {\n      A -= mapRotation;\n    } else {\n      A += mapRotation;\n    }\n#endif\n  }\n  float B = sin(A);\n  float C = cos(A);\n  mat2 D = mat2(C, -1. * B, B, C);\n  vec2 E = (aShape.xy / 10.0);\n  if(m == 1. && flipY == .0) {\n    E *= vec2(1., -1.);\n  }\n  vIsText = l;\n  if(l > .5) {\n    E = E / glyphSize * d;\n  } else {\n    \n#ifdef HAS_PAD_OFFSET\nfloat F = aPadOffset.x - 1.;\n    float G = aPadOffset.y;\n#else\nfloat F = .0;\n    float G = .0;\n#endif\nE = (E / iconSize * vec2(h, i) + vec2(F, G)) * layerScale;\n  }\n  E = D * E;\n  float H;\n  if(isRenderingTerrain == 1.) {\n    H = 1.;\n  } else {\n    H = o / cameraToCenterDistance;\n  }\n  if(m == .0) {\n    vec2 I = E * 2. / canvasSize;\n    gl_Position.xy += I * u * o;\n  } else if(l > .5) {\n    float J;\n    if(isRenderingTerrain == 1.) {\n      J = tileRatio / zoomScale;\n    } else {\n      J = tileRatio / zoomScale * H * u;\n    }\n    vec2 I = E;\n    gl_Position = projViewModelMatrix * positionMatrix * vec4(c + vec3(I, .0) * J, 1.);\n  } else {\n    vec2 I = E;\n    gl_Position = projViewModelMatrix * positionMatrix * vec4(c + vec3(I, .0) * tileRatio / zoomScale * H * u, 1.);\n  }\n  if(l > .5) {\n    gl_Position.xy += vec2(e, -f) * 2. / canvasSize * o;\n  } else {\n    gl_Position.xy += vec2(j, -k) * 2. / canvasSize * o;\n  }\n#ifndef PICKING_MODE\nif(m == .0) {\n    vGammaScale = mix(1., H, textPerspectiveRatio);\n  } else {\n    vGammaScale = H + mapPitch / 4.;\n  }\n  vGammaScale = clamp(vGammaScale, .0, 1.);\n  vec2 K = floor(aShape.zw / 2.);\n  if(l > .5) {\n    vTexCoord = K / glyphTexSize;\n  } else {\n    vTexCoord = K / iconTexSize;\n  }\n  vHalo = mod(aShape.w, 2.);\n  vTextSize = d;\n#ifdef ENABLE_COLLISION\nvOpacity = aOpacity / 255.;\n#else\nvOpacity = 1.;\n#endif\n#ifdef HAS_OPACITY\nif(l > .5) {\n    vOpacity *= aColorOpacity.y / 255.;\n  } else {\n    vOpacity *= aColorOpacity.x / 255.;\n  }\n#endif\n#ifdef HAS_TEXT_FILL\nvTextFill = aTextFill / 255.;\n#endif\n#ifdef HAS_TEXT_HALO_FILL\nvTextHaloFill = aTextHaloFill / 255.;\n#endif\n#if defined(HAS_TEXT_HALO_RADIUS) || defined(HAS_TEXT_HALO_OPACITY)\nvTextHalo = aTextHalo;\n#endif\nhighlight_setVarying();\n#else\n#ifdef ENABLE_COLLISION\nbool L = aOpacity == 255.;\n#else\nbool L = true;\n#endif\nfbo_picking_setData(gl_Position.w, L);\n#endif\n}";const dN=[],gN=[],pN=[],AN=[],mN=[],yN=[];function _N(t,e,n,i,o,s,a,l,h,c,u,f,g,A){const{tileRatio:m,tileResolution:w}=h,T=m/(w/c.getResolution())*(u/c.cameraToCenterDistance)*f;Fv(n,n,T),Fv(i,i,T),Fv(o,o,T),Fv(s,s,T),Fy(dN,n[0],n[1],g?n[2]/A:0),Fy(gN,i[0],i[1],g?i[2]/A:0),Fy(pN,o[0],o[1],g?o[2]/A:0),Fy(AN,s[0],s[1],g?s[2]/A:0),Ny(dN,dN,e),Ny(gN,gN,e),Ny(pN,pN,e),Ny(AN,AN,e),QD(n,dN,a,c.width,c.height),QD(i,gN,a,c.width,c.height),QD(o,pN,a,c.width,c.height),QD(s,AN,a,c.width,c.height),Ev(mN,Math.min(n[0],i[0],o[0],s[0]),Math.min(n[1],i[1],o[1],s[1])),Ev(yN,Math.max(n[0],i[0],o[0],s[0]),Math.max(n[1],i[1],o[1],s[1])),g_(t,mN[0]+l[0],mN[1]+l[1],yN[0]+l[0],yN[1]+l[1])}function vN(t,e,n,i,o,s,a,l){1!==l&&(Fv(n,n,l),Fv(i,i,l),Fv(o,o,l),Fv(s,s,l)),Ev(mN,Math.min(n[0],i[0],o[0],s[0]),Math.min(n[1],i[1],o[1],s[1])),Ev(yN,Math.max(n[0],i[0],o[0],s[0]),Math.max(n[1],i[1],o[1],s[1])),g_(t,e[0]+mN[0]+a[0],e[1]+mN[1]-a[1],e[0]+yN[0]+a[0],e[1]+yN[1]-a[1])}function xN(t,e,n,i,o){e-=n*i,1===o&&(e+=n);const s=Math.sin(e),a=Math.cos(e);return Gm(t,a,-s,s,a)}const bN=15,wN=15,TN=2048,MN=24,CN=.01,SN=[],PN=[],IN=[],ON=[],EN=[],kN=[],RN=[],LN=[],DN=[1,-1],FN=[1,1];function NN(t,e,n,i,o){const s=e.material.uniforms,a=o.cameraToCenterDistance,l=e.geometry.properties,h=this.getSymbol(l.symbolIndex),c=e.geometry.desc.positionSize,u=l.aAnchor,f=Fy(SN,u[n*c],u[n*c+1],2===c?0:u[n*c+2]),{aTerrainAltitude:g}=l;if(g){const t=100*g[2*n];t&&(f[2]+=t)}let A=QD(PN,f,i,o.width,o.height);const m=A[2];let w=1;s.markerPerspectiveRatio&&(w=DL(.5+.5*(1-(1-a/m)*s.markerPerspectiveRatio),0,4));const{aShape:T,aMarkerDx:M,aMarkerDy:C,aMarkerWidth:P,aMarkerHeight:I,aPitchAlign:O,aRotationAlign:E,aRotation:D}=l,N=O?O[2*n]:s.markerPitchWithMap,H=E?E[2*n]:s.markerRotateWithMap,U=Ev(LN,(M?M[n]:h.markerDx)||0,-((C?C[n]:h.markerDy)||0));let W=Ev(ON,T[2*n]/10,T[2*n+1]/10),q=Ev(EN,T[2*n+2]/10,T[2*n+3]/10),X=Ev(kN,T[2*n+4]/10,T[2*n+5]/10),J=Ev(RN,T[2*n+6]/10,T[2*n+7]/10);0===s.flipY&&1===N&&(Lv(W,W,DN),Lv(q,q,DN),Lv(X,X,DN),Lv(J,J,DN));const[Q,Y]=SF(e.geometry);let K=P?P[n]:h.markerWidth;NL(K)&&(K=Q||bN);let $=I?I[n]:h.markerHeight;NL($)&&($=Y||wN);const tt=Ev(FN,K/TN,$/TN);let et;Zv(W,W,tt),Zv(q,q,tt),Zv(X,X,tt),Zv(J,J,tt),et=D?D[2*n]/9362:-(h.markerRotation||0)*Math.PI/180;const nt=-et,it=o.getBearing()*Math.PI/180;if(it*H||nt){const t=xN(IN,nt,it,H,N);W=Gv(W,W,t),q=Gv(q,q,t),X=Gv(X,X,t),J=Gv(J,J,t)}1===N?_N(t,f,W,q,X,J,i,U,s,o,m,w):(Lv(W,W,DN),Lv(q,q,DN),Lv(X,X,DN),Lv(J,J,DN),vN(t,A,W,q,X,J,U,w));const rt=this.getMap().getDevicePixelRatio();return 1!==rt&&(t[0]*=rt,t[1]*=rt,t[2]*=rt,t[3]*=rt),t}const{PackUtil:HN}=ZR(),BN=1,zN=[],GN=[],jN=[],UN=[],VN=[],WN=[],ZN=[1,-1];function qN(t,e,n,i,o,s,a,l,h){const c=i.material.uniforms,u=h.cameraToCenterDistance,f=i.geometry.properties,g=this.getSymbol(f.symbolIndex),A="line"===g.textPlacement&&!ZL(g),m=MN,w=n[2];let T=1;c.textPerspectiveRatio&&(T=DL(.5+.5*(1-(1-u/w)*c.textPerspectiveRatio),0,4));const{aTextDx:M,aTextDy:C,aPitchAlign:P,aRotationAlign:I,aRotation:O,aType:E,aDxDy:D}=i.geometry.properties;let N,H,U;D?(N=D[4*a+2],H=D[4*a+3]):(N=M?M[a]:g.textDx,H=C?C[a]:g.textDy),P&&(U=E?P[2*a+1]:P[a]);const W=P?U:c.textPitchWithMap;let q;I&&(q=E?I[2*a+1]:I[a]);const X=I?q:c.textRotateWithMap,J=Ev(WN,N||0,-(H||0));if(A){const{aOffset:i,aShape:o}=f,s=i.length!==o.length;let u,g,A,m;if(s?(u=Fy(GN,i[3*a]/10,i[3*a+1]/10,i[3*a+2]/10),g=Fy(jN,i[3*a+3]/10,i[3*a+4]/10,i[3*a+5]/10),A=Fy(UN,i[3*a+6]/10,i[3*a+7]/10,i[3*a+8]/10),m=Fy(VN,i[3*a+9]/10,i[3*a+10]/10,i[3*a+11]/10)):(u=Ev(GN,i[2*a]/10,i[2*a+1]/10),g=Ev(jN,i[2*a+2]/10,i[2*a+3]/10),A=Ev(UN,i[2*a+4]/10,i[2*a+5]/10),m=Ev(VN,i[2*a+6]/10,i[2*a+7]/10)),1===W){const n=oL(h.getResolution(),h);_N(t,e,u,g,A,m,l,J,c,h,w,T,s,n)}else Lv(u,u,ZN),Lv(g,g,ZN),Lv(A,A,ZN),Lv(m,m,ZN),vN(t,n,u,g,A,m,J,T)}else{const{aShape:i}=f;let s,u=Ev(GN,i[2*a]/10,-i[2*a+1]/10),M=Ev(jN,i[2*a+2]/10,-i[2*a+3]/10),C=Ev(UN,i[2*a+4]/10,-i[2*a+5]/10),P=Ev(VN,i[2*a+6]/10,-i[2*a+7]/10);0===c.flipY&&1===W&&(Lv(u,u,ZN),Lv(M,M,ZN),Lv(C,C,ZN),Lv(P,P,ZN)),s=O?E&&O.length>E.length?O[2*a+1]/9362:O[a]/9362:(g.textRotation||0)*Math.PI/180;const I=A?0:h.getBearing()*Math.PI/180;if(s||I){const t=xN(zN,s,I,X,W);u=Gv(u,u,t),M=Gv(M,M,t),C=Gv(C,C,t),P=Gv(P,P,t)}const D=o/m;Fv(u,u,D),Fv(M,M,D),Fv(C,C,D),Fv(P,P,D),1===W?_N(t,e,u,M,C,P,l,J,c,h,w,T):vN(t,n,u,M,C,P,J,T)}t[0]-=(s=s||0)+BN,t[1]-=s+BN,t[2]+=s+BN,t[3]+=s+BN;const Q=this.getMap().getDevicePixelRatio();return 1!==Q&&(t[0]*=Q,t[1]*=Q,t[2]*=Q,t[3]*=Q),t}function XN(t,e,n){const i=e.geometry.desc.positionSize,{aAnchor:o,aAltitude:s,aTerrainAltitude:a}=e.geometry.properties,l=n*i;if(s?Fy(t,o[l],o[l+1],s[n]):3===i?HN.unpackPosition(t,o[l],o[l+1],o[l+2]):Fy(t,o[l],o[l+1],0),a){const e=100*a[2*n];e&&(t[2]+=e)}return t}kw.register("text_render_frag","#define HAS_HIGHLIGHT_COLOR_POINT 1\n#define SDF_PX 8.0\n#define DEVICE_PIXEL_RATIO 1.0\n#define EDGE_GAMMA 0.105 / DEVICE_PIXEL_RATIO\nuniform sampler2D glyphTex;\nuniform float textOpacity;\nuniform highp float gammaScale;\nuniform float isHalo;\nuniform highp float textHaloBlur;\n#if defined(HAS_TEXT_HALO_OPACITY) || defined(HAS_TEXT_HALO_RADIUS)\n    varying vec2 vTextHalo;\n#endif\n#ifndef HAS_TEXT_HALO_OPACITY\n    uniform float textHaloOpacity;\n#endif\n#ifndef HAS_TEXT_HALO_RADIUS\n    uniform highp float textHaloRadius;\n#endif\nvarying float vTextSize;\nvarying float vGammaScale;\n#ifdef HAS_TEXT_FILL\n    varying vec4 vTextFill;\n#else\n    uniform vec4 textFill;\n#endif\n#ifdef HAS_TEXT_HALO_FILL\n    varying vec4 vTextHaloFill;\n#else\n    uniform vec4 textHaloFill;\n#endif\nvec4 renderText(vec2 texCoord) {\n    #ifdef HAS_TEXT_FILL\n        vec4 myTextFill = vTextFill;\n    #else\n        vec4 myTextFill = textFill;\n    #endif\n    float fontScale = vTextSize / 24.0;\n    vec4 color = myTextFill;\n    highp float gamma = EDGE_GAMMA / (fontScale * gammaScale);\n    lowp float buff = 185.0 / 256.0;    bool isHaloText;\n    #ifdef HAS_HALO_ATTR\n        isHaloText = vHalo > 0.5;\n    #else\n        isHaloText = isHalo == 1.0;\n    #endif\n    if (isHaloText) {\n        #ifdef HAS_TEXT_HALO_FILL\n            vec4 haloFill = vTextHaloFill;\n        #else\n            vec4 haloFill = textHaloFill;\n        #endif\n        #ifdef HAS_TEXT_HALO_RADIUS\n            float haloRadius = vTextHalo.x;\n        #else\n            float haloRadius = textHaloRadius;\n        #endif\n        if (haloRadius == 0.0) {\n            discard;\n        }\n        color = haloFill;\n        gamma = (textHaloBlur * 1.19 / SDF_PX + EDGE_GAMMA) / (fontScale * gammaScale);\n        buff = (6.0 - haloRadius / fontScale) / SDF_PX;\n        #ifdef HAS_TEXT_HALO_OPACITY\n            float haloOpacity = vTextHalo.y / 255.0;\n        #else\n            float haloOpacity = textHaloOpacity;\n        #endif\n        color *= haloOpacity * 1.25;\n    }\n    float dist = texture2D(glyphTex, texCoord).a;\n    highp float gammaScaled = gamma * vGammaScale * 0.7;\n    float alpha = clamp(smoothstep(buff - gammaScaled, buff + gammaScaled, dist), 0.0, 1.0);\n    return color * (alpha * textOpacity);\n}");const JN={textFill:[0,0,0,1],textOpacity:1,textPitchAlignment:0,textRotationAlignment:0,textHaloRadius:0,textHaloFill:[1,1,1,1],textHaloBlur:0,textHaloOpacity:1,textPerspectiveRatio:0,textSize:14,textDx:0,textDy:0,textRotation:0};function QN(t,e,n,i,o,s,a,l,h){const c=[];if(e.isDisposed()||0===e.data.aPosition.length)return c;const u=e.properties.glyphAtlas;if(!u)return c;if(0===i.textSize||0===i.textOpacity)return c;KN.call(this,e,i,s,a,l,h);const f=$N.call(this,{},t,e,o);let g=!1;o.textOpacity<1&&(g=!0),e.properties.memorySize=e.getMemorySize(),e.generateBuffers(t,{excludeElementsInVAO:!0});const A=new Qb(f,JN),m=new aw(e,A,{disableVAO:!0,transparent:g,castShadow:!1,picking:!0});if(m.setLocalTransform(n),m.setUniform("alphaTest",CN),f.isHalo&&(m.properties.isHalo=!0),a&&m.setDefines({ENABLE_COLLISION:1}),c.push(m),f.isHalo){const t=YN.call(this,e,o,f.glyphTex,u,a,n);t.properties.haloMesh=m,c.push(t)}return c.forEach((t=>{const n=t.defines||{};tH.call(this,n,t),t.setDefines(n),t.properties.symbolIndex=e.properties.symbolIndex})),c}function YN(t,e,n,i,o,s){let a=!1;e.textOpacity<1&&(a=!0);const l={flipY:0,tileResolution:t.properties.tileResolution,tileRatio:t.properties.tileRatio,glyphTex:n,glyphTexSize:[i.width,i.height],isHalo:0};nH(t,l,e);const h=new Qb(l,JN),c=new aw(t,h,{disableVAO:!0,transparent:a,castShadow:!1,picking:!0});return c.setUniform("alphaTest",CN),Object.defineProperty(c.properties,"textSize",{enumerable:!0,get:function(){return l.textSize}}),o&&c.setDefines({ENABLE_COLLISION:1}),c.setLocalTransform(s),c}function KN(t,e,n,i,o,s){LD(t,e,n,this.layer);const a=t.properties;if(!a.textInitialized){eH.call(this,t,i||s,o),a.textInitialized=!0;const{aTextSize:e,aTextDx:n,aTextDy:l,aPitchAlign:h,aRotationAlign:c,aRotation:u,aOverlap:f,aAltitude:g}=t.data;if(e){const t=(kD+"aTextSize").trim();a.aTextSize=a[t]||new e.constructor(e)}if(n){const t=(kD+"aTextDx").trim();a.aTextDx=a[t]||new n.constructor(n)}if(l){const t=(kD+"aTextDy").trim();a.aTextDy=a[t]||new l.constructor(l)}if(h){const t=(kD+"aPitchAlign").trim();a.aPitchAlign=a[t]||new h.constructor(h)}if(c){const t=(kD+"aRotationAlign").trim();a.aRotationAlign=a[t]||new c.constructor(c)}if(u){const t=(kD+"aRotation").trim();a.aRotation=a[t]||new u.constructor(u)}if(f){const t=(kD+"aOverlap").trim();a.aOverlap=a[t]||new f.constructor(f)}if(g){const t=(kD+"aAltitude").trim();a.aAltitude=a[t]||new g.constructor(g)}}}function $N(t,e,n,i){const o=n.properties.glyphAtlas,s=o&&TF(e,o,!1);return LL(t=t||{},{flipY:0,tileResolution:n.properties.tileResolution,tileRatio:n.properties.tileRatio,glyphTex:s||this._emptyTexture,glyphTexSize:[o&&o.width||0,o&&o.height||0]}),nH(n,t,i),t}function tH(t,e){const n=e.geometry;n.data.aTextFill&&(t.HAS_TEXT_FILL=1),n.data.aTextSize&&(t.HAS_TEXT_SIZE=1),n.data.aColorOpacity&&(t.HAS_OPACITY=1),n.data.aTextHaloFill&&e.material.uniforms.isHalo&&(t.HAS_TEXT_HALO_FILL=1);const i=this.getSymbolDef(n.properties.symbolIndex);WD(i.textHaloRadius)&&e.material.uniforms.isHalo&&(t.HAS_TEXT_HALO_RADIUS=1),WD(i.textHaloOpacity)&&e.material.uniforms.isHalo&&(t.HAS_TEXT_HALO_OPACITY=1),WD(i.textDx)&&(t.HAS_TEXT_DX=1),WD(i.textDy)&&(t.HAS_TEXT_DY=1),n.data.aPitchAlign&&(t.HAS_PITCH_ALIGN=1),WD(i.textRotationAlignment)&&(t.HAS_TEXT_ROTATION_ALIGN=1),n.data.aRotation&&(t.HAS_TEXT_ROTATION=1),n.data.aAltitude&&(t.HAS_ALTITUDE=1),n.properties.aOffset&&n.properties.aShape&&n.properties.aOffset.length!==n.properties.aShape.length&&(t.HAS_OFFSET_Z=1)}function eH(t,e,n){const i=t.properties,o=this.getSymbol(i.symbolIndex),s="line"===i.textPlacement&&!ZL(o),{aPosition:a,aShape:l}=t.data,h=a.length/t.desc.positionSize;if(i.vertexCount=h,i.aPickingId=t.data.aPickingId,i.aCount||(i.aCount=t.data.aCount,delete t.data.aCount),e||s){let t=l;if(l.length===4*h){t=new l.constructor(2*h);for(let e=0;e<h;e++)t[2*e]=l[4*e],t[2*e+1]=l[4*e+1]}i.aAnchor=a,i.aShape=t}if(i.visElemts||(i.elements=t.elements,i.visElemts=new t.elements.constructor(t.elements.length)),s){const{aVertical:e,aSegment:n,aGlyphOffset:o,aPitchRotation:s}=t.data,a=!!s;i.aGlyphOffset=o,i.aPitchRotation=s,i.aSegment=n,i.aVertical=e,delete t.data.aSegment,delete t.data.aVertical,delete t.data.aGlyphOffset,delete t.data.aPitchRotation;const l=h*(a?3:2);t.data.aOffset={usage:"dynamic",data:new Int16Array(l)},i.aOffset=new Int16Array(l)}if(e){t.data.aOpacity={usage:"dynamic",data:new Uint8Array(h)},i.aOpacity=new Uint8Array(h),n&&(i.aOpacity.fill(255,0),t.data.aOpacity.data.fill(255,0));const{aTextHalo:e}=t.data;if(e&&!i.aTextHalo){const t=(kD+"aTextHalo").trim();i.aTextHalo=i[t]||new e.constructor(e)}}}function nH(t,e,n){void 0===e.isHalo&&(e.isHalo=1),BL(e,"textOpacity",n,"textOpacity",JN.textOpacity),BL(e,"textFill",n,"textFill",JN.textFill,jL()),BL(e,"textHaloFill",n,"textHaloFill",JN.textHaloFill,jL()),BL(e,"textHaloBlur",n,"textHaloBlur",JN.textHaloBlur),BL(e,"textHaloRadius",n,"textHaloRadius",JN.textHaloRadius),BL(e,"textHaloOpacity",n,"textHaloOpacity",JN.textHaloOpacity),BL(e,"textPerspectiveRatio",n,"textPerspectiveRatio",JN.textPerspectiveRatio,(e=>"line"===t.properties.textPlacement?1:e)),BL(e,"textRotateWithMap",n,"textRotationAlignment",JN.textRotationAlignment,(t=>+("map"===t))),BL(e,"textPitchWithMap",n,"textPitchAlignment",JN.textPitchAlignment,(t=>+("map"===t))),BL(e,"textSize",n,"textSize",JN.textSize),BL(e,"textDx",n,"textDx",JN.textDx),BL(e,"textDy",n,"textDy",JN.textDy),BL(e,"textRotation",n,"textRotation",JN.textRotation,(t=>t*Math.PI/180))}function iH(t){const e=[];return{uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,n){return cy(e,n.projViewMatrix,n.modelMatrix)}},{name:"zoomScale",type:"function",fn:function(t,e){return e.tileResolution/e.resolution}}],extraCommandProps:{viewport:{x:0,y:0,width:()=>t?t.width:1,height:()=>t?t.height:1},stencil:{enable:!0,mask:255,func:{cmp:"<=",ref:(t,e)=>e.stencilRef,mask:255},op:{fail:"keep",zfail:"keep",zpass:"replace"}},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},depth:{enable:!0,range:()=>this.sceneConfig.depthRange||[0,1],func:()=>this.sceneConfig.depthFunc||"always",mask:!1},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}}}}function rH(t,e){const n=_k(e.textFill),i=_k(e.textSize),o=_k(e.textHaloFill),s=_k(e.textHaloRadius),a=_k(e.textHaloOpacity),l=_k(e.textDx),h=_k(e.textDy),c=_k(e.textOpacity),u=vk(e.textPitchAlignment),f=vk(e.textRotationAlignment),g=_k(e.textRotation),A=vk(e.textAllowOverlapFn),m=vk(e.textIgnorePlacement),w={},T=new Int16Array(1),M=new Uint16Array(1);return[{attrName:"aTextFill",symbolName:"textFill",define:"HAS_TEXT_FILL",type:Uint8Array,width:4,evaluate:(e,i)=>{let o=n(t.getZoom(),e);return mk(o)&&(o=this.evaluateInFnTypeConfig(o,i,t,e,!0)),Array.isArray(o)||(o=w[o]=w[o]||KE(o).unitArray()),o=GL(o),o}},{attrName:"aTextSize",symbolName:"textSize",define:"HAS_TEXT_SIZE",type:Uint8Array,width:1,evaluate:(e,n)=>{let o=i(t.getZoom(),e)||JN.textSize;return mk(o)&&(o=this.evaluateInFnTypeConfig(o,n,t,e)),T[0]=o,T[0]}},{attrName:"aTextHaloFill",symbolName:"textHaloFill",define:"HAS_TEXT_HALO_FILL",type:Uint8Array,width:4,evaluate:e=>{let n=o(t.getZoom(),e);return Array.isArray(n)||(n=w[n]=w[n]||KE(n).unitArray()),n=GL(n),n}},{attrName:"aTextHalo",symbolName:"textHaloRadius",define:"HAS_TEXT_HALO_RADIUS",type:Uint8Array,index:0,width:2,evaluate:e=>{const n=s(t.getZoom(),e);return T[0]=n,T[0]}},{attrName:"aTextHalo",symbolName:"textHaloOpacity",define:"HAS_TEXT_HALO_OPACITY",type:Uint8Array,index:1,width:2,evaluate:e=>{const n=a(t.getZoom(),e);return T[0]=255*n,T[0]}},{attrName:"aTextDx",symbolName:"textDx",define:"HAS_TEXT_DX",type:Uint8Array,width:1,evaluate:(e,n)=>{let i=l(t.getZoom(),e);return mk(i)&&(i=this.evaluateInFnTypeConfig(i,n,t,e)),T[0]=i,T[0]}},{attrName:"aTextDy",symbolName:"textDy",define:"HAS_TEXT_DY",type:Uint8Array,width:1,evaluate:(e,n)=>{let i=h(t.getZoom(),e);return mk(i)&&(i=this.evaluateInFnTypeConfig(i,n,t,e)),T[0]=i,T[0]}},{attrName:"aColorOpacity",symbolName:"textOpacity",define:"HAS_OPACITY",type:Uint8Array,width:1,evaluate:(e,n)=>{let i=c(t.getZoom(),e);return mk(i)&&(i=this.evaluateInFnTypeConfig(i,n,t,e)),T[0]=255*i,T[0]}},{attrName:"aPitchAlign",symbolName:"textPitchAlignment",type:Uint8Array,width:1,define:"HAS_PITCH_ALIGN",evaluate:e=>+("map"===u(t.getZoom(),e))},{attrName:"aRotationAlign",symbolName:"textRotationAlignment",type:Uint8Array,width:1,define:"HAS_ROTATION_ALIGN",evaluate:e=>+("map"===f(t.getZoom(),e))},{attrName:"aRotation",symbolName:"textRotation",type:Uint16Array,width:1,define:"HAS_TEXT_ROTATION",evaluate:e=>{const n=FL(g(t.getZoom(),e),0,360)*Math.PI/180;return M[0]=9362*n,M[0]}},{attrName:"aOverlap",symbolName:"textAllowOverlap",type:Uint8Array,width:1,evaluate:n=>{let i=A(t.getZoom(),n)||0,o=(m?m(t.getZoom(),n):e.textIgnorePlacement)||0;return i=1<<3+4*i,o=(m?2:0)+o,i+o}},{attrName:"aOverlap",symbolName:"textIgnorePlacement",type:Uint8Array,width:1,evaluate:n=>{let i=(A?A(t.getZoom(),n):e.textAllowOverlap)||0,o=m(t.getZoom(),n)||0;return i=(A?8:0)+4*i,o=1<<1+o,i+o}}]}const oH=[],sH=[],aH=[],lH=[];function hH(t,e,n,i,o,s,a){t=1===t?1:0;const l=this.getMap(),h=e.geometry.properties,c=this.getSymbol(h.symbolIndex),u="line"===h.textPlacement&&!ZL(c),{aTextSize:f,aTextHalo:g,aShape:A}=h;let m=f?f[n[o]]:c.textSize;null==m&&(m=JN.textSize);const w=g?g[2*n[o]]:e.properties.textHaloRadius,T=XN(aH,e,n[o]),{aProjectedAnchor:M}=e.geometry.properties;let C=lH;const P=3*n[o];M&&M[P]!==TL?(lH[0]=M[P],lH[1]=M[P+1],lH[2]=M[P+2]):C=QD(lH,T,a,l.width,l.height);const I=i,{boxes:O,collision:E}=this._getCollideBoxes(e,o);let D=0;if(u||1===e.material.uniforms.textRotateWithMap||c.textRotation){let i=0;for(let s=o;s<o+6*I;s+=6){const o=O[D]=O[D]||[];D++;const h=qN.call(this,o,T,C,e,m,w,n[s],a,l);if(!t){const e=this.isCollides(h);1===e?t=1:-1===e&&i++}}i===I&&(t=-1)}else{let i=n[o],h=A[2*i+1];for(let c=o;c<s;c+=6){const o=A[2*n[c]+1];if(h!==o||c===s-6){const u=n[c===s-6?c:c-6],f=qN.call(this,oH,T,C,e,m,w,i,a,l),g=qN.call(this,sH,T,C,e,m,w,u,a,l),A=O[D]=O[D]||[];D++,A[0]=Math.min(f[0],g[0]),A[1]=Math.min(f[1],g[1]),A[2]=Math.max(f[2],g[2]),A[3]=Math.max(f[3],g[3]),i=n[c],h=o,!t&&this.isCollides(A)&&(t=1)}}}return E.collides=t,E}function cH(t,e){const n=function(t,e){const{aPickingId:n,features:i}=t.geometry.properties,o=n[e],s=i&&i[o]&&i[o].feature;return s&&s.label}(t,e);return n?function(t,e,n){if(!n)return null;const i=t.localTransform,o=XN(uH,t,e);g_(fH,o[0],o[1],o[2],1);const s=S_(fH,fH,i);let a=0;for(const t of n)a+=t.codePointAt(0);return[Math.floor(s[0]),Math.floor(s[1]),Math.floor(s[2]),a]}(t,e,n):null}const uH=[],fH=[],dH=6,gH=4,pH=new Uint16Array(1),AH=new Int8Array(1);function mH(t,e,n,i,o,s,a,l,h){if(e.isDisposed()||0===e.data.aPosition.length)return null;const c=!!e.properties.glyphAtlas;if(!!!e.properties.iconAtlas&&!c&&!e.properties.isEmpty)return null;
//!geometry.properties.aShape collision
if(!e.properties.aShape){const{aPosition:t,aShape:n}=e.data,i=e.data.aPosition.length/e.desc.positionSize,o=new Uint8Array(i);l&&o.fill(255,0),e.data.aOpacity={usage:"dynamic",data:o},e.properties.aOpacity=new Uint8Array(i),l&&e.properties.aOpacity.fill(255,0),e.properties.aAnchor=t;const s=n.length/4,a=new n.constructor(2*s);for(let t=0;t<s;t++)a[2*t]=n[4*t],a[2*t+1]=n[4*t+1];e.properties.aShape=a}e.properties.visElemts||(e.properties.elements=e.elements,e.properties.visElemts=new e.elements.constructor(e.elements.length)),c&&KN.call(this,e,i,s.text,a,l,h),e.properties.memorySize=e.getMemorySize(),e.generateBuffers(t,{excludeElementsInVAO:!0});const u={flipY:0,tileResolution:e.properties.tileResolution,tileRatio:e.properties.tileRatio};_H.call(this,u,t,e,o),$N.call(this,u,t,e,o),u.isHalo=0;const f=[],g={disableVAO:!0,transparent:!0,castShadow:!1,picking:!0};let A;if(c){const t=LL({},u);t.isHalo=1;const i=new Qb(t);A=new aw(e,i,g),A.properties.isHalo=1,A.setUniform("alphaTest",CN),A.setLocalTransform(n)}const m=new Qb(u),w=new aw(e,m,g),T={HAS_HALO_ATTR:1};if(a&&(T.ENABLE_COLLISION=1),vH.call(this,e,T),A){const t=LL({},T);tH.call(this,T,A),A.setDefines(t)}return c&&tH.call(this,T,w),w.setDefines(T),w.setUniform("alphaTest",CN),w.setLocalTransform(n),w.properties.symbolIndex=e.properties.symbolIndex,f.push(w),f}function yH(t){const{aMarkerDx:e,aMarkerDy:n,aTextDx:i,aTextDy:o}=t.data,s=i||o||e||n;if(s){const a=new s.constructor(4*s.length);for(let t=0;t<a.length;t+=4){const s=t/4;e&&(a[t]=e[s]),n&&(a[t+1]=n[s]),i&&(a[t+2]=i[s]),o&&(a[t+3]=o[s])}t.data.aDxDy=a,t.properties.aDxDy=a.slice(),e&&(t.properties.aMarkerDx=e),n&&(t.properties.aMarkerDy=n),i&&(t.properties.aTextDx=i),o&&(t.properties.aTextDy=o)}}function _H(t,e,n,i){const[o,s]=SF(n);BL(t,"markerOpacity",i,"markerOpacity",1),BL(t,"markerPerspectiveRatio",i,"markerPerspectiveRatio",i.markerTextFit?0:1),BL(t,"markerWidth",i,"markerWidth",o||bN),BL(t,"markerHeight",i,"markerHeight",s||wN),BL(t,"markerDx",i,"markerDx",0),BL(t,"markerDy",i,"markerDy",0),BL(t,"markerRotation",i,"markerRotation",0,(t=>t*Math.PI/180)),BL(t,"markerPitchWithMap",i,"markerPitchAlignment",0,(t=>"map"===t?1:0)),BL(t,"markerRotateWithMap",i,"markerRotationAlignment",0,(t=>"map"===t?1:0));const a=n.properties.iconAtlas;t.iconTex=a?TF(e,a,!1):this._emptyTexture,t.iconTexSize=a?[a.width,a.height]:[0,0]}function vH(t,e){t.data.aMarkerWidth&&(e.HAS_MARKER_WIDTH=1),t.data.aMarkerHeight&&(e.HAS_MARKER_HEIGHT=1),t.data.aColorOpacity&&(e.HAS_OPACITY=1);const n=this.getSymbolDef(t.properties.symbolIndex);WD(n.markerDx)&&(e.HAS_MARKER_DX=1),WD(n.markerDy)&&(e.HAS_MARKER_DY=1),WD(n.textDx)&&(e.HAS_TEXT_DX=1),WD(n.textDy)&&(e.HAS_TEXT_DY=1),WD(n.markerPitchAlignment)&&(e.HAS_MARKER_PITCH_ALIGN=1),WD(n.textPitchAlignment)&&(e.HAS_TEXT_PITCH_ALIGN=1),WD(n.markerRotationAlignment)&&(e.HAS_MARKER_ROTATION_ALIGN=1),WD(n.textRotationAlignment)&&(e.HAS_TEXT_ROTATION_ALIGN=1),WD(n.markerRotation)&&(e.HAS_MARKER_ROTATION=1),WD(n.textRotation)&&(e.HAS_TEXT_ROTATION=1),t.data.aPadOffset&&(e.HAS_PAD_OFFSET=1),t.data.aAltitude&&(e.HAS_ALTITUDE=1)}function xH(t,e){const n=_k(e.markerWidth),i=_k(e.markerHeight),o=_k(e.markerDx),s=_k(e.markerDy),a=_k(e.markerOpacity),l=_k(e.markerTextFit),h=vk(e.markerPitchAlignment),c=vk(e.textPitchAlignment),u=vk(e.markerRotationAlignment),f=vk(e.textRotationAlignment),g=_k(e.markerRotation),A=_k(e.textRotation),m=vk(e.markerAllowOverlapFn),w=vk(e.markerIgnorePlacement),T=_k(e.textOpacity),M=_k(e.textDx),C=_k(e.textDy),P=new Int16Array(1),I=new Uint16Array(1);return[{attrName:"aMarkerWidth",symbolName:"markerWidth",type:Uint16Array,width:1,define:"HAS_MARKER_WIDTH",evaluate:(i,o,s,a)=>{const h=s[a],c=e.markerTextFit,u=l?l(t.getZoom(),i):c;if("both"===u||"width"===u)return h;let f=n(t.getZoom(),i);return mk(f)&&(f=this.evaluateInFnTypeConfig(f,o,t,i)),P[0]=f,P[0]}},{attrName:"aMarkerHeight",symbolName:"markerHeight",type:Uint16Array,width:1,define:"HAS_MARKER_HEIGHT",evaluate:(n,o,s,a)=>{const h=s[a],c=e.markerTextFit,u=l?l(t.getZoom(),n):c;if("both"===u||"height"===u)return h;let f=i(t.getZoom(),n);return mk(f)&&(f=this.evaluateInFnTypeConfig(f,o,t,n)),P[0]=f,P[0]}},{attrName:"aDxDy",symbolName:"markerDx",type:Int8Array,width:4,index:0,define:"HAS_MARKER_DX",evaluate:(e,n,i,s)=>{let a=o(t.getZoom(),e);mk(a)&&(a=this.evaluateInFnTypeConfig(a,n,t,e));const{aMarkerDx:l}=n.properties;return l&&(l[s/4]=a),P[0]=a,P[0]}},{attrName:"aDxDy",symbolName:"markerDy",type:Int8Array,width:4,index:1,define:"HAS_MARKER_DY",evaluate:(e,n,i,o)=>{let a=s(t.getZoom(),e);mk(a)&&(a=this.evaluateInFnTypeConfig(a,n,t,e));const{aMarkerDy:l}=n.properties;return l&&(l[Math.floor(o/4)]=a),P[0]=a,P[0]}},{attrName:"aDxDy",symbolName:"textDx",type:Int8Array,width:4,index:2,define:"HAS_TEXT_DX",evaluate:(e,n,i,o)=>{let s=M(t.getZoom(),e);mk(s)&&(s=this.evaluateInFnTypeConfig(s,n,t,e));const{aTextDx:a}=n.properties;return a&&(a[Math.floor(o/4)]=s),P[0]=s,P[0]}},{attrName:"aDxDy",symbolName:"textDy",type:Int8Array,width:4,index:3,define:"HAS_TEXT_DY",evaluate:(e,n,i,o)=>{let s=C(t.getZoom(),e);mk(s)&&(s=this.evaluateInFnTypeConfig(s,n,t,e));const{aTextDy:a}=n.properties;return a&&(a[Math.floor(o/4)]=s),P[0]=s,P[0]}},{attrName:"aColorOpacity",symbolName:"markerOpacity",type:Uint8Array,width:2,index:0,define:"HAS_OPACITY",evaluate:(e,n)=>{let i=1;return a&&(i=a(t.getZoom(),e),mk(i)&&(i=this.evaluateInFnTypeConfig(i,n,t,e))),P[0]=255*i,P[0]}},{attrName:"aColorOpacity",symbolName:"textOpacity",type:Uint8Array,width:2,index:1,define:"HAS_OPACITY",evaluate:(e,n)=>{let i=1;return T&&(i=T(t.getZoom(),e),mk(i)&&(i=this.evaluateInFnTypeConfig(i,n,t,e))),P[0]=255*i,P[0]}},{attrName:"aPitchAlign",symbolName:"markerPitchAlignment",type:Uint8Array,width:2,index:0,define:"HAS_PITCH_ALIGN",evaluate:e=>+("map"===h(t.getZoom(),e))},{attrName:"aPitchAlign",symbolName:"textPitchAlignment",type:Uint8Array,width:2,index:1,define:"HAS_PITCH_ALIGN",evaluate:e=>+("map"===c(t.getZoom(),e))},{attrName:"aRotationAlign",symbolName:"markerRotationAlignment",type:Uint8Array,width:2,index:0,define:"HAS_MARKER_ROTATION_ALIGN",evaluate:e=>+("map"===u(t.getZoom(),e))},{attrName:"aRotationAlign",symbolName:"textRotationAlignment",type:Uint8Array,width:2,index:1,define:"HAS_TEXT_ROTATION_ALIGN",evaluate:e=>+("map"===f(t.getZoom(),e))},{attrName:"aRotation",symbolName:"markerRotation",type:Uint16Array,width:2,index:0,define:"HAS_MARKER_ROTATION",evaluate:e=>{const n=FL(g(t.getZoom(),e),0,360)*Math.PI/180;return I[0]=9362*n,I[0]}},{attrName:"aRotation",symbolName:"textRotation",type:Uint16Array,width:2,index:1,define:"HAS_TEXT_ROTATION",evaluate:e=>{const n=FL(A(t.getZoom(),e),0,360)*Math.PI/180;return I[0]=9362*n,I[0]}},{attrName:"aOverlap",symbolName:"markerAllowOverlap",type:Uint8Array,width:1,evaluate:n=>{let i=m(t.getZoom(),n)||0,o=(w?w(t.getZoom(),n):e.markerIgnorePlacement)||0;return i=1<<3+4*i,o=(w?2:0)+o,i+o}},{attrName:"aOverlap",symbolName:"markerIgnorePlacement",type:Uint8Array,width:1,evaluate:n=>{let i=(m?m(t.getZoom(),n):e.markerAllowOverlap)||0,o=w(t.getZoom(),n)||0;return i=(m?8:0)+4*i,o=2+o,i+o}}]}function bH(t,e,n){if(!e||!n||"none"===n)return;const{iconAtlas:i,glyphAtlas:o}=e.properties;if(!i||!o)return;!function(t){if(t.properties.iconElements)return;const e=[],n=[],i=t.elements,o=t.properties.aType;for(let t=0;t<i.length;t++){const s=i[t];0===o[s]?e.push(s):n.push(s)}t.properties.iconElements=new i.constructor(e),t.properties.textElements=new i.constructor(n)}(e);const s=function(t,e){let n=t.properties.textFitFn;mk(e)&&(n=t.properties.textFitFn=vk(e));const i="none"!==e,o=[],s=t.properties.iconElements,a=t.data.aPickingId,l=t.properties.textElements,h=t.data.aPickingId,c=t.properties.aCount,u=t.properties.features;let f,g=l[0];f={pickingId:h[g],start:0,end:c[g]*dH};let A=!1,m=!1,w=0;const T=new Set;for(let t=0;t<s.length;t+=dH){const g=a[s[t]];if(!A&&f)for(;f.pickingId<g&&f.end<l.length;){const t=f.end,e=l[t];f.start=t,f.end=t+c[e]*dH,f.pickingId=h[e]}if(!A&&f&&f.pickingId<g&&(A=!0,!i)){if(!m)return[];for(let e=t;e<s.length;e+=dH)o[w++]=[-1,-1];return o}const M=u[g]&&u[g].feature,C=n?n(null,M&&M.properties||{}):e;if(f&&g===f.pickingId){o[w++]=[f.start,f.end];const t=f.end,e=l[t];f.start=t,f.end=t+c[e]*dH,f.pickingId=h[e],m=!0}else if(C&&"none"!==C)for(let e=t;e<t+dH;e++)T.add(e);else o[w++]=[-1,-1]}if(T.size)if(T.size===s.length)t.setElements([]);else{const e=[];for(let t=0;t<s.length;t++)T.has(t)||e.push(s[t]);t.setElements(new s.constructor(e))}return m?o:[]}(e,n);if(e.getElements().length&&s.length&&(e.properties.labelIndex=s,s.length&&n&&"none"!==n)){const n=function(t){const e=[],n=t.properties.labelIndex,{aShape:i}=t.data;let o=!1;for(let s=0;s<n.length;s++){const[a,l]=n[s];if(-1===a)e.push(0,0,0,0);else{o=!0;let n=1/0,s=1/0,h=-1/0,c=-1/0;const u=t.properties.textElements;for(let t=a;t<l;t++){const e=u[t],o=i[4*e],a=i[4*e+1];o<n&&(n=o),o>h&&(h=o),a<s&&(s=a),a>c&&(c=a)}e.push(n,s,h,c)}}return o?e:[]}(e);n.length&&(e.properties.labelShape=n,wH.call(this,t,e))}}function wH(t,e){const n=this.getSymbolDef(e.properties.symbolIndex),i=n.markerTextFit,o=e.properties;let s="both"===i||"width"===i,a="both"===i||"height"===i;if(mk(n.markerTextFit)){let t=e.properties.textFitFn;t||(t=e.properties.textFitFn=_k(n.markerTextFit));const{features:i}=e.properties,l=e.properties.iconElements,{aPickingId:h}=e.data,c=[],u=[];let f=!0;for(let e=0;e<l.length;e+=dH){const n=i[h[l[e]]],o=(n&&n.feature||{}).properties||{};let s=t(null,o);mk(s)&&(s=(o.textFitFn=o.textFitFn||_k(s))(null,o)),"both"===s?(c.push(e/dH),u.push(e/dH)):"width"===s?(f=!1,c.push(e/dH)):"height"===s&&(f=!1,u.push(e/dH))}f?(o.fitIcons=c,s=!0,a=!0):(c.length&&(o.fitWidthIcons=c,s=!0),u.length&&(o.fitHeightIcons=u,a=!0))}o.aPickingId||(o.aPickingId=new e.data.aPickingId.constructor(e.data.aPickingId));const{aMarkerWidth:l,aMarkerHeight:h,aPickingId:c}=o,u=c.length;if(s)if(l){const t=e.data.aMarkerWidth;e.data.aMarkerWidth=new Uint16Array(t),o.aMarkerWidth=new Uint16Array(t);const n=(kD+"aMarkerWidth").trim();o[n]&&(o[n]=o.aMarkerWidth)}else{const t=this.getSymbol(e.properties.symbolIndex).markerWidth||0;o.aMarkerWidth=new Uint16Array(u),o.aMarkerWidth.fill(t),t&&(o.aMarkerWidth.dirty=!0),e.data.aMarkerWidth=new Uint16Array(u)}if(a)if(h){const t=e.data.aMarkerHeight;e.data.aMarkerHeight=new Uint16Array(t),o.aMarkerHeight=new Uint16Array(t);const n=(kD+"aMarkerHeight").trim();o[n]&&(o[n]=o.aMarkerHeight)}else{const t=this.getSymbol(e.properties.symbolIndex).markerHeight||0;o.aMarkerHeight=new Uint16Array(u),o.aMarkerHeight.fill(t),t&&(o.aMarkerHeight.dirty=!0),e.data.aMarkerHeight=new Uint16Array(u)}const f=this.getSymbolDef(e.properties.symbolIndex),g=_k(f.textSize);MH.call(this,t,e),(!mk(f.textSize)||g.isZoomConstant&&g.isFeatureConstant)&&(o.isFitConstant=!0)}const TH=[0,0,0,0];function MH(t,e){const n=e.properties;if(!n.glyphAtlas||!n.textElements||!n.textElements.length)return;const i=e.properties;if(i.isFitConstant||!i.labelShape||!i.labelShape.length)return;const o=this.getSymbolDef(e.properties.symbolIndex),s=o.textSize;let a;mk(s)&&(a=n._textSizeFn?n._textSizeFn:n._textSizeFn=_k(s));const l=o.markerTextFitPadding||TH;let h;mk(l)&&(h=i._paddingFn?i._paddingFn:i._paddingFn=vk(l));const c=t.getZoom(),{fitIcons:u,fitWidthIcons:f,fitHeightIcons:g}=i,{aMarkerWidth:A,aMarkerHeight:m,labelShape:w}=i,T=e.properties.iconElements,{features:M,aPickingId:C}=i,P=(t,e,n,o)=>{const u=w[4*e],f=w[4*e+1],g=w[4*e+2],T=w[4*e+3];if(!(u||f||g||T))return;const P=C[t],I=M[P]&&M[P].feature,O=I&&I.properties||{};let E=a?a(c,O):s;mk(E)&&(E=(O.textSizeFn=O.textSizeFn||_k(E))(c,O)),E/=MN;let D,N=h&&h(c,O)||l;if(mk(N)&&(N=(O.fitPaddingFn=O.fitPaddingFn||vk(N))(c,O)),N=N||TH,N[0]===N[2]&&N[1]===N[3]||(D=i.aPadOffset,D||(D=i.aPadOffset=new Int8Array(2*A.length))),A&&n){const e=Math.abs((g-u)/10*E)+(N[1]+N[3]||0);if(pH[0]=e,A[t]!==pH[0]&&(VL(A,pH[0],t,t+gH),A.dirty=!0),D){const e=(N[1]+N[3])/2-N[3];if(AH[0]=e,D[2*t]!==AH[0]){for(let n=t;n<t+gH;n++)D[2*n]=e;D.dirty=!0}}}if(m&&o){const e=Math.abs((T-f)/10*E)+(N[0]+N[2]||0);if(pH[0]=e,m[t]!==pH[0]&&(VL(m,pH[0],t,t+gH),m.dirty=!0),D){const e=N[0]-(N[0]+N[2])/2;if(AH[0]=e,D[2*t+1]!==AH[0]){for(let n=t;n<t+gH;n++)D[2*n+1]=e;D.dirty=!0}}}};if(u||f||g){if(u)for(let t=0;t<u.length;t++){const e=u[t];P(T[e*dH],e,!0,!0)}else if(f||g){if(f)for(let t=0;t<f.length;t++){const e=f[t];P(T[e*dH],e,!0,!1)}if(g)for(let t=0;t<g.length;t++){const e=g[t];P(T[e*dH],e,!1,!0)}}}else for(let t=0;t<T.length;t+=dH){P(T[t],t/dH,!0,!0)}const{aPadOffset:I}=i;I&&(e.data.aPadOffset=I)}const{FilterUtil:CH}=ZR(),SH=[],PH={collides:-1},IH=[TN,TN],OH=ay([]),EH=[];let kH=class Pr extends aN{static getBloomSymbol(){return["markerBloom","textBloom"]}constructor(t,e,n,i,o,s){super(t,e,n,i,o,s),this.propAllowOverlap="markerAllowOverlap",this.propIgnorePlacement="markerIgnorePlacement",this._fnTypeConfigs={},this.isLabelCollides=hH.bind(this),this._meshesToCheck=[],this._emptyTexture=t.texture(2)}needToRefreshTerrainTileOnZooming(){for(let t=0;t<this.symbolDef.length;t++){const e=this.symbolDef[t].markerPitchAlignment;if("map"===e||mk(e)||CH.isExpression(e))return!0}return!1}isTerrainVector(){return this.layer.options.awareOfTerrain&&!this.needToRefreshTerrainTileOnZooming()}isTerrainSkin(){return super.isTerrainSkin()&&this.needToRefreshTerrainTileOnZooming()}setShaderDefines(t){this._shaderDefines=t}createFnTypeConfig(t,e){const n=xH.call(this,t,e),i=rH.call(this,t,e);for(let t=i.length-1;t>=0;t--){const e=i[t].attrName;"aTextDx"!==e&&"aTextDy"!==e&&"aPitchAlign"!==e&&"aRotation"!==e&&"aRotationAlign"!==e&&"aColorOpacity"!==e&&"aOverlap"!==e||i.splice(t,1)}const o=n.concat(i);return o.text=i,o.icon=n,o}startFrame(...t){return this._meshesToCheck.length=0,super.startFrame(...t)}createGeometry(t,e){return t&&t.empty&&(t.data={aPosition:new Uint8Array(t.data.aPosition),aPickingId:t.data.aPickingId}),super.createGeometry(t,e)}postCreateGeometry(t){const{geometry:e,symbolIndex:n}=t,i=this.getSymbolDef(n),o=this.getFnTypeConfig(n),{iconAtlas:s,glyphAtlas:a}=e.properties;if(s||a){if(this._prepareRequiredProps(e),s&&(this.drawDebugAtlas(s),function(t,e,n,i){LD(t,e,n,i),function(t){const{aMarkerWidth:e,aMarkerHeight:n,aMarkerDx:i,aMarkerDy:o,aPitchAlign:s,aRotationAlign:a,aRotation:l,aOverlap:h}=t.data;if(e){const n=(kD+"aMarkerWidth").trim();t.properties.aMarkerWidth=t.properties[n]||new e.constructor(e)}if(n){const e=(kD+"aMarkerHeight").trim();t.properties.aMarkerHeight=t.properties[e]||new n.constructor(n)}if(i){const e=(kD+"aMarkerDx").trim();t.properties.aMarkerDx=t.properties[e]||new i.constructor(i)}if(o){const e=(kD+"aMarkerDy").trim();t.properties.aMarkerDy=t.properties[e]||new o.constructor(o)}if(s){const e=(kD+"aPitchAlign").trim();t.properties.aPitchAlign=t.properties[e]||new s.constructor(s)}if(a){const e=(kD+"aRotationAlign").trim();t.properties.aRotationAlign=t.properties[e]||new a.constructor(a)}if(l){const e=(kD+"aRotation").trim();t.properties.aRotation=t.properties[e]||new l.constructor(l)}if(h){const e=(kD+"aOverlap").trim();t.properties.aOverlap=t.properties[e]||new h.constructor(h)}}(t)}(e,i,o.icon,this.layer)),a){const t=i.markerTextFit;if(t){const n=this.getMap();bH.call(this,n,e,t)}}}else e.properties.isEmpty=!0}_prepareRequiredProps(t){const{aCount:e,aShape:n}=t.data;t.properties.aCount=e,delete t.data.aCount;const i=n.length/4,o=new Uint8Array(i),s=new Uint8Array(i);for(let t=0;t<i;t++)o[t]=n[4*t+2]%2,s[t]=n[4*t+3]%2;t.properties.aType=o,t.properties.aHalo=s,yH.call(this,t)}prepareCollideIndex(t){const{collideIds:e,elements:n,aCount:i,aType:o}=t.properties;if(!e)return;const s={};if(!n)return void(t.properties.collideBoxIndex=s);let a=0,l=n[0],h=0,c=e[l],u=o[0],f=1;i&&(f=i[n[h]]);for(let t=0;t<=n.length;t+=dH)if(l=n[t],e[l]!==c||u!==o[l]||t===n.length){s[c]||(s[c]=[]);let g=h;1===u&&(g=h+(t-h)/2),s[c].push([g,t,(t-g)/(f*dH),a++,h]),c=e[l],u=o[l],h=t,i&&(f=i[n[h]])}t.properties.collideBoxIndex=s}createMesh(t,e){const n=this.isEnableCollision(),i=this.layer,{geometry:o,symbolIndex:s}=t;o.properties.symbolIndex=s;const a=this.getSymbolDef(s),l=this.getSymbol(s),h=this.getFnTypeConfig(s),c=[],u=this.isEnableUniquePlacement(),f=mH.call(this,this.regl,o,e,a,l,h,i.options.collision,!n,u);if(f.length){const t=this.getAltitudeOffsetMatrix();f[0].positionMatrix=t,f[1]&&(f[1].positionMatrix=t),c.push(...f)}return"line"===o.properties.markerPlacement&&(this._rebuildCollideIds(o),c.forEach((t=>t.properties.isLinePlacement=!0))),this.prepareCollideIndex(o),c}_rebuildCollideIds(t){const e=this.layer instanceof kp,{collideIds:n,glyphAtlas:i,iconAtlas:o}=t.properties,s=new Uint16Array(n.length),a=!!i;if(o){const{collideIds:n,aType:o}=t.properties;if(i){let t=0,e=o[0],i=0;for(let a=1;a<n.length;a++)0===o[a]&&1===e&&(s.fill(t++,i,a),i=a),e=o[a];i<n.length&&s.fill(t++,i,n.length)}else{let t=0;for(let e=0;e<n.length;e+=gH)s.fill(t++,e,e+gH)}t.properties.collideIds=s,t.properties.uniqueCollideIds=XL(s,!e)}else if(a){const{collideIds:n,aCount:i}=t.properties;if(!i)return;let o=0,s=i[0];for(let t=0;t<n.length;){const e=t+s*gH;n.fill(o++,t,e),t+=s*gH,e<n.length&&(s=i[e])}t.properties.uniqueCollideIds=XL(n,!e)}}addMesh(t){if(this.isEnableCollision()&&t.length>0){const e=new $F(t);e.properties.uniqueCollideIds=t[0].geometry.properties.uniqueCollideIds,e.properties.meshKey=t[0].properties.meshKey,e.properties.level=t[0].properties.level,this._meshesToCheck.push(e)}for(let e=0;e<t.length;e++){if(!this.isMeshIterable(t[e]))continue;const n=t[e].geometry,{symbolIndex:i}=n.properties;ZL(this.getSymbolDef(i))&&MH.call(this,this.getMap(),n)}const e=this.getMap().getZoom();for(let n=0;n<t.length;n++){if(!this.isMeshIterable(t[n]))continue;const i=t[n].geometry,{symbolIndex:o}=i.properties,s=this.getSymbolDef(o),a=this.getFnTypeConfig(o);HD(this.regl,this.layer,s,a,t[n],e);const{aMarkerWidth:l,aMarkerHeight:h,aPadOffset:c}=i.properties;l&&l.dirty&&(i.updateData("aMarkerWidth",l),l.dirty=!1),h&&h.dirty&&(i.updateData("aMarkerHeight",h),h.dirty=!1),c&&c.dirty&&(i.updateData("aPadOffset",c),c.dirty=!1)}super.addMesh(...arguments)}updateCollision(t){if(!this.isEnableCollision())return;super.updateCollision(t);const e=this.scene.getMeshes();e&&e.length?(this._updateIconCollision(t.timestamp),this._meshesToCheck=[],this._endCollision()):this._endCollision()}isMeshIterable(t){return t&&t.geometry&&!t.geometry.properties.isEmpty&&t.material&&this.isMeshVisible(t)&&!(this.shouldIgnoreBackground()&&!this.layer.getRenderer().isForeground(t))}_updateIconCollision(){if(!this.isEnableCollision())return;let t=this._meshesToCheck;t&&t.length&&this._updateIconAndText(t)}_updateBox(t,e,n,i){return this.updateBoxCollisionFading(!0,t,e,n,i)}isEnableUniquePlacement(){return this.isEnableCollision()&&!0===this.sceneConfig.uniquePlacement}_updateIconAndText(t){const e=this.layer.getRenderer();t=t.sort(RH);for(let n=0;n<t.length;n++){const i=t[n];if(!i||!i.meshes.length)continue;let o=!1;if(1===i.meshes.length)o=this.isMeshIterable(i.meshes[0]);else for(let t=0;t<i.meshes.length;t++)if(this.isMeshIterable(i.meshes[t])){o=!0;break}if(!o)continue;const s=e.isForeground(i.meshes[0]);if(this.shouldIgnoreBackground()&&!s)continue;const a=i.properties.meshKey;this.startMeshCollision(i),this._startCheckMesh(i),this.forEachBox(i,this._updateBox),this._endCheckMesh(i),this.endMeshCollision(a);for(let t=0;t<i.meshes.length;t++)this._updateOpacity(i.meshes[t])}}_updateOpacity(t){const e=t&&t.geometry&&t.geometry.properties.aOpacity;e&&e.dirty&&(t.geometry.updateData("aOpacity",e),e.dirty=!1)}forEachBox(t,e){const n=t.properties.uniqueCollideIds;if(!n)return;const i={boxIndex:0},o=n.length;for(let s=0;s<o;s++)this._iterateMeshBox(t,n[s],e,i)}_iterateMeshBox(t,e,n,i){const o=this.getMap(),{collideBoxIndex:s}=t.meshes[0].geometry.properties,a=s&&s[e];if(!a||!a.length)return!1;const l=cy(SH,o.projViewMatrix,t.meshes[0].localTransform);let h,c=!1;const u=t.meshes;let f=0;for(let t=0;t<u.length;t++){if(!this.isMeshIterable(u[t]))continue;const{collideBoxIndex:n}=u[t].geometry.properties,i=n[e];i&&(f+=i.length)}if(!f)return!1;h=this._getMeshBoxes(f);let g=0;for(let t=0;t<u.length;t++){const n=u[t];if(!this.isMeshIterable(n))continue;c=!0;const i=n.geometry.properties,{elements:o,aCount:s,collideBoxIndex:a}=i,l=a[e];if(l)for(let t=0;t<l.length;t++){const[e,a,c]=l[t];let u=1;s&&(u=s[o[e]]);const f=e+0*u*dH;h[g].mesh=n,h[g].start=f,h[g].end=a,h[g].boxStart=l[t][4],h[g].boxCount=i.glyphAtlas?u:c,h[g].allElements=o,g++}}return!!c&&(n.call(this,t,h,l,i.boxIndex++)&&this._markerVisible(t,e),!0)}_startCheckMesh(t){const e=t.meshes;for(let t=0;t<e.length;t++){const n=e[t],i=n&&n.geometry;i&&(i.properties.visElemts.count=0)}}_markerVisible(t,e){const n=t.meshes;for(let t=0;t<n.length;t++){const i=n[t],o=i&&i.geometry;if(!o||o.properties.isEmpty)continue;const{collideBoxIndex:s,elements:a,visElemts:l}=o.properties,h=s[e];if(h&&h.length)for(let t=0;t<h.length;t++){const e=h[t][4],n=h[t][1];let i=l.count;for(let t=e;t<n;t++)l[i++]=a[t];l.count=i}}}_endCheckMesh(t){const e=t.meshes;for(let t=0;t<e.length;t++){const n=e[t],i=n&&n.geometry;if(!i)continue;const{visElemts:o}=i.properties;i.setElements(o,o.count)}}isBoxCollides(t,e,n,i,o,s){if(this._isTextGeo(t,e,i))return hH.call(this,0,t,e,n,i,o,s);if(t.geometry.properties.isEmpty)return PH;const{aTerrainAltitude:a}=t.geometry.properties;if(a&&a[2*e[i]]===ML)return PH;const l=this.getMap(),{boxes:h,collision:c}=this._getCollideBoxes(t,i);let u=0,f=0,g=0;for(let n=i;n<o;n+=dH){const i=h[g]=h[g]||[];g++;const o=NN.call(this,i,t,e[n],s,l);if(!u){const t=this.isCollides(o);1===t?u=1:-1===t&&f++}}return f===n&&(u=-1),c.collides=u,c}deleteMesh(t,e){t&&(t instanceof $F&&(t=t.meshes),e&&(Array.isArray(t)?t.forEach((t=>{t&&t.material&&delete t.material.uniforms.iconTex})):t.material&&delete t.material.uniforms.iconTex),super.deleteMesh(t,e))}isBloom(t){const e=t&&t.material&&!NL(t.material.get("markerOpacity")),n=this.getSymbol(t.properties.symbolIndex);return!!(e?n.markerBloom:n.textBloom)}isUniqueStencilRefPerTile(){return!1}init(){const t=this.canvas;this.renderer=new cw(this.regl);const e={viewport:{x:(t,e)=>e.viewport?e.viewport.x:0,y:(t,e)=>e.viewport?e.viewport.y:0,width:(e,n)=>n.viewport?n.viewport.width:t?t.width:1,height:(e,n)=>n.viewport?n.viewport.height:t?t.height:1},stencil:{enable:!0,func:{cmp:"<=",ref:(t,e)=>e.stencilRef},op:{fail:"keep",zfail:"keep",zpass:"replace"}},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},depth:{enable:!0,range:()=>this.sceneConfig.depthRange||[0,1],func:()=>this.sceneConfig.depthFunc||"always",mask:!!NL(this.sceneConfig.depthMask)||this.sceneConfig.depthMask},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}};if(this.shader=new zw({vert:fN,frag:"#define SHADER_NAME MARKER\n#define HAS_HIGHLIGHT_COLOR_POINT 1\nprecision mediump float;\n#include <gl2_frag>\nuniform float alphaTest;\nuniform sampler2D iconTex;\nuniform lowp float markerOpacity;\nuniform lowp float blendSrcIsOne;\nuniform float layerOpacity;\n#include <highlight_frag>\nvarying vec2 vTexCoord;\nvarying float vOpacity;\nvarying float vIsText;\nvarying float vHalo;\n#include <text_render_frag>\nvoid main() {\n  vec4 c;\n  if(vIsText > .5) {\n    c = renderText(vTexCoord);\n  } else {\n    c = texture2D(iconTex, vTexCoord) * markerOpacity;\n  }\n  c = c * vOpacity * layerOpacity;\n  if(c.a < .05) {\n    discard;\n  }\n  glFragColor = c;\n  if(glFragColor.a < alphaTest) {\n    discard;\n  }\n  glFragColor = highlight_blendColor(glFragColor);\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){return cy([],e.projViewMatrix,e.modelMatrix)}},{name:"zoomScale",type:"function",fn:function(t,e){return e.tileResolution/e.resolution}}],extraCommandProps:e,defines:this._shaderDefines||{}}),this.shader.version=300,this.pickingFBO){const t=new zM(this.renderer,{vert:"#define PICKING_MODE 1\n"+fN,uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){return cy([],e.projViewMatrix,e.modelMatrix)}},{name:"zoomScale",type:"function",fn:function(t,e){return e.tileResolution/e.resolution}}],extraCommandProps:e},this.pickingFBO,this.getMap());this.picking=[t]}}getUniformValues(t,e){const n=e&&e.isRenderingTerrainSkin,i=this.layer.getTileSize().width,o=n?OH:t.projViewMatrix,s=t.cameraToCenterDistance,a=Ev(EH,t.width,t.height);n&&Ev(a,i,i);const l=this.getBlendFunc(),h=hs.isFunction(l.src)?l.src():l.src;return{layerScale:this.layer.options.styleScale||1,mapPitch:t.getPitch()*Math.PI/180,mapRotation:t.getBearing()*Math.PI/180,projViewMatrix:o,cameraToCenterDistance:s,canvasSize:a,iconSize:IH,resolution:t.getResolution(),glyphSize:MN,gammaScale:1,blendSrcIsOne:+!("one"!==h&&1!==h),viewport:n&&e&&e.viewport,isRenderingTerrain:+!!n}}getUniqueEntryKey(t,e){if(!this._isTextGeo(t.geometry))return null;const{elements:n}=t.geometry.properties;return cH(t,n[e])}_isTextGeo(t,e,n){const{aType:i}=t.geometry.properties;return 1===i[e[n]]}delete(){return this._emptyTexture&&(rb.isTextureDestroyed(this._emptyTexture)||this._emptyTexture.destroy(),this._emptyTexture=null),super.delete()}};function RH(t,e){return t.properties.level-e.properties.level||t.properties.meshKey-e.properties.meshKey}const LH=[],DH=[],FH=[];function NH(t,e,n,i,o,s,a,l,h,c,u,f,g){const{aGlyphOffset:A,aSegment:m,aTextDx:w,aTextDy:T,symbolIndex:M}=e.geometry.properties,C=this.getSymbol(M),P=Ev(FH,(w?w[o]:C.textDx)||0,(T?T[o]:C.textDy)||0),I=Ev(LH,A[2*o],A[2*o+1]),O=Fy(DH,m[3*o],m[3*o+1],m[3*o+2]),E=function(t,e,n,i,o,s,a,l,h,c,u,f,g,A,m,w,T,M){m||(m=i);const C=e.geometry.properties.line,P=s[0]*f,I=g?P-a:P+a;let O=I>0?1:-1,E=0;g&&(O*=-1,E=Math.PI),O<0&&(E+=Math.PI);const D=c+u,N=Math.abs(I);let H=O>0?h:h+1,U=XD.convert(i),W=XD.convert(i),q=XD.convert(o),X=XD.convert(o),J=0,Q=0;for(;J+Q<=N;){if(H+=O,H<c||H>=D)return null;W.x=U.x,W.y=U.y,X.x=q.x,X.y=q.y,U.x=n[3*H],U.y=n[3*H+1],q.x=C[3*H],q.y=C[3*H+1],J+=Q,Q=W.dist(U)/A}const Y=(N-J)/Q,K=w&&w.getRenderer(),$=K&&K.getTerrainHelper(),tt=e.properties.tile.terrainTileInfos;if(!M&&$){const{extent:n}=e.properties.tile,i=w.getTileSize().width/n,o=w.getMap();let s=q.sub(X).mult(Y)._add(X);U=iF(YD,o,e,q,i,w,T,tt),W=iF(KD,o,e,X,i,w,T,tt),s=iF($D,o,e,s,i,w,T,tt);const a=E+Math.atan2(U[1]-W[1],U[0]-W[0]);return t[0]=(s[0]-m[0])/A,t[1]=(s[1]-m[1])/A,t[2]=a,t}const et=U.sub(W),nt=et.mult(Y)._add(W);nt._add(et._unit()._perp()._mult(l*O));const it=E+Math.atan2(U.y-W.y,U.x-W.x);return t[0]=(nt.x-i[0])/A,t[1]=(nt.y-i[1])/A,t[2]=it,t}(t,e,i,s,a,I,P[0],P[1],O[0],O[1],O[2],n/24,h,l,c,u,f,g);return E}const HH=[],BH=[];function zH(t,e,n,i,o,s,a,l,h,c,u,f,g){const{aVertical:A}=n.geometry.properties,m=A[s];let w,T,M=NH.call(this,HH,n,i,o,s,l,h,c,!1);if(!M)return null;if(Dy(t,M),M=NH.call(this,BH,n,i,o,a,l,h,c,!1),g=Math.PI*g/180,!M||Math.abs(M[2])>g)return null;if(Dy(e,M),f&&(Gv(HH,HH,f),Gv(BH,BH,f)),m){const t=Math.abs(BH[1]-HH[1]),e=Math.abs(BH[0]-HH[0])*u;T=HH[0]>BH[0]?1:0,t>e?(w=1,T=HH[1]<BH[1]?0:1):w=0}else w=0,T=HH[0]>BH[0]?1:0;return 2*T+w}var GH="#define SHADER_NAME TEXT_VERT\n#define RAD 0.0174532925\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\nattribute vec4 aShape;\n#ifdef ENABLE_COLLISION\nattribute float aOpacity;\n#endif\n#ifdef HAS_OPACITY\nattribute float aColorOpacity;\n#endif\n#ifdef HAS_TEXT_SIZE\nattribute float aTextSize;\n#else\nuniform float textSize;\n#endif\n#ifdef HAS_TEXT_DX\nattribute float aTextDx;\n#else\nuniform float textDx;\n#endif\n#ifdef HAS_TEXT_DY\nattribute float aTextDy;\n#else\nuniform float textDy;\n#endif\n#if defined(HAS_PITCH_ALIGN)\nattribute float aPitchAlign;\n#else\nuniform float textPitchWithMap;\n#endif\n#if defined(HAS_TEXT_ROTATION_ALIGN)\nattribute float aRotationAlign;\n#else\nuniform float textRotateWithMap;\n#endif\nuniform float flipY;\n#if defined(HAS_TEXT_ROTATION)\nattribute float aRotation;\n#else\nuniform float textRotation;\n#endif\nuniform float cameraToCenterDistance;\nuniform mat4 positionMatrix;\nuniform mat4 projViewModelMatrix;\nuniform float textPerspectiveRatio;\nuniform vec2 glyphTexSize;\nuniform vec2 canvasSize;\nuniform float glyphSize;\nuniform float mapPitch;\nuniform float mapRotation;\nuniform float zoomScale;\nuniform float tileRatio;\nuniform float layerScale;\nuniform float isRenderingTerrain;\n#ifndef PICKING_MODE\nvarying vec2 vTexCoord;\nvarying float vGammaScale;\nvarying float vTextSize;\nvarying float vOpacity;\n#ifdef HAS_TEXT_FILL\nattribute vec4 aTextFill;\nvarying vec4 vTextFill;\n#endif\n#ifdef HAS_TEXT_HALO_FILL\nattribute vec4 aTextHaloFill;\nvarying vec4 vTextHaloFill;\n#endif\n#if defined(HAS_TEXT_HALO_RADIUS) || defined(HAS_TEXT_HALO_OPACITY)\nattribute vec2 aTextHalo;\nvarying vec2 vTextHalo;\n#endif\n#include <highlight_vert>\n#else\n#include <fbo_picking_vert>\n#endif\n#include <vt_position_vert>\nvoid main() {\n  vec3 c = unpackVTPosition();\n#ifdef HAS_TEXT_SIZE\nfloat d = aTextSize * layerScale;\n#else\nfloat d = textSize * layerScale;\n#endif\n#ifdef HAS_TEXT_DX\nfloat e = aTextDx;\n#else\nfloat e = textDx;\n#endif\n#ifdef HAS_TEXT_DY\nfloat f = aTextDy;\n#else\nfloat f = textDy;\n#endif\n#if defined(HAS_PITCH_ALIGN)\nfloat h = aPitchAlign;\n#else\nfloat h = textPitchWithMap;\n#endif\n#if defined(HAS_ROTATION_ALIGN)\nfloat i = aRotationAlign;\n#else\nfloat i = textRotateWithMap;\n#endif\ngl_Position = projViewModelMatrix * positionMatrix * vec4(c, 1.);\n  float j = gl_Position.w;\n  float k;\n  if(isRenderingTerrain == 1. && h == 1.) {\n    k = 1.;\n  } else {\n    float l = (1. - cameraToCenterDistance / j) * textPerspectiveRatio;\n    k = clamp(.5 + .5 * (1. - l), .0, 4.);\n  }\n#ifdef HAS_TEXT_ROTATION\nfloat m = -aRotation / 9362. - mapRotation * i;\n#else\nfloat m = -textRotation - mapRotation * i;\n#endif\nif(h == 1.) {\n    \n#ifdef REVERSE_MAP_ROTATION_ON_PITCH\nm += mapRotation;\n#else\nm -= mapRotation;\n#endif\n  }\n  float n = sin(m);\n  float o = cos(m);\n  mat2 u = mat2(o, -1. * n, n, o);\n  vec2 v = aShape.xy / 10.0;\n  if(h == 1. && flipY == .0) {\n    v = v * vec2(1., -1.);\n  }\n  vec2 A = aShape.zw;\n  v = u * (v / glyphSize * d);\n  float B;\n  if(isRenderingTerrain == 1.) {\n    B = 1.;\n  } else {\n    B = j / cameraToCenterDistance;\n  }\n  if(h == .0) {\n    vec2 C = v * 2. / canvasSize;\n    gl_Position.xy += C * k * j;\n  } else {\n    float D;\n    if(isRenderingTerrain == 1.) {\n      D = tileRatio / zoomScale;\n    } else {\n      D = tileRatio / zoomScale * B * k;\n    }\n    vec2 C = v;\n    gl_Position = projViewModelMatrix * positionMatrix * vec4(c + vec3(C, .0) * D, 1.);\n  }\n  gl_Position.xy += vec2(e, -f) * 2. / canvasSize * j;\n#ifndef PICKING_MODE\nif(h == .0) {\n    vGammaScale = mix(1., B, textPerspectiveRatio);\n  } else {\n    vGammaScale = B + mapPitch / 4.;\n  }\n  vTexCoord = A / glyphTexSize;\n  vGammaScale = clamp(vGammaScale, .0, 1.);\n  vTextSize = d;\n#ifdef ENABLE_COLLISION\nvOpacity = aOpacity / 255.;\n#else\nvOpacity = 1.;\n#endif\n#ifdef HAS_OPACITY\nvOpacity *= aColorOpacity / 255.;\n#endif\n#ifdef HAS_TEXT_FILL\nvTextFill = aTextFill / 255.;\n#endif\n#ifdef HAS_TEXT_HALO_FILL\nvTextHaloFill = aTextHaloFill / 255.;\n#endif\n#if defined(HAS_TEXT_HALO_RADIUS) || defined(HAS_TEXT_HALO_OPACITY)\nvTextHalo = aTextHalo;\n#endif\nhighlight_setVarying();\n#else\n#ifdef ENABLE_COLLISION\nbool E = aOpacity == 255.;\n#else\nbool E = true;\n#endif\nfbo_picking_setData(gl_Position.w, E);\n#endif\n}",jH="#define SHADER_NAME TEXT_LINE\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\nattribute vec2 aTexCoord;\n#ifdef HAS_OFFSET_Z\nattribute vec3 aOffset;\nuniform float altitudeScale;\n#else\nattribute vec2 aOffset;\n#endif\n#ifdef ENABLE_COLLISION\nattribute float aOpacity;\n#endif\n#ifdef HAS_OPACITY\nattribute float aColorOpacity;\n#endif\n#ifdef HAS_TEXT_SIZE\nattribute float aTextSize;\n#else\nuniform float textSize;\n#endif\n#ifdef HAS_TEXT_DX\nattribute float aTextDx;\n#else\nuniform float textDx;\n#endif\n#ifdef HAS_TEXT_DY\nattribute float aTextDy;\n#else\nuniform float textDy;\n#endif\n#if defined(HAS_PITCH_ALIGN)\nattribute float aPitchAlign;\n#else\nuniform float textPitchWithMap;\n#endif\nuniform float zoomScale;\nuniform float cameraToCenterDistance;\nuniform mat4 projViewModelMatrix;\nuniform float textPerspectiveRatio;\nuniform float mapPitch;\nuniform vec2 glyphTexSize;\nuniform vec2 canvasSize;\nuniform float tileRatio;\nuniform float layerScale;\nuniform float isRenderingTerrain;\nuniform float textPitchFilter;\n#ifndef PICKING_MODE\nvarying vec2 vTexCoord;\nvarying float vGammaScale;\nvarying float vTextSize;\nvarying float vOpacity;\n#ifdef HAS_TEXT_FILL\nattribute vec4 aTextFill;\nvarying vec4 vTextFill;\n#endif\n#ifdef HAS_TEXT_HALO_FILL\nattribute vec4 aTextHaloFill;\nvarying vec4 vTextHaloFill;\n#endif\n#if defined(HAS_TEXT_HALO_RADIUS) || defined(HAS_TEXT_HALO_OPACITY)\nattribute vec2 aTextHalo;\nvarying vec2 vTextHalo;\n#endif\n#include <highlight_vert>\n#else\n#include <fbo_picking_vert>\n#endif\n#include <vt_position_vert>\nvoid main() {\n  vec3 c = unpackVTPosition();\n#ifdef HAS_TEXT_DX\nfloat d = aTextDx;\n#else\nfloat d = textDx;\n#endif\n#ifdef HAS_TEXT_DY\nfloat e = aTextDy;\n#else\nfloat e = textDy;\n#endif\n#ifdef HAS_TEXT_SIZE\nfloat f = aTextSize * layerScale;\n#else\nfloat f = textSize * layerScale;\n#endif\n#ifdef HAS_PITCH_ALIGN\nfloat h = aPitchAlign;\n#else\nfloat h = textPitchWithMap;\n#endif\ngl_Position = projViewModelMatrix * vec4(c, 1.);\n  float i = gl_Position.w;\n  float j = i / cameraToCenterDistance;\n  float k;\n  if(isRenderingTerrain == 1.) {\n    k = 1.;\n  } else {\n    float l = (1. - cameraToCenterDistance / i) * textPerspectiveRatio;\n    k = clamp(.5 + .5 * (1. - l), .0, 4.);\n  }\n#ifdef HAS_OFFSET_Z\nvec3 m = aOffset / 10.0;\n  m[2] /= altitudeScale;\n#else\nvec3 m = vec3(aOffset / 10.0, .0);\n#endif\nvec2 n = aTexCoord;\n  if(h == 1.) {\n    float o;\n    if(isRenderingTerrain == 1.) {\n      o = tileRatio;\n    } else {\n      o = tileRatio / zoomScale * j * k;\n    }\n    m.xy *= o;\n    gl_Position = projViewModelMatrix * vec4(c + m, 1.);\n  } else {\n    gl_Position.xy += m.xy * 2. / canvasSize * k * i;\n  }\n  gl_Position.xy += vec2(d, -e) * 2. / canvasSize * i;\n  if(textPitchFilter > .0) {\n    if(textPitchFilter == 1. && h == .0 || textPitchFilter == 2. && h == 1.) {\n      gl_Position = vec4(-9999., -9999., .0, 1.);\n    }\n  }\n#ifndef PICKING_MODE\nif(h == 1.) {\n    vGammaScale = j + mapPitch / 4.;\n  } else {\n    vGammaScale = mix(1., j, textPerspectiveRatio);\n  }\n  vGammaScale = clamp(vGammaScale, .0, 1.);\n  vTexCoord = n / glyphTexSize;\n  vTextSize = f;\n#ifdef ENABLE_COLLISION\nvOpacity = aOpacity / 255.;\n#else\nvOpacity = 1.;\n#endif\n#ifdef HAS_OPACITY\nvOpacity *= aColorOpacity / 255.;\n#endif\n#ifdef HAS_TEXT_FILL\nvTextFill = aTextFill / 255.;\n#endif\n#ifdef HAS_TEXT_HALO_FILL\nvTextHaloFill = aTextHaloFill / 255.;\n#endif\n#if defined(HAS_TEXT_HALO_RADIUS) || defined(HAS_TEXT_HALO_OPACITY)\nvTextHalo = aTextHalo;\n#endif\nhighlight_setVarying();\n#else\n#ifdef ENABLE_COLLISION\nbool u = aOpacity == 255.;\n#else\nbool u = true;\n#endif\nfbo_picking_setData(gl_Position.w, u);\n#endif\n}",UH="#define SHADER_NAME TEXT_FRAG\nprecision mediump float;\nuniform float layerOpacity;\nvarying vec2 vTexCoord;\nvarying float vOpacity;\nuniform float alphaTest;\n#include <text_render_frag>\n#include <highlight_frag>\nvoid main() {\n  gl_FragColor = renderText(vTexCoord) * vOpacity * layerOpacity;\n  if(gl_FragColor.a < alphaTest) {\n    discard;\n  }\n  gl_FragColor = highlight_blendColor(gl_FragColor);\n}";const{TextUtil:VH,PackUtil:WH,FilterUtil:ZH,TEXT_MAX_ANGLE:qH}=ZR(),XH=function(t){const e=this.layer.getRenderer();return!this._isHalo0(t)&&e.isTileNearCamera(t)&&"line"!==t.geometry.properties.textPlacement},JH=function(t){const e=this.layer.getRenderer();return!this._isHalo0(t)&&!e.isForeground(t)&&"line"!==t.geometry.properties.textPlacement},QH=function(t){const e=this.layer.getRenderer();return!this._isHalo0(t)&&e.isTileNearCamera(t)&&"line"===t.geometry.properties.textPlacement},YH=function(t){const e=this.layer.getRenderer(),n=t.properties.tile.z,i=e.getCurrentTileZoom();return!this._isHalo0(t)&&!e.isForeground(t)&&"line"===t.geometry.properties.textPlacement&&n<i},KH=[0,0,3],$H=[],tB=[],eB=[],nB=[],iB=[],rB=[],oB=[],sB=[],aB=[1,-1],lB=new Int16Array(3),hB=[],cB=[],uB=[],fB=[],dB=[],gB=[],pB=[],AB={},mB={},yB={},_B=[],vB=[],xB=ay([]),bB=[];let wB=class xs extends aN{static getBloomSymbol(){return["textBloom"]}constructor(t,e,n,i,o,s){super(t,e,n,i,o,s),this.propAllowOverlap="textAllowOverlap",this.propIgnorePlacement="textIgnorePlacement",this.colorCache={},this._filter0=XH.bind(this),this._filter1=JH.bind(this),this._lineFilter0=QH.bind(this),this._lineFilter1=YH.bind(this),this.isLabelCollides=hH.bind(this),this._genTextNames()}prepareRender(...t){super.prepareRender(...t);const e=this.scene.getMeshes();if(e&&e.length)for(let t=0;t<e.length;t++){if(e[t].properties.isHalo)continue;const{haloMesh:n}=e[t].properties;n.dirtyDefines&&e[t].setDefines(n.defines)}}updateSymbol(...t){this._tagTerrainVector=void 0,this._tagTerrainSkin=void 0;const e=super.updateSymbol(...t);return this._genTextNames(),e}isTerrainVector(){if(!super.isTerrainSkin())return!1;if(void 0!==this._tagTerrainVector)return this._tagTerrainVector;for(let t=0;t<this.symbolDef.length;t++)if("map"!==this.symbolDef[t].textPitchAlignment)return this._tagTerrainVector=!0,!0;return this._tagTerrainVector=!1,!1}isTerrainSkin(){if(!super.isTerrainSkin())return!1;if(void 0!==this._tagTerrainSkin)return this._tagTerrainSkin;for(let t=0;t<this.symbolDef.length;t++){const e=this.symbolDef[t].textPitchAlignment;if("map"===e||mk(e)||ZH.isExpression(e))return this._tagTerrainSkin=!0,!0}return this._tagTerrainSkin=!1,!1}_genTextNames(){this._textNameFn=[];for(let t=0;t<this.symbolDef.length;t++){const e=this.symbolDef[t];if(ZH.isExpression(e.textName)){const n=ZH.createExpression(e.textName,"string");this._textNameFn[t]=(t,e)=>{let i;AB.zoom=t,mB.properties=e;try{i=n.evaluateWithoutErrorHandling(AB,mB,yB,null,_B)}catch(t){i=null}return i}}else mk(e.textName)&&(this._textNameFn[t]=_k(e.textName))}}shouldDeleteMeshOnUpdateSymbol(t){if(!Array.isArray(t))return(0===t.textHaloRadius||0===this.symbolDef[0].textHaloRadius)&&t.textHaloRadius!==this.symbolDef[0].textHaloRadius;for(let e=0;e<t.length;e++)if(t[e]&&(0===t[e].textHaloRadius||0===this.symbolDef[e].textHaloRadius)&&t[e].textHaloRadius!==this.symbolDef[e].textHaloRadius)return!0;return!1}createFnTypeConfig(t,e){return rH(t,e)}isBloom(t){return!!this.getSymbol(t.properties.symbolIndex)[xs.getBloomSymbol()[0]]}createGeometry(t,e,n){const i=t;if(!i.glyphAtlas)return null;const o=super.createGeometry(i,e);if(!o||!o.geometry)return null;const{geometry:s}=o;return s.properties.glyphAtlas&&this.drawDebugAtlas(s.properties.glyphAtlas),s&&i.lineVertex&&(s.properties.line=i.lineVertex,s.properties.line.id=n),o}createMesh(t,e,{tileVectorTransform:n}){const i=this.isEnableCollision(),o=this.isEnableUniquePlacement(),{geometry:s,symbolIndex:a}=t;s.properties.symbolIndex=a;const l=this.getSymbol(a),h=this.getSymbolDef(a),c=this.getFnTypeConfig(a),u=QN.call(this,this.regl,s,e,h,l,c,this.layer.options.collision,!i,o);return u.length&&("line"===s.properties.textPlacement?this._hasLineText=!0:this._hasNormalText=!0),u.forEach((t=>{t.positionMatrix=this.getAltitudeOffsetMatrix(),t.properties.tileVectorTransform=n})),u}updateCollision(t){super.updateCollision(t);const e=this.scene.getMeshes();e&&e.length?(this._projectedLinesCache={},this._updateLabels(t.timestamp),this._endCollision()):this._endCollision()}callCurrentTileShader(t,e){this.shader.filter=e.sceneFilter?[this._filter0,e.sceneFilter]:this._filter0,this.callRenderer(this.shader,t,e),this._shaderAlongLine.filter=e.sceneFilter?[this._lineFilter0,e.sceneFilter]:this._lineFilter0,this.callRenderer(this._shaderAlongLine,t,e)}callBackgroundTileShader(t,e){this.shader.filter=e.sceneFilter?[this._filter1,e.sceneFilter]:this._filter1,this.callRenderer(this.shader,t,e),this._shaderAlongLine.filter=e.sceneFilter?[this._lineFilter1,e.sceneFilter]:this._lineFilter1,this.callRenderer(this._shaderAlongLine,t,e)}callRenderer(t,e,n){n&&n.isRenderingTerrain&&mk(this.symbolDef.textPitchAlignment)&&(e.textPitchFilter=n.isRenderingTerrainSkin?1:2),super.callRenderer(t,e,n)}_updateLabels(){let t=this.scene.getMeshes();if(!t||!t.length)return;const e=-this.getMap().getBearing()*Math.PI/180,n=Um(eB,e),i=(t,e,n,i)=>{const{start:o,end:s,mesh:a,allElements:l}=e[0];if(this.updateBoxCollisionFading(!0,a,e,n,i)){let e=t.count;for(let n=o;n<s;n++)t[e++]=l[n];t.count=e}},o=this.isEnableCollision(),s=this.layer.getRenderer();t=t.sort(MB);for(let e=0;e<t.length;e++){const a=t[e];if(!this.isMeshIterable(a))continue;if(!s.isTileNearCamera(a)){const{visElemts:t}=a.geometry.properties;t&&(t.count=0),a.geometry.setElements(t,0);continue}const l=a.geometry,h=this.getSymbol(a.properties.symbolIndex);a.properties.textHaloRadius=NL(h.textHaloRadius)?JN.textHaloRadius:h.textHaloRadius;const c=a.properties.meshKey;if("line"===l.properties.textPlacement){if(!l.properties.line)continue;o&&this.startMeshCollision(a),this._updateLineLabel(a,n);const{aOffset:t,aOpacity:e}=l.properties;t.dirty&&(l.updateData("aOffset",t),t.dirty=!1),e&&e.dirty&&(l.updateData("aOpacity",e),e.dirty=!1),o&&this.endMeshCollision(c)}else if(o){this.startMeshCollision(a);const{elements:t,aOpacity:e,visElemts:n}=l.properties;n.count=0,this.forEachBox(a,((t,e,o,s,a)=>{i(n,e,o,s)})),e&&e.dirty&&l.updateData("aOpacity",e);n.count===t.length&&l.count===t.length||!n.count&&!l.count||l.setElements(n,n.count),this.endMeshCollision(c)}}}isMeshIterable(t){return t.isValid()&&t.material&&!t.material.get("isHalo")&&!(this.shouldIgnoreBackground()&&!this.layer.getRenderer().isForeground(t))}isMeshUniquePlaced(t){return!!this.isMeshIterable(t)&&"line"!==this.getSymbol(t.properties.symbolIndex).textPlacement}getUniqueEntryKey(t,e){return cH(t,e)}_updateLineLabel(t,e){const n=this.getMap(),i=t.geometry,o=i.properties;let s=o.line;if(!s)return;const a=n.getPitch(),l=n.getBearing(),{lineTextPitch:h,lineTextBearing:c}=t.properties,u=1===t.material.uniforms.textPitchWithMap,f=o.elements;if(!u){const e=cy($H,n.projViewMatrix,t.localTransform),i=s.id+"-"+e.join();let a;this._projectedLinesCache[i]?s=this._projectedLinesCache[i]:(a=o.projectedLine=o.projectedLine||new Array(s.length),s=this._projectLine(a,s,e,n.width,n.height),this._projectedLinesCache[i]=a)}const g=this.isEnableCollision(),A=i.properties.visElemts=i.properties.visElemts||new f.constructor(f.length),m=i.properties.visCache=i.properties.visCache||[];g&&(A.count=0);const w=void 0===h||!n.isInteracting()||Math.abs(a-h)>2||Math.abs(l-c)>2;w&&(this._meshCollisionStale=!0),this.forEachBox(t,((t,n,i,o)=>{const{start:a,end:l}=n[0];let h=m[o];if((void 0===h||w)&&(h=this._updateLabelAttributes(t,f,a,l,s,i,u?e:null,o)),m[o]=h,g&&(h=this.updateBoxCollisionFading(h,t,n,i,o),h)){let t=A.count;for(let e=a;e<l;e++)A[t++]=f[e];A.count=t}})),w&&(t.properties.lineTextPitch=a,t.properties.lineTextBearing=l);const T=t.geometry.properties.aAltitude;T&&T.dirty&&(i.updateData("aAltitude",T),T.dirty=!1),!g||A.count===f.length&&i.count===A.count||i.setElements(A,A.count)}_projectLine(t,e,n,i,o){const s=function(t,e,n,i,o){for(let s=0;s<e.length;s+=3)g_(JD,e[s],e[s+1],e[s+2],1),QD(JD,JD,n,i,o),t[s]=JD[0],t[s+1]=JD[1],t[s+2]=e[s+2];return t}(t,e,n,i,o);return s}forEachBox(t,e){const n=this.getMap(),i=cy($H,n.projViewMatrix,t.properties.tileVectorTransform),{collideIds:o,aCount:s,features:a,elements:l}=t.geometry.properties;if(!o)return;const h=this.isEnableUniquePlacement(),c=this._getMeshBoxes(1);c[0].allElements=l,c[0].mesh=t;let u=0,f=l[0],g=0,A=o[f];for(let n=0;n<=l.length;n+=6)if(f=l[n],o[f]!==A||n===l.length){const m=a[A]&&a[A].feature;if(h&&this.isMeshUniquePlaced(t)&&m&&!m.label){const e=m.properties||{},{symbolIndex:n}=t.properties,i=n&&this._textNameFn[n.index]?this._textNameFn[n.index](t.properties.z,e):this.getSymbol(t.properties.symbolIndex).textName,o=VH.resolveText(i,e);m.label=o}const w=n,T=s[l[g]];for(let n=g;n<w;n+=6*T)c[0].start=n,c[0].end=n+6*T,c[0].boxCount=T,e.call(this,t,c,i,u++);A=o[f],g=n}}_updateLabelAttributes(t,e,n,i,o,s,a){const l=this.layer.getRenderer(),h=t.material.uniforms,c=1===h.textPitchWithMap,u=!c&&l.getTerrainHelper&&l.getTerrainHelper(),f=this.isEnableCollision(),g=this.getMap(),A=t.geometry,m=A.desc.positionSize,{aShape:w,aOffset:T,aAnchor:M,aAltitude:C,aPitchRotation:P}=A.properties;let{aProjectedAnchor:I}=A.properties;I||(I=A.properties.aProjectedAnchor=new Array(M.length/m*3));const O=A.properties.aTextSize,E=!a,D=e[n],N=D*m;let H;H=A.data.aAltitude?Fy(nB,M[N],M[N+1],C[D]):WH.unpackPosition(nB,M[N],M[N+1],M[N+2]);const U=QD(iB,H,s,g.width,g.height),W=A.properties.aTerrainAltitude;let q;if(W){const t=W[D];if(t===ML)return I[3*D]=TL,I[3*D+1]=TL,I[3*D+2]=TL,!1;t?(q=Fy(vB,...H),q[2]=100*t,q=QD(q,q,s,g.width,g.height)):q=U}else q=U;const X=g.getDevicePixelRatio();if(__(bB,q,1/X),g.isOffscreen(bB))return f||TB(T,e,n,i),I[3*D]=TL,I[3*D+1]=TL,I[3*D+2]=TL,!1;E&&(H=U),I[3*D]=q[0],I[3*D+1]=q[1],I[3*D+2]=q[2];const J=E?1:A.properties.tileExtent/this.layer.getTileSize().width;let Q=!0;const Y=e[n],K=e[i-1],$=O?O[Y]:t.properties.textSize,tt=this._updateNormal(t,$,o,Y,K,H,nB,J,a);if(null===tt)return TB(T,e,n,i),!1;const et=K-Y<=3,nt=Math.floor(tt/2),it=tt%2;for(let a=n;a<i;a+=6){const l=e[a];let g;if(g=nt||a!==n||et||u?nt||a!==i-6||et||u?NH.call(this,tB,t,$,o,l,H,nB,J,nt,q,this.layer,s,c):pB:gB,!g){Q=!1,f||TB(T,e,n,i);break}let A=g[2];it&&(A-=Math.PI/2);const m=xN(rB,A,0,h.textRotateWithMap,h.textPitchWithMap),M=T.length>w.length;let C;if(M){Fy(fB,P[3*l],P[3*l+1],0);const t=Zy(fB,fB),e=-P[3*l+2];if(e){const n=G_(hB,t,e);gy(cB,KH),by(uB,n),C=cy(uB,uB,cB)}}for(let t=0;t<4;t++){const e=2*(l+t);Ev(oB,w[e]/10,w[e+1]/10),Fv(oB,oB,$/24),Gv(oB,oB,m),c?(Lv(oB,oB,aB),kv(sB,oB,g),M&&(sB[2]=0,C&&Jy(sB,sB,C))):(Lv(sB,g,aB),kv(sB,oB,sB)),lB[0]=10*sB[0],lB[1]=10*sB[1],M&&(lB[2]=10*sB[2]);const n=(M?3:2)*(l+t);(T[n]!==lB[0]||T[n+1]!==lB[1]||M&&T[n+2]!==lB[2])&&(T.dirty=!0,T[n]=lB[0],T[n+1]=lB[1],M&&(T[n+2]=lB[2]))}}return Q}_updateNormal(t,e,n,i,o,s,a,l,h){const c=o-i<=3,u=this.getMap(),f=this.getSymbol(t.geometry.properties.symbolIndex);return c?0:zH.call(this,gB,pB,t,e,n,i,o,s,a,l,u.width/u.height,h,f.textMaxAngle||qH)}isBoxCollides(t,e,n,i,o,s){return this.isLabelCollides(0,t,e,n,i,o,s)}deleteMesh(t,e){t&&(e&&(Array.isArray(t)?t.forEach((t=>{t&&t.material&&delete t.material.uniforms.texture})):t.material&&delete t.material.uniforms.texture),super.deleteMesh(t,e))}delete(){super.delete(),this._shaderAlongLine.dispose(),delete this._projectedLinesCache,this._linePicking&&this._linePicking.dispose()}isUniqueStencilRefPerTile(){return!1}isEnableTileStencil(){return!this.layer.getRenderer().isEnableWorkAround("win-intel-gpu-crash")}init(){this.renderer=new cw(this.regl);const{uniforms:t,extraCommandProps:e}=iH.call(this,this.canvas,this.sceneConfig),n=this.canvas,i={x:(t,e)=>e.viewport?e.viewport.x:0,y:(t,e)=>e.viewport?e.viewport.y:0,width:(t,e)=>e.viewport?e.viewport.width:n?n.width:1,height:(t,e)=>e.viewport?e.viewport.height:n?n.height:1};e.viewport=i,this.shader=new zw({vert:GH,frag:UH,uniforms:t,extraCommandProps:e});let o=e;if(this.layer.getRenderer().isEnableWorkAround("win-intel-gpu-crash")&&(o=LL({},e),o.stencil=LL({},e.stencil),o.stencil.enable=!0,o.stencil.func.cmp="<",o.stencil.func.ref=(t,e)=>2*e.level+(e.isHalo||0)+1),this._shaderAlongLine=new zw({vert:jH,frag:UH,uniforms:t,extraCommandProps:o}),this.pickingFBO){const e=new zM(this.renderer,{vert:"#define PICKING_MODE 1\n"+GH,uniforms:t,extraCommandProps:{viewport:this.pickingViewport}},this.pickingFBO,this.getMap());e.filter=t=>"line"!==this.getSymbol(t.properties.symbolIndex).textPlacement;const n=new zM(this.renderer,{vert:"#define PICKING_MODE 1\n"+jH,uniforms:t,extraCommandProps:{viewport:this.pickingViewport}},this.pickingFBO,this.getMap());n.filter=t=>"line"===t.geometry.properties.textPlacement,this.picking=[e,n]}}getUniformValues(t,e){const n=e&&e.isRenderingTerrainSkin,i=this.layer.getTileSize().width,o=n?xB:t.projViewMatrix,s=t.cameraToCenterDistance,a=Ev(dB,t.width,t.height);n&&Ev(a,i,i);const l=oL(t.getResolution(),t);return{layerScale:this.layer.options.styleScale||1,mapPitch:t.getPitch()*Math.PI/180,mapRotation:t.getBearing()*Math.PI/180,projViewMatrix:o,viewMatrix:t.viewMatrix,cameraToCenterDistance:s,canvasSize:a,glyphSize:MN,gammaScale:1*(this.layer.options.textGamma||1),resolution:t.getResolution(),altitudeScale:l,viewport:n&&e&&e.viewport,textPitchFilter:0,isRenderingTerrain:+!!n}}};function TB(t,e,n,i){for(let o=n;o<i;o+=6){const n=e[o];for(let e=0;e<4;e++){const i=3*(n+e);(t[i]||t[i+1]||t[i+2])&&(t.dirty=!0,t[i]=0,t[i+1]=0,t[i+2]=0)}}}function MB(t,e){const n=t.properties.level-e.properties.level;return 0===n?t.properties.meshKey-e.properties.meshKey:n}var CB="#define SHADER_NAME NATIVE_POINT\n#include <gl2_vert>\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\n#ifdef HAS_COLOR\nattribute vec4 aColor;\nvarying vec4 vColor;\n#endif\nuniform mat4 positionMatrix;\nuniform mat4 projViewModelMatrix;\nuniform float markerSize;\n#ifdef PICKING_MODE\n#include <fbo_picking_vert>\n#endif\n#include <vt_position_vert>\nvoid main() {\n  vec3 c = unpackVTPosition();\n  gl_Position = projViewModelMatrix * positionMatrix * vec4(c, 1.);\n  gl_PointSize = markerSize;\n#ifdef HAS_COLOR\nvColor = aColor / 255.;\n#endif\n#ifdef PICKING_MODE\nfbo_picking_setData(gl_Position.w, true);\n#endif\n}";const SB={markerFill:[0,0,0],markerOpacity:1,markerSize:10};let PB=class Ts extends bF{getPrimitive(){return"points"}isTerrainSkin(){return!1}isTerrainVector(){return this.layer.options.awareOfTerrain}isUniqueStencilRefPerTile(){return!1}createMesh(t,e){const{geometry:n,symbolIndex:i,ref:o}=t,s=this.getSymbol(i);void 0===o&&(LD(n,this.getSymbolDef(i),this.getFnTypeConfig(i),this.layer),n.generateBuffers(this.regl));const a={};BL(a,"markerOpacity",s,"markerOpacity",1),BL(a,"markerSize",s,"markerSize",10),BL(a,"markerFill",s,"markerFill","#000",jL(this.colorCache,3));const l=new Qb(a,SB);l.createDefines=()=>"square"!==s.markerType?{USE_CIRCLE:1}:null,l.appendDefines=t=>("square"!==s.markerType&&(t.USE_CIRCLE=1),t);const h=new aw(n,l,{castShadow:!1,picking:!0}),c={};return h.geometry.data.aAltitude&&(c.HAS_ALTITUDE=1),n.data.aColor&&(c.HAS_COLOR=1),h.setDefines(c),h.positionMatrix=this.getAltitudeOffsetMatrix(),h.setLocalTransform(e),h.properties.symbolIndex=i,h}createFnTypeConfig(t,e){const n=vk(e.markerFill);return[{attrName:"aColor",symbolName:"markerFill",type:Uint8Array,width:4,define:"HAS_COLOR",evaluate:(e,i)=>{let o=n(t.getZoom(),e);return mk(o)&&(o=this.evaluateInFnTypeConfig(o,i,t,e,!0)),Array.isArray(o)||(o=this.colorCache[o]=this.colorCache[o]||KE(o).unitArray()),o=GL(o),o}}]}init(){this.renderer=new cw(this.regl);const t=[],e={vert:CB,frag:"#define SHADER_NAME NATIVE_POINT\nprecision mediump float;\n#include <gl2_frag>\n#ifdef USE_CIRCLE\n#if __VERSION__ == 100\n#ifdef GL_OES_standard_derivatives\n#define STANDARD_DERIVATIVES_ENABLED 1\n#extension GL_OES_standard_derivatives : enable\n#endif\n#else\n#define STANDARD_DERIVATIVES_ENABLED 1\n#endif\n#endif\n#ifdef HAS_COLOR\nvarying vec4 vColor;\n#else\nuniform vec3 markerFill;\n#endif\nuniform float markerOpacity;\nuniform float layerOpacity;\nvoid main() {\n  float c = 1.;\n#ifdef USE_CIRCLE\nfloat r = .0, d = .0;\n  vec2 e = 2. * gl_PointCoord - 1.;\n  r = dot(e, e);\n  if(r > 1.) {\n    discard;\n  }\n#ifdef STANDARD_DERIVATIVES_ENABLED\nd = fwidth(r);\n  c = 1. - smoothstep(1. - d, 1. + d, r);\n#endif\n#endif\n#ifdef HAS_COLOR\nvec4 f = vColor;\n#else\nvec4 f = vec4(markerFill, 1.);\n#endif\nglFragColor = f * markerOpacity * c * layerOpacity;\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(e,n){return cy(t,n.projViewMatrix,n.modelMatrix),t}}],defines:null,extraCommandProps:{viewport:{x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1},depth:{enable:!0,mask:!1,range:this.sceneConfig.depthRange||[0,1],func:this.sceneConfig.depthFunc||"always"},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"}}};if(this.shader=new zw(e),this.shader.version=300,this.pickingFBO){const t=[];this.picking=[new zM(this.renderer,{vert:"#define PICKING_MODE 1\n"+CB,uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(e,n){return cy(t,n.projViewMatrix,n.modelMatrix),t}}],extraCommandProps:{viewport:this.pickingViewport}},this.pickingFBO,this.getMap())]}}getUniformValues(t){return{projViewMatrix:t.projViewMatrix}}};var IB="#define SHADER_NAME NATIVE_LINE\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\nuniform mat4 projViewModelMatrix;\nuniform mat4 positionMatrix;\n#ifndef PICKING_MODE\n#if defined(HAS_COLOR)\nattribute vec4 aColor;\nvarying vec4 vColor;\n#endif\n#else\n#include <fbo_picking_vert>\n#endif\n#include <vt_position_vert>\nvoid main() {\n  vec3 c = unpackVTPosition();\n  gl_Position = projViewModelMatrix * positionMatrix * vec4(c, 1.);\n#ifndef PICKING_MODE\n#if defined(HAS_COLOR)\nvColor = aColor / 255.;\n#endif\n#else\nfbo_picking_setData(gl_Position.w, true);\n#endif\n}";const OB=ay([]);let EB=class Ms extends bF{constructor(t,e,n,i,o,s){if(super(t,e,n,i,o,s),this.primitive="lines",mk(this.symbolDef.lineColor)){const t=e.getMap(),n=vk(this.symbolDef.lineColor);this.colorSymbol=e=>n(t.getZoom(),e)}}needPolygonOffset(){return!0}createMesh(t,e){const{geometry:n,symbolIndex:i,ref:o}=t,s=this.getSymbol(i),a=this.getMeshUniforms(n,s);void 0===o&&n.generateBuffers(this.regl);const l=new Qb(a),h=new aw(n,l,{castShadow:!1,picking:!0});h.setLocalTransform(e),h.properties.symbolIndex=i;const c={};return h.geometry.data.aAltitude&&(c.HAS_ALTITUDE=1),h.setDefines(c),h}getMeshUniforms(t,e){const n={};return BL(n,"lineColor",e,"lineColor","#000",jL(this.colorCache)),BL(n,"lineOpacity",e,"lineOpacity",1),n}isEnableTileStencil(t){return!(t&&t.isRenderingTerrain&&this.isTerrainSkin())}init(){this.renderer=new cw(this.regl);const t=this.canvas,e=[{name:"projViewModelMatrix",type:"function",fn:function(t,e){const n=[];return cy(n,e.projViewMatrix,e.modelMatrix),n}}],n={vert:IB,frag:"#define SHADER_NAME NATIVE_LINE\nprecision mediump float;\nuniform float lineOpacity;\nuniform vec4 lineColor;\nuniform float layerOpacity;\n#if defined(HAS_COLOR)\nvarying vec4 vColor;\n#endif\nvoid main() {\n  gl_FragColor = lineColor * lineOpacity;\n#if defined(HAS_COLOR)\ngl_FragColor *= vColor;\n#endif\ngl_FragColor *= layerOpacity;\n}",uniforms:e,defines:null,extraCommandProps:{viewport:{x:(t,e)=>e.viewport?e.viewport.x:0,y:(t,e)=>e.viewport?e.viewport.y:0,width:(e,n)=>n.viewport?n.viewport.width:t?t.width:1,height:(e,n)=>n.viewport?n.viewport.height:t?t.height:1},stencil:{enable:(t,e)=>this.isEnableTileStencil(e.painterContext),mask:255,func:{cmp:()=>this.isOnly2D()?"=":"<=",ref:(t,e)=>e.stencilRef,mask:255},op:{fail:"keep",zfail:"keep",zpass:"replace"}},depth:{enable:!0,range:this.sceneConfig.depthRange||[0,1],func:this.sceneConfig.depthFunc||"<="},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}}};this.shader=new zw(n),this.pickingFBO&&(this.picking=[new zM(this.renderer,{vert:"#define PICKING_MODE 1\n"+IB,uniforms:e,extraCommandProps:{viewport:this.pickingViewport}},this.pickingFBO,this.getMap())])}getUniformValues(t,e){const n=e&&e.isRenderingTerrainSkin;return{projViewMatrix:n?OB:t.projViewMatrix,viewport:n&&e&&e.viewport}}getPrimitive(){return"lines"}};const{DEFAULT_TEX_WIDTH:kB}=ZR(),RB=[1,1,1],LB=[1,1,1,1],DB=[0,0],FB=[1,1],NB=[],HB=new gh(0,0),BB=new gh(0,0),zB=[],GB=[];let jB=class Hs extends _F{isEnableTileStencil(){return!1}supportRenderMode(t){return this.isAnimating()?"fxaa"===t||"fxaaAfterTaa"===t:"taa"===t||"fxaa"===t}isTerrainSkin(){return!1}isTerrainVector(){return this.layer.options.awareOfTerrain}isAnimating(){return!1}createMesh(t,e,{tilePoint:n}){if(!this.material)return this.setToRedraw(),null;const{geometry:i,symbolIndex:o}=t,s=this.layer instanceof kp,a=new aw(i,this.material);if(this.sceneConfig.animation){RB[2]=.01;const t=[];py(t,RB),cy(t,e,t),e=t}const l=this.getSymbolDef(o),h=this.getFnTypeConfig(o);LD(i,l,h,this.layer);const c=this.getShader(),u=c.getGeometryDefines?c.getGeometryDefines(i):{},f=this.getSymbol(o),g=jL(this.colorCache);if(i.data.aExtrude){u.IS_LINE_EXTRUSION=1;const{tileResolution:t,tileRatio:e}=i.properties,n=this.getMap();Object.defineProperty(a.uniforms,"linePixelScale",{enumerable:!0,get:function(){return e*n.getResolution()/t}}),BL(a.uniforms,"lineWidth",f,"lineWidth",4),BL(a.uniforms,"lineOpacity",f,"lineOpacity",1),BL(a.uniforms,"lineColor",f,"lineColor","#fff",g),Object.defineProperty(a.uniforms,"lineHeight",{enumerable:!0,get:()=>{const t=this.dataConfig.defaultAltitude*(this.dataConfig.altitudeScale||1);return WL(t)?t:0}})}else{BL(a.uniforms,"polygonFill",f,"polygonFill",LB,g),BL(a.uniforms,"polygonOpacity",f,"polygonOpacity",1);const t=[];Object.defineProperty(a.uniforms,"vertexColorsOfType",{enumerable:!0,get:()=>{const e=g(f.bottomPolygonFill||LB),n=g(f.topPolygonFill||LB);t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=n[0],t[5]=n[1],t[6]=n[2],t[7]=n[3];const i=a.geometry.properties.vertexColors;if(i){let e=8;t.length=8+i.length;for(let n=0;n<i.length;n++)t[e++]=i[n][0],t[e++]=i[n][1],t[e++]=i[n][2],t[e++]=i[n][3]}return t}})}if(i.data.aColor&&(u.HAS_COLOR=1),i.data.aOpacity&&(u.HAS_OPACITY=1),i.data.aLineWidth&&(u.HAS_LINE_WIDTH=1),i.data.aLineHeight&&(u.HAS_LINE_HEIGHT=1),i.data.aTerrainAltitude&&(u.HAS_TERRAIN_ALTITUDE=1),i.data.aVertexColorType){const t=a.geometry.properties.vertexColors;let e=2;t&&(e+=t.length),u.VERTEX_TYPES_COUNT=e}if(i.data.aOpacity){const t=i.data.aOpacity;for(let e=0;e<t.length;e++)if(t[e]<255){i.properties.hasAlpha=!0;break}}u.HAS_MIN_ALTITUDE=1,u.HAS_LAYER_OPACITY=1,i.generateBuffers(this.regl),a.setDefines(u),a.setPositionMatrix(this.getAltitudeOffsetMatrix()),a.setLocalTransform(e),(i.properties.maxAltitude<=0||a.properties.level>=3)&&(a.castShadow=!1),a.setUniform("maxAltitude",a.geometry.properties.maxAltitude),Object.defineProperty(a.uniforms,"minAltitude",{enumerable:!0,get:()=>this.layer.options.altitude||0});const{tileResolution:A}=i.properties,m=this.getMap(),w=this.layer.getRenderer(),T=m.pointAtResToCoord(new _e(n),A),M=function(t,e,n,i,o){return t.pointAtResToDistance(1,0,i,n)}(m,0,T,A),C=[];Object.defineProperty(a.uniforms,"uvOrigin",{enumerable:!0,get:()=>this._computeUVOffset(C,o,n,A,M,s)}),a.setUniform("uvOffset",[0,0]),Object.defineProperty(a.uniforms,"hasAlpha",{enumerable:!0,get:()=>{const t=this.getSymbol(o);return i.properties.hasAlpha||t.polygonOpacity<1||t.lineOpacity<1||a.material&&(a.material.uniforms.baseColorTexture||a.material.uniforms.emissiveTexture)}});const P=this.layer.getMap().getMaxNativeZoom();return Object.defineProperty(a.uniforms,"stencilRef",{enumerable:!0,get:()=>w.isForeground(a)?0:P-a.properties.tile.z}),a.properties.symbolIndex=o,a}_computeUVOffset(t,e,n,i,o,s){if(1===this.dataConfig.topUVMode)return t[0]=0,t[1]=0,t;const a=this.getMap(),l=this.getSymbol(e).material;let h=n;!this.dataConfig.side&&l&&l.textureOrigin&&(HB.set(l.textureOrigin[0],l.textureOrigin[1]),a.coordToPointAtRes(HB,i,BB),h=Ev(zB,n[0]-BB.x,n[1]-BB.y));const c=!!l&&l.uvOffsetInMeter;let u=l&&l.uvOffset||DB;const f=this.getUVOffsetAnim();f&&(u=this.getUVOffset(f));const g=l&&l.uvScale||FB;let A=this.dataConfig.side?0:h[0],m=this.dataConfig.side?0:h[1];const w=l&&l.textureWidth||kB;c&&(A+=u[0]/o,m+=u[1]/o);const T=Ev(t,A*o*g[0]/w+(c?0:u[0]),m*o*g[1]/(w*g[1]/g[0])+(c?0:u[1]));return s||(T[1]*=-1),T}callShader(t,e){const n=this.sceneConfig.cullFace;this.sceneConfig.cullFace="front",this.callBackgroundTileShader(t,e),void 0===n?delete this.sceneConfig.cullFace:this.sceneConfig.cullFace=n,super.callShader(t,e)}getShadowMeshes(){if(!this.isVisible())return NB;this.shadowCount=this.scene.getMeshes().length;const t=this.scene.getMeshes().filter((t=>0===t.properties.level));for(let e=0;e<t.length;e++){const n=t[e];n.material!==this.material&&n.setMaterial(this.material)}return t}getUVOffsetAnim(){const t=this.getSymbols()[0];return t.material&&t.material.uvOffsetAnim}getUVOffset(t){const e=this.getSymbols()[0],n=e.material&&e.material.uvOffset||DB,i=!!e.material&&e.material.uvOffsetInMeter,o=performance.now()/1e3,s=Ev(GB,n[0],n[1]);return s[0]=o*t[0],s[1]=o*t[0],i||(s[0]%=1,s[1]%=1),s}needPolygonOffset(){return this._needPolygonOffset}startFrame(...t){return delete this._needPolygonOffset,super.startFrame(...t)}addMesh(t,e){t.forEach((t=>{this._prepareMesh(t,e)})),super.addMesh(...arguments)}_prepareMesh(t,e){if(null!==e){const n=t.localTransform;0===e&&(e=.01),RB[2]=e,py(n,RB),cy(n,t.properties.tileTransform,n),t.setLocalTransform(n)}else t.setLocalTransform(t.properties.tileTransform);t.material!==this.material&&t.setMaterial(this.material),t.geometry.properties.maxAltitude<=0&&(this._needPolygonOffset=!0),t.ssr=this.getSymbol(t.properties.symbolIndex).ssr?1:0}deleteMaterial(){this.material&&(this.material.dispose(),delete this.material)}deleteMesh(t,e){if(t)if(this.scene.removeMesh(t),Array.isArray(t))for(let n=0;n<t.length;n++)e||(t[n].geometry.dispose(),delete t[n].geometry.properties.layer),t[n].dispose();else e||(t.geometry.dispose(),delete t.geometry.properties.layer),t.dispose()}updateDataConfig(t,e){return!("line-extrusion"===this.dataConfig.type&&!t.altitudeProperty&&!e.altitudeProperty)}createFnTypeConfig(t,e){const n=vk(e.polygonFill||e.lineColor),i=_k(e.polygonOpacity||e.lineOpacity),o=_k(e.lineWidth),s=new Uint8Array(1),a=new Uint16Array(1);return[{attrName:"aColor",type:Uint8Array,width:4,symbolName:e.polygonFill?"polygonFill":e.lineColor?"lineColor":"polygonFill",define:"HAS_COLOR",evaluate:(e,i)=>{let o=n(t.getZoom(),e);return mk(o)&&(o=this.evaluateInFnTypeConfig(o,i,t,e,!0)),Array.isArray(o)||(o=this.colorCache[o]=this.colorCache[o]||KE(o).unitArray()),o=GL(o),o}},{attrName:"aOpacity",type:Uint8Array,width:1,symbolName:e.polygonOpacity?"polygonOpacity":e.lineOpacity?"lineOpacity":"polygonOpacity",evaluate:(e,n)=>{let o=i(t.getZoom(),e);return mk(o)&&(o=this.evaluateInFnTypeConfig(o,n,t,e,!1)),s[0]=255*o,s[0]<255&&(n.properties.hasAlpha=!0),s[0]}},{attrName:"aLineWidth",type:Uint8Array,width:1,symbolName:"lineWidth",define:"HAS_LINE_WIDTH",evaluate:e=>{const n=o(t.getZoom(),e);return a[0]=Math.round(2*n),a[0]}}]}updateSymbol(t,e){let n=!1;t&&t.material&&(n=function(t,e){for(const n in e)if(VB[n]&&e[n]!==t[n]&&(!t[n]||!e[n]))return!0;return!1}(this.symbolDef[0].material||{},t.material));const i=super.updateSymbol(t,e);return t&&t.material&&this._updateMaterial(t.material),n||i}_isNeedRefreshStyle(t,e){return UB(t)!==UB(e)}};function UB(t){if(!t||!t.material)return!1;for(const e in t.material)if(e.indexOf("Texture")>0&&t.material[e])return!0;return!1}const VB={normalTexture:1,bumpTexture:1};let WB=class Vs extends jB{createGeometry(t){const e=t.data,n=this.getSymbols()[0];if(n.material&&n.material.extrusionOpacity){const t=new Uint8Array(e.aPosition.length/3);for(let n=0;n<e.aPosition.length;n+=3)t[n/3]=e.aPosition[n+2]>0?0:1;e.aExtrusionOpacity=t}const i=new vb(e,t.indices);return LL(i.properties,t.properties),this._prepareFeatureIds(i,t),{geometry:i,symbolIndex:{index:0}}}updateSceneConfig(t){let e;if(this.sceneConfig.cullFace!==t.cullFace&&(e=!0),LL(this.sceneConfig,t),e){const t=this.getShaderConfig();this.shader.dispose(),this.shader=new Gw(t)}this.setToRedraw()}getShader(){return this.shader}delete(t){this.getMap().off("updatelights",this._updateLights,this),super.delete(t),this.material.dispose()}init(){this.getMap().on("updatelights",this._updateLights,this);this.renderer=new cw(this.regl);const t=this.getShaderConfig();this.shader=new Gw(t),this._updateMaterial();const e={vert:this.getPickingVert(),uniforms:["projViewMatrix","modelMatrix","positionMatrix",{name:"projViewModelMatrix",type:"function",fn:function(t,e){return cy([],e.projViewMatrix,e.modelMatrix)}}],extraCommandProps:{viewport:this.pickingViewport}};this.picking=[new zM(this.renderer,e,this.layer.getRenderer().pickingFBO,this.getMap())]}_updateLights(){this.setToRedraw()}getShaderConfig(){const t=this.canvas,e={x:0,y:0,width:()=>t?t.width:1,height:()=>t?t.height:1};return{extraCommandProps:{cull:{enable:()=>void 0===this.sceneConfig.cullFace||!!this.sceneConfig.cullFace,face:()=>{let t=this.sceneConfig.cullFace;return!0===t&&(t="back"),t||"back"}},stencil:{enable:!0,func:{cmp:"<=",ref:(t,e)=>e.level},op:{fail:"keep",zfail:"keep",zpass:"replace"}},depth:{enable:!0,range:this.sceneConfig.depthRange||[0,1],func:this.sceneConfig.depthFunc||"<="},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},viewport:e,polygonOffset:{enable:!0,offset:this.getPolygonOffset()}}}}_updateMaterial(){this.material&&this.material.dispose();const t=this.layer instanceof kp,e=this.getSymbols()[0].material,n={};for(const i in e)qL(e,i)&&(n[i]=e[i],"uvRotation"===i&&(n[i]=n[i]*Math.PI/180,t||(n[i]*=-1)));this.material=new $b(n)}getUniformValues(t,e){const n=t.viewMatrix,i=t.projMatrix,o=t.cameraPosition,s=this._getLightUniformValues(),a=LL({viewMatrix:n,projMatrix:i,cameraPosition:o,projViewMatrix:t.projViewMatrix},s);a.halton=e&&e.jitter?e.jitter:[0,0];const l=this.layer.getRenderer().canvas;return a.outSize=[l.width,l.height],a}getPickingVert(){return"\n            attribute vec3 aPosition;\n            uniform mat4 projViewModelMatrix;\n            uniform mat4 modelMatrix;\n            uniform mat4 positionMatrix;\n            //fbo pickingvert\n            #include <fbo_picking_vert>\n            #include <get_output>\n            void main()\n            {\n                mat4 localPositionMatrix = getPositionMatrix();\n                vec4 localPosition = getPosition(aPosition);\n\n                gl_Position = projViewModelMatrix * localPositionMatrix * localPosition;\n                //gl_Positiondepth\n                fbo_picking_setData(gl_Position.w, true);\n            }\n        "}_getLightUniformValues(){const t=this.getMap().getLightManager(),e=t&&t.getAmbientLight()||{},n=t&&t.getDirectionalLight()||{};return{ambientColor:e.color||[.2,.2,.2],light0_diffuse:[...n.color||[.1,.1,.1],1],lightSpecular:n.specular||[.8,.8,.8],light0_viewDirection:n.direction||[1,1,-1]}}};const ZB=[1,1,1];let qB=class Bs extends _F{createGeometry(t){const{data:e,indices:n}=t,i=new vb(e,n,0,{primitive:"lines"});return i.generateBuffers(this.regl),{geometry:i,symbolIndex:{index:0}}}createMesh(t,e){const{geometry:n}=t,i=new aw(n);if(i.castShadow=!1,this.sceneConfig.animation){ZB[2]=.01;const t=[];py(t,ZB),cy(t,e,t),e=t}return i.setLocalTransform(e),i.properties.symbolIndex={index:0},i}addMesh(t,e){if(!t.length)return this;let n;null!==e?(0===e&&(e=.01),n=t[0].localTransform,ZB[2]=e,py(n,ZB),cy(n,t[0].properties.tileTransform,n)):n=t[0].properties.tileTransform;for(let e=0;e<t.length;e++)t[e].setLocalTransform(n);return this.scene.addMesh(t),this}init(){const t=this.regl;this.scene=new _w,this.renderer=new cw(t);const e={x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1},n={vert:"\n    attribute vec3 aPosition;\n    attribute vec4 aColor;\n\n    uniform mat4 projViewModelMatrix;\n    uniform vec2 outSize;\n\n    varying vec4 vColor;\n\n    void main()\n    {\n        gl_Position = projViewModelMatrix * vec4(aPosition, 1.0);\n        vColor = aColor / 255.0;\n    }\n",frag:"\n    #ifdef GL_ES\n        precision lowp float;\n    #endif\n\n    uniform float opacity;\n\n    varying vec4 vColor;\n\n    void main()\n    {\n        gl_FragColor = vColor * opacity;\n    }\n",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){const n=[];return cy(n,e.projViewMatrix,e.modelMatrix),n}}],extraCommandProps:{stencil:{enable:!0,func:{cmp:"<=",ref:(t,e)=>e.level},op:{fail:"keep",zfail:"keep",zpass:"replace"}},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},viewport:e}};this.shader=new zw(n)}getUniformValues(t){const e=this.sceneConfig.opacity||.3,n=this.layer.getRenderer().canvas;return{projViewMatrix:t.projViewMatrix,outSize:[n.width,n.height],opacity:e}}};const{getPBRUniforms:XB}=xC.PBRUtils;let JB=class js extends jB{constructor(...t){super(...t),this._loader=new dw(null,this.layer.getURLModifier()),this.scene.sortFunction=this.sortByCommandKey}supportRenderMode(t){return this.getSymbols()[0].ssr?"fxaa"===t||"fxaaAfterTaa"===t:super.supportRenderMode(t)}isAnimating(){const t=this._getUVOffsetAnim();if(t&&(t[0]||t[1]))return!0}needToRedraw(){const t=this._getUVOffsetAnim();return!(!t||!t[0]&&!t[1])||super.needToRedraw()}_getUVOffsetAnim(){const t=this.getSymbols()[0];return t.material&&t.material.uvOffsetAnim}createGeometry(t){if(!t.data||!t.data.aPosition||!t.data.aPosition.length)return null;const e={uv0Attribute:"aTexCoord0"};t.data.aAltitude&&(e.altitudeAttribute="aAltitude");const n=new vb(t.data,t.indices,0,e);return LL(n.properties,t.properties),t.vertexColors&&(n.properties.vertexColors=t.vertexColors),this.material.uniforms.normalTexture&&!n.data[n.desc.tangentAttribute]&&n.data[n.desc.uv0Attribute]&&(n.data[n.desc.normalAttribute]||n.createNormal(),n.createTangent()),this._prepareFeatureIds(n,t),{geometry:n,symbolIndex:{index:0}}}paint(t){const e=!!t.shadow;t.states&&t.states.includesChanged&&(this.shader.dispose(),delete this.shader,this._updateDepthShader.dispose(),delete this._updateDepthShader,this._createShader(t));let n=!!t.ssr&&this.getSymbols()[0].ssr;const i=this.shader,o=i.shaderDefines;if(n){const e=LL({},o,t.ssr.defines);i.shaderDefines=e}if(t.onlyUpdateDepthInTaa&&(this.shader=this._updateDepthShader,!n&&this._previousSSR&&(this.shader=i,this.setToRedraw(!0))),this.updateIBLDefines(i),super.paint(t),void 0!==this.shadowCount&&e){const t=this.scene.getMeshes().length;this.shadowCount!==t&&this.setToRedraw()}this.shader=i,n&&(i.shaderDefines=o),delete this.shadowCount,this._previousSSR=n}updateSceneConfig(t){LL(this.sceneConfig,t),this.setToRedraw()}delete(){super.delete(),this.disposeIBLTextures(),this.material.dispose(),this._updateDepthShader&&(this._updateDepthShader.dispose(),delete this._updateDepthShader)}init(t){this.getMap().on("updatelights",this._onUpdatelights,this),this.createIBLTextures(),this._context=this._context||t;this.renderer=new cw(this.regl),this._bindedOnTextureLoad=this._onTextureLoad.bind(this),this._bindDisposeCachedTexture=this.disposeCachedTexture.bind(this),this._bindOnMaterialComplete=this._onMaterialComplete.bind(this),this._updateMaterial(),this._createShader(t);const e={vert:"\n                #include <gl2_vert>\n                attribute vec3 aPosition;\n                uniform mat4 projViewModelMatrix;\n                uniform mat4 positionMatrix;\n                //fbo pickingvert\n                #include <line_extrusion_vert>\n                #include <get_output>\n                #include <fbo_picking_vert>\n                void main() {\n                    mat4 localPositionMatrix = getPositionMatrix();\n                    #ifdef IS_LINE_EXTRUSION\n                        vec3 linePosition = getLineExtrudePosition(aPosition);\n                        vec4 localVertex = getPosition(linePosition);\n                    #else\n                        vec4 localVertex = getPosition(aPosition);\n                    #endif\n\n                    gl_Position = projViewModelMatrix * localPositionMatrix * localVertex;\n                    fbo_picking_setData(gl_Position.w, true);\n                }\n            ",uniforms:[{name:"projViewModelMatrix",type:"function",fn:(t,e)=>cy([],e.projViewMatrix,e.modelMatrix)}],extraCommandProps:{viewport:this.pickingViewport,depth:{enable:!0,range:this.sceneConfig.depthRange||[0,1],func:this.sceneConfig.depthFunc||"<=",mask:!!NL(this.sceneConfig.depthMask)||this.sceneConfig.depthMask}}};this.picking=[new zM(this.renderer,e,this.layer.getRenderer().pickingFBO,this.getMap())]}_createShader(t){const e={x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1},n={},i=[];i.push(...eT.getUniformDeclares()),this.fillIncludes(n,i,t);const o={cull:{enable:(t,e)=>!(e.geometryProperties.hasNegativeHeight||void 0!==this.sceneConfig.cullFace&&!this.sceneConfig.cullFace),face:()=>this.sceneConfig.cullFace||"back"},stencil:{enable:!1},viewport:e,depth:{enable:!0,range:this.sceneConfig.depthRange||[0,1],func:this.sceneConfig.depthFunc||"<="},blend:{enable:(t,e)=>void 0===e.hasAlpha||!!e.hasAlpha,func:this.getBlendFunc(),equation:"add"},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}},s={uniforms:i,defines:this._getDefines(n),extraCommandProps:o};this.shader=new xC.StandardShader(s),s.frag="\n            precision mediump float;\n            #include <gl2_frag>\n            void main() {\n                glFragColor = vec4(0.0);\n                #if __VERSION__ == 100\n                    gl_FragColor = glFragColor;\n                #endif\n            }\n        ",this._updateDepthShader=new xC.StandardShader(s)}_onTextureLoad({resources:t}){for(let e=0;e<t.length;e++)this.addCachedTexture(t[e].url,t[e].data);this.setToRedraw(!0)}_onMaterialComplete(){this.setToRedraw(!0)}_updateMaterial(t){if(t){const e=this.getSymbols()[0].material;e&&LL(e,t)}const e=this.layer instanceof kp,n=this.dataConfig,i=t||this.getSymbols()[0].material,o={};let s=!1;for(const t in i)if(qL(i,t))if(t.indexOf("Texture")>0){let e=i[t];if(!e){o[t]=void 0;continue}const a="string"==typeof e?e:e.url,l=this.getCachedTexture(a);l?l.then?a===e?e={promise:l,wrap:"repeat"}:e.promise=l:a===e?e={data:l,wrap:"repeat"}:e.data=l:a===e&&(e={url:a,wrap:"repeat"}),e.flipY=!n.upsideUpTexture,e.min="linear mipmap linear",e.mag="linear",o[t]=new Iw(e,this._loader),o[t].once("complete",this._bindedOnTextureLoad),o[t].once("disposed",this._bindDisposeCachedTexture),o[t].promise&&this.addCachedTexture(a,o[t].promise),s=!0}else o[t]=i[t],"uvRotation"===t&&(o[t]=Math.PI*o[t]/180,e||(o[t]*=-1));if(void 0===o.alphaTest&&this.getMaterialClazz&&(o.alphaTest=.05),this.material){for(let t in o)this.material.set(t,o[t]);this.setToRedraw(!0)}else this.material=new xC.StandardMaterial(o),this.material.once("complete",this._bindOnMaterialComplete);s||this._onMaterialComplete()}getShader(){return this.shader}getUniformValues(t,e){const{iblTexes:n,dfgLUT:i}=this.getIBLRes(),o=XB(t,n,i,e&&e.ssr,e&&e.jitter);return this.setIncludeUniformValues(o,e),o}_getDefines(t){return this.hasIBL()?t.HAS_IBL_LIGHTING=1:delete t.HAS_IBL_LIGHTING,t}_onUpdatelights(){if(!this.shader)return;const t=this.shader.shaderDefines;this._getDefines(t),this.shader.shaderDefines=t}};var QB="#include <gl2_vert>\n#define EXTRUDE_SCALE 63.0\n#define EXTRUDE_MOD 64.0\n#define MAX_LINE_DISTANCE 65535.0\nuniform mat4 projViewModelMatrix;\nuniform mat4 positionMatrix;\nuniform vec2 centiMeterToLocal;\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\nattribute vec4 aTubeNormal;\n#ifdef HAS_LINE_WIDTH\nattribute float aLineWidth;\n#else\nuniform float lineWidth;\n#endif\n#include <vt_position_vert>\n#ifdef PICKING_MODE\n#include <fbo_picking_vert>\n#else\nuniform mat4 modelViewMatrix;\nuniform mat3 modelNormalMatrix;\nuniform mat4 modelMatrix;\n#if defined(HAS_PATTERN)\nuniform float resolution;\nuniform float tileResolution;\nuniform float tileRatio;\nattribute float aLinesofar;\nvarying highp float vLinesofar;\nattribute vec4 aTexInfo;\nvarying vec4 vTexInfo;\nvarying float vNormalY;\nvarying float vPatternHeight;\nattribute float aNormalDistance;\n#if defined(HAS_PATTERN_ANIM)\nattribute float aLinePatternAnimSpeed;\nvarying float vLinePatternAnimSpeed;\n#endif\n#if defined(HAS_PATTERN_GAP)\nattribute float aLinePatternGap;\nvarying float vLinePatternGap;\n#endif\n#endif\n#ifdef HAS_COLOR\nattribute vec4 aColor;\nvarying vec4 vColor;\n#endif\n#ifdef HAS_OPACITY\nattribute float aOpacity;\n#endif\nvarying float vOpacity;\nvarying vec3 vModelNormal;\nvarying vec4 vViewVertex;\nvarying vec3 vModelVertex;\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_vert>\n#endif\n#include <highlight_vert>\nvoid main() {\n  \n#ifdef HAS_LINE_WIDTH\nfloat c = aLineWidth;\n#else\nfloat c = lineWidth;\n#endif\nfloat d = c / 2.;\n  vec3 e = aTubeNormal.xyz / EXTRUDE_SCALE;\n  vec3 f = unpackVTPosition();\n  vec4 h = vec4(f, 1.);\n  h.xy += e.xy * d * centiMeterToLocal;\n  h.z += e.z * d;\n  gl_Position = projViewModelMatrix * h;\n#ifdef PICKING_MODE\nfbo_picking_setData(gl_Position.w, true);\n#else\nvViewVertex = modelViewMatrix * h;\n  vec3 i = normalize(e);\n  vModelNormal = modelNormalMatrix * i;\n  vModelVertex = (modelMatrix * h).xyz;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nshadow_computeShadowPars(h);\n#endif\n#ifdef HAS_COLOR\nvColor = aColor / 255.;\n#endif\n#ifdef HAS_OPACITY\nvOpacity = aOpacity / 255.;\n#else\nvOpacity = 1.;\n#endif\n#ifdef HAS_PATTERN\nfloat j = tileResolution / resolution;\n  float k = aLinesofar - d * centiMeterToLocal.y * aNormalDistance / EXTRUDE_SCALE;\n  vLinesofar = k / tileRatio * j;\n  vTexInfo = vec4(aTexInfo.xy, aTexInfo.zw + 1.);\n  vPatternHeight = c * centiMeterToLocal.x / tileRatio * j;\n  vNormalY = aTubeNormal.w / EXTRUDE_SCALE;\n#if defined(HAS_PATTERN_ANIM)\nvLinePatternAnimSpeed = aLinePatternAnimSpeed / 127.;\n#endif\n#if defined(HAS_PATTERN_GAP)\nvLinePatternGap = aLinePatternGap / 10.0;\n#endif\n#endif\nhighlight_setVarying();\n#endif\n}";const{StyleUtil:YB}=ZR(),{getPBRUniforms:KB}=xC.PBRUtils;let $B=class Zs extends bF{needToRedraw(){return super.needToRedraw()||this.isAnimating()}isTerrainSkin(){return!1}isTerrainVector(){return!0}isUniqueStencilRefPerTile(){return!1}supportRenderMode(t){return this.isAnimating()?"fxaa"===t||"fxaaAfterTaa"===t:"taa"===t||"fxaa"===t}isAnimating(){if(this._hasPatternAnim)return!0;const t=this.getSymbols();for(let e=0;e<t.length;e++)if(t[e].linePatternFile&&t[e].linePatternAnimSpeed)return!0;return!1}isBloom(t){return!!this.getSymbol(t.properties.symbolIndex).lineBloom}createMesh(t,e){if(!t.geometry)return null;const n=this.getMap(),{geometry:i,symbolIndex:o,ref:s}=t,a=this.getSymbolDef(o);void 0===s&&LD(i,a,this.getFnTypeConfig(o),this.layer);const l=this.getSymbol(o),{tileResolution:h,tileRatio:c}=i.properties,u={tileResolution:h,tileRatio:c};BL(u,"lineColor",l,"lineColor","#fff",jL(this.colorCache)),BL(u,"linePatternGapColor",l,"linePatternGapColor",[1,1,1,1],jL(this.colorCache)),BL(u,"lineWidth",l,"lineWidth",2,(t=>YB.getTubeSizeScale(this.dataConfig.metric)*t)),BL(u,"lineOpacity",l,"lineOpacity",1),BL(u,"linePatternAnimSpeed",l,"linePatternAnimSpeed",0),BL(u,"linePatternGap",l,"linePatternGap",0),BL(u,"metallicFactor",l,"metallicFactor",0),BL(u,"roughnessFactor",l,"roughnessFactor",.4),BL(u,"emissiveFactor",l,"emissiveFactor",[0,0,0]),BL(u,"uvScale",l,"uvScale",[1,1]);const f=i.properties.iconAtlas,g=this.layer instanceof kp;f&&(u.linePatternFile=TF(this.regl,f,!1),u.atlasSize=f?[f.width,f.height]:[0,0],u.flipY=g?-1:1,this.drawDebugAtlas(f)),void 0===s&&i.generateBuffers(this.regl),u.alphaTest=-1;const A=new xC.StandardMaterial(u),m=new aw(i,A,{castShadow:!1,picking:!0}),w=n.distanceToPointAtRes(100,100,i.properties.tileResolution)._multi(c/1e4).toArray();m.setUniform("centiMeterToLocal",w);const T=n.getResolution(n.getMaxNativeZoom());m.setUniform("animSpeedScale",h/T),m.setLocalTransform(e);const M={IS_LINE_EXTRUSION:1,HAS_LAYER_OPACITY:1};return"square-tube"===this.dataConfig.type&&(M.IS_SQUARE_TUBE=1),f&&(M.HAS_PATTERN=1),m.properties.symbolIndex=o,i.data.aColor&&(M.HAS_COLOR=1),this.setMeshDefines(M,i,a),i.data.aAltitude&&(M.HAS_ALTITUDE=1),m.setDefines(M),m}setMeshDefines(t,e,n){e.data.aOpacity&&(t.HAS_OPACITY=1),e.data.aLineWidth&&(t.HAS_LINE_WIDTH=1),WD(n.linePatternAnimSpeed)&&(t.HAS_PATTERN_ANIM=1),WD(n.linePatternGap)&&(t.HAS_PATTERN_GAP=1)}paint(t){t.states&&t.states.includesChanged.shadow&&(this.shader.dispose(),this.createShader(t)),super.paint(t)}init(t){this.getMap().on("updatelights",this._onUpdatelights,this),this.createIBLTextures();if(this.renderer=new cw(this.regl),this.createShader(t),this.pickingFBO){const t=[];this.picking=[new zM(this.renderer,{vert:"#define PICKING_MODE 1\n"+QB,uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){const n=[];return cy(n,e.projViewMatrix,e.modelMatrix),n}},{name:"modelNormalMatrix",type:"function",fn:(e,n)=>Qm(t,n.modelMatrix)}],extraCommandProps:this.getExtraCommandProps()},this.pickingFBO,this.getMap())]}}createShader(t){this._context=t;const e=[],n={};this.fillIncludes(n,e,t),e.push({name:"projViewModelMatrix",type:"function",fn:function(t,e){const n=[];return cy(n,e.projViewMatrix,e.modelMatrix),n}}),this.shader=new xC.StandardShader({vert:QB,uniforms:e,defines:this._getDefines(n),extraCommandProps:this.getExtraCommandProps()})}getExtraCommandProps(){const t=this.canvas;return{viewport:{x:0,y:0,width:()=>t?t.width:1,height:()=>t?t.height:1},stencil:{enable:!0,func:{cmp:()=>"<=",ref:(t,e)=>e.level},op:{fail:"keep",zfail:"keep",zpass:"replace"}},cull:{enable:()=>!!this.sceneConfig.cullFace,face:this.sceneConfig.cullFace||"back"},depth:{enable:!0,range:this.sceneConfig.depthRange||[0,1],mask:this.sceneConfig.depthMask||!0,func:this.sceneConfig.depthFunc||"<="},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}}}getUniformValues(t,e){const{iblTexes:n,dfgLUT:i}=this.getIBLRes(),o=KB(t,n,i,null,e&&e.jitter),s=t.viewMatrix;return o.projViewMatrix=t.projViewMatrix,o.viewMatrix=s,o.resolution=t.getResolution(),o.currentTime=this.layer.getRenderer().getFrameTimestamp()||0,this.setIncludeUniformValues(o,e),o}createFnTypeConfig(t,e){const n=vk(e.lineColor),i=vk(e.aLinePatternAnimSpeed),o=vk(e.aLinePatternGap),s=this.createShapeFnTypeConfigs(t,e),a=new Int8Array(2);return[{attrName:"aColor",symbolName:"lineColor",type:Uint8Array,width:4,define:"HAS_COLOR",evaluate:(e,i)=>{let o=n(t.getZoom(),e);return mk(o)&&(o=this.evaluateInFnTypeConfig(o,i,t,e,!0)),Array.isArray(o)||(o=this.colorCache[o]=this.colorCache[o]||KE(o).unitArray()),o=GL(o),o}},{attrName:"aLinePattern",symbolName:"linePatternAnimSpeed",type:Int8Array,width:2,related:["linePatternGap"],define:"HAS_LINE_PATTERN",evaluate:(e,n,o,s)=>{let l=i(t.getZoom(),e);return NL(l)&&(l=0),0!==l&&(n.properties.hasPatternAnim=1),a[0]=l/127,a[1]=o[s+1],a}},{attrName:"aLinePattern",symbolName:"linePatternGap",type:Int8Array,width:2,related:["linePatternAnimSpeed"],define:"HAS_LINE_PATTERN",evaluate:(e,n,i,s)=>{let l=o(t.getZoom(),e);return NL(l)&&(l=0),a[1]=10*l,a[0]=i[s],a}}].concat(s)}createShapeFnTypeConfigs(t,e){const n=_k(e.lineWidth),i=_k(e.lineOpacity),o=new Uint16Array(1);return[{attrName:"aLineWidth",symbolName:"lineWidth",type:Uint8Array,width:1,define:"HAS_LINE_WIDTH",evaluate:(e,i)=>{let s=n(t.getZoom(),e);return mk(s)&&(s=this.evaluateInFnTypeConfig(s,i,t,e)),o[0]=Math.round(2*s),o[0]}},{attrName:"aOpacity",symbolName:"lineOpacity",type:Uint8Array,width:1,define:"HAS_OPACITY",evaluate:(e,n)=>{let s=i(t.getZoom(),e);return mk(s)&&(s=this.evaluateInFnTypeConfig(s,n,t,e)),o[0]=255*s,o[0]}}]}_getDefines(t){return this.hasIBL()?t.HAS_IBL_LIGHTING=1:delete t.HAS_IBL_LIGHTING,t}_onUpdatelights(){if(!this.shader)return;const t=this.shader.shaderDefines;this._getDefines(t),this.shader.shaderDefines=t}delete(){super.delete(),this.disposeIBLTextures(),this.shader&&(this.shader.dispose(),delete this.shader)}};const{PackUtil:tz}=ZR(),ez=[],nz=[],iz=[],rz=[],oz=[],sz=[],az=[],lz=[0,0,0],hz=[0,0,0],cz=[1,1,1],uz=[],fz=[1,1,1,1],dz=[],gz=[1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1],pz=t=>class extends t{constructor(t,e,n,i,o,s){super(t,e,n,i,o,s),this._ready=!1,this.scene.sortFunction=this.sortByCommandKey;const a=i.fetchOptions||{};a.referrer=window&&window.location.href,this._gltfManager=t.gltfManager=t.gltfManager||new tM(t,{fetchOptions:a,urlModifier:t=>{const n=e.getURLModifier();return n&&n(t)||t}}),this._initTRSFuncType(),this._initGLTF()}isUniqueStencilRefPerTile(){return!1}isAnimating(){const t=this.getSymbols();for(let e=0;e<t.length;e++)if(t[e]&&this._gltfPack[e]&&this._isSkinAnimating(e))return!0;return!1}createGeometry(t,e){const{data:n,positionSize:i}=t;return{geometry:{properties:LL({},t.properties),data:n,positionSize:i,features:e},symbolIndex:t.symbolIndex}}getFnTypeConfig(){return uz}createMesh(t,e,{tileTranslationMatrix:n,tileExtent:i,tilePoint:o},{timestamp:s}){if(!this._ready)return null;const a=this.getMap(),{geometry:l}=t,{positionSize:h,features:c}=l;if(!l.data.aPosition||0===l.data.aPosition.length)return null;"native-line"===this.dataConfig.type&&this._arrangeAlongLine(0,l,o);const{aPosition:u}=l.data;let f=u.length/h;const g={instance_vectorA:new Float32Array(4*f),instance_vectorB:new Float32Array(4*f),instance_vectorC:new Float32Array(4*f),aPickingId:[]},A=this._updateInstanceData(g,n,i,l.properties.z,l.data,h,c);l.data.aTerrainAltitude&&(g.aTerrainAltitude=l.data.aTerrainAltitude);const m={},w=g.aPickingId,T=function(t){const e=new Map;for(let n=0;n<t.length;n++){const i=t[n];let o=e.get(i);o||(o=[],e.set(i,o)),o.push(n)}return e}(w);for(const t in g)m[t]={buffer:this.regl.buffer({dimension:g[t].length/f,data:g[t]}),divisor:1};const M=this._hasFuncType(),C=this._getMeterScale(),P=ay([]);fy(P,P,[C,C,C]);const I=[],O=this.getSymbols();for(let t=0;t<O.length;t++){const e=O[t],i=this._gltfMeshInfos[t];if(!i)continue;const o=this._gltfPack[t][0],{fixSizeOnZoom:h}=e;let c=ay([]);M||(c=this._getSymbolTRSMatrix(c));let u=0;i.forEach((t=>{const{geometry:n,nodeMatrix:i}=t;cy(dz,gz,i),cy(dz,c,dz);const o=cy(dz,P,dz),s=n.boundingBox.copy();s.transform(o);const a=this._calAnchorTranslation(s,e);Math.abs(a)>Math.abs(u)&&(u=a)}));const C=[0,0,u],E=i.map(((i,M)=>{const{geometry:I,materialInfo:O,morphWeights:E,extraInfo:D,nodeIndex:N}=i;e.alphaTest&&(O.alphaTest=e.alphaTest);const H=new(this.getMaterialClazz(O))(O),U={},W=new lw(m,f,I,H,{transparent:!1,picking:!0});if(o.hasSkinAnimation()){const e=this._updateAnimation(W,t,0)[N];W.setUniform("jointTexture",e.jointTexture),W.setUniform("jointTextureSize",e.jointTextureSize),W.setUniform("numJoints",e.numJoints),W.setUniform("skinAnimation",+this._isSkinAnimating(t)),W.properties.startTime=s,U.HAS_SKIN=1}E&&(W.setUniform("morphWeights",E),U.HAS_MORPH=1),W.setUniform("hasAlpha",D.alphaMode&&"BLEND"===D.alphaMode.toUpperCase()),BL(W.uniforms,"polygonFill",e,"markerFill",fz,jL(this.colorCache)),BL(W.uniforms,"polygonOpacity",e,"markerOpacity",1);const q=[];W.setPositionMatrix((()=>{const e=this._getMeshNodeMatrix(t,M,N);cy(q,gz,e),cy(q,c,q),cy(q,P,q);const n=ay(dz);if(0!==u&&(gy(n,C),cy(q,n,q)),WL(h)){const t=a.getGLScale()/a.getGLScale(h);return Fy(ez,t,t,t),py(n,ez),cy(n,n,q)}return q}));const X=this.layer.getRenderer().getZScale(),J=[],Q=[];return W.setLocalTransform((()=>{const t=this.layer.options.altitude||0;return Dy(Q,A),Q[2]+=100*t*X,uy(J,n,Q),J})),I.generateBuffers(this.regl,{excludeElementsInVAO:!0}),g.instance_color&&(U.HAS_INSTANCE_COLOR=1),g.aTerrainAltitude&&(U.HAS_INSTANCE_TERRAIN_ALTITUDE=1,W.setUniform("terrainAltitudeScale",100*this.layer.getRenderer().getZScale())),U.HAS_LAYER_OPACITY=1,LL(W.properties,l.properties),W.properties.aPickingId=w,W.properties.nodeIndex=N,W.properties.pickingIdIndiceMap=T,W.setDefines(U),W.properties.symbolIndex={index:t},W}));I.push(...E)}return I.insContext={instanceData:g,tileTranslationMatrix:n,tileExtent:i,aPosition:u,positionSize:h},I}_arrangeAlongLine(t,e){const{tileExtent:n,z:i}=e.properties,{data:o,positionSize:s}=e;let a=this._calGLTFScale(t);a=Gy([],a,this._getMeterScale());const l={gapLength:this.dataConfig.gapLength||0,direction:this.dataConfig.direction||0,scaleVertex:!0},h=this._gltfPack[0][0],{aPosition:c,aAltitude:u,aPickingId:f}=o,g=new gh(0,0,0),A=new gh(0,0,0),m=[],w=u?[]:m,T=[],M=[],C=[],P=[],I=[],O=[],E=this.layer.getTileSize().width/n*this.layer.getRenderer().getTileGLScale(i),D=this.layer.getRenderer().getZScale();let N=f[0];for(let t=0;t<c.length-s;t+=s){const e=f[t/s+1];if(e!==N){N=e;continue}u?Fy(I,c[t],c[t+1],u[t/s]):tz.unpackPosition(I,c[t],c[t+1],c[t+2]);const[n,i,o]=I;let H=t+s;u?Fy(O,c[H],c[H+1],u[H/s]):tz.unpackPosition(O,c[H],c[H+1],c[H+2]);const[U,W,q]=O,X=f[t/s],J=g.set(n*E,i*E,o*D),Q=A.set(U*E,W*E,q*D),Y=J.distanceTo(Q),K=h.arrangeAlongLine(J,Q,Y,a,1,l);for(let t=0;t<K.length;t++){const e=K[t];g.set(n,i,o),A.set(U,W,q);const s=Az(g,A,e.t);m.push(s.x,s.y),w.push(s.z),T.push(X),M.push(-e.rotationZ*Math.PI/180),C.push(e.rotationXY*Math.PI/180),P.push(...e.scale)}}e.data={aPosition:new c.constructor(m),aPickingId:new f.constructor(T),aZRotation:M,aXYRotation:C,aScaleXYZ:P},u&&(e.data.aAltitude=new u.constructor(w))}_calGLTFScale(t){const e=this.getSymbols()[t],n=[1,1,1],i=e.modelHeight;return i&&this._gltfPack[t][0].calModelHeightScale(n,i),Fy(oz,e.scaleX||1,e.scaleY||1,e.scaleZ||1),By(n,n,oz)}_getMeshNodeMatrix(t,e,n){const i=this._gltfMeshInfos[t][e];return this._isSkinAnimating(t)&&this._nodeMatrixMap&&this._nodeMatrixMap[n]||i.nodeMatrix}_updateAnimation(t,e,n){if(!this._gltfPack)return;const i=this._gltfPack[e][0];this._skinMap||(this._skinMap={}),this._nodeMatrixMap={},this._skinMap[t.uuid]||(this._skinMap[t.uuid]={});const o=this.getSymbols()[e],s=this._gltfJSON[e],{loop:a,speed:l,animationName:h}=o;return i.updateAnimation(n,a||!1,l||1,h||s.animations[0].name,t.properties.startTime||0,this._nodeMatrixMap,this._skinMap[t.uuid]),this._skinMap[t.uuid]}_calAnchorTranslation(t,e){const n=e.anchorZ||"center";let i=0;const o=t.max[2]-t.min[2];return"bottom"===n?i=o/2:"top"===n&&(i=-o/2),i}addMesh(t,e,n){if(!t)return null;if(t[0].properties.level>2)return null;const i=n.timestamp;for(let e=0;e<t.length;e++){if(!t[e]||!t[e].geometry)continue;t[e].instancedData.aTerrainAltitude&&this._updateTerrainAltitude(t[e],t[e].instancedData,t[e].properties,3,n);const o=t[e].properties.symbolIndex.index,s=this._isSkinAnimating(o);s&&this._updateAnimation(t[e],o,i),t[e].setUniform("skinAnimation",+s),this._highlightMesh(t[e])}return this.scene.addMesh(t),this}_updateATerrainAltitude(t,e){t&&t.updateInstancedData&&t.updateInstancedData("aTerrainAltitude",e)}prepareRender(t){const e=this.getSymbols();let n=!1;for(let t=0;t<e.length;t++)if(e[t]&&this._gltfPack[t]&&this._isSkinAnimating(t)&&this._gltfPack[t]&&!n){n=!0;break}n&&this.setToRedraw(!0),super.prepareRender(t)}getShadowMeshes(){return this.isVisible()?(this.shadowCount=this.scene.getMeshes().length,this.scene.getMeshes().filter((t=>0===t.properties.level))):uz}_isSkinAnimating(t){const e=this.getSymbols()[t];return!!(e&&e.animation&&this._gltfPack[t]&&this._gltfPack[t][0]&&this._gltfPack[t][0].hasSkinAnimation())}_updateInstanceData(t,e,n,i,o,s,a){function l(e,n,i,o){t[e][4*n]=i[o],t[e][4*n+1]=i[o+4],t[e][4*n+2]=i[o+8],t[e][4*n+3]=i[o+12]}const{aPosition:h,aPickingId:c,aXYRotation:u,aZRotation:f,aAltitude:g,aScaleXYZ:A}=o,m=h.length/s,w=this.layer.getTileSize().width/n*this.layer.getRenderer().getTileGLScale(i),T=this.layer.getRenderer().getZScale(),M=100*(this.dataConfig.altitudeOffset||0);let C=1/0,P=1/0,I=1/0,O=-1/0,E=-1/0,D=-1/0;const N=[],H=[];for(let t=0;t<m;t++){g?Fy(H,h[t*s],h[t*s+1],g[t]):tz.unpackPosition(H,h[t*s],h[t*s+1],h[t*s+2]);const e=Fy(N,H[0]*w,-H[1]*w,(H[2]+M)*T);e[0]<C&&(C=e[0]),e[0]>O&&(O=e[0]),e[1]<P&&(P=e[1]),e[1]>E&&(E=e[1]),e[2]<I&&(I=e[2]),e[2]>D&&(D=e[2])}const U=(C+O)/2,W=(P+E)/2,q=(I+D)/2,X=[],J=this._hasFuncType(),Q=[0,0,1],Y=[0,0,0];for(let e=0;e<m;e++){g?Fy(H,h[e*s],h[e*s+1],g[e]):tz.unpackPosition(H,h[e*s],h[e*s+1],h[e*s+2]);const n=Fy(N,H[0]*w-U,-H[1]*w-W,(H[2]+M)*T-q),i=Fy(oz,1,1,1);A&&(Fy(i,A[3*e],A[3*e+1],A[3*e+2]),py(sz,i));const o=u&&u[e]||0,m=f&&f[e]||0;if(o||m){Ay(X,m,Q);const t=Fy(ez,Math.cos(m),Math.sin(m),0);dy(X,X,o,Qy(t,t,Y,90*Math.PI/180)),A&&cy(X,X,sz);cy(X,gy(dz,n),X)}else gy(X,n),A&&cy(X,X,sz);if(J){cy(X,X,this._getSymbolTRSMatrix(dz,a,c,e))}l("instance_vectorA",e,X,0),l("instance_vectorB",e,X,1),l("instance_vectorC",e,X,2),t.aPickingId[e]=c[e]}return Fy(N,U,W,q),N}_getMeterScale(){if(!this._meterScale){const t=this.getMap();this._meterScale=100*oL(t.getGLRes(),t)}return this._meterScale}_getSymbolTRSMatrix(t,e,n,i){const o=this.getMap(),s=this.symbolDef[0],a=this._getMeterScale();let l=s.translationX||0,h=s.translationY||0,c=s.translationZ||0,u=s.rotationX||0,f=s.rotationY||0,g=s.rotationZ||0,A=s.scaleX||1,m=s.scaleY||1,w=s.scaleZ||1;const T=e&&e[n&&n[i]],M=o.getZoom(),C=T&&T.feature&&T.feature.properties,P=this._getModelHeightScale(M,C);this._txFn&&(l=this._txFn(M,C)),this._tyFn&&(h=this._tyFn(M,C)),this._tzFn&&(c=this._tzFn(M,C));const I=Fy(nz,l*a,h*a,c*a);this._rxFn&&(u=this._rxFn(M,C)),this._ryFn&&(f=this._ryFn(M,C)),this._rzFn&&(g=this._rzFn(M,C));const O=Fy(iz,u,f,g);this._sxFn&&(A=this._sxFn(M,C)),this._syFn&&(m=this._syFn(M,C)),this._szFn&&(w=this._szFn(M,C));const E=Fy(rz,A*P,m*P,w*P);return this._getGLTFMatrix(t,I,O,E)}_getModelHeightScale(t,e){const n=this.symbolDef[0];let i=this._modelHeightFn?this._modelHeightFn(t,e):n.modelHeight;if(eL(i))return 1;const o=this._gltfBBox[0];return i/Math.abs(o.max[1]-o.min[1])}getShaderConfig(){const t=super.getShaderConfig();return t.positionAttribute="POSITION",t.normalAttribute="NORMAL",t}init(t){super.init(t),this._initGLTF()}_initTRSFuncType(){const t=this.symbolDef[0];mk(t.modelHeight)&&(this._modelHeightFn=_k(t.modelHeight)),mk(t.translationX)&&(this._txFn=_k(t.translationX)),mk(t.translationY)&&(this._tyFn=_k(t.translationY)),mk(t.translationZ)&&(this._tzFn=_k(t.translationZ)),mk(t.rotationX)&&(this._rxFn=_k(t.rotationX)),mk(t.rotationY)&&(this._ryFn=_k(t.rotationY)),mk(t.rotationZ)&&(this._rzFn=_k(t.rotationZ)),mk(t.scaleX)&&(this._sxFn=_k(t.scaleX)),mk(t.scaleY)&&(this._syFn=_k(t.scaleY)),mk(t.scaleZ)&&(this._szFn=_k(t.scaleZ))}_hasFuncType(){return!!(this._modelHeightFn&&!this._modelHeightFn.isFeatureConstant||this._txFn&&!this._txFn.isFeatureConstant||this._tyFn&&!this._tyFn.isFeatureConstant||this._tzFn&&!this._tzFn.isFeatureConstant||this._rxFn&&!this._rxFn.isFeatureConstant||this._ryFn&&!this._ryFn.isFeatureConstant||this._rzFn&&!this._rzFn.isFeatureConstant||this._sxFn&&!this._sxFn.isFeatureConstant||this._syFn&&!this._syFn.isFeatureConstant||this._szFn&&!this._szFn.isFeatureConstant)}_initGLTF(){if(this._gltfPack)return;this._gltfPack=[],this._gltfJSON=[],this._gltfBBox=[],this._gltfMeshInfos=[];const t=this.getSymbols();this._loaded=0;for(let e=0;e<t.length;e++){const n=t[e].url||"pyramid";this._gltfManager.loginGLTF(n);const i=this._gltfManager.getGLTF(n);if(i.then)i.then((n=>{if(!n.gltfPack)return this._loaded++,void(this._loaded>=t.length&&(this._ready=!0,this.setToRedraw(!0)));const{gltfPack:i,json:o,bbox:s}=n;this._gltfPack[e]=[i],this._gltfMeshInfos[e]=i.getMeshesInfo(),this._gltfJSON[e]=o,this._gltfBBox[e]=s,this._loaded++,this._loaded>=t.length&&(this._ready=!0),this.setToRedraw(!0)}));else{const{gltfPack:t,json:n,bbox:o}=i;t&&(this._gltfPack[e]=[t],this._gltfMeshInfos[e]=t.getMeshesInfo(),this._gltfJSON[e]=n,this._gltfBBox[e]=o,this._loaded++)}}this._loaded>=t.length&&(this._ready=!0)}getPickingVert(){return"\n    attribute vec3 aPosition;\n    uniform mat4 projViewModelMatrix;\n    uniform mat4 modelMatrix;\n    uniform mat4 positionMatrix;\n    //fbo pickingvert\n    #include <fbo_picking_vert>\n    #include <get_output>\n    void main()\n    {\n        mat4 localPositionMatrix = getPositionMatrix();\n        vec4 localPosition = getPosition(aPosition);\n\n        gl_Position = projViewModelMatrix * localPositionMatrix * localPosition;\n        //gl_Positiondepth\n        fbo_picking_setData(gl_Position.w, true);\n    }"}deleteMesh(t){if(t){this.scene.removeMesh(t);for(let e=0;e<t.length;e++){const n=this._skinMap&&this._skinMap[t[e].uuid];if(n){for(const t in n)n[t].jointTexture&&n[t].jointTexture.destroy();delete this._skinMap[t[e].uuid]}t[e].disposeInstancedData(),t[e].dispose()}}}delete(){super.delete();const t=this.getSymbols();for(let e=0;e<t.length;e++){this._gltfManager.logoutGLTF(t[e].url||"pyramid")}if(this._skinMap){for(const t in this._skinMap){const e=this._skinMap[t];for(const t in e)e[t].jointTexture&&e[t].jointTexture.destroy()}delete this._skinMap}delete this._nodeMatrixMap}_getGLTFMatrix(t,e,n,i){const o=Fy(ez,...e||lz),s=n||hz,a=i||cz;return xy(t,Q_(az,s[0],s[1],s[2]),o,a)}shouldDrawParentTile(){return!1}};function Az(t,e,n){const i=mz(t.x,e.x,n),o=mz(t.y,e.y,n),s=mz(t.z||0,e.z||0,n);return new t.constructor(i,o,s)}function mz(t,e,n){return t+n*(e-t)}class po extends(pz(WB)){getMaterialClazz(t){return t.diffuseFactor?rw:$b}}class go extends(pz(JB)){getMaterialClazz(t){return t.specularGlossinessTexture||t.diffuseTexture?xC.StandardSpecularGlossinessMaterial:xC.StandardMaterial}}const{getPBRUniforms:yz}=xC.PBRUtils,_z={color:[2.0303,2.028,2.028],direction:[0,-.2717,-1]},vz=.3737,xz={index:0},bz=[0,0,0],wz=[2,2];class Ao extends bF{supportRenderMode(t){return"fxaa"===t||"fxaaBeforeTaa"===t}needPolygonOffset(){return!0}isTerrainSkin(){return!1}isTerrainVector(){return!0}needToRedraw(){return!!super.needToRedraw()||this.getSymbol(xz).animation}createMesh(t,e){const{geometry:n}=t;n.generateBuffers(this.regl);const i=new aw(n,null,{castShadow:!1,picking:!0});return i.properties.symbolIndex=xz,i.setLocalTransform(e),i}callShader(t,e){super.callShader(t,e),this.transformWater();const n=this._getWaterUniform(this.getMap(),e);this._drawCount+=this.renderer.render(this._waterShader,n,this._waterScene,this.getRenderFBO(e))}addMesh(t,e){this._prepareMesh(t,e),super.addMesh(...arguments)}_prepareMesh(t){const e=this.getSymbol(xz).ssr;for(let n=0;n<t.length;n++)t[n].ssr=e?1:0}paint(t){t.states&&t.states.includesChanged&&(this.shader.dispose(),this._waterShader.dispose(),this._createShader(t));const e=!!t.ssr&&this.getSymbol(xz).ssr,n=this._waterShader,i=n.shaderDefines;if(e){const e=LL({},i,t.ssr.defines);n.shaderDefines=e}this.updateIBLDefines(n),this._water.ssr=e?1:0,super.paint(t),e&&(n.shaderDefines=i)}isEnableTileStencil(){return!1}init(t){this.createIBLTextures();this.renderer=new cw(this.regl),this.createGround(),this._createShader(t),this.pickingFBO&&(this.picking=[new zM(this.renderer,{vert:wF,uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){const n=[];return cy(n,e.projViewMatrix,e.modelMatrix),n}}],extraCommandProps:{viewport:this.pickingViewport}},this.pickingFBO,this.getMap())]),this._loadTextures()}_loadTextures(){const t=this.regl;this._emptyTex||(this._emptyTex=t.texture(2));const e=this.layer.getURLModifier(),n=this.getSymbol({index:0}),i=n.texWaveNormal,o=this.getCachedTexture(i),s=this;if(o)this._normalTex||(o.isLoading?setTimeout((()=>{this.shader&&this._loadTextures()}),20):this._normalTex=this._createTex(t,o));else{const n=new Image;n.isLoading=!0,n.onload=function(){delete this.isLoading,s._normalTex=s._createTex(t,this),s.setToRedraw()},n.onerror=()=>{console.error("invalid water wave normal texture:"+i)},this.addCachedTexture(i,n),n.src=e&&e(i)||i}const a=n.texWavePerturbation,l=this.getCachedTexture(a);if(l)this._pertTex||(l.isLoading?setTimeout((()=>{this._loadTextures()}),20):this._pertTex=this._createTex(t,l));else{const n=new Image;n.isLoading=!0,n.onload=function(){delete this.isLoading,s._pertTex=s._createTex(t,this),s.setToRedraw()},n.onerror=()=>{console.error("invalid water wave perturbation texture:"+a)},this.addCachedTexture(a,n),n.src=e&&e(a)||a}}_createTex(t,e){return this._emptyTex?t.texture({width:e.width,height:e.height,mag:"linear",min:"linear mipmap linear",wrapS:"repeat",wrapT:"repeat",flipY:!0,data:e}):null}_createShader(t){const e=this.canvas,n=[],i=[{name:"projViewModelMatrix",type:"function",fn:function(t,e){const n=[];return cy(n,e.projViewMatrix,e.modelMatrix),n}},{name:"modelViewNormalMatrix",type:"function",fn:(t,e)=>{const n=cy([],e.viewMatrix,e.modelMatrix),i=hy(n,n);return Qm([],ly(i,i))}},{name:"modelViewMatrix",type:"function",fn:(t,e)=>cy([],e.viewMatrix,e.modelMatrix)},{name:"environmentTransform",type:"function",fn:(t,e)=>ey(n,Math.PI*(e.environmentOrientation||0)/180)}],o={TIME_NOISE_TEXTURE_REPEAT:vz};this.fillIncludes(o,i,t);const s={x:0,y:0,width:()=>e?e.width:1,height:()=>e?e.height:1};this.shader=new zw({vert:"\n                attribute vec3 aPosition;\n\n                uniform mat4 projViewModelMatrix;\n                uniform float minAltitude;\n\n                void main() {\n                    vec3 position = aPosition;\n                    position.z += minAltitude * 100.0;\n                    gl_Position = projViewModelMatrix * vec4(position, 1.);\n                }\n            ",frag:"\n    #define SHADER_NAME WATER_STENCIL\n    precision mediump float;\n    void main() {\n        gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);\n    }\n",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){const n=[];return cy(n,e.projViewMatrix,e.modelMatrix),n}}],extraCommandProps:{viewport:s,colorMask:[!1,!1,!1,!1],stencil:{enable:!0,mask:255,func:{cmp:"<=",ref:254,mask:255},op:{fail:"keep",zfail:"keep",zpass:"replace"}},depth:{enable:!0,range:this.sceneConfig.depthRange||[0,1],func:this.sceneConfig.depthFunc||"<="},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}}});const a={viewport:s,stencil:{enable:!0,mask:255,func:{cmp:"==",ref:254,mask:255},op:{fail:"keep",zfail:"keep",zpass:"replace"}},depth:{enable:!1}};i.push(...eT.getUniformDeclares()),this._waterShader=new zw({vert:"#define SHADER_NAME WATER\nuniform mat4 modelMatrix;\nuniform mat4 projViewModelMatrix;\nattribute vec3 aPosition;\nattribute vec2 aTexCoord;\nuniform vec2 uvOffset;\nuniform vec2 noiseUvOffset;\nuniform vec2 uvScale;\nvarying vec2 vUv;\nvarying vec2 vNoiseUv;\nvarying vec3 vPos;\nvarying mat3 vTbnMatrix;\n#ifdef HAS_SSR\nuniform mat4 modelViewMatrix;\nvarying vec4 vViewVertex;\n#endif\n#include <highlight_vert>\nmat3 c(in vec3 d) {\n  vec3 t = normalize(cross(d, vec3(.0, 1., .0)));\n  vec3 e = normalize(cross(d, t));\n  return mat3(t, e, d);\n}\n#if defined(HAS_SHADOWING)\n#include <vsm_shadow_vert>\n#endif\nconst vec3 f = vec3(0., 0., 1.);\nvoid main(void) {\n  vec4 h = vec4(aPosition, 1.);\n  vec4 i = modelMatrix * h;\n  vPos = i.xyz;\n  vTbnMatrix = c(f);\n  gl_Position = projViewModelMatrix * h;\n  vUv = aTexCoord * uvScale + uvOffset;\n  vNoiseUv = aTexCoord * uvScale * TIME_NOISE_TEXTURE_REPEAT + noiseUvOffset;\n#ifdef HAS_SSR\nvec4 j = modelViewMatrix * h;\n  vViewVertex = j;\n#endif\n#if defined(HAS_SHADOWING)\nshadow_computeShadowPars(h);\n#endif\nhighlight_setVarying();\n}",frag:"#define SHADER_NAME WATER\nprecision highp float;\nprecision highp sampler2D;\n#include <hsv_frag>\nuniform vec3 hsv;\nuniform float contrast;\nuniform float layerOpacity;\n#if defined(HAS_SHADOWING)\n#include <vsm_shadow_frag>\n#endif\n#include <highlight_frag>\n#if defined(HAS_IBL_LIGHTING)\nuniform vec3 hdrHSV;\nuniform samplerCube prefilterMap;\nuniform sampler2D brdfLUT;\nuniform mat3 environmentTransform;\nuniform vec3 diffuseSPH[9];\nvec3 c(const in vec3 d) {\n  vec3 e = environmentTransform * d;\n  float x = e.x;\n  float y = e.y;\n  float z = e.z;\n  vec3 f = (diffuseSPH[0] + diffuseSPH[1] * x + diffuseSPH[2] * y + diffuseSPH[3] * z + diffuseSPH[4] * z * x + diffuseSPH[5] * y * z + diffuseSPH[6] * y * x + diffuseSPH[7] * (3. * z * z - 1.) + diffuseSPH[8] * (x * x - y * y));\n  if(length(hdrHSV) > .0) {\n    f = hsv_apply(f, hdrHSV);\n  }\n  return max(f, vec3(.0));\n}\nvec3 h(const in vec3 i, const in float j, const in float k, const in float l) {\n  vec4 rgba = texture2D(brdfLUT, vec2(k, j));\n  float b = (rgba[3] * 65280.0 + rgba[2] * 255.);\n  float a = (rgba[1] * 65280.0 + rgba[0] * 255.);\n  const float m = 1. / 65535.;\n  return (i * a + b * l) * m;\n}\n#else\nuniform vec3 ambientColor;\n#endif\nstruct PBRShadingWater {\n  float NdotL;\n  float NdotV;\n  float NdotH;\n  float VdotH;\n  float LdotH;\n  float VdotN;\n};\nvec3 o(const in vec4 u, const in float v) {\n  if(v <= .0)\n    return u.rgb;\n  return v * u.rgb * u.a;\n}\n#ifdef HAS_SSR\nvarying vec4 vViewVertex;\nuniform mat3 modelViewNormalMatrix;\nuniform sampler2D TextureDepth;\nuniform highp vec2 outSize;\nuniform float ssrFactor;\nuniform float ssrQuality;\nuniform sampler2D TextureReflected;\nuniform highp mat4 projMatrix;\nuniform mat4 invProjMatrix;\nuniform vec4 outputFovInfo[2];\nuniform mat4 reprojViewProjMatrix;\nuniform vec2 cameraNearFar;\nfloat A(const in vec4 B) {\n  return B.r + B.g / 255.;\n}\nfloat C(const in vec2 D, const in float E) {\n  vec3 F = vec3(.06711056, .00583715, 52.9829189);\n  return fract(F.z * fract(dot(D.xy + E * vec2(47., 17.) * .695, F.xy))) * .5;\n}\nvec3 G(const in float H, const in float I, const in vec2 J) {\n  float K = min(I - .01, H);\n  float L = floor(K);\n  float M = min(I, L + 1.);\n  float N = pow(2., M);\n  vec2 O = 2. * N / J;\n  if(K - L > .5)\n    N *= 2.;\n  return vec3(O, N);\n}\nvec2 P(const in vec2 Q, const in vec3 R) {\n  vec2 S = max(R.xy, min(1. - R.xy, Q));\n  return vec2(2. * S.x, R.z - 1. - S.y) / R.z;\n}\nvec3 T(const in mat4 U, const in vec3 V) {\n  vec4 W = U * vec4(V, 1.);\n  return vec3(.5 + .5 * W.xy / W.w, W.w);\n}\nvec3 X(const in float Y, const in vec2 S) {\n  return texture2D(TextureReflected, S).rgb;\n}\nfloat Z(float ba) {\n  highp mat4 U = projMatrix;\n  highp float z = ba * 2. - 1.;\n  return -U[3].z / (z + U[2].z);\n}\nfloat bb(const vec2 S) {\n  float ba = A(texture2D(TextureDepth, S));\n  return ba;\n}\nvec3 bc(const in float E, const in vec3 bd, const in vec3 be, const in vec3 bf, const in vec3 bg, const in float bh) {\n  vec2 bi;\n  bi.x = C(gl_FragCoord.yx, E);\n  bi.y = fract(bi.x * 52.9829189);\n  bi.y = mix(bi.y, 1., .7);\n  float bj = 2. * 3.14159 * bi.x;\n  float bk = pow(max(bi.y, .000001), bh / (2. - bh));\n  float bl = sqrt(1. - bk * bk);\n  vec3 bm = vec3(bl * cos(bj), bl * sin(bj), bk);\n  bm = bm.x * bd + bm.y * be + bm.z * bf;\n  return normalize((2. * dot(bg, bm)) * bm - bg);\n}\nfloat bn(const in float E) {\n  return (C(gl_FragCoord.xy, E) - .5);\n}\nvec3 bo(const in vec3 bp, const in float bq, const in vec3 br) {\n  vec3 bs = T(projMatrix, vViewVertex.xyz + br * bq);\n  bs.z = 1. / bs.z;\n  bs -= bp;\n  float bt = min(1., .99 * (1. - bp.x) / max(1e-5, bs.x));\n  float bu = min(1., .99 * (1. - bp.y) / max(1e-5, bs.y));\n  float bv = min(1., .99 * bp.x / max(1e-5, -bs.x));\n  float bw = min(1., .99 * bp.y / max(1e-5, -bs.y));\n  return bs * min(bt, bu) * min(bv, bw);\n}\nfloat bx(const in vec3 bp, const in vec3 bs, inout float by, inout float bz) {\n  float bA = (bz + by) * .5;\n  vec3 bB = bp + bs * bA;\n  float z = bb(bB.xy);\n  float ba = Z(z);\n  float bC = -1. / bB.z;\n  by = ba > bC ? by : bA;\n  bz = ba > bC ? bA : bz;\n  return bA;\n}\nvec4 bD(const in vec3 bp, const in float bq, in float bE, const in vec3 br, const in float j, const in float E) {\n  const int bF = 20;\n  float bG = 1. / float(bF);\n  bE *= bG;\n  vec3 bs = bo(bp, bq, br);\n  float bH = bG;\n  vec3 bI = vec3(.0, bH, 1.);\n  vec3 bB;\n  float z, ba, bC, bJ, bK, bL;\n  bool bM;\n  float bN = 1.;\n  float bA;\n  for(int bO = 0; bO < bF; bO++) {\n    bB = bp + bs * bI.y;\n    z = bb(bB.xy);\n    ba = Z(z);\n    bC = -1. / bB.z;\n    bJ = bC - ba;\n    bJ *= clamp(sign(abs(bJ) - bq * bG * bG), .0, 1.);\n    bM = abs(bJ + bE) < bE;\n    bK = clamp(bI.x / (bI.x - bJ), .0, 1.);\n    bL = bM ? bI.y + bK * bG - bG : 1.;\n    bI.z = min(bI.z, bL);\n    bI.x = bJ;\n    if(bM) {\n      float by = bI.y - bG;\n      float bz = bI.y;\n      bA = bx(bp, bs, by, bz);\n      bA = bx(bp, bs, by, bz);\n      bA = bx(bp, bs, by, bz);\n      bN = bA;\n      break;\n    }\n    bI.y += bG;\n  }\n  return vec4(bp + bs * bN, 1. - bN);\n}\nvec3 bP(in vec4 bQ, const in float bR, const in vec3 bS, const in vec3 bT, const in float j) {\n  vec4 bU = mix(outputFovInfo[0], outputFovInfo[1], bQ.x);\n  bQ.xyz = vec3(mix(bU.xy, bU.zw, bQ.y), 1.) * -1. / bQ.z;\n  bQ.xyz = (reprojViewProjMatrix * vec4(bQ.xyz, 1.)).xyw;\n  bQ.xy /= bQ.z;\n  float bV = clamp(6. - 6. * max(abs(bQ.x), abs(bQ.y)), .0, 1.);\n  bQ.xy = .5 + .5 * bQ.xy;\n  return vec3(bQ.xy, 1.);\n}\nvec3 ssr(const in vec3 bS, const in vec3 bT, const in float j, const in vec3 d, const in vec3 bg) {\n  float bW = .0;\n  vec4 f = vec4(.0);\n  float bh = j * j;\n  bh = bh * bh;\n  vec3 bX = abs(d.z) < .999 ? vec3(.0, .0, 1.) : vec3(1., .0, .0);\n  vec3 bd = normalize(cross(bX, d));\n  vec3 be = cross(d, bd);\n  float bR = ssrFactor * clamp(-4. * dot(bg, d) + 3.8, .0, 1.);\n  bR *= clamp(4.7 - j * 5., .0, 1.);\n  vec3 bp = T(projMatrix, vViewVertex.xyz);\n  bp.z = 1. / bp.z;\n  vec3 br = bc(bW, bd, be, d, bg, bh);\n  float bq = mix(cameraNearFar.y + vViewVertex.z, -vViewVertex.z - cameraNearFar.x, br.z * .5 + .5);\n  float bE = .5 * bq;\n  vec4 bQ;\n  if(dot(br, d) > .001 && bR > .0) {\n    bQ = bD(bp, bq, bE, br, j, bW);\n    if(bQ.w > .0)\n      return bP(bQ, bR, bS, bT, j);\n    \n  }\n  return vec3(.0);\n}\n#endif\nconst vec3 bY = vec3(0., 0., 1.);\nuniform mat4 viewMatrix;\nuniform sampler2D normalTexture;\nuniform sampler2D heightTexture;\nuniform vec4 waveParams;\nuniform vec2 waterDir;\nuniform vec4 waterBaseColor;\nuniform vec3 lightDirection;\nuniform vec3 lightColor;\nuniform vec3 camPos;\nuniform float timeElapsed;\nvarying vec2 vUv;\nvarying vec2 vNoiseUv;\nvarying vec3 vPos;\nvarying mat3 vTbnMatrix;\nfloat bZ(vec3 e, float ca) {\n  float cb = max(.015, ca);\n  return max((e.x + e.y) * .3303545 / cb + .3303545, .0);\n}\nconst vec2 cc = vec2(6. / 25., 5. / 24.);\nvec2 cd(sampler2D ce, vec2 S) {\n  return 2. * texture2D(ce, S).rg - 1.;\n}\nfloat cf(vec2 S) {\n  return texture2D(heightTexture, S).b;\n}\nvec3 cg(sampler2D ce, vec2 S) {\n  return 2. * texture2D(ce, S).rgb - 1.;\n}\nfloat ch(vec2 S, float ci) {\n  return fract(ci);\n}\nfloat cj(vec2 S, float ci) {\n  float ck = ch(S, ci);\n  return 1. - abs(1. - 2. * ck);\n}\nvec3 cl(sampler2D cm, vec2 S, float ci, float cn) {\n  float co = waveParams[2];\n  float cp = waveParams[3];\n  vec2 cq = cd(cm, S) * co;\n  float ck = ch(S, ci + cn);\n  float cr = cj(S, ci + cn);\n  vec2 f = S;\n  f -= cq * (ck + cp);\n  f += cn;\n  f += (ci - ck) * cc;\n  return vec3(f, cr);\n}\nconst float cs = 7.77;\nvec3 ct(sampler2D cu, sampler2D cv, vec2 cw, vec2 cx, float ci) {\n  float ca = waveParams[0];\n  vec2 cy = ci * -cx;\n  float cz = cf(vNoiseUv) * cs;\n  vec3 cA = cl(cv, cw + cy, ci + cz, .0);\n  vec3 cB = cl(cv, cw + cy, ci + cz, .5);\n  vec3 cC = cg(cu, cA.xy) * cA.z;\n  vec3 cD = cg(cu, cB.xy) * cB.z;\n  vec3 cE = normalize(cC + cD);\n  cE.xy *= ca;\n  cE.z = sqrt(1. - dot(cE.xy, cE.xy));\n  return cE;\n}\nvec4 cF(vec2 cw, float cG) {\n  float cH = waveParams[1];\n  vec3 d = ct(normalTexture, heightTexture, cw * cH, waterDir, cG);\n  float cI = bZ(d, waveParams[0]);\n  return vec4(d, cI);\n}\nconst float cJ = 3.141592653589793;\nconst float cK = 1. / cJ;\nconst float cL = .3183098861837907;\nconst float cM = 1.570796326794897;\nconst float cN = .4;\nfloat cO = 2.2;\nvec3 cP(float cQ, vec3 cR, float l) {\n  return cR + (l - cR) * pow(1. - cQ, 5.);\n}\nfloat cS(float cT, float j) {\n  float cU = j * j;\n  float cV = cT * cT;\n  float cW = pow((cV * (cU - 1.) + 1.), cO) * cJ;\n  return cU / cW;\n}\nfloat cX(float cY) {\n  return .25 / (cY * cY);\n}\nvec3 cZ(const vec3 x) {\n  return (x * (2.51 * x + .03)) / (x * (2.43 * x + .59) + .14);\n}\nconst float da = 2.2;\nconst float db = .4545454545;\nvec4 dc(vec4 u) {\n  return vec4(pow(u.rgb, vec3(db)), u.w);\n}\nvec3 dd(vec3 u) {\n  return pow(u, vec3(da));\n}\nconst vec3 de = vec3(.02, 1., 5.);\nconst vec2 df = vec2(.02, .1);\nconst float j = .06;\nconst float dg = 1.7;\nconst vec3 dh = vec3(0, .6, .9);\nconst vec3 di = vec3(.72, .92, 1.);\nconst float dj = .65;\nconst float dk = 300000.0;\nconst float dl = 500000.0;\nconst float dm = .775;\nconst float dn = .8;\nPBRShadingWater dp;\nvec3 dq(in PBRShadingWater dr, float j, vec3 ds, float dt) {\n  vec3 du = cP(dr.VdotH, ds, dt);\n  float dv = cS(dr.NdotH, j);\n  float dw = cX(dr.LdotH);\n  float dx = mix(j + .045, j + .385, 1. - dr.VdotH);\n  float dy = 1.2;\n  float dz = cS(dr.NdotH, dx) * dy;\n  return ((dv + dz) * dw) * du;\n}\nvec3 dA(float dg, float dB, vec3 dh, float dC) {\n  return dg * (.075 * dh * pow(dB, 4.) + 50. * pow(dB, 23.)) * dC;\n}\nvec3 dD(in float bk, in vec3 dE, in vec3 dF) {\n  float dG = pow((1. - bk), de[2]);\n  return mix(dF, dE, dG);\n}\nvec3 dH(in vec3 e, in vec3 dI, in float dJ, in float j) {\n  \n#ifdef HAS_IBL_LIGHTING\nvec3 dK = reflect(-dI, e);\n  vec3 dL = textureCube(prefilterMap, environmentTransform * dK).rgb;\n  float dM = clamp(1. + dot(dK, e), .0, 1.);\n  dL *= dM * dM;\n  vec3 i = dL;\n  vec3 dN = c(e);\n  float l = clamp(50.0 * waterBaseColor.g, .0, 1.);\n  vec3 dO = h(waterBaseColor.rgb, j, dot(e, dI), l);\n  return i * dO + dN;\n#else\nvec3 dP = dd(di);\n  vec3 dQ = dd(dh);\n  vec3 di = dD(dJ, dP, dQ);\n  return di;\n#endif\n}\nvec3 dR(in vec3 e, in vec3 dI, in vec3 dS, vec3 u, in vec3 dT, in vec3 dU, in float dV, float dW, vec3 dX) {\n  float dY = 0.;\n  vec3 dZ = dd(u);\n  vec3 bm = normalize(dS + dI);\n  dp.NdotL = clamp(dot(e, dS), .0, 1.);\n  dp.NdotV = clamp(dot(e, dI), .001, 1.);\n  dp.VdotN = clamp(dot(dI, e), .001, 1.);\n  dp.NdotH = clamp(dot(e, bm), .0, 1.);\n  dp.VdotH = clamp(dot(dI, bm), .0, 1.);\n  dp.LdotH = clamp(dot(dS, bm), .0, 1.);\n  float dJ = max(dot(dU, dI), .0);\n  vec3 di = dH(e, dI, dJ, j);\n  float ea = max(dot(dU, dS), .0);\n  float eb = .1 + ea * .9;\n  di *= eb;\n  float ec = clamp(dV, .8, 1.);\n  vec3 ed = cP(dp.VdotN, vec3(de[0]), de[1]);\n  vec3 ee = ed * di * ec;\n  vec3 ef = dZ * mix(di, ea * dT * cK, 2. / 3.) * ec;\n  vec3 i = vec3(.0);\n  if(dJ > .0 && ea > .0) {\n    vec3 eg = dq(dp, j, vec3(df[0]), df[1]);\n    vec3 eh = dT * cK * dV;\n    i = dp.NdotL * eh * eg;\n  }\n  vec3 cI = vec3(.0);\n  if(dJ > .0) {\n    cI = dA(dg, dW, dh, eb);\n  }\n  vec3 ei = vec3(.0);\n#ifdef HAS_SSR\nfloat ej = smoothstep(dl, dk, -dX.z);\n  mat4 ek = viewMatrix;\n  vec4 el = vec4(dX.xyz, 1.);\n  vec3 em = normalize(el.xyz);\n  vec4 en = ek * vec4(e, .0);\n  vec3 eo = normalize(en.xyz);\n  vec4 ep = ek * vec4(dU, .0);\n  float eq = pow(max(dot(-em, ep.xyz), .0), cN);\n  vec3 er = mix(ep.xyz, eo, eq);\n  vec3 es = ssr(vec3(.0), vec3(1.), j, normalize(er), -normalize(vViewVertex.xyz));\n  if(es.z > .0) {\n    vec2 et = smoothstep(.3, .6, abs(vec2(.5) - es.xy));\n    dY = dm * clamp(1. - 1.3 * et.y, .0, 1.) * ej;\n    vec3 eu = X(.0, es.xy);\n    ei = dd(eu) * dY * ed.y * dj;\n  }\n#endif\nfloat ev = mix(dn, dn * .5, dY);\n  return cZ((1. - dY) * ee + ei + ef * ev + i + cI);\n}\nvoid main() {\n  vec3 dU = bY;\n  vec4 ew = cF(vUv, timeElapsed);\n  vec3 e = normalize(vTbnMatrix * ew.xyz);\n  vec3 dI = -normalize(vPos - camPos);\n  vec3 dS = normalize(-lightDirection);\n#if defined(HAS_SHADOWING)\nfloat dV = shadow_computeShadow();\n#else\nfloat dV = 1.;\n#endif\nvec4 ex = viewMatrix * vec4(vPos, 1.);\n  vec4 ey = vec4(dR(e, dI, dS, waterBaseColor.rgb, lightColor, dU, dV, ew.w, ex.xyz), waterBaseColor.a);\n  gl_FragColor = dc(ey);\n  if(contrast != 1.) {\n    gl_FragColor = contrastMatrix(contrast) * gl_FragColor;\n  }\n  if(length(hsv) > .0) {\n    gl_FragColor = hsv_apply(gl_FragColor, hsv);\n  }\n  gl_FragColor = highlight_blendColor(gl_FragColor) * layerOpacity;\n}",defines:o,uniforms:i,extraCommandProps:a})}getUniformValues(t){return{projViewMatrix:t.projViewMatrix,minAltitude:this.layer.options.altitude||0}}_getWaterUniform(t,e){const{iblTexes:n,dfgLUT:i}=this.getIBLRes(),o=yz(t,n,i,e&&e.ssr,e&&e.jitter),s=t.getLightManager();let a=s&&s.getDirectionalLight()||{};const l=s&&s.getAmbientLight()||{},h=this.getSymbol(xz),c=this._waterDir=this._waterDir||[],u=this._waveParams=this._waveParams||[];g_(u,.09,h.uvScale||3,.03,-.5),LL(o,{ambientColor:l.color||[.2,.2,.2],viewMatrix:t.viewMatrix,lightDirection:a.direction||_z.direction,lightColor:a.color||_z.color,camPos:t.cameraPosition,timeElapsed:h.animation?(this.layer.getRenderer().getFrameTimestamp()||0)/(1/(h.waterSpeed||1)*1e4):0,normalTexture:this._normalTex||this._emptyTex,heightTexture:this._pertTex||this._emptyTex,waveParams:u,waterDir:Tz(c,h.waterDirection||0),waterBaseColor:h.waterBaseColor||[.1451,.2588,.4863,1],contrast:h.contrast||1,hsv:h.hsv||bz});const f=this.layer.getRenderer();return o.layerOpacity=f._getLayerOpacity(),this.setIncludeUniformValues(o,e),e&&e.ssr&&e.ssr.renderUniforms&&LL(o,e.ssr.renderUniforms),o}delete(){super.delete(),this._emptyTex&&(this._emptyTex.destroy(),delete this._emptyTex),this._normalTex&&this._normalTex.destroy(),this._pertTex&&this._pertTex.destroy(),this.shader&&(this.shader.dispose(),delete this.shader),this._waterShader&&this._waterShader.dispose(),this._water&&(this._water.geometry.dispose(),this._water.material&&this._water.material.dispose(),this._water.dispose(),delete this._water),this.disposeIBLTextures()}createGround(){const t=new Ow;t.data.aTexCoord=new Uint8Array([0,1,1,1,0,0,1,0]),t.generateBuffers(this.renderer.regl),this._water=new aw(t,null,{castShadow:!1}),this._waterScene=new _w([this._water])}transformWater(){const t=this.getMap(),e=GroundPainter.getGroundTransform(this._water.localTransform,t);this._water.setLocalTransform(e);const n=t._get2DExtentAtRes(t.getGLRes()),i=n.getWidth(),o=n.getHeight(),s=t.cameraLookAt,a=(s[0]-i)/wz[0],l=(s[1]+o)/wz[1],h=a*vz%1,c=l*vz%1,u=i/wz[0]*2,f=o/wz[1]*2;this._water.setUniform("uvOffset",[a%1,l%1]),this._water.setUniform("noiseUvOffset",[h,c]),this._water.setUniform("uvScale",[u,-f])}}function Tz(t,e){return e=Math.PI*e/180,t[0]=Math.sin(e),t[1]=Math.cos(e),t}var Mz="#define SHADER_NAME BILL_BOARD\n#include <gl2_vert>\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\nattribute vec2 aExtrude;\nattribute vec2 aTexCoord;\nattribute vec4 aQuat;\nvarying vec2 vTexCoord;\nuniform mat4 positionMatrix;\nuniform mat4 projViewModelMatrix;\nuniform float extrudeScale;\n#ifdef PICKING_MODE\n#include <fbo_picking_vert>\n#endif\n#include <vt_position_vert>\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_vert>\n#endif\nmat4 c(vec4 q) {\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float d = x * x, e = y * y, f = z * z;\n  float xy = x * y, xz = x * z, yz = y * z;\n  float wx = w * x, wy = w * y, wz = w * z;\n  return mat4(1. - 2. * (e + f), 2. * (xy + wz), 2. * (xz - wy), .0, 2. * (xy - wz), 1. - 2. * (d + f), 2. * (yz + wx), .0, 2. * (xz + wy), 2. * (yz - wx), 1. - 2. * (d + e), .0, .0, .0, .0, 1.);\n}\nvoid main() {\n  vec4 h = vec4(aExtrude.x * extrudeScale, .0, aExtrude.y, 1.);\n  mat4 i = c(aQuat);\n  vec3 j = (i * h).xyz;\n  vec3 k = unpackVTPosition(j);\n  vTexCoord = aTexCoord;\n  gl_Position = projViewModelMatrix * positionMatrix * vec4(k, 1.);\n#ifdef PICKING_MODE\nfbo_picking_setData(gl_Position.w, true);\n#elif defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nshadow_computeShadowPars(vec4(k, 1.));\n#endif\n}";function Cz(t,e,n){n=n||{},this.w=t||64,this.h=e||64,this.autoResize=!!n.autoResize,this.shelves=[],this.freebins=[],this.stats={},this.bins={},this.maxId=0}function Sz(t,e,n){this.x=0,this.y=t,this.w=this.free=e,this.h=n}function Pz(t,e,n,i,o,s,a){this.id=t,this.x=e,this.y=n,this.w=i,this.h=o,this.maxw=s||i,this.maxh=a||o,this.refcount=0
/*!
   * Codes from mapbox-gl-js
   * github.com/mapbox/mapbox-gl-js
   * MIT License
   */}function Iz(t,{width:e,height:n},i,o){if(o){if(o.length!==e*n*i)throw new RangeError("mismatched image size")}else o=new Uint8Array(e*n*i);return t.width=e,t.height=n,t.data=o,t}function Oz(t,e,n,i,o,s){if(0===o.width||0===o.height)return e;if(o.width>t.width||o.height>t.height||n.x>t.width-o.width||n.y>t.height-o.height)throw new RangeError("out of range source coordinates for image copy");if(o.width>e.width||o.height>e.height||i.x>e.width-o.width||i.y>e.height-o.height)throw new RangeError("out of range destination coordinates for image copy");const a=t.data,l=e.data;if(a===l)return e;for(let h=0;h<o.height;h++){const c=((n.y+h)*t.width+n.x)*s,u=((i.y+h)*e.width+i.x)*s;for(let t=0;t<o.width*s;t++)l[u+t]=a[c+t]}return e}Cz.prototype.pack=function(t,e){t=[].concat(t),e=e||{};for(var n,i,o,s=[],a=0;a<t.length;a++)if(i=t[a].h||t[a].height,(n=t[a].w||t[a].width)&&i){if(!(o=this.packOne(n,i,t[a].id)))continue;e.inPlace&&(t[a].x=o.x,t[a].y=o.y,t[a].id=o.id),s.push(o)}return this.shrink(),s},Cz.prototype.packOne=function(t,e,n){var i,o,s,a,l,h,c,u,f={freebin:-1,shelf:-1,waste:1/0},g=0;if("string"==typeof n||"number"==typeof n){if(i=this.getBin(n))return this.ref(i),i;"number"==typeof n&&(this.maxId=Math.max(n,this.maxId))}else n=++this.maxId;for(a=0;a<this.freebins.length;a++){if(e===(i=this.freebins[a]).maxh&&t===i.maxw)return this.allocFreebin(a,t,e,n);e>i.maxh||t>i.maxw||e<=i.maxh&&t<=i.maxw&&(s=i.maxw*i.maxh-t*e)<f.waste&&(f.waste=s,f.freebin=a)}for(a=0;a<this.shelves.length;a++)if(g+=(o=this.shelves[a]).h,!(t>o.free)){if(e===o.h)return this.allocShelf(a,t,e,n);e>o.h||e<o.h&&(s=(o.h-e)*t)<f.waste&&(f.freebin=-1,f.waste=s,f.shelf=a)}return-1!==f.freebin?this.allocFreebin(f.freebin,t,e,n):-1!==f.shelf?this.allocShelf(f.shelf,t,e,n):e<=this.h-g&&t<=this.w?(o=new Sz(g,this.w,e),this.allocShelf(this.shelves.push(o)-1,t,e,n)):this.autoResize?(l=h=this.h,((c=u=this.w)<=l||t>c)&&(u=2*Math.max(t,c)),(l<c||e>l)&&(h=2*Math.max(e,l)),this.resize(u,h),this.packOne(t,e,n)):null},Cz.prototype.allocFreebin=function(t,e,n,i){var o=this.freebins.splice(t,1)[0];return o.id=i,o.w=e,o.h=n,o.refcount=0,this.bins[i]=o,this.ref(o),o},Cz.prototype.allocShelf=function(t,e,n,i){var o=this.shelves[t].alloc(e,n,i);return this.bins[i]=o,this.ref(o),o},Cz.prototype.shrink=function(){if(this.shelves.length>0){for(var t=0,e=0,n=0;n<this.shelves.length;n++){var i=this.shelves[n];e+=i.h,t=Math.max(i.w-i.free,t)}this.resize(t,e)}},Cz.prototype.getBin=function(t){return this.bins[t]},Cz.prototype.ref=function(t){if(1==++t.refcount){var e=t.h;this.stats[e]=1+(0|this.stats[e])}return t.refcount},Cz.prototype.unref=function(t){return 0===t.refcount?0:(0==--t.refcount&&(this.stats[t.h]--,delete this.bins[t.id],this.freebins.push(t)),t.refcount)},Cz.prototype.clear=function(){this.shelves=[],this.freebins=[],this.stats={},this.bins={},this.maxId=0},Cz.prototype.resize=function(t,e){this.w=t,this.h=e;for(var n=0;n<this.shelves.length;n++)this.shelves[n].resize(t);return!0},Sz.prototype.alloc=function(t,e,n){if(t>this.free||e>this.h)return null;var i=this.x;return this.x+=t,this.free-=t,new Pz(n,i,this.y,t,e,t,this.h)},Sz.prototype.resize=function(t){return this.free+=t-this.w,this.w=t,!0};class ko{constructor(t,e){Iz(this,t,4,e)}resize(t){!function(t,{width:e,height:n},i){if(e===t.width&&n===t.height)return;const o=Iz({},{width:e,height:n},i);Oz(t,o,{x:0,y:0},{x:0,y:0},{width:Math.min(t.width,e),height:Math.min(t.height,n)},i),t.width=e,t.height=n,t.data=o.data}(this,t,4)}clone(){return new ko({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,e,n,i,o){Oz(t,e,n,i,o,4)}}const Ez=new _e(0,0),kz=[],Rz=[],Lz=document.createElement("canvas");class Do extends bF{constructor(...t){super(...t),this._ready=!0;const e=this.getSymbolDef({index:0}),n=YR(e&&e.source);if(this._ready=!n,mk(e.width)?this._widthFn=_k(e.width):this._width=e.width,mk(e.height)?this._heightFn=_k(e.height):this._height=e.height,mk(e.rotationX)?this._rotationXFn=_k(e.rotationX):this._rotationX=e.rotationX,mk(e.rotationY)?this._rotationYFn=_k(e.rotationY):this._rotationY=e.rotationY,mk(e.rotationZ)?this._rotationZFn=_k(e.rotationZ):this._rotationZ=e.rotationZ,n){const t=this._image=new Image;t.onload=()=>{this._ready=!0},t.src=e.source}}needToRedraw(){const t=this.getSymbolDef({index:0});if(!t||!$R(t.source))return super.needToRedraw();const e=this.layer.getRenderer().getCurrentTiles();return!e||OD(e)?super.needToRedraw():this._checkIfSourceUpdated()||super.needToRedraw()}_checkIfSourceUpdated(){let t=!1;const e=this.layer.getRenderer(),n=e.getCurrentTiles(),i=this.getSymbolDef({index:0}).source,o=e.tileCache,s=[];for(const e in n){const n=o.get(e);if(!(n&&n.image&&n.image.cache&&n.image.cache[0]))continue;let{geometry:a}=n.image.cache[0];if(!a||!a[0]||!a[0].geometry)continue;a=a[0].geometry.properties.billGeometry;const{oldPickingId:l,contextCache:h,textureCache:c,features:u,billTexture:f}=a.properties;if(!l||!l.length)continue;let g=!1,A=!1;const m=l.length;for(let e=0;e<m;e++){const n=l[e],o=h[n]=h[n]||{},a=u[n]&&u[n].feature;if(!a)continue;const f=c[n];let m=0,w=0;f&&(m=f.width,w=f.height);let T,M=i(o,a.properties);M.redraw?(g=t=!0,T=c[n]=M.data,m===T.width&&w===T.height||(A=!0)):T=c[n],s.push({id:n,w:T.width,h:T.height})}if(g){const t=this._fillFnTextureData(A?a.properties.aTexCoord:null,a,s);f({width:t.width,height:t.height,data:t.data,format:t.format,mag:"linear",min:"linear",flipY:!1,premultiplyAlpha:!0}),A&&a.updateData("aTexCoord",a.properties.aTexCoord)}}return t}isTerrainSkin(){return!1}isTerrainVector(){return this.layer.options.awareOfTerrain}isUniqueStencilRefPerTile(){return!1}createMesh(t,e,{tilePoint:n}){if(!this._ready)return null;let{geometry:i}=t;const{features:o,tileResolution:s,tileRatio:a}=i.properties;if(!i.data.aPosition||0===i.data.aPosition.length)return null;const l=this._createBillboard(i,i.desc.positionSize,o);l.generateBuffers(this.regl),i.properties.billGeometry=l;const h=new Qb({billTexture:l.properties.billTexture}),c=new aw(l,h,{castShadow:!1,picking:!0}),u=this.getMap();Ez.set(n[0],n[1]);const f=u.altitudeToPoint(1,s)*a;c.setUniform("extrudeScale",f/100);const g=[];c.setFunctionUniform("textureSize",(()=>{const t=l.properties.billTexture;return g[0]=t.width,g[1]=t.height,g}));const A={};return c.geometry.data.aAltitude&&(A.HAS_ALTITUDE=1),c.setDefines(A),c.positionMatrix=this.getAltitudeOffsetMatrix(),c.setLocalTransform(e),c.properties.symbolIndex={index:0},c}_createBillboard(t,e,n){const i=t.properties.z,{aPosition:o,aPickingId:s}=t.data,a=t.properties;a.oldPickingId=s;const l=a.contextCache=[],h=a.textureCache=[],c=s.length,u=6*c,f=new o.constructor(u*e),g=new Int16Array(2*u),A=new Float32Array(4*u),m=new s.constructor(u),w=this.getSymbolDef({index:0}).source,T=[];for(let t=0;t<c;t++){const n=o.subarray(t*e,(t+1)*e),i=s[t];f.set(n,6*t*e),f.set(n,(6*t+1)*e),f.set(n,(6*t+2)*e),f.set(n,(6*t+3)*e),f.set(n,(6*t+4)*e),f.set(n,(6*t+5)*e),m[6*t]=i,m[6*t+1]=i,m[6*t+2]=i,m[6*t+3]=i,m[6*t+4]=i,m[6*t+5]=i}const M=$R(w);for(let t=0;t<c;t++){const e=s[t],o=n[e];let a;M?(a=w(l[e]=l[e]||{},o&&o.feature&&o.feature.properties).data,h[e]=a,T.push({id:e,w:a.width,h:a.height})):a=this._image,this._fillExtrude(g,t,o,i),this._fillQuat(A,t,o,i)}const C=new Int16Array(2*u);if(T.length){const e=this._fillFnTextureData(C,t,T);a.billTexture=TF(this.regl,e,!1,!1)}else{const t={x:0,y:0,w:this._image.width,h:this._image.height};for(let e=0;e<c;e++)this._fillTexCoord(C,e,t,1);const e=this._image;a.billTexture=this.regl.texture({width:e.width,height:e.height,data:e})}const P=6*c<65536?Uint16Array:Uint32Array,I=[];for(let t=0;t<c;t++){const e=6*t;I.push(e,e+1,e+2),I.push(e+3,e+4,e+5)}const O={aPosition:f,aPickingId:m,aExtrude:g,aQuat:A,aTexCoord:C},{feaPickingIdMap:E,aFeaIds:D}=t.properties,N=new D.constructor(u);for(let t=0;t<m.length;t++)N[t]=E[m[t]];a.aFeaIds=N,a.aTexCoord=C;const H=new vb(O,new P(I),0,{positionSize:e});return H.properties=t.properties,H}_fillQuat(t,e,n,i){let o=this._rotationX||0,s=this._rotationY||0,a=this._rotationZ||0;const l=n&&n.feature&&n.feature.properties;this._rotationXFn&&(o=this._rotationXFn(i,l)),this._rotationYFn&&(s=this._rotationYFn(i,l)),this._rotationZFn&&(a=this._rotationZFn(i,l)),Q_(Rz,o,s,-a);for(let n=0;n<6;n++)t.set(Rz,4*(e+n))}_fillExtrude(t,e,n,i){let o=this._width||0,s=this._height||0;const a=n&&n.feature&&n.feature.properties;this._widthFn&&(o=this._widthFn(i,a)),this._heightFn&&(s=this._heightFn(i,a));const l=o/2*100,h=s/2*100;kz[0]=-l,kz[1]=-h,t.set(kz,2*e),kz[0]=l,kz[1]=h,t.set(kz,2*e+2),kz[0]=-l,kz[1]=h,t.set(kz,2*e+4),kz[0]=-l,kz[1]=-h,t.set(kz,2*e+6),kz[0]=l,kz[1]=-h,t.set(kz,2*e+8),kz[0]=l,kz[1]=h,t.set(kz,2*e+10)}_fillFnTextureData(t,e,n){const i=e.properties,{textureCache:o,oldPickingId:s}=i,a=s.length,l=new Cz(0,0,{autoResize:!0}),h=Lz.getContext("2d");l.pack(n,{inPlace:!0});const c=this.sceneConfig.textureLimit||1024;let u=1;l.w*l.h>c*c&&(u=Math.sqrt(c*c/(l.w*l.h)),l.resize(Math.floor(l.w*u),Math.floor(l.h*u)));const f=new ko({width:l.w,height:l.h});for(let e=0;e<a;e++){const i=n[e];t&&this._fillTexCoord(t,e,i,u);const s=o[i.id];if(!s)continue;const a=Math.floor(i.w*u),l=Math.floor(i.h*u);Lz.width=a,Lz.height=l,h.drawImage(s,0,0,a,l);const c=h.getImageData(0,0,a,l);ko.copy(c,f,{x:0,y:0},{x:Math.floor(i.x*u),y:Math.floor(i.y*u)},{width:a,height:l})}return f.format="rgba",f}_fillTexCoord(t,e,n,i){const{x:o,y:s,w:a,h:l}=n,h=Math.floor(o*i),c=Math.floor((o+a)*i),u=Math.floor(s*i),f=Math.floor((s+l)*i);kz[0]=h,kz[1]=f,t.set(kz,2*e),kz[0]=c,kz[1]=u,t.set(kz,2*e+2),kz[0]=h,kz[1]=u,t.set(kz,2*e+4),kz[0]=h,kz[1]=f,t.set(kz,2*e+6),kz[0]=c,kz[1]=f,t.set(kz,2*e+8),kz[0]=c,kz[1]=u,t.set(kz,2*e+10)}init(){this.renderer=new cw(this.regl);const t=[],e={vert:Mz,frag:"#define SHADER_NAME BILL_BOARD\nprecision mediump float;\n#include <gl2_frag>\nuniform sampler2D billTexture;\nuniform vec2 textureSize;\nvarying vec2 vTexCoord;\nvoid main() {\n  glFragColor = texture2D(billTexture, vTexCoord / textureSize);\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nfloat c = shadow_computeShadow();\n  glFragColor.rgb = shadow_blend(glFragColor.rgb, c);\n#endif\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(e,n){return cy(t,n.projViewMatrix,n.modelMatrix),t}}],defines:null,extraCommandProps:{viewport:{x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1},depth:{enable:!0,range:this.sceneConfig.depthRange||[0,1],func:this.sceneConfig.depthFunc||"<="},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},cull:{enable:!1}}};if(this.shader=new zw(e),this.shader.version=300,this.pickingFBO){const t=[];this.picking=[new zM(this.renderer,{vert:"#define PICKING_MODE 1\n"+Mz,uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(e,n){return cy(t,n.projViewMatrix,n.modelMatrix),t}}],extraCommandProps:{viewport:this.pickingViewport,depth:{enable:!0,range:this.sceneConfig.depthRange||[0,1],func:this.sceneConfig.depthFunc||"<="},cull:{enable:!1}}},this.pickingFBO,this.getMap())]}}getUniformValues(t){return{projViewMatrix:t.projViewMatrix}}deleteMesh(t,e){if(Array.isArray(t))for(let e=0;e<t.length;e++){const n=t[e];if(n.geometry){const t=n.geometry.properties;t.textureCache&&(delete t.billTexture,delete t.textureCache,delete t.contextCache)}}else if(t.geometry){const e=t.geometry.properties;e.textureCache&&(delete e.billTexture,delete e.textureCache,delete e.contextCache)}return super.deleteMesh(t,e)}}const Dz=ID("fill",FF);Dz.registerAt(yD);const Fz=ID("line",zF);Fz.registerAt(yD);const Nz=ID("line-gradient",YF);Nz.registerAt(yD);const Hz=ID("icon",kH);Hz.registerAt(yD);const Bz=ID("text",wB);Bz.registerAt(yD);const zz=ID("native-line",EB);zz.registerAt(yD),ID("native-point",PB).registerAt(yD);const Gz=ID("phong",WB);Gz.registerAt(yD);const jz=ID("wireframe",qB);jz.registerAt(yD);const Uz=ID("lit",JB);Uz.registerAt(yD);const Vz=ID("tube",$B);Vz.registerAt(yD);const Wz=ID("gltf-phong",po);Wz.registerAt(yD);const Zz=ID("gltf-lit",go);Zz.registerAt(yD);const qz=ID("heatmap",class extends bF{createFnTypeConfig(t,e){const n=_k(e.heatmapWeight),i=new Int16Array(1);return[{attrName:"aWeight",symbolName:"heatmapWeight",type:Int16Array,width:1,define:"HAS_HEAT_WEIGHT",evaluate:e=>{const o=n(t.getZoom(),e);return i[0]=255*o,i[0]}}]}createMesh(t,e){const{geometry:n,symbolIndex:i,ref:o}=t;void 0===o&&LD(n,this.getSymbolDef(i),this.getFnTypeConfig(i),this.layer);const s=this.getSymbol(i),a={tileRatio:n.properties.tileRatio,dataResolution:n.properties.tileResolution};BL(a,"heatmapIntensity",s,"heatmapIntensity",1),BL(a,"heatmapRadius",s,"heatmapRadius",6),BL(a,"heatmapWeight",s,"heatmapWeight",1),BL(a,"heatmapOpacity",s,"heatmapOpacity",1),n.generateBuffers(this.regl);const l=new Qb(a),h=new aw(n,l,{transparent:!0,castShadow:!1,picking:!0}),c={};return n.data.aWeight&&(c.HAS_HEAT_WEIGHT=1),h.setDefines(c),h.setLocalTransform(e),h.properties.symbolIndex=i,h}callRenderer(t,e,n){const i=this.getRenderFBO(n);this._drawCount+=this._process.render(this.scene,e,i)}getUniformValues(t){const e=this.getSymbol({index:0}),{projViewMatrix:n}=t;return{glScale:1/t.getGLScale(),resolution:t.getResolution(),projViewMatrix:n,heatmapOpacity:e.heatmapOpacity}}getHeatmapMeshes(){return this.scene.getMeshes()}delete(){super.delete(...arguments),this._process.dispose(),delete this._process}init(){this.renderer=new cw(this.regl);const t=this.getPolygonOffset(),e=this.getSymbols()[0];this._process=new HeatmapProcess(this.regl,this.sceneConfig,this.layer,e.heatmapColor,null,t)}});qz.registerAt(yD);const Xz=ID("water",Ao);Xz.registerAt(yD);const Jz=ID("billboard",Do);Jz.registerAt(yD),MD.registerPainter("lit",JB),MD.registerPainter("icon",kH),MD.registerPainter("fill",FF),MD.registerPainter("line",zF),MD.registerPainter("line-gradient",YF),MD.registerPainter("water",Ao),MD.registerPainter("tube",$B),MD.registerPainter("billboard",Do);class Jo extends yD{getTileUrl(t,e,n){const i=this.getMap().getResolution(n);return super.getTileUrl(t,e,function(t){return 19-Math.log(t/Qz)/Math.LN2}(i))}static fromJSON(t){return t&&"MapboxVectorTileLayer"===t.type?new Jo(t.id,t.options):null}}Jo.registerJSONType("MapboxVectorTileLayer");const Qz=12756274*Math.PI/(256*Math.pow(2,20));class Qo extends yD{constructor(t,e){(e=e||{}).spatialReference=null,super(t,e),this.setData(e.data)}onAdd(){this._prepareOptions()}_prepareOptions(){const t=this.getMap(),e=t.getMaxNativeZoom(),n=t.getProjection(),i="EPSG:4326"===n.code||"EPSG:4490"===n.code;var o;i&&(this.options.tileSystem=[1,-1,-180,90]),this.options.spatialReference=i?function(t,e){return{projection:e,fullExtent:{top:90,left:-180,bottom:-90,right:180},resolutions:function(){const e=[];for(let n=0;n<=t+1;n++)e[n]=90/(128*Math.pow(2,n));return e}()}}(e,n.code):(o=e,{projection:"EPSG:3857",resolutions:function(){const t=[],e=6378137*Math.PI;for(let n=0;n<=o+1;n++)t[n]=e/(256*Math.pow(2,n));return t}(),fullExtent:{top:6378137*Math.PI,left:-6378137*Math.PI,bottom:-6378137*Math.PI,right:6378137*Math.PI}})}getWorkerOptions(){const t=super.getWorkerOptions();let e=this.options.data;return YR(e)||e&&e.url?(e.url&&(e=JSON.parse(JSON.stringify(e))),e=Kz(e,this.getURLModifier())):e=this.features,t.data=e,t.tileBuffer=this.options.tileBuffer,t.extent=this.options.extent,t.hasAltitude=this.options.enableAltitude,t.simplifyTolerance=this.options.simplifyTolerance,t.projection=this.getSpatialReference().getProjection().code,t.generateOMBB=this.options.generateOMBB,t.convertFn=this.options.convertFn?this.options.convertFn+"":null,t}setData(t){return this.options.data=t,t&&(YR(t)||t.url)?(!!this.getRenderer()&&this._updateWorker(),this):(this._setData(t),this._updateWorker(),this)}_setData(t){return this.options.convertFn&&(t=new Function("data",this.options.convertFn+"\nreturn convert(data)")(t)),this.features=t,this._generateIdMap(),this}_updateWorker(){const t=this.getRenderer();if(t){const e=t.getWorkerConnection();if(e){let n=this.options.data;YR(n)||n&&n.url?(n.url&&(n=JSON.parse(JSON.stringify(n))),n=Kz(n,this.getURLModifier())):n=this.features,e.setData(n,((e,n)=>{t.clear(),this.onWorkerReady(null,n),t.setToRedraw(),setTimeout((()=>{t.setToRedraw()}),500)}))}}}getExtent(){return this._dataExtent}onWorkerReady(t,e){t?this.fire("dataerror",{error:t}):(e&&(e.extent&&this._setExtent(e.extent),e.idMap&&(this._idMaps=e.idMap)),this.fire("dataload",{extent:e&&e.extent}))}_setExtent(t){this._dataExtent=new Ph(...t)}_fetchData(t,e){YR(t)?lL.getJSON(t,e):lL.getJSON(t.url,t,e)}getData(){return this.features||null}getTileUrl(t,e,n){return this.getId()+","+t+","+e+","+n}getFeature(t){return this._idMaps[t]}static fromJSON(t){return t&&"GeoJSONVectorTileLayer"===t.type?new Qo(t.id,t.options):null}getGeometryById(t){return this._idMaps?this._idMaps[t]:null}_generateIdMap(){if(!this.features)return;if(this.features=JSON.parse(JSON.stringify(this.features)),!this.features)return;let t=0;this._idMaps={};const e=this.options.featureIdProperty,n=this.features;Array.isArray(n)?n.forEach((n=>{if(n){if(KR(n.id)||(n.id=t++),e){let t=e;tL(e)&&(t=e[n.layer||"0"]),n.id=n.properties[t]}this._idMaps[n.id]=n}})):n.features&&n.features.forEach((n=>{if(n){if(KR(n.id)||(n.id=t++),e){let t=e;tL(e)&&(t=e[n.layer||"0"]),n.id=n.properties[t]}this._idMaps[n.id]=n}}))}}function Yz(t){let e=document.createElement("a");return e.href=t,t=e.href,e=null,t}function Kz(t,e){return t.url?t.url=e?e(t.url):Yz(t.url):t=e?e(t):Yz(t),t}Qo.registerJSONType("GeoJSONVectorTileLayer"),Qo.mergeOptions({features:"id",tileBuffer:64,extent:8192,pyramidMode:1,simplifyTolerance:3,tileStackDepth:0,generateOMBB:!0});const{SYMBOLS_NEED_REBUILD_IN_VECTOR:$z,GlyphRequestor:tG,PointPack:eG,LinePack:nG,StyledPoint:iG,VectorPack:rG,StyledVector:oG}=ZR();let sG=!1,aG=1;const lG="_symbol_".trim(),hG=(wL+"").trim();let cG=new Float32Array(1);const uG=[];class ga extends vm.CanvasRenderer{constructor(...t){super(...t),this.features={},this._geometries={},this._counter=0,this._allFeatures={},this._featureMapping={},this._markerFeatures={},this._textFeatures={},this._lineFeatures={},this._dirtyAll=!0,this._kidGen={id:0,pickingId:0},this._dirtyTargetsInCurrentFrame={}}setURLModifier(t){this._urlModifier=t}getURLModifier(){return this._urlModifier}needToRedraw(){return super.needToRedraw()||this.painter&&this.painter.needToRedraw()||this._markerPainter&&this._markerPainter.needToRedraw()||this._linePainter&&this._linePainter.needToRedraw()}getAnalysisMeshes(){return this.painter&&this.painter.getAnalysisMeshes()||uG}getRayCastData(){return null}draw(t,e){this._frameTime=t;const n=this.layer;this.prepareCanvas(),this._zScale=this._getCentiMeterScale(this.getMap().getGLRes()),this._parentContext=e||{};const i=this._parentContext.renderMode,o=this._preparePaintContext();if(this._startFrame(o,i),this._dirtyAll)this.buildMesh(),this._buildMarkerMesh(),this._buildLineMesh(),this._dirtyTargetsInCurrentFrame={},this._dirtyGeo=!1,this._dirtyAll=!1,this._dirtyLine=!1;else if(this._dirtyGeo){const t=this.atlas,e=this._markerAtlas,n=this._lineAtlas;delete this.atlas,delete this._markerAtlas,delete this._lineAtlas,this.buildMesh(t),this._buildMarkerMesh(e),this._buildLineMesh(n),this._dirtyGeo=!1,this._dirtyLine=!1}else if(this._dirtyLine){const t=this._lineAtlas;delete this._lineAtlas,this._buildLineMesh(t),this._dirtyLine=!1}if(!this.meshes&&!this._markerMeshes&&!this._lineMeshes)return void this.completeRender();this._showHideUpdated&&(this._updateMeshVisible(),this._showHideUpdated=!1),this._updateDirtyTargets();const s=!i||"default"===i;let a=0;0===this.layer.options.meshRenderOrder&&this._renderMeshes(o,a,i);let l=0;if(this._lineMeshes&&(s||this._linePainter.supportRenderMode(i))){this._linePainter.startFrame(o),this._linePainter.addMesh(this._lineMeshes,null,{bloom:this._parentContext.bloom}),this._linePainter.prepareRender(o);const t=o.polygonOffsetIndex||0;a=this.meshes&&this.meshes.length?a-1:a,o.polygonOffsetIndex=(o.polygonOffsetIndex||0)+a,l=this._linePainter.render(o).drawCount,o.polygonOffsetIndex=t}if(1===this.layer.options.meshRenderOrder&&this._renderMeshes(o,l?a-1:a,i),this._markerMeshes&&(s||this._markerPainter.supportRenderMode(i))){const e=!this._parentContext.timestamp||this._parentContext.isFinalRender,i=!this._collisionTimestamp||this._collisionTimestamp!==t;n.options.collision&&i&&n.clearCollisionIndex();const s=this.layer.options.sceneConfig;this._markerPainter.sceneConfig.collision=!s||!!eL(s.collision)||s.collision,this._markerPainter.startFrame(o),this._markerPainter.addMesh(this._markerMeshes,null,{bloom:this._parentContext.bloom}),this._markerPainter.prepareRender(o),n.options.collision&&i&&(this._markerPainter.updateCollision(o),e&&(this._collisionTimestamp=t)),this._markerPainter.render(o)}(s||e&&e.isFinalRender)&&(this.completeRender(),this.layer.fire("canvasisdirty"))}_startFrame(t,e){this.painter&&(!e||"default"===e||this.painter.supportRenderMode(e))&&this.painter.startFrame(t)}_renderMeshes(t,e,n){return this.painter&&this.meshes&&(!n||"default"===n||this.painter.supportRenderMode(n))?(this.painter.addMesh(this.meshes,null,{bloom:t&&t.bloom}),this.painter.prepareRender(t),t.polygonOffsetIndex=(t.polygonOffsetIndex||0)+e,this.painter.render(t)):{redraw:!1,drawCount:0}}supportRenderMode(){return!0}isForeground(){return!0}_preparePaintContext(){const t={regl:this.regl,layer:this.layer,symbol:this._layerSymbol,gl:this.gl,sceneConfig:this.layer.options.sceneConfig,pluginIndex:0,cameraPosition:this.getMap().cameraPosition,timestamp:this.getFrameTimestamp()};return this._parentContext&&QR(t,this._parentContext),t}drawOnInteracting(t,e,n){this.draw(e,n)}getFrameTimestamp(){return this._frameTime}_getFeaturesToRender(t,e){(t=t||e)===e&&(e=null);const n=[],i=[0,0,0,0];this.layer._sortGeometries();const o=this.layer.getGeometries();for(let s=0;s<o.length;s++){const a=o[s][qF];if(!this.features[a])continue;const l=this.features[a];if(Array.isArray(l))for(let o=0;o<l.length;o++){const s=l[o],a=s[hG];(!t||t[a]||e&&(!e||e[a]))&&(s.visible||(this._showHideUpdated=!0),this._addCoordsToCenter(s.geometry,i,s.coordinates),n.push(s))}else{l.visible||(this._showHideUpdated=!0);const o=l[hG];if(t&&!t[o]&&(!e||e&&!e[o]))continue;this._addCoordsToCenter(l.geometry,i,l.coordinates),n.push(l)}}if(n.length||(this.meshes&&this.painter&&(this.painter.deleteMesh(this.meshes),delete this.meshes),this._markerMeshes&&(this._markerPainter.deleteMesh(this._markerMeshes),delete this._markerMeshes),this._lineMeshes&&(this._linePainter.deleteMesh(this._lineMeshes),delete this._lineMeshes)),i[3]&&(i[0]/=i[3],i[1]/=i[3]),isNaN(i[0])||isNaN(i[1]))throw new Error(`invalid geometry coordinates for ${this.layer.getJSONType()}`);return{features:n,center:i}}buildMesh(){}createVectorPacks(t,e,n,i,o,s){return t&&i&&i.length?new e(i,n,{zoom:this.getMap().getZoom(),EXTENT:1/0,requestor:this.requestor,atlas:o,center:s,positionType:Float32Array}).load():Promise.resolve(null)}createMesh(t,e,n,i,o,s){return this.createVectorPacks(t,e,n,i,o,s).then((a=>this._createMesh(a,t,e,n,i,o,s)))}_createMesh(t,e,n,i,o,s,a){if(!t)return null;const l=e.createGeometries([t.data],PL(o,null,0,i,this.layer));for(let t=0;t<l.length;t++)l[t]&&this._fillCommonProps(l[t].geometry);const h=ay([]);uy(h,h,Fy([],a[0],a[1],0)),fy(h,h,Fy([],1,1,this._zScale));const c=e.createMeshes(l,h,{tilePoint:[a[0],a[1]]});for(let t=0;t<c.length;t++){const e=c[t];e.properties.level=0,e.properties.tileTransform=h;const n=e.defines;n.ENABLE_TILE_STENCIL=1,e.setDefines(n),e.properties.meshKey=this.layer.getId()}return{meshes:c,atlas:{iconAtlas:t.data.iconAtlas}}}_addCoordsToCenter(t,e,n){for(let i=0;i<t.length;i++)if(Array.isArray(t[i][0]))for(let o=0;o<t[i].length;o++)if(Array.isArray(t[i][o][0]))for(let s=0;s<t[i][o].length;s++)isNaN(+t[i][o][s][0])||isNaN(+t[i][o][s][1])||this._addCoord(e,t[i][o][s][0],t[i][o][s][1],t[i][o][s][2],1,n[i][o][s]);else isNaN(+t[i][o][0])||isNaN(+t[i][o][1])||this._addCoord(e,t[i][o][0],t[i][o][1],t[i][o][2],1,n[i][o]);else isNaN(+t[i][0])||isNaN(+t[i][1])||this._addCoord(e,t[i][0],t[i][1],t[i][2],1,n[i])}_addCoord(t,e,n,i,o,s){const a=this.getMap().getProjection().isSphere();let l=!1;(s[0]>180||s[0]<-180)&&a&&!sG&&(l=!0,sG=!0,console.warn(`Layer(${this.layer.getId()}) has invalid longitude value: ${s[0]}`)),(s[1]>90||s[1]<-90)&&a&&!sG&&(l=!0,sG=!0,console.warn(`Layer(${this.layer.getId()}) has invalid latitude value: ${s[1]}`)),l||(t[0]+=e,t[1]+=n,t[2]+=i||0,t[3]+=o)}_fillCommonProps(t){const e=this.getMap().getGLRes(),n=t.properties;n.tileResolution=e,n.tileRatio=1,n.z=1,n.tileExtent=1,n.elements=t.elements,n.aPickingId=t.data.aPickingId}_isEnableWorkAround(t){return"win-intel-gpu-crash"===t&&this.layer.options.workarounds["win-intel-gpu-crash"]&&dG(this.gl)}prepareRequestors(){if(this._iconRequestor)return;const t=this.layer;this._iconRequestor=new cL({iconErrorUrl:t.options.iconErrorUrl,urlModifier:e=>{const n=t.getURLModifier();return n&&n(e)||e}});const e=!this._isEnableWorkAround("win-intel-gpu-crash");this._glyphRequestor=new tG((e=>{t.getMap().getRenderer().callInNextFrame(e)}),t.options.glyphSdfLimitPerFrame,e,t.options.style&&t.options.style.renderPlugin&&t.options.style.renderPlugin.sdfURL),this.requestor=this._fetchPattern.bind(this),this._markerRequestor=this._fetchIconGlyphs.bind(this)}_fetchPattern(t,e,n){const i=[];this._iconRequestor.getIcons(t,((t,e)=>{if(t)throw t;e.buffers&&i.push(...e.buffers),n(null,{icons:e.icons},i)}))}_fetchIconGlyphs(t,e,n){this._glyphRequestor.getGlyphs(e,((e,i)=>{if(e)throw e;const o=i.buffers||[];this._iconRequestor.getIcons(t,((t,e)=>{if(t)throw t;e.buffers&&e.buffers.length&&o.push(...e.buffers),n(null,{icons:e.icons,glyphs:i.glyphs},o)}))}))}_buildMarkerMesh(t){const e=Object.keys(this._markerFeatures),n=Object.keys(this._textFeatures);if(!e.length&&!n.length)return void(this._markerMeshes&&(this._markerPainter.deleteMesh(this._markerMeshes),delete this._markerMeshes));const{features:i,center:o}=this._getFeaturesToRender(this._markerFeatures,this._textFeatures),s=[],a=[];for(let t=0;t<i.length;t++){const e=i[t][hG];this._markerFeatures[e]&&s.push(i[t]),this._textFeatures[e]&&a.push(i[t])}if(!s.length&&!a.length)return void(this._markerMeshes&&(this._markerPainter.deleteMesh(this._markerMeshes),delete this._markerMeshes));const l=this._showHideUpdated;this._markerCenter=o;const h=this._createPointPacks(s,a,t,o);this._markerAtlas={};const c=[],u=[];this._isCreatingMarkerMesh=!0,Promise.all(h).then((t=>{if(this._markerMeshes&&(this._markerPainter.deleteMesh(this._markerMeshes),delete this._markerMeshes),!t||!t.length)return void this.setToRedraw();const e=this._markerPainter.createGeometries(t.map((t=>(t&&t.data&&(t.data.isIdUnique=!0),t&&t.data))),this._allFeatures);for(let n=0;n<e.length;n++)this._fillCommonProps(e[n].geometry,t[n]&&t[n].data);const n=t[0]&&t[0].data.iconAtlas,i=t[0]&&t[0].data.glyphAtlas||t[1]&&t[1].data.glyphAtlas;n&&(this._markerAtlas.iconAtlas=n),i&&(this._markerAtlas.glyphAtlas=i);const s=ay([]);uy(s,s,Fy(u,o[0],o[1],0)),fy(s,s,Fy(c,1,1,this._zScale));const a=this._markerPainter.createMeshes(e,s);for(let t=0;t<a.length;t++)a[t].geometry.properties.originElements=a[t].geometry.properties.elements.slice(),a[t].properties.level=0,a[t].material.set("flipY",1),a[t].properties.meshKey=aG++;this._markerMeshes=a,l&&(this._showHideUpdated=!0),this._isCreatingMarkerMesh=!1,this.setToRedraw(),this.layer.fire("buildmarkermesh")}))}_updateMeshVisible(){if(this._markerMeshes&&(this._updateVisElements(this._markerMeshes[0],this._markerFeatures),this._updateVisElements(this._markerMeshes[1],this._textFeatures),this._markerMeshes[0]&&this._markerPainter.prepareCollideIndex(this._markerMeshes[0].geometry),this._markerMeshes[1]&&this._markerPainter.prepareCollideIndex(this._markerMeshes[1].geometry)),this._lineMeshes)for(let t=0;t<this._lineMeshes.length;t++)this._updateVisElements(this._lineMeshes[t],this._lineFeatures);if(this.meshes)for(let t=0;t<this.meshes.length;t++)this._updateVisElements(this.meshes[t],this._allFeatures)}_updateVisElements(t,e){if(!t)return;const{aPickingId:n,originElements:i}=t.geometry.properties,o=[];for(let t=0;t<i.length;t++){const s=n[i[t]];e[s]&&e[s].feature.visible&&o.push(i[t])}const s=t.geometry.properties.elements=new i.constructor(o);t.geometry.setElements(s)}_createPointPacks(t,e,n,i){const o={zoom:this.getMap().getZoom(),EXTENT:1/0,requestor:this._markerRequestor,atlas:n,center:i,positionType:Float32Array,defaultAltitude:0,forceAltitudeAttribute:!0,markerWidthType:Uint16Array,markerHeightType:Uint16Array,allowEmptyPack:1};return[this._markerSymbol].map(((n,i)=>new eG(0===i?t:e,n,o).load()))}updateMesh(){}_updateMarkerMesh(t){const e=t._getInternalSymbol(),n={zoom:this.getMap().getZoom(),isVector3D:!0},i=this._convertGeo(t);if(!this._markerMeshes)return!1;let o=this.features[i];Array.isArray(o)||(o=[o]);const s=[],a=[],l=[],h=this.getMap().getZoom();let c,u;c=Array.isArray(e)?e.map((t=>t?xk(t,(()=>(s[0]=h,s))):t)):xk(e,(()=>(s[0]=h,s))),u=Array.isArray(e)?e.map((t=>t?rG.genFnTypes(t):t)):rG.genFnTypes(e);for(let t=0;t<o.length;t++){if(!o[t])continue;const i=Array.isArray(e)?e[t]:e,s=Array.isArray(c)?c[t]:c,a=Array.isArray(u)?u[t]:u,l=new iG(o,i,s,a,n).getIconAndGlyph();if(!this._markerAtlas||!eG.isAtlasLoaded(l,this._markerAtlas))return this._markRebuild(),this.setToRedraw(),!1}for(let t=0;t<o.length;t++){const e=o[t][hG];this._markerFeatures[e]&&a.push(o[t]),this._textFeatures[e]&&l.push(o[t])}const f=o[0].id,g=this._createPointPacks(a,l,this._markerAtlas,this._markerCenter),A=this._markerMeshes;return Promise.all(g).then((t=>{for(let e=0;e<t.length;e++){if(!t[e])continue;t[e].data&&(t[e].data.isIdUnique=!0);const n=A[e],i=n.geometry.properties.aFeaIds.indexOf(f);if(i<0)continue;const o=t[e].data.featureIds.length,s=t[e].data.dynamicAttributes;for(const a in t[e].data.data){if("aPickingId"===a)continue;if(s[a])continue;const l=t[e].data.data[a];l&&n.geometry.updateSubData(a,l,i*l.length/o)}}this.setToRedraw()})),!0}_updateLineMesh(t){return this._updateMesh(t,this._lineMeshes,this._lineAtlas,this._lineCenter,this._linePainter,nG,UF,this._groupLineFeas)}_updateMesh(t,e,n,i,o,s,a,l){if(!e)return!1;if(!n)return this._markRebuild(),this.setToRedraw(),!1;const h=t._getInternalSymbol(),c={zoom:this.getMap().getZoom()};let u=this.features[t[qF]];Array.isArray(u)||(u=[u]);const f=[];for(let t=0;t<u.length;t++){const e=u[t];if(!e)continue;const i=Array.isArray(h)?h[t]:h,o=rG.genFnTypes(i),a=new oG(u,i,o,c),l=s===nG?a.getLineResource():a.getPolygonResource();if(!rG.isAtlasLoaded(l,n[t]))return this._markRebuild(),this.setToRedraw(),!1;f.push(e)}const g=u[0].id,A=l.call(this,f);for(let t=0;t<A.length;t++)if(A[t].length){const n=e.filter((e=>e.feaGroupIndex===t));if(!n.length)return this._markRebuild(),this.setToRedraw(),!1;if(n[0].geometry.properties.aFeaIds.indexOf(g)<0)return this._markRebuild(),this.setToRedraw(),!1}const m=QR({},a),w=A.map((t=>this.createVectorPacks(o,s,m,t,n[0],i)));return Promise.all(w).then((t=>{for(let n=0;n<t.length;n++){let i;if(Array.isArray(e)){for(let t=0;t<e.length;t++)if(e[t].feaGroupIndex===n){i=e[t];break}}else i=e;i&&this._updateMeshData(i,g,t[n])}})),!0}_updateMeshData(t,e,n){const i=t.geometry.properties.aFeaIds,o=i.indexOf(e);if(!(o<0)){if(n){const e=n.data.dynamicAttributes,i=n.data.featureIds.length,s=n.data.data;for(const n in s)if(!e[n]&&rL(s,n)&&s[n]){const e=s[n];t.geometry.updateSubData(n,e,o*e.length/i)}}else{let n=o+1;for(;i[n]===e;)n++;const s=n-o,a=t.geometry.desc.positionSize;cG.length!==3*s&&(cG=new Float32Array(s*a),cG.fill(-1/0,0)),t.geometry.updateSubData(t.geometry.desc.positionAttribute,cG,o*a)}this.layer.fire("updatemesh"),this.setToRedraw()}}_buildLineMesh(t){if(!Object.keys(this._lineFeatures).length)return void(this._lineMeshes&&(this._linePainter.deleteMesh(this._lineMeshes),delete this._lineMeshes));const{features:e,center:n}=this._getFeaturesToRender(this._lineFeatures);if(!e.length)return;const i=this._showHideUpdated;this._lineCenter=n;const o=this._groupLineFeas(e),s=QR({},UF),a=o.map(((e,i)=>this.createMesh(this._linePainter,nG,s,e,t&&t[i],n)));this._isCreatingLineMesh=!0,Promise.all(a).then((t=>{this._lineMeshes&&this._linePainter.deleteMesh(this._lineMeshes);const e=[],n=[];for(let i=0;i<t.length;i++){const o=t[i]&&t[i].meshes;if(o){for(let t=0;t<o.length;t++){const n=o[t];n.feaGroupIndex=i,e.push(n),n.geometry.properties.originElements=n.geometry.properties.elements.slice()}n[i]=t[i].atlas}}this._lineMeshes=e,this._lineAtlas=n,i&&(this._showHideUpdated=i),this._isCreatingLineMesh=!1,this.setToRedraw(),this.layer.fire("buildlinemesh")}))}_groupLineFeas(t){const e=(lG+"lineDasharray").trim(),n=(lG+"linePatternFile").trim(),i=[],o=[],s=[];for(let a=0;a<t.length;a++){const l=t[a],h=l.properties&&l.properties[e];h&&_G(h)?s.push(l):l.properties&&l.properties[n]?o.push(l):i.push(l)}return[i,o,s]}_markRebuildGeometry(){this._dirtyGeo=!0,this.setToRedraw()}_markRebuild(){this._dirtyAll=!0,this.setToRedraw()}_convertGeometries(t){const e=this.layer.getId();for(let n=0;n<t.length;n++){const i=t[n];let o=!1;for(let t=0;t<this.GeometryTypes.length;t++)if(i instanceof this.GeometryTypes[t]){o=!0;break}if(!o)throw new Error(`${i.getJSONType()} can't be added to ${this.layer.getJSONType()}(id:${e}).`);this._convertGeo(i)}}_convertGeo(t){void 0===t[qF]&&(t[qF]=this._counter++);const e=t[qF];this.features[e]&&this._removeFeatures(e),this.features[e]=JF(t,this._kidGen,this.features[e]);return this._refreshFeatures(this.features[e],e),this._geometries[e]=t,e}_refreshFeatures(t,e){if(!t)return;const n=Array.isArray(t)?t[0].id:t.id;if(this._featureMapping[n]=t,Array.isArray(t))for(let n=0;n<t.length;n++){const i=t[n][hG];if(t[n][qF]=e,this._allFeatures[i]={feature:t[n]},this._allFeatures[i][qF]=e,!this.needCheckPointLineSymbols())continue;const o={feature:t[n]};(gG(t[n])||pG(t[n]))&&(this._markerFeatures[i]=o),pG(t[n])&&(this._textFeatures[i]=o),yG(t[n])&&(this._lineFeatures[i]=o)}else{t[qF]=e;const n={feature:t},i=t[hG];if(this._allFeatures[i]=n,!this.needCheckPointLineSymbols())return;(gG(t)||pG(t))&&(this._markerFeatures[i]=n),pG(t)&&(this._textFeatures[i]=n),yG(t)&&(this._lineFeatures[i]=n)}}needCheckPointLineSymbols(){return!0}_removeFeatures(t){const e=this.features[t];if(e)if(Array.isArray(e))for(let t=0;t<e.length;t++){const n=e[t][hG];delete this._featureMapping[e[t].id],delete this._allFeatures[n],delete this._markerFeatures[n],delete this._textFeatures[n],delete this._lineFeatures[n]}else{const t=e[hG];delete this._featureMapping[e.id],delete this._allFeatures[t],delete this._markerFeatures[t],delete this._textFeatures[t],delete this._lineFeatures[t]}}pick(t,e,n){const i=[];return this.layer.isVisible()?([this.painter,this._markerPainter,this._linePainter].forEach((o=>{if(!o)return;const s=o.pick(t,e,n.tolerance);if(s&&s.data&&s.data.feature){const t=this._geometries[s.data.feature[qF]];n&&n.includeInternals?i.push(t):(s.geometry=t,delete s.plugin,delete s.data,delete s.point,i.push(s))}})),i):i}_getFeaKeyId(t){const e=this.features[t[qF]];return Array.isArray(e)?e[0][hG]:e[hG]}_updateDirtyTargets(){let t=!1;for(const e in this._dirtyTargetsInCurrentFrame){const n=this._dirtyTargetsInCurrentFrame[e],i=this._getFeaKeyId(n);if(!this._isCreatingMarkerMesh&&(this._markerFeatures[i]||this._textFeatures[i])){const e=this._updateMarkerMesh(n);t=t||e}if(!this._isCreatingLineMesh&&this._lineFeatures[i]){const e=this._updateLineMesh(n);t=t||e}if(!this._isCreatingMesh){const e=this.updateMesh(n);t=t||e}}this._dirtyTargetsInCurrentFrame={},t&&(fG(this),this.layer.fire("partialupdate"))}_convertAndRebuild(t){this._convertGeo(t),this._markRebuild(),fG(this)}onGeometryAdd(t){this.setToRedraw(),this.canvas&&t&&t.length&&(this._convertGeometries(t),this._markRebuild(),fG(this))}onGeometryRemove(t){if(t&&t.length){for(let e=0;e<t.length;e++){const n=t[e][qF];void 0!==n&&(delete this._geometries[n],this._removeFeatures(n),delete this.features[n])}this._markRebuild(),fG(this)}}onGeometrySymbolChange(t){const e=t.target._getParent()||t.target,n=e[qF];if(void 0===n)return;let i=t.properties;if(Array.isArray(i)){const t={};for(let e=0;e<i.length;e++)i[e]&&QR(t,i[e]);i=t}else if(i&&void 0!==i[0]){const t={};for(const e in i)i[e]&&QR(t,i[e]);i=t}for(const t in i)if(rL(i,t)&&$z[t])return void this._convertAndRebuild(e);const o=e._getInternalSymbol(),s=this.features[n];if(this._convertGeo(e),s)if(function(t,e){return Array.isArray(t)?!!Array.isArray(e)&&t.length===e.length:!Array.isArray(e)}(o,s)){if(Array.isArray(o)){for(let t=0;t<o.length;t++)if(!vG(o[t],s[t]))return void this._convertAndRebuild(e)}else if(!vG(o,s))return void this._convertAndRebuild(e);this.onGeometryPositionChange(t)}else this._convertAndRebuild(e);else this._convertAndRebuild(e)}onGeometryShapeChange(t){const e=t.target._getParent()||t.target;void 0!==e[qF]&&(this._convertGeometries([e]),this._markRebuildGeometry(),fG(this))}onGeometryPositionChange(t){const e=t.target._getParent()||t.target,n=e[qF];void 0!==n&&(this._convertGeometries([e]),this._dirtyTargetsInCurrentFrame[n]=e,fG(this))}onGeometryZIndexChange(t){void 0!==(t.target._getParent()||t.target)[qF]&&this._markRebuild()}onGeometryShow(t){void 0!==(t.target._getParent()||t.target)[qF]&&this._onShowHide(t)}onGeometryHide(t){void 0!==(t.target._getParent()||t.target)[qF]&&this._onShowHide(t)}_onShowHide(t){const e=t.target._getParent()||t.target,n=this.features[e[qF]];if(n){const t=e.isVisible();if(Array.isArray(n)){if(t===n[0].visible)return;for(let e=0;e<n.length;e++)n[e].visible=t}else{if(t===n.visible)return;n.visible=t}this._markShowHide(),fG(this)}}_markShowHide(){this._showHideUpdated=!0}onGeometryPropertiesChange(t){const e=t.target._getParent()||t.target,n=e[qF];void 0!==n&&this.painter&&(this.features[n]=JF(e,this._kidGen),this._refreshFeatures(this.features[n],n),this._markerMeshes&&this._markerMeshes.length&&this._markerPainter.needRebuildOnGometryPropertiesChanged()||this._lineMeshes&&this._lineMeshes.length&&this._linePainter.needRebuildOnGometryPropertiesChanged()||this.meshes&&this.meshes.length&&this.painter.needRebuildOnGometryPropertiesChanged()?this._markRebuild():this.painter.onFeatureChange(this.features[n],this.meshes),fG(this))}createContext(){const t=this.canvas.gl&&this.canvas.gl.wrap;t?(this.gl=this.canvas.gl.wrap(),this.regl=this.canvas.gl.regl):this._createREGLContext(),t&&(this.canvas.pickingFBO=this.canvas.pickingFBO||this.regl.framebuffer(this.canvas.width,this.canvas.height)),this.prepareRequestors(),this.pickingFBO=this.canvas.pickingFBO||this.regl.framebuffer(this.canvas.width,this.canvas.height),this.painter=this.createPainter();const e=MD.get3DPainterClass("icon");let n=e.getBloomSymbol();const i=QR({},GF,jF);i.markerPerspectiveRatio=this.layer.options.markerPerspectiveRatio||0,this._defineSymbolBloom(i,n),this._markerSymbol=i;const o=QR({},AL,this.layer.options.sceneConfig||{});this._markerPainter=new e(this.regl,this.layer,i,o,0),this._markerPainter.setShaderDefines({REVERSE_MAP_ROTATION_ON_PITCH:1});const s=MD.get3DPainterClass("line"),a=QR({},UF);n=s.getBloomSymbol(),this._defineSymbolBloom(a,n),this._lineSymbol=a;const l=QR({},this.layer.options.sceneConfig||{});void 0===l.depthMask&&(l.depthMask=!0),this._linePainter=new s(this.regl,this.layer,a,l,0),this.layer.getGeometries()&&this.onGeometryAdd(this.layer.getGeometries())}_isInGroupGLLayer(){return!!(this.canvas&&this.canvas.gl&&this.canvas.gl.wrap)}_defineSymbolBloom(t,e){for(let n=0;n<e.length;n++)t[e[n]]=this.layer.options.enableBloom}updateBloom(t){this._markerPainter&&this._updatePainterBloom(this._markerPainter,this._markerSymbol,t),this._linePainter&&this._updatePainterBloom(this._linePainter,this._lineSymbol,t),this.painter&&this._updatePainterBloom(this.painter,this.painterSymbol,t)}_updatePainterBloom(t,e,n){const i=t.constructor.getBloomSymbol().reduce(((t,i)=>(t[i]=n,e[i]=n,t)),{});t.updateSymbol(i,e)}createPainter(){}_createREGLContext(){const t=this.layer.options.glOptions||{alpha:!0,depth:!0,stencil:!0,antialias:!1};t.preserveDrawingBuffer=!0,t.stencil=!0,this.glOptions=t,this.gl=this.gl||this._createGLContext(this.canvas,t),this.regl=Dm({gl:this.gl,attributes:t,extensions:ab.WEBGL_EXTENSIONS,optionalExtensions:ab.WEBGL_OPTIONAL_EXTENSIONS})}_createGLContext(t,e){const n=["webgl","experimental-webgl"];let i=null;for(let o=0;o<n.length;++o){try{i=t.getContext(n[o],e)}catch(t){}if(i)break}return i}clearCanvas(){super.clearCanvas(),this.regl&&this.regl.clear({color:[0,0,0,0],depth:1,stencil:255})}resizeCanvas(t){super.resizeCanvas(t);const e=this.canvas;e&&(!this.pickingFBO||this.pickingFBO.width===e.width&&this.pickingFBO.height===e.height||this.pickingFBO.resize(e.width,e.height),this.painter&&this.painter.resize(e.width,e.height))}onRemove(){super.onRemove(),this.painter&&(this.painter.delete(),delete this.painter),this._markerPainter&&(this._markerPainter.delete(),delete this._markerPainter),this._linePainter&&(this._linePainter.delete(),delete this._linePainter)}drawOutline(t){if(this._outlineAll&&(this.painter&&this.painter.outlineAll(t),this._markerPainter.outlineAll(t),this._linePainter.outlineAll(t)),this._outlineFeatures)for(let e=0;e<this._outlineFeatures.length;e++)this.painter&&this.painter.outline(t,this._outlineFeatures[e]),this._markerPainter.outline(t,this._outlineFeatures[e]),this._linePainter.outline(t,this._outlineFeatures[e])}outlineAll(){this._outlineAll=!0,this.setToRedraw()}outline(t){this._outlineFeatures||(this._outlineFeatures=[]);const e=[];for(let n=0;n<t.length;n++){const i=this.layer.getGeometryById(t[n]);if(i){const t=this.features[i[qF]];if(Array.isArray(t))for(let n=0;n<t.length;n++)e.push(t[n].id);else e.push(t.id)}}this._outlineFeatures.push(e),this.setToRedraw()}cancelOutline(){delete this._outlineAll,delete this._outlineFeatures,this.setToRedraw()}isEnableWorkAround(t){return"win-intel-gpu-crash"===t&&this.layer.options.workarounds["win-intel-gpu-crash"]&&dG(this.gl)}_getCentiMeterScale(t){return oL(t,this.getMap())}_onSpatialReferenceChange(){const t=this.layer.getGeometries();t&&this._convertGeometries(t),this._markRebuild()}_getLayerOpacity(){const t=this.layer.options.opacity;return this._isInGroupGLLayer()?eL(t)?1:t:1}}function fG(t){t.setToRedraw()}function dG(t){const e=t.getExtension("WEBGL_debug_renderer_info");if(e&&"undefined"!=typeof navigator){const n=t.getParameter(e.UNMASKED_RENDERER_WEBGL),i="Win32"===navigator.platform||"Win64"===navigator.platform;if(n&&n.toLowerCase().indexOf("intel")>=0&&i)return!0}return!1}function gG({properties:t}){const e=(lG+"markerFile").trim(),n=(lG+"markerType").trim();return t[e]||t[n]}function pG({properties:t}){return t[(lG+"textName").trim()]}const AG=(lG+"lineWidth").trim(),mG=(VF+"").trim();function yG(t){return 2===t.type&&!t.properties[mG]||3===t.type&&void 0!==t.properties[AG]}function _G(t){if(!Array.isArray(t))return 0;let e=0;for(let n=0;n<t.length;n++)e+=t[n];return e}function vG(t,e){if(Object.keys(t).sort().join()!==Object.keys(e.properties||{}).filter((t=>0===t.indexOf(lG))).map((t=>t.substring(lG.length))).sort().join())return!1;for(const n in t)if(rL(t,n)){const i=(lG+n).trim();if(mk(t[n])!==mk(e.properties[i]))return!1}return!0}function xG(t,e,n){if(!t||t.type!==e)return null;const i=new n(t.id,t.options),o=t.geometries,s=[];for(let t=0;t<o.length;t++){const e=cf.fromJSON(o[t]);e&&s.push(e)}return i.addGeometry(s),i}class Ma extends MD{static fromJSON(t){return xG(t,"PointLayer",Ma)}constructor(...t){super(...t),this.options.sceneConfig||(this.options.sceneConfig=QR({},AL))}getPolygonOffsetCount(){return 0}getPolygonOffset(){return 0}}Ma.mergeOptions({glyphSdfLimitPerFrame:15,iconErrorUrl:null,workarounds:{"win-intel-gpu-crash":!0},collision:!1,collisionFrameLimit:1}),Ma.registerJSONType("PointLayer"),Ma.registerRenderer("canvas",null),Ma.registerRenderer("gl",class extends ga{constructor(...t){super(...t),this.GeometryTypes=[ld,Ad]}onGeometryAdd(t){t&&(Array.isArray(t)?t.forEach((t=>{t.options.maxMarkerWidth=t.options.maxMarkerHeight=255})):t.options.maxMarkerWidth=t.options.maxMarkerHeight=255,super.onGeometryAdd(t))}});const{LinePack:bG}=ZR();class Ia extends MD{static fromJSON(t){return xG(t,"LineStringLayer",Ia)}}Ia.mergeOptions({meshRenderOrder:1}),Ia.registerJSONType("LineStringLayer");const wG=(VF+"").trim();Ia.registerRenderer("gl",class extends ga{constructor(...t){super(...t),this.GeometryTypes=[cd,yd]}createPainter(){const t=MD.get3DPainterClass("line-gradient");this.painterSymbol=QR({},{lineGradientProperty:wG},UF),this._defineSymbolBloom(this.painterSymbol,t.getBloomSymbol());const e=QR({},this.layer.options.sceneConfig||{});return void 0===e.depthMask&&(e.depthMask=!0),new t(this.regl,this.layer,this.painterSymbol,e,0)}buildMesh(){let{features:t,center:e}=this._getFeaturesToRender();if(t=t.filter((t=>!!t.properties[wG])),!t.length)return;const n=this._showHideUpdated;this._meshCenter=e;const i=QR({},this.painterSymbol),o=this.createMesh(this.painter,bG,i,t,null,e);this._isCreatingMesh=!0,o.then((t=>{this.meshes&&this.painter.deleteMesh(this.meshes);const e=[],i=t&&t.meshes;if(i){e.push(...i);for(let t=0;t<i.length;t++)i[t].feaGroupIndex=0,i[t].geometry.properties.originElements=i[t].geometry.properties.elements.slice()}this.meshes=e,n&&(this._showHideUpdated=n),this._isCreatingMesh=!1,this.setToRedraw()}))}}),Ia.registerRenderer("canvas",null);const{PolygonPack:TG}=ZR();class Fa extends MD{static fromJSON(t){return xG(t,"PolygonLayer",Fa)}}Fa.registerJSONType("PolygonLayer");const MG={polygonFill:{type:"identity",default:[1,1,1,1],property:"_symbol_polygonFill"},polygonPatternFile:{type:"identity",default:void 0,property:"_symbol_polygonPatternFile"},polygonOpacity:{type:"identity",default:1,property:"_symbol_polygonOpacity"},uvScale:{type:"identity",default:[1,1],property:"_symbol_uvScale"},uvOffset:{type:"identity",default:[0,0],property:"_symbol_uvOffset"},uvOffsetInMeter:{type:"identity",default:!1,property:"_symbol_uvOffsetInMeter"},polygonPatternFileWidth:{type:"identity",default:void 0,property:"_symbol_polygonPatternFileWidth"},polygonPatternFileHeight:{type:"identity",default:void 0,property:"_symbol_polygonPatternFileHeight"},polygonPatternFileOrigin:{type:"identity",default:void 0,property:"_symbol_polygonPatternFileOrigin"},polygonPatternUV:{type:"identity",default:void 0,property:"_symbol_polygonPatternUV"}};class Ra extends ga{constructor(){super(...arguments),this.GeometryTypes=[od,_d]}getPolygonOffsetCount(){return this.options.altitude>0?0:2}buildMesh(t){const{features:e,center:n}=this._getFeaturesToRender();if(!e.length)return;const i=this._showHideUpdated;this._meshCenter=n;const o=this._groupPolygonFeatures(e),s=QR({},MG),a=o.map(((e,i)=>this.createMesh(this.painter,TG,s,e,t&&t[i],n)));this._isCreatingMesh=!0,Promise.all(a).then((t=>{this.meshes&&this.painter.deleteMesh(this.meshes),t=function(t){const e=[];for(let n=0;n<t.length;n++)Array.isArray(t[n])?e.push(...t[n]):e.push(t[n]);return e}(t);const e=[],n=[];for(let i=0;i<t.length;i++){const o=t[i]&&t[i].meshes;if(o){e.push(...o);for(let t=0;t<o.length;t++)o[t].feaGroupIndex=i,o[t].geometry.properties.originElements=o[t].geometry.properties.elements.slice(),1===i&&(o[t].transparent=!0);n[i]=t[i].atlas}}this.meshes=e,this.atlas=n,i&&(this._showHideUpdated=i),this._isCreatingMesh=!1,this.setToRedraw(),this.layer.fire("buildmesh")}))}getRayCastData(t,e){const n=this.painter.getRayCastData(t,e);if(!n||!n.feature)return null;return this._geometries[n.feature[qF]]}_groupPolygonFeatures(t){const e=[],n=[];for(let i=0;i<t.length;i++){const o=t[i];o.properties&&o.properties._symbol_polygonOpacity<1?n.push(o):e.push(o)}return[e,n]}createPainter(){const t=MD.get3DPainterClass("fill"),e=this.painterSymbol=QR({},MG);return this._defineSymbolBloom(e,t.getBloomSymbol()),new t(this.regl,this.layer,e,this.layer.options.sceneConfig,0)}updateMesh(t){return this._updateMesh(t,this.meshes,this.atlas,this._meshCenter,this.painter,TG,MG,this._groupPolygonFeatures)}}function CG(t,e,n,i,o,s,a){const l=n&&Array.isArray(n[0]);for(let s=0,h=n.length;s<h;s++){t[e]=(l?n[s][0]:n[s].x)*i,t[e+1]=(l?n[s][1]:n[s].y)*i,a!==Float32Array&&(t[e]=Math.round(t[e]),t[e+1]=Math.round(t[e+1]));let h=o||0;Array.isArray(o)&&(h=o[s]),h=h?Math.round(i*h):0,t[e+2]=h,e+=3}return t.trySetLength&&t.trySetLength(e),e}Fa.registerRenderer("gl",Ra),Fa.registerRenderer("canvas",null);const SG=Math.PI/180,PG=6378137*Math.PI/180,IG=85.0511287798;function OG(t,e,n){return function(t,e){const n=IG,i=e[0],o=Math.max(Math.min(n,e[1]),-n);let s;return s=0===o?0:Math.log(Math.tan((90+o)*SG/2))/SG,t[0]=i*PG,t[1]=s*PG,t}(t,e)}function EG(t,e,n,i){const o=n[0]-i[0],s=n[1]-i[1];let a=(e[0]-n[0])*(n[0]-i[0])+(e[1]-n[1])*(n[1]-i[1]);return a/=o*o+s*s,t[0]=n[0]+a*o,t[1]=n[1]+a*s,t}function kG(t,e,n,i,o){return s=i,a=o,l=t[3*e[n-1]],h=t[3*e[n-1]+1],Math.sqrt((l-s)*(l-s)+(h-a)*(h-a));var s,a,l,h}const{PackUtil:RG,ArrayPool:LG}=ZR();function DG(t,e,n,i,o,s,a,l,h,c,u,f,g,A,m,w,T){const M=e.getLength(),C=o/3;for(let n=2,i=M;n<i;n+=3)t[o+n-2]=e[n-2],t[o+n-1]=e[n-1],t[o+n-0]=e[n]-a;o+=M;for(let n=2,i=M;n<i;n+=3)t[o+n-2]=e[n-2],t[o+n-1]=e[n-1],t[o+n-0]=e[n]-l;t.trySetLength((o+=M)+M),t.copyWithin(o,o-2*M,o-M),t.trySetLength((o+=M)+M),t.copyWithin(o,o-2*M,o-M),o+=M,(n=n||[]).push(M/3);const P=n.getLength();for(let e=0;e<P;e++)FG(C+(n[e-1]||0),C+n[e],t,M/3,h,i,c,u,f,g,s,A,m,w,T);return o}function FG(t,e,n,i,o,s,a,l,h,c,u,f,g,A,m){const w=s.getLength();let T,M;for(let n=t,a=e;n<a-1;n++)if(T=n,M=n+1,o===1/0)if((n-t)%2==1&&(T+=2*i,M+=2*i),m){let t=s.currentIndex;s[t++]=T+i,s[t++]=M,s[t++]=T,s[t++]=M+i,s[t++]=M,s[t++]=T+i,s.currentIndex=t}else{let t=s.currentIndex;s[t++]=T+i,s[t++]=T,s[t++]=M,s[t++]=M,s[t++]=M+i,s[t++]=T+i,s.currentIndex=t}a&&function(t,e,n,i,o,s,a,l,h,c,u,f){let g,A=0,m=0,w=0,T=0;const M=f?[1,3,4]:[2,3,4];for(let f=s.getLength()-1;f>=a;f--){const a=s[f],C=3*a+2,P=o[3*a],I=o[3*a+1],O=o[C];A||m||(A=Math.max(o[C],o[3*s[f-3]+2]),m=Math.min(o[C],o[3*s[f-3]+2]),g=A-m);let E=w;const D=f%6;0===t?(5===D&&(T=kG(o,s,f,P,I)),E=D===M[0]||D===M[1]||D===M[2]?w:w+T):1===t&&(D===M[0]||D===M[1]||D===M[2]?E=0:5===D?(T=kG(o,s,f,P,I),E=T):E=T);let N;N=1===e?O===A?1:0:"bottom"===n?O===A?g/100/h:0:O===A?0:-g/100/h,i[2*a]=E/c*(1/(100*u))/l,i[2*a+1]=N,0===D&&(w+=T)}}(l,h,c,u,n,s,w,f[0],f[1],g,A,m)}function NG(t){const e=[t[0]];let n=t[0];for(let i=1;i<t.length;i++)Array.isArray(t[i])?t[i][0]===n[0]&&t[i][1]===n[1]&&t[i][2]===n[2]||e.push(t[i]):t[i].x===n.x&&t[i].y===n.y&&t[i].z===n.z||e.push(t[i]),n=t[i];return e}const{StyleUtil:HG,PackUtil:BG,ArrayPool:zG}=ZR(),GG=zG.getInstance();function jG(t,e,n,i,o,s,a,l,h,c,u,f,g,A,m,w){void 0===e.top&&(e.top=!0),void 0===e.side&&(e.side=!0),GG.reset();const{altitudeScale:T,altitudeProperty:M,defaultAltitude:C,heightProperty:P,minHeightProperty:I,defaultHeight:O,tangent:E,uv:D,topUVMode:N,sideUVMode:H,sideVerticalUVMode:U,top:W,side:q,textureYOrigin:X,topThickness:J}=e,Q=!!w,Y=function(t,e,{altitudeScale:n,altitudeProperty:i,defaultAltitude:o,heightProperty:s,minHeightProperty:a,defaultHeight:l},{center:h,side:c,top:u,topThickness:f,uvOrigin:g,uv:A,uvSize:m,topUVMode:w,sideUVMode:T,sideVerticalUVMode:M,textureYOrigin:C,tileRatio:P,centimeterToPoint:I,verticalCentimeterToPoint:O,positionType:E,res:D,glScale:N,projectionCode:H},U,W){let q=e/t[0].extent;q=1;const X=e===1/0,J=W.get(),Q=W.get(),Y=W.get(),K=W.getProxy(),$=W.get(),tt=W.get(),et=W.get(),nt=!!A,it=!!u,rt=!!c,ot=nt?W.get():null;function st(t,n,i,o,s,a){let l=n;if(it){const c=$k(K,i,3);if(0===c.length)return n;let u=K.getLength(),A=$.currentIndex;for(let t=0;t<u;t++)$[A++]=K[t];if($.currentIndex=A,n+=K.getLength(),a)for(let e=2,n=c.length;e<n;e+=3)c[e]+=t/3,c[e-1]+=t/3,c[e-2]+=t/3;u=c.length,A=tt.currentIndex;for(let t=0;t<u;t++)tt[A++]=c[t];tt.currentIndex=A,nt&&function(t,e,n,i,o,s,a,l,h,c,u,f,g,A,m){0===t?function(t,e,n,i,o,s,a,l,h,c){const u=1/(100*s[0]),f=1/(100*s[1]),g=c&&c[0]||0,A=c&&c[1]||0,m=[0,0];for(let o=t;o<e;o+=3){const t=o/3*2,e=i[o+1]-A;n[t]=m[0]+(i[o]-g)/a*u/l,n[t+1]=m[1]-e/a*f/h}}(e,n,i,o,0,a,l,h,c,m):1===t&&function(t,e,n,i,o,s,a,l,h,c,u){if(!t)return;let f,g,A,m;0===t[4]?(f=t[0],g=t[1],A=t[2],m=t[3]):(f=t[1],g=t[2],A=t[3],m=t[0]);const w=Nv(f,g),T=Nv(g,A),M=[],C=[],P=[];for(let t=e;t<n;t+=3){const e=t/3*2;Ev(M,(s.x/h+o[t]/a)*l,s.y/h*l+(u?o[t+1]:-o[t+1])/a*l),"EPSG:4326"!==c&&"EPSG:4490"!==c||OG(M,M),EG(C,M,f,g),EG(P,M,m,f),i[e]=Nv(f,C)/w,i[e+1]=Nv(f,P)/T}}(u,e,n,i,o,s,l,f,g,A,!!m)}(w||0,t,n,ot,$,g,I,P,m[0],m[1],s,D,N,H,h),f>0&&!rt&&(n=DG($,K,i,tt,n,ot,0,f,e,nt,T||0,M||0,C,m,P,O,o<0?!a:a)),et.setLength(n/3),et.fill(1,l/3,n/3)}if(rt){it&&(f=0),l=n,n=DG($,K,i,tt,n,ot,f,o,e,nt,T||0,M||0,C,m,P,O,o<0?!a:a),et.setLength(n/3);const t=K.getLength()/3;et.fill(1,l/3,l/3+t),et.fill(0,l/3+t,l/3+2*t),et.fill(1,l/3+2*t,l/3+3*t),et.fill(0,l/3+3*t,n/3)}return n}let at=-1/0,ut=1/0,ft=0,gt=0,vt=t.length;KR(U)&&(gt=U,vt=U+1);let xt=0,bt=!1;const Ct=W.getProxy();let Ot=!1;for(;gt<vt;gt++){const e=t[gt],h=e.id;KR(h)&&(Math.abs(h)>xt&&(xt=Math.abs(h)),h<0&&(bt=!0));const c=e.geometry,u=e.properties[CL];let f=Array.isArray(u&&u[0]&&u[0][0])?u[0]:u;const{altitude:g,height:A}=RG.getFeaAltitudeAndHeight(e,n,i,o,s,l,a);A<0?(Ot=!0,ut=Math.min(g,ut),at=Math.max(g-A,at)):(at=Math.max(g,at),ut=Math.min(g-A,ut));const m=$.getLength();let w=0,T=ft;Ct.setLength(0),K.setLength(0);const M=RG.calculateSignedArea(c[0])<0;for(let t=0,e=c.length;t<e;t++){let n=c[t];M&&(n=n.reverse()),n=NG(n);const i=RG.calculateSignedArea(n)<0;if(!i&&t>0&&(w++,f=u&&u[w],ft=st(T,ft,Ct,1*A,f,X),K.setLength(0),Ct.setLength(0),T=ft),!n.length){t===e-1&&(ft=st(T,ft,Ct,1*A,f,X));continue}const o=n.length;if(Array.isArray(n[0])?n[0][0]===n[o-1][0]&&n[0][1]===n[o-1][1]||n.push([n[0][0],n[0][1]]):n[0].x===n[o-1].x&&n[0].y===n[o-1].y||n.push(n[0]),i){let t=Ct.currentIndex;Ct[t++]=K.getLength()/3,Ct.currentIndex=t}CG(K,K.getLength(),n,1,g,0,E),t===e-1&&(ft=st(T,ft,Ct,1*A,f,X))}const C=$.getLength()-m,P=(wL+"").trim();for(let t=0;t<C/3;t++){let t=Q.currentIndex;Q[t++]=void 0===e[P]?gt:e[P],Q.currentIndex=t,t=J.currentIndex,J[t++]=gt,J.currentIndex=t,KR(h)&&(t=Y.currentIndex,Y[t++]=h,Y.currentIndex=t)}}const Gt=RG.getUnsignedArrayType(Q.getLength()?Q[Q.getLength()-1]:0),$t={hasNegativeHeight:Ot,maxAltitude:at===-1/0?0:at,minAltitude:ut===1/0?0:ut,vertices:$,verticeTypes:et,indices:tt,pickingIds:LG.createTypedArray(Q,Gt),featureIndexes:J};if(Y.getLength()){const t=bt?RG.getPosArrayType(xt):RG.getUnsignedArrayType(xt);$t.featureIds=LG.createTypedArray(Y,t)}else $t.featureIds=[];return ot&&(ot.setLength($.getLength()/3*2),$t.uvs=ot),$t}(t,n,{altitudeScale:T,altitudeProperty:M,defaultAltitude:C||0,heightProperty:P,minHeightProperty:I,defaultHeight:O||0},{center:w,top:W,side:q,topThickness:10*J||0,uv:D||E,uvSize:[o,o],uvOrigin:i,topUVMode:N,sideUVMode:H,sideVerticalUVMode:U,textureYOrigin:X,tileRatio:l,centimeterToPoint:h,verticalCentimeterToPoint:c,positionType:m,res:s,glScale:a,projectionCode:g},A,GG),K=[],$=Y.vertices.getLength()/3,tt=BG.getIndexArrayType($),et=zG.createTypedArray(Y.indices,tt);delete Y.indices,K.push(et.buffer,Y.pickingIds.buffer);const nt=Math.max(Math.abs(Y.maxAltitude),Math.abs(Y.minAltitude)),it=m||BG.getPosArrayType(Math.max(512,nt));Y.vertices=zG.createTypedArray(Y.vertices,it);const rt=E?GG.getProxy():new Float32Array(3*$);rt.setLength&&rt.setLength(3*$);const ot=vx(Y.vertices,et,rt);let st=!0;const at=ot.getLength?ot.getLength():ot.length;for(let t=0;t<at;t++){Q||(ot[t]=-ot[t]);const e=ot[t]%1;1-Math.abs(e)>1e-6?st=!1:0!==e&&(ot[t]=Math.round(ot[t]))}if(Y.normals=ot,E){let t=GG.get();t.setLength(4*$),t=Ix(Y.vertices,Y.normals,Y.uvs,et,t),t=function(t,e){const n=e.getLength(),i=new Float32Array(n),o=[],s=[],a=[];for(let l=0;l<n;l+=4){const n=l/4*3;Fy(s,t[n]||0,t[n+1]||0,t[n+2]||0),g_(o,e[l]||0,e[l+1]||0,e[l+2]||0,e[l+3]||0),yx(a,s,o),d_(i.subarray(l,l+4),a)}return i}(Y.normals,t),Y.tangents=t,K.push(t.buffer),delete Y.normals}if(Y.normals&&(st&&(Y.normals=zG.createTypedArray(Y.normals,Int8Array)),K.push(Y.normals.buffer)),Y.uvs){Y.uvs=zG.createTypedArray(Y.uvs,Float32Array),K.push(Y.uvs.buffer)}if(w){const t=Y.vertices,e=t.length;for(let n=0;n<e;n+=3)t[n]-=w[0],t[n+1]-=w[1]}const ut=function(t,e,n,i){const o={},s={},a=i.getLength();if(iL(e.polygonFill)){let l=vk(e.polygonFill);const h=new Uint8Array(4*a);h.fill(255);for(let e=0;e<a;e++){const s=t[i[e]],a=s.properties||{};a.$layer=s.layer,a.$type=s.type;let c=l(n,a);mk(c)&&(o.aColor=1,l=vk(c),c=l(n,a)),delete a.$layer,delete a.$type,HG.normalizeColor(UG,c),h[4*e]=UG[0],h[4*e+1]=UG[1],h[4*e+2]=UG[2],h[4*e+3]=UG[3]}s.aColor=h}if(iL(e.polygonOpacity)){let l=_k(e.polygonOpacity);const h=new Uint8Array(a);h.fill(255);for(let e=0;e<a;e++){const s=t[i[e]],a=s.properties||{};a.$layer=s.layer,a.$type=s.type;let c=l(n,a);mk(c)&&(o.aOpacity=1,l=vk(c),c=l(n,a)),delete a.$layer,delete a.$type,h[e]=255*c}s.aOpacity=h}return s.dynamicAttributes=o,s}(t,u,f,Y.featureIndexes),ft=function(t,e,n,i,o){const s=[[],[]],a=iL(i.topPolygonFill),l=iL(i.bottomPolygonFill),h=[255,255,255,255],c=e.getLength();if(a||l){let u=a&&vk(i.topPolygonFill),f=l&&vk(i.bottomPolygonFill),g=null,A=null,m=null,w=null;for(let i=0;i<c;i++){if(1===t[i]&&!a||0===t[i]&&!l)continue;const c=1===t[i];if(c&&e[i]===g){t[i]=m;continue}if(!c&&e[i]===A){t[i]=w;continue}const T=n[e[i]],M=T.properties||{};M.$layer=T.layer,M.$type=T.type;let C=c?u:f,P=C(o,M);mk(P)&&(C=vk(P),P=C(o,M)),delete M.$layer,delete M.$type,HG.normalizeColor(UG,P),y_(UG,UG,h);let I=VG(s,UG);I<0&&(I=s.length,s.push(d_([],UG))),t[i]=I,c?(g=e[i],m=I):(A=e[i],w=I)}}return s.slice(2)}(Y.verticeTypes,Y.featureIndexes,t,u,f),gt={data:{data:{aVertexColorType:zG.createTypedArray(Y.verticeTypes,ft.length<=252?Uint8Array:Uint16Array),aPosition:Y.vertices,aNormal:Y.normals,aTexCoord0:Y.uvs,aTangent:Y.tangents,aPickingId:Y.pickingIds},indices:et,properties:{maxAltitude:Y.maxAltitude/100,minAltitude:Y.minAltitude/100,hasNegativeHeight:Y.hasNegativeHeight},dynamicAttributes:ut.dynamicAttributes,vertexColors:ft},buffers:K};return Y.featureIds.length?(gt.data.featureIds=Y.featureIds,K.push(gt.data.featureIds.buffer)):gt.data.featureIds=[],ut.aColor&&(gt.data.data.aColor=ut.aColor,gt.buffers.push(ut.aColor.buffer)),ut.aOpacity&&(gt.data.data.aOpacity=ut.aOpacity,gt.buffers.push(ut.aOpacity.buffer)),gt.buffers.push(gt.data.data.aPosition.buffer),gt.data.pickingIdIndiceMap=BG.generatePickingIndiceIndex(gt.data.data.aPickingId,gt.data.indices),gt}const UG=[];function VG(t,e){for(let n=0;n<t.length;n++)if(P_(e,t[n]))return n;return-1}ZR();class tl{constructor(t=[],e=WG){if(this.data=t,this.length=this.data.length,this.compare=e,this.length>0)for(let t=(this.length>>1)-1;t>=0;t--)this._down(t)}push(t){this.data.push(t),this.length++,this._up(this.length-1)}pop(){if(0===this.length)return;const t=this.data[0],e=this.data.pop();return this.length--,this.length>0&&(this.data[0]=e,this._down(0)),t}peek(){return this.data[0]}_up(t){const{data:e,compare:n}=this,i=e[t];for(;t>0;){const o=t-1>>1,s=e[o];if(n(i,s)>=0)break;e[t]=s,t=o}e[t]=i}_down(t){const{data:e,compare:n}=this,i=this.length>>1,o=e[t];for(;t<i;){let i=1+(t<<1),s=e[i];const a=i+1;if(a<this.length&&n(e[a],s)<0&&(i=a,s=e[a]),n(s,o)>=0)break;e[t]=s,t=i}e[t]=o}}function WG(t,e){return t<e?-1:t>e?1:0}var ZG={exports:{}},qG=function(t,e,n,i){var o=t[0],s=t[1],a=!1;void 0===n&&(n=0),void 0===i&&(i=e.length);for(var l=(i-n)/2,h=0,c=l-1;h<l;c=h++){var u=e[n+2*h+0],f=e[n+2*h+1],g=e[n+2*c+1];f>s!=g>s&&o<(e[n+2*c+0]-u)*(s-f)/(g-f)+u&&(a=!a)}return a},XG=function(t,e,n,i){var o=t[0],s=t[1],a=!1;void 0===n&&(n=0),void 0===i&&(i=e.length);for(var l=i-n,h=0,c=l-1;h<l;c=h++){var u=e[h+n][0],f=e[h+n][1],g=e[c+n][1];f>s!=g>s&&o<(e[c+n][0]-u)*(s-f)/(g-f)+u&&(a=!a)}return a};ZG.exports=function(t,e,n,i){return e.length>0&&Array.isArray(e[0])?XG(t,e,n,i):qG(t,e,n,i)};var JG=ZG.exports.nested=XG;ZG.exports.flat=qG;const QG=11102230246251565e-32,YG=134217729,KG=(3+8*QG)*QG;function $G(t,e,n,i,o){let s,a,l,h,c=e[0],u=i[0],f=0,g=0;u>c==u>-c?(s=c,c=e[++f]):(s=u,u=i[++g]);let A=0;if(f<t&&g<n)for(u>c==u>-c?(a=c+s,l=s-(a-c),c=e[++f]):(a=u+s,l=s-(a-u),u=i[++g]),s=a,0!==l&&(o[A++]=l);f<t&&g<n;)u>c==u>-c?(a=s+c,h=a-s,l=s-(a-h)+(c-h),c=e[++f]):(a=s+u,h=a-s,l=s-(a-h)+(u-h),u=i[++g]),s=a,0!==l&&(o[A++]=l);for(;f<t;)a=s+c,h=a-s,l=s-(a-h)+(c-h),c=e[++f],s=a,0!==l&&(o[A++]=l);for(;g<n;)a=s+u,h=a-s,l=s-(a-h)+(u-h),u=i[++g],s=a,0!==l&&(o[A++]=l);return 0===s&&0!==A||(o[A++]=s),A}function tj(t){return new Float64Array(t)}const ej=33306690738754716e-32,nj=22204460492503146e-32,ij=11093356479670487e-47,rj=tj(4),oj=tj(8),sj=tj(12),aj=tj(16),lj=tj(4);function hj(t,e,n,i,o,s,a){for(var l=new tl([],cj),h=t.data;h;){for(var c=0;c<h.children.length;c++){var u=h.children[c],f=h.leaf?yj(u,n,i):uj(n,i,u);f>s||l.push({node:u,dist:f})}for(;l.length&&!l.peek().node.children;){var g=l.pop(),A=g.node,m=yj(A,e,n),w=yj(A,i,o);if(g.dist<m&&g.dist<w&&dj(n,A,a)&&dj(i,A,a))return A}(h=l.pop())&&(h=h.node)}return null}function cj(t,e){return t.dist-e.dist}function uj(t,e,n){if(fj(t,n)||fj(e,n))return 0;var i=_j(t[0],t[1],e[0],e[1],n.minX,n.minY,n.maxX,n.minY);if(0===i)return 0;var o=_j(t[0],t[1],e[0],e[1],n.minX,n.minY,n.minX,n.maxY);if(0===o)return 0;var s=_j(t[0],t[1],e[0],e[1],n.maxX,n.minY,n.maxX,n.maxY);if(0===s)return 0;var a=_j(t[0],t[1],e[0],e[1],n.minX,n.maxY,n.maxX,n.maxY);return 0===a?0:Math.min(i,o,s,a)}function fj(t,e){return t[0]>=e.minX&&t[0]<=e.maxX&&t[1]>=e.minY&&t[1]<=e.maxY}function dj(t,e,n){for(var i,o,s,a,l=Math.min(t[0],e[0]),h=Math.min(t[1],e[1]),c=Math.max(t[0],e[0]),u=Math.max(t[1],e[1]),f=n.search({minX:l,minY:h,maxX:c,maxY:u}),g=0;g<f.length;g++)if(o=f[g].next.p,s=t,(i=f[g].p)!==(a=e)&&o!==s&&gj(i,o,s)>0!=gj(i,o,a)>0&&gj(s,a,i)>0!=gj(s,a,o)>0)return!1;return!0}function gj(t,e,n){return function(t,e,n,i,o,s){const a=(e-s)*(n-o),l=(t-o)*(i-s),h=a-l;if(0===a||0===l||a>0!=l>0)return h;const c=Math.abs(a+l);return Math.abs(h)>=ej*c?h:-function(t,e,n,i,o,s,a){let l,h,c,u,f,g,A,m,w,T,M,C,P,I,O,E,D,N;const H=t-o,U=n-o,W=e-s,q=i-s;I=H*q,g=YG*H,A=g-(g-H),m=H-A,g=YG*q,w=g-(g-q),T=q-w,O=m*T-(I-A*w-m*w-A*T),E=W*U,g=YG*W,A=g-(g-W),m=W-A,g=YG*U,w=g-(g-U),T=U-w,D=m*T-(E-A*w-m*w-A*T),M=O-D,f=O-M,rj[0]=O-(M+f)+(f-D),C=I+M,f=C-I,P=I-(C-f)+(M-f),M=P-E,f=P-M,rj[1]=P-(M+f)+(f-E),N=C+M,f=N-C,rj[2]=C-(N-f)+(M-f),rj[3]=N;let X=function(t,e){let n=e[0];for(let t=1;t<4;t++)n+=e[t];return n}(0,rj),J=nj*a;if(X>=J||-X>=J)return X;if(f=t-H,l=t-(H+f)+(f-o),f=n-U,c=n-(U+f)+(f-o),f=e-W,h=e-(W+f)+(f-s),f=i-q,u=i-(q+f)+(f-s),0===l&&0===h&&0===c&&0===u)return X;if(J=ij*a+KG*Math.abs(X),X+=H*u+q*l-(W*c+U*h),X>=J||-X>=J)return X;I=l*q,g=YG*l,A=g-(g-l),m=l-A,g=YG*q,w=g-(g-q),T=q-w,O=m*T-(I-A*w-m*w-A*T),E=h*U,g=YG*h,A=g-(g-h),m=h-A,g=YG*U,w=g-(g-U),T=U-w,D=m*T-(E-A*w-m*w-A*T),M=O-D,f=O-M,lj[0]=O-(M+f)+(f-D),C=I+M,f=C-I,P=I-(C-f)+(M-f),M=P-E,f=P-M,lj[1]=P-(M+f)+(f-E),N=C+M,f=N-C,lj[2]=C-(N-f)+(M-f),lj[3]=N;const Q=$G(4,rj,4,lj,oj);I=H*u,g=YG*H,A=g-(g-H),m=H-A,g=YG*u,w=g-(g-u),T=u-w,O=m*T-(I-A*w-m*w-A*T),E=W*c,g=YG*W,A=g-(g-W),m=W-A,g=YG*c,w=g-(g-c),T=c-w,D=m*T-(E-A*w-m*w-A*T),M=O-D,f=O-M,lj[0]=O-(M+f)+(f-D),C=I+M,f=C-I,P=I-(C-f)+(M-f),M=P-E,f=P-M,lj[1]=P-(M+f)+(f-E),N=C+M,f=N-C,lj[2]=C-(N-f)+(M-f),lj[3]=N;const Y=$G(Q,oj,4,lj,sj);I=l*u,g=YG*l,A=g-(g-l),m=l-A,g=YG*u,w=g-(g-u),T=u-w,O=m*T-(I-A*w-m*w-A*T),E=h*c,g=YG*h,A=g-(g-h),m=h-A,g=YG*c,w=g-(g-c),T=c-w,D=m*T-(E-A*w-m*w-A*T),M=O-D,f=O-M,lj[0]=O-(M+f)+(f-D),C=I+M,f=C-I,P=I-(C-f)+(M-f),M=P-E,f=P-M,lj[1]=P-(M+f)+(f-E),N=C+M,f=N-C,lj[2]=C-(N-f)+(M-f),lj[3]=N;const K=$G(Y,sj,4,lj,aj);return aj[K-1]}(t,e,n,i,o,s,c)}(t[0],t[1],e[0],e[1],n[0],n[1])}function pj(t){var e=t.p,n=t.next.p;return t.minX=Math.min(e[0],n[0]),t.minY=Math.min(e[1],n[1]),t.maxX=Math.max(e[0],n[0]),t.maxY=Math.max(e[1],n[1]),t}function Aj(t,e){var n={p:t,prev:null,next:null,minX:0,minY:0,maxX:0,maxY:0};return e?(n.next=e.next,n.prev=e,e.next.prev=n,e.next=n):(n.prev=n,n.next=n),n}function mj(t,e){var n=t[0]-e[0],i=t[1]-e[1];return n*n+i*i}function yj(t,e,n){var i=e[0],o=e[1],s=n[0]-i,a=n[1]-o;if(0!==s||0!==a){var l=((t[0]-i)*s+(t[1]-o)*a)/(s*s+a*a);l>1?(i=n[0],o=n[1]):l>0&&(i+=s*l,o+=a*l)}return(s=t[0]-i)*s+(a=t[1]-o)*a}function _j(t,e,n,i,o,s,a,l){var h,c,u,f,g=n-t,A=i-e,m=a-o,w=l-s,T=t-o,M=e-s,C=g*g+A*A,P=g*m+A*w,I=m*m+w*w,O=g*T+A*M,E=m*T+w*M,D=C*I-P*P,N=D,H=D;0===D?(c=0,N=1,f=E,H=I):(f=C*E-P*O,(c=P*E-I*O)<0?(c=0,f=E,H=I):c>N&&(c=N,f=E+P,H=I)),f<0?(f=0,-O<0?c=0:-O>C?c=N:(c=-O,N=C)):f>H&&(f=H,-O+P<0?c=0:-O+P>C?c=N:(c=-O+P,N=C));var U=(1-(u=0===f?0:f/H))*o+u*a-((1-(h=0===c?0:c/N))*t+h*n),W=(1-u)*s+u*l-((1-h)*e+h*i);return U*U+W*W}function vj(t,e){return t[0]===e[0]?t[1]-e[1]:t[0]-e[0]}const{PackUtil:xj}=ZR();class Dl{constructor(t,e){this.x=t,this.y=e}clone(){return new Dl(this.x,this.y)}normalize(){const t=this.length();this.x/=t,this.y/=t}negate(){this.x=-this.x,this.y=-this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}diff(t){return new Dl(this.x-t.x,this.y-t.y)}distance(t){const e=this.x-t.x,n=this.y-t.y;return Math.sqrt(e*e+n*n)}dot(t){return this.x*t.x+this.y*t.y}equals(t){return this.x===t.x&&this.y===t.y}orthogonal(){return new Dl(this.y,-this.x)}}function bj(t,e,n,i){const o=((n.x-t.x)*i.y-(n.y-t.y)*i.x)/(e.x*i.y-e.y*i.x);return new Dl(t.x+o*e.x,t.y+o*e.y)}const wj=[],Tj=[];function Mj(t){if(KR(t[0]&&t[0].x)){const e=[];let n=0;for(let i=0;i<t.length;i++)Tj[n]?(Tj[n][0]=t[i].x,Tj[n][1]=t[i].y):Tj[n]=[t[i].x,t[i].y],e.push(Tj[n]),n++;t=e}try{const e=function(t,e,n){e=Math.max(0,void 0===e?2:e),n=n||0;var i=function(t){for(var e=t[0],n=t[0],i=t[0],o=t[0],s=0;s<t.length;s++){var a=t[s];a[0]<e[0]&&(e=a),a[0]>i[0]&&(i=a),a[1]<n[1]&&(n=a),a[1]>o[1]&&(o=a)}var l=[e,n,i,o],h=l.slice();for(s=0;s<t.length;s++)JG(t[s],l)||h.push(t[s]);return function(t){t.sort(vj);for(var e=[],n=0;n<t.length;n++){for(;e.length>=2&&gj(e[e.length-2],e[e.length-1],t[n])<=0;)e.pop();e.push(t[n])}for(var i=[],o=t.length-1;o>=0;o--){for(;i.length>=2&&gj(i[i.length-2],i[i.length-1],t[o])<=0;)i.pop();i.push(t[o])}return i.pop(),e.pop(),e.concat(i)}(h)}(t),o=new RBush(16);o.toBBox=function(t){return{minX:t[0],minY:t[1],maxX:t[0],maxY:t[1]}},o.compareMinX=function(t,e){return t[0]-e[0]},o.compareMinY=function(t,e){return t[1]-e[1]},o.load(t);for(var s,a=[],l=0;l<i.length;l++){var h=i[l];o.remove(h),s=Aj(h,s),a.push(s)}var c=new RBush(16);for(l=0;l<a.length;l++)c.insert(pj(a[l]));for(var u=e*e,f=n*n;a.length;){var g=a.shift(),A=g.p,m=g.next.p,w=mj(A,m);if(!(w<f)){var T=w/u;(h=hj(o,g.prev.p,A,m,g.next.next.p,T,c))&&Math.min(mj(h,A),mj(h,m))<=T&&(a.push(g),a.push(Aj(h,g)),o.remove(h),c.remove(g),c.insert(pj(g)),c.insert(pj(g.next)))}}g=s;var M=[];do{M.push(g.p),g=g.next}while(g!==s);return M.push(g.p),M}(t,1/0);let n=[1/0,1/0],i=[-1/0,-1/0];for(let t=0;t<e.length;t++)e[t][0]<n[0]&&(n[0]=e[t][0]),e[t][0]>i[0]&&(i[0]=e[t][0]),e[t][1]<n[1]&&(n[1]=e[t][1]),e[t][1]>i[1]&&(i[1]=e[t][1]);const o=[];let s=[],a=0;for(let t=0;t<e.length;t++)t===e.length-1&&e[t][0]===e[0][0]&&e[t][1]===e[0][1]||(OG(o,e[t]),wj[a]?(wj[a].x=o[0],wj[a].y=o[1]):wj[a]=new Dl(o[0],o[1]),s.push(wj[a]),a++);xj.calculateSignedArea(s)<0&&(s=s.reverse());const l=function(t){let e,n=Number.MAX_VALUE;const i=function(t,i,o,s,a,l,h,c){var u=bj(t,i,a,l),f=bj(o,s,a,l),g=bj(h,c,t,i),A=bj(h,c,o,s),m=u.distance(f)*u.distance(g);0!==m&&m<n&&(e=[u,g,A,f],n=m)};var o=[];for(let e=0;e<t.length;e++)o.push(t[(e+1)%t.length].diff(t[e])),o[e].normalize();var s,a,l,h,c=new Dl(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),u=new Dl(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let e=0;e<t.length;e++){var f=t[e];f.x<c.x&&(c.x=f.x,s=e),f.x>u.x&&(u.x=f.x,a=e),f.y<c.y&&(c.y=f.y,h=e),f.y>u.y&&(u.y=f.y,l=e)}var g=new Dl(0,-1),A=new Dl(0,1),m=new Dl(-1,0),w=new Dl(1,0);for(let e=0;e<t.length;e++){var T=[Math.acos(g.dot(o[s])),Math.acos(A.dot(o[a])),Math.acos(m.dot(o[l])),Math.acos(w.dot(o[h]))];switch(T.indexOf(Math.min.apply(Math,T))){case 0:(A=(g=o[s].clone()).clone()).negate(),(w=(m=g.orthogonal()).clone()).negate(),s=(s+1)%t.length;break;case 1:(g=(A=o[a].clone()).clone()).negate(),(w=(m=g.orthogonal()).clone()).negate(),a=(a+1)%t.length;break;case 2:(w=(m=o[l].clone()).clone()).negate(),(A=(g=w.orthogonal()).clone()).negate(),l=(l+1)%t.length;break;case 3:(m=(w=o[h].clone()).clone()).negate(),(A=(g=w.orthogonal()).clone()).negate(),h=(h+1)%t.length}i(t[s],g,t[a],A,t[l],m,t[h],w)}return e}(s);if(!l||4!==l.length)return null;const h=l[0].distance(l[1]),c=l[1].distance(l[2]),u=l.map((t=>[t.x,t.y]));return u.push(+(c>h)),u}catch(t){return null}}const{DEFAULT_TEX_WIDTH:Cj}=ZR();class Ul extends MD{static fromJSON(t){return xG(t,"ExtrudePolygonLayer",Ul)}getPolygonOffsetCount(){return 0}getPolygonOffset(){return 0}onConfig(t){const e=this.getRenderer();return e&&e.onConfig(t),super.onConfig(t)}updateMaterial(t){this.options.material||(this.options.material={}),t?QR(this.options.material,t):this.options.material=null;const e=this.getRenderer();return e&&e.updateMaterial(t),this}updateSideMaterial(t){let e=!1;this.options.sideMaterial||(this.options.sideMaterial={},e=!0),t?QR(this.options.sideMaterial,t):this.options.sideMaterial=null;const n=this.getRenderer();return n&&(e&&n._deleteSideMaterial(),n.updateSideMaterial(t)),this}updateDataConfig(t){if(!t)return this;this.options.dataConfig||(this.options.dataConfig={});const e=JSON.parse(JSON.stringify(this.options.dataConfig));QR(this.options.dataConfig,t);const n=this.getRenderer();return n&&n.updateDataConfig(t,e),this}}Ul.registerJSONType("ExtrudePolygonLayer"),Ul.mergeOptions({cullFace:!1,castShadow:!0});const Sj={polygonFill:{type:"identity",default:[1,1,1,1],property:"_symbol_polygonFill"},polygonOpacity:{type:"identity",default:1,property:"_symbol_polygonOpacity"},topPolygonFill:{type:"identity",default:[1,1,1,1],property:"_symbol_topPolygonFill"},bottomPolygonFill:{type:"identity",default:[1,1,1,1],property:"_symbol_bottomPolygonFill"}},Pj={defaultAltitude:20},Ij=t=>1===t.properties.top;Ul.registerRenderer("gl",class extends Ra{constructor(...t){super(...t),this.GeometryTypes=[od,_d]}_groupPolygonFeatures(t){return[t]}onConfig(t){this.painter&&(eL(t.cullFace)||this.painter.updateSceneConfig({cullFace:t.cullFace}))}updateMaterial(t){this.painter&&(this.painter._updateMaterial(t),this.layer.options.sideMaterial||this.sidePainter._updateMaterial(t),this.setToRedraw())}_deleteSideMaterial(){this.sidePainter&&this.sidePainter.deleteMaterial()}updateSideMaterial(t){this.sidePainter&&(t?this.sidePainter._updateMaterial(t):(this.sidePainter.deleteMaterial(),this.sidePainter._updateMaterial(this.layer.options.material)),this.setToRedraw())}updateDataConfig(t,e){this.painter&&(this.painter.updateDataConfig(t,e),this._markRebuild())}updateBloom(t){super.updateBloom(t),this.sidePainter&&this._updatePainterBloom(this.sidePainter,this.sidePainterSymbol,t)}needCheckPointLineSymbols(){return!1}draw(t,e){return super.draw(t,e)}createPainter(){const t=MD.get3DPainterClass("lit");this.painterSymbol=QR({},Sj),this.sidePainterSymbol=QR({},Sj),this._defineSymbolBloom(this.painterSymbol,t.getBloomSymbol());const e=this.layer,n=QR({},Pj,e.options.dataConfig||{});e.options.material&&(this.painterSymbol.material=e.options.material),this.sidePainterSymbol.material=e.options.sideMaterial?e.options.sideMaterial:e.options.material;const i={cullFace:e.options.cullFace};Object.defineProperty(i,"castShadow",{enumerable:!0,get:()=>e.options.castShadow}),Object.defineProperty(i,"depthMask",{enumerable:!0,get:()=>e.options.depthMask});const o=QR({},n);o.upsideUpTexture=!0;const s=new t(this.regl,e,this.painterSymbol,i,0,o);return this.sidePainter=new t(this.regl,e,this.sidePainterSymbol,i,0,n),s}_startFrame(...t){super._startFrame(...t);const e=this.painter;this.painter=this.sidePainter,super._startFrame(...t),this.painter=e}_renderMeshes(...t){const e=t[0],n=e.sceneFilter;e.sceneFilter=t=>(!n||n(t))&&Ij(t);const i=super._renderMeshes(...t);e.sceneFilter=t=>(!n||n(t))&&Ij(t);const o=this.painter;this.painter=this.sidePainter;const s=e.sceneFilter=t=>(!n||n(t))&&(t=>1===t.properties.side)(t);return super._renderMeshes(...t),this.painter=o,e.sceneFilter=n,{redraw:i.redraw||s.redraw,drawCount:(i.drawCount||0)+(s.drawCount||0)}}createMesh(t,e,n,i,o,s){const a=[];this._extrudeCenter=s;const l=this._createPackData(i,n,!0,!1),h=this._createPackData(i,n,!1,!0);if(l){const o=this._createMesh(l,t,e,n,i,null,s);o.meshes[0].properties.top=1,a.push(o)}if(h){const o=this._createMesh(h,t,e,n,i,null,s);o.meshes[0].properties.side=1,a.push(o)}return a}_createPackData(t,e,n,i){const o=this.getMap();e=Sj;const s=this._extrudeCenter,a=o.getZoom(),l=new _e(0,0),h=new gh(0,0),c=QR({},Pj,this.layer.options.dataConfig);if(c.uv=!0,c.top&&(c.top=n),c.side&&(c.side=i),!1===c.top&&!1===c.side)return null;if(!t.length)return null;const u=o.getGLRes(),f=o.getProjection().code,g=n?this.painterSymbol&&this.painterSymbol.material:this.sidePainterSymbol&&this.sidePainterSymbol.material,A=g&&g.textureWidth||Cj,m=[QL(o,1,h,u)/100,QL(o,1,h,u,1)/100];return jG(t,c,1/0,l,A,o.getGLRes(),1,1,m,this._zScale,e,a,f,void 0,Float32Array,s)}updateMesh(t){let e=this.features[t[qF]];if(!e||!this.meshes)return;const n=this._createPackData([e],this.painterSymbol,!0,!1);let i=0;n&&n.data&&this._updateMeshData(this.meshes[i++],e.id,n);const o=this._createPackData([e],this.painterSymbol,!1,!0);o&&o.data&&this._updateMeshData(this.meshes[i++],e.id,o)}_convertGeo(t){if(t.getProperties()||t.setProperties({}),!t.getProperties()[CL]){const e=t.getCoordinates();if(t instanceof _d){const n=[];for(let t=0;t<e.length;t++){n[t]=Mj(e[t]&&e[t][0])}t.getProperties()[CL]=n}else{const n=Mj(e[0]);t.getProperties()[CL]=n}}return super._convertGeo(t)}resizeCanvas(t){super.resizeCanvas(t),this.sidePainter&&this.sidePainter.resize(this.canvas.width,this.canvas.height)}onRemove(){super.onRemove(),this.sidePainter&&(this.sidePainter.delete(),delete this.sidePainter)}drawOutline(t){if(super.drawOutline(t),this._outlineAll&&this.sidePainter&&this.sidePainter.outlineAll(t),this._outlineFeatures)for(let e=0;e<this._outlineFeatures.length;e++)this.sidePainter&&this.sidePainter.outline(t,this._outlineFeatures[e])}getShadowMeshes(){return this.painter?this.painter.getShadowMeshes():[]}}),Ul.registerRenderer("canvas",null);const{PackUtil:Oj,FilterUtil:Ej,SYMBOLS_NEED_REBUILD_IN_VT:kj,SYMBOLS_NEED_REBUILD_IN_VECTOR:Rj}=ZR();kw.register("vt_position_vert","#ifdef HAS_TERRAIN_ALTITUDE\n    attribute float aTerrainAltitude;\n#endif\nuniform float minAltitude;\nvec3 unpackVTPosition(vec2 aPosition, float aAltitude) {\n    float altitude = aAltitude;\n    #ifdef HAS_TERRAIN_ALTITUDE\n        altitude += aTerrainAltitude * 100.0;\n    #endif\n    altitude += minAltitude * 100.0;\n    return vec3(aPosition, altitude);\n}\n#ifdef HAS_ALTITUDE\n    vec3 unpackVTPosition(vec3 offset) {\n        return unpackVTPosition(aPosition + offset.xy, aAltitude + offset.z);\n    }\n    vec3 unpackVTPosition() {\n        return unpackVTPosition(aPosition, aAltitude);\n    }\n#else\n    float position_modValue = 16384.0;\n    float position_delta = 0.00001;\n    vec3 unpackVTPosition(vec3 offset) {\n        float z = aPosition.z;\n        vec2 pos = sign(aPosition.xy + position_delta) * mod(abs(aPosition.xy), position_modValue);\n        vec2 highs = floor(abs(aPosition.xy) / position_modValue);\n        float altitude = sign(z + position_delta) * (highs.x * 2.0 + highs.y) * pow(2.0, 15.0) + z;\n        return unpackVTPosition(pos + offset.xy, altitude + offset.z);\n    }\n    vec3 unpackVTPosition() {\n        return unpackVTPosition(vec3(0.0));\n    }\n#endif"),oy();const Lj=function(t,e){const n=t.toString(),i=n.indexOf("{")+1,o=n.substring(0,i);let s=`${o}\n    (`+e.toString()+")({});\n";return s+="\n"+n.substring(o.length),s}(VR,WR);if(GC){const t=Lf.VERSION;if(t.indexOf("1.0.0-beta")>=0||t.indexOf("1.0.0-alpha")>=0){va("@ispace/vt",GC.inject(Lj))}else va("@ispace/vt",(function(){return GC.inject(Lj)}))}else va("@ispace/vt",Lj);"undefined"!=typeof console&&console.log("@ispace/vt v0.107.5");for(
/*!
  * Contains code from THREE.js
  * MIT License
  * https://github.com/mrdoob/three.js
  */
var Dj=[],Fj=0;Fj<6;Fj++)Dj[Fj]=[];var Nj=[];function Hj(t,e,n){Jj(t);for(var i=0;i<6;i++){var o=Dj[i];if(Nj[0]=o[0]>0?e[1][0]:e[0][0],Nj[1]=o[1]>0?e[1][1]:e[0][1],Nj[2]=o[2]>0?e[1][2]:e[0][2],Yj(o,Nj)<0)return!1}return!0}var Bj=3,zj=4,Gj=5,jj=6,Uj=7,Vj=8,Wj=9,Zj=10,qj=11;function Xj(t,e){var n=e,i=e,o=t[0],s=t[1],a=t[2],l=Math.abs(o*i[Bj]+s*i[zj]+a*i[Gj])+Math.abs(o*i[jj]+s*i[Uj]+a*i[Vj])+Math.abs(o*i[Wj]+s*i[Zj]+a*i[qj]),h=Yj(t,n);return!(h<=-l)}function Jj(t){var e=t[0],n=t[1],i=t[2],o=t[3],s=t[4],a=t[5],l=t[6],h=t[7],c=t[8],u=t[9],f=t[10],g=t[11],A=t[12],m=t[13],w=t[14],T=t[15];Qj(Dj[0],o-e,h-s,g-c,T-A),Qj(Dj[1],o+e,h+s,g+c,T+A),Qj(Dj[2],o+n,h+a,g+u,T+m),Qj(Dj[3],o-n,h-a,g-u,T-m),Qj(Dj[4],o-i,h-l,g-f,T-w),Qj(Dj[5],o+i,h+l,g+f,T+w)}function Qj(t,e,n,i,o){var s=1/Math.sqrt(e*e+n*n+i*i);return t[0]=e*s,t[1]=n*s,t[2]=i*s,t[3]=o*s,t}function Yj(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]}
/*!
   * @ispace/3dtiles v0.105.8
   * LICENSE : UNLICENSED
   * (c) 2016-2026 ispace.org
   */const Kj="${",$j=`function(t){\n/*!\n     * @ispace/gl v0.108.4\n     * LICENSE : UNLICENSED\n     * (c) 2016-2026 ispace.com\n     */\nconst e=function(){if("undefined"!=typeof undefinedThis)return globalThis;if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof undefined)return global;throw new Error("unable to locate global object")},n=e(),r=n.gl_trans__coders=n.gl_trans__coders||{};function a(){return e().ispace_gltf_loader}r.inject=function(t){const r=t.toString(),a=r.indexOf("{")+1,o=r.substring(0,a),i=n.gl_trans__coders=n.gl_trans__coders||{};let s=\`${Kj}o}\\n    const _____getGlobal = ${Kj}e.toString()};\\n    const g___lobals = _____getGlobal()\\n    const tran_____scoders = g___lobals['gl_trans__coders'] = g___lobals['gl_trans__coders'] || {};\`;for(const t in i)"inject"!==t&&"getTranscoder"!==t&&"registerTranscoder"!==t&&(s+='tran_____scoders["'+t+'"] ='+i[t].toString()+"\\n;");return s+="\\n("+e().ispace_gltf_loader_bundle.toString()+")({});\\n",s+="\\n"+r.substring(o.length),s},r.registerTranscoder=function(t,e){r[t]=e},r.getTranscoder=function(t){return r[t]};var o="undefined"!=typeof Float32Array?Float32Array:Array;function i(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function s(t,e,n){var r=e[0],a=e[1],o=e[2],i=e[3],s=e[4],c=e[5],u=e[6],l=e[7],f=e[8],h=e[9],y=e[10],d=e[11],b=e[12],m=e[13],p=e[14],g=e[15],v=n[0],w=n[1],M=n[2],T=n[3];return t[0]=v*r+w*s+M*f+T*b,t[1]=v*a+w*c+M*h+T*m,t[2]=v*o+w*u+M*y+T*p,t[3]=v*i+w*l+M*d+T*g,v=n[4],w=n[5],M=n[6],T=n[7],t[4]=v*r+w*s+M*f+T*b,t[5]=v*a+w*c+M*h+T*m,t[6]=v*o+w*u+M*y+T*p,t[7]=v*i+w*l+M*d+T*g,v=n[8],w=n[9],M=n[10],T=n[11],t[8]=v*r+w*s+M*f+T*b,t[9]=v*a+w*c+M*h+T*m,t[10]=v*o+w*u+M*y+T*p,t[11]=v*i+w*l+M*d+T*g,v=n[12],w=n[13],M=n[14],T=n[15],t[12]=v*r+w*s+M*f+T*b,t[13]=v*a+w*c+M*h+T*m,t[14]=v*o+w*u+M*y+T*p,t[15]=v*i+w*l+M*d+T*g,t}function c(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]}function u(){var t=new o(3);return o!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function l(t){var e=t[0],n=t[1],r=t[2];return Math.hypot(e,n,r)}function f(t,e,n){var r=new o(3);return r[0]=t,r[1]=e,r[2]=n,r}function h(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function y(t,e,n,r){return t[0]=e,t[1]=n,t[2]=r,t}function d(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t}function b(t,e){var n=e[0],r=e[1],a=e[2],o=n*n+r*r+a*a;return o>0&&(o=1/Math.sqrt(o)),t[0]=e[0]*o,t[1]=e[1]*o,t[2]=e[2]*o,t}function m(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function p(t,e,n){var r=e[0],a=e[1],o=e[2],i=n[3]*r+n[7]*a+n[11]*o+n[15];return i=i||1,t[0]=(n[0]*r+n[4]*a+n[8]*o+n[12])/i,t[1]=(n[1]*r+n[5]*a+n[9]*o+n[13])/i,t[2]=(n[2]*r+n[6]*a+n[10]*o+n[14])/i,t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var g=function(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t},v=function(t,e,n){return t[0]=e[0]*n[0],t[1]=e[1]*n[1],t[2]=e[2]*n[2],t},w=l;function M(){var t=new o(4);return o!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}u(),function(){var t,e=(t=new o(4),o!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}();var T;function A(t){return t&&t.t&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}u(),f(1,0,0),f(0,1,0),M(),M(),T=new o(9),o!=Float32Array&&(T[1]=0,T[2]=0,T[3]=0,T[5]=0,T[6]=0,T[7]=0),T[0]=1,T[4]=1,T[8]=1;var k={exports:{}},_={exports:{}},O=function(t){return!(!t||"string"==typeof t)&&(t instanceof Array||Array.isArray(t)||t.length>=0&&(t.splice instanceof Function||Object.getOwnPropertyDescriptor(t,t.length-1)&&"String"!==t.constructor.name))},S=Array.prototype.concat,x=Array.prototype.slice,F=_.exports=function(t){for(var e=[],n=0,r=t.length;n<r;n++){var a=t[n];O(a)?e=S.call(e,x.call(a)):e.push(a)}return e};F.wrap=function(t){return function(){return t(F(arguments))}};var I=_.exports,C={"aliceblue":[240,248,255],"antiquewhite":[250,235,215],"aqua":[0,255,255],"aquamarine":[127,255,212],"azure":[240,255,255],"beige":[245,245,220],"bisque":[255,228,196],"black":[0,0,0],"blanchedalmond":[255,235,205],"blue":[0,0,255],"blueviolet":[138,43,226],"brown":[165,42,42],"burlywood":[222,184,135],"cadetblue":[95,158,160],"chartreuse":[127,255,0],"chocolate":[210,105,30],"coral":[255,127,80],"cornflowerblue":[100,149,237],"cornsilk":[255,248,220],"crimson":[220,20,60],"cyan":[0,255,255],"darkblue":[0,0,139],"darkcyan":[0,139,139],"darkgoldenrod":[184,134,11],"darkgray":[169,169,169],"darkgreen":[0,100,0],"darkgrey":[169,169,169],"darkkhaki":[189,183,107],"darkmagenta":[139,0,139],"darkolivegreen":[85,107,47],"darkorange":[255,140,0],"darkorchid":[153,50,204],"darkred":[139,0,0],"darksalmon":[233,150,122],"darkseagreen":[143,188,143],"darkslateblue":[72,61,139],"darkslategray":[47,79,79],"darkslategrey":[47,79,79],"darkturquoise":[0,206,209],"darkviolet":[148,0,211],"deeppink":[255,20,147],"deepskyblue":[0,191,255],"dimgray":[105,105,105],"dimgrey":[105,105,105],"dodgerblue":[30,144,255],"firebrick":[178,34,34],"floralwhite":[255,250,240],"forestgreen":[34,139,34],"fuchsia":[255,0,255],"gainsboro":[220,220,220],"ghostwhite":[248,248,255],"gold":[255,215,0],"goldenrod":[218,165,32],"gray":[128,128,128],"green":[0,128,0],"greenyellow":[173,255,47],"grey":[128,128,128],"honeydew":[240,255,240],"hotpink":[255,105,180],"indianred":[205,92,92],"indigo":[75,0,130],"ivory":[255,255,240],"khaki":[240,230,140],"lavender":[230,230,250],"lavenderblush":[255,240,245],"lawngreen":[124,252,0],"lemonchiffon":[255,250,205],"lightblue":[173,216,230],"lightcoral":[240,128,128],"lightcyan":[224,255,255],"lightgoldenrodyellow":[250,250,210],"lightgray":[211,211,211],"lightgreen":[144,238,144],"lightgrey":[211,211,211],"lightpink":[255,182,193],"lightsalmon":[255,160,122],"lightseagreen":[32,178,170],"lightskyblue":[135,206,250],"lightslategray":[119,136,153],"lightslategrey":[119,136,153],"lightsteelblue":[176,196,222],"lightyellow":[255,255,224],"lime":[0,255,0],"limegreen":[50,205,50],"linen":[250,240,230],"magenta":[255,0,255],"maroon":[128,0,0],"mediumaquamarine":[102,205,170],"mediumblue":[0,0,205],"mediumorchid":[186,85,211],"mediumpurple":[147,112,219],"mediumseagreen":[60,179,113],"mediumslateblue":[123,104,238],"mediumspringgreen":[0,250,154],"mediumturquoise":[72,209,204],"mediumvioletred":[199,21,133],"midnightblue":[25,25,112],"mintcream":[245,255,250],"mistyrose":[255,228,225],"moccasin":[255,228,181],"navajowhite":[255,222,173],"navy":[0,0,128],"oldlace":[253,245,230],"olive":[128,128,0],"olivedrab":[107,142,35],"orange":[255,165,0],"orangered":[255,69,0],"orchid":[218,112,214],"palegoldenrod":[238,232,170],"palegreen":[152,251,152],"paleturquoise":[175,238,238],"palevioletred":[219,112,147],"papayawhip":[255,239,213],"peachpuff":[255,218,185],"peru":[205,133,63],"pink":[255,192,203],"plum":[221,160,221],"powderblue":[176,224,230],"purple":[128,0,128],"rebeccapurple":[102,51,153],"red":[255,0,0],"rosybrown":[188,143,143],"royalblue":[65,105,225],"saddlebrown":[139,69,19],"salmon":[250,128,114],"sandybrown":[244,164,96],"seagreen":[46,139,87],"seashell":[255,245,238],"sienna":[160,82,45],"silver":[192,192,192],"skyblue":[135,206,235],"slateblue":[106,90,205],"slategray":[112,128,144],"slategrey":[112,128,144],"snow":[255,250,250],"springgreen":[0,255,127],"steelblue":[70,130,180],"tan":[210,180,140],"teal":[0,128,128],"thistle":[216,191,216],"tomato":[255,99,71],"turquoise":[64,224,208],"violet":[238,130,238],"wheat":[245,222,179],"white":[255,255,255],"whitesmoke":[245,245,245],"yellow":[255,255,0],"yellowgreen":[154,205,50]},E=I,U=Object.hasOwnProperty,N=Object.create(null);for(var z in C)U.call(C,z)&&(N[C[z]]=z);var L=k.exports={to:{},get:{}};function j(t,e,n){return Math.min(Math.max(e,t),n)}function D(t){var e=Math.round(t).toString(16).toUpperCase();return e.length<2?"0"+e:e}L.get=function(t){var e,n;switch(t.substring(0,3).toLowerCase()){case"hsl":e=L.get.hsl(t),n="hsl";break;case"hwb":e=L.get.hwb(t),n="hwb";break;default:e=L.get.rgb(t),n="rgb"}return e?{model:n,value:e}:null},L.get.rgb=function(t){if(!t)return null;var e,n,r,a=[0,0,0,1];if(e=t.match(/^#([a-f0-9]{6})([a-f0-9]{2})?$/i)){for(r=e[2],e=e[1],n=0;n<3;n++){var o=2*n;a[n]=parseInt(e.slice(o,o+2),16)}r&&(a[3]=parseInt(r,16)/255)}else if(e=t.match(/^#([a-f0-9]{3,4})$/i)){for(r=(e=e[1])[3],n=0;n<3;n++)a[n]=parseInt(e[n]+e[n],16);r&&(a[3]=parseInt(r+r,16)/255)}else if(e=t.match(/^rgba?\\(\\s*([+-]?\\d+)(?=[\\s,])\\s*(?:,\\s*)?([+-]?\\d+)(?=[\\s,])\\s*(?:,\\s*)?([+-]?\\d+)\\s*(?:[,|\\/]\\s*([+-]?[\\d\\.]+)(%?)\\s*)?\\)$/)){for(n=0;n<3;n++)a[n]=parseInt(e[n+1],0);e[4]&&(e[5]?a[3]=.01*parseFloat(e[4]):a[3]=parseFloat(e[4]))}else{if(!(e=t.match(/^rgba?\\(\\s*([+-]?[\\d\\.]+)\\%\\s*,?\\s*([+-]?[\\d\\.]+)\\%\\s*,?\\s*([+-]?[\\d\\.]+)\\%\\s*(?:[,|\\/]\\s*([+-]?[\\d\\.]+)(%?)\\s*)?\\)$/)))return(e=t.match(/^(\\w+)$/))?"transparent"===e[1]?[0,0,0,0]:U.call(C,e[1])?((a=C[e[1]])[3]=1,a):null:null;for(n=0;n<3;n++)a[n]=Math.round(2.55*parseFloat(e[n+1]));e[4]&&(e[5]?a[3]=.01*parseFloat(e[4]):a[3]=parseFloat(e[4]))}for(n=0;n<3;n++)a[n]=j(a[n],0,255);return a[3]=j(a[3],0,1),a},L.get.hsl=function(t){if(!t)return null;var e=t.match(/^hsla?\\(\\s*([+-]?(?:\\d{0,3}\\.)?\\d+)(?:deg)?\\s*,?\\s*([+-]?[\\d\\.]+)%\\s*,?\\s*([+-]?[\\d\\.]+)%\\s*(?:[,|\\/]\\s*([+-]?(?=\\.\\d|\\d)(?:0|[1-9]\\d*)?(?:\\.\\d*)?(?:[eE][+-]?\\d+)?)\\s*)?\\)$/);if(e){var n=parseFloat(e[4]);return[(parseFloat(e[1])%360+360)%360,j(parseFloat(e[2]),0,100),j(parseFloat(e[3]),0,100),j(isNaN(n)?1:n,0,1)]}return null},L.get.hwb=function(t){if(!t)return null;var e=t.match(/^hwb\\(\\s*([+-]?\\d{0,3}(?:\\.\\d+)?)(?:deg)?\\s*,\\s*([+-]?[\\d\\.]+)%\\s*,\\s*([+-]?[\\d\\.]+)%\\s*(?:,\\s*([+-]?(?=\\.\\d|\\d)(?:0|[1-9]\\d*)?(?:\\.\\d*)?(?:[eE][+-]?\\d+)?)\\s*)?\\)$/);if(e){var n=parseFloat(e[4]);return[(parseFloat(e[1])%360+360)%360,j(parseFloat(e[2]),0,100),j(parseFloat(e[3]),0,100),j(isNaN(n)?1:n,0,1)]}return null},L.to.hex=function(){var t=E(arguments);return"#"+D(t[0])+D(t[1])+D(t[2])+(t[3]<1?D(Math.round(255*t[3])):"")},L.to.rgb=function(){var t=E(arguments);return t.length<4||1===t[3]?"rgb("+Math.round(t[0])+", "+Math.round(t[1])+", "+Math.round(t[2])+")":"rgba("+Math.round(t[0])+", "+Math.round(t[1])+", "+Math.round(t[2])+", "+t[3]+")"},L.to.rgb.percent=function(){var t=E(arguments),e=Math.round(t[0]/255*100),n=Math.round(t[1]/255*100),r=Math.round(t[2]/255*100);return t.length<4||1===t[3]?"rgb("+e+"%, "+n+"%, "+r+"%)":"rgba("+e+"%, "+n+"%, "+r+"%, "+t[3]+")"},L.to.hsl=function(){var t=E(arguments);return t.length<4||1===t[3]?"hsl("+t[0]+", "+t[1]+"%, "+t[2]+"%)":"hsla("+t[0]+", "+t[1]+"%, "+t[2]+"%, "+t[3]+")"},L.to.hwb=function(){var t=E(arguments),e="";return t.length>=4&&1!==t[3]&&(e=", "+t[3]),"hwb("+t[0]+", "+t[1]+"%, "+t[2]+"%"+e+")"},L.to.keyword=function(t){return N[t.slice(0,3)]};var P=k.exports,B={exports:{}},q={"aliceblue":[240,248,255],"antiquewhite":[250,235,215],"aqua":[0,255,255],"aquamarine":[127,255,212],"azure":[240,255,255],"beige":[245,245,220],"bisque":[255,228,196],"black":[0,0,0],"blanchedalmond":[255,235,205],"blue":[0,0,255],"blueviolet":[138,43,226],"brown":[165,42,42],"burlywood":[222,184,135],"cadetblue":[95,158,160],"chartreuse":[127,255,0],"chocolate":[210,105,30],"coral":[255,127,80],"cornflowerblue":[100,149,237],"cornsilk":[255,248,220],"crimson":[220,20,60],"cyan":[0,255,255],"darkblue":[0,0,139],"darkcyan":[0,139,139],"darkgoldenrod":[184,134,11],"darkgray":[169,169,169],"darkgreen":[0,100,0],"darkgrey":[169,169,169],"darkkhaki":[189,183,107],"darkmagenta":[139,0,139],"darkolivegreen":[85,107,47],"darkorange":[255,140,0],"darkorchid":[153,50,204],"darkred":[139,0,0],"darksalmon":[233,150,122],"darkseagreen":[143,188,143],"darkslateblue":[72,61,139],"darkslategray":[47,79,79],"darkslategrey":[47,79,79],"darkturquoise":[0,206,209],"darkviolet":[148,0,211],"deeppink":[255,20,147],"deepskyblue":[0,191,255],"dimgray":[105,105,105],"dimgrey":[105,105,105],"dodgerblue":[30,144,255],"firebrick":[178,34,34],"floralwhite":[255,250,240],"forestgreen":[34,139,34],"fuchsia":[255,0,255],"gainsboro":[220,220,220],"ghostwhite":[248,248,255],"gold":[255,215,0],"goldenrod":[218,165,32],"gray":[128,128,128],"green":[0,128,0],"greenyellow":[173,255,47],"grey":[128,128,128],"honeydew":[240,255,240],"hotpink":[255,105,180],"indianred":[205,92,92],"indigo":[75,0,130],"ivory":[255,255,240],"khaki":[240,230,140],"lavender":[230,230,250],"lavenderblush":[255,240,245],"lawngreen":[124,252,0],"lemonchiffon":[255,250,205],"lightblue":[173,216,230],"lightcoral":[240,128,128],"lightcyan":[224,255,255],"lightgoldenrodyellow":[250,250,210],"lightgray":[211,211,211],"lightgreen":[144,238,144],"lightgrey":[211,211,211],"lightpink":[255,182,193],"lightsalmon":[255,160,122],"lightseagreen":[32,178,170],"lightskyblue":[135,206,250],"lightslategray":[119,136,153],"lightslategrey":[119,136,153],"lightsteelblue":[176,196,222],"lightyellow":[255,255,224],"lime":[0,255,0],"limegreen":[50,205,50],"linen":[250,240,230],"magenta":[255,0,255],"maroon":[128,0,0],"mediumaquamarine":[102,205,170],"mediumblue":[0,0,205],"mediumorchid":[186,85,211],"mediumpurple":[147,112,219],"mediumseagreen":[60,179,113],"mediumslateblue":[123,104,238],"mediumspringgreen":[0,250,154],"mediumturquoise":[72,209,204],"mediumvioletred":[199,21,133],"midnightblue":[25,25,112],"mintcream":[245,255,250],"mistyrose":[255,228,225],"moccasin":[255,228,181],"navajowhite":[255,222,173],"navy":[0,0,128],"oldlace":[253,245,230],"olive":[128,128,0],"olivedrab":[107,142,35],"orange":[255,165,0],"orangered":[255,69,0],"orchid":[218,112,214],"palegoldenrod":[238,232,170],"palegreen":[152,251,152],"paleturquoise":[175,238,238],"palevioletred":[219,112,147],"papayawhip":[255,239,213],"peachpuff":[255,218,185],"peru":[205,133,63],"pink":[255,192,203],"plum":[221,160,221],"powderblue":[176,224,230],"purple":[128,0,128],"rebeccapurple":[102,51,153],"red":[255,0,0],"rosybrown":[188,143,143],"royalblue":[65,105,225],"saddlebrown":[139,69,19],"salmon":[250,128,114],"sandybrown":[244,164,96],"seagreen":[46,139,87],"seashell":[255,245,238],"sienna":[160,82,45],"silver":[192,192,192],"skyblue":[135,206,235],"slateblue":[106,90,205],"slategray":[112,128,144],"slategrey":[112,128,144],"snow":[255,250,250],"springgreen":[0,255,127],"steelblue":[70,130,180],"tan":[210,180,140],"teal":[0,128,128],"thistle":[216,191,216],"tomato":[255,99,71],"turquoise":[64,224,208],"violet":[238,130,238],"wheat":[245,222,179],"white":[255,255,255],"whitesmoke":[245,245,245],"yellow":[255,255,0],"yellowgreen":[154,205,50]},R={};for(var V in q)q.hasOwnProperty(V)&&(R[q[V]]=V);var G=B.exports={rgb:{channels:3,labels:"rgb"},hsl:{channels:3,labels:"hsl"},hsv:{channels:3,labels:"hsv"},hwb:{channels:3,labels:"hwb"},cmyk:{channels:4,labels:"cmyk"},xyz:{channels:3,labels:"xyz"},lab:{channels:3,labels:"lab"},lch:{channels:3,labels:"lch"},hex:{channels:1,labels:["hex"]},keyword:{channels:1,labels:["keyword"]},ansi16:{channels:1,labels:["ansi16"]},ansi256:{channels:1,labels:["ansi256"]},hcg:{channels:3,labels:["h","c","g"]},apple:{channels:3,labels:["r16","g16","b16"]},gray:{channels:1,labels:["gray"]}};for(var $ in G)if(G.hasOwnProperty($)){if(!("channels"in G[$]))throw new Error("missing channels property: "+$);if(!("labels"in G[$]))throw new Error("missing channel labels property: "+$);if(G[$].labels.length!==G[$].channels)throw new Error("channel and label counts mismatch: "+$);var X=G[$].channels,H=G[$].labels;delete G[$].channels,delete G[$].labels,Object.defineProperty(G[$],"channels",{value:X}),Object.defineProperty(G[$],"labels",{value:H})}G.rgb.hsl=function(t){var e,n,r=t[0]/255,a=t[1]/255,o=t[2]/255,i=Math.min(r,a,o),s=Math.max(r,a,o),c=s-i;return s===i?e=0:r===s?e=(a-o)/c:a===s?e=2+(o-r)/c:o===s&&(e=4+(r-a)/c),(e=Math.min(60*e,360))<0&&(e+=360),n=(i+s)/2,[e,100*(s===i?0:n<=.5?c/(s+i):c/(2-s-i)),100*n]},G.rgb.hsv=function(t){var e,n,r,a,o,i=t[0]/255,s=t[1]/255,c=t[2]/255,u=Math.max(i,s,c),l=u-Math.min(i,s,c),f=function(t){return(u-t)/6/l+.5};return 0===l?a=o=0:(o=l/u,e=f(i),n=f(s),r=f(c),i===u?a=r-n:s===u?a=1/3+e-r:c===u&&(a=2/3+n-e),a<0?a+=1:a>1&&(a-=1)),[360*a,100*o,100*u]},G.rgb.hwb=function(t){var e=t[0],n=t[1],r=t[2];return[G.rgb.hsl(t)[0],100*(1/255*Math.min(e,Math.min(n,r))),100*(r=1-1/255*Math.max(e,Math.max(n,r)))]},G.rgb.cmyk=function(t){var e,n=t[0]/255,r=t[1]/255,a=t[2]/255;return[100*((1-n-(e=Math.min(1-n,1-r,1-a)))/(1-e)||0),100*((1-r-e)/(1-e)||0),100*((1-a-e)/(1-e)||0),100*e]},G.rgb.keyword=function(t){var e=R[t];if(e)return e;var n,r,a,o=1/0;for(var i in q)if(q.hasOwnProperty(i)){var s=q[i],c=(r=t,a=s,Math.pow(r[0]-a[0],2)+Math.pow(r[1]-a[1],2)+Math.pow(r[2]-a[2],2));c<o&&(o=c,n=i)}return n},G.keyword.rgb=function(t){return q[t]},G.rgb.xyz=function(t){var e=t[0]/255,n=t[1]/255,r=t[2]/255;return[100*(.4124*(e=e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92)+.3576*(n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92)+.1805*(r=r>.04045?Math.pow((r+.055)/1.055,2.4):r/12.92)),100*(.2126*e+.7152*n+.0722*r),100*(.0193*e+.1192*n+.9505*r)]},G.rgb.lab=function(t){var e=G.rgb.xyz(t),n=e[0],r=e[1],a=e[2];return r/=100,a/=108.883,n=(n/=95.047)>.008856?Math.pow(n,1/3):7.787*n+16/116,[116*(r=r>.008856?Math.pow(r,1/3):7.787*r+16/116)-16,500*(n-r),200*(r-(a=a>.008856?Math.pow(a,1/3):7.787*a+16/116))]},G.hsl.rgb=function(t){var e,n,r,a,o,i=t[0]/360,s=t[1]/100,c=t[2]/100;if(0===s)return[o=255*c,o,o];e=2*c-(n=c<.5?c*(1+s):c+s-c*s),a=[0,0,0];for(var u=0;u<3;u++)(r=i+1/3*-(u-1))<0&&r++,r>1&&r--,o=6*r<1?e+6*(n-e)*r:2*r<1?n:3*r<2?e+(n-e)*(2/3-r)*6:e,a[u]=255*o;return a},G.hsl.hsv=function(t){var e=t[0],n=t[1]/100,r=t[2]/100,a=n,o=Math.max(r,.01);return n*=(r*=2)<=1?r:2-r,a*=o<=1?o:2-o,[e,100*(0===r?2*a/(o+a):2*n/(r+n)),100*((r+n)/2)]},G.hsv.rgb=function(t){var e=t[0]/60,n=t[1]/100,r=t[2]/100,a=Math.floor(e)%6,o=e-Math.floor(e),i=255*r*(1-n),s=255*r*(1-n*o),c=255*r*(1-n*(1-o));switch(r*=255,a){case 0:return[r,c,i];case 1:return[s,r,i];case 2:return[i,r,c];case 3:return[i,s,r];case 4:return[c,i,r];case 5:return[r,i,s]}},G.hsv.hsl=function(t){var e,n,r,a=t[0],o=t[1]/100,i=t[2]/100,s=Math.max(i,.01);return r=(2-o)*i,n=o*s,[a,100*(n=(n/=(e=(2-o)*s)<=1?e:2-e)||0),100*(r/=2)]},G.hwb.rgb=function(t){var e,n,r,a,o,i,s,c=t[0]/360,u=t[1]/100,l=t[2]/100,f=u+l;switch(f>1&&(u/=f,l/=f),r=6*c-(e=Math.floor(6*c)),1&e&&(r=1-r),a=u+r*((n=1-l)-u),e){default:case 6:case 0:o=n,i=a,s=u;break;case 1:o=a,i=n,s=u;break;case 2:o=u,i=n,s=a;break;case 3:o=u,i=a,s=n;break;case 4:o=a,i=u,s=n;break;case 5:o=n,i=u,s=a}return[255*o,255*i,255*s]},G.cmyk.rgb=function(t){var e=t[0]/100,n=t[1]/100,r=t[2]/100,a=t[3]/100;return[255*(1-Math.min(1,e*(1-a)+a)),255*(1-Math.min(1,n*(1-a)+a)),255*(1-Math.min(1,r*(1-a)+a))]},G.xyz.rgb=function(t){var e,n,r,a=t[0]/100,o=t[1]/100,i=t[2]/100;return n=-.9689*a+1.8758*o+.0415*i,r=.0557*a+-.204*o+1.057*i,e=(e=3.2406*a+-1.5372*o+-.4986*i)>.0031308?1.055*Math.pow(e,1/2.4)-.055:12.92*e,n=n>.0031308?1.055*Math.pow(n,1/2.4)-.055:12.92*n,r=r>.0031308?1.055*Math.pow(r,1/2.4)-.055:12.92*r,[255*(e=Math.min(Math.max(0,e),1)),255*(n=Math.min(Math.max(0,n),1)),255*(r=Math.min(Math.max(0,r),1))]},G.xyz.lab=function(t){var e=t[0],n=t[1],r=t[2];return n/=100,r/=108.883,e=(e/=95.047)>.008856?Math.pow(e,1/3):7.787*e+16/116,[116*(n=n>.008856?Math.pow(n,1/3):7.787*n+16/116)-16,500*(e-n),200*(n-(r=r>.008856?Math.pow(r,1/3):7.787*r+16/116))]},G.lab.xyz=function(t){var e,n,r,a=t[0];e=t[1]/500+(n=(a+16)/116),r=n-t[2]/200;var o=Math.pow(n,3),i=Math.pow(e,3),s=Math.pow(r,3);return n=o>.008856?o:(n-16/116)/7.787,e=i>.008856?i:(e-16/116)/7.787,r=s>.008856?s:(r-16/116)/7.787,[e*=95.047,n*=100,r*=108.883]},G.lab.lch=function(t){var e,n=t[0],r=t[1],a=t[2];return(e=360*Math.atan2(a,r)/2/Math.PI)<0&&(e+=360),[n,Math.sqrt(r*r+a*a),e]},G.lch.lab=function(t){var e,n=t[0],r=t[1];return e=t[2]/360*2*Math.PI,[n,r*Math.cos(e),r*Math.sin(e)]},G.rgb.ansi16=function(t){var e=t[0],n=t[1],r=t[2],a=1 in arguments?arguments[1]:G.rgb.hsv(t)[2];if(0===(a=Math.round(a/50)))return 30;var o=30+(Math.round(r/255)<<2|Math.round(n/255)<<1|Math.round(e/255));return 2===a&&(o+=60),o},G.hsv.ansi16=function(t){return G.rgb.ansi16(G.hsv.rgb(t),t[2])},G.rgb.ansi256=function(t){var e=t[0],n=t[1],r=t[2];return e===n&&n===r?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(n/255*5)+Math.round(r/255*5)},G.ansi16.rgb=function(t){var e=t%10;if(0===e||7===e)return t>50&&(e+=3.5),[e=e/10.5*255,e,e];var n=.5*(1+~~(t>50));return[(1&e)*n*255,(e>>1&1)*n*255,(e>>2&1)*n*255]},G.ansi256.rgb=function(t){if(t>=232){var e=10*(t-232)+8;return[e,e,e]}var n;return t-=16,[Math.floor(t/36)/5*255,Math.floor((n=t%36)/6)/5*255,n%6/5*255]},G.rgb.hex=function(t){var e=(((255&Math.round(t[0]))<<16)+((255&Math.round(t[1]))<<8)+(255&Math.round(t[2]))).toString(16).toUpperCase();return"000000".substring(e.length)+e},G.hex.rgb=function(t){var e=t.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);if(!e)return[0,0,0];var n=e[0];3===e[0].length&&(n=n.split("").map((function(t){return t+t})).join(""));var r=parseInt(n,16);return[r>>16&255,r>>8&255,255&r]},G.rgb.hcg=function(t){var e,n=t[0]/255,r=t[1]/255,a=t[2]/255,o=Math.max(Math.max(n,r),a),i=Math.min(Math.min(n,r),a),s=o-i;return e=s<=0?0:o===n?(r-a)/s%6:o===r?2+(a-n)/s:4+(n-r)/s+4,e/=6,[360*(e%=1),100*s,100*(s<1?i/(1-s):0)]},G.hsl.hcg=function(t){var e=t[1]/100,n=t[2]/100,r=1,a=0;return(r=n<.5?2*e*n:2*e*(1-n))<1&&(a=(n-.5*r)/(1-r)),[t[0],100*r,100*a]},G.hsv.hcg=function(t){var e=t[1]/100,n=t[2]/100,r=e*n,a=0;return r<1&&(a=(n-r)/(1-r)),[t[0],100*r,100*a]},G.hcg.rgb=function(t){var e=t[0]/360,n=t[1]/100,r=t[2]/100;if(0===n)return[255*r,255*r,255*r];var a,o=[0,0,0],i=e%1*6,s=i%1,c=1-s;switch(Math.floor(i)){case 0:o[0]=1,o[1]=s,o[2]=0;break;case 1:o[0]=c,o[1]=1,o[2]=0;break;case 2:o[0]=0,o[1]=1,o[2]=s;break;case 3:o[0]=0,o[1]=c,o[2]=1;break;case 4:o[0]=s,o[1]=0,o[2]=1;break;default:o[0]=1,o[1]=0,o[2]=c}return a=(1-n)*r,[255*(n*o[0]+a),255*(n*o[1]+a),255*(n*o[2]+a)]},G.hcg.hsv=function(t){var e=t[1]/100,n=e+t[2]/100*(1-e),r=0;return n>0&&(r=e/n),[t[0],100*r,100*n]},G.hcg.hsl=function(t){var e=t[1]/100,n=t[2]/100*(1-e)+.5*e,r=0;return n>0&&n<.5?r=e/(2*n):n>=.5&&n<1&&(r=e/(2*(1-n))),[t[0],100*r,100*n]},G.hcg.hwb=function(t){var e=t[1]/100,n=e+t[2]/100*(1-e);return[t[0],100*(n-e),100*(1-n)]},G.hwb.hcg=function(t){var e=t[1]/100,n=1-t[2]/100,r=n-e,a=0;return r<1&&(a=(n-r)/(1-r)),[t[0],100*r,100*a]},G.apple.rgb=function(t){return[t[0]/65535*255,t[1]/65535*255,t[2]/65535*255]},G.rgb.apple=function(t){return[t[0]/255*65535,t[1]/255*65535,t[2]/255*65535]},G.gray.rgb=function(t){return[t[0]/100*255,t[0]/100*255,t[0]/100*255]},G.gray.hsl=G.gray.hsv=function(t){return[0,0,t[0]]},G.gray.hwb=function(t){return[0,100,t[0]]},G.gray.cmyk=function(t){return[0,0,0,t[0]]},G.gray.lab=function(t){return[t[0],0,0]},G.gray.hex=function(t){var e=255&Math.round(t[0]/100*255),n=((e<<16)+(e<<8)+e).toString(16).toUpperCase();return"000000".substring(n.length)+n},G.rgb.gray=function(t){return[(t[0]+t[1]+t[2])/3/255*100]};var J=B.exports,Y=J;function K(t){var e=function(){for(var t={},e=Object.keys(Y),n=e.length,r=0;r<n;r++)t[e[r]]={distance:-1,parent:null};return t}(),n=[t];for(e[t].distance=0;n.length;)for(var r=n.pop(),a=Object.keys(Y[r]),o=a.length,i=0;i<o;i++){var s=a[i],c=e[s];-1===c.distance&&(c.distance=e[r].distance+1,c.parent=r,n.unshift(s))}return e}function Q(t,e){return function(n){return e(t(n))}}function Z(t,e){for(var n=[e[t].parent,t],r=Y[e[t].parent][t],a=e[t].parent;e[a].parent;)n.unshift(e[a].parent),r=Q(Y[e[a].parent][a],r),a=e[a].parent;return r.conversion=n,r}var W=J,tt=function(t){for(var e=K(t),n={},r=Object.keys(e),a=r.length,o=0;o<a;o++){var i=r[o];null!==e[i].parent&&(n[i]=Z(i,e))}return n},et={};Object.keys(W).forEach((function(t){et[t]={},Object.defineProperty(et[t],"channels",{value:W[t].channels}),Object.defineProperty(et[t],"labels",{value:W[t].labels});var e=tt(t);Object.keys(e).forEach((function(n){var r=e[n];et[t][n]=function(t){var e=function(e){if(null==e)return e;arguments.length>1&&(e=Array.prototype.slice.call(arguments));var n=t(e);if("object"==typeof n)for(var r=n.length,a=0;a<r;a++)n[a]=Math.round(n[a]);return n};return"conversion"in t&&(e.conversion=t.conversion),e}(r),et[t][n].raw=function(t){var e=function(e){return null==e?e:(arguments.length>1&&(e=Array.prototype.slice.call(arguments)),t(e))};return"conversion"in t&&(e.conversion=t.conversion),e}(r)}))}));var nt=P,rt=et,at=[].slice,ot=["keyword","gray","hex"],it={};Object.keys(rt).forEach((function(t){it[at.call(rt[t].labels).sort().join("")]=t}));var st={};function ct(t,e){if(!(this instanceof ct))return new ct(t,e);if(e&&e in ot&&(e=null),e&&!(e in rt))throw new Error("Unknown model: "+e);var n,r;if(null==t)this.model="rgb",this.color=[0,0,0],this.valpha=1;else if(t instanceof ct)this.model=t.model,this.color=t.color.slice(),this.valpha=t.valpha;else if("string"==typeof t){var a=nt.get(t);if(null===a)throw new Error("Unable to parse color from string: "+t);this.model=a.model,r=rt[this.model].channels,this.color=a.value.slice(0,r),this.valpha="number"==typeof a.value[r]?a.value[r]:1}else if(t.length){this.model=e||"rgb",r=rt[this.model].channels;var o=at.call(t,0,r);this.color=ft(o,r),this.valpha="number"==typeof t[r]?t[r]:1}else if("number"==typeof t)t&=16777215,this.model="rgb",this.color=[t>>16&255,t>>8&255,255&t],this.valpha=1;else{this.valpha=1;var i=Object.keys(t);"alpha"in t&&(i.splice(i.indexOf("alpha"),1),this.valpha="number"==typeof t.alpha?t.alpha:0);var s=i.sort().join("");if(!(s in it))throw new Error("Unable to parse color from object: "+JSON.stringify(t));this.model=it[s];var c=rt[this.model].labels,u=[];for(n=0;n<c.length;n++)u.push(t[c[n]]);this.color=ft(u)}if(st[this.model])for(r=rt[this.model].channels,n=0;n<r;n++){var l=st[this.model][n];l&&(this.color[n]=l(this.color[n]))}this.valpha=Math.max(0,Math.min(1,this.valpha)),Object.freeze&&Object.freeze(this)}function ut(t,e,n){return(t=Array.isArray(t)?t:[t]).forEach((function(t){(st[t]||(st[t]=[]))[e]=n})),t=t[0],function(r){var a;return arguments.length?(n&&(r=n(r)),(a=this[t]()).color[e]=r,a):(a=this[t]().color[e],n&&(a=n(a)),a)}}function lt(t){return function(e){return Math.max(0,Math.min(t,e))}}function ft(t,e){for(var n=0;n<e;n++)"number"!=typeof t[n]&&(t[n]=0);return t}function ht(t){return null==t}function yt(t){return"object"==typeof t&&!!t}function dt(t){return t/Math.PI*180}ct.prototype={toString:function(){return this.string()},toJSON:function(){return this[this.model]()},string:function(t){var e=this.model in nt.to?this:this.rgb(),n=1===(e=e.round("number"==typeof t?t:1)).valpha?e.color:e.color.concat(this.valpha);return nt.to[e.model](n)},percentString:function(t){var e=this.rgb().round("number"==typeof t?t:1),n=1===e.valpha?e.color:e.color.concat(this.valpha);return nt.to.rgb.percent(n)},array:function(){return 1===this.valpha?this.color.slice():this.color.concat(this.valpha)},object:function(){for(var t={},e=rt[this.model].channels,n=rt[this.model].labels,r=0;r<e;r++)t[n[r]]=this.color[r];return 1!==this.valpha&&(t.alpha=this.valpha),t},unitArray:function(){var t=this.rgb().color;return t[0]/=255,t[1]/=255,t[2]/=255,1!==this.valpha&&t.push(this.valpha),t},unitObject:function(){var t=this.rgb().object();return t.r/=255,t.g/=255,t.b/=255,1!==this.valpha&&(t.alpha=this.valpha),t},round:function(t){return t=Math.max(t||0,0),new ct(this.color.map(function(t){return function(e){return function(t,e){return Number(t.toFixed(e))}(e,t)}}(t)).concat(this.valpha),this.model)},alpha:function(t){return arguments.length?new ct(this.color.concat(Math.max(0,Math.min(1,t))),this.model):this.valpha},red:ut("rgb",0,lt(255)),green:ut("rgb",1,lt(255)),blue:ut("rgb",2,lt(255)),hue:ut(["hsl","hsv","hsl","hwb","hcg"],0,(function(t){return(t%360+360)%360})),saturationl:ut("hsl",1,lt(100)),lightness:ut("hsl",2,lt(100)),saturationv:ut("hsv",1,lt(100)),value:ut("hsv",2,lt(100)),chroma:ut("hcg",1,lt(100)),gray:ut("hcg",2,lt(100)),white:ut("hwb",1,lt(100)),wblack:ut("hwb",2,lt(100)),cyan:ut("cmyk",0,lt(100)),magenta:ut("cmyk",1,lt(100)),yellow:ut("cmyk",2,lt(100)),black:ut("cmyk",3,lt(100)),x:ut("xyz",0,lt(100)),y:ut("xyz",1,lt(100)),z:ut("xyz",2,lt(100)),l:ut("lab",0,lt(100)),a:ut("lab",1),b:ut("lab",2),keyword:function(t){return arguments.length?new ct(t):rt[this.model].keyword(this.color)},hex:function(t){return arguments.length?new ct(t):nt.to.hex(this.rgb().round().color)},rgbNumber:function(){var t=this.rgb().color;return(255&t[0])<<16|(255&t[1])<<8|255&t[2]},luminosity:function(){for(var t=this.rgb().color,e=[],n=0;n<t.length;n++){var r=t[n]/255;e[n]=r<=.03928?r/12.92:Math.pow((r+.055)/1.055,2.4)}return.2126*e[0]+.7152*e[1]+.0722*e[2]},contrast:function(t){var e=this.luminosity(),n=t.luminosity();return e>n?(e+.05)/(n+.05):(n+.05)/(e+.05)},level:function(t){var e=this.contrast(t);return e>=7.1?"AAA":e>=4.5?"AA":""},isDark:function(){var t=this.rgb().color;return(299*t[0]+587*t[1]+114*t[2])/1e3<128},isLight:function(){return!this.isDark()},negate:function(){for(var t=this.rgb(),e=0;e<3;e++)t.color[e]=255-t.color[e];return t},lighten:function(t){var e=this.hsl();return e.color[2]+=e.color[2]*t,e},darken:function(t){var e=this.hsl();return e.color[2]-=e.color[2]*t,e},saturate:function(t){var e=this.hsl();return e.color[1]+=e.color[1]*t,e},desaturate:function(t){var e=this.hsl();return e.color[1]-=e.color[1]*t,e},whiten:function(t){var e=this.hwb();return e.color[1]+=e.color[1]*t,e},blacken:function(t){var e=this.hwb();return e.color[2]+=e.color[2]*t,e},grayscale:function(){var t=this.rgb().color,e=.3*t[0]+.59*t[1]+.11*t[2];return ct.rgb(e,e,e)},fade:function(t){return this.alpha(this.valpha-this.valpha*t)},opaquer:function(t){return this.alpha(this.valpha+this.valpha*t)},rotate:function(t){var e=this.hsl(),n=e.color[0];return n=(n=(n+t)%360)<0?360+n:n,e.color[0]=n,e},mix:function(t,e){if(!t||!t.rgb)throw new Error('Argument to "mix" was not a Color instance, but rather an instance of '+typeof t);var n=t.rgb(),r=this.rgb(),a=void 0===e?.5:e,o=2*a-1,i=n.alpha()-r.alpha(),s=((o*i==-1?o:(o+i)/(1+o*i))+1)/2,c=1-s;return ct.rgb(s*n.red()+c*r.red(),s*n.green()+c*r.green(),s*n.blue()+c*r.blue(),n.alpha()*a+r.alpha()*(1-a))}},Object.keys(rt).forEach((function(t){if(-1===ot.indexOf(t)){var e=rt[t].channels;ct.prototype[t]=function(){if(this.model===t)return new ct(this);if(arguments.length)return new ct(arguments,t);var n,r="number"==typeof arguments[e]?e:this.valpha;return new ct((n=rt[this.model][t].raw(this.color),Array.isArray(n)?n:[n]).concat(r),t)},ct[t]=function(n){return"number"==typeof n&&(n=ft(at.call(arguments),e)),new ct(n,t)}}}));const bt=[1,1,1,1,2,2,3,0];function mt(t){const e=t.length;let n="";for(let r=0;r<e;){let a=t[r++];if(128&a){let n=bt[a>>3&7];if(!(64&a)||!n||r+n>e)return null;for(a&=63>>n;n>0;n-=1){const e=t[r++];if(128!=(192&e))return null;a=a<<6|63&e}}n+=String.fromCharCode(a)}return n}new Array(3),new Array(3);const pt=[1/6378137,1/6378137,1/6356752.314245179],gt=[1/40680631590769,1/40680631590769,1/40408299984661.445],vt=new Array(3),wt=new Array(3),Mt=new Array(3);function Tt(t,e){const n=gt,r=function(t,e,n,r,a){const o=e[0],i=e[1],s=e[2],c=n[0],u=n[1],l=n[2],f=o*o*c*c,h=i*i*u*u,y=s*s*l*l,d=f+h+y,b=Math.sqrt(1/d),m=function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}(At,e,b);if(d<a)return isFinite(b)?m:void 0;const p=r[0],g=r[1],v=r[2],w=kt;w[0]=m[0]*p*2,w[1]=m[1]*g*2,w[2]=m[2]*v*2;let M,T,A,k,_,O,S,x,F,I,C,E=(1-b)*Ot(e)/(.5*Ot(w)),U=0;do{E-=U,A=1/(1+E*p),k=1/(1+E*g),_=1/(1+E*v),O=A*A,S=k*k,x=_*_,F=O*A,I=S*k,C=x*_,M=f*O+h*S+y*x-1,T=f*F*p+h*I*g+y*C*v;U=M/(-2*T)}while(Math.abs(M)>_t);return t[0]=o*A,t[1]=i*k,t[2]=s*_,t}(vt,e,pt,n,.1);let a=v(wt,r,n);a=function(t,e){const n=e[0],r=e[1],a=e[2];let o=n*n+r*r+a*a;o>0&&(o=Math.sqrt(o),t[0]=e[0]/o,t[1]=e[1]/o,t[2]=e[2]/o);return t}(a,a);const o=g(Mt,e,r),i=Math.atan2(a[1],a[0]),s=Math.asin(a[2]),c=(u=m(o,e),(Math.sign?Math.sign(u):0==(u=+u)||isNaN(u)?Number(u):u>0?1:-1)*Ot(o));var u;return t[0]=dt(i),t[1]=dt(s),t[2]=c,t}const At=new Array(3),kt=new Array(3),_t=1e-12;function Ot(t){return l(t)}function St(t,e){let n="";for(let r=0;r<4;r++){const a=t.getUint8(e+r);n+=String.fromCharCode(a)}return n}const xt="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;function Ft(t,e,n){const r=new Uint8Array(t,e,n);return xt?JSON.parse(xt.decode(r)):JSON.parse(mt(r))}function It(t,e,n){const r=new Uint8Array(t,e,n);return xt?JSON.parse(xt.decode(r)):JSON.parse(mt(r))}function Ct(t,e,n){return{offset:e,byteLength:n}}function Et(t,e,n,r){const{byteOffset:a,componentType:o,type:i}=t,{ctor:s,type:c}=function(t){return zt[t]}(o||"UNSIGNED_SHORT"),u=function(t){if(!t)return 1;return Nt[t]}(i);return{byteStride:0,byteOffset:a+n,itemSize:u,count:r*u,componentType:c,array:new s(e,n+a,r*u)}}function Ut(t,e,n,r){const a=Et(t,e,n,r);return a.array.buffer.byteLength!==e.byteLength&&(a.array=a.array.slice()),a}const Nt={"SCALAR":1,"VEC2":2,"VEC3":3,"VEC4":4};const zt={"BYTE":{ctor:Int8Array,type:5120,name:"Int8Array"},"UNSIGNED_BYTE":{ctor:Uint8Array,type:5121,name:"Uint8Array"},"SHORT":{ctor:Int16Array,type:5122,name:"Int16Array"},"UNSIGNED_SHORT":{ctor:Uint16Array,type:5123,name:"Uint16Array"},"INT":{ctor:Int32Array,type:5124,name:"Int32Array"},"UNSIGNED_INT":{ctor:Uint32Array,type:5125,name:"Uint32Array"},"FLOAT":{ctor:Float32Array,type:5126,name:"Float32Array"},"DOUBLE":{ctor:Float64Array,type:5126,name:"Float64Array"}};function Lt(t){for(const e in zt)if(t===zt[e].ctor)return zt[e].type;throw new Error("unrecognized ctor:"+t)}function jt(t,e,n,r){const a=t,o=e.length/3;for(let t=0;t<o;t++)a[3*t]=e[3*t]/65535*r[0]+n[0],a[3*t+1]=e[3*t+1]/65535*r[1]+n[1],a[3*t+2]=e[3*t+2]/65535*r[2]+n[2];return a}function Dt(t,e,n){const r=t.getUint32(12,!0),a=t.getUint32(16,!0),o=t.getUint32(20,!0),i=t.getUint32(24,!0),s=t.buffer;let c,u={},l={},f=null;r>0&&(u=Ft(s,e,r),e+=r),a>0&&(c=function(t,e,n){return{offset:e,byteLength:n}}(0,e,a),e+=a),o>0&&(l=It(s,e,o),e+=o);const h=Ct(0,e,i);return f=s.slice(h.offset,h.offset+h.byteLength),n.push(f),{featureTable:u,featureTableBin:c,batchTable:l,batchTableBin:f}}const Pt={5120:Int8Array,5122:Int16Array,5124:Int32Array,5121:Uint8Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};function Bt(t){for(const e in Pt)if(t===Pt[e])return+e;throw new Error("unrecognized ctor:"+t)}let qt=null;function Rt(){return qt||(qt={"image/crn":r.crn&&r.crn(),"image/ktx2":r.ktx2&&r.ktx2(),"image/cttf":r.ktx2&&r.ktx2(),"draco":r.draco&&r.draco()}),qt}const{Ajax:Vt,GLTFLoader:Gt}=a();class $t{constructor(t,e,n){this.o=t,this.i=e||Gt,this.u=n,this.h=Rt()}static createEmptyB3DM(){return{featureTable:null,batchTable:null,gltf:{}}}load(t,e,n=0,r=0,a){return e?(r||(r=e.byteLength),this.m(t,e,n,r,a)):Vt.getArrayBuffer(t,{}).then((e=>{const a=e.data;return r||(r=a.byteLength),this.m(t,a,n,r)}))}m(t,e,n,r,a){const o=a&&a.maxTextureSize,i=this.p(e,n,r,t);if(i.error)return Promise.resolve(i);const s=t.substring(0,t.lastIndexOf("/"));let c;try{c=new this.i(s,i.glb,{transferable:!0,requestImage:this.o,decoders:this.h,supportedFormats:this.u,maxTextureSize:o})}catch(t){return Promise.resolve({error:t})}return c.load({skipAttributeTransform:!1}).then((e=>{e.url=\`${Kj}t}-${Kj}n}-${Kj}r}\`;const a=c.transferables;for(let t=0;t<i.transferables.length;t++)a.indexOf(i.transferables[t])<0&&a.push(i.transferables[t]);return{magic:"b3dm",count:i.count,transferables:a,featureTable:i.featureTable,batchTable:i.batchTable,batchTableBin:i.batchTableBin,gltf:e}}))}p(t,e,n,r){const a=new DataView(t,e,n),o=a.getUint32(4,!0);if(1!==o){const t="Unsupported b3dm version: "+o+", url:"+r;return console.warn(t),{error:t}}if(a.getUint32(8,!0)!==a.byteLength){const t="Length in b3dm header is inconsistent with b3dm's byte length, url: "+r;return console.warn(t),{error:t}}let i,s=a.getUint32(12,!0),c=a.getUint32(16,!0),u=a.getUint32(20,!0),l=a.getUint32(24,!0),f=28+e;u>=570425344?(f-=8,i=s,u=c,l=0,s=0,c=0):l>=570425344&&(f-=4,i=u,u=s,l=c,s=0,c=0);const h=[t];let y,d,b;if(s>0?(y=Ft(t,f,s),f+=s,i=y.BATCH_LENGTH):y={"BATCH_LENGTH":i},c>0&&(f+=c),u>0&&(d=It(t,f,u),f+=u,l>0)){const e=Ct(0,f,l);b=t.slice(e.offset,e.offset+e.byteLength),f+=l,h.push(b)}const m=y.BATCH_LENGTH,p={};if(y&&y.BATCH_ID){p.BATCH_ID=Ut(y.BATCH_ID,t,undefined.offset,m);const e=p.BATCH_ID.array&&p.BATCH_ID.array.buffer;e&&h.indexOf(e)<0&&h.push(e)}return{count:i,transferables:h,featureTable:y,batchTable:d,batchTableBin:b,b3dm:p,glb:{buffer:t,byteOffset:f,byteLength:a.byteLength+a.byteOffset-f}}}v(){return null}}const{Ajax:Xt,GLTFLoader:Ht}=a();class Jt{constructor(t,e,n,r){this.o=t,this.i=e||Ht,this.u=n,this.h=Rt(),this.M=r}load(t,e,n=0,r=0,a){return e?(r||(r=e.byteLength),this.m(t,e,n,r,a)):Xt.getArrayBuffer(t,{}).then((e=>{const a=e.data;return r||(r=a.byteLength),this.m(t,a,n,r)}))}m(t,e,n,r,a){return this.T(t,e,n,r,a).then((({gltf:a,transferables:o})=>{const i=this.A(e,n,r,t);if(i.error)return Promise.resolve(i);for(let t=0;t<o.length;t++)-1===i.transferables.indexOf(o[t])&&i.transferables.push(o[t]);return delete a.transferables,Promise.resolve({magic:"i3dm",count:i.count,transferables:i.transferables,featureTable:i.featureTable,batchTable:i.batchTable,batchTableBin:i.batchTableBin,i3dm:i.i3dm,gltf:a})}))}T(t,e,n,r,a){const o=a&&a.maxTextureSize,i={transferable:!0,requestImage:this.o,decoders:this.h,supportedFormats:this.u,maxTextureSize:o},s=new DataView(e,n,r),c=32+s.getUint32(12,!0)+s.getUint32(16,!0)+s.getUint32(20,!0)+s.getUint32(24,!0);if(0===s.getUint32(28,!0)){let r=mt(new Uint8Array(e,c+n,s.byteLength-c));-1==r.indexOf("://")&&(r=t.substring(0,t.lastIndexOf("/"))+"/"+r);return r.indexOf(".glb")>0?Xt.getArrayBuffer(r,{}).then((t=>this.k(r,{buffer:t.data,byteOffset:0},i))):Xt.getJSON(r,{}).then((t=>this.k(r,t,i)))}{const r={buffer:e,byteOffset:c+n,byteLength:s.byteLength-c};return this.k(t,r,i)}}k(t,e,n){const r=t.substring(0,t.lastIndexOf("/")),a=new this.i(r,e,n);return a.load({skipAttributeTransform:!0}).then((n=>{let r=0,o=0;return e.buffer&&(r=e.byteOffset||0,o=e.byteLength||0),n.url=\`${Kj}t}-${Kj}r}-${Kj}o}\`,{transferables:a.transferables,gltf:n}}))}A(t,e,n,r){const a=new DataView(t,e,n),o=a.getUint32(4,!0);if(1!==o){const t="Unsupported pnts version: "+o+", url:"+r;return console.warn(t),{error:t}}if(a.getUint32(8,!0)!==a.byteLength){const t="Length in pnts header is inconsistent with pnts's byte length, url: "+r;return console.warn(t),{error:t}}const i=[t],{featureTable:s,featureTableBin:c,batchTable:u,batchTableBin:l}=Dt(a,32+e,i),f={},h=s.INSTANCES_LENGTH;if(s.POSITION){const{byteOffset:e}=s.POSITION;f.POSITION={byteStride:0,byteOffset:0,itemSize:3,count:h,componentType:5126,array:new Float32Array(t,e+c.offset,3*h).slice()},i.push(f.POSITION.array.buffer)}else if(s.POSITION_QUANTIZED){const e=s.QUANTIZED_VOLUME_OFFSET,n=s.QUANTIZED_VOLUME_SCALE,{byteOffset:r}=s.POSITION_QUANTIZED;f.POSITION={byteStride:12,byteOffset:0,itemSize:3,count:h,componentType:5126,array:this._(new Uint16Array(t,r+c.offset,3*h),e,n)},i.push(f.POSITION.array.buffer)}if(s.BATCH_ID){f.BATCH_ID=Ut(s.BATCH_ID,t,c.offset,h);const e=f.BATCH_ID.array&&f.BATCH_ID.array.buffer;e&&i.indexOf(e)<0&&i.push(e)}if(s.NORMAL_UP){let{byteOffset:e}=s.NORMAL_UP;f.NORMAL_UP={byteStride:0,byteOffset:0,itemSize:3,count:h,componentType:5126,array:new Float32Array(t,e+c.offset,3*h).slice()},i.push(f.NORMAL_UP.array.buffer),e=s.NORMAL_RIGHT.byteOffset,f.NORMAL_RIGHT={byteStride:0,byteOffset:0,itemSize:3,count:h,componentType:5126,array:new Float32Array(t,e+c.offset,3*h).slice()},i.push(f.NORMAL_RIGHT.array.buffer)}else if(s.NORMAL_UP_OCT32P){let{byteOffset:e}=s.NORMAL_UP_OCT32P;f.NORMAL_UP={byteStride:0,byteOffset:0,itemSize:3,count:h,componentType:5126,array:this.O(new Uint16Array(t,e+c.offset,2*h))},i.push(f.NORMAL_UP.array.buffer),e=s.NORMAL_RIGHT_OCT32P.byteOffset,f.NORMAL_RIGHT={byteStride:0,byteOffset:0,itemSize:3,count:h,componentType:5126,array:this.O(new Uint16Array(t,e+c.offset,2*h))},i.push(f.NORMAL_RIGHT.array.buffer)}if(s.SCALE){const{byteOffset:e}=s.SCALE;f.SCALE={byteStride:0,byteOffset:0,itemSize:1,count:h,componentType:5126,array:new Float32Array(t,e+c.offset,h).slice()},i.push(f.SCALE.array.buffer)}else if(s.SCALE_NON_UNIFORM){const{byteOffset:e}=s.SCALE_NON_UNIFORM;f.SCALE_NON_UNIFORM={byteStride:0,byteOffset:0,itemSize:3,count:h,componentType:5126,array:new Float32Array(t,e+c.offset,3*h).slice()},i.push(f.SCALE_NON_UNIFORM.array.buffer)}return{count:h,batchTable:u,batchTableBin:l,featureTable:s,i3dm:f,transferables:i}}O(t){const e=t.length/2,n=new Float32Array(3*e),r=[];for(let a=0;a<e;a++)Yt(r,t[2*a],t[2*a+1],65535),n[3*a]=r[0],n[3*a+1]=r[1],n[3*a+2]=r[2];return n}_(t,e,n){return jt(new Float32Array(t.length),t,e,n)}v(){return null}}function Yt(t,e,n,r){if(t[0]=Kt(e,r),t[1]=Kt(n,r),t[2]=1-(Math.abs(t[0])+Math.abs(t[1])),t[2]<0){const e=t[0];t[0]=(1-Math.abs(t[1]))*Qt(e),t[1]=(1-Math.abs(e))*Qt(t[1])}return b(t,t)}function Kt(t,e){return function(t,e,n){return t<e?e:t>n?n:t}(t,0,e=function(t,e){if(null!=t)return t;return e}(e,255))/e*2-1}function Qt(t){return t<0?-1:1}const{Ajax:Zt}=a();class Wt{constructor(){}load(t,e,n=0,r=0){return e?(r||(r=e.byteLength),this.m(t,e,n,r)):Zt.getArrayBuffer(t,{}).then((e=>{const a=e.data;return r||(r=a.byteLength),this.m(t,a,n,r)}))}m(t,e,n,r){return this.S(e,n,r,t).then((t=>t.error?t:{magic:"pnts",count:t.count,transferables:t.transferables,featureTable:t.featureTable,batchTable:t.batchTable,batchTableBin:t.batchTableBin,pnts:t.pnts}))}S(t,e,n,r){const a=new DataView(t,e,n),o=a.getUint32(4,!0);if(1!==o){const t="Unsupported pnts version: "+o+", url:"+r;return console.warn(t),{error:t}}if(a.getUint32(8,!0)!==a.byteLength){const t="Length in pnts header is inconsistent with pnts's byte length, url: "+r;return console.warn(t),{error:t}}const i=[t],{featureTable:s,featureTableBin:c,batchTable:u,batchTableBin:l}=Dt(a,e+28,i),f=s.QUANTIZED_VOLUME_OFFSET,h=s.QUANTIZED_VOLUME_SCALE,y=s.POINTS_LENGTH;let d,b={};if(s.extensions&&s.extensions["3DTILES_draco_point_compression"]){b=s.extensions["3DTILES_draco_point_compression"],d=new DataView(t,b.byteOffset+c.offset,b.byteLength);const e={attributes:b.properties,useUniqueIDs:!1};return this.F||(this.F=Rt().draco),this.F(d,e).then((e=>{const n=e.attributes;!s.POSITION&&!s.POSITION_QUANTIZED||n.POSITION||n.POSITION_QUANTIZED||(n.POSITION=s.POSITION,n.POSITION_QUANTIZED=s.POSITION_QUANTIZED),!(s.RGB||s.RGBA||s.RGB565)||n.RGB||n.RGBA||n.RGB565||(n.RGB=s.RGB,n.RGBA=s.RGBA,n.RGB565=s.RGB565),!s.NORMAL&&!s.NORMAL_OCT16P||n.NORMAL||n.NORMAL_OCT16P||(n.NORMAL=s.NORMAL,n.NORMAL_OCT16P=s.NORMAL_OCT16P);const r=this.I(t,e.attributes,c.offset,y,i,f,h);if(e.attributes.BATCH_ID){const t=e.attributes.BATCH_ID.array;r.BATCH_ID={byteStride:0,byteOffset:0,itemSize:1,count:t.length,componentType:Lt(t.constructor),array:t},i.push(t.buffer)}else if(s.BATCH_ID||Object.keys(u).length){s.BATCH_ID?r.BATCH_ID=Ut(s.BATCH_ID,t,c.offset,y):r.BATCH_ID=te(y);const e=r.BATCH_ID.array&&r.BATCH_ID.array.buffer;e&&i.indexOf(e)<0&&i.push(e)}return{count:y,batchTable:u,batchTableBin:l,featureTable:s,pnts:r,transferables:i}}))}const m=this.I(t,s,c.offset,y,i,f,h);if(s.BATCH_ID||Object.keys(u).length){s.BATCH_ID?m.BATCH_ID=Ut(s.BATCH_ID,t,c.offset,y):m.BATCH_ID=te(y);const e=m.BATCH_ID.array&&m.BATCH_ID.array.buffer;e&&i.indexOf(e)<0&&i.push(e)}return Promise.resolve({count:y,batchTable:u,batchTableBin:l,featureTable:s,pnts:m,transferables:i})}I(t,e,n,r,a,o,i){const s={};if(e.POSITION){let{byteOffset:o,array:i}=e.POSITION;o=o||0;const c=i?0:n;if(!i){const e=t.slice(o+c,o+c+3*r*4);i=new Float32Array(e)}s.POSITION={byteStride:0,byteOffset:0,itemSize:3,count:r,componentType:5126,array:i},a.push(i.buffer)}else if(e.POSITION_QUANTIZED){let{byteOffset:c}=e.POSITION_QUANTIZED;const{array:u}=e.POSITION_QUANTIZED;c=c||0;const l=u?0:n;s.POSITION={byteStride:0,byteOffset:0,itemSize:3,count:r,componentType:5126,array:this._(u||new Uint16Array(t,c+l,3*r),o,i)},a.push(s.POSITION.array.buffer)}if(e.RGBA){let{byteOffset:o,array:i}=e.RGBA;o=o||0;const c=i?0:n;if(!i){const e=t.slice(o+c,o+c+4*r);i=new Uint8Array(e)}s.RGBA={byteStride:0,byteOffset:0,itemSize:4,count:r,componentType:5121,array:i},a.push(i.buffer)}else if(e.RGB){let{byteOffset:o,array:i}=e.RGB;o=o||0;const c=i?0:n;if(!i){const e=t.slice(o+c,o+c+3*r);i=new Uint8Array(e)}s.RGB={byteStride:0,byteOffset:0,itemSize:3,count:r,componentType:5121,array:i},a.push(i.buffer)}else if(e.RGB565){let{byteOffset:o,array:i}=e.RGB565;o=o||0;const c=i?0:n;if(!i){const e=t.slice(o+c,o+c+2*r);i=new Uint16Array(e)}s.RGB565={byteStride:0,byteOffset:0,itemSize:1,count:r,componentType:5123,array:i},a.push(i.buffer)}if(e.NORMAL){let{byteOffset:o,array:i}=e.NORMAL;o=o||0;const c=i?0:n;if(!i){const e=t.slice(o+c,o+c+3*r*4);i=new Float32Array(e)}s.NORMAL={byteStride:0,byteOffset:0,itemSize:3,count:r,componentType:5126,array:i},a.push(i.buffer)}else if(e.NORMAL_OCT16P){let{byteOffset:o,array:i}=e.NORMAL_OCT16P;o=o||0;const c=i?0:n;if(!i){const e=t.slice(o+c,o+c+2*r);i=new Uint8Array(e)}s.NORMAL_OCT16P={byteStride:0,byteOffset:0,itemSize:2,count:r,componentType:5121,array:i},a.push(i.buffer)}return s}_(t,e,n){return jt(new Float32Array(t.length),t,e,n)}v(){return null}}function te(t){const e=(n=t)<256?Uint8Array:n<65536?Uint16Array:Uint32Array;var n;const r=new e(t);for(let e=0;e<t;e++)r[e]=e;return{byteStride:0,byteOffset:0,itemSize:1,count:t,componentType:Lt(e),array:r}}const{Ajax:ee,GLTFLoader:ne}=a();class re{constructor(t,e,n,r){this.u=n,this.o=t,this.i=e||ne,this.M=r}load(t,e,n=0,r=0,a){return e?this.m(t,e,n,r,a):ee.getArrayBuffer(t,{}).then((e=>{const a=e.data;return this.m(t,a,n,r)}))}m(t,e,n,r,a){r||(r=e.byteLength);const o=this.C(e,t,n,r),i=[];for(let n=0;n<o.length;n++){let r;if("b3dm"===o[n].magic)r=new $t(this.o,this.i,this.u);else if("i3dm"===o[n].magic)r=new Jt(this.o,this.i,this.u,this.M);else if("pnts"===o[n].magic)r=new Wt;else{if("cmpt"!==o[n].magic){console.warn("Unsupported magic in CMPT tile:",o[n].magic);continue}r=new re(this.o,this.i,this.u,this.M)}i.push(r.load(t,e,o[n].offset,o[n].byteLength,a).then((t=>t)))}return Promise.all(i).then((t=>({magic:"cmpt",tiles:t})))}C(t,e,n,r){const a=new DataView(t,n,r),o=a.getUint32(4,!0);if(1!==o){const t="Unsupported cmpt version: "+o+", url:"+e;return console.warn(t),{error:t}}if(16===a.byteLength)return[];const i=[],s=a.getUint32(12,!0);let c=16;for(let e=0;e<s;e++){const e=St(a,c),r=a.getUint32(c+8,!0);i.push({magic:e,buffer:t,offset:c+n,byteLength:r}),c+=r}return i}}const{GLTFLoader:ae}=a();function oe(t,e){if(t.scenes&&t.scenes.length)for(let n=0,r=t.scenes.length;n<r;n++){const r=t.scenes[n].nodes;for(let n=0,a=r.length;n<a;n++){const a=[];he(r[n],a,t,e)}}}const ie=[],se=[],ce=[],ue=[0,0,0],le=function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}([]),fe=[1,1,1];function he(t,e,n,r){const a=e.slice(0);if(t.matrix)a.push(t.matrix);else if(t.rotation||t.translation||t.scale){const e=function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t}(ie,t.translation||ue),n=function(t,e){var n=e[0],r=e[1],a=e[2],o=e[3],i=n+n,s=r+r,c=a+a,u=n*i,l=r*i,f=r*s,h=a*i,y=a*s,d=a*c,b=o*i,m=o*s,p=o*c;return t[0]=1-f-d,t[1]=l+p,t[2]=h-m,t[3]=0,t[4]=l-p,t[5]=1-u-d,t[6]=y+b,t[7]=0,t[8]=h+m,t[9]=y-b,t[10]=1-u-f,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}(se,t.rotation||le),r=function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}(ce,t.scale||fe);s(r,n,r);const o=s([],e,r);a.push(o)}if(t.children&&t.children.length)for(let e=0,o=t.children.length;e<o;e++)he(t.children[e],a,n,r);if(void 0!==t.mesh){const e=t.mesh,o=n.meshes[e];if(o){const t=a.slice(0),i=o.primitives;for(let a=0,o=i.length;a<o;a++){const o=i[a];o&&(o.matrices=t,r(o,e,a,n))}}}}function ye(t,e){let{byteOffset:n,byteStride:r,count:a}=t;const{componentType:o,itemSize:i}=t,s=t.array.buffer,c=o?ae.getTypedArrayCtor(o):t.array.constructor;if(n=void 0===n?t.array.byteOffset:n,r=r||0,a=a||t.array.length/i,(!r||r===i*c.BYTES_PER_ELEMENT)&&n%c.BYTES_PER_ELEMENT==0){const t=new c(s,n,a*i);for(let r=0;r<a*i;r+=i){e(new c(t.buffer,n+r*c.BYTES_PER_ELEMENT,i),r/i)}return}const u=new Uint8Array(i*c.BYTES_PER_ELEMENT);r||(r=i*c.BYTES_PER_ELEMENT);for(let t=0;t<a;t++){const a=new Uint8Array(s,r*t+n,i*c.BYTES_PER_ELEMENT);u.set(a);e(new c(u.buffer),t),a.set(u)}}var de=ge("DXT1"),be=ge("DXT3"),me=ge("DXT5"),pe=ge("DX10");function ge(t){return t.charCodeAt(0)+(t.charCodeAt(1)<<8)+(t.charCodeAt(2)<<16)+(t.charCodeAt(3)<<24)}var ve=A((function(t){var e,n,r=new Int32Array(t,0,31);if(542327876!==r[0])throw new Error("Invalid magic number in DDS header");if(4&!r[20])throw new Error("Unsupported format, must contain a FourCC code");var a=r[21];switch(a){case de:e=8,n="dxt1";break;case be:e=16,n="dxt3";break;case me:e=16,n="dxt5";break;case 116:n="rgba32f";break;case pe:var o=new Uint32Array(t.slice(128,148));n=o[0];var i=o[1];if(o[2],o[3],o[4],3!==i||2!==n)throw new Error("Unsupported DX10 texture format "+n);n="rgba32f";break;default:throw new Error("Unsupported FourCC code: "+(s=a,String.fromCharCode(255&s,s>>8&255,s>>16&255,s>>24&255)))}var s;var c=r[2],u=1;131072&c&&(u=Math.max(1,r[7]));var l=!1;512&r[28]&&(l=!0);var f,h=r[4],y=r[3],d=r[1]+4,b=h,m=y,p=[];a===pe&&(d+=20);if(l)for(var g=0;g<6;g++){if("rgba32f"!==n)throw new Error("Only RGBA32f cubemaps are supported");h=b,y=m;for(var v=Math.log(h)/Math.log(2)+1,w=0;w<v;w++)f=h*y*16,p.push({offset:d,length:f,shape:[h,y]}),w<u&&(d+=f),h=Math.floor(h/2),y=Math.floor(y/2)}else for(w=0;w<u;w++)f=Math.max(4,h)/4*Math.max(4,y)/4*e,p.push({offset:d,length:f,shape:[h,y]}),d+=f,h=Math.floor(h/2),y=Math.floor(y/2);return{shape:[b,m],images:p,format:n,flags:c,cubemap:l}})),we=Math.abs,Me=Math.sin,Te=Math.cos,Ae=Math.tan,ke=Math.atan,_e=Math.atan2,Oe=Math.sqrt,Se=Math.log,xe=Math.hypot,Fe=Math.sinh,Ie=Math.cosh,Ce=1/0;function Ee(t){var e,n,r,a,o,i,s=[],c=[],u=[],l=[];function f(t,e){for(var n,r=2*Te(2*e),a=t.length-1,o=t[a],i=0;--a>=0;)n=r*o-i+t[a],i=o,o=n;return e+n*Me(2*e)}function h(t,e,n){for(var r,a,o=Me(e),i=Te(e),s=Fe(n),c=Ie(n),u=2*i*c,l=-2*o*s,f=t.length-1,h=t[f],y=0,d=0,b=0;--f>=0;)r=d,a=y,h=u*(d=h)-r-l*(y=b)+t[f],b=l*d-a+u*y;return[(u=o*c)*h-(l=i*s)*b,u*b+l*h]}t.es,o=a=(r=t.es/(1+Oe(1-t.es)))/(2-r),s[0]=a*(2+a*(-2/3+a*(a*(116/45+a*(26/45+a*(-2854/675)))-2))),c[0]=a*(a*(2/3+a*(4/3+a*(-82/45+a*(32/45+a*(4642/4725)))))-2),o*=a,s[1]=o*(7/3+a*(a*(-227/45+a*(2704/315+a*(2323/945)))-1.6)),c[1]=o*(5/3+a*(-16/15+a*(-13/9+a*(904/315+a*(-1522/945))))),o*=a,s[2]=o*(56/15+a*(-136/35+a*(-1262/105+a*(73814/2835)))),c[2]=o*(-26/15+a*(34/21+a*(1.6+a*(-12686/2835)))),o*=a,s[3]=o*(4279/630+a*(-332/35+a*(-399572/14175))),c[3]=o*(1237/630+a*(a*(-24832/14175)-2.4)),o*=a,s[4]=o*(4174/315+a*(-144838/6237)),c[4]=o*(-734/315+a*(109598/31185)),o*=a,s[5]=o*(601676/22275),c[5]=o*(444337/155925),o=a*a,e=t.k0/(1+a)*(1+o*(1/4+o*(1/64+o/256))),u[0]=a*(a*(2/3+a*(-37/96+a*(1/360+a*(81/512+a*(-96199/604800)))))-.5),l[0]=a*(.5+a*(-2/3+a*(5/16+a*(41/180+a*(-127/288+a*(7891/37800)))))),u[1]=o*(-1/48+a*(-1/15+a*(437/1440+a*(-46/105+a*(1118711/3870720))))),l[1]=o*(13/48+a*(a*(557/1440+a*(281/630+a*(-1983433/1935360)))-.6)),o*=a,u[2]=o*(-17/480+a*(37/840+a*(209/4480+a*(-5569/90720)))),l[2]=o*(61/240+a*(-103/140+a*(15061/26880+a*(167603/181440)))),o*=a,u[3]=o*(-4397/161280+a*(11/504+a*(830251/7257600))),l[3]=o*(49561/161280+a*(-179/168+a*(6601661/7257600))),o*=a,u[4]=o*(-4583/161280+a*(108847/3991680)),l[4]=o*(34729/80640+a*(-3418889/1995840)),o*=a,u[5]=o*(-20648693/638668800),l[5]=.6650675310896665*o,i=f(c,t.phi0),n=-e*(i+function(t,e){var n,r=2*Te(e),a=t.length-1,o=t[a],i=0;for(;--a>=0;)n=r*o-i+t[a],i=o,o=n;return Me(e)*n}(l,2*i)),t.fwd=function(t,r){var a,o,i,s,u,y=t.phi,d=t.lam;y=f(c,y),a=Me(y),o=Te(y),s=Me(d),i=Te(d),y=_e(a,i*o),d=_e(s*o,xe(a,o*i)),d=function(t){var e=we(t);return e=function(t){var e=1+t,n=e-1;return 0===n?t:t*Se(e)/n}(e*(1+e/(xe(1,e)+1))),t<0?-e:e}(Ae(d)),u=h(l,2*y,2*d),y+=u[0],d+=u[1],we(d)<=2.623395162778?(r.y=e*y+n,r.x=e*d):r.x=r.y=Ce},t.inv=function(t,r){var a,o,i,c,l,y=t.y,d=t.x;y=(y-n)/e,we(d/=e)<=2.623395162778?(y+=(l=h(u,2*y,2*d))[0],d+=l[1],d=ke(Fe(d)),a=Me(y),o=Te(y),c=Me(d),i=Te(d),d=_e(c,i*o),y=_e(a*i,xe(c,i*o)),r.phi=f(s,y),r.lam=d):r.phi=r.lam=Ce}}const Ue=Math.PI/180,Ne=6378137*Math.PI/180,ze=85.0511287798,Le={};function je(t,e,n,r){if("EPSG:3857"===n)return function(t,e){const n=ze,r=e[0],a=Math.max(Math.min(n,e[1]),-n);let o;o=0===a?0:Math.log(Math.tan((90+a)*Ue/2))/Ue;return t[0]=r*Ne,t[1]=o*Ne,t}(t,e);if(!n||"EPSG:9807"!==n.code&&"Traverse_Mercator"!==n.code){if("EPSG:4326"===n||"EPSG:4490"===n||"identity"===n)return De(t,e);if("baidu"===n)return De(t,e);throw new Error("unsupported projection:"+n)}{if(!(!r||4326===r.wkid))return function(t,e){return t[0]=e[0],t[1]=e[1],t}(t,e);const a=JSON.stringify(n);let o=Le[a];return o||(o=Le[a]=function(t){const e={a:Be,es:qe,x0:ht(t.falseEasting)?5e5:t.falseEasting,y0:ht(t.falseNorthing)?0:t.falseNorthing,k0:t.scaleFactor||.9996,lam0:(t.centralMeridian||0)*Pe,phi0:(t.latitudeOfOrigin||0)*Pe,originLam0:t.startLongtitude||0,originPhi0:t.startLatitude||0};Ee(e);const n={lam:0,phi:0},r={};let a=0,o=0;(e.originLam0||e.originPhi0)&&(n.lam=e.originLam0*Pe-e.lam0,n.phi=e.originPhi0*Pe,e.fwd(n,r),a=e.a*r.x+e.x0,o=e.a*r.y+e.y0);return{project:function(t,i){n.lam=t[0]*Pe-e.lam0,n.phi=t[1]*Pe,e.fwd(n,r);const s=e.a*r.x+e.x0-a,c=e.a*r.y+e.y0-o;return i[0]=s,i[1]=c,i}}}(n)),o.project(e,t)}}function De(t,e){return t[0]=e[0],t[1]=e[1],t}const Pe=.017453292519943295,Be=6378137,qe=.0066943799901413165;const{Ajax:Re}=a(),Ve=i([]),Ge=Rt().draco,$e=Rt().ktx2,Xe={"pbrMetallicRoughness":{"baseColorFactor":[.5,.5,.5,1],"metallicFactor":0,"roughnessFactor":.5}},He={"position":{name:"POSITION",accessor:{"componentType":5126,"type":"VEC3"}},"normal":{name:"NORMAL",accessor:{"componentType":5126,"type":"VEC3"}},"uv0":{name:"TEXCOORD_0",accessor:{"componentType":5126,"type":"VEC2"}},"color":{name:"COLOR_0",accessor:{"componentType":5121,"type":"VEC4"}},"uv-region":{name:"uvRegion",accessor:{"componentType":5123,"type":"VEC4"}},"feature-index":{name:"_BATCHID",accessor:{"componentType":5125,"type":"SCALAR"}},"faceRange":{name:"faceRange",accessor:{"componentType":5125,"type":"VEC2"}}};function Je(t,e,n,r,a,o){const s=[],c=[],u=[];for(let e=0;e<t.meshes.length;e++){const{geometry:n,material:r}=t.meshes[e],a=Re.getArrayBuffer(n.url,o);a.xhr.url=n.url,u.push(a.xhr);const i=a.then((t=>({buffer:t})));s.push(i);const l=[];if(nn(r,l),l.length){const t=l.map((t=>{const e=Re.getArrayBuffer(t.url,o);return e.xhr.url=t.url,u.push(e.xhr),e.then((e=>e&&e.status?null:{buffer:e,mimeType:t.mimeType,format:t.format}))}));s.push(...t)}c[e]=l.length}const l=Promise.all(s).then((o=>{for(let t=0;t<o.length;t++)if(!o[t]||!o[t].buffer)return Promise.resolve(null);const s=[];let u=0;for(let t=0;t<c.length;t++){const e=c[t];s.push({geoBuffer:{data:o[u].buffer.data},textureBuffers:o.slice(u+1,e+u+1).map((t=>({data:t.buffer.data,mimeType:t.mimeType,format:t.format})))}),u+=1+e}const l=function(t,e,n,r,a,o){const s={asset:{generator:"i3s",version:"2.0"},extensions:{},scene:0,scenes:[{nodes:[]}],nodes:{},meshes:{},materials:[],skins:[],animations:null,textures:[],transferables:[]},c=[];for(let u=0;u<t.meshes.length;u++){let{material:l}=t.meshes[u];const{geometry:f}=t.meshes[u];let h;const y=e[u].geoBuffer.data;if(!y)continue;h=un(y)?Ke(s,u,f,y,t.transform,t.center,a,o):Ze(s,u,f,y,t.transform,t.center,a,o),c.push(h),s.nodes[u]={mesh:u,nodeIndex:u,matrix:i([])},s.scenes[0].nodes[u]=s.nodes[u],l||(l=Xe);const d=tn(u,s,l,e[u].textureBuffers,n,r);c.push(d)}return Promise.all(c).then((()=>({gltf:s,featureTable:{BATCH_LENGTH:0},transferables:s.transferables})))}(t,s,e,a,n,r);return l}));return l.xhr=u,l}const Ye={"magFilter":9728,"minFilter":9728,"wrapR":33071,"wrapS":33071,"wrapT":33071};function Ke(t,e,n,r,a,o,i,s){const c=n.info.compressedAttributes.attributes.reduce(((t,e,n)=>{const r=He[e];if(!r)return t;return t[r.name||e]=n,t}),{});return Ge(r,{attributes:c,metadatas:{"POSITION":[{name:"i3s-scale_x",type:"double"},{name:"i3s-scale_y",type:"double"}]},useUniqueIDs:!1,skipAttributeTransform:!1}).then((n=>We(n,t,e,a,o,i,s)))}const Qe={position:function(t,e,n){const r=3*t.vertexCount,a=new Float32Array(e,n,r);return t.position={array:a,componentType:5126,itemSize:3,count:r/3,meta:{"i3s-scale_x":1,"i3s-scale_y":1},type:"VEC3"},n+=4*r},normal:function(t,e,n){const r=3*t.vertexCount,a=new Float32Array(e,n,r);return t.normal={array:a,componentType:5126,itemSize:3,count:r/3,type:"VEC3"},n+=4*r},uv0:function(t,e,n){const r=2*t.vertexCount,a=new Float32Array(e,n,r);return t.uv0={array:a,componentType:5126,itemSize:2,count:r/2,type:"VEC2"},n+=4*r},color:function(t,e,n){const r=4*t.vertexCount,a=new Uint8Array(e,n,r);return t.color={array:a,componentType:5121,itemSize:4,count:r/4,type:"VEC4"},n+=r},featureId:function(t,e,n){return n+=8*t.featureCount},id:function(t,e,n){return n+=8*t.featureCount},faceRange:function(t,e,n){const r=2*t.featureCount,a=new Uint32Array(e,n,r);return t.faceRange={array:a,componentType:5125,itemSize:2,count:r/2,type:"VEC2"},n+=4*r},uvRegion:function(t,e,n){const r=4*t.vertexCount,a=new Uint16Array(e,n,r);return t["uv-region"]={array:a,componentType:5123,itemSize:4,count:r/4,type:"VEC4"},n+=2*r},region:function(t,e,n){const r=4*t.vertexCount,a=new Uint16Array(e,n,r);return t["uv-region"]={array:a,componentType:5123,itemSize:4,count:r/4,type:"VEC4"},n+=2*r}};function Ze(t,e,n,r,a,o,i,s){const c={vertexCount:0},u=new DataView(r);try{let t=0;c.vertexCount=u.getUint32(t,1),t+=4,c.featureCount=u.getUint32(t,1),t+=4;const e=n.info.ordering?null:n.info;if(e){const n=[];for(const t in e)"offset"!==t&&""!==t&&n.push(t);for(let e=0;e<n.length;e++)Qe[n[e]]?t=Qe[n[e]](c,r,t):console.error("Unknown decoder for",n[e])}else{const e=n.info;let a=e.ordering,o=e.featureAttributeOrder;const i=null;i&&i.geometryData&&i.geometryData[0]&&i.geometryData[0].params;for(let e=0;e<a.length;e++){const n=Qe[a[e]];n||console.log(a[e]),t=n(c,r,t)}for(let e=0;e<o.length;e++){const n=Qe[o[e]];n||console.log(o[e]),t=n(c,r,t)}}}catch(t){}c.scale_x=1,c.scale_y=1;const l={};for(const t in c){const e=He[t]&&He[t].name;e&&(l[e]=c[t])}if(c.faceRange){const t=c.faceRange.array,e=t.length/2,n=(f=e)<=255?Uint8Array:f<=65535?Uint16Array:Uint32Array,r=new n(l.POSITION.array.length/3);for(let e=0;e<t.length-1;e+=2){const n=e/2,a=t[e],o=t[e+1];for(let t=a;t<=o;t++)r[3*t]=n,r[3*t+1]=n,r[3*t+2]=n}l._BATCHID={componentType:Bt(n),array:r,itemSize:1,count:r.length,type:"SCALAR"}}var f;return We({attributes:l},t,e,a,o,i,s)}function We(t,e,n,r,a,o,i){const s={attributes:t.attributes,material:n,indices:t.indices,mode:4};!function(t){const e=t.array,n=t.meta&&t.meta["i3s-scale_x"],r=t.meta&&t.meta["i3s-scale_y"];if(n&&r&&(1!==n||1!==r))for(let t=0;t<e.length;t+=3)e[t]*=n.value,e[t+1]*=r.value}(t.attributes.POSITION);const u=function(t,e,n,r,a){let o,i=[0,0,0,1];const s=[0,0],u=je([],n,r,a);u[2]=n[2];const l=e&&c(Ve,e);return ye(t,(t=>(i[0]=t[0],i[1]=t[1],i[2]=t[2],l||(i=p(i,i,e)),n&&d(i,i,n),je(s,i,r,a),o=i[2],t[0]=s[0]-u[0],t[1]=s[1]-u[1],t[2]=o-u[2],t))),u}(t.attributes.POSITION,r,a,o,i);e.meshes[n]={primitives:[s],index:n},e.extensions.ispace_RTC={projCenter:u},e.extensions.CESIUM_RTC={rtcCoord:a};for(const n in t.attributes)cn(e.transferables,t.attributes[n].array.buffer);return t.indices&&cn(e.transferables,t.indices.array.buffer),s}function tn(t,e,n,r,a,o){const i=r.map((t=>function(t,e,n,r,a){if("dds"===e){const e=ve(t),r=e.images.map((e=>new Uint8Array(t,e.offset,e.length))),a="dxt1"===e.format?33777:33779;return Promise.resolve({image:{mipmap:r,width:e.shape[0],height:e.shape[1],mimeType:n},sampler:Ye,format:a})}if("png"===e||"jpg"===e)return function(t,e){rn||(rn=new OffscreenCanvas(2,2),an=rn.getContext("2d",{willReadFrequently:!0}));const n=new Blob([new Uint8Array(t)]);return createImageBitmap(n).then((t=>{let{width:n,height:r}=t;on(n)||(n=sn(n)),on(r)||(r=sn(r));const a=e;a&&(n=Math.min(a,n),r=Math.min(a,r)),rn.width=n,rn.height=r,an.drawImage(t,0,0,n,r),t.close();const o=an.getImageData(0,0,n,r);return{width:n,height:r,array:new Uint8Array(o.data)}})).catch((()=>({width:2,height:2,array:new Uint8Array(4)})))}(t,a).then((t=>{t.mimeType=n;return{image:t,sampler:Ye,format:6408}}));if("ktx2"===e)return $e(t,r).then((t=>(t.mimeType=n,{image:t,sampler:Ye,format:t.format})));return null}(t.data,t.format,t.mimeType,a,o).then((t=>{if(t.image)if(t.image.array)cn(e.transferables,t.image.array.buffer);else if(t.image.mipmap)for(let n=0;n<t.image.mipmap.length;n++)cn(e.transferables,t.image.mipmap[n].buffer);return t}))));return Promise.all(i).then((r=>{en(t,e,n,r)}))}function en(t,e,n,r){const a=JSON.parse(JSON.stringify(n)),o=e.textures;r.ptr||(r.ptr=0);for(const t in n)n[t]&&n[t].url?(o.push(r[r.ptr++]),a[t]={index:o.length-1},void 0!==n[t].factor&&(a[t].scale=n[t].factor)):yt(n[t])&&(a[t]=en(-1,e,n[t],r));return t>=0&&(e.materials[t]=a),a}function nn(t,e){for(const n in t)t[n]&&t[n].url?e.push({url:t[n].url,mimeType:t[n].mimeType,format:t[n].format}):yt(t[n])&&nn(t[n],e)}let rn,an;function on(t){return!(t&t-1)&&0!==t}function sn(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))}function cn(t,e){e&&(t.indexOf(e)>=0||t.push(e))}function un(t){const e=new Uint8Array(t,0,5);return e[0]==="D".charCodeAt()&&e[1]==="R".charCodeAt()&&e[2]==="A".charCodeAt()&&e[3]==="C".charCodeAt()&&e[4]==="O".charCodeAt()}var ln="undefined"!=typeof Float32Array?Float32Array:Array;function fn(t,e,n,r){return t[0]=e,t[1]=n,t[2]=r,t}var hn=function(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t};!function(){var t=function(){var t=new ln(3);return ln!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}()}();const yn=[];const dn=[],bn=[],mn=[],pn=[],gn=[],vn=[],wn=[];function Mn(t,e,n,r,a,o){fn(pn,t[3*e],t[3*e+1],t[3*e+2]),fn(gn,t[3*n],t[3*n+1],t[3*n+2]),fn(vn,t[3*r],t[3*r+1],t[3*r+2]);const i=hn(dn,vn,gn),s=hn(bn,pn,gn),c=function(t,e,n){var r=e[0],a=e[1],o=e[2],i=n[0],s=n[1],c=n[2];return t[0]=a*c-o*s,t[1]=o*i-r*c,t[2]=r*s-a*i,t}(mn,i,s);!function(t,e){var n=e[0],r=e[1],a=e[2],o=n*n+r*r+a*a;o>0&&(o=1/Math.sqrt(o),t[0]=e[0]*o,t[1]=e[1]*o,t[2]=e[2]*o)}(wn,c),a[3*e]=a[3*e]||0,a[3*n]=a[3*n]||0,a[3*r]=a[3*r]||0,a[3*e+1]=a[3*e+1]||0,a[3*n+1]=a[3*n+1]||0,a[3*r+1]=a[3*r+1]||0,a[3*e+2]=a[3*e+2]||0,a[3*n+2]=a[3*n+2]||0,a[3*r+2]=a[3*r+2]||0,a[3*e]+=wn[0],a[3*n]+=wn[0],a[3*r]+=wn[0],a[3*e+1]+=wn[1],a[3*n+1]+=wn[1],a[3*r+1]+=wn[1],a[3*e+2]+=wn[2],a[3*n+2]+=wn[2],a[3*r+2]+=wn[2],o[e]+=1,o[n]+=1,o[r]+=1}const{Ajax:Tn,GLTFLoader:An}=a(),kn=[1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1],_n=[0,0,1,0,0,1,0,0,-1,0,0,0,0,0,0,1],On=2*Math.PI*6378137/360,Sn="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;let xn,Fn,In=!1;if("undefined"!=typeof OffscreenCanvas){try{Fn=new OffscreenCanvas(2,2).getContext("2d",{willReadFrequently:!0})}catch(t){}Fn&&"undefined"!=typeof createImageBitmap&&(In=!0)}const Cn=i([]),En=[0,0,0],Un=[],Nn=[],zn=[],Ln=[],jn={"POSITION":1,"TEXCOORD_0":1,"TEXCOORD_1":1,"NORMAL":1,"TANGENT":1},Dn={"TEXCOORD_0":1e-4,"TEXCOORD_1":1e-4};let Pn;class Bn{constructor(t,e,n,r){this.id=t,this.options=e,this.U=(...t)=>this.requestImage.call(this,...t),this.N=n,this.L={},r(null,{},[])}j(t){this.D||(this.u=t,this.P=new Wt,this.D=new $t(this.U,An,t),this.B=new Jt(this.U,An,t))}requestImage(t,e){In?fetch(t).then((t=>t.arrayBuffer())).then((t=>{const e=new self.Blob([new Uint8Array(t)]);return createImageBitmap(e)})).then((t=>{xn.width=t.width,xn.height=t.height,Fn.drawImage(t,0,0);const n=Fn.getImageData(0,0,xn.width,xn.height);t.close(),e(null,{width:t.width,height:t.height,data:new Uint8Array(n.data)})})):this.N("requestImage",{url:t},null,e)}loadTile(t,e){this.j(t.supportedFormats);const{service:n,url:r,arraybuffer:a}=t,o=n.fetchOptions||{};if(o.referrer=t.referrer,o.referrerPolicy=o.referrerPolicy||"origin",function(t){return t.indexOf("i3s:")>=0}(r)){const a=t.i3sInfo,i=n.maxTextureSize||0,s=Je(a,t.supportedFormats,this.options.projection,t.projection,i,o);return s.then((t=>{if(delete this.L[r],!t)return void e({status:404,url:r,i3sInfo:a});if(!Object.keys(t.gltf.meshes).length)return void e({status:404,url:r,i3sInfo:a});t.gltf.url=r;const{transferables:o}=t;t.magic="b3dm",n.createNormalIfMissed&&this.q(t.gltf),Yn(n)&&this.R(t.gltf),e(null,t,o)})),void(this.L[r]=s.xhr)}if(a){delete this.L[r];const n=St(new DataView(a),0);if("{"===n[0]||" "===n[0]||"<"===n[0]){const n=function(t,e,n){if(Sn){const r=new Uint8Array(t,e,n);return Sn.decode(r)}return mt(new Uint8Array(t,e,n))}(a,0,a.byteLength),o=JSON.parse(n);o.accessors?this.V(o,r,t,"gltf",e):this.G(t.rootIdx,o,a,r,e)}else this.V(a,r,t,n,e)}else{let a=n.urlParams;a&&(a=(r.indexOf("?")>0?"&":"?")+a);const i=r.replace(/\\+/g,"%2B");let s=Tn.getArrayBuffer(i+(a||""),o);const c=s.xhr;s=s.then((n=>{delete this.L[r],n&&n.status?e(n):(t.arraybuffer=n&&n.data,this.loadTile(t,e))})).catch((t=>{delete this.L[r],e(t)})),this.L[r]=c}}V(t,e,n,r,a){r=r&&r.toLowerCase();const{service:o}=n;if("b3dm"===r){this.D.load(e,t,0,0,{maxTextureSize:o.maxTextureSize||0}).then((t=>{if(t.error)return void a(t);const{content:e,transferables:r}=this.$(t,n);o.createNormalIfMissed&&this.q(e.gltf),Yn(o)&&this.R(e.gltf),a(null,e,r)})).catch((t=>{a(t)}))}else if("pnts"===r){const r=n.transform||Cn;this.P.load(e,t).then((t=>{const{content:e,transferables:o}=this.X(t,r,n.rootIdx);this.H(e),a(null,e,o)}))}else if("i3dm"===r){const r=n.transform||Cn;this.B.load(e,t,0,0,{maxTextureSize:o.maxTextureSize||0}).then((t=>{const{content:e,transferables:i}=this.J(t,r,n.rootIdx);o.createNormalIfMissed&&this.q(e.gltf),Yn(o)&&this.R(e.gltf),a(null,e,i)}))}else if("cmpt"===r){new re(this.U,An,this.u,o.maxTextureSize||0).load(e,t,0,0,{maxTextureSize:o.maxTextureSize||0}).then((t=>{const{content:e,transferables:r}=this.Y(t,n);this.K(e,o),Yn(o)&&this.Z(e),a(null,e,r)})).catch((t=>{a(t)}))}else if("gltf"===r){this.h||(this.h=Rt());const r=e.substring(0,e.lastIndexOf("/")),i=t instanceof ArrayBuffer&&{buffer:t,byteOffset:0,byteLength:t.byteLength}||t;let s;try{s=new An(r,i,{transferable:!0,requestImage:this.U,decoders:this.h,supportedFormats:this.u,maxTextureSize:o.maxTextureSize||0})}catch(t){a(t)}s.load({skipAttributeTransform:!1}).then((t=>{t.url=e,this.W(t,null,n),o.createNormalIfMissed&&this.q(t),Yn(o)&&this.R(t),a(null,{magic:"gltf",gltf:t},s.transferables)}))}else a(new Error("unsupported tile format: "+r))}K(t,e){t.content?t.content.forEach((t=>{this.K(t,e)})):e.createNormalIfMissed&&this.q(t.gltf)}Z(t){t.content?t.content.forEach((t=>{this.Z(t)})):this.R(t.gltf)}tt(t,e){if(this.et(t,e)&&!t.attributes.NORMAL){const e=t.attributes.POSITION.array,n=e.length,r=this.nt()?Pn.subarray(0,n):e,a=function(t,e,n){const r=n||[];r.setLength&&r.setLength(t.length);const a=yn;a.length<t.length/3&&(a.length=t.length/3),a.fill(0,0,t.length/3);const o=void 0===e.length?e:e.length;for(let n=0;n<o/3;n++)void 0===e.length?Mn(t,3*n,3*n+1,3*n+2,r,a):Mn(t,e[3*n],e[3*n+1],e[3*n+2],r,a);for(let t=0;t<r.length;t+=3){const e=a[t/3];0!==e?(r[t]/=e,r[t+1]/=e,r[t+2]/=e):(r[t]=0,r[t+1]=0,r[t+2]=0)}return r}(r,t.indices.array,new Float32Array(r.length));t.attributes.NORMAL={array:a,byteLength:a.byteLength,byteOffset:0,byteStride:0,componentType:5126,count:a.length/3,itemSize:3,name:"NORMAL",type:"VEC3"}}}R(t){if(!t||!t.meshes||t.extensionsUsed&&t.extensionsUsed.indexOf("KHR_techniques_webgl")>-1)return;if(t.asset&&t.asset.sharePosition)return;const e=t.meshes;for(const t in e){e[t].primitives.forEach((t=>{t.compressed_int16_params={};const e=t.attributes;for(const n in e)if(jn[n]&&e[n].array&&e[n].array instanceof Float32Array){let r=1;this.nt()&&"POSITION"===n&&(r=On,t.compressed_int16_params.compressed_ratio=r);const a=Xn(e[n].array,r,e[n].min,e[n].max,n);if(!a)continue;const{array:o,range:i}=a;e[n].componentType=5124,e[n].array=o,t.compressed_int16_params[n]=i}}))}}q(t){if(!t||!t.meshes||t.extensionsUsed&&t.extensionsUsed.indexOf("KHR_techniques_webgl")>-1)return;if(t.asset&&t.asset.sharePosition)return;const e=t.meshes;for(const n in e){e[n].primitives.forEach((e=>{this.tt(e,t)}))}}H(t){if(!t||!t.pnts)return;const e=t.pnts;t.compressed_int16_params={};for(const n in e)if(jn[n]&&e[n].array&&e[n].array instanceof Float32Array){let r=1;this.nt()&&"POSITION"===n&&(r=On,t.compressed_int16_params.compressed_ratio=r);const{array:a,range:o}=Xn(e[n].array,r,e[n].min,e[n].max,n);e[n].array=a,t.compressed_int16_params[n]=o}}rt(t){const e=[];for(let n=0;n<t.length;n++){const r=t[n];if(!r.childTile)continue;const a={boundingVolume:{sphere:[r.boundingSphere.center.x,r.boundingSphere.center.y,r.boundingSphere.center.z,r.boundingSphere.radius]},content:{uri:r.childTile},geometricError:r.boundingSphere.radius/r.rangeList*16,refine:"REPLACE"};e.push(a)}return e}G(t,e,n,r,a){return e.capabilities,void a(null,e)}Y(t,e){const{tiles:n}=t,r={magic:"cmpt",content:[]},a=[];for(let t=0;t<n.length;t++){const{magic:o}=n[t];if("b3dm"===o){const{content:o,transferables:i}=this.$(n[t],e);Gn(a,i),r.content.push(o)}else if("i3dm"===o){const{transform:o,rootIdx:i}=e,{content:s,transferables:c}=this.J(n[t],o,i);Gn(a,c),r.content.push(s)}else if("pnts"===o){const{transform:o,rootIdx:i}=e,{content:s,transferables:c}=this.X(n[t],o,i);Gn(a,c),r.content.push(s)}else if("cmpt"===o){const{content:o,transferables:i}=this.Y(n[t],e);Gn(a,i),r.content.push(o)}}return{content:r,transferables:a}}$(t,e){const{gltf:n,transferables:r,featureTable:a}=t;return this.W(n,a,e),delete t.transferables,{content:t,transferables:r}}W(t,e,n){const r=function(t){if(!t||!t.meshes)return!1;if(t.extensions&&t.extensions.KHR_techniques_webgl)return!0;const e="visited";let n=1;const r=[];for(const a in t.meshes){const o=t.meshes[a],{primitives:i}=o;if(i)for(let t=0;t<i.length;t++){const a=i[t].attributes&&i[t].attributes.POSITION;if(!a||!a.array)continue;a.array.buffer[e]||(a.array.buffer[e]=n++);const o=n-1+"-"+(a.byteOffset||0);if(r.indexOf(o)>=0)return!0;r.push(o)}}return!1}(t);this.ot(t);n.service.createNormalIfMissed||this.it(t),t.asset||(t.asset={}),r?(t.asset.sharePosition=!0,this.st(t,e,n.upAxis,n.transform)):this.ct(t,e,n.upAxis,n.transform)}J(t,e,n){const{featureTable:r}=t,a=t.i3dm,o=r&&r.RTC_CENTER||[0,0,0],i=this.options.projection,s=e&&c(Cn,e),u={xmin:1/0,xmax:-1/0,ymin:1/0,ymax:-1/0,hmin:1/0,hmax:-1/0};Rn(a.POSITION.array,3,o,Cn,u);const l=Vn(u);e&&!s&&p(l,l,e);const f=this.ut(l),d=[];je(d,f,i),d[2]=f[2];const b=h([],l),m=[0,0,0],g=[0,0,0],v=[0,0],M=[1/0,1/0,1/0],T=[-1/0,-1/0,-1/0];ye(a.POSITION,(t=>{m[0]=t[0]+o[0],m[1]=t[1]+o[1],m[2]=t[2]+o[2],e&&!s&&p(m,m,e),0===w(m)?y(g,0,0,-6378137):Tt(g,m),je(v,g,i),t[0]=v[0]-d[0],t[1]=v[1]-d[1],t[2]=g[2]-d[2],t[0]<M[0]&&(M[0]=t[0]),t[1]<M[1]&&(M[1]=t[1]),t[2]<M[2]&&(M[2]=t[2]),t[0]>T[0]&&(T[0]=t[0]),t[1]>T[1]&&(T[1]=t[1]),t[2]>T[2]&&(T[2]=t[2])})),a.POSITION.min=M,a.POSITION.max=T,e&&p(l,l,e),t.rtcCenter=b,t.rtcCoord=f,t.projCenter=d,t.rootIdx=n;const A=t.transferables;return delete t.transferables,{content:t,transferables:A}}X(t,e,n){const{featureTable:r}=t,a=t.pnts,o=r&&r.RTC_CENTER||[0,0,0],i=this.options.projection,s=e&&c(Cn,e),u={xmin:1/0,xmax:-1/0,ymin:1/0,ymax:-1/0,hmin:1/0,hmax:-1/0};Rn(a.POSITION.array,3,o,e,u);const l=Vn(u),f=this.lt(l),d=h([],l),b=[1/0,1/0,1/0],m=[-1/0,-1/0,-1/0];let g=[0,0,0,1];const v=[0,0,0],M=[0,0];ye(a.POSITION,(t=>(g[0]=t[0]+o[0],g[1]=t[1]+o[1],g[2]=t[2]+o[2],e&&!s&&(g=p(g,g,e)),0===w(g)?y(v,0,0,-6378137):Tt(v,g),je(M,v,i),t[0]=M[0]-f[0],t[1]=M[1]-f[1],t[2]=v[2]-f[2],t[0]<b[0]&&(b[0]=t[0]),t[1]<b[1]&&(b[1]=t[1]),t[2]<b[2]&&(b[2]=t[2]),t[0]>m[0]&&(m[0]=t[0]),t[1]>m[1]&&(m[1]=t[1]),t[2]>m[2]&&(m[2]=t[2]),t))),a.POSITION.min=b,a.POSITION.max=m,e&&p(l,l,e);const T=this.ut(l);t.rtcCenter=d,t.projCenter=f,t.rtcCoord=T,t.rootIdx=n;const A=t.transferables;return delete t.transferables,{content:t,transferables:A}}ot(t){if(!Array.isArray(t.textures))return;const e=t.textures;for(let t=0;t<e.length;t++){const n=e[t]&&e[t].image&&e[t].image.array;if(n&&n.length){const r=n[0],a=n[1],o=n[2],i=n[3];let s=!0;for(let t=4;t<n.length;t+=4)if(n[t]!==r||n[t+1]!==a||n[t+2]!==o||n[t+3]!==i){s=!1;break}s&&(e[t].image.color=[r/255,a/255,o/255,i/255],delete e[t].image.array)}}}it(t){const e=t.meshes;for(const n in e){const r=e[n];if(!r)continue;const a=r.primitives;if(a)for(let e=0;e<a.length;e++){if(!a[e])continue;if(!a[e].attributes||a[e].attributes.NORMAL)continue;const n=a[e].material;if(!ht(n)){const e=t.materials[n];if(!e)continue;e.extensions||(e.extensions={}),e.extensions.KHR_materials_unlit={}}}}}abortTileLoading(t,e){const n=this.L[t.url];if(Array.isArray(n))for(let t=0;t<n.length;t++)n[t].abort();else n&&n.abort&&n.abort();delete this.L[t.url],e(null)}ft(t,e,n,r){const a=e&&e.RTC_CENTER||t.extensions&&t.extensions.CESIUM_RTC&&t.extensions.CESIUM_RTC.center;let o=kn;"X"===(n=n&&n.toUpperCase())?o=_n:"Z"===n&&(o=Cn),t.extensions=t.extensions||{},t.extensions.CESIUM_RTC||(t.extensions.CESIUM_RTC={}),a&&(t.extensions.CESIUM_RTC.center=a),t.extensions.ispace_RTC={};const c={xmin:1/0,xmax:-1/0,ymin:1/0,ymax:-1/0,hmin:1/0,hmax:-1/0};oe(t,(t=>{if(!(t.attributes&&t.attributes.POSITION))return;const e=i(Un);t.matrices&&$n(e,t.matrices);const n=t.attributes.POSITION.array,u=t.attributes.POSITION.itemSize;s(e,o,e),r&&s(e,r,e),Rn(n,u,a||En,e,c,t.compressUniforms)}));const u=Vn(c);return{rtcCenter:a,modelCenter:u,upAxisTransform:o}}st(t,e,n,r){const{modelCenter:a,upAxisTransform:o,rtcCenter:c}=this.ft(t,e,n),u=this.lt(a);t.extensions.ispace_RTC.projCenter=u,t.extensions.ispace_RTC.rtcCoord=t.extensions.CESIUM_RTC.rtcCoord=this.ut(a);const l=h([],a);r&&p(a,a,r),t.extensions.CESIUM_RTC.rtcCoord=this.ut(a),c||(oe(t,(t=>{if(t.attributes&&t.attributes.POSITION){const e=t.attributes.POSITION;if(e.array.buffer.projected&&e.array.buffer.projected[e.byteOffset])return;const n=i(Un);t.matrices&&$n(n,t.matrices),s(n,o,n);const r=function(t,e){var n=e[0],r=e[1],a=e[2],o=e[3],i=e[4],s=e[5],c=e[6],u=e[7],l=e[8],f=e[9],h=e[10],y=e[11],d=e[12],b=e[13],m=e[14],p=e[15],g=n*s-r*i,v=n*c-a*i,w=n*u-o*i,M=r*c-a*s,T=r*u-o*s,A=a*u-o*c,k=l*b-f*d,_=l*m-h*d,O=l*p-y*d,S=f*m-h*b,x=f*p-y*b,F=h*p-y*m,I=g*F-v*x+w*S+M*O-T*_+A*k;return I?(I=1/I,t[0]=(s*F-c*x+u*S)*I,t[1]=(a*x-r*F-o*S)*I,t[2]=(b*A-m*T+p*M)*I,t[3]=(h*T-f*A-y*M)*I,t[4]=(c*O-i*F-u*_)*I,t[5]=(n*F-a*O+o*_)*I,t[6]=(m*w-d*A-p*v)*I,t[7]=(l*A-h*w+y*v)*I,t[8]=(i*x-s*O+u*k)*I,t[9]=(r*O-n*x-o*k)*I,t[10]=(d*T-b*w+p*g)*I,t[11]=(f*w-l*T-y*g)*I,t[12]=(s*_-i*S-c*k)*I,t[13]=(n*S-r*_+a*k)*I,t[14]=(b*v-d*M-m*g)*I,t[15]=(l*M-f*v+h*g)*I,t):null}(Nn,n),a=[1/0,1/0,1/0],c=[-1/0,-1/0,-1/0];ye(e,(t=>{p(t,t,n),t[0]=t[0]-l[0],t[1]=t[1]-l[1],t[2]=t[2]-l[2],p(t,t,r),t[0]<a[0]&&(a[0]=t[0]),t[1]<a[1]&&(a[1]=t[1]),t[2]<a[2]&&(a[2]=t[2]),t[0]>c[0]&&(c[0]=t[0]),t[1]>c[1]&&(c[1]=t[1]),t[2]>c[2]&&(c[2]=t[2])})),e.min=a,e.max=c,e.array.buffer.projected||(e.array.buffer.projected={}),e.array.buffer.projected[e.byteOffset]=1}})),t.extensions.CESIUM_RTC.center=l)}ct(t,e,n,r){const{modelCenter:a,rtcCenter:o}=this.ft(t,e,n,r),i=this.lt(a);t.extensions.ispace_RTC.projCenter=i,t.extensions.ispace_RTC.rtcCoord=t.extensions.CESIUM_RTC.rtcCoord=this.ut(a),oe(t,(e=>{if(e.attributes&&e.attributes.POSITION){const a=this.et(e,t);if(a){const t=e.attributes.POSITION.array.length;(!Pn||Pn.length<t)&&(Pn=new Float32Array(t))}e.attributes.NORMAL&&this.ht(e.attributes.NORMAL,e.matrices,n),e.attributes.TANGENT&&this.ht(e.attributes.TANGENT,e.matrices,n);const{newPositions:i}=this.yt(e.attributes.POSITION,e.matrices,o,t.extensions.ispace_RTC,n,r,e.compressUniforms,a),{componentType:s}=e.attributes.POSITION;5126!==s&&(e.attributes.POSITION.array=new Float32Array(i))}}));for(const e in t.nodes){t.nodes[e].matrix=Cn}}lt(t){const e=this.options.projection;"identity"===e?h(zn,t):0===w(t)?y(zn,0,0,-6378137):Tt(zn,t),je(Ln,zn,e);const n=zn[2],r=[];return r[0]=Ln[0],r[1]=Ln[1],r[2]=n,r}ht(t,e,n){let r;r="Y"===n?kn:"X"===n?_n:Cn;const a=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}([],r);if($n(a,e),c(a,Cn))return;const o=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t}([],a),i=[];ye(t,(t=>(function(t,e,n){var r=e[0],a=e[1],o=e[2];t[0]=r*n[0]+a*n[3]+o*n[6],t[1]=r*n[1]+a*n[4]+o*n[7],t[2]=r*n[2]+a*n[5]+o*n[8]}(i,t,o),b(i,i),h(t,i),i)))}yt(t,e,n,r,a,o,s,u){if(t.array.buffer.projected&&t.array.buffer.projected[t.byteOffset])return null;const l=i([]);$n(l,e);const f=this.options.projection;a=a&&a.toUpperCase();const h=n;let b=null;"Y"===a?b=kn:"X"===a&&(b=_n);let m=[0,0,0,1];const g=[0,0,0],v=[0,0],M=r.projCenter,T=je([],r.rtcCoord,"EPSG:3857"),A=o&&c(Cn,o),k=t.min=t.min||[],_=t.max=t.max||[];y(k,1/0,1/0,1/0),y(_,-1/0,-1/0,-1/0);const O=s||{},{decode_position_min:S,decode_position_normConstant:x}=O;let F=[0,0,0,0],I=1;S&&(F=S),x&&(I=x);const C=[];return ye(t,((e,n)=>{if(m[0]=e[0]*I+F[0],m[1]=e[1]*I+F[1],m[2]=e[2]*I+F[2],m=p(m,m,l),b&&(m=p(m,m,b)),h&&d(m,m,h),o&&!A&&(m=p(m,m,o)),0===w(m)?y(g,0,0,-6378137):Tt(g,m),u){const t=Pn;je(v,g,f),t[3*n]=v[0]-T[0],t[3*n+1]=v[0]-T[1],t[3*n+2]=v[0]-T[2]}if(je(v,g,f),e instanceof Float32Array)e[0]=v[0]-M[0],e[1]=v[1]-M[1],e[2]=g[2]-M[2];else{const n=v[0]-M[0],r=v[1]-M[1],a=g[2]-M[2];5126!==t.componentType&&(C.push(n),C.push(r),C.push(a),C.push(e[3]))}return e[0]<k[0]&&(k[0]=e[0]),e[1]<k[1]&&(k[1]=e[1]),e[2]<k[2]&&(k[2]=e[2]),e[0]>_[0]&&(_[0]=e[0]),e[1]>_[1]&&(_[1]=e[1]),e[2]>_[2]&&(_[2]=e[2]),e})),t.array.buffer.projected||(t.array.buffer.projected={}),t.array.buffer.projected[t.byteOffset]=1,{projCenter:M,newPositions:C}}ut(t){return 0===w(t)?y([],0,0,-6378137):Tt([],t)}onRemove(){}nt(){return"EPSG:4326"===this.options.projection||"EPSG:4490"===this.options.projection}et(t,e){if(!t.attributes.POSITION||function(t,e){const n=e.materials[t.material],r=n&&n.extensions&&n.extensions.KHR_materials_unlit;return r}(t,e))return!1;return!t.attributes.TANGENT}}const qn=[];function Rn(t,e,n,r,a,o){const i=o||{},{decode_position_min:s,decode_position_normConstant:c}=i;let u=[0,0,0,0],l=1;s&&(u=s),c&&(l=c);for(let o=0,i=t.length;o<i;o+=e){const{xmin:i,ymin:s,xmax:c,ymax:f,hmin:h,hmax:b}=a;y(qn,t[o]*l+u[0],t[o+1]*l+u[1],t[o+2]*l+u[2]),p(qn,qn,r);const m=d(qn,n,qn);m[0]<i&&(a.xmin=m[0]),m[0]>c&&(a.xmax=m[0]),m[1]<s&&(a.ymin=m[1]),m[1]>f&&(a.ymax=m[1]),e>2&&(m[2]<h&&(a.hmin=m[2]),m[2]>b&&(a.hmax=m[2]))}}function Vn(t){const{xmax:e,ymax:n,xmin:r,ymin:a,hmin:o,hmax:i}=t,s=[(r+e)/2,(a+n)/2,(o+i)/2];return e===-1/0&&(s[0]=0),n===-1/0&&(s[1]=0),i===-1/0&&(s[2]=0),isNaN(s[2])&&(s[2]=0),s}function Gn(t,e){for(let n=0;n<e.length;n++)t.indexOf(e[n])<0&&t.push(e[n])}function $n(t,e){const n=t;for(let t=e.length-1;t>=0;t--)s(n,e[t],n);return n}function Xn(t,e,n,r,a){if(e&&e>1)for(let n=0;n<t.length;n++)(n+1)%3!=0&&(t[n]*=e);let o,i;if(n&&r&&1===e)o=Math.min(...n),i=Math.max(...r);else{const{min:e,max:n}=function(t){let e=1/0,n=-1/0;for(let r=0;r<t.length;r++)t[r]>n&&(n=t[r]),t[r]<e&&(e=t[r]);return{min:e,max:n}}(t);o=e,i=n}return!function(t,e,n,r){for(let a=0;a<t.length;a++){const o=Hn(Jn(t[a],e,n),e,n);if(Math.abs(o-t[a])>Dn[r])return!1}return!0}(t,o,i,a)&&Dn[a]?null:function(t,e,n){const r=new Int16Array(t.length);for(let a=0;a<t.length;a++)r[a]=Jn(t[a],e,n);return{array:r,range:[e,n]}}(t,o,i)}function Hn(t,e,n){return((t>=32768?-(65536-t)/32768:t/32767)+1)*(n-e)/2+e}function Jn(t,e,n){const r=2*(t-e)/(n-e)-1,a=Math.max(-1,Math.min(1,r));return a<0?32768*a:32767*a}function Yn(t){return void 0===t.compressGeometry||t.compressGeometry}let Kn=0;class Qn{constructor(t){this.workerId=t,this.workers={},this.dt={}}addLayer({actorId:t,mapId:e,layerId:n,params:r},a){if(this.bt(e,n))return;const o=this.gt(e,n),i=r.options;this.workers[o]=new Bn(n,i,((...e)=>this.send.call(this,t,...e)),a)}removeLayer({mapId:t,layerId:e},n){const r=this.bt(t,e),a=this.gt(t,e);delete this.workers[a],r&&r.onRemove(n)}loadTile({mapId:t,layerId:e,params:n},r){const a=this.bt(t,e);a&&a.loadTile(n,r)}abortTileLoading({mapId:t,layerId:e,params:n},r){const a=this.bt(t,e);a&&a.abortTileLoading(n,r)}receive(t){const e=t.callback,n=this.dt[e];delete this.dt[e],n&&t.error?n(new Error(t.error)):n&&n(null,t.data)}send(t,e,n,r,a){const o=a?\`${Kj}t}-${Kj}Kn++}\`:null;a&&(this.dt[o]=a),postMessage({type:"<request>",workerId:this.workerId,actorId:t,command:e,params:n,callback:String(o)},r||[])}gt(t,e){return\`${Kj}t}-${Kj}e}\`}bt(t,e){const n=this.gt(t,e);return this.workers[n]}}t.initialize=function(){},t.onmessage=function(t,e){const n=t.data;this.dispatcher||(this.dispatcher=new Qn(t.workerId)),"<response>"===t.type?this.dispatcher.workerId===t.workerId&&this.dispatcher.receive(t):this.dispatcher[n.command]({actorId:n.actorId,mapId:n.mapId,layerId:n.layerId,params:n.params},((t,n,r)=>{t&&404!==t.status&&204!==t.status&&console.error(t),t instanceof Error&&(t={message:t.message}),e(t,n,r)}))}}`;var tU={exports:{}},eU={exports:{}},nU=function(t){return!(!t||"string"==typeof t)&&(t instanceof Array||Array.isArray(t)||t.length>=0&&(t.splice instanceof Function||Object.getOwnPropertyDescriptor(t,t.length-1)&&"String"!==t.constructor.name))},iU=Array.prototype.concat,rU=Array.prototype.slice,oU=eU.exports=function(t){for(var e=[],n=0,i=t.length;n<i;n++){var o=t[n];nU(o)?e=iU.call(e,rU.call(o)):e.push(o)}return e};oU.wrap=function(t){return function(){return t(oU(arguments))}};var sU={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},aU=eU.exports,lU=Object.hasOwnProperty,hU=Object.create(null);for(var cU in sU)lU.call(sU,cU)&&(hU[sU[cU]]=cU);var uU=tU.exports={to:{},get:{}};function fU(t,e,n){return Math.min(Math.max(e,t),n)}function dU(t){var e=Math.round(t).toString(16).toUpperCase();return e.length<2?"0"+e:e}uU.get=function(t){var e,n;switch(t.substring(0,3).toLowerCase()){case"hsl":e=uU.get.hsl(t),n="hsl";break;case"hwb":e=uU.get.hwb(t),n="hwb";break;default:e=uU.get.rgb(t),n="rgb"}return e?{model:n,value:e}:null},uU.get.rgb=function(t){if(!t)return null;var e,n,i,o=[0,0,0,1];if(e=t.match(/^#([a-f0-9]{6})([a-f0-9]{2})?$/i)){for(i=e[2],e=e[1],n=0;n<3;n++){var s=2*n;o[n]=parseInt(e.slice(s,s+2),16)}i&&(o[3]=parseInt(i,16)/255)}else if(e=t.match(/^#([a-f0-9]{3,4})$/i)){for(i=(e=e[1])[3],n=0;n<3;n++)o[n]=parseInt(e[n]+e[n],16);i&&(o[3]=parseInt(i+i,16)/255)}else if(e=t.match(/^rgba?\(\s*([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/)){for(n=0;n<3;n++)o[n]=parseInt(e[n+1],0);e[4]&&(o[3]=e[5]?.01*parseFloat(e[4]):parseFloat(e[4]))}else{if(!(e=t.match(/^rgba?\(\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/)))return(e=t.match(/^(\w+)$/))?"transparent"===e[1]?[0,0,0,0]:lU.call(sU,e[1])?((o=sU[e[1]])[3]=1,o):null:null;for(n=0;n<3;n++)o[n]=Math.round(2.55*parseFloat(e[n+1]));e[4]&&(o[3]=e[5]?.01*parseFloat(e[4]):parseFloat(e[4]))}for(n=0;n<3;n++)o[n]=fU(o[n],0,255);return o[3]=fU(o[3],0,1),o},uU.get.hsl=function(t){if(!t)return null;var e=t.match(/^hsla?\(\s*([+-]?(?:\d{0,3}\.)?\d+)(?:deg)?\s*,?\s*([+-]?[\d\.]+)%\s*,?\s*([+-]?[\d\.]+)%\s*(?:[,|\/]\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/);if(e){var n=parseFloat(e[4]);return[(parseFloat(e[1])%360+360)%360,fU(parseFloat(e[2]),0,100),fU(parseFloat(e[3]),0,100),fU(isNaN(n)?1:n,0,1)]}return null},uU.get.hwb=function(t){if(!t)return null;var e=t.match(/^hwb\(\s*([+-]?\d{0,3}(?:\.\d+)?)(?:deg)?\s*,\s*([+-]?[\d\.]+)%\s*,\s*([+-]?[\d\.]+)%\s*(?:,\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/);if(e){var n=parseFloat(e[4]);return[(parseFloat(e[1])%360+360)%360,fU(parseFloat(e[2]),0,100),fU(parseFloat(e[3]),0,100),fU(isNaN(n)?1:n,0,1)]}return null},uU.to.hex=function(){var t=aU(arguments);return"#"+dU(t[0])+dU(t[1])+dU(t[2])+(t[3]<1?dU(Math.round(255*t[3])):"")},uU.to.rgb=function(){var t=aU(arguments);return t.length<4||1===t[3]?"rgb("+Math.round(t[0])+", "+Math.round(t[1])+", "+Math.round(t[2])+")":"rgba("+Math.round(t[0])+", "+Math.round(t[1])+", "+Math.round(t[2])+", "+t[3]+")"},uU.to.rgb.percent=function(){var t=aU(arguments),e=Math.round(t[0]/255*100),n=Math.round(t[1]/255*100),i=Math.round(t[2]/255*100);return t.length<4||1===t[3]?"rgb("+e+"%, "+n+"%, "+i+"%)":"rgba("+e+"%, "+n+"%, "+i+"%, "+t[3]+")"},uU.to.hsl=function(){var t=aU(arguments);return t.length<4||1===t[3]?"hsl("+t[0]+", "+t[1]+"%, "+t[2]+"%)":"hsla("+t[0]+", "+t[1]+"%, "+t[2]+"%, "+t[3]+")"},uU.to.hwb=function(){var t=aU(arguments),e="";return t.length>=4&&1!==t[3]&&(e=", "+t[3]),"hwb("+t[0]+", "+t[1]+"%, "+t[2]+"%"+e+")"},uU.to.keyword=function(t){return hU[t.slice(0,3)]};var gU=tU.exports,pU={exports:{}},AU={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},mU={};for(var yU in AU)AU.hasOwnProperty(yU)&&(mU[AU[yU]]=yU);var _U=pU.exports={rgb:{channels:3,labels:"rgb"},hsl:{channels:3,labels:"hsl"},hsv:{channels:3,labels:"hsv"},hwb:{channels:3,labels:"hwb"},cmyk:{channels:4,labels:"cmyk"},xyz:{channels:3,labels:"xyz"},lab:{channels:3,labels:"lab"},lch:{channels:3,labels:"lch"},hex:{channels:1,labels:["hex"]},keyword:{channels:1,labels:["keyword"]},ansi16:{channels:1,labels:["ansi16"]},ansi256:{channels:1,labels:["ansi256"]},hcg:{channels:3,labels:["h","c","g"]},apple:{channels:3,labels:["r16","g16","b16"]},gray:{channels:1,labels:["gray"]}};for(var vU in _U)if(_U.hasOwnProperty(vU)){if(!("channels"in _U[vU]))throw new Error("missing channels property: "+vU);if(!("labels"in _U[vU]))throw new Error("missing channel labels property: "+vU);if(_U[vU].labels.length!==_U[vU].channels)throw new Error("channel and label counts mismatch: "+vU);var xU=_U[vU].channels,bU=_U[vU].labels;delete _U[vU].channels,delete _U[vU].labels,Object.defineProperty(_U[vU],"channels",{value:xU}),Object.defineProperty(_U[vU],"labels",{value:bU})}_U.rgb.hsl=function(t){var e,n,i=t[0]/255,o=t[1]/255,s=t[2]/255,a=Math.min(i,o,s),l=Math.max(i,o,s),h=l-a;return l===a?e=0:i===l?e=(o-s)/h:o===l?e=2+(s-i)/h:s===l&&(e=4+(i-o)/h),(e=Math.min(60*e,360))<0&&(e+=360),n=(a+l)/2,[e,100*(l===a?0:n<=.5?h/(l+a):h/(2-l-a)),100*n]},_U.rgb.hsv=function(t){var e,n,i,o,s,a=t[0]/255,l=t[1]/255,h=t[2]/255,c=Math.max(a,l,h),u=c-Math.min(a,l,h),f=function(t){return(c-t)/6/u+.5};return 0===u?o=s=0:(s=u/c,e=f(a),n=f(l),i=f(h),a===c?o=i-n:l===c?o=1/3+e-i:h===c&&(o=2/3+n-e),o<0?o+=1:o>1&&(o-=1)),[360*o,100*s,100*c]},_U.rgb.hwb=function(t){var e=t[0],n=t[1],i=t[2];return[_U.rgb.hsl(t)[0],1/255*Math.min(e,Math.min(n,i))*100,100*(i=1-1/255*Math.max(e,Math.max(n,i)))]},_U.rgb.cmyk=function(t){var e,n=t[0]/255,i=t[1]/255,o=t[2]/255;return[100*((1-n-(e=Math.min(1-n,1-i,1-o)))/(1-e)||0),100*((1-i-e)/(1-e)||0),100*((1-o-e)/(1-e)||0),100*e]},_U.rgb.keyword=function(t){var e=mU[t];if(e)return e;var n,i,o,s=1/0;for(var a in AU)if(AU.hasOwnProperty(a)){var l=(i=t,o=AU[a],Math.pow(i[0]-o[0],2)+Math.pow(i[1]-o[1],2)+Math.pow(i[2]-o[2],2));l<s&&(s=l,n=a)}return n},_U.keyword.rgb=function(t){return AU[t]},_U.rgb.xyz=function(t){var e=t[0]/255,n=t[1]/255,i=t[2]/255;return[100*(.4124*(e=e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92)+.3576*(n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92)+.1805*(i=i>.04045?Math.pow((i+.055)/1.055,2.4):i/12.92)),100*(.2126*e+.7152*n+.0722*i),100*(.0193*e+.1192*n+.9505*i)]},_U.rgb.lab=function(t){var e=_U.rgb.xyz(t),n=e[0],i=e[1],o=e[2];return i/=100,o/=108.883,n=(n/=95.047)>.008856?Math.pow(n,1/3):7.787*n+16/116,[116*(i=i>.008856?Math.pow(i,1/3):7.787*i+16/116)-16,500*(n-i),200*(i-(o=o>.008856?Math.pow(o,1/3):7.787*o+16/116))]},_U.hsl.rgb=function(t){var e,n,i,o,s,a=t[0]/360,l=t[1]/100,h=t[2]/100;if(0===l)return[s=255*h,s,s];e=2*h-(n=h<.5?h*(1+l):h+l-h*l),o=[0,0,0];for(var c=0;c<3;c++)(i=a+1/3*-(c-1))<0&&i++,i>1&&i--,o[c]=255*(s=6*i<1?e+6*(n-e)*i:2*i<1?n:3*i<2?e+(n-e)*(2/3-i)*6:e);return o},_U.hsl.hsv=function(t){var e=t[0],n=t[1]/100,i=t[2]/100,o=n,s=Math.max(i,.01);return n*=(i*=2)<=1?i:2-i,o*=s<=1?s:2-s,[e,100*(0===i?2*o/(s+o):2*n/(i+n)),(i+n)/2*100]},_U.hsv.rgb=function(t){var e=t[0]/60,n=t[1]/100,i=t[2]/100,o=Math.floor(e)%6,s=e-Math.floor(e),a=255*i*(1-n),l=255*i*(1-n*s),h=255*i*(1-n*(1-s));switch(i*=255,o){case 0:return[i,h,a];case 1:return[l,i,a];case 2:return[a,i,h];case 3:return[a,l,i];case 4:return[h,a,i];case 5:return[i,a,l]}},_U.hsv.hsl=function(t){var e,n,i,o=t[0],s=t[1]/100,a=t[2]/100,l=Math.max(a,.01);return i=(2-s)*a,n=s*l,[o,100*(n=(n/=(e=(2-s)*l)<=1?e:2-e)||0),100*(i/=2)]},_U.hwb.rgb=function(t){var e,n,i,o,s,a,l,h=t[0]/360,c=t[1]/100,u=t[2]/100,f=c+u;switch(f>1&&(c/=f,u/=f),i=6*h-(e=Math.floor(6*h)),1&e&&(i=1-i),o=c+i*((n=1-u)-c),e){default:case 6:case 0:s=n,a=o,l=c;break;case 1:s=o,a=n,l=c;break;case 2:s=c,a=n,l=o;break;case 3:s=c,a=o,l=n;break;case 4:s=o,a=c,l=n;break;case 5:s=n,a=c,l=o}return[255*s,255*a,255*l]},_U.cmyk.rgb=function(t){var e=t[1]/100,n=t[2]/100,i=t[3]/100;return[255*(1-Math.min(1,t[0]/100*(1-i)+i)),255*(1-Math.min(1,e*(1-i)+i)),255*(1-Math.min(1,n*(1-i)+i))]},_U.xyz.rgb=function(t){var e,n,i,o=t[0]/100,s=t[1]/100,a=t[2]/100;return n=-.9689*o+1.8758*s+.0415*a,i=.0557*o+-.204*s+1.057*a,e=(e=3.2406*o+-1.5372*s+-.4986*a)>.0031308?1.055*Math.pow(e,1/2.4)-.055:12.92*e,n=n>.0031308?1.055*Math.pow(n,1/2.4)-.055:12.92*n,i=i>.0031308?1.055*Math.pow(i,1/2.4)-.055:12.92*i,[255*(e=Math.min(Math.max(0,e),1)),255*(n=Math.min(Math.max(0,n),1)),255*(i=Math.min(Math.max(0,i),1))]},_U.xyz.lab=function(t){var e=t[0],n=t[1],i=t[2];return n/=100,i/=108.883,e=(e/=95.047)>.008856?Math.pow(e,1/3):7.787*e+16/116,[116*(n=n>.008856?Math.pow(n,1/3):7.787*n+16/116)-16,500*(e-n),200*(n-(i=i>.008856?Math.pow(i,1/3):7.787*i+16/116))]},_U.lab.xyz=function(t){var e,n,i;e=t[1]/500+(n=(t[0]+16)/116),i=n-t[2]/200;var o=Math.pow(n,3),s=Math.pow(e,3),a=Math.pow(i,3);return n=o>.008856?o:(n-16/116)/7.787,e=s>.008856?s:(e-16/116)/7.787,i=a>.008856?a:(i-16/116)/7.787,[e*=95.047,n*=100,i*=108.883]},_U.lab.lch=function(t){var e,n=t[0],i=t[1],o=t[2];return(e=360*Math.atan2(o,i)/2/Math.PI)<0&&(e+=360),[n,Math.sqrt(i*i+o*o),e]},_U.lch.lab=function(t){var e,n=t[1];return e=t[2]/360*2*Math.PI,[t[0],n*Math.cos(e),n*Math.sin(e)]},_U.rgb.ansi16=function(t){var e=t[0],n=t[1],i=t[2],o=1 in arguments?arguments[1]:_U.rgb.hsv(t)[2];if(0===(o=Math.round(o/50)))return 30;var s=30+(Math.round(i/255)<<2|Math.round(n/255)<<1|Math.round(e/255));return 2===o&&(s+=60),s},_U.hsv.ansi16=function(t){return _U.rgb.ansi16(_U.hsv.rgb(t),t[2])},_U.rgb.ansi256=function(t){var e=t[0],n=t[1],i=t[2];return e===n&&n===i?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(n/255*5)+Math.round(i/255*5)},_U.ansi16.rgb=function(t){var e=t%10;if(0===e||7===e)return t>50&&(e+=3.5),[e=e/10.5*255,e,e];var n=.5*(1+~~(t>50));return[(1&e)*n*255,(e>>1&1)*n*255,(e>>2&1)*n*255]},_U.ansi256.rgb=function(t){if(t>=232){var e=10*(t-232)+8;return[e,e,e]}var n;return t-=16,[Math.floor(t/36)/5*255,Math.floor((n=t%36)/6)/5*255,n%6/5*255]},_U.rgb.hex=function(t){var e=(((255&Math.round(t[0]))<<16)+((255&Math.round(t[1]))<<8)+(255&Math.round(t[2]))).toString(16).toUpperCase();return"000000".substring(e.length)+e},_U.hex.rgb=function(t){var e=t.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);if(!e)return[0,0,0];var n=e[0];3===e[0].length&&(n=n.split("").map((function(t){return t+t})).join(""));var i=parseInt(n,16);return[i>>16&255,i>>8&255,255&i]},_U.rgb.hcg=function(t){var e,n=t[0]/255,i=t[1]/255,o=t[2]/255,s=Math.max(Math.max(n,i),o),a=Math.min(Math.min(n,i),o),l=s-a;return e=l<=0?0:s===n?(i-o)/l%6:s===i?2+(o-n)/l:4+(n-i)/l+4,e/=6,[360*(e%=1),100*l,100*(l<1?a/(1-l):0)]},_U.hsl.hcg=function(t){var e,n=t[1]/100,i=t[2]/100,o=0;return(e=i<.5?2*n*i:2*n*(1-i))<1&&(o=(i-.5*e)/(1-e)),[t[0],100*e,100*o]},_U.hsv.hcg=function(t){var e=t[2]/100,n=t[1]/100*e,i=0;return n<1&&(i=(e-n)/(1-n)),[t[0],100*n,100*i]},_U.hcg.rgb=function(t){var e=t[1]/100,n=t[2]/100;if(0===e)return[255*n,255*n,255*n];var i,o=[0,0,0],s=t[0]/360%1*6,a=s%1,l=1-a;switch(Math.floor(s)){case 0:o[0]=1,o[1]=a,o[2]=0;break;case 1:o[0]=l,o[1]=1,o[2]=0;break;case 2:o[0]=0,o[1]=1,o[2]=a;break;case 3:o[0]=0,o[1]=l,o[2]=1;break;case 4:o[0]=a,o[1]=0,o[2]=1;break;default:o[0]=1,o[1]=0,o[2]=l}return[255*(e*o[0]+(i=(1-e)*n)),255*(e*o[1]+i),255*(e*o[2]+i)]},_U.hcg.hsv=function(t){var e=t[1]/100,n=e+t[2]/100*(1-e),i=0;return n>0&&(i=e/n),[t[0],100*i,100*n]},_U.hcg.hsl=function(t){var e=t[1]/100,n=t[2]/100*(1-e)+.5*e,i=0;return n>0&&n<.5?i=e/(2*n):n>=.5&&n<1&&(i=e/(2*(1-n))),[t[0],100*i,100*n]},_U.hcg.hwb=function(t){var e=t[1]/100,n=e+t[2]/100*(1-e);return[t[0],100*(n-e),100*(1-n)]},_U.hwb.hcg=function(t){var e=1-t[2]/100,n=e-t[1]/100,i=0;return n<1&&(i=(e-n)/(1-n)),[t[0],100*n,100*i]},_U.apple.rgb=function(t){return[t[0]/65535*255,t[1]/65535*255,t[2]/65535*255]},_U.rgb.apple=function(t){return[t[0]/255*65535,t[1]/255*65535,t[2]/255*65535]},_U.gray.rgb=function(t){return[t[0]/100*255,t[0]/100*255,t[0]/100*255]},_U.gray.hsl=_U.gray.hsv=function(t){return[0,0,t[0]]},_U.gray.hwb=function(t){return[0,100,t[0]]},_U.gray.cmyk=function(t){return[0,0,0,t[0]]},_U.gray.lab=function(t){return[t[0],0,0]},_U.gray.hex=function(t){var e=255&Math.round(t[0]/100*255),n=((e<<16)+(e<<8)+e).toString(16).toUpperCase();return"000000".substring(n.length)+n},_U.rgb.gray=function(t){return[(t[0]+t[1]+t[2])/3/255*100]};var wU=pU.exports,TU=wU;function MU(t,e){return function(n){return e(t(n))}}function CU(t,e){for(var n=[e[t].parent,t],i=TU[e[t].parent][t],o=e[t].parent;e[o].parent;)n.unshift(e[o].parent),i=MU(TU[e[o].parent][o],i),o=e[o].parent;return i.conversion=n,i}var SU=wU,PU=function(t){for(var e=function(t){var e=function(){for(var t={},e=Object.keys(TU),n=e.length,i=0;i<n;i++)t[e[i]]={distance:-1,parent:null};return t}(),n=[t];for(e[t].distance=0;n.length;)for(var i=n.pop(),o=Object.keys(TU[i]),s=o.length,a=0;a<s;a++){var l=o[a],h=e[l];-1===h.distance&&(h.distance=e[i].distance+1,h.parent=i,n.unshift(l))}return e}(t),n={},i=Object.keys(e),o=i.length,s=0;s<o;s++){var a=i[s];null!==e[a].parent&&(n[a]=CU(a,e))}return n},IU={};Object.keys(SU).forEach((function(t){IU[t]={},Object.defineProperty(IU[t],"channels",{value:SU[t].channels}),Object.defineProperty(IU[t],"labels",{value:SU[t].labels});var e=PU(t);Object.keys(e).forEach((function(n){var i=e[n];IU[t][n]=function(t){var e=function(e){if(null==e)return e;arguments.length>1&&(e=Array.prototype.slice.call(arguments));var n=t(e);if("object"==typeof n)for(var i=n.length,o=0;o<i;o++)n[o]=Math.round(n[o]);return n};return"conversion"in t&&(e.conversion=t.conversion),e}(i),IU[t][n].raw=function(t){var e=function(e){return null==e?e:(arguments.length>1&&(e=Array.prototype.slice.call(arguments)),t(e))};return"conversion"in t&&(e.conversion=t.conversion),e}(i)}))}));var OU=gU,EU=IU,kU=[].slice,RU=["keyword","gray","hex"],LU={};Object.keys(EU).forEach((function(t){LU[kU.call(EU[t].labels).sort().join("")]=t}));var DU={};function FU(t,e){if(!(this instanceof FU))return new FU(t,e);if(e&&e in RU&&(e=null),e&&!(e in EU))throw new Error("Unknown model: "+e);var n,i;if(null==t)this.model="rgb",this.color=[0,0,0],this.valpha=1;else if(t instanceof FU)this.model=t.model,this.color=t.color.slice(),this.valpha=t.valpha;else if("string"==typeof t){var o=OU.get(t);if(null===o)throw new Error("Unable to parse color from string: "+t);this.model=o.model,this.color=o.value.slice(0,i=EU[this.model].channels),this.valpha="number"==typeof o.value[i]?o.value[i]:1}else if(t.length){this.model=e||"rgb";var s=kU.call(t,0,i=EU[this.model].channels);this.color=BU(s,i),this.valpha="number"==typeof t[i]?t[i]:1}else if("number"==typeof t)t&=16777215,this.model="rgb",this.color=[t>>16&255,t>>8&255,255&t],this.valpha=1;else{this.valpha=1;var a=Object.keys(t);"alpha"in t&&(a.splice(a.indexOf("alpha"),1),this.valpha="number"==typeof t.alpha?t.alpha:0);var l=a.sort().join("");if(!(l in LU))throw new Error("Unable to parse color from object: "+JSON.stringify(t));this.model=LU[l];var h=EU[this.model].labels,c=[];for(n=0;n<h.length;n++)c.push(t[h[n]]);this.color=BU(c)}if(DU[this.model])for(i=EU[this.model].channels,n=0;n<i;n++){var u=DU[this.model][n];u&&(this.color[n]=u(this.color[n]))}this.valpha=Math.max(0,Math.min(1,this.valpha)),Object.freeze&&Object.freeze(this)}function NU(t,e,n){return(t=Array.isArray(t)?t:[t]).forEach((function(t){(DU[t]||(DU[t]=[]))[e]=n})),t=t[0],function(i){var o;return arguments.length?(n&&(i=n(i)),(o=this[t]()).color[e]=i,o):(o=this[t]().color[e],n&&(o=n(o)),o)}}function HU(t){return function(e){return Math.max(0,Math.min(t,e))}}function BU(t,e){for(var n=0;n<e;n++)"number"!=typeof t[n]&&(t[n]=0);return t}FU.prototype={toString:function(){return this.string()},toJSON:function(){return this[this.model]()},string:function(t){var e=this.model in OU.to?this:this.rgb(),n=1===(e=e.round("number"==typeof t?t:1)).valpha?e.color:e.color.concat(this.valpha);return OU.to[e.model](n)},percentString:function(t){var e=this.rgb().round("number"==typeof t?t:1),n=1===e.valpha?e.color:e.color.concat(this.valpha);return OU.to.rgb.percent(n)},array:function(){return 1===this.valpha?this.color.slice():this.color.concat(this.valpha)},object:function(){for(var t={},e=EU[this.model].channels,n=EU[this.model].labels,i=0;i<e;i++)t[n[i]]=this.color[i];return 1!==this.valpha&&(t.alpha=this.valpha),t},unitArray:function(){var t=this.rgb().color;return t[0]/=255,t[1]/=255,t[2]/=255,1!==this.valpha&&t.push(this.valpha),t},unitObject:function(){var t=this.rgb().object();return t.r/=255,t.g/=255,t.b/=255,1!==this.valpha&&(t.alpha=this.valpha),t},round:function(t){return t=Math.max(t||0,0),new FU(this.color.map(function(t){return function(e){return function(t,e){return Number(t.toFixed(e))}(e,t)}}(t)).concat(this.valpha),this.model)},alpha:function(t){return arguments.length?new FU(this.color.concat(Math.max(0,Math.min(1,t))),this.model):this.valpha},red:NU("rgb",0,HU(255)),green:NU("rgb",1,HU(255)),blue:NU("rgb",2,HU(255)),hue:NU(["hsl","hsv","hsl","hwb","hcg"],0,(function(t){return(t%360+360)%360})),saturationl:NU("hsl",1,HU(100)),lightness:NU("hsl",2,HU(100)),saturationv:NU("hsv",1,HU(100)),value:NU("hsv",2,HU(100)),chroma:NU("hcg",1,HU(100)),gray:NU("hcg",2,HU(100)),white:NU("hwb",1,HU(100)),wblack:NU("hwb",2,HU(100)),cyan:NU("cmyk",0,HU(100)),magenta:NU("cmyk",1,HU(100)),yellow:NU("cmyk",2,HU(100)),black:NU("cmyk",3,HU(100)),x:NU("xyz",0,HU(100)),y:NU("xyz",1,HU(100)),z:NU("xyz",2,HU(100)),l:NU("lab",0,HU(100)),a:NU("lab",1),b:NU("lab",2),keyword:function(t){return arguments.length?new FU(t):EU[this.model].keyword(this.color)},hex:function(t){return arguments.length?new FU(t):OU.to.hex(this.rgb().round().color)},rgbNumber:function(){var t=this.rgb().color;return(255&t[0])<<16|(255&t[1])<<8|255&t[2]},luminosity:function(){for(var t=this.rgb().color,e=[],n=0;n<t.length;n++){var i=t[n]/255;e[n]=i<=.03928?i/12.92:Math.pow((i+.055)/1.055,2.4)}return.2126*e[0]+.7152*e[1]+.0722*e[2]},contrast:function(t){var e=this.luminosity(),n=t.luminosity();return e>n?(e+.05)/(n+.05):(n+.05)/(e+.05)},level:function(t){var e=this.contrast(t);return e>=7.1?"AAA":e>=4.5?"AA":""},isDark:function(){var t=this.rgb().color;return(299*t[0]+587*t[1]+114*t[2])/1e3<128},isLight:function(){return!this.isDark()},negate:function(){for(var t=this.rgb(),e=0;e<3;e++)t.color[e]=255-t.color[e];return t},lighten:function(t){var e=this.hsl();return e.color[2]+=e.color[2]*t,e},darken:function(t){var e=this.hsl();return e.color[2]-=e.color[2]*t,e},saturate:function(t){var e=this.hsl();return e.color[1]+=e.color[1]*t,e},desaturate:function(t){var e=this.hsl();return e.color[1]-=e.color[1]*t,e},whiten:function(t){var e=this.hwb();return e.color[1]+=e.color[1]*t,e},blacken:function(t){var e=this.hwb();return e.color[2]+=e.color[2]*t,e},grayscale:function(){var t=this.rgb().color,e=.3*t[0]+.59*t[1]+.11*t[2];return FU.rgb(e,e,e)},fade:function(t){return this.alpha(this.valpha-this.valpha*t)},opaquer:function(t){return this.alpha(this.valpha+this.valpha*t)},rotate:function(t){var e=this.hsl(),n=e.color[0];return n=(n=(n+t)%360)<0?360+n:n,e.color[0]=n,e},mix:function(t,e){if(!t||!t.rgb)throw new Error('Argument to "mix" was not a Color instance, but rather an instance of '+typeof t);var n=t.rgb(),i=this.rgb(),o=void 0===e?.5:e,s=2*o-1,a=n.alpha()-i.alpha(),l=((s*a==-1?s:(s+a)/(1+s*a))+1)/2,h=1-l;return FU.rgb(l*n.red()+h*i.red(),l*n.green()+h*i.green(),l*n.blue()+h*i.blue(),n.alpha()*o+i.alpha()*(1-o))}},Object.keys(EU).forEach((function(t){if(-1===RU.indexOf(t)){var e=EU[t].channels;FU.prototype[t]=function(){if(this.model===t)return new FU(this);if(arguments.length)return new FU(arguments,t);var n,i="number"==typeof arguments[e]?e:this.valpha;return new FU((n=EU[this.model][t].raw(this.color),Array.isArray(n)?n:[n]).concat(i),t)},FU[t]=function(n){return"number"==typeof n&&(n=BU(kU.call(arguments),e)),new FU(n,t)}}}));var zU,GU=(zU=FU)&&zU.t&&Object.prototype.hasOwnProperty.call(zU,"default")?zU.default:zU;function jU(t){return null==t}function UU(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)t[e]=n[e]}return t}function VU(t){return null!=t&&("function"==typeof t||null!==t.constructor&&t.constructor===Function)}function WU(t){return"object"==typeof t&&!!t}function ZU(t){return"number"==typeof t&&!isNaN(t)}function qU(t){return t*Math.PI/180}function XU(t){return t/Math.PI*180}function JU(t){let e=document.createElement("a");return e.href=t,t=e.href,e=null,t}function QU(t){return Math.sign?Math.sign(t):0==(t=+t)||isNaN(t)?Number(t):t>0?1:-1}const YU=[1,1,1,1,2,2,3,0];function KU(t){const e=t.length;let n="";for(let i=0;i<e;){let o=t[i++];if(128&o){let n=YU[o>>3&7];if(!(64&o)||!n||i+n>e)return null;for(o&=63>>n;n>0;n-=1){const e=t[i++];if(128!=(192&e))return null;o=o<<6|63&e}}n+=String.fromCharCode(o)}return n}function $U(t,e,n){return t[3*n]=e[0],t[3*n+1]=e[1],t[3*n+2]=e[2],t}function tV(t){return t.flat?t.flat(1/0):t.reduce(((t,e)=>t.concat(e)),[])}function eV(t){return t<256?Uint8Array:t<65536?Uint16Array:Uint32Array}function nV(t){return 0===t.indexOf("data:")}function iV(t){const e=t.indexOf("base64,"),n=t.substring(e+7),i=window.atob(n),o=i.length,s=new Uint8Array(o);for(let t=0;t<o;t++)s[t]=i.charCodeAt(t);return s.buffer}function rV(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];if(n)for(let e=0,i=n.length;e<i;e++)t.push(n[e])}return t.length}const oV={};function sV(t,e){if(!Array.isArray(e)){e=oV[e]=oV[e]||GU(e).array().map((t=>t/255))}for(let n=0;n<e.length;n++)t[n]=e[n];return 3===e.length&&(t[3]=1),t}var aV=Object.freeze({__proto__:null,base64URLToArrayBuffer:iV,extend:UU,flatArr:tV,getAbsoluteURL:JU,getBatchIdArrayType:eV,isBase64:nV,isFunction:VU,isNil:jU,isNumber:ZU,isObject:WU,normalizeColor:sV,pushIn:rV,setColumn3:$U,sign:QU,stringFromUTF8Array:KU,toDegree:XU,toRadian:qU});function lV(t){return-1===t.indexOf("http://")&&-1===t.indexOf("https://")&&-1===t.indexOf("file://")}function hV(t){return(t=t||{}).referrerPolicy=t.referrerPolicy||"origin",t.referrer=window&&window.location.href,t}const cV=function(){if("undefined"!=typeof globalThis)return globalThis;if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("unable to locate global object")},uV=cV(),fV=uV.gl_trans__coders=uV.gl_trans__coders||{};
/*!
   * @ispace/gl v0.108.4
   * LICENSE : UNLICENSED
   * (c) 2016-2026 ispace.com
   */function dV(){return cV().ispace_gltf_loader}fV.inject=function(t){const e=t.toString(),n=e.indexOf("{")+1,i=e.substring(0,n),o=uV.gl_trans__coders=uV.gl_trans__coders||{};let s=`${i}\n    const _____getGlobal = ${cV.toString()};\n    const g___lobals = _____getGlobal()\n    const tran_____scoders = g___lobals['gl_trans__coders'] = g___lobals['gl_trans__coders'] || {};`;for(const t in o)"inject"!==t&&"getTranscoder"!==t&&"registerTranscoder"!==t&&(s+='tran_____scoders["'+t+'"] ='+o[t].toString()+"\n;");return s+="\n("+cV().ispace_gltf_loader_bundle.toString()+")({});\n",s+="\n"+e.substring(i.length),s},fV.registerTranscoder=function(t,e){fV[t]=e},fV.getTranscoder=function(t){return fV[t]};const gV="undefined"==typeof document?null:document.createElement("canvas");let pV=class jt extends Em.Actor{constructor(t,e,n){super(t),this.mapId=e,this.i=n}initialize(t){t(null)}loadTile(t,e,n){let i=null;e&&e.arraybuffer&&(i=[e.arraybuffer]);this.send({mapId:this.mapId,layerId:t,command:"loadTile",params:e},i,n)}abortTileLoading(t,e,n){this.broadcast({mapId:this.mapId,layerId:t,command:"abortTileLoading",params:{url:e}},null,n)}addLayer(t,e,n){this.broadcast({actorId:this.actorId,mapId:this.mapId,layerId:t,command:"addLayer",params:{options:e}},null,n)}removeLayer(t,e){this.broadcast({mapId:this.mapId,layerId:t,command:"removeLayer"},null,e)}requestImage({url:t},e){const n=new Image;n.onload=()=>{if(!this.isActive())return;if(!gV)return void e(new Error("There is no canvas to draw image!"));const t=this.i?n:function(t){if(AV(t.width)&&AV(t.height))return t;let e=t.width,n=t.height;AV(e)||(e=mV(e)),AV(n)||(n=mV(n));const i=document.createElement("canvas");i.width=e,i.height=n,i.getContext("2d").drawImage(t,0,0,e,n);const o=t.src,s=o.lastIndexOf("/")+1,a=o.substring(s);return console.warn(`Texture(${a})'s size is not power of two, resize from (${t.width}, ${t.height}) to (${e}, ${n})`),i}(n);gV.width=t.width,gV.height=t.height;const i=gV.getContext("2d",{willReadFrequently:!0});i.drawImage(t,0,0,t.width,t.height);const o=i.getImageData(0,0,t.width,t.height),s={width:t.width,height:t.height,data:new Uint8Array(o.data)};e(null,s,[s.data.buffer])},n.onerror=function(t){e(t)},n.src=t}};function AV(t){return!(t&t-1)&&0!==t}function mV(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))}const{GLTFLoader:yV}=dV();function _V(t,e){if(t.scenes&&t.scenes.length)for(let n=0,i=t.scenes.length;n<i;n++){const i=t.scenes[n].nodes;for(let n=0,o=i.length;n<o;n++){CV(i[n],[],t,e)}}}const vV=[],xV=[],bV=[],wV=[0,0,0],TV=z_([]),MV=[1,1,1];function CV(t,e,n,i){const o=e.slice(0);if(t.matrix)o.push(t.matrix);else if(t.rotation||t.translation||t.scale){const e=gy(vV,t.translation||wV),n=by(xV,t.rotation||TV),i=py(bV,t.scale||MV);cy(i,n,i);const s=cy([],e,i);o.push(s)}if(t.children&&t.children.length)for(let e=0,s=t.children.length;e<s;e++)CV(t.children[e],o,n,i);if(void 0!==t.mesh){const e=t.mesh,s=n.meshes[e];if(s){const t=o.slice(0),a=s.primitives;for(let o=0,s=a.length;o<s;o++){const s=a[o];s&&(s.matrices=t,i(s,e,o,n))}}}}function SV(t,e,n){let{byteOffset:i,byteStride:o}=e;const{componentType:s,itemSize:a}=e,l=e.array.buffer,h=s?yV.getTypedArrayCtor(s):e.array.constructor;if(i=void 0===i?e.array.byteOffset:i,o=o||0,!o||o===a*h.BYTES_PER_ELEMENT&&i%h.BYTES_PER_ELEMENT==0){const e=new h(l,i+n*a*h.BYTES_PER_ELEMENT,a);return t.set(e),t}o||(o=a*h.BYTES_PER_ELEMENT);const c=new Uint8Array(l,o*n+i,a*h.BYTES_PER_ELEMENT);return new Uint8Array(t.buffer).set(c),t}function PV(t,e,n,i){t[4*e]=n[i],t[4*e+1]=n[i+4],t[4*e+2]=n[i+8],t[4*e+3]=n[i+12]}var IV="#include <gl2_vert>\nconst float SHIFT_RIGHT_11 = 1.0 / 2048.0;\nconst float SHIFT_RIGHT_5 = 1.0 / 32.0;\nconst float SHIFT_LEFT_11 = 2048.0;\nconst float SHIFT_LEFT_5 = 32.0;\nconst float NORMALIZE_6 = 1.0 / 64.0;\nconst float NORMALIZE_5 = 1.0 / 32.0;\n#ifdef HAS_POSITION\n    attribute vec3 POSITION;\n#endif\n#if defined(HAS_RGB)\n    attribute vec3 RGB;\n#elif defined(HAS_RGBA)\n    attribute vec4 RGBA;\n#elif defined(HAS_RGB565)\n    attribute float RGB565;\n#endif\nuniform vec4 pointColor;\nuniform float pointSize;\nuniform mat4 projViewModelMatrix;\nuniform float pointOpacity;\nvarying vec4 vColor;\n#ifdef HAS_NORMAL\n    #ifdef HAS_NORMAL_OCT16P\n        attribute vec2 NORMAL_OCT16P;\n        float signNotZero(float value) {\n            return value >= 0.0 ? 1.0 : -1.0;\n        }\n        vec2 signNotZero(vec2 value) {\n            return vec2(signNotZero(value.x), signNotZero(value.y));\n        }\n        vec3 octDecode(vec2 encoded, float range) {\n            if (encoded.x == 0.0 && encoded.y == 0.0) {\n                return vec3(0.0, 0.0, 0.0);\n            }\n            encoded = encoded / range * 2.0 - 1.0;\n            vec3 v = vec3(encoded.x, encoded.y, 1.0 - abs(encoded.x) - abs(encoded.y));\n            if (v.z < 0.0) {\n                v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\n            }\n            return normalize(v);\n        }\n        vec3 octDecode(vec2 encoded) {\n            return octDecode(encoded, 255.0);\n        }\n    #else\n        attribute vec3 NORMAL;\n    #endif\n    uniform vec3 lightDir;\n    uniform mat3 modelNormalMatrix;\n    uniform mat4 positionMatrix;\n    float getLambertDiffuse(vec3 lightDir, vec3 normal) {\n        return max(dot(-lightDir, normal), 0.0);\n    }\n#endif\n#ifdef PICKING_MODE\n    #include <fbo_picking_vert>\n#endif\n#include <draco_decode_vert>\nvoid main() {\n    #ifdef HAS_POSITION\n        vec3 localPos = decode_getPosition(POSITION);\n    #endif\n    gl_Position = projViewModelMatrix * vec4(localPos, 1.0);\n    gl_PointSize = pointSize;\n    #ifdef PICKING_MODE\n        fbo_picking_setData(gl_Position.w, true);\n    #else\n        #if defined(HAS_RGB)\n            vColor = vec4(RGB / 255.0, 1.0) * pointOpacity;\n        #elif defined(HAS_RGBA)\n            vColor = RGBA / 255.0 * pointOpacity;\n        #elif defined(HAS_RGB565)\n            float compressed = RGB565;\n            float r = floor(compressed * SHIFT_RIGHT_11);\n            compressed -= r * SHIFT_LEFT_11;\n            float g = floor(compressed * SHIFT_RIGHT_5);\n            compressed -= g * SHIFT_LEFT_5;\n            float b = compressed;\n            vec3 rgb = vec3(r * NORMALIZE_5, g * NORMALIZE_6, b * NORMALIZE_5);\n            vColor = vec4(rgb, 1.0);\n        #else\n            vColor = pointColor;\n        #endif\n        #ifdef HAS_NORMAL\n            mat3 positionNormalMatrix = mat3(positionMatrix);\n            mat3 normalMatrix = modelNormalMatrix * positionNormalMatrix;\n            #ifdef HAS_NORMAL_OCT16P\n                vec3 localNormal = octDecode(NORMAL_OCT16P);\n            #else\n                vec3 localNormal = NORMAL;\n            #endif\n            vec3 normal = normalize(normalMatrix * localNormal);\n            float colorStrength = getLambertDiffuse(lightDir, normal);\n            colorStrength = max(colorStrength, 0.5);\n            vColor *= colorStrength;\n        #endif\n    #endif\n}\n";const OV=new Array(3),EV=new Array(3),kV=[40680631590769,40680631590769,40408299984661.445];function RV(t,e,n,i){const o=kV,s=Math.cos(n);OV[0]=s*Math.cos(e),OV[1]=s*Math.sin(e),OV[2]=Math.sin(n),VV(OV,OV),By(EV,o,OV);const a=Math.sqrt(qy(OV,EV));var l,h,c;return(l=EV)[0]=(h=EV)[0]/(c=a),l[1]=h[1]/c,l[2]=h[2]/c,Gy(OV,OV,i),Ny(t,EV,OV)}const LV=[1/6378137,1/6378137,1/6356752.314245179],DV=[1/40680631590769,1/40680631590769,1/40408299984661.445],FV=new Array(3),NV=new Array(3),HV=new Array(3);function BV(t,e){const n=DV,i=function(t,e,n,i,o){const s=e[0],a=e[1],l=e[2],h=n[0],c=n[1],u=n[2],f=s*s*h*h,g=a*a*c*c,A=l*l*u*u,m=f+g+A,w=Math.sqrt(1/m),T=Gy(zV,e,w);if(m<.1)return isFinite(w)?T:void 0;const M=i[0],C=i[1],P=i[2],I=GV;I[0]=T[0]*M*2,I[1]=T[1]*C*2,I[2]=T[2]*P*2;let O,E,D,N,H,U,W,q,X,J,Q,Y=(1-w)*UV(e)/(.5*UV(I)),K=0;do{Y-=K,D=1/(1+Y*M),N=1/(1+Y*C),H=1/(1+Y*P),U=D*D,W=N*N,q=H*H,X=U*D,J=W*N,Q=q*H,O=f*U+g*W+A*q-1,E=f*X*M+g*J*C+A*Q*P,K=O/(-2*E)}while(Math.abs(O)>jV);return t[0]=s*D,t[1]=a*N,t[2]=l*H,t}(FV,e,LV,n);let o=n_(NV,i,n);o=VV(o,o);const s=e_(HV,e,i),a=Math.atan2(o[1],o[0]),l=Math.asin(o[2]),h=QU(qy(s,e))*UV(s);return t[0]=XU(a),t[1]=XU(l),t[2]=h,t}const zV=new Array(3),GV=new Array(3),jV=1e-12;function UV(t){return Ry(t)}function VV(t,e){const n=e[0],i=e[1],o=e[2];let s=n*n+i*i+o*o;return s>0&&(s=Math.sqrt(s),t[0]=e[0]/s,t[1]=e[1]/s,t[2]=e[2]/s),t}function WV(t,e){return By(e,t,DV),Zy(e,e)}function ZV(t,e){const n=t[0],i=t[1],o=Math.cos(i),s=o*Math.cos(n),a=o*Math.sin(n),l=Math.sin(i);return e.x=s,e.y=a,e.z=l,Zy(e,e)}var qV=Object.freeze({__proto__:null,cartesian3ToDegree:BV,geodeticSurfaceNormal:WV,geodeticSurfaceNormalCartographic:ZV,normalizeCartesian:VV,radianToCartesian3:RV});function XV(t,e,n,i){n=n||0,i=i||n;const o=Math.abs(t-e);return o<=i||o<=n*Math.max(Math.abs(t),Math.abs(e))}function JV(t,e){let n="";for(let i=0;i<4;i++){const o=t.getUint8(e+i);n+=String.fromCharCode(o)}return n}const QV="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;function YV(t,e,n){const i=new Uint8Array(t,e,n);return QV?JSON.parse(QV.decode(i)):JSON.parse(KU(i))}function KV(t,e,n){const i=new Uint8Array(t,e,n);return QV?JSON.parse(QV.decode(i)):JSON.parse(KU(i))}function $V(t,e,n){return{offset:e,byteLength:n}}function tW(t,e,n,i){const{byteOffset:o,componentType:s,type:a}=t,{ctor:l,type:h}=sW(s||"UNSIGNED_SHORT"),c=rW(a);return{byteStride:0,byteOffset:o+n,itemSize:c,count:i*c,componentType:h,array:new l(e,n+o,i*c)}}function eW(t,e,n,i){const o=tW(t,e,n,i);return o.array.buffer.byteLength!==e.byteLength&&(o.array=o.array.slice()),o}function nW(t,e,n,i){const{byteOffset:o,componentType:s,type:a}=t,{ctor:l}=sW(s||"UNSIGNED_SHORT"),h=rW(a),c=new l(e,o,n*h);return 1===h?c[i]:c.subarray(i*h,i*h+h)}const iW={SCALAR:1,VEC2:2,VEC3:3,VEC4:4};function rW(t){return t?iW[t]:1}const oW={BYTE:{ctor:Int8Array,type:5120,name:"Int8Array"},UNSIGNED_BYTE:{ctor:Uint8Array,type:5121,name:"Uint8Array"},SHORT:{ctor:Int16Array,type:5122,name:"Int16Array"},UNSIGNED_SHORT:{ctor:Uint16Array,type:5123,name:"Uint16Array"},INT:{ctor:Int32Array,type:5124,name:"Int32Array"},UNSIGNED_INT:{ctor:Uint32Array,type:5125,name:"Uint32Array"},FLOAT:{ctor:Float32Array,type:5126,name:"Float32Array"},DOUBLE:{ctor:Float64Array,type:5126,name:"Float64Array"}};function sW(t){return oW[t]}function aW(t){for(const e in oW)if(t===oW[e].ctor)return oW[e].type;throw new Error("unrecognized ctor:"+t)}function lW(t,e,n,i){const o=t,s=e.length/3;for(let t=0;t<s;t++)o[3*t]=e[3*t]/65535*i[0]+n[0],o[3*t+1]=e[3*t+1]/65535*i[1]+n[1],o[3*t+2]=e[3*t+2]/65535*i[2]+n[2];return o}function hW(t,e,n){const i=t.getUint32(12,!0),o=t.getUint32(16,!0),s=t.getUint32(20,!0),a=t.getUint32(24,!0),l=t.buffer;let h,c={},u={},f=null;i>0&&(c=YV(l,e,i),e+=i),o>0&&(h=function(t,e,n){return{offset:e,byteLength:n}}(0,e,o),e+=o),s>0&&(u=KV(l,e,s),e+=s);const g=$V(0,e,a);return f=l.slice(g.offset,g.offset+g.byteLength),n.push(f),{featureTable:c,featureTableBin:h,batchTable:u,batchTableBin:f}}const cW={up:{south:"east",north:"west",west:"south",east:"north"},down:{south:"west",north:"east",west:"north",east:"south"},south:{up:"west",down:"east",west:"down",east:"up"},north:{up:"east",down:"west",west:"up",east:"down"},west:{up:"north",down:"south",north:"down",south:"up"},east:{up:"south",down:"north",north:"up",south:"down"}},uW={north:[-1,0,0],east:[0,1,0],up:[0,0,1],south:[1,0,0],west:[0,-1,0],down:[0,0,-1]},fW={},dW={east:[],north:[],up:[],west:[],south:[],down:[]};let gW=[],pW=[],AW=[];const mW=[0,0,0];function yW(t,e,n){return n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[4]=t[4],n[5]=t[5],n[6]=t[6],n[7]=t[7],n[8]=t[8],n[9]=t[9],n[10]=t[10],n[11]=t[11],n[12]=e[0],n[13]=e[1],n[14]=e[2],n[15]=t[15],n}const _W=function(t,e){const n=cW[t][e];let i;const o=t+e;return fW[o]?i=fW[o]:(i=function(i,o,s){if($y(i,mW))Dy(gW,uW[t]),Dy(pW,uW[e]),Dy(AW,uW[n]);else if(XV(i[0],0,1e-14)&&XV(i[1],0,1e-14)){const o=QU(i[2]);Dy(gW,uW[t]),Dy(pW,uW[e]),Gy(pW,pW,o),Dy(AW,uW[n]),Gy(AW,AW,o)}else{WV(i,dW.up);const o=dW.up,s=dW.east;s[0]=-i[1],s[1]=i[0],s[2]=0,Zy(dW.east,s),Xy(dW.north,o,s),Gy(dW.down,dW.up,-1),Gy(dW.west,dW.east,-1),Gy(dW.south,dW.north,-1),gW=dW[t],pW=dW[e],AW=dW[n]}return s[0]=gW[0],s[1]=gW[1],s[2]=gW[2],s[3]=0,s[4]=pW[0],s[5]=pW[1],s[6]=pW[2],s[7]=0,s[8]=AW[0],s[9]=AW[1],s[10]=AW[2],s[11]=0,s[12]=i[0],s[13]=i[1],s[14]=i[2],s[15]=1,s},fW[o]=i),i}("east","north"),vW=[],xW=[],bW=[],wW=[],TW=[],MW=[],CW=[],SW={x:0,y:0},PW={x:0,y:0},IW=Math.PI/180;let OW;const EW={width:100,height:10};let kW=!1;try{new OffscreenCanvas(1,1).getContext("2d").fillText("hello",0,0),kW=!0}catch(zU){kW=!1}class an{constructor(t,e={}){if(!Array.isArray(t))return void console.error("colors is not array");if(t.length<2)return void console.error("colors.length should >1");this.colors=t;let n=1/0,i=-1/0;for(let e=0,o=t.length;e<o;e++){const o=t[e][0];n=Math.min(o,n),i=Math.max(o,i)}this.min=n,this.max=i,this.valueOffset=this.max-this.min,this.options=Object.assign({},EW,e),this.o()}getImageData(){return this.imgData}o(){const t=function(){if(!OW){const{width:t,height:e}=EW;kW?OW=new OffscreenCanvas(t,e):(OW=document.createElement("canvas"),OW.width=t,OW.height=e)}return OW}(),{width:e,height:n}=this.options;t.width=e,t.height=n;const i=t.getContext("2d");i.clearRect(0,0,t.width,t.height);const o=i.createLinearGradient(0,0,t.width,0),{colors:s,valueOffset:a}=this;for(let t=0,e=s.length;t<e;t++){const[e,n]=s[t];o.addColorStop((e-this.min)/a,n)}i.fillStyle=o,i.fillRect(0,0,t.width,t.height),this.imgData=i.getImageData(0,0,t.width,t.height)}getColor(t){t=Math.max(this.min,t);const e=((t=Math.min(t,this.max))-this.min)/this.valueOffset;let n=Math.round(e*this.imgData.width);n=Math.min(n,this.imgData.width-1);const i=4*n;return[this.imgData.data[i],this.imgData.data[i+1],this.imgData.data[i+2],this.imgData.data[i+3]]}}var RW;function LW(t){return null==t}function DW(t){return!LW(t)}function FW(t){return""===t}function NW(t,e){var n,i,o;if(qW(t)){var s,a=t.stops&&"object"==typeof t.stops[0][0],l=a||DW(t.property),h=a||!l,c=t.type||e||"exponential";if("exponential"===c)s=zW;else if("interval"===c)s=BW;else if("categorical"===c)s=HW;else if("identity"===c)s=UW;else if("color-interpolate"===c)s=jW;else{if("calculate-expression"!==c)throw new Error('Unknown function type "'+c+'"');s=VW}if(a){var u={},f=[];for(let e=0;e<t.stops.length;e++){var g=t.stops[e];void 0===u[g[0].zoom]&&(u[g[0].zoom]={zoom:g[0].zoom,type:t.type,property:t.property,default:t.default,stops:[]}),u[g[0].zoom].stops.push([g[0].value,g[1]])}for(let t in u)f.push([u[t].zoom,NW(u[t])]);n=function(e,n){const i=zW({stops:f,base:t.base},e)(e,n);return"function"==typeof i?i(e,n):i},i=!1,o=!1}else h?(n=function(e){const n=s(t,e);return"function"==typeof n?n(e):n},i=!0,o=!1):(n=function(e,n){const i=s(t,n?n[t.property]:null);return"function"==typeof i?i(e,n):i},i=!1,o=!0)}else n=function(){return t},i=!0,o=!0;return n.isZoomConstant=o,n.isFeatureConstant=i,n}function HW(t,e){for(let n=0;n<t.stops.length;n++)if(e===t.stops[n][0])return t.stops[n][1];return t.default}function BW(t,e){for(var n=0;n<t.stops.length&&!(e<t.stops[n][0]);n++);return t.stops[Math.max(n-1,0)][1]}function zW(t,e){for(var n=DW(t.base)&&!FW(t.base)?t.base:1,i=0;!(i>=t.stops.length||e<=t.stops[i][0]);)i++;return 0===i?t.stops[i][1]:i===t.stops.length?t.stops[i-1][1]:WW(e,n,t.stops[i-1][0],t.stops[i][0],t.stops[i-1][1],t.stops[i][1])}"function"==typeof Map&&(RW=new Map);const GW={width:100,height:1};function jW(t,e){const n=t.stops;if(n&&n.length>1){let t;if(RW){const e=JSON.stringify(n);if(!RW.has(e)){const t=new an(n,GW);RW.set(e,t)}t=RW.get(e)}else t=new an(n,GW);const[i,o,s,a]=t.getColor(e);return[i/255,o/255,s/255,a/255]}return n&&1===n.length?n[0][1]:null}function UW(t,e){return i=t.default,DW(n=e)?n:DW(i)?i:DW(o)?o:null;var n,i,o}function VW(t,e){const n=String(t.property),i=t.expression,o=e;function s(e){return LW(e)||FW(e)||isNaN(e)?t.default:e}if(!DW(e)||FW(e)||isNaN(e)||e<0)return s(t.default);{const e=function t(e,n,i){const o=Number(i),s=String(n);return Array.isArray(e)?e.map((e=>t(e,s,o))):e===s?o:e}(i,n,o);return s(function e(n){if(!Array.isArray(n)){if("number"==typeof n)return n;throw new Error("Invalid expression format")}{const i=n[0];if(!["+","-","*","/"].includes(i))throw new Error(`Unknown operator: ${i}`);const o=n.slice(1).map((t=>e(t)));switch(i){case"+":return o.reduce(((t,e)=>t+e),0);case"-":return o.reduce(((t,e)=>t-e));case"*":return o.reduce(((t,e)=>t*e),1);case"/":return o.some((t=>0===t))?t.default:o.reduce(((t,e)=>t/e));default:throw new Error(`Unsupported operator: ${i}`)}}}(e))}}function WW(t,e,n,i,o,s){return"function"==typeof o?function(){var a=o.apply(void 0,arguments),l=s.apply(void 0,arguments);return WW(t,e,n,i,a,l)}:o.length?function(t,e,n,i,o,s){var a=[];for(let l=0;l<o.length;l++)a[l]=ZW(t,e,n,i,o[l],s[l]);return a}(t,e,n,i,o,s):ZW(t,e,n,i,o,s)}function ZW(t,e,n,i,o,s){var a,l=i-n,h=t-n;return o*(1-(a=1===e?h/l:(Math.pow(e,h)-1)/(Math.pow(e,l)-1)))+s*a}function qW(t){return t&&"object"==typeof t&&(t.stops||t.property&&"identity"===t.type||t.expression&&"calculate-expression"===t.type)}function XW(t){return JW(t,"exponential")}function JW(t,e){if(!qW(t))return function(){return t};let n=!0,i=!0;const o=(t=JSON.parse(JSON.stringify(t))).stops;if(o)for(let t=0;t<o.length;t++)if(qW(o[t][1])){const s=JW(o[t][1],e);n=n&&s.isZoomConstant,i=i&&s.isFeatureConstant,o[t]=[o[t][0],s]}const s=NW(t,e);return s.isZoomConstant=n&&s.isZoomConstant,s.isFeatureConstant=i&&s.isFeatureConstant,s}const{getTextureMagFilter:QW,getTextureMinFilter:YW,getTextureWrap:KW,getMaterialType:$W,getMaterialFormat:tZ,getPrimitive:eZ,getUniqueREGLBuffer:nZ}=Hb,iZ=[1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1],rZ=[0,0,1,0,0,1,0,0,-1,0,0,0,0,0,0,1],{loginIBLResOnCanvas:oZ,logoutIBLResOnCanvas:sZ,getIBLResOnCanvas:aZ,getPBRUniforms:lZ}=xC.PBRUtils,hZ={factor:0,units:0},cZ=[1,1,1,1],uZ=[0,0,0],fZ={specularStrength:0,materialShininess:1},dZ=[1,1,1],gZ=ay([]),pZ=[0,0,0],AZ=[0,0],mZ=[],yZ=t=>t.material instanceof $b,_Z=t=>t.material instanceof xC.StandardMaterial,vZ=[],xZ=new gh(0,0),bZ=new _e(0,0),wZ=new _e(0,0),TZ=new _e(0,0),MZ=[],CZ=[],SZ=[],PZ=[],IZ=[],OZ=[],EZ=[],kZ=[],RZ=[],LZ=[],DZ=[],FZ=[],NZ=[],HZ=[],BZ={POSITION:"POSITION",NORMAL:"NORMAL",TEXCOORD_0:"TEXCOORD_0",TEXCOORD_1:"TEXCOORD_1",COLOR_0:"COLOR_0",TANGENT:"TANGENT",_BATCHID:"_BATCHID"},zZ=[0,1,1,2,2,3,3,0,0,4,1,5,2,6,3,7,4,5,5,6,6,7,7,4],GZ=function(t,e){const n=2*Math.PI/t,i=[],o=[];for(let e=0;e<=t;e++){const t=1*Math.cos(n*e),o=1*Math.sin(n*e),s=0;i[3*e]=t,i[3*e+1]=o,i[3*e+2]=s}for(let e=t;e<=200;e++){const t=1*Math.cos(n*e),o=1*Math.sin(n*e);i[3*e]=0,i[3*e+1]=t,i[3*e+2]=o}for(let t=200;t<=300;t++){const e=1*Math.cos(n*t),o=1*Math.sin(n*t),s=0;i[3*t]=e,i[3*t+1]=s,i[3*t+2]=o}const s=i.length/3-1;for(let t=0;t<s;t++)99!==t&&199!==t&&(o[2*t]=t,o[2*t+1]=t+1);return i.push(0,0,0),i.push(1,0,0),i.push(0,1,0),i.push(0,0,1),o.push(s+1,s+2),o.push(s+1,s+3),o.push(s+1,s+4),{vertices:i,indices:o}}(100),jZ=[0,0,0,1],UZ=[1,1,1];class wr{constructor(t,e){this.h=e,this.u=e.getRenderer().canvas,this.pickingFBO=e.getRenderer().pickingFBO,this.m=t,this.p=new cw(t),this.v={},this.T={},this._={},this.M={},this.O={},this.A={},this.I=new _w,this.S=new _w,this.C=new _w,this.k=new _w,this.N=new dw(t.texture(2)),this.L=(...t)=>this.R.call(this,...t),this.P=new XM(this.m,this.U(),this.N);const n=this.getMap();this.B=n.altitudeToPoint(100,n.getGLRes())/100}getI3DMMeshes(){return this.M}getPNTSMeshes(){return this._}getB3DMMeshes(){return this.T}getPaintedMeshes(){return this.G}getMap(){return this.h.getMap()}paint(t,e,n){const i=n&&n.renderTarget,o=n&&n.sceneFilter,s=this.getMap();if(!t.length||!s)return null;const a=this.D(),l=s.projViewMatrix,h=[],c=[],u=[],f=[],g=[];for(let e=0,i=t.length;e<i;e++){const i=t[e].data.node;let o=this.F(i);if(!o)continue;const s=this.h.j(i.H),a=s.debugNodes,A=s.heightOffset||0,m=s.coordOffset||AZ;this.O[i.id]&&(o=this.O[i.id],o=tV(o));let w=s.polygonOffset||hZ;VU(w)&&(w=w()),Array.isArray(o)||(h[0]=o,o=h);for(let h=0,T=o.length;h<T;h++){if(!o[h]||!o[h].isValid||!o[h].isValid())continue;const T=o[h].properties.magic;if(o[h].properties.heightOffset===A&&o[h].properties.coordOffset[0]===m[0]&&o[h].properties.coordOffset[1]===m[1]||(this.q(o[h]),o[h].$=sy([],o[h].localTransform)),o[h].V=i,"b3dm"===T){if(o[h].getBoundingBox&&!Hj(l,o[h].getBoundingBox()))continue;const{batchIdData:t,batchIdMap:e}=o[h].geometry.properties;if(t&&e){const t=o[h].properties.node.H;this.J&&this.J[t]?eE.highlightMesh(this.m,o[h],this.J[t],this.Y,e):this.J&&this.J[t]||eE.highlightMesh(this.m,o[h],null,this.Y,e),eE.showOnly(this.m,o[h],this.Z&&this.Z[t],this.K,e)}if(a&&a.length&&a.indexOf(o[h].V.id)<0)continue;n&&n.bloom&&o[h].properties.hlBloomMesh&&(o[h].properties.hlBloomMesh.properties.depthFunc="always",u.push(o[h].properties.hlBloomMesh)),u.push(o[h])}else"pnts"===T?f.push(o[h]):"i3dm"===T&&g.push(o[h]);o[h].properties.isLeaf=t[e].leave,o[h].properties.branchRootId=t[e].branchRootId;const M=255-t[e].selectionDepth;o[h].properties.selectionDepth=M,o[h].properties.polygonOffset=w;const C=void 0===s.cullFace||!!s.cullFace;o[h].properties.cullFace=C;const P=o[h].properties.hlBloomMesh;if(P){const n=P.properties;n.branchRootId=t[e].branchRootId,n.selectionDepth=M,n.polygonOffset=w,n.cullFace=C}t[e].leave||c.push(o[h]),this.X(o[h]),this.W(o[h],i)}}let A=0;const m=this.P.getExcludeFilter();gI.setIncludeUniformValues(a,n),A+=this.tt(this.et,a,[o,yZ,m],i,c,u,g),A+=this.tt(this.nt,a,[o,_Z,m],i,c,u,g),this.P.forEachShader(((t,e,n)=>{const s=this.D(n);A+=this.tt(t,s,[o,e],i,c,u,g)})),this.S.setMeshes(f);const w=this.rt();return A+=this.p.render(this.st,w,this.S,i&&i.fbo),this.G={pntsMeshes:f,i3dmMeshes:g,b3dmMeshes:u},this.k.setMeshes(e),this.p.render(this.it,a,this.k,i&&i.fbo),A}prepareRender(t){this.ot(t)}ot(t){t&&t.states&&t.states.includesChanged&&(this.nt.dispose(),delete this.nt,this.et.dispose(),delete this.et),this.ct(t)}tt(t,e,n,i,o,s,a){t.filter=n.filter((t=>!!t)),e.stencilEnable=!1,e.cullFace="back";const l=i&&i.fbo;let h=0;const c=[],u=[];let f=!1,g=s[0]&&s[0].properties.branchRootId;for(let n=0;n<s.length;n++){const{branchRootId:i}=s[n].properties;i!==g&&(f?(u.length&&(h+=this.lt(t,e,l,!1,u),u.length=0),h+=this.lt(t,e,l,f,c)):rV(u,c),g=i,f=!1,c.length=0),c.push(s[n]),s[n].properties.selectionDepth<255&&(f=!0),n===s.length-1&&(f||(rV(u,c),c.length=0),u.length&&(h+=this.lt(t,e,l,!1,u)),h+=this.lt(t,e,l,f,c))}return this.I.setMeshes(s.filter((t=>t.properties.isLeaf))),this.C.setMeshes(a),h+=this.p.render(t,e,this.C,i&&i.fbo),h}lt(t,e,n,i,o){return o.length?(this.I.setMeshes(o),e.stencilEnable=!1,i&&(this.ht(n),e.stencilEnable=!1,e.cullFace="front",this.p.render(t,e,this.I,n),e.cullFace="back",e.stencilEnable=!0),this.p.render(t,e,this.I,n)):0}ht(t){this.m.clear({stencil:255,framebuffer:t})}getCurrentB3DMMeshes(){return this.I.getMeshes()}getCurrentI3DMMeshes(){return this.C.getMeshes()}ut(t,e){return e.V.ft-t.V.ft}deleteTile(t){const e=t.node;e.dt&&(e.dt.geometry.dispose(),e.dt.dispose(),delete e.dt);this.bt(e.id)}bt(t){const e=this.T[t]||this._[t]||this.M[t]||this.O[t]||this.v[t];this.O[t]?this.yt(t):e&&(this.gt(e),delete this.T[t],delete this._[t],delete this.M[t],delete this.v[t])}yt(t){let e=this.O[t];e=tV(e);for(let t=0;t<e.length;t++){const{id:n}=e[t].properties;this.bt(n)}delete this.O[t]}gt(t){if(Array.isArray(t))for(let e=0,n=t.length;e<n;e++)this.gt(t[e]);else{eE.showOnly(this.m,t),eE.highlightMesh(this.m,t);const e=t.geometry.properties.url;if(e){const n=this.A[e];n&&n.refMeshes&&(n.refMeshes.delete(t.uuid),n.refMeshes.size||(n.geometry.dispose(),n.material.dispose(),delete this.A[e]))}else t.geometry.dispose(),t.material&&t.material.dispose();t.dispose()}}remove(){const t=this.h;sZ(t.getRenderer().canvas,t.getMap());for(const t in this.O)this.yt(t);this.O={};for(const t in this.T)this.bt(t);this.T={};for(const t in this._)this.bt(t);this._={};for(const t in this.M)this.bt(t);this.M={};for(const t in this.v)this.bt(t);this.v={},this.et&&(this.et.dispose(),delete this.et),this.nt&&(this.nt.dispose(),delete this.nt),this.st&&(this.st.dispose(),delete this.st),this.it&&(this.it.dispose(),delete this.it),this.P.dispose(),this.picking&&this.picking.dispose()}F(t){return this.T[t.id]||this._[t.id]||this.M[t.id]||this.O[t.id]}has(t){return this.F(t)||this.v[t.id]}q(t){const e=t.properties.magic;"b3dm"===e?this.wt(t):"i3dm"===e?this.vt(t):"pnts"===e&&this.Tt(t)}createPntsMesh(t,e,n,i){if(this._[e]){const t=this._[e];return console.warn(`pnts mesh with id(${e}) was already created.`),i(null,{id:e,mesh:t}),t}const{pnts:o,featureTable:s,rootIdx:a,compressed_int16_params:l}=t,h=s.POINTS_LENGTH;o.BATCH_ID||(o.BATCH_ID=new Uint8Array(h),o.BATCH_ID.fill(0));const c=new vb(o,null,h,{static:!0,primitive:"points",positionAttribute:"POSITION",pickingIdAttribute:"BATCH_ID"});c.generateBuffers(this.m);const u={};o.POSITION?u.HAS_POSITION=1:o.POSITION_QUANTIZED&&(u.HAS_POSITION_QUANTIZED=1),o.RGB?u.HAS_RGB=1:o.RGBA?u.HAS_RGBA=1:o.RGB565&&(u.HAS_RGB565=1),(o.NORMAL||o.NORMAL_OCT16P)&&(u.HAS_NORMAL=1,o.NORMAL_OCT16P&&(u.HAS_NORMAL_OCT16P=1)),this._t(u,l),t.featureTable.CONSTANT_RGBA&&(t.featureTable.CONSTANT_RGBA=t.featureTable.CONSTANT_RGBA.map((t=>t/255)));const{rtcCenter:f,rtcCoord:g,projCenter:A}=t,m=this.h.j(a),w=new aw(c);w.properties.magic="pnts",w.properties.id=e,w.properties.node=n,w.properties.count=h,w.properties.batchTable=t.batchTable,w.properties.batchTableBin=t.batchTableBin,w.properties.serviceIndex=a,w.properties.rtcCoord=g,w.properties.rtcCenter=f,w.properties.projCenter=A,w.setDefines(u),w.setFunctionUniform("pointColor",(function(){return t.featureTable.CONSTANT_RGBA?t.featureTable.CONSTANT_RGBA:m&&m.pointColor||[1,1,1,1]}));const T=this.getMap();let M=null,C=null;w.setFunctionUniform("pointSize",(function(){if(!m)return 2;if(qW(m.pointSize)){const t=JSON.stringify(m.pointSize);return t!==M&&(C=XW(m.pointSize),M=t),C(T.getZoom())}return m.pointSize||2}));let P=null,I=null;return w.setFunctionUniform("pointOpacity",(function(){if(!m)return 1;if(qW(m.pointOpacity)){const t=JSON.stringify(m.pointOpacity);return t!==P&&(I=XW(m.pointOpacity),P=t),I(T.getZoom())}return m.pointOpacity||1})),this.Mt(w,l),this.Tt(w),w.$=sy([],w.localTransform),this._[e]=w,i(null,{id:e,mesh:[w]}),[w]}Tt(t){const e=t.localTransform||[],{rtcCoord:n,node:i,projCenter:o}=t.properties;this.Ot(e,n,o,i.H),t.setLocalTransform(e)}createI3DMMesh(t,e,n,i){if(this.M[e]){const t=this.M[e];return console.warn(`i3dm mesh with id(${e}) was already created.`),this.v[e]||i(null,{id:e,mesh:t}),t}const o=this.h.j(n.H),s=this.At(n.xt),{i3dm:a,featureTable:l,gltf:h,batchTable:c,batchTableBin:u,count:f}=t,g=l.INSTANCES_LENGTH,{rtcCenter:A,rtcCoord:m,projCenter:w}=t,T=this.It(PZ,n,A,m);yW(T,pZ,T);const M=vy(IZ,T);Av(M,M);const C=_y(OZ,T),P=py(EZ,C),I=this.St(kZ,w,n),O=this.Ct(DZ),E=this.kt(FZ,m),D=i_(NZ,E,O),N=py(HZ,D),{POSITION:H,NORMAL_UP:U,NORMAL_RIGHT:W,SCALE:q,SCALE_NON_UNIFORM:X}=a,J={instance_vectorA:new Float32Array(4*g),instance_vectorB:new Float32Array(4*g),instance_vectorC:new Float32Array(4*g),aPickingId:new Uint16Array(g)};for(let t=0;t<g;t++)J.aPickingId[t]=t;const Q=new Float32Array(3),Y=new Float32Array(3),K=[],$=new Float32Array(1),tt=new Float32Array(3),et=[],nt=[],it=[],rt=[];!function(t,e){let{byteOffset:n,byteStride:i,count:o}=t;const{componentType:s,itemSize:a}=t,l=t.array.buffer,h=s?yV.getTypedArrayCtor(s):t.array.constructor;if(n=void 0===n?t.array.byteOffset:n,i=i||0,o=o||t.array.length/a,(!i||i===a*h.BYTES_PER_ELEMENT)&&n%h.BYTES_PER_ELEMENT==0){const t=new h(l,n,o*a);for(let i=0;i<o*a;i+=a)e(new h(t.buffer,n+i*h.BYTES_PER_ELEMENT,a),i/a);return}const c=new Uint8Array(a*h.BYTES_PER_ELEMENT);i||(i=a*h.BYTES_PER_ELEMENT);for(let t=0;t<o;t++){const o=new Uint8Array(l,i*t+n,a*h.BYTES_PER_ELEMENT);c.set(o),e(new h(c.buffer),t),o.set(c)}}(H,((t,e)=>{U?(SV(Y,W,e),SV(Q,U,e),Xy(K,Y,Q),Zy(K,K),$U(et,Y,0),$U(et,Q,1),$U(et,K,2),J_(nt,et),Av(nt,nt),j_(nt,M,nt)):z_(nt),q?(SV($,q,e),Fy(it,$[0],$[0],$[0])):X?(SV(tt,X,e),Fy(it,...tt)):Fy(it,1,1,1),xy(rt,nt,t,it),PV(J.instance_vectorA,e,rt,0),PV(J.instance_vectorB,e,rt,1),PV(J.instance_vectorC,e,rt,2)}));const ot={};for(const t in J)ot[t]={buffer:this.m.buffer({dimension:J[t].length/g,data:J[t]}),divisor:1};const st=o.shader||"pbr";let at=0,ut=!0;const ft=[],gt=[];return _V(h,((t,i,o,a)=>{const h=this.Nt(t,i,o,a,n,!0,st,gt),{geometry:M,material:C}=h;C&&!C.isReady()&&(ut=!1,at++);const O=new lw(ot,g,M,C);h.refMeshes||(h.refMeshes=new Set,h.refMeshes.add(O.uuid)),O.properties.magic="i3dm",O.properties.id=e,O.properties.count=f,O.properties.batchTable=c,O.properties.batchTableBin=u,O.properties.serviceIndex=n.H,O.properties.rtcCoord=m,O.properties.rtcCenter=A,O.properties.projCenter=w,O.properties.node=n;const E=this.Lt(t,M,C,n.H,a);t.compressed_int16_params&&this.Mt(O,t.compressed_int16_params),this.Et(O,t.attributes);const D=ay([]);if(t.matrices&&t.matrices.length)for(let e=0;e<t.matrices.length;e++)cy(D,D,t.matrices[e]);cy(D,s,D),cy(D,N,D),cy(D,l.EAST_NORTH_UP||U?P:T,D),O.setPositionMatrix(D),this.vt(O,I),O.setDefines(E),O.properties.polygonOffset={offset:0,factor:0},ft.push(O),delete t.attributes,O.$=sy([],O.localTransform)})),VZ(gt),ut?(this.M[e]=ft,i(null,{id:e,mesh:ft})):(this.v[e]={meshes:ft,count:at},ft.Rt=i),ft}vt(t,e){const{rtcCoord:n,node:i,projCenter:o}=t.properties;e||(e=this.St(kZ,o,i));const s=this.h.j(i.H),a=t.localTransform||[];if(s.coordOffset){cy(a,this.Pt(PZ,i.H,n),e)}else sy(a,e);t.setLocalTransform(a),t.properties.heightOffset=s.heightOffset||0,t.properties.coordOffset=s.coordOffset&&s.coordOffset.slice(0)||AZ}St(t,e,n){py(t,this.Ct(DZ));const i=this.Ut(CZ,e,n.H);return cy(t,gy(RZ,i),t),t}createB3DMMesh(t,e,n,i){if(t.gltf&&(t.gltf.transferables=null),this.T[e]||this.v[e]){const t=this.T[e];return console.warn(`mesh with id(${e}) was already created.`),this.v[e]||i(null,{id:e,mesh:t}),t}let o;if(n.maxExtent){const t=new Ph(n.maxExtent).convertTo((t=>this._pointToPrj(t)));o=[t.xmin,t.ymin,t.xmax,t.ymax]}const s=t.gltf,{projCenter:a}=s.extensions.ispace_RTC,{rtcCoord:l,center:h}=s.extensions.CESIUM_RTC,c=s.asset.sharePosition,u=this.At(n.xt),f=this.Bt(kZ,c,l,h,a,n),g=this.h.j(n.H);let A=g.shader||"pbr";if(g.unlit)A="phong";else if(s.materials)for(let t=0;t<s.materials.length;t++)if(s.materials[t]&&s.materials[t].extensions&&s.materials[t].extensions.KHR_materials_unlit){A="phong";break}const m=[],w=[];let T=0,M=!0;return _V(s,((i,s,C,P)=>{const I=this.Nt(i,s,C,P,n,!1,A,m),{geometry:O,material:E}=I;E&&!E.isReady()&&(M=!1,T++);const D=new aw(O,E);I.refMeshes||(I.refMeshes=new Set,I.refMeshes.add(D.uuid)),D.properties.magic="b3dm",D.properties.id=e,D.properties.node=n,t.batchTable&&(D.properties.batchTable=t.batchTable,D.properties.batchTableBin=t.batchTableBin),D.properties.count=t.featureTable&&t.featureTable.BATCH_LENGTH||0,D.properties.serviceIndex=n.H;const N=this.Lt(i,O,E,n.H,P);D.setDefines(N);const H=i.compressUniforms;if(H)for(const t in H)D.setUniform(t,H[t]);i.compressed_int16_params&&this.Mt(D,i.compressed_int16_params),this.Et(D,i.attributes),o&&(N.USE_MAX_EXTENT=1,D.setUniform("maxPrjExtent",o)),D.hasFunctionUniform("polygonOpacity")||D.setFunctionUniform("polygonOpacity",(function(){return ZU(g.opacity)?g.opacity:1})),D.hasFunctionUniform("polygonFill")||D.setFunctionUniform("polygonFill",(function(){return sV([],g.polygonFill||cZ)})),D.material.hasFunctionUniform("hsv")||D.material.setFunctionUniform("hsv",(function(){return g.hsv||uZ}));const U=ay([]);if(c&&i.matrices&&i.matrices.length)for(let t=0;t<i.matrices.length;t++)cy(U,U,i.matrices[t]);c&&cy(U,u,U),D.properties.node=n,D.properties.projCenter=a,D.properties.nodeMatrix=U,D.properties.isSharedPosition=c,D.properties.rtcCoord=l,D.properties.rtcCenter=h,this.wt(D,f),w.push(D),delete i.attributes,D.$=sy([],D.localTransform)})),VZ(m),M?(this.T[e]=w,i(null,{id:e,mesh:w})):(this.v[e]={meshes:w,count:T},w.Rt=i),w}Gt(t){const e=this.h.Dt(t.id);if(!e||t.dt)return;let n,i,o,s;if(e.obbox)n=e.boxPosition,i=zZ,o=e.boxCenter,s=UZ;else if(e.sphereBox){const t=e.sphereBox[1];n=GZ.vertices,i=GZ.indices,o=e.sphereBox[0],s=[t,t,t]}const a=new vb({POSITION:n},i,0,{primitive:"lines",positionAttribute:"POSITION"}),l=new aw(a,new Qb({lineColor:[.8,.8,.1,1],lineOpacity:1})),h=[];xy(h,jZ,o,s),l.localTransform=h,l.$=sy([],h),l.properties.node=t,t.dt=l}Ft(t){t.dt&&(t.dt.geometry.dispose(),t.dt.dispose(),delete t.dt)}Mt(t,e){e.POSITION&&t.setUniform("compressedPositionRange",e.POSITION),e.TEXCOORD_0&&t.setUniform("compressedTexcoordRange_0",e.TEXCOORD_0),e.TEXCOORD_1&&t.setUniform("compressedTexcoordRange_1",e.TEXCOORD_0),e.NORMAL&&t.setUniform("compressedNormalRange",e.NORMAL),e.TANGENT&&t.setUniform("compressedTangentRange",e.TANGENT),e.compressed_ratio&&t.setUniform("compressed_ratio",e.compressed_ratio)}wt(t,e){const{isSharedPosition:n,rtcCoord:i,rtcCenter:o,projCenter:s,nodeMatrix:a,node:l}=t.properties;e||(e=this.Bt(e||kZ,n,i,o,s,l));const h=t.localTransform||ay([]);cy(h,e,a);const c=this.h.j(l.H);if(c.coordOffset){cy(h,this.Pt(PZ,l.H,i),h)}t.setLocalTransform(h),t.properties.heightOffset=c.heightOffset||0,t.properties.coordOffset=c.coordOffset&&c.coordOffset.slice(0)||AZ}Bt(t,e,n,i,o,s){if(e){const e=this.kt(FZ,n),o=py(SZ,e);cy(t,this.It(PZ,s,i,n),o)}else this.Ot(t,n,o,s.H);return t}Et(t,e){if(e&&e.TEXCOORD_0&&e.TEXCOORD_0.extensions&&e.TEXCOORD_0.extensions.WEB3D_quantized_attributes){t.setUniform("decodeMatrix",e.TEXCOORD_0.extensions.WEB3D_quantized_attributes.decodeMatrix)}}It(t,e,n,i){const o=this.getMap(),s=this.h.j(e.H).heightOffset||0,a=e.matrix?sy(t,e.matrix):ay(t);n&&yW(a,Jy(vZ,n,a),a);const l=function(t,e,n,i,o,s,a){e=Dy(vW,e);const l=RV(vW,e[0]*IW,e[1]*IW,e[2]),h=yy(xW,n),c=i.ellipsoid;let u;u=0===s_(h)?Fy(bW,0,0,-6378137):BV(bW,h),SW.x=u[0],SW.y=u[1];const f=i.project(SW,PW);wW[0]=f.x/o,wW[1]=f.y/o,wW[2]=(u[2]+a)*s;const g=_W(l,c,TW);return yW(function(t,e,n){const i=t[0],o=t[1],s=t[2],a=t[4],l=t[5],h=t[6],c=t[8],u=t[9],f=t[10],g=e[0],A=e[1],m=e[2],w=e[3],T=e[4],M=e[5],C=e[6],P=e[7],I=e[8],O=o*g+l*A+u*m,E=s*g+h*A+f*m,D=i*w+a*T+c*M,N=o*w+l*T+u*M,H=s*w+h*T+f*M,U=i*C+a*P+c*I,W=o*C+l*P+u*I,q=s*C+h*P+f*I;return n[0]=i*g+a*A+c*m,n[1]=O,n[2]=E,n[3]=0,n[4]=D,n[5]=N,n[6]=H,n[7]=0,n[8]=U,n[9]=W,n[10]=q,n[11]=0,n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15],n}(hy(MW,g),Qm(CW,n),t),wW,t),t}(a,i,a,o.getProjection(),o.getGLRes(),this.B,s),h=function(t,e){return Fy(t,e[12],e[13],e[14]),t}(CZ,l);let c=this.h.options.offset;if(VU(c)){const t=this.h.Dt(e.id).boxCoord;c=c.call(this.h,t)}return Fy(MZ,c[0],c[1],0),e_(h,h,MZ),yW(l,h,l),l}Pt(t,e,n){const i=this.h.j(e);if(!i.coordOffset)return null;const o=this.getMap(),s=o.getGLRes();xZ.set(n[0],n[1]);const a=o.coordToPointAtRes(xZ,s,wZ),l=i.coordOffset,h=xZ.set(n[0]+l[0],n[1]+l[1]),c=o.coordToPointAtRes(h,s,TZ);return gy(t,Fy(MZ,c.x-a.x,c.y-a.y,(l[2]||0)*this.B))}createCMPTMesh(t,e,n,i){if(this.O[e]){const t=this.O[e];return console.warn(`mesh with id(${e}) was already created.`),i(null,{id:e,mesh:t}),t}const{content:o}=t,s=[];for(let t=0;t<o.length;t++){const{magic:i}=o[t],a=e+"."+t;"b3dm"===i?this.createB3DMMesh(o[t],a,n,((t,{mesh:e})=>{s.push(e)})):"i3dm"===i?this.createI3DMMesh(o[t],a,n,((t,{mesh:e})=>{s.push(e)})):"pnts"===i?this.createPntsMesh(o[t],a,n,((t,{mesh:e})=>{s.push(e)})):"cmpt"===i&&this.createCMPTMesh(o[t],a,n,((t,{mesh:e})=>{s.push(e)}))}return this.O[e]=s,i(null,{id:e,mesh:s}),s}Lt(t,e,n,i,o){const s=("phong"===(this.h.j(i).shader||"pbr")?this.et:this.nt).getGeometryDefines(e);return o.asset&&"S3M"===o.asset.generator&&this.jt(s,e),e.data.uvRegion&&(s.HAS_I3S_UVREGION=1),e.data[e.desc.normalAttribute]&&(s.VertexNormal=1),e.data[e.desc.color0Attribute]&&(s.VertexColor=1),e.data[e.desc.uv0Attribute]&&(s.TexCoord=1),e.data[e.desc.textureCoordMatrixAttribute]&&(s.HAS_TextureCoordMatrix=1),n.get("uTexture")&&(s.COMPUTE_TEXCOORD=1),n.get("uTexture2")&&(s.TexCoord2=1),"MESHOPT"===this.h.zt&&(s.MeshOPT_Compress=1),this.hasIBL()&&(s.HAS_IBL_LIGHTING=1),t.attributes&&t.attributes.TEXCOORD_0&&"WEB3D_quantized_attributes"===t.attributes.TEXCOORD_0.extensions&&(s.HAS_WEB3D_quantized_attributes_TEXCOORD=1),s.HAS_MIN_ALTITUDE=1,s.HAS_LAYER_OPACITY=1,this._t(s,t.compressed_int16_params),UU(s,t.compressDefines),s}_t(t,e){e&&Object.keys(e).length>0&&(t.HAS_COMPRESSED_INT16=1,e.POSITION&&(t.HAS_COMPRESSED_INT16_POSITION=1),e.TEXCOORD_0&&(t.HAS_COMPRESSED_INT16_TEXCOORD_0=1),e.TEXCOORD_1&&(t.HAS_COMPRESSED_INT16_TEXCOORD_1=1),e.NORMAL&&(t.HAS_COMPRESSED_INT16_NORMAL=1),e.TANGENT&&(t.HAS_COMPRESSED_INT16_TANGENT=1),e.compressed_ratio&&(t.HAS_COMPRESSED_INT16_RATIO=1))}X(t){const e=this.h.getRenderer();e&&e.updateMaskDefines(t)}jt(t,e){e.data.aNormal&&(t.VertexNormal=1),e.data.instanceId&&(t.Instance=1),e.data.aTexCoord0&&(t.TexCoord=1),e.data.aColor&&(t.VertexColor=1),e.data.aTexCoord1&&(t.TexCoord2=1),e.data.uv2&&(t.InstanceBim=1)}Nt(t,e,n,i,o,s,a,l){let h=!1;i.asset&&"S3M"===i.asset.generator&&(h=!0,i.extensions=i.extensions||{});const c=i.url+"-"+e+"-"+n;if(this.A[c])return this.A[c];let u,f;l.push(t);const g=i.materials&&i.materials[t.material],A=i.extensions&&i.extensions.KHR_techniques_webgl,m=this.h.j(o.H);if(A&&g.extensions&&g.extensions.KHR_techniques_webgl){const e=this.Ht(t,i,s,h);u=e.material,f=e.geometry,m.fillEmptyDataInMissingAttribute&&(f.desc.fillEmptyDataInMissingAttribute=!0)}else{f=this.qt(t,s,BZ);u=this.$t(t.material,i,a,m.material||fZ,l,m)}u&&(u.setFunctionUniform("alphaTest",(function(){const t=m.alphaTest;return jU(t)?.1:t})),u.setFunctionUniform("environmentExposure",(()=>{const t=m.ambientLight;let e=m.environmentExposure;const n=this.getMap().getLightManager(),i=n&&n.getAmbientLight();if(t&&(!i||i.color)&&void 0===e){e=t[0]/(i&&i.color?i.color[0]:.2)}return e||1}))),u&&!u.isReady()?u.Vt=o.id:u||(u=new $b({baseColorFactor:[1,1,1,1]}));const w={geometry:f,material:u};return f.properties.url=c,this.A[c]=w,w}Ht(t,e,n,i){const{geometry:o,material:s}=this.P.createMesh(t,e,n,i);return{geometry:o,material:s}}qt(t,e,n){const i=t.attributes,o="COLOR_0";let s=i._BATCHID&&i._BATCHID.array;if(s&&s.byteOffset&&(s=new s.constructor(s)),i[o]){const t=i[o].array||i[o];if(t instanceof Float32Array){const e=new Uint8Array(t.length);for(let n=0;n<e.length;n++)e[n]=Math.round(255*t[n]);i[o].array?(i[o].array=e,i[o].componentType=5121):i[o]=e}}const a={};for(const t in i){const e=nZ(this.m,i[t],{dimension:i[t].itemSize}),o=n[t]||t;a[o]={buffer:e},i[t].quantization&&(a[o].quantization=i[t].quantization),o===n.POSITION&&(a[o].array=i[t].array,a[o].min=i[t].min,a[o].max=i[t].max)}const l=t.indices?t.indices.array?t.indices.array.slice():t.indices:null,h=new vb(a,l,0,{positionAttribute:n.POSITION,normalAttribute:n.NORMAL,uv0Attribute:n.TEXCOORD_0,uv1Attribute:n.TEXCOORD_1,color0Attribute:n.COLOR_0,tangentAttribute:n.TANGENT,pickingIdAttribute:n._BATCHID,primitive:void 0===t.mode?"triangles":eZ(t.mode)});return s&&l&&(h.properties.batchIdData=s,h.properties.batchIdMap=function(t,e){if(!e)return null;const n=new Map;for(let i=0;i<e.length;i++){const o=e[i],s=t[o];let a=n.get(s);a||(a=[],n.set(s,a)),a.push(o)}return n}(s,l)),h.generateBuffers(this.m,{excludeElementsInVAO:e}),h}Ot(t,e,n,i){const o=ay(t),s=this.Ct(dZ);return this.Ut(CZ,n,i),uy(o,o,CZ),fy(o,o,s),o}Ut(t,e,n){const i=this.B;xZ.x=e[0],xZ.y=e[1];const o=this._prjToPoint(xZ);let s=this.h.options.offset;VU(s)&&(s=s.call(this.h,xZ));const a=this.h.j(n).heightOffset||0;return Fy(t,o.x-s[0],o.y-s[1],i*e[2]+i*a),t}W(t,e){const n=this.h.Jt(LZ,e);t.localTransform=cy(t.localTransform,n,t.$)}kt(t,e){const n=this.getMap();xZ.x=e[0],xZ.y=e[1];const i=n.distanceToPointAtRes(100,100,n.getGLRes(),xZ);return Fy(t,i.x/100,i.y/100,this.B),t}ct(t){if(this.nt)return;const e=[],n=[];this.st=new zw({vert:IV,frag:"#define SHADER_NAME PNTS\nprecision mediump float;\nvarying vec4 vColor;\nvoid main() {\n    vec2 circCoord = 2.0 * gl_PointCoord - 1.0;\n    if (dot(circCoord, circCoord) > 1.0) {\n        discard;\n    } else {\n        gl_FragColor = vColor;\n    }\n}\n",uniforms:[{name:"projViewModelMatrix",type:"function",fn:(t,e)=>cy(n,e.projViewMatrix,e.modelMatrix)},{name:"modelNormalMatrix",type:"function",fn:(t,n)=>Qm(e,n.modelMatrix)}],extraCommandProps:{viewport:{x:0,y:0,width:()=>this.u?this.u.width:1,height:()=>this.u?this.u.height:1},blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"},depth:{enable:!0,func:"<"}}});const i={},o=[];gI.fillIncludes(i,o,t);const s=this.U();this.et=new Gw({uniforms:o,defines:i,extraCommandProps:s}),this.nt=new xC.StandardShader({uniforms:o,defines:i,extraCommandProps:s}),this.it=new lT({extraCommandProps:{viewport:{x:0,y:0,width:()=>this.u?this.u.width:1,height:()=>this.u?this.u.height:1},blend:{enable:!0,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one minus src alpha",dstAlpha:"one minus src alpha"},equation:"add"}}});const a=this.h;oZ(a.getRenderer().canvas,this.m,a.getMap()),this.picking=new zM(this.p,{vert:this.nt.vert,extraCommandProps:s,uniforms:this.nt.uniforms,defines:{PICKING_MODE:1,ENABLE_PICKING:1,HAS_PICKING_ID:1}},this.pickingFBO,this.getMap()),this.Yt=new zM(this.p,{vert:IV,extraCommandProps:s,uniforms:this.st.uniforms,defines:{PICKING_MODE:1,ENABLE_PICKING:1,HAS_PICKING_ID:1}},this.pickingFBO,this.getMap())}U(){return{viewport:{x:0,y:0,width:()=>this.u?this.u.width:1,height:()=>this.u?this.u.height:1},cull:{enable:(t,e)=>e.meshProperties.cullFace,face:(t,e)=>e.cullFace||"back"},stencil:{enable:(t,e)=>e.stencilEnable,func:{cmp:"<=",ref:(t,e)=>e.meshProperties.selectionDepth},opFront:{fail:"keep",zfail:"keep",zpass:"replace"},opBack:{fail:"keep",zfail:"keep",zpass:"replace"}},depth:{enable:!0,func:(t,e)=>e.meshProperties.depthFunc||"<="},blend:{enable:!0,func:{src:1,dst:"one minus src alpha"},equation:"add"},polygonOffset:{enable:!0,offset:(t,e)=>e.meshProperties.polygonOffset}}}rt(t){const e=this.getMap(),n=e.getLightManager(),i=(n&&n.getDirectionalLight()||{}).direction||[1,1,-1];return{projViewMatrix:e.projViewMatrix,pointOpacity:t&&t.pointOpacity||1,lightDir:Zy(mZ,i)}}D(){const t=this.getMap(),e=this.h,n=e.getRenderer().canvas,{iblTexes:i,dfgLUT:o}=aZ(n),s=lZ(t,i,o),a=this.h.getRenderer(),l=a.getMaskUniforms();s.minAltitude=e.options.altitude||0;return s.layerOpacity=a.canvas.gl&&a.canvas.gl.wrap?e.options.opacity||0:1,UU(s,{czm_lightDirectionEC:s.light0_viewDirection,lightSpecular:[1,1,1],viewMatrix:t.viewMatrix,projMatrix:t.projMatrix,projViewMatrix:t.projViewMatrix,outSize:[n.width,n.height],polygonFill:[1,1,1,1],polygonOpacity:1}),UU(s,l),s}$t(t,e,n,i,o,s){const a=e.materials&&e.materials[t];if(!a||!a.baseColorTexture&&!a.pbrMetallicRoughness)return null;const l=UU({},i);if(a.baseColorTexture){const t=e.textures[a.baseColorTexture.index];let n;t&&!t.image.color&&(n=this.Zt(t,o)),l.baseColorFactor=t&&t.image.color||a.baseColorFactor||[1,1,1,1],n&&(l.baseColorTexture=n)}else{if(a.normalTexture){const t=this.Zt(e.textures[a.normalTexture.index],o);if(t){const e=a.normalTexture.scale||1;l.normalTexture=t,l.normalMapFactor=e}}if(a.occlusionTexture){const t=this.Zt(e.textures[a.occlusionTexture.index],o);if(t){const e=a.occlusionTexture.strength||1;l.occlusionTexture=t,l.occlusionFactor=e}}if(a.emissiveTexture){const t=this.Zt(e.textures[a.emissiveTexture.index],o);t&&(l.emissiveTexture=t)}a.emissiveFactor&&(l.emissiveFactor=a.emissiveFactor);const t=a.pbrMetallicRoughness;if(t){if(t.baseColorFactor&&(l.baseColorFactor=t.baseColorFactor),t.baseColorTexture&&void 0!==t.baseColorTexture.index){const n=e.textures[t.baseColorTexture.index];if(n&&n.image&&n.image.color)l.baseColorFactor=l.baseColorFactor?m_(l.baseColorFactor,l.baseColorFactor,n.image.color):n.image.color;else{const t=this.Zt(n,o);t&&(l.baseColorTexture=t,l.baseColorTexture.getREGLTexture(this.m))}}if(jU(t.metallicFactor)||(l.metallicFactor=t.metallicFactor),jU(t.roughnessFactor)||(l.roughnessFactor=t.roughnessFactor),a.metallicRoughnessTexture){const t=this.Zt(e.textures[a.metallicRoughnessTexture.index],o);t&&(l.metallicRoughnessTexture=t)}}}if(a.s3mMaterial)return new Qb(l);if(s.unlit||a.extensions&&a.extensions.KHR_materials_unlit){l.ambientColor=[1,1,1],l.light0_diffuse=[0,0,0,0],l.lightSpecular=[0,0,0];const t=new $b(l);return t.unlit=void 0===s.unlit||!!s.unlit,t}let h=new xC.StandardMaterial(l);"phong"===n&&(h=$b.convertFrom(h));const c=a.pbrMetallicRoughness,u=c&&c.baseColorTexture&&c.baseColorTexture.extensions;return u&&u.KHR_texture_transform&&(h.set("khr_offset",u.KHR_texture_transform.offset||[0,0]),h.set("khr_rotation",u.KHR_texture_transform.rotation||0),h.set("khr_scale",u.KHR_texture_transform.scale||[1,1])),h.doubleSided=!(!s.doubleSided&&!a.doubleSided),h.once("complete",this.L),h}Zt(t,e){if(!t)return null;const n={type:t.type?$W(t.type):"uint8",format:t.format?tZ(t.format):"rgba",flipY:!!t.flipY},i=t.image;if(e.push(i),i.array?n.data=i.array:i.mipmap&&(n.mipmap=i.mipmap),!n.data&&!n.mipmap)return null;if(n.width=i.width,n.height=i.height,n.mipmap&&(n.width<4||n.height<4))return null;const o=t.sampler||t.texture&&t.texture.sampler;return o&&(o.magFilter&&(n.mag=QW(o.magFilter)),o.minFilter&&(n.min=YW(o.minFilter)),o.wrapS&&(n.wrapS=KW(o.wrapS)),o.wrapT&&(n.wrapT=KW(o.wrapT))),new Iw(n,this.N)}R({target:t}){const e=t.Vt,n=this.v[e];if(n.count--,!n.count){const t=n.meshes;this.T[e]=t,delete this.v[e];const i=t.Rt;delete t.Rt,i(null,{mesh:n.meshes,id:e})}}Ct(t){const e=1/this.getMap().getGLRes(),n=this.B;return t[0]=t[1]=e,t[2]=n,t}Kt(t){return this.h.Kt(t)}_pointToPrj(t){const e=this.getMap();return e.getGLZoom?e._pointToPrj(t,e.getGLZoom()):e._pointToPrjAtRes(t,e.getGLRes())}_prjToPoint(t){const e=this.getMap();return e.getGLZoom?e._prjToPoint(t,e.getGLZoom()):e._prjToPointAtRes(t,e.getGLRes(),bZ)}At(t){return"Y"===t?iZ:"X"===t?rZ:gZ}pick(t,e,n=3){const i=this.h;if(!i||!i.options.picking)return[];if(!this.pickingFBO||!this.picking)return[];const o=[],s=this.D(),a=this.Xt(this.picking,s,this.I,t,e,n);a&&o.push(a);const l=this.Xt(this.picking,s,this.C,t,e,n);l&&o.push(l);const h=this.rt(),c=this.Xt(this.Yt,h,this.S,t,e,n);return c&&o.push(c),o}Xt(t,e,n,i,o,s){if(!n.getMeshes().length)return null;const a=this.h,l=this.getMap();t.render(n.getMeshes().filter((t=>!t.bloom)),e,!0);let h={};t.getRenderedMeshes().length&&(h=t.pick(i,o,s,e,{viewMatrix:l.viewMatrix,projMatrix:l.projMatrix,returnPoint:a.options.pickingPoint}));const{meshId:c,pickingId:u,point:f,coordinate:g}=h,A=(0===c||c)&&t.getMeshAt(c);if(!A||!A.geometry)return null;const m=A.properties;f&&f.length&&(f[0]=Math.round(1e5*f[0])/1e5,f[1]=Math.round(1e5*f[1])/1e5,f[2]=Math.round(1e5*f[2])/1e5);const w={batchId:u},T=a.options.services,M=T&&T[A.properties.serviceIndex];if(M&&M.debug&&(w.debugInfo=m),m&&m.batchTable){const{batchTable:t,batchTableBin:e,count:n}=m,i=u;for(const o in t)w[o]=void 0!==t[o].byteOffset?nW(t[o],e,n,i):t[o][i]}return{service:A.properties.serviceIndex,data:w,point:f,coordinate:g}}highlight(t){this.J=t;const e=this.h.getRenderer();this.Y=e.getFrameTimestamp(),e.setToRedraw(!0)}cancelAllHighlight(){this.J=null;const t=this.h.getRenderer();this.Y=t.getFrameTimestamp(),t.setToRedraw(!0)}showOnly(t){this.Z=t;const e=this.h.getRenderer();this.K=e.getFrameTimestamp(),e.setToRedraw(!0)}cancelShowOnly(){this.Z=null;const t=this.h.getRenderer();this.K=t.getFrameTimestamp(),t.setToRedraw(!0)}Wt(){if(!this.G)return[];const t={},e=[];for(const n in this.G){const i=this.G[n];if(i)for(let n=0;n<i.length;n++){const o=i[n],s=o&&o.geometry;if(!o||!s)continue;const a=o.properties.serviceIndex;t[a]||(t[a]=new Set);const l=s.properties.batchIdData;if(l)for(let n=0;n<l.length;n++)t[a].has(l[n])||(e.push({id:l[n],service:a}),t[a].add(l[n]))}}return e}hasIBL(){const t=this.getMap().getLightManager();return!(!t||!t.getAmbientResource())}}function VZ(t){for(let e=0;e<t.length;e++)t[e]&&(t[e].array&&(t[e].array=null),t[e].mipmap&&(t[e].mipmap=null),t[e].indices&&(t[e].indices=null))}function WZ(t,e){if(e)for(let n=0;n<e.length;n++)t[e[n].id||e[n].index]=e[n]}const ZZ=[];class Mr{constructor(t,e,n,i,o){this.h=i,this.Qt=t,this.H=e,this.te=o,this.ee=n.version,t.indexOf("i3s:tileset:")<0?(this.ne=this.ee<=1.6?"root":0,n.version=this.ee):(this.ne=t.substring(12),this.ee>1.6&&(this.ne=parseInt(this.ne))),this.Qt=t,this.re=n}load(){const t=this.re,e=t.layerScene.baseUrl;if(this.ee<=1.6)return t[this.ne]&&t[this.ne].lodSelection?(this.se=t[this.ne],this.ie()):new Promise((n=>{let i=e+"/nodes/"+this.ne;t.layerScene.eslpk&&(i+="/3dNodeIndexDocument.json"),this.te(this.H,i,(()=>{this.se=t[this.ne],n(this.ie())}))}));if(this.ee>=1.7){if(t[this.ne])return this.se=t[this.ne],this.ie();const n=Math.floor(this.ne/t.nodesPerPage);return new Promise((i=>{let o=e+"/nodepages/"+n;t.layerScene.eslpk&&(o+=".json"),this.te(this.H,o,(()=>{this.se=t[this.ne],i(this.ie())}))}))}return null}getTileset(){return this.oe}getChildrenURL(){return this.ae}ie(){const t=this.re,e=t.layerScene.baseUrl,n=this.se.children,i=[],o={};if(n)for(let s=0;s<n.length;s++)if(this.ee<=1.6){const a=n[s].id;if(t[a])continue;const l=a;o[l]||(o[l]=new Promise((n=>{let i=e+"/nodes/"+l;t.layerScene.eslpk&&(i+="/3dNodeIndexDocument.json"),this.te(this.H,i,(()=>{n()}))})),i.push(o[l]))}else{const a=n[s];if(t[a])continue;const l=Math.floor(a/t.nodesPerPage);o[l]||(o[l]=new Promise((n=>{let i=e+"/nodepages/"+l;t.layerScene.eslpk&&(i+=".json"),this.te(this.H,i,(()=>{n()}))})),i.push(o[l]))}return i.length?Promise.all(i).then((()=>this.ce())):this.ce()}ce(){return Promise.resolve(this.le())}he(t){WZ(this.re,t)}le(){return{asset:{i3s:!0,version:"1.0",gltfUpAxis:"Z"},geometricError:Number.MAX_VALUE,root:this.ue(this.se,!0)}}ue(t){const e=this.h.getRenderer(),n=this.re.projection,i=!n||n&&4326===n.wkid,o=this.ee,s=this.re,a=t,l=a.obb,h=a.mbs,c={};let u;if(h)u=Fy([],h[0],h[1],h[2]),i||(u=e.fe(u,u)),u=qZ([],u[0],u[1],u[2]),c.sphere=[...u,h[3]];else if(l){u=Fy([],l.center[0],l.center[1],l.center[2]),i||(u=e.fe(u,u)),u=qZ([],u[0],u[1],u[2]);const t=function(t,e,n){const i=ny([],n);return i[0]=i[0]*e[0],i[1]=i[1]*e[0],i[2]=i[2]*e[0],i[3]=i[3]*e[1],i[4]=i[4]*e[1],i[5]=i[5]*e[1],i[6]=i[6]*e[2],i[7]=i[7]*e[2],i[8]=i[8]*e[2],[...t,...i]}(u,l.halfSize,l.quaternion);Fy(ZZ,t[3]+t[6]+t[9],t[4]+t[7]+t[10],t[5]+t[8]+t[11]);const n=s_(ZZ);c.sphere=[...u,n]}let f=1/0,g=0;if(a.mbs?g=a.mbs[3]:a.obb&&(g=Math.max(Math.max(a.obb.halfSize[0],a.obb.halfSize[1]),a.obb.halfSize[2])),void 0!==a.lodThreshold)"maxScreenThresholdSQ"===s.lodSelectionMetricType?f=g/(Math.sqrt(a.lodThreshold)/(.25*Math.PI)):console.error("Unsupported lodSelectionMetricType in Layer");else if(void 0!==a.lodSelection)for(let t=0;t<a.lodSelection.length;t++)"maxScreenThreshold"===a.lodSelection[t].metricType&&(f=g/a.lodSelection[t].maxError);(f===1/0||isNaN(f))&&(f=1e5);const A=16*f,m=ay([]),w=a.children;let T;if(w){T=[];const t=this.re;for(let e=0;e<w.length;e++){const n=o<=1.6?w[e].id:w[e];if(!t[n]){T=null;break}T.push(this.ue(t[n]))}}const M={refine:"REPLACE",boundingVolume:c,transform:m,geometricError:A};return o<=1.6?t.lodSelection?t.geometryData&&(M.content={uri:"i3s:mesh:"+(t.id||t.index)}):M.content={uri:"i3s:tileset:"+(t.id||t.index)}:w&&w.length&&!T?M.content={uri:"i3s:tileset:"+(t.id||t.index)}:a.mesh&&(M.content={uri:"i3s:mesh:"+(t.id||t.index)}),T&&T.length&&(M.children=T),M}getJSON(){return this.se}}function qZ(t,e,n,i){return RV(t,qU(e),qU(n),i)}const XZ=!!fV.ktx2,JZ=ay([]),QZ=(()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const t=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(t instanceof WebAssembly.Module)return new WebAssembly.Instance(t)instanceof WebAssembly.Instance}}catch(t){}return!1})();function YZ(t){return t.indexOf("i3s:mesh")>=0}function KZ(t,e,n,i,o){const s=e.layerScene.eslpk,a=function(t,e){const n=e.substring(9);return t>=1.7?parseInt(n):n}(e.version,t),l=e[a],h=e.layerScene.baseUrl,c=[];let u=!1;const f=JZ;let g,A;if(e.version<=1.6){if(!l.geometryData)return null;const t=l.geometryData.length;if(!t)return null;let n=h+`/nodes/${l.id}/`+l.geometryData[t-1].href;s&&(n+=".bin");const i={geometry:{url:n,info:e.layerScene.store.defaultGeometrySchema}};let o=l.textureData&&l.textureData[0]&&l.textureData[0].href;if(o){const t=e.layerScene.store.textureEncoding[0];let n;n="image/jpeg"===t?"jpg":"png",s&&(o+="."+n);i.material={pbrMetallicRoughness:{baseColorTexture:{url:h+`/nodes/${l.id}/`+o,factor:1,format:n,mimeType:t},metallicFactor:0}}}c.push(i)}else{g=l.mesh.geometry,A=l.mesh.material;const t=(e.layerScene.store||{}).textureEncoding,a=e.layerScene.geometryDefinitions[g.definition],{geometryBuffers:f}=a;u=i&&2===f.length;let m=h+`/nodes/${g.resource}/geometries/`+(fV.draco&&u?1:0);s&&(m+=".bin");const w={geometry:{url:m,info:fV.draco&&u?f[1]:f[0]}};if(o&&QZ&&u&&!fV.draco)throw new Error("Must import @ispace/transcoder.draco to load i3s draco compressed geometry");const T=e.layerScene.materialDefinitions;let M,C=0;A&&(C=T[A.definition]),M=T?function(t,e,n,i,o,s,a){const l=JSON.parse(JSON.stringify(e));return $Z(t,l,n,i,o,s,a),l}(t,C,e.layerScene.textureSetDefinitions,h,A.resource,n,e.layerScene.eslpk):{pbrMetallicRoughness:{metallicFactor:0}},w.material=M,c.push(w)}return{dracoCompression:u,meshes:c,nodeIndex:a,center:l.obb&&l.obb.center||l.mbs&&[l.mbs[0],l.mbs[1],l.mbs[2]],transform:f}}function $Z(t,e,n,i,o,s,a){for(const l in e)if(e[l]&&e[l].textureSetDefinitionId>=0){const h=n[e[l].textureSetDefinitionId],c="images/"+h.formats[0].format,u=eq(h.formats,s,t),f={url:i+`/nodes/${o}/textures/${u.name}`,factor:void 0===e[l].factor?1:e[l].factor,format:u.format,mimeType:c};if(a){let t="";switch(u.format){case"dds":t="bin.dds";break;case"jpg":case"png":t=u.format}f.url+="."+t}e[l]=f}else WU(e[l])&&$Z(t,e[l],n,i,o,s,a)}const tq={"image/jpeg":"jpg","image/jpg":"jpg","image/png":"jpg","image/vnd-ms.dds":"dds","image/ktx":"jpg"};function eq(t,e,n){if(n&&n.length){const e=n[n.length-1],i=tq[e];if(i){for(let e=0,n=t.length;e<n;e++)if(t[e].format===i)return t[e]}else console.error("i3s not find texture format type from:",tq,"current textureEncoding:",e)}for(let n=0;n<=t.length;n++){const i=t[n].format;if("dds"===i&&e.hasExtension("WEBGL_compressed_texture_s3tc"))return t[n];if("jpg"===i||"png"===i)return t[n];if("ktx2"===i&&XZ)return t[n]}return null}const{Ajax:nq}=dV(),iq=new gh(0,0),rq=new gh(0,0),oq=new Set,sq=[],aq=new class{constructor(t,e){this.max=t,this.currentSize=0,this.data=new Map,this.onRemove=e}reset(t){if(this.data){const e=this.data.keys();for(const n of e){const e=this.data.get(n);t&&t!==e.renderer||this.de(n,e)}}return t||(this.data=new Map,this.currentSize=0),this}clear(t){this.reset(t)}add(t,e){if(!e)return this;if(e.node&&e.node.memorySize&&(this.currentSize+=e.node.memorySize),this.has(t)){const n=this.data.get(t);n&&n.node&&n.node.memorySize&&(this.currentSize-=n.node.memorySize),this.data.delete(t),this.data.set(t,e)}else this.data.set(t,e);return this}shrink(){if(this.currentSize>this.max){let t=!1;const e=this.data.keys();let n=e.next();for(;this.currentSize>this.max&&void 0!==n.value;){!t&&this.data.get(n.value).current&&(t=!0,console.warn(`current maxGPUMemory(${this.max/1024/1024}) for Geo3DTilesLayer is not enough, one or more current tiles will be discarded.`));const i=this.getAndRemove(n.value);i&&this.onRemove(i),n=e.next()}}}has(t){return this.data.has(t)}keys(){const t=new Array(this.data.size);let e=0;const n=this.data.keys();for(const i of n)t[e++]=i;return t}getAndRemove(t){if(!this.has(t))return null;const e=this.data.get(t);return e.node&&e.node.memorySize&&(this.currentSize-=e.node.memorySize),this.data.delete(t),e}get(t){if(!this.has(t))return null;const e=this.data.get(t);return this.data.delete(t),this.data.set(t,e),e}remove(t){if(!this.has(t))return this;const e=this.data.get(t);return this.de(t,e),this}de(t,e){e.node&&e.node.memorySize&&(this.currentSize-=e.node.memorySize),this.data.delete(t),this.onRemove(e)}setMaxSize(t){return this.max=t,this.shrink(),this}getMemorySize(){let t=0;const e=this.data.values();for(const n of e){const e=n&&n.node;e&&e.memorySize&&(t+=e.memorySize)}return t}markAll(t,e){const n=this.data.values();for(const i of n)t&&i.renderer!==t||(i.current=e)}}(1024*(Gt.mobile?32:1024)*1024,(t=>{const e=t.renderer;delete t.renderer,e.deleteTile(t)}));let lq=0;class jr extends(SI(vm.CanvasRenderer)){constructor(t){super(t);const e=1024*t.options.maxGPUMemory*1024;e>aq.max&&aq.setMaxSize(e),this.tileCache=aq,lq++,this.tilesLoading={},this.me={},this.pe=[],this.te=(...t)=>this.be.call(this,...t)}getAnalysisMeshes(){if(!this.painter)return sq;const t=this.painter.getPaintedMeshes();if(!t)return sq;const e=[],{b3dmMeshes:n,pntsMeshes:i,i3dmMeshes:o}=t;return n.length&&rV(e,n.filter((t=>!(!t||!t.geometry)))),i.length&&rV(e,i.filter((t=>!(!t||!t.geometry)))),o.length&&rV(e,o.filter((t=>!(!t||!t.geometry)))),e}needToRedraw(){return!!this.getMap().isInteracting()||!!this.pe.length||super.needToRedraw()}getFrameTimestamp(){return this.ye}drawOnInteracting(t,e,n){this.draw(e,n)}draw(t,e){this.ye=t;const n=this.prepareCanvas();if(n&&!n.intersects(this.canvasExtent2D))return void this.completeRender();const{root:i,tiles:o}=this.layer.getTiles();if(!o||!o.length)return void this.completeRender();this.painter.prepareRender(e),this.ge(),this.we(e);const{selectedTiles:s,requests:a}=this.ve(i,o);a.length&&this.loadTiles(a),this.Te(s,e),this._e(),a.length||this.completeRender()}ve(t,e){let n=[];this.Me();let i=0;const o=this.Oe(),s={};let a=!1,l=!1;for(let t=0;t<e.length;t++){const o=e[t],h=o.node;if(s[h.id])continue;s[h.id]=1;let c=!1;const u=this.getCachedTile(h.id);(this.Ae(h.id)?(i++,c=l=!0,this.tilesLoading[h.id].current=!0):u?(this.getTileOpacity(u)<1&&(c=l=!0),a=!0,o.selected=!0,o.data=u):this.painter.has(h)||(c=l=!0,n.push(h)),c)&&((this.xe(o)||this.Ie(o).length)&&(a=!0))}const h=a?this.Se(t):[];if(n.length>1&&(n.sort(hq),o)){const t=o-i;n=t>0?n.slice(0,t):[]}return{loading:l,requests:n,selectedTiles:h}}Se(t){const e=[];let n,i;const o=[t],s=[];for(;o.length>0||s.length>0;){if(s.length>0){const t=s[s.length-1];if(t.Ce===o.length){s.pop(),t===n&&(t.leave=!0),t.branchRootId=i,e.push(t),0===s.length&&(i=null);continue}}const t=o.pop(),a=t.children;if(t.selected)if("add"===t.node.refine)t.leave=!0,t.selectionDepth=s.length,t.branchRootId=i,e.push(t);else{if(t.selectionDepth=s.length,n=t,0===a.length){t.leave=!0,t.branchRootId=i,e.push(t);continue}0===s.length&&(i=t.node.id),s.push(t),t.Ce=o.length}for(let t=0;t<a.length;t++)o.push(a[t])}return e}xe(t){if(!t.parent)return null;let e=t.parent;for(;e&&e.level>=0;){const t=e.node.id;if(this.tileCache.has(t))return e.selected=!0,e.data=this.tileCache.get(t),e;e=e.parent}return null}Ie(t){const e=[];if(!t.node.children||!t.node.children.length)return e;const n=t.ke+1,i=[t.node];for(;i.length>0;){const o=i.pop().children;for(let s=0,a=o.length;s<a;s++){if((!o[s].content||!o[s].content.url)&&o[s].children&&o[s].children.length){i.push(o[s]);continue}const a=o[s].id;if(this.tileCache.has(a)){const n=this.layer.Ne(o[s],t);n.selected=!0,n.data=this.tileCache.get(a),t.children.push(n),e.push(n)}else o[s].ke<=n&&i.push(o[s])}}return e}Te(t,e){this.tileCache.markAll(this,!1);const n=[];for(let e=0,i=t.length;e<i;e++){const i=t[e].data;i.current=!0,i.renderer=this,this.tileCache.add(t[e].node.id,i);const o=i.node,s=this.layer.j(o.H);o.dt&&s.debug&&!Array.isArray(s.debug)&&n.push(o.dt)}const i=this.layer.options.services;for(let t=0;t<i.length;t++){const e=i[t],o=Array.isArray(e.debug)&&e.debug;if(o)for(const t of o){const e=this.layer.Dt(t),i=e&&e.node;i&&i.dt&&n.push(i.dt)}}const o={tiles:t};this.onDrawTileStart(o);const s=this.painter.paint(t,n,e);this.layer.fire("drawtiles",{count:s}),this.onDrawTileEnd(o),s&&this.layer.fire("canvasisdirty",{renderCount:s}),this.tileCache.shrink()}onDrawTileStart(){}onDrawTileEnd(){}loadTiles(t){for(let e=0,n=t.length;e<n;e++){const n=t[e];this.tilesLoading[n.id]={current:!0,node:n},this.loadTile(n)}}loadTile(t){let e=t.content.url;if(nV(e)){const n=iV(e);return this.Le(e,n,t),null}if(function(t){return t.indexOf("i3s:tileset")>=0}(e)){const n=t.H;return new Mr(e,n,this.Ee[n],this.layer,this.te).load().then((n=>{this.onTilesetLoad(n,t,e)}))}return t&&lV(e)&&!YZ(e)&&(e=t.baseUrl+e),this.Le(e,null,t),null}Le(t,e,n){let i=this.Re;i||(i=rb.getSupportedFormats(this.gl.gl||this.gl),this.Re=i);const o=this.layer.j(n.H);o.isSuperMapiServer&&(t=function(t,e){const n=t.substring(e.length).split("/"),i=[];for(let t=0;t<n.length;t++)i.push(encodeURIComponent(n[t]));return e+i.join("/")}(t,n.baseUrl));const s={url:this.layer.getTileUrl(t,this.layer.Pe[n.H]),arraybuffer:e,rootIdx:n.H,upAxis:n.xt,transform:n.matrix,supportedFormats:i};if(YZ(t)){const e=this.Ee[n.H];if(s.projection=e.projection,s.i3sInfo=KZ(t,e,this.regl,this.layer.options.enableI3SCompressedGeometry,this.layer.options.forceI3SCompressedGeometry),!s.i3sInfo)return void this.onTileError({status:404},n,t)}s.service=UU({},o),o.offset&&delete s.service.offset,s.referrer=window&&window.location.href,this.workerConn.loadTile(this.layer.getId(),s,((e,i)=>{if(e)return void this.onTileError(e,n,t);const{magic:o}=i;"b3dm"===o||"pnts"===o||"i3dm"===o||"cmpt"===o||"gltf"===o?this.pe.push({data:i,tile:n}):this.onTilesetLoad(i,n,t)}))}Gt(t){this.painter&&this.painter.Gt(t)}Ft(t){this.painter&&this.painter.Ft(t)}we(){const t=this.getMap(),e=this.layer.options.meshLimitPerFrame;let n=0;for(;this.pe.length&&(n<e||!t.isInteracting());){const{data:t,tile:e}=this.pe.shift(),{magic:i}=t;"b3dm"===i||"gltf"===i?this.painter.createB3DMMesh(t,e.id,e,((n,{mesh:i})=>{this.Ue(t,e,n,i)})):"pnts"===i?this.painter.createPntsMesh(t,e.id,e,((n,{mesh:i})=>{this.Ue(t,e,n,i)})):"i3dm"===i?this.painter.createI3DMMesh(t,e.id,e,((n,{mesh:i})=>{this.Ue(t,e,n,i)})):"cmpt"===i&&this.painter.createCMPTMesh(t,e.id,e,((n,{mesh:i})=>{this.Ue(t,e,n,i)})),n++}}Ue(t,e,n,i){if(n)this.onTileError(n,e);else{const n=this.Be(i);e.memorySize=n,this.onTileLoad(t,e)}}Be(t){let e=0;if(Array.isArray(t))for(let n=0;n<t.length;n++)t[n]&&(e+=this.Be(t[n]));else t&&(e+=t.getMemorySize());return e}onTileLoad(t,e){this.layer&&(delete this.tilesLoading[e.id],this.layer.onTileLoad(t,e),this.Ge(e),this.setToRedraw(),this.layer.fire("tileload",{node:e}))}onTilesetLoad(t,e,n){this.layer&&(this.layer.zt=t.extensions&&t.extensions["s3m:VertexCompressionType"],t.capabilities||t.layers&&t.layers[0]&&t.layers[0].capabilities?this.De(t,e,n):(delete this.tilesLoading[e.id],this.layer.onTilesetLoad(t,e,n)))}onTileError(t,e,n){if(!this.layer)return;const i=n||e.content.url,o=t&&t.message||t;t&&(404===t.status||204===t.status)||oq.has(o)||(console.warn("failed to load 3d tile: "+i),console.warn(t),oq.add(o)),delete this.tilesLoading[e.id],(!this.layer.options.onlyCacheNoContentTileWhenError||t&&!hs.isNoContentHttpCode(t.status))&&this.Fe(e,t),this.layer.fire("tileerror",{node:e,error:t})}getCachedTile(t){return this.tileCache.get(t)}getShadowMeshes(){if(!this.painter)return[];const t=[],e=this.painter.getCurrentB3DMMeshes();for(const n in e)e[n]&&e[n].isValid&&e[n].isValid()&&t.push(e[n]);const n=this.painter.getCurrentI3DMMeshes();for(const e in n)n[e]&&n[e].isValid&&n[e].isValid()&&t.push(n[e]);return t}Fe(t,e){const n={loadTime:hs.now(),current:!0,error:e,node:t};n.renderer=this,this.tileCache.add(t.id,n)}Ge(t){const e={loadTime:hs.now(),current:!0,node:t};e.renderer=this,this.tileCache.add(t.id,e)}abortTileLoading(t){if(!t||!this.workerConn)return;const e=t.node.content.url;this.workerConn.abortTileLoading(this.layer.getId(),e),delete this.me[e]}Me(){if(this.tilesLoading)for(const t in this.tilesLoading)this.tilesLoading[t].current=!1}deleteTile(t){this.painter.deleteTile(t)}createContext(){const t=this.layer,e=t.options.glOptions||{alpha:!0,depth:!0,stencil:!0,preserveDrawingBuffer:!0,antialias:t.options.antialias},n=this.canvas.gl&&this.canvas.gl.wrap;n?(this.gl=this.canvas.gl.wrap(),this.regl=this.canvas.gl.regl):(this.glOptions=e,this.gl=this.je(this.canvas,e)),this.regl=this.regl||Dm({gl:this.gl,attributes:e,extensions:["OES_element_index_uint"],optionalExtensions:t.options.optionalExtensions||[]}),this.prepareWorker(),n&&(this.canvas.pickingFBO=this.canvas.pickingFBO||this.regl.framebuffer(this.canvas.width,this.canvas.height)),this.pickingFBO=this.canvas.pickingFBO||this.regl.framebuffer(this.canvas.width,this.canvas.height),this.painter=new wr(this.regl,t),this.layer.ze(),this.layer.fire("contextcreate",{regl:this.regl})}prepareWorker(){const t=this.getMap();this.workerConn||(this.workerConn=new pV("@ispace/3dtiles",t.id,rb.supportNPOT(this.regl)));const e=this.workerConn;if(!e.isActive())return;let n=this.layer.options||{};n=UU({},n),delete n.offset;const i=t.options.spatialReference;n.projection=i&&i.coordType||i&&i.projection||t.getSpatialReference().getProjection().code;const o=this.layer.getId();e.addLayer(o,n,(t=>{if(t)throw t;this.layer&&(this.ready=!0,this.layer.fire("workerready"))}))}onRemove(){this.painter&&this.painter.remove(),this.pickingFBO&&(this.canvas.pickingFBO||this.pickingFBO.destroy(),delete this.pickingFBO),this.workerConn&&(this.workerConn.removeLayer(this.layer.getId(),(t=>{if(t)throw t})),this.workerConn.remove(),delete this.workerConn),lq--,lq||aq.reset(),this.clear(),delete this.tileCache,super.onRemove()}clear(){this._e(!0),this.tileCache.reset(this),this.tilesLoading={},super.clear()}clearCanvas(){this.regl&&this.regl.clear({color:[0,0,0,0],depth:1,stencil:0}),super.clearCanvas()}getTileOpacity(){return 1}getStencilValue(){return 0}_e(t){this.He||(this.He=Date.now());const e=Date.now();if(!t&&e-this.He<this.layer.options.retireInterval)return;this.He=e;const n=[];for(const e in this.tilesLoading){const i=this.tilesLoading[e];!t&&i.current||(n.push(e),this.abortTileLoading(i))}for(let t=0;t<n.length;t++)delete this.tilesLoading[n[t]]}Oe(){return this.getMap().isInteracting()?this.layer.options.loadingLimitOnInteracting:this.layer.options.loadingLimit}je(t,e){const n=["webgl","experimental-webgl"];let i=null;for(let o=0;o<n.length;++o){try{i=t.getContext(n[o],e)}catch(t){}if(i)break}return i}Ae(t){return!!this.tilesLoading[t]}getI3DMMeshes(){return this.painter.getI3DMMeshes()}getPNTSMeshes(){return this.painter.getPNTSMeshes()}getB3DMMeshes(){return this.painter.getB3DMMeshes()}readBatchData(t,e,n){return tW(t,e,0,n)}ge(){if(!this.qe)return;const t=this.layer.options.i3sNodepageLimitPerFrame||Number.MAX_VALUE;let e=0;const n=[];for(const i in this.qe){const o=this.qe[i];if("pending"===o.status)continue;o.status="pending";const s=o.rootIdx,a=hV(this.layer.j(s).fetchOptions);if(n.push(nq.getJSON(i,a).then((t=>{delete this.qe[i];const e=this.Ee[s];if(e){t.nodes?WZ(e,t.nodes):(e[t.id]=t,WZ(e,t.children));for(let t=0;t<o.length;t++)o[t]();this.setToRedraw()}else this.setToRedraw()}))),e++,e>=t)break}n.length&&Promise.all(n)}be(t,e,n){this.qe||(this.qe={}),this.qe[e]=this.qe[e]||[],this.qe[e].rootIdx=t,this.qe[e].push(n),this.setToRedraw()}De(t,e,n){this.Ee||(this.Ee=[]);const i=e.H;this.Ee[i]||(this.Ee[i]={});const o=this.Ee[i],s=this.layer.j(i);t.layers&&(t=t.layers[0],"/"!==n[n.length-1]&&(n+="/"),n+="layers/0"),o.version=+(s.i3sVersion||t.store.version),!t.spatialReference||t.spatialReference.wkid&&4326===t.spatialReference.wkid||console.warn("i3s has a spatialReference other than 4326.",t.spatialReference),t.spatialReference&&4490===t.spatialReference.wkid&&(console.warn("i3s spatialReference is 4490,auto set spatialReference to 4326,This may cause some location issues, please ensure that your service is 4326"),t.spatialReference.wkid=4326),o.projection=t.spatialReference,function(t,e,n,i,o,s,a){if(!s.layerScene){s.layerScene=e,s.nodesPerPage=e.nodePages&&e.nodePages.nodesPerPage||64,s.lodSelectionMetricType=e.nodePages&&e.nodePages.lodSelectionMetricType;let t=o;if(s.layerScene.eslpk=t.indexOf("3dSceneLayer.json")>=0,t.endsWith(".json")){const e=o.lastIndexOf("/");t=e<0?"./":o.substring(0,e)}s.layerScene.baseUrl=function(t){return t.split("?")[0]}(t)}return new Mr(o,n,s,t,a).load()}(this.layer,t,i,0,n,o,this.te).then((t=>{this.onTilesetLoad(t,e,n)}))}pick(t,e,n){if(!this.painter)return[];const i=this.pickingFBO,{width:o,height:s}=this.canvas;return!this.pickingFBO||i.width===o&&i.height===s||i.resize(o,s),this.painter.pick(t,e,n&&n.tolerance)}highlight(t){if(this.J||(this.J=[]),Array.isArray(t))for(let e=0;e<t.length;e++){const n=t[e].service||0;let i=this.J[n];i||(i=this.J[n]=new Map),i.set(t[e].id,t[e])}else{const e=t.service||0;let n=this.J[e];n||(n=this.J[e]=new Map),n.set(t.id,t)}this.painter.highlight(this.J)}cancelHighlight(t,e){if(!this.J)return;const n=this.J[t];if(n){if(Array.isArray(e))for(let t=0;t<e.length;t++)n.delete(e[t]);else n.delete(e);n.size||(this.J[t]=null),this.painter.highlight(this.J)}}cancelAllHighlight(){delete this.J,this.painter.cancelAllHighlight()}showOnly(t){if(this.Z||(this.Z=[]),Array.isArray(t))for(let e=0;e<t.length;e++){const n=t[e].service||0;let i=this.Z[n];i||(i=this.Z[n]=new Map),i.set(t[e].id,t[e])}else{const e=t.service||0;let n=this.Z[e];n||(n=this.Z[e]=new Map),n.set(t.id,t)}this.painter.showOnly(this.Z)}cancelShowOnly(){delete this.Z,this.painter.cancelShowOnly()}Wt(){return this.painter?this.painter.Wt():[]}fe(t,e){const n=this.getMap();if("identity"===n.getProjection().code.toLowerCase()){const n=this.$e();return iq.set(e[0],e[1]),n.unproject(iq,rq),t[0]=rq.x,t[1]=rq.y,t}return iq.set(e[0],e[1]),n.getProjection().unproject(iq,rq),t[0]=rq.x,t[1]=rq.y,t}Ve(t,e){const n=this.$e();return iq.set(e[0],e[1]),n.project(iq,rq),t[0]=rq.x,t[1]=rq.y,t}Je(t,e){const n=this.$e();return iq.set(e[0],e[1]),n.unproject(iq,rq),t[0]=rq.x,t[1]=rq.y,t}$e(){const t=this.getMap().options.spatialReference.coordType;if(!t)throw new Error("Missing coordType in map spatialReference.");return this.Ye||(this.Ye=sf.getProjectionInstance(t)),this.Ye}}function hq(t,e){return t.ft-e.ft}function cq(t,e,n){return t[0]=e[n],t[1]=e[n+3],t[2]=e[n+6],t}const uq=[],fq=[],dq=[],gq=[],pq=[],Aq=2*Math.PI;class Xr{constructor(t,e,n,i){this.west=t,this.south=e,this.east=n,this.north=i}static contains(t,e){let n=e[0];const i=e[1],o=t.west;let s=t.east;return s<o&&(s+=Aq,n<0&&(n+=Aq)),(n>o||XV(n,o,1e-14))&&(n<s||XV(n,s,1e-14))&&i>=t.south&&i<=t.north}static southwest(t,e){return e[0]=t.west,e[1]=t.south,e[2]=0,e}static northeast(t,e){return e[0]=t.east,e[1]=t.north,e[2]=0,e}static southeast(t,e){return e[0]=t.east,e[1]=t.south,e[2]=0,e}static northwest(t,e){return e[0]=t.west,e[1]=t.north,e[2]=0,e}}const mq=[0,0,1];function yq(t,e){return RV(e,t[0],t[1],t[2])}class ts{constructor(t,e){this.normal=Dy([],t),this.distance=e}static fromPointNormal(t,e,n){const i=-qy(e,t);return Dy(n.normal,e),n.distance=i,n}}const _q=[],vq=[],xq=[],bq=[],wq=[],Tq=[],Mq=[],Cq=[],Sq=[],Pq=[],Iq=new ts([1,0,0],0),Oq=[];class ds{constructor(t){this.southwestCornerCartesian=[],this.northeastCornerCartesian=[],this.westNormal=[],this.eastNormal=[],this.southNormal=[],this.northNormal=[],this.rectangle=new Xr(...t),this.minimumHeight=t[4],this.maximumHeight=t[5],this.computeBox(this.rectangle)}distanceToCamera(t,e){let n=0;if(!Xr.contains(this.rectangle,e)){const e=this.northeastCornerCartesian,i=this.westNormal,o=this.southNormal,s=this.eastNormal,a=this.northNormal,l=Hy(Oq,t,this.southwestCornerCartesian),h=qy(l,i),c=qy(l,o),u=Hy(Oq,t,e),f=qy(u,s),g=qy(u,a);h>0?n+=h*h:f>0&&(n+=f*f),c>0?n+=c*c:g>0&&(n+=g*g)}const i=e[2],o=this.minimumHeight,s=this.maximumHeight;if(i>s){const t=i-s;n+=t*t}else if(i<o){const t=o-i;n+=t*t}return Math.sqrt(n)}computeBox(t){const e=this;yq(Xr.southwest(t,vq),e.southwestCornerCartesian),yq(Xr.northeast(t,vq),e.northeastCornerCartesian),_q[0]=t.west,_q[1]=.5*(t.south+t.north),_q[2]=0;const n=yq(_q,xq),i=Xy(wq,n,mq);Zy(e.westNormal,i),_q[0]=t.east;const o=yq(_q,Cq),s=Xy(wq,mq,o);Zy(e.eastNormal,s);const a=Hy(wq,n,o),l=Zy(bq,a),h=t.south;let c;if(h>0){_q[0]=.5*(t.west+t.east),_q[1]=h;const n=yq(_q,Sq);Dy(Pq,l);const i=ts.fromPointNormal(e.southwestCornerCartesian,e.westNormal,Iq);Eq(Sq,Pq,i,e.southwestCornerCartesian),c=WV(n,Tq)}else c=ZV(Xr.southeast(t,vq),Tq);const u=Xy(Mq,c,a);Zy(e.southNormal,u);const f=t.north;let g;if(f<0){_q[0]=.5*(t.west+t.east),_q[1]=f;const n=yq(_q,Sq);Gy(Pq,l,-1);const i=ts.fromPointNormal(e.northeastCornerCartesian,e.eastNormal,Iq);Eq(Sq,Pq,i,e.northeastCornerCartesian),g=WV(n,Tq)}else g=ZV(Xr.northwest(t,vq),Tq);const A=Xy(Mq,a,g);Zy(e.northNormal,A)}}function Eq(t,e,n,i){const o=t,s=e,a=n.normal,l=qy(a,s);if(Math.abs(l)<1e-15)return;const h=(-n.distance-qy(a,o))/l;return h<0?void 0:Ny(i=Gy(i,s,h),o,i)}function kq(t){return[t.xmin,t.ymin,t.xmax,t.ymax]}const Rq=Ds,Lq={services:[],maxGPUMemory:Gt.mobile?32:1536,retireInterval:2e3,loadingLimitOnInteracting:5,loadingLimit:10,debug:!1,meshLimitPerFrame:1,i3sNodepageLimitPerFrame:1,enableI3SCompressedGeometry:!0,forceI3SCompressedGeometry:!0,onlyCacheNoContentTileWhenError:!0,picking:!0,pickingPoint:!0,geometryEvents:!1,alwaysShowTopTiles:!0,antialias:!1,offset:[0,0],renderer:"gl",forceRenderOnZooming:!0,forceRenderOnRotating:!0,forceRenderOnMoving:!0,optionalExtensions:["ANGLE_instanced_arrays","OES_element_index_uint","OES_standard_derivatives","OES_vertex_array_object","OES_texture_half_float","OES_texture_half_float_linear","OES_texture_float","OES_texture_float_linear","WEBGL_depth_texture","EXT_shader_texture_lod","WEBGL_compressed_texture_astc","WEBGL_compressed_texture_etc","WEBGL_compressed_texture_etc1","WEBGL_compressed_texture_pvrtc","WEBGL_compressed_texture_s3tc","WEBGL_compressed_texture_s3tc_srgb"]},Dq=[0,0,0],Fq=[0,0,0],Nq=[0,0,0],Hq=[0,0,0],Bq=[0,0,0],zq=[0,0,0],Gq=[0,0,0],jq=[1,1,1],Uq=[1,1,1],Vq=[0,0,0,0],Wq=[],Zq=new gh(0,0),qq=new _e(0,0),Xq=[0,0,0,0,0,0,0,0,0],Jq=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],Qq=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],Yq=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],Kq=new _e(0,0),$q=ay([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),tX=[0,0],eX=[0,0,0],nX=[1,1,1],iX=[0,0,0],rX=[0,0,0],oX=[0,0,0,0],sX=[1,1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1];class qs extends(aO(Pf)){static fromJSON(t){return t&&"Geo3DTilesLayer"===t.type?new qs(t.id,t.options):null}static getEnuTransform(t,e=[1,1,1],n=[0,0,0]){const i=RV([],t[0]*Math.PI/180,t[1]*Math.PI/180,t[2]||0),o=_W(i,null,[]),s=xy([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],Q_([0,0,0,0],...n),[0,0,0],e);return cy(s,o,s)}constructor(t,e){super(t,e),this.isGeo3DTilesLayer=!0,this.Ze(),this.Ke=[]}Ze(){const t=this.options.services.map((t=>t.url));this.Xe=this.Xe||{},this.Pe=this.Pe||[];for(let e=0;e<t.length;e++){const n=t[e];let i=this.Xe[n];void 0===i&&(i=this.Xe[n]=this.Pe.length),this.Pe[i]=hX(n,i,this.options.services[e])}this.fire("rootready",{roots:this.Pe.slice(0)})}showService(t){return this.updateService(t,{visible:!0}),this}hideService(t){return this.updateService(t,{visible:!1}),this}setToRedraw(){return this.We(),this}addService(t){return this.options.services=this.options.services||[],this.options.services.push(t),this.Ze(),this.We(),this}updateService(t,e){if(!e)return this;const n=this.options.services;let i=!1;n&&n[t]&&(i=!(fX(n[t].coordOffset,e.coordOffset)&&fX(n[t].heightOffset,e.heightOffset)&&fX(n[t].scale,e.scale)&&fX(n[t].rotation,e.rotation)),UU(n[t],e));const o=this.Pe&&this.Pe[this.Xe[n[t].url]];return o&&(jU(e.visible)||(o.visible=e.visible),i&&o.version++),this.We(),this}removeService(t){const e=this.options.services;if(e&&e[t]){const n=e[t].url,i=this.Xe[n];this.Pe[i]&&(this.Pe[i]=null),delete this.Xe[n],e.splice(t,1)}return this.We(),this}getTileUrl(t,e){const n=e&&e.service&&e.service.subdomains;if(n&&e.domainKey){const i=n.length;if(i){const o=[...t].reduce(((t,e)=>t+e.charCodeAt(0)),0)%i;return t.replace(e.domainKey,n[o])}}return t}getExtent(t){if(!t&&0!==t){const t=new Ph;for(let e=0;e<this.Pe.length;e++){const n=this.Pe[e];if(n&&n.boundingVolume){const e=this.boundingVolumeToExtent(n);t._combine(e)}}return t}const e=this.Pe[t];return e&&e.boundingVolume?this.boundingVolumeToExtent(e):null}boundingVolumeToExtent(t){const e=t.boundingVolume.Qe?$q:t.matrix,n=this.getMap(),i="identity"===n.getProjection().code.toLowerCase(),o=this.getRenderer();if(t.boundingVolume.region){const e=t.boundingVolume.region;return new Ph(XU(e[0]),XU(e[1]),XU(e[2]),XU(e[3]))}if(t.boundingVolume.sphere){const s=t.boundingVolume.sphere,a=BV([],Jy([0,0,0],s,e));i&&o.Ve(a,a);const l=s[3],h=n.locate(a,-l,l),c=n.locate(a,l,-l);return new Ph(h,c)}if(t.boundingVolume.box){const s=t.boundingVolume.box,a=Jy([0,0,0],s,e),l=new gh(BV([],a));i&&o.Ve(l,l);const h=s.slice(3);ty(h,Qm([0,0,0,0,0,0,0,0,0],t.matrix),h);const c=Ry(h.slice(0,3)),u=Ry(h.slice(3,6)),f=Ry(h.slice(6,9)),g=Math.max(c,u,f),A=n.locate(l,-g,g),m=n.locate(l,g,-g);return new Ph(A,m)}return null}getRootTiles(){return this.Pe}getTiles(){const t=this.getRenderer();if(!t.ready)return this.We(),{tiles:Wq};const e=this.getMap(),n=e.cameraPosition,i=e.pointAtResToDistance(n[2],0,e.getGLRes()),o=this.tn(n);this.nn=this.nn||[0,0,0],Fy(this.nn,qU(o.x),qU(o.y),i),this.rn=RV(this.rn||[],this.nn[0],this.nn[1],this.nn[2]),this.sn=2*Math.tan(.5*qU(e.getFov()));const s=e.projViewMatrix;let a;if(e.getPitch()<=80){const t=e.getExtent(),n=t.getWidth()/2,i=t.getHeight()/2;t.xmin-=n,t.ymin-=i,t.xmax+=n,t.ymax+=i,a=kq(t)}const l=(this.getMasks()||[]).filter((t=>t&&t instanceof ClipOutsideMask));l.forEach((t=>{if(!t.maskGeoJSON&&t.toGeoJSON)try{t.maskGeoJSON=t.toGeoJSON();const e=t.getExtent();t.maskGeoJSON.bbox=kq(e)}catch(t){console.error(t)}}));const h={children:[],level:-1};let c=h;const u=[];for(let e=0;e<this.Pe.length;e++){const n=this.Pe[e];if(!n||!n.visible)continue;const i=n.service,o=[n],h=this.an(e);for(;o.length>0;){const e=o.pop();for(e.id||this.cn(e);c.level>=e.ke;)c=c.parent;const n=this.ln(e,h,s,a,l);if(e.service=i,!(n===dX.VISIBLE||n!==dX.OUT_OF_FRUSTUM&&this.options.alwaysShowTopTiles&&uX(e))){let t=c;for(;t&&!t.content;)t=t.parent;n===dX.SCREEN_ERROR_TOO_SMALL&&t&&t.content&&this.hn(u,t);continue}e.ft<1/0&&this.un(e);const f=this.Ne(e,c);c.children.push(f);const g=e.children,A=g&&g.length,m=f.content;if(m&&(!A||n===dX.SCREEN_ERROR_TOO_SMALL)&&this.hn(u,f),n!==dX.SCREEN_ERROR_TOO_SMALL&&A){m&&"add"===e.refine&&this.hn(u,f),c=f;const n=g[0].parent;let i=!1;for(let s=0,a=g.length;s<a;s++){if(n){const e=t.getCachedTile(g[s].id);if(e&&e.error&&404!==e.error.status)continue;i=!0}else{i=!0,g[s].parent=e,g[s].xt=e.xt,g[s].baseUrl=e.baseUrl;const t=g[s].content&&(g[s].content.url||g[s].content.uri);t&&(nV(t)||t.indexOf("i3s:")>=0?g[s].baseUrl=e.baseUrl:lV(t)?g[s].content.url=e.baseUrl+t:g[s].baseUrl=t.substring(0,t.lastIndexOf("/")+1))}o.push(g[s])}!i&&m&&this.hn(u,f)}}}return{root:h,tiles:u}}hn(t,e){const{viewerRequestVolume:n,matrix:i}=e.node;n&&!function(t,e,n,i){if(n.region){const e=n.region;if(t[0]>=e[0]&&t[0]<=e[2]&&t[1]>=e[1]&&t[1]<=e[3])return!0}else{if(n.sphere)return aX(n,e,i)<=0;if(n.box)return 0===lX(n,e,i)}return!1}(this.nn,this.rn,n,i)||t.push(e)}Ne(t,e){return{id:t.id,node:t,children:[],level:t.ke,parent:e,content:t.content&&t.content.url}}cn(t){const e=this.getId();t.id=e+":"+hs.GUID(),t.matrix=t.transform||ay([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),t.dn=this.mn(t),t.parent&&(function(t){return t.content&&t.content.uri&&t.content.uri.indexOf("i3s:")>=0}(t)||(t.matrix=cy(t.matrix,t.parent.matrix,t.matrix)),t.H=t.parent.H,void 0===t.ke&&(t.ke=t.parent.ke+1),t.maxExtent=t.parent.maxExtent),t.refine=t.refine&&t.refine.toLowerCase()||"replace",t.content&&!t.content.url&&t.content.uri&&(t.content.url=t.content.uri)}j(t){return this.Pe[t].service}pn(t){const e=t.boundingVolume;if(!e||e.Qe&&!this.bn(t))return;const n=this.j(t.H),i=n.heightOffset||0,o=this.options.offset,s=VU(o)||o[0]||o[1],a=n.coordOffset||tX;if(!Array.isArray(a))throw new Error("service.coordOffset must be an array");if(!e.Qe&&(!t.boundingVolume||!i&&Iy(t.matrix,$q)&&!s&&a===tX))return;e.box&&e.region&&delete e.region;const{region:l,box:h,sphere:c}=e;if(e.coordOffset=[a[0],a[1]],e.heightOffset=i,l){e.originalVolume||(e.originalVolume=l.slice(0));const t=e.originalVolume,n=this.yn([XU(t[0]),XU(t[1])]);l[0]=qU(n.x+a[0]),l[1]=qU(n.y+a[1]);const o=this.yn([XU(t[2]),XU(t[3])]);l[2]=qU(o.x+a[0]),l[3]=qU(o.y+a[1]),l[4]=t[4]+i+(a[2]||0),l[5]=t[5]+i+(a[2]||0)}else if(h||c){e.originalVolume||(e.originalVolume=(h||c).slice(0));const n=h||c,o=Jy(Dq,e.originalVolume,t.matrix),s=BV(Fq,o),l=this.yn([s[0]+a[0],s[1]+a[1]]);s[0]=l.x,s[1]=l.y,s[2]+=i+(a[2]||0),RV(n,qU(s[0]),qU(s[1]),s[2])}e.Qe=!0;try{t.extent=this.boundingVolumeToExtent(t)}catch(t){console.error(t)}}bn(t){const e=t.boundingVolume,n=this.j(t.H),i=n.coordOffset||tX;return e.coordOffset[0]!==i[0]||e.coordOffset[1]!==i[1]||e.heightOffset!==(n.heightOffset||0)}mn(t){return void 0===t.geometricError||!t.boundingVolume}un(t){let e=t.parent;for(;e&&e.dn&&!(e.ft<=t.ft);)e.ft=t.ft,e=t.parent}onTileLoad(t,e){if(t.children&&(!e.children||!e.children.length)){e.children=t.children;const n=e.content.url;e.baseUrl=n.substring(0,n.lastIndexOf("/")+1),this.We()}}onTilesetLoad(t,e,n){if(!t)return void console.warn("invalid tileset at : "+n);const i=(t.asset&&t.asset.gltfUpAxis||e&&e.xt||"Y").toUpperCase();t.root.baseUrl=n.substring(0,n.lastIndexOf("/")+1);const o=n.indexOf("realspace/")>-1;0===e.ke&&t.asset&&t.asset.s3mType&&o&&(t.root.baseUrl+="data/path/");const s=t.asset.i3s;if(t.root.xt=i,e){const n=e.boundingVolume,i=e.gn;i&&delete e.gn,UU(e,t.root),e.refine=e.refine&&e.refine.toLowerCase()||"replace",n&&(e.boundingVolume=n);let o=t.root.transform;if(i){const t=this.j(e.H);t.ecefTransform&&(o=cy([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t.ecefTransform,o||$q))}o&&(e.parent?s||(e.matrix=cy([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e.parent.matrix,o)):e.matrix=cy([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e.matrix,o)),delete e.content,t.root.content&&(e.content=t.root.content),e.dn=this.mn(e);const a=e.content&&(e.content.url||e.content.uri);a&&e.content.uri&&(e.content.url=e.content.uri,delete e.content.uri),!s&&a&&!nV(a)&&lV(a)&&(e.content.url=e.baseUrl+a),t.root&&!e.parent&&this.wn(e)}this.We(),this.fire("loadtileset",{tileset:t,index:e&&e.H,url:n})}vn(t,e,n){if(!t.extent||!Rq)return!0;const i=t.extent;if(oX[0]=i.xmin,oX[1]=i.ymin,oX[2]=i.xmax,oX[3]=i.ymax,e&&!Rq.bboxIntersect(oX,e))return!1;if(n.length){for(let t=0,e=n.length;t<e;t++){const e=n[t].maskGeoJSON;if(!e||!e.bbox||Rq.bboxInMask(oX,e))return!0}return!1}return!0}ln(t,e,n,i,o){if(!this.vn(t,i,o))return dX.OUT_OF_FRUSTUM;if(t.ft=1/0,0===t.ke||t.dn)return this.wn(t),dX.VISIBLE;if(this.pn(t),!this.Tn(t,e,n))return dX.OUT_OF_FRUSTUM;if(0===t.geometricError)return dX.VISIBLE;let s=this.j(t.H).maximumScreenSpaceError;null==s&&(s=16);let a=this._n(t);return 0===a&&t.parent&&(a=.5*(t.parent.Mn||0)),a>=s?dX.VISIBLE:dX.SCREEN_ERROR_TOO_SMALL}Kt(t,e){e||(e=new _e(0,0));const n=this.getMap();return n.coordToPointAtRes(t,n.getGLRes(),e)}Tn(t,e,n){const i=t.id;let o=this.Ke[i];const{boundingVolume:s}=t,a=s.region,l=s.box,h=s.sphere,c=this.On(t.H),u=this.getRenderer();return o&&o.version===c.version||(a?o=this.Ke[i]=this.An(t):l?o=this.Ke[i]=this.xn(t):h&&(o=this.Ke[i]=this.In(t)),o.version=c.version,t.dt&&(u.Ft(t.dt),delete t.dt)),this.j(t.H).debug&&(this.Ke[i].node=t,u.Gt(t)),o.obbox?function(t,e,n){Jj(t);for(var i=0;i<6;i++)if(!Xj(Dj[i],e))return!1;return!0}(n,o.obbox):!!h&&function(t,e,n){Jj(t);for(var i=e[0],o=-e[1],s=0;s<6;s++)if(Yj(Dj[s],i)<o)return!1;return!0}(n,o.sphereBox)}An(t){const e=this.getMap(),n=e.getGLRes(),i=t.boundingVolume.region;let{ws:o,en:s}=function(t){const e=t[2],n=t[3],i=t[5],o=RV([],t[0],t[1],t[4]),s=RV([],e,n,i);return{ws:BV(o,o),en:BV(s,s)}}(i);o=new gh(o),s=new gh(s);const a=e.coordToPointAtRes(o,n);a.z=e.altitudeToPoint(o.z,n);const l=e.coordToPointAtRes(s,n);l.z=e.altitudeToPoint(s.z,n);const h=[l.x,a.y,l.z,l.x,l.y,l.z,a.x,l.y,l.z,a.x,a.y,l.z,l.x,a.y,a.z,l.x,l.y,a.z,a.x,l.y,a.z,a.x,a.y,a.z],c=[(h[0]+h[18])/2,(h[1]+h[19])/2,(h[2]+h[20])/2],u=this.On(t.H);t!==u||u.Sn||(u.Sn=c);const f=this.Jt([],t),g=Iy($q,f);if(!g){Jy(c,c,f);const t=Dq;for(let e=0;e<h.length;e+=3){let n=Fy(t,h[e],h[e+1],h[e+2]);g||(n=Jy(n,n,f)),h[e]=n[0],h[e+1]=n[1],h[e+2]=n[2]}}const A=e.pointAtResToCoord(new _e(c),n);A.z=(o.z+s.z)/2;const m=this.Cn(h,c);for(let t=0;t<h.length;t++)h[t]-=c[t%3];return{obbox:m,boxPosition:h,boxCenter:c,boxCoord:A}}xn(t){const e=this.getRenderer(),n=this.getMap(),i="identity"===n.getProjection().code.toLowerCase(),o=n.getGLRes(),{boxCenter:s,boxCoord:a}=this.kn(t),l=t.boundingVolume.box,h=function(t,e,n,i,o,s,a,l,h,c,u,f,g,A,m,w,T){return t[0]=e||0,t[1]=s||0,t[2]=c||0,t[3]=0,t[4]=n||0,t[5]=a||0,t[6]=u||0,t[7]=0,t[8]=i||0,t[9]=l||0,t[10]=f||0,t[11]=0,t[12]=o||0,t[13]=h||0,t[14]=g||0,t[15]=1,t}([],(c=this.Nn(l,t.matrix))[0],c[3],c[6],(u=l)[0],c[1],c[4],c[7],u[1],c[2],c[5],c[8],u[2]);var c,u;const f=this.Jt([],t),g=Iy($q,f);g||Jy(s,s,f);const A=[],m=Dq;for(let t=0;t<sX.length;t+=3){m[0]=sX[t],m[1]=sX[t+1],m[2]=sX[t+2],Jy(m,m,h),BV(m,m),i&&e.Ve(m,m);const s=Zq.set(m[0],m[1],m[2]);n.coordToPointAtRes(s,o,qq);let a=Fy(m,qq.x,qq.y,n.altitudeToPoint(s.z,o));g||(a=Jy(a,a,f)),A[t]=a[0],A[t+1]=a[1],A[t+2]=a[2]}const w=this.Cn(A,s);for(let t=0;t<A.length;t++)A[t]-=s[t%3];return{obbox:w,boxPosition:A,boxCenter:s,boxCoord:a}}In(t){const e=this.getMap(),n=this.getRenderer(),i="identity"===e.getProjection().code.toLowerCase(),o=t.boundingVolume.sphere;let s=Dq;0===o[0]&&0===o[1]&&0===o[2]?s=[0,0,-6378137]:BV(s,o),i&&n.Ve(s,s);const a=new gh(s),l=this.Kt(a,qq).toArray();l[2]=e.altitudeToPoint(a.z,e.getGLRes());const h=this.Ln(a);return{boxCenter:l,boxCoord:a,sphereBox:[l,o[3]*h[2]]}}Cn(t,e){const n=cX(Bq,t,0,1,4,5),i=cX(zq,t,0,3,4,7),o=cX(Gq,t,0,1,2,3);return[...e,...e_(Dq,n,e),...e_(Fq,i,e),...e_(Nq,o,e)]}kn(t){const e=this.getMap(),n=this.getRenderer(),i="identity"===e.getProjection().code.toLowerCase(),o=e.getGLRes(),s=t.boundingVolume.box.slice(0,3);BV(s,s),i&&n.Ve(s,s);const a=new gh(s),l=e.coordToPointAtRes(a,o);return{boxCenter:[l.x,l.y,e.altitudeToPoint(a.z,o)],boxCoord:a}}Jt(t,e){const n=this.On(e.H),i=this.j(e.H),o=n.Sn,s=gy(Jq,Fy(Dq,-o[0],-o[1],-o[2])),a=gy(Qq,o),l=Q_(Vq,...i.rotation||eX),h=i.scale;let c;c=Array.isArray(h)?Fy(iX,h[0],h[1],h[2]):h&&Fy(iX,h,h,h)||nX;return t=cy(t,xy(Yq,l,rX,c),s),cy(t,a,t)}wn(t){const e=this.j(t.H);if(!t.boundingVolume||this.En(t,e))return;const n=t.boundingVolume.region,i=t.boundingVolume.sphere;let o=null;t.boundingVolume.box?o=this.Rn(t).boxCenter:n?o=this.Pn(t).boxCenter:i&&(o=this.In(t).boxCenter);const s=e.heightOffset||0,a=e.coordOffset||[0,0];t.Un=[a[0]||0,a[1]||0],t.Bn=s,t.Sn=o}En(t,e){if(!t.Un)return!1;const n=e.coordOffset||tX;return t.Un[0]===n[0]&&t.Un[1]===n[1]&&t.Bn===(e.heightOffset||0)}Pn(t){return this.pn(t),this.An(t)}Rn(t){return this.pn(t),this.kn(t)}Nn(t,e){let n=t.slice(3,12);return n=ty(n,Qm(Xq,e),n),n}Ln(t){const e=this.getMap(),n=e.distanceToPointAtRes(100,100,e.getGLRes(),t);let i;return i=e.altitudeToPoint?e.altitudeToPoint(100,e.getGLRes())/100:n.y/100,Fy(jq,n.x/100*1.01,n.y/100*1.01,i),jq}yn(t){Array.isArray(t)&&(t=new gh(t));let e=this.options.offset;if(VU(e)&&(e=e.call(this,Array.isArray(t)?new gh(t):t)),e[0]||e[1]){const n=this.getMap(),i=n.getGLRes(),o=n.coordToPointAtRes(t,i);return qq.set(e[0],e[1]),o._sub(qq),n.pointAtResToCoord(o,i)}return t}On(t){return this.Pe[t]}an(t){const e=this.j(t).maxExtent;if(!e)return null;const n=this.Pe[t];return n.maxExtent||(n.maxExtent=new Ph(e).convertTo((t=>this.Kt(t)))),n.maxExtent}_n(t){const e=this.sn,n=t.geometricError;if(0===n)return t.Mn=0,0;const i=this.j(t.H);let o=i.scale||1;if(Array.isArray(o)&&(o=Ry(o)),i.ecefTransform){const t=_y(Uq,i.ecefTransform);o*=s_(t)}const s=this.getMap();let a;t.boundingVolume.region?a=function(t,e,n){return t.Gn||(t.Gn=new ds(t.boundingVolume.region)),t.Gn.distanceToCamera(e,n)}(t,this.rn,this.nn):t.boundingVolume.sphere?a=aX(t.boundingVolume,this.rn):t.boundingVolume.box&&(a=lX(t.boundingVolume,this.rn));const l=Math.max(Math.abs(a),1e-7),h=n*o*s.height/(l*e);return t.ft=a,t.Mn=h,h}We(){const t=this.getRenderer();t&&t.setToRedraw()}Dt(t){return this.Ke[t]}identify(t,e={}){const n=this.getMap(),i=this.getRenderer();if(!n||!i)return[];Array.isArray(t)&&(t=new gh(t));const o=n.coordToContainerPoint(t);return this.identifyAtPoint(o,e)}identifyAtPoint(t,e={}){const n=[];if(!e.excludeMasks){const i=this.identifyMask(t,e);i&&i.length&&rV(n,i)}const i=this.getMap(),o=this.getRenderer();if(!i||!o)return[];const s=i.getDevicePixelRatio();return rV(n,o.pick(t.x*s,t.y*s,e)),e&&e.filter&&!e.excludeMasks?n.filter((t=>e.filter(t))):n}getCurrentBatchIDs(){const t=this.getMap(),e=this.getRenderer();return t&&e?e.Wt():[]}highlight(t){const e=this.getRenderer();return Array.isArray(t)||(t=[t]),e?(e.highlight(t),this):(this.J||(this.J=[]),this.J.push(t),this)}ze(){if(this.J){for(let t=0;t<this.J.length;t++)this.highlight(this.J[t]);delete this.J}}cancelHighlight(t,e){const n=this.getRenderer();return n?(n.cancelHighlight(t,e),this):this}cancelAllHighlight(){const t=this.getRenderer();return t?(t.cancelAllHighlight(),this):this}showOnly(t){const e=this.getRenderer();return e?(e.showOnly(t),this):(this.Z||(this.Z=[]),this.Z.push(t),this)}Dn(){if(this.Z){for(let t=0;t<this.Z.length;t++)this.showOnly(this.Z[t]);delete this.Z}}cancelShowOnly(t){const e=this.getRenderer();return e?(e.cancelShowOnly(t),this):this}setServiceOpacity(t,e){const n=this.options.services[t];return n&&(n.opacity=e),this.getRenderer()?(this.We(),this):this}setServiceDebug(t,e){const n=this.options.services[t];return n&&(n.debug=e),this.getRenderer()?(this.We(),this):this}tn(t){const e=this.getMap(),n=e.getGLRes();Kq.set(t[0],t[1]);const i=e.pointAtResToCoord(Kq,n);return"identity"===e.getProjection().code.toLowerCase()?(Fq[0]=i.x,Fq[1]=i.y,this.getRenderer().Je(Dq,Fq),i.set(Dq[0],Dq[1]),i):i}toJSON(){return{type:this.getJSONType(),id:this.getId(),options:this.config()}}}function aX(t,e,n){let i=t.sphere;n&&(i=Jy([0,0,0],i,n));const o=r_(i,e),s=t.sphere[3];return o<s?0:o-s}function lX(t,e,n){const i=t.box;let o=Fy(Dq,i[0],i[1],i[2]);return n&&(o=Jy([0,0,0],o,n)),function(t,e,n){return Math.sqrt(function(t,e,n){const i=Hy(uq,n,t),o=cq(fq,e,0),s=cq(dq,e,1),a=cq(gq,e,2),l=s_(o),h=s_(s),c=s_(a);Zy(o,o),Zy(s,s),Zy(a,a);const u=pq;u[0]=qy(i,o),u[1]=qy(i,s),u[2]=qy(i,a);let f,g=0;return u[0]<-l?(f=u[0]+l,g+=f*f):u[0]>l&&(f=u[0]-l,g+=f*f),u[1]<-h?(f=u[1]+h,g+=f*f):u[1]>h&&(f=u[1]-h,g+=f*f),u[2]<-c?(f=u[2]+c,g+=f*f):u[2]>c&&(f=u[2]-c,g+=f*f),g}(t,e,n))}(o,Ym(Xq,i[3],i[4],i[5],i[6],i[7],i[8],i[9],i[10],i[11]),e)}function hX(t,e,n){const i=(t=JU(t)).indexOf("{s}")>=0?"{s}":t.indexOf("%7Bs%7D")>=0?"%7Bs%7D":null;return{version:0,dn:!0,service:n,visible:!!jU(n.visible)||n.visible,baseUrl:t.substring(0,t.lastIndexOf("/"))+"/",content:{url:t},refine:"replace",matrix:ay([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),H:e,ke:0,gn:!0,domainKey:i}}function cX(t,e,n,i,o,s){const a=Fy(Dq,e[3*n],e[3*n+1],e[3*n+2]),l=Fy(Fq,e[3*i],e[3*i+1],e[3*i+2]),h=Fy(Nq,e[3*o],e[3*o+1],e[3*o+2]),c=Fy(Hq,e[3*s],e[3*s+1],e[3*s+2]);return t[0]=(a[0]+l[0]+h[0]+c[0])/4,t[1]=(a[1]+l[1]+h[1]+c[1])/4,t[2]=(a[2]+l[2]+h[2]+c[2])/4,t}function uX(t){if(!t.content||t.hasParentContent)return!1;let e=t.parent;if(e&&(e.content||e.hasParentContent))return t.hasParentContent||(t.hasParentContent=!0),!1;for(;e;){if(e.content||e.hasParentContent)return t.hasParentContent||(t.hasParentContent=!0),!1;e=e.parent}return!0}function fX(t,e){return Array.isArray(t)&&Array.isArray(e)?2===t.length?Uv(t,e):Ky(t,e):t===e}var dX;qs.mergeOptions(Lq),qs.registerRenderer("gl",jr),qs.registerJSONType("Geo3DTilesLayer"),function(t){t[t.OUT_OF_FRUSTUM=0]="OUT_OF_FRUSTUM",t[t.SCREEN_ERROR_TOO_SMALL=1]="SCREEN_ERROR_TOO_SMALL",t[t.VISIBLE=2]="VISIBLE"}(dX||(dX={}));let gX=null;function pX(){return gX||(gX={"image/crn":fV.crn&&fV.crn(),"image/ktx2":fV.ktx2&&fV.ktx2(),"image/cttf":fV.ktx2&&fV.ktx2(),draco:fV.draco&&fV.draco()}),gX}const{Ajax:AX,GLTFLoader:mX}=dV();class ni{constructor(t,e,n){this.Fn=t,this.jn=e||mX,this.Re=n,this.zn=pX()}static createEmptyB3DM(){return{featureTable:null,batchTable:null,gltf:{}}}load(t,e,n=0,i=0,o){return e?(i||(i=e.byteLength),this.Hn(t,e,n,i,o)):AX.getArrayBuffer(t,{}).then((e=>{const o=e.data;return i||(i=o.byteLength),this.Hn(t,o,n,i)}))}Hn(t,e,n,i,o){const s=o&&o.maxTextureSize,a=this.qn(e,n,i,t);if(a.error)return Promise.resolve(a);const l=t.substring(0,t.lastIndexOf("/"));let h;try{h=new this.jn(l,a.glb,{transferable:!0,requestImage:this.Fn,decoders:this.zn,supportedFormats:this.Re,maxTextureSize:s})}catch(t){return Promise.resolve({error:t})}return h.load({skipAttributeTransform:!1}).then((e=>{e.url=`${t}-${n}-${i}`;const o=h.transferables;for(let t=0;t<a.transferables.length;t++)o.indexOf(a.transferables[t])<0&&o.push(a.transferables[t]);return{magic:"b3dm",count:a.count,transferables:o,featureTable:a.featureTable,batchTable:a.batchTable,batchTableBin:a.batchTableBin,gltf:e}}))}qn(t,e,n,i){const o=new DataView(t,e,n),s=o.getUint32(4,!0);if(1!==s){const t="Unsupported b3dm version: "+s+", url:"+i;return console.warn(t),{error:t}}if(o.getUint32(8,!0)!==o.byteLength){const t="Length in b3dm header is inconsistent with b3dm's byte length, url: "+i;return console.warn(t),{error:t}}let a,l=o.getUint32(12,!0),h=o.getUint32(16,!0),c=o.getUint32(20,!0),u=o.getUint32(24,!0),f=28+e;c>=570425344?(f-=8,a=l,c=h,u=0,l=0,h=0):u>=570425344&&(f-=4,a=c,c=l,u=h,l=0,h=0);const g=[t];let A,m,w;if(l>0?(A=YV(t,f,l),f+=l,a=A.BATCH_LENGTH):A={BATCH_LENGTH:a},h>0&&(f+=h),c>0&&(m=KV(t,f,c),f+=c,u>0)){const e=$V(0,f,u);w=t.slice(e.offset,e.offset+e.byteLength),f+=u,g.push(w)}const T=A.BATCH_LENGTH,M={};if(A&&A.BATCH_ID){M.BATCH_ID=eW(A.BATCH_ID,t,(void 0).offset,T);const e=M.BATCH_ID.array&&M.BATCH_ID.array.buffer;e&&g.indexOf(e)<0&&g.push(e)}return{count:a,transferables:g,featureTable:A,batchTable:m,batchTableBin:w,b3dm:M,glb:{buffer:t,byteOffset:f,byteLength:o.byteLength+o.byteOffset-f}}}$n(){return null}}const{Ajax:yX,GLTFLoader:_X}=dV();class ii{constructor(t,e,n,i){this.Fn=t,this.jn=e||_X,this.Re=n,this.zn=pX(),this.Vn=i}load(t,e,n=0,i=0,o){return e?(i||(i=e.byteLength),this.Hn(t,e,n,i,o)):yX.getArrayBuffer(t,{}).then((e=>{const o=e.data;return i||(i=o.byteLength),this.Hn(t,o,n,i)}))}Hn(t,e,n,i,o){return this.Jn(t,e,n,i,o).then((({gltf:o,transferables:s})=>{const a=this.Yn(e,n,i,t);if(a.error)return Promise.resolve(a);for(let t=0;t<s.length;t++)-1===a.transferables.indexOf(s[t])&&a.transferables.push(s[t]);return delete o.transferables,Promise.resolve({magic:"i3dm",count:a.count,transferables:a.transferables,featureTable:a.featureTable,batchTable:a.batchTable,batchTableBin:a.batchTableBin,i3dm:a.i3dm,gltf:o})}))}Jn(t,e,n,i,o){const s={transferable:!0,requestImage:this.Fn,decoders:this.zn,supportedFormats:this.Re,maxTextureSize:o&&o.maxTextureSize},a=new DataView(e,n,i),l=32+a.getUint32(12,!0)+a.getUint32(16,!0)+a.getUint32(20,!0)+a.getUint32(24,!0);if(0===a.getUint32(28,!0)){let i=KU(new Uint8Array(e,l+n,a.byteLength-l));return-1==i.indexOf("://")&&(i=t.substring(0,t.lastIndexOf("/"))+"/"+i),i.indexOf(".glb")>0?yX.getArrayBuffer(i,{}).then((t=>this.Zn(i,{buffer:t.data,byteOffset:0},s))):yX.getJSON(i,{}).then((t=>this.Zn(i,t,s)))}return this.Zn(t,{buffer:e,byteOffset:l+n,byteLength:a.byteLength-l},s)}Zn(t,e,n){const i=t.substring(0,t.lastIndexOf("/")),o=new this.jn(i,e,n);return o.load({skipAttributeTransform:!0}).then((n=>{let i=0,s=0;return e.buffer&&(i=e.byteOffset||0,s=e.byteLength||0),n.url=`${t}-${i}-${s}`,{transferables:o.transferables,gltf:n}}))}Yn(t,e,n,i){const o=new DataView(t,e,n),s=o.getUint32(4,!0);if(1!==s){const t="Unsupported pnts version: "+s+", url:"+i;return console.warn(t),{error:t}}if(o.getUint32(8,!0)!==o.byteLength){const t="Length in pnts header is inconsistent with pnts's byte length, url: "+i;return console.warn(t),{error:t}}const a=[t],{featureTable:l,featureTableBin:h,batchTable:c,batchTableBin:u}=hW(o,32+e,a),f={},g=l.INSTANCES_LENGTH;if(l.POSITION){const{byteOffset:e}=l.POSITION;f.POSITION={byteStride:0,byteOffset:0,itemSize:3,count:g,componentType:5126,array:new Float32Array(t,e+h.offset,3*g).slice()},a.push(f.POSITION.array.buffer)}else if(l.POSITION_QUANTIZED){const e=l.QUANTIZED_VOLUME_OFFSET,n=l.QUANTIZED_VOLUME_SCALE,{byteOffset:i}=l.POSITION_QUANTIZED;f.POSITION={byteStride:12,byteOffset:0,itemSize:3,count:g,componentType:5126,array:this.Kn(new Uint16Array(t,i+h.offset,3*g),e,n)},a.push(f.POSITION.array.buffer)}if(l.BATCH_ID){f.BATCH_ID=eW(l.BATCH_ID,t,h.offset,g);const e=f.BATCH_ID.array&&f.BATCH_ID.array.buffer;e&&a.indexOf(e)<0&&a.push(e)}if(l.NORMAL_UP){let{byteOffset:e}=l.NORMAL_UP;f.NORMAL_UP={byteStride:0,byteOffset:0,itemSize:3,count:g,componentType:5126,array:new Float32Array(t,e+h.offset,3*g).slice()},a.push(f.NORMAL_UP.array.buffer),e=l.NORMAL_RIGHT.byteOffset,f.NORMAL_RIGHT={byteStride:0,byteOffset:0,itemSize:3,count:g,componentType:5126,array:new Float32Array(t,e+h.offset,3*g).slice()},a.push(f.NORMAL_RIGHT.array.buffer)}else if(l.NORMAL_UP_OCT32P){let{byteOffset:e}=l.NORMAL_UP_OCT32P;f.NORMAL_UP={byteStride:0,byteOffset:0,itemSize:3,count:g,componentType:5126,array:this.Xn(new Uint16Array(t,e+h.offset,2*g))},a.push(f.NORMAL_UP.array.buffer),e=l.NORMAL_RIGHT_OCT32P.byteOffset,f.NORMAL_RIGHT={byteStride:0,byteOffset:0,itemSize:3,count:g,componentType:5126,array:this.Xn(new Uint16Array(t,e+h.offset,2*g))},a.push(f.NORMAL_RIGHT.array.buffer)}if(l.SCALE){const{byteOffset:e}=l.SCALE;f.SCALE={byteStride:0,byteOffset:0,itemSize:1,count:g,componentType:5126,array:new Float32Array(t,e+h.offset,g).slice()},a.push(f.SCALE.array.buffer)}else if(l.SCALE_NON_UNIFORM){const{byteOffset:e}=l.SCALE_NON_UNIFORM;f.SCALE_NON_UNIFORM={byteStride:0,byteOffset:0,itemSize:3,count:g,componentType:5126,array:new Float32Array(t,e+h.offset,3*g).slice()},a.push(f.SCALE_NON_UNIFORM.array.buffer)}return{count:g,batchTable:c,batchTableBin:u,featureTable:l,i3dm:f,transferables:a}}Xn(t){const e=t.length/2,n=new Float32Array(3*e),i=[];for(let o=0;o<e;o++)vX(i,t[2*o],t[2*o+1],65535),n[3*o]=i[0],n[3*o+1]=i[1],n[3*o+2]=i[2];return n}Kn(t,e,n){return lW(new Float32Array(t.length),t,e,n)}$n(){return null}}function vX(t,e,n,i){if(t[0]=xX(e,i),t[1]=xX(n,i),t[2]=1-(Math.abs(t[0])+Math.abs(t[1])),t[2]<0){const e=t[0];t[0]=(1-Math.abs(t[1]))*bX(e),t[1]=(1-Math.abs(e))*bX(t[1])}return Zy(t,t)}function xX(t,e){return function(t,e,n){return t<0?0:t>n?n:t}(t,0,e=function(t,e){return null!=t?t:255}(e))/e*2-1}function bX(t){return t<0?-1:1}const{Ajax:wX}=dV();class hi{constructor(){}load(t,e,n=0,i=0){return e?(i||(i=e.byteLength),this.Hn(t,e,n,i)):wX.getArrayBuffer(t,{}).then((e=>{const o=e.data;return i||(i=o.byteLength),this.Hn(t,o,n,i)}))}Hn(t,e,n,i){return this.Wn(e,n,i,t).then((t=>t.error?t:{magic:"pnts",count:t.count,transferables:t.transferables,featureTable:t.featureTable,batchTable:t.batchTable,batchTableBin:t.batchTableBin,pnts:t.pnts}))}Wn(t,e,n,i){const o=new DataView(t,e,n),s=o.getUint32(4,!0);if(1!==s){const t="Unsupported pnts version: "+s+", url:"+i;return console.warn(t),{error:t}}if(o.getUint32(8,!0)!==o.byteLength){const t="Length in pnts header is inconsistent with pnts's byte length, url: "+i;return console.warn(t),{error:t}}const a=[t],{featureTable:l,featureTableBin:h,batchTable:c,batchTableBin:u}=hW(o,e+28,a),f=l.QUANTIZED_VOLUME_OFFSET,g=l.QUANTIZED_VOLUME_SCALE,A=l.POINTS_LENGTH;let m,w={};if(l.extensions&&l.extensions["3DTILES_draco_point_compression"]){w=l.extensions["3DTILES_draco_point_compression"],m=new DataView(t,w.byteOffset+h.offset,w.byteLength);const e={attributes:w.properties,useUniqueIDs:!1};return this.Qn||(this.Qn=pX().draco),this.Qn(m,e).then((e=>{const n=e.attributes;!l.POSITION&&!l.POSITION_QUANTIZED||n.POSITION||n.POSITION_QUANTIZED||(n.POSITION=l.POSITION,n.POSITION_QUANTIZED=l.POSITION_QUANTIZED),!(l.RGB||l.RGBA||l.RGB565)||n.RGB||n.RGBA||n.RGB565||(n.RGB=l.RGB,n.RGBA=l.RGBA,n.RGB565=l.RGB565),!l.NORMAL&&!l.NORMAL_OCT16P||n.NORMAL||n.NORMAL_OCT16P||(n.NORMAL=l.NORMAL,n.NORMAL_OCT16P=l.NORMAL_OCT16P);const i=this.tr(t,e.attributes,h.offset,A,a,f,g);if(e.attributes.BATCH_ID){const t=e.attributes.BATCH_ID.array;i.BATCH_ID={byteStride:0,byteOffset:0,itemSize:1,count:t.length,componentType:aW(t.constructor),array:t},a.push(t.buffer)}else if(l.BATCH_ID||Object.keys(c).length){i.BATCH_ID=l.BATCH_ID?eW(l.BATCH_ID,t,h.offset,A):TX(A);const e=i.BATCH_ID.array&&i.BATCH_ID.array.buffer;e&&a.indexOf(e)<0&&a.push(e)}return{count:A,batchTable:c,batchTableBin:u,featureTable:l,pnts:i,transferables:a}}))}const T=this.tr(t,l,h.offset,A,a,f,g);if(l.BATCH_ID||Object.keys(c).length){T.BATCH_ID=l.BATCH_ID?eW(l.BATCH_ID,t,h.offset,A):TX(A);const e=T.BATCH_ID.array&&T.BATCH_ID.array.buffer;e&&a.indexOf(e)<0&&a.push(e)}return Promise.resolve({count:A,batchTable:c,batchTableBin:u,featureTable:l,pnts:T,transferables:a})}tr(t,e,n,i,o,s,a){const l={};if(e.POSITION){let{byteOffset:s,array:a}=e.POSITION;s=s||0;const h=a?0:n;if(!a){const e=t.slice(s+h,s+h+3*i*4);a=new Float32Array(e)}l.POSITION={byteStride:0,byteOffset:0,itemSize:3,count:i,componentType:5126,array:a},o.push(a.buffer)}else if(e.POSITION_QUANTIZED){let{byteOffset:h}=e.POSITION_QUANTIZED;const{array:c}=e.POSITION_QUANTIZED;h=h||0;l.POSITION={byteStride:0,byteOffset:0,itemSize:3,count:i,componentType:5126,array:this.Kn(c||new Uint16Array(t,h+(c?0:n),3*i),s,a)},o.push(l.POSITION.array.buffer)}if(e.RGBA){let{byteOffset:s,array:a}=e.RGBA;s=s||0;const h=a?0:n;if(!a){const e=t.slice(s+h,s+h+4*i);a=new Uint8Array(e)}l.RGBA={byteStride:0,byteOffset:0,itemSize:4,count:i,componentType:5121,array:a},o.push(a.buffer)}else if(e.RGB){let{byteOffset:s,array:a}=e.RGB;s=s||0;const h=a?0:n;if(!a){const e=t.slice(s+h,s+h+3*i);a=new Uint8Array(e)}l.RGB={byteStride:0,byteOffset:0,itemSize:3,count:i,componentType:5121,array:a},o.push(a.buffer)}else if(e.RGB565){let{byteOffset:s,array:a}=e.RGB565;s=s||0;const h=a?0:n;if(!a){const e=t.slice(s+h,s+h+2*i);a=new Uint16Array(e)}l.RGB565={byteStride:0,byteOffset:0,itemSize:1,count:i,componentType:5123,array:a},o.push(a.buffer)}if(e.NORMAL){let{byteOffset:s,array:a}=e.NORMAL;s=s||0;const h=a?0:n;if(!a){const e=t.slice(s+h,s+h+3*i*4);a=new Float32Array(e)}l.NORMAL={byteStride:0,byteOffset:0,itemSize:3,count:i,componentType:5126,array:a},o.push(a.buffer)}else if(e.NORMAL_OCT16P){let{byteOffset:s,array:a}=e.NORMAL_OCT16P;s=s||0;const h=a?0:n;if(!a){const e=t.slice(s+h,s+h+2*i);a=new Uint8Array(e)}l.NORMAL_OCT16P={byteStride:0,byteOffset:0,itemSize:2,count:i,componentType:5121,array:a},o.push(a.buffer)}return l}Kn(t,e,n){return lW(new Float32Array(t.length),t,e,n)}$n(){return null}}function TX(t){const e=eV(t),n=new e(t);for(let e=0;e<t;e++)n[e]=e;return{byteStride:0,byteOffset:0,itemSize:1,count:t,componentType:aW(e),array:n}}const{Ajax:MX,GLTFLoader:CX}=dV();class mi{constructor(t,e,n,i){this.Re=n,this.Fn=t,this.jn=e||CX,this.Vn=i}load(t,e,n=0,i=0,o){return e?this.Hn(t,e,n,i,o):MX.getArrayBuffer(t,{}).then((e=>this.Hn(t,e.data,n,i)))}Hn(t,e,n,i,o){i||(i=e.byteLength);const s=this.er(e,t,n,i),a=[];for(let n=0;n<s.length;n++){let i;if("b3dm"===s[n].magic)i=new ni(this.Fn,this.jn,this.Re);else if("i3dm"===s[n].magic)i=new ii(this.Fn,this.jn,this.Re,this.Vn);else if("pnts"===s[n].magic)i=new hi;else{if("cmpt"!==s[n].magic){console.warn("Unsupported magic in CMPT tile:",s[n].magic);continue}i=new mi(this.Fn,this.jn,this.Re,this.Vn)}a.push(i.load(t,e,s[n].offset,s[n].byteLength,o).then((t=>t)))}return Promise.all(a).then((t=>({magic:"cmpt",tiles:t})))}er(t,e,n,i){const o=new DataView(t,n,i),s=o.getUint32(4,!0);if(1!==s){const t="Unsupported cmpt version: "+s+", url:"+e;return console.warn(t),{error:t}}if(16===o.byteLength)return[];const a=[],l=o.getUint32(12,!0);let h=16;for(let e=0;e<l;e++){const e=JV(o,h),i=o.getUint32(h+8,!0);a.push({magic:e,buffer:t,offset:h+n,byteLength:i}),h+=i}return a}}if(GC){const t=Lf.VERSION;if(t.indexOf("1.0.0-beta")>=0||t.indexOf("1.0.0-alpha")>=0){va("@ispace/3dtiles",GC.inject($j))}else va("@ispace/3dtiles",(function(){return GC.inject($j)}))}else va("@ispace/3dtiles",$j);"undefined"!=typeof console&&console.log("@ispace/3dtiles v0.105.8");
/*!
   * @ispace/gltf-layer v0.105.4
   * LICENSE : UNLICENSED
   * (c) 2016-2026 ispace.org
   */
const SX='function(e){\n/*!\n     * @ispace/gl v0.108.4\n     * LICENSE : UNLICENSED\n     * (c) 2016-2026 ispace.com\n     */\nconst n=function(){if("undefined"!=typeof undefinedThis)return globalThis;if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof undefined)return global;throw new Error("unable to locate global object")},t=n(),r=t.gl_trans__coders=t.gl_trans__coders||{};r.inject=function(e){const r=e.toString(),o=r.indexOf("{")+1,s=r.substring(0,o),a=t.gl_trans__coders=t.gl_trans__coders||{};let c=`${s}\\n    const _____getGlobal = ${n.toString()};\\n    const g___lobals = _____getGlobal()\\n    const tran_____scoders = g___lobals[\'gl_trans__coders\'] = g___lobals[\'gl_trans__coders\'] || {};`;for(const e in a)"inject"!==e&&"getTranscoder"!==e&&"registerTranscoder"!==e&&(c+=\'tran_____scoders["\'+e+\'"] =\'+a[e].toString()+"\\n;");return c+="\\n("+n().ispace_gltf_loader_bundle.toString()+")({});\\n",c+="\\n"+r.substring(s.length),c},r.registerTranscoder=function(e,n){r[e]=n},r.getTranscoder=function(e){return r[e]};const o=n().ispace_gltf_loader,s={"image/crn":r.crn&&r.crn(),"image/ktx2":r.ktx2&&r.ktx2(),"image/cttf":r.ktx2&&r.ktx2(),"draco":r.draco&&r.draco()};let a;const c={};function i(e,n,t){return new o.GLTFLoader(e,n,t).load({skipAttributeTransform:!0})}function f(e,n,t,r){const a=n.lastIndexOf("/"),c=n.slice(0,a);r&&(n=r(n));const f=(...n)=>l.call(this,e,...n);return function(e,n){return o.Ajax.getArrayBuffer(e,n)}(n,t).then((e=>{if(e.message)return e;const a=e.data;return new DataView(a,a.byteOffset,a.byteLength).getUint32(4,!0)>2?function(e,n){return o.Ajax.getJSON(e,n)}(n,t).then((e=>e.message?e:i(c,e,{requestImage:f,decoders:s,transferable:!0,fetchOptions:t,urlModifier:r}))):i(c,{buffer:e.data,byteOffset:0},{requestImage:f,decoders:s,transferable:!0,fetchOptions:t,urlModifier:r})}))}function l(e,n,t,r){e?c[n]?c[n].push(r):(c[n]=[r],self.postMessage({type:"<request>",command:"sendImageData",actorId:e,workerId:a,params:n})):function(e,n){const t=new Image;t.onload=()=>{if(!u)return void n(new Error("There is no canvas to draw image!"));u.width=t.width,u.height=t.height;const e=u.getContext("2d");e.drawImage(t,0,0,t.width,t.height);const r=e.getImageData(0,0,t.width,t.height),o={width:t.width,height:t.height,data:new Uint8Array(r.data)};n(null,o,[o.data.buffer])},t.onerror=function(e){n(e)},t.src=e}(n,r)}const u="undefined"==typeof document?null:document.createElement("canvas");e.loadGLTF=f,e.onmessage=function(e){const n=e.data,t=n.url;if("addLayer"===n.command||"removeLayer"===n.command)a=e.workerId,self.postMessage({type:"<response>",actorId:n.actorId,workerId:a,params:"ok"});else if(t)!function(e){const n=e.data,t=e.callback,r=e.actorId,o=n.url,s=n.fetchOptions||{};s.referrerPolicy=s.referrerPolicy||"origin",s.referrer=n.referrer,f(r,o,s).then((e=>{e.message?self.postMessage({callback:t,error:e}):self.postMessage({callback:t,data:e},e.transferables)})).catch((e=>{self.postMessage({callback:t,error:e})})),c.receive=t}(e);else if(n.imageUrl){const e=c[n.imageUrl];if(delete c[n.imageUrl],e)for(let t=0;t<e.length;t++)e[t](null,n.result)}}}';function PX(t){return null==t}function IX(t){return!PX(t)}function OX(t,e){if(!t||!e)return null;let n=e;if(Array.isArray(e)){if(!hs.isNumber(e[0]))return null;n=new gh(e)}const i=t.coordinateToPointAtRes(n,t.getGLRes()),o=t.altitudeToPoint(n.z||0,t.getGLRes());return[i.x,i.y,o]}function EX(t,e){return Math.abs(t)*Math.sign(e)}function kX(t,e,n){const i=Zh.Measurer.getInstance().measureLenBetween(t,e);let o=n.count;o&&n.snapToEndVertexes&&(o-=1);const s=o>0?i/o:n.gapLength+n.bboxWidth,a=Math.floor(i/s),l=[],h=n.rotateAlongLine+function(t,e,n){const i=n.getGLRes(),o=n.coordinateToPointAtRes(t,i),s=n.coordinateToPointAtRes(e,i);return hs.computeDegree(s.x,s.y,o.x,o.y)/Math.PI*180}(t,e,n.map);if(a>=1){const o=0,c=a;if(n.snapToEndVertexes)for(let n=o;n<=c;n++){const o={coordinates:RX(t,e,s*n/i),scale:[1,1,1],rotation:[0,0,h]};l.push(o)}else for(let n=o+1;n<=c;n++){const o={coordinates:RX(t,e,s*(n-.5)/i),scale:[1,1,1],rotation:[0,0,h]};l.push(o)}if(n.scaleEndModel){const n=(i-s*a)/s,o={coordinates:RX(t,e,(s*a+(i-s*a)/2)/i),scale:[n,1,1],rotation:[0,0,h]};l.push(o)}}else if(n.scaleEndModel){const n=i/s,o={coordinates:RX(t,e,.5),scale:[n,1,1],rotation:[0,0,h]};l.push(o)}return l}function RX(t,e,n){const i=LX(t.x,e.x,n),o=LX(t.y,e.y,n);return new gh(i,o)}function LX(t,e,n){return t+n*(e-t)}const DX={},FX="undefined"==typeof document?null:document.createElement("canvas");let NX=class F extends Em.Actor{constructor(t,e){super(t),this.mapId=e.getMap().id,this.i=e}loadGLTF(t){const e=function(t){let e=document.createElement("a");return e.href=t,t=e.href,e=null,t}(t),n={url:e,referrer:window&&window.location.href,fetchOptions:this.i.options.fetchOptions};return new Promise(((t,e)=>{this.send(n,null,((n,i)=>{n?e(n):t(i)}))}))}sendImageData(t,e){!function(t,e){const n=new Image;n.onload=()=>{if(!FX)return void e(new Error("There is no canvas to draw image!"));FX.width=n.width,FX.height=n.height;const t=FX.getContext("2d");t.drawImage(n,0,0,n.width,n.height);const i=t.getImageData(0,0,n.width,n.height),o={width:n.width,height:n.height,data:new Uint8Array(i.data)};e(null,o)},n.onerror=function(t){e(t)},n.src=t}(t,((n,i)=>{n||this.isActive()&&e(null,{result:i,imageUrl:t})}))}addLayer(t,e,n){this.broadcast({actorId:this.actorId,mapId:this.mapId,layerId:t,command:"addLayer",params:{options:e}},null,n)}removeLayer(t,e,n){this.broadcast({mapId:this.mapId,layerId:t,command:"removeLayer"},null,n)}};
/*!
   * @ispace/gl v0.108.4
   * LICENSE : UNLICENSED
   * (c) 2016-2026 ispace.com
   */const HX=function(){if("undefined"!=typeof globalThis)return globalThis;if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("unable to locate global object")},BX=HX(),zX=BX.gl_trans__coders=BX.gl_trans__coders||{};zX.inject=function(t){const e=t.toString(),n=e.indexOf("{")+1,i=e.substring(0,n),o=BX.gl_trans__coders=BX.gl_trans__coders||{};let s=`${i}\n    const _____getGlobal = ${HX.toString()};\n    const g___lobals = _____getGlobal()\n    const tran_____scoders = g___lobals['gl_trans__coders'] = g___lobals['gl_trans__coders'] || {};`;for(const t in o)"inject"!==t&&"getTranscoder"!==t&&"registerTranscoder"!==t&&(s+='tran_____scoders["'+t+'"] ='+o[t].toString()+"\n;");return s+="\n("+HX().ispace_gltf_loader_bundle.toString()+")({});\n",s+="\n"+e.substring(i.length),s},zX.registerTranscoder=function(t,e){zX[t]=e},zX.getTranscoder=function(t){return zX[t]};const GX=HX().ispace_gltf_loader,jX={"image/crn":zX.crn&&zX.crn(),"image/ktx2":zX.ktx2&&zX.ktx2(),"image/cttf":zX.ktx2&&zX.ktx2(),draco:zX.draco&&zX.draco()};let UX;const VX={};function WX(t,e,n){return new GX.GLTFLoader(t,e,n).load({skipAttributeTransform:!0})}function ZX(t,e,n,i){const o=e.lastIndexOf("/"),s=e.slice(0,o);i&&(e=i(e));const a=(...e)=>qX.call(this,t,...e);return function(t,e){return GX.Ajax.getArrayBuffer(t,e)}(e,n).then((t=>{if(t.message)return t;const o=t.data;return new DataView(o,o.byteOffset,o.byteLength).getUint32(4,!0)>2?function(t,e){return GX.Ajax.getJSON(t,e)}(e,n).then((t=>t.message?t:WX(s,t,{requestImage:a,decoders:jX,transferable:!0,fetchOptions:n,urlModifier:i}))):WX(s,{buffer:t.data,byteOffset:0},{requestImage:a,decoders:jX,transferable:!0,fetchOptions:n,urlModifier:i})}))}function qX(t,e,n,i){t?VX[e]?VX[e].push(i):(VX[e]=[i],self.postMessage({type:"<request>",command:"sendImageData",actorId:t,workerId:UX,params:e})):function(t,e){const n=new Image;n.onload=()=>{if(!XX)return void e(new Error("There is no canvas to draw image!"));XX.width=n.width,XX.height=n.height;const t=XX.getContext("2d");t.drawImage(n,0,0,n.width,n.height);const i=t.getImageData(0,0,n.width,n.height),o={width:n.width,height:n.height,data:new Uint8Array(i.data)};e(null,o,[o.data.buffer])},n.onerror=function(t){e(t)},n.src=t}(e,i)}const XX="undefined"==typeof document?null:document.createElement("canvas"),JX=[],QX=[],YX=[],KX=[],$X=[1,1,1],tJ=[],eJ=[],nJ=[1,1,1],iJ=[],rJ=new db,oJ=function(t,e){const n=[];return n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=0,n[4]=t[3],n[5]=t[4],n[6]=t[5],n[7]=0,n[8]=t[6],n[9]=t[7],n[10]=t[8],n[11]=0,n[12]=e[0],n[13]=e[1],n[14]=e[2],n[15]=1,n}(function(t){const e=Math.cos(t),n=Math.sin(t),i=[];return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=e,i[5]=n,i[6]=0,i[7]=-n,i[8]=e,i}(.5*Math.PI),[0,0,0]),sJ=new _e(0,0),aJ=[186/255,186/255,186/255,1],lJ={lightAmbient:[1,1,1],lightDiffuse:[1,1,1],lightSpecular:[1,1,1],lightDirection:[1,1,1]},hJ=new Set(["url","translationX","translationY","translationZ","rotationX","rotationY","rotationZ","scaleX","scaleY","scaleZ","anchorZ","markerPixelHeight","modelHeight"]),cJ=[1,1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1],uJ=[0,1,1,2,2,3,3,0,0,4,1,5,2,6,3,7,4,5,5,6,6,7,7,4],fJ=[.8,.8,.1,1];class ct extends ld{constructor(t,e){const n=hs.extend({},e),i=n.symbol;super(t,n),this.options.symbol=i,this.o=!1,this.h=ay([]),this.l="gltfmarker",this.u=!0,this.m=!0,this.p={get translation(){return[0,0,0]},get rotation(){return[0,0,0]},get scale(){return[1,1,1]}},this._()}static parseJSONData(t){const e=ct.fromJSON(t);return e.setZoomOnAdded(t.zoomOnAdded),e}static fromJSON(t){return new ct(t.coordinates,t.options)}static getGLTFAnchorsAlongLineString(t,e,n,i){const o=[];for(let s=0;s<t.length-1;s++){const a=kX(t[s],t[s+1],{map:n,bboxWidth:e,gapLength:i.gapLength||0,count:i.count,rotateAlongLine:i.rotateAlongLine,snapToEndVertexes:i.snapToEndVertexes,scaleEndModel:i.scaleEndModel});hs.pushIn(o,a)}return o}static combineGLTFBoundingBox(t){const e=[];for(let n=0;n<t.length;n++){const i=t[n].getBoundingBox();e.push([i.min,i.max])}const n=e[0];if(!n)return null;const i=Dy([],n[0]),o=Dy([],n[1]);for(let t=1;t<e.length;t++){const n=e[t],s=Dy([],n[0]),a=Dy([],n[1]);s[0]<i[0]&&(i[0]=s[0]),s[1]<i[1]&&(i[1]=s[1]),s[2]<i[2]&&(i[2]=s[2]),a[0]>o[0]&&(o[0]=a[0]),a[1]>o[1]&&(o[1]=a[1]),a[2]>o[2]&&(o[2]=a[2])}return{min:i,max:o}}setTransformOrigin(t){this.v=t}getTransformOrigin(){return this.v||this.getCenter()}getMeshes(t,e,n){let i=[];const o=this.getMap();if(e&&(this.regl=e),this.getLayer().isVisible()&&this.isVisible()&&this.M()){if(!this.S)return this.O(t,e),i;let s=this.isAnimated()||this.T()&&o.isZooming()||this.m||"multigltfmarker"===this.getGLTFMarkerType()&&this.u||"effectmarker"===this.getGLTFMarkerType();if(!s){const t=this.h;sy(tJ,t),this._(),s=!Iy(t,tJ)}s&&this.A(this.S,n),i=this.S.filter((t=>!!(Hj(o.projViewMatrix,t.getBoundingBox())||t instanceof lw)&&(this.k(t,n),this.P(t),!0))),this.C(!1)}return i}getGLTFJSON(){return this.L}getAllMeshes(){return this.S}I(){return this.L}F(t){this.L=t}D(t,e){this._externSymbol=this._externSymbol||{},this._externSymbol[t]=e,"uniforms"===t&&(this.G=!0)}setUrl(t){return this.updateSymbol({url:t}),this}setSymbol(t){const e=this.getUrl();super.setSymbol(t);const n=this.getShader(),i=this.N;i&&t.url!==e&&(i.logoutGLTF(e),this.B=!1,this.R(!1),delete this.S),this.j&&this.j!==n&&this.U(i,this.regl),this.j=n,this.G=!0,this.u=!0}getCenter(){const t=this.getMap();if(!t)return null;const e=OX(t,super.getCenter()||this.getCoordinates());if(!e)return null;const n=this.J(),i=new _e([e[0]+n[0],e[1]+n[1],e[2]+n[2]]),o=t.getGLRes(),s=t.pointAtResToCoord(i,o);return s.z=i.z/t.altitudeToPoint(100,o)*100,s}getPointZ(){const t=this.getCoordinates(),e=this.getMap();return e&&t?e.altitudeToPoint(t.z||0,e.getGLRes()):null}getUrl(){const t=this._getInternalSymbol();return t&&t.url||"pyramid"}addTo(t){if(this.getLayer())throw new Error("GLTFMarker cannot be added to two or more layers at the same time.");return t.addGeometry(this),this}O(t,e){const n=this.getUrl();if(this.N=t,!this.B){const e=this.getLayer().getRenderer();t.loginGLTF(n,((...t)=>e.H.apply(e,t))),this.B=!0}const i=t.getGLTF(n);i&&!i.then&&(this.R(!0),this.V(i,t,e))}k(t,e){"effectmarker"===this.getGLTFMarkerType()?this.updateUV(e):"glowmarker"===this.getGLTFMarkerType()&&this.Z();const n=this.getUniforms();if(n&&this.isDirty()&&this.q())for(const e in n)t.setUniform(e,n[e]);this.W()&&(t.transparent=!0),t.setUniform("uPickingId",this.X()),t.properties.isAnimated=this.isAnimated()}P(t){const e=this.getShader(),n=t.getDefines();let i=!1;if("pbr"===e||"pbr-lite"===e){const t=this.getLayer(),{iblTexes:e}=xC.PBRUtils.getIBLResOnCanvas(t.getRenderer().canvas);e?n.HAS_IBL_LIGHTING||(n.HAS_IBL_LIGHTING=1,i=!0):n.HAS_IBL_LIGHTING&&(i=!0,delete n.HAS_IBL_LIGHTING)}i&&t.setDefines(n);const o=this.getLayer().getRenderer();o&&o.updateMaskDefines(t)}U(t){const e=this.getUrl(),n=this.S;t&&n&&(t.isSimpleModel(e)?this.Y(n):t.getGLTF(e)&&(n.forEach((t=>{this.k(t)})),this.Y(n)))}Y(t){const e=this.getShader();t.forEach((t=>{const n=this.$(t.properties.geometryResource);"wireframe"===e?(t.properties.geometryResource&&!t.properties.geometryResource.copyGeometry&&t.properties.geometryResource.copyEdgeGeometry(),t.geometry=t.properties.geometryResource.copyGeometry):t.geometry=t.properties.geometryResource.geometry,t.material=n}))}A(t,e){Fy($X,1,1,1);const n=ay(tJ),i=this.isAnimated();this._();const o=this.getModelMatrix(),{nodeMatrixMap:s,skinMap:a}=this.K(e);this.tt($X);let l=0;t.forEach((t=>{const e=t.properties.geometryResource.nodeIndex,h=s[e],c=i&&h?h:t.nodeMatrix;fy(n,o,$X),cy(n,n,oJ),t.et=t.et||ay([]);const u=cy(iJ,t.et,c);t instanceof lw?(t.positionMatrix=cy(t.positionMatrix,n,u),t.localTransform=this.it(),this.st(t)):t.localTransform=cy(t.localTransform,n,u);const f=t.geometry.boundingBox.copy(rJ);f.transform(t.positionMatrix,t.localTransform);const g=this.nt(f);if(Math.abs(g)>Math.abs(l)&&(l=g),i){const n=a[e];n&&(t.material.set("skinAnimation",1),t.material.set("jointTextureSize",n.jointTextureSize),t.material.set("numJoints",n.numJoints),t.material.set("jointTexture",n.jointTexture));const i=t.geometry.properties.morphWeights;i&&this.rt(i,t.material)}else t.material.set("skinAnimation",0)}));const h=this.ot();if(h&&(fy(n,o,$X),cy(n,n,oJ),this.ht.localTransform=cy(this.ht.localTransform,n,this.ht.ct)),0!==l){Fy(eJ,0,0,l);const e=gy(tJ,eJ);t.forEach((t=>{if(t instanceof lw)t.positionMatrix=cy(t.positionMatrix,e,t.positionMatrix),this.st(t);else{const n=cy(t.localTransform,e,t.localTransform);t.localTransform=n}})),h&&(this.ht.localTransform=cy(this.ht.localTransform,e,this.ht.localTransform))}t.forEach((t=>{t instanceof lw&&this.st(t)})),this.fire("updatematrix",{target:this})}getBoundingBoxCenter(){const t=this.lt,e=this.getMap();if(!t||!this.ht||!e)return null;const n=e.getGLRes(),{min:i,max:o}=t,s=Ny([],i,o);Gy(s,s,.5),Jy(s,s,this.ht.localTransform);const a=new _e(s),l=e.pointAtResToCoordinate(a,n);return l.z=100/e.altitudeToPoint(100,n)*s[2],l}getBoundingBoxWidth(t){const e=this.lt;if(!e)return 0;let n=0;"x"===t?n=0:"y"===t?n=2:"z"===t&&(n=1);const{min:i,max:o}=e,s=this.ut()[n];return(o[n]-i[n])*s}getAxisXWidth(){return this.getBoundingBoxWidth("x")}getAxisYWidth(){return this.getBoundingBoxWidth("y")}getAxisZWidth(){return this.getBoundingBoxWidth("z")}tt(t){const e=this.getMap(),n=e.getGLRes(),i=e.altitudeToPoint(100,n);return t[0]*=i/100,t[1]*=i/100,t[2]*=i/100,t}ft(t,e){return this.gltfPack.calModelHeightScale(t,e)}dt(t,e){const n=this.lt;if(!e||e<0||!n)return t;const i=this.getMap(),o=Math.abs(n.max[1]-n.min[1]),s=i.altitudeToPoint(o,i.getGLRes()),a=e*i.getGLScale()/s;return Fy(t,a,a,a)}getCurrentPixelHeight(){const t=this.getBoundingBox();return Math.abs(t.max[2]-t.min[2])/this.getMap().getGLScale()}getFitTranslate(t){const e=this.lt,n=Fy(t,(e.min[0]+e.max[0])/2,(e.min[1]+e.max[1])/2,(e.min[2]+e.max[2])/2);return Gy(n,n,-1)}nt(t){const e=this.getSymbol(),n=e&&e.anchorZ||"center";let i=0;const o=t.max[2]-t.min[2];return"bottom"===n?i=o/2:"top"===n&&(i=-o/2),i}K(t){const e=this.isAnimated(),n=this.gt(),i={},o=this._t();if(t&&e&&this.gltfPack&&n){const e=this.xt();if(IX(e)){this.yt(t);const n=this.vt(),s=this.isAnimationLooped(),a=this.getAnimationSpeed(),l=this.getSymbol(),h=l&&l.animationNodes;for(let l=0;l<e.length;l++)this.gltfPack.updateAnimation(t,s,a,e[l],n,i,o,h)}else console.warn("animation specified does not exist!")}return{nodeMatrixMap:i,skinMap:o}}V(t,e,n){const i=this.getUrl();this.F(t.json),this.wt(i,e,n),this.U(e,n),this.createdBygltfmarker||(this.fire("load",{data:t.json}),this.fire("setUrl-debug"),this._fireEvent("meshcreate",{url:i}))}wt(t,e,n){const i=[],o=this.getShader(),s=e.getGLTF(t);if(s&&s.resources){if(!s.resources.length)return void this._fireEvent("modelerror",{url:t,info:"there are no geomtries in the gltf model"});this.gltfPack=s.gltfPack,s.resources.forEach((t=>{const e=this.bt(t,o,n);i.push(e)}))}this.S=i,this.lt=this.Mt(),this.St(this.S),this.fire("createscene-debug",{meshes:this.S})}St(t){this.A(t);const e=this.getBoundingBox();if(!e)return;const n=this.getMap(),{max:i,min:o}=e;Ry([i[0]-o[0],i[1]-o[1],i[2]-o[2]])/n.getGLScale()<20&&(console.warn("Model's size on screen is too small, try to increase its symbol.scaleX/Y/Z"),this.fire("smallonscreen"))}ot(){if(this.ht)return this.ht.material.set("lineColor",this.Ot||fJ),this.ht.material.set("lineOpacity",this.Tt||1),this.ht;const t=this.lt;if(!t)return null;const{min:e,max:n}=t;cJ[0]=n[0],cJ[1]=e[1],cJ[2]=n[2],cJ[3]=n[0],cJ[4]=n[1],cJ[5]=n[2],cJ[6]=e[0],cJ[7]=n[1],cJ[8]=n[2],cJ[9]=e[0],cJ[10]=e[1],cJ[11]=n[2],cJ[12]=n[0],cJ[13]=e[1],cJ[14]=e[2],cJ[15]=n[0],cJ[16]=n[1],cJ[17]=e[2],cJ[18]=e[0],cJ[19]=n[1],cJ[20]=e[2],cJ[21]=e[0],cJ[22]=e[1],cJ[23]=e[2];const i=new vb({POSITION:cJ},uJ,0,{primitive:"lines",positionAttribute:"POSITION"});i.generateBuffers(this.regl);const o=new aw(i,new Qb({lineColor:this.Ot||fJ,lineOpacity:this.Tt||1}));return this.ht=o,this.ht.ct=sy([],o.localTransform),o}showBoundingBox(t){this.options.showDebugBoundingBox=!0,this.Ot=t&&t.lineColor,this.Tt=t&&t.lineOpacity,this.u=!0}hideBoundingBox(){this.options.showDebugBoundingBox=!1,this.u=!0}getBoundingBox(){const t=this.S;if(!t||!t.length)return null;if(!this.m)return this.At;"multigltfmarker"===this.getGLTFMarkerType()&&t.forEach((t=>{this.st(t),t.updateBoundingBox()}));const e=t[0].getBoundingBox(),n=Dy([],e[0]),i=Dy([],e[1]);for(let e=1;e<t.length;e++){const o=t[e].getBoundingBox(),s=Dy([],o[0]),a=Dy([],o[1]);s[0]<n[0]&&(n[0]=s[0]),s[1]<n[1]&&(n[1]=s[1]),s[2]<n[2]&&(n[2]=s[2]),a[0]>i[0]&&(i[0]=a[0]),a[1]>i[1]&&(i[1]=a[1]),a[2]>i[2]&&(i[2]=a[2])}const o={min:n,max:i};return this.At=o,"multigltfmarker"===this.getGLTFMarkerType()?this.kt.length&&(this.m=!1):this.m=!1,o}Mt(){return this.gltfPack.getGLTFBBox()}bt(t,e,n){const i=this.Pt(t,e,n),o=i.getDefines();return i instanceof lw?(o.HAS_PICKING_ID=1,o.HAS_INSTANCE_COLOR=1):o.HAS_PICKING_ID=2,i.geometry.data.COLOR_0&&(o.HAS_COLOR0=1),o.HAS_MIN_ALTITUDE=1,o.HAS_LAYER_OPACITY=1,i.setDefines(o),i}Pt(t,e,n){const i=this.getGLTFMarkerType();let o=null;const s=this.$(t);let a=t.geometry;if("wireframe"===e&&(t.copyEdgeGeometry(),a=t.copyGeometry),n?a.generateBuffers(n):(this.Ct=this.Ct||[],this.Ct.push(a)),"multigltfmarker"===i){this.Lt();const t=this.It(ay(KX)),e=this.Ft();o=new lw(t.attributesData,e,a,s),o.setUniform("instance",1),n?o.generateInstancedBuffers(n):(this.Dt=this.Dt||[],this.Dt.push(o))}else o=new aw(a,s),o.setUniform("instance",0);o.nodeMatrix=sy([],t.nodeMatrix),o.properties.geometryResource=t,o.properties.nodeIndex=t.nodeIndex,this.isBloom()&&(o.bloom=1),o.transparent=this.W(),"BLEND"===t.extraInfo.alphaMode&&(o.transparent=!0),o.properties.pickingId=this.X(),this.Gt(o);const l=this.getLayer();return Object.defineProperty(o.uniforms,"minAltitude",{enumerable:!0,get:()=>l.options.altitude||0}),o}$(t){let e=null;const n=this.getShader(),i=this.getUniforms()||{},o=t.materialInfo||{},s=this.getLayer().getRenderer();if("phong"===n)if("pbrSpecularGlossiness"===o.name)e=new rw(o);else{for(const t in lJ)i[t]=i[t]||lJ[t];e=new $b(o)}else if("pbr"===n){if(e="pbrSpecularGlossiness"===o.name?new xC.StandardSpecularGlossinessMaterial(o):new xC.StandardMaterial(o),s.regl&&!xC.PBRUtils.isSupported(s.regl)){e=$b.convertFrom(e);for(const t in lJ)i[t]=i[t]||lJ[t]}}else e="pbr-lite"===n?new ew(o):new Qb(o);const a=this.getSymbol(),l=a&&a.doubleSided;IX(l)&&(e.doubleSided=l);for(const t in i)e.set(t,i[t]);return t.morphWeights&&this.rt(t.morphWeights,e),t.skin&&e.set("skinAnimation",0),e}rt(t,e){const n=e.get("morphWeights1")||[],i=e.get("morphWeights2")||[];for(let e=0;e<4;e++)n[e]=t[e]||0,i[e]=t[e+4]||0;e.set("morphWeights1",n),e.set("morphWeights2",i)}Gt(t){const e=this.getSymbol();e&&e.uniforms?(t.setUniform("polygonFill",e.uniforms.polygonFill||aJ),t.setUniform("polygonOpacity",void 0===e.uniforms.polygonOpacity?1:e.uniforms.polygonOpacity),t.setUniform("lineColor",e.uniforms.lineColor||aJ),t.setUniform("lineOpacity",void 0===e.uniforms.lineOpacity?1:e.uniforms.lineOpacity)):(t.setUniform("polygonFill",aJ),t.setUniform("polygonOpacity",1),t.setUniform("lineColor",aJ),t.setUniform("lineOpacity",1))}Nt(){const t=this.getLayer();if(!t)return null;const e=t.getMap();if(!e)return null;const n=this.getBoundingBox();if(!n)return null;const i=n.min,o=n.max,s=g_(QX,(i[0]+o[0])/2,(i[1]+o[1])/2,i[2],1),a=g_(YX,(i[0]+o[0])/2,(i[1]+o[1])/2,o[2],1),l=S_(s,s,e.projViewMatrix),h=S_(a,a,e.projViewMatrix),c=(l[0]/l[3]+1)*e.width/2,u=(1-l[1]/l[3])*e.height/2,f=(h[0]/h[3]+1)*e.width/2,g=(1-h[1]/h[3])*e.height/2,A=Math.min(c,f),m=Math.max(c,f),w=Math.min(u,g),T=Math.max(u,g);return new Ph({xmin:A,ymin:w,xmax:m,ymax:T})}onAdd(){const t=this.getLayer().getMap();if(t&&!IX(this.Et)){const e=t.getZoom();this.Et=e}}onRemove(){this.Bt()}remove(){const t=this.getUrl();if(this.N&&(delete this.S,this.N.logoutGLTF(t),delete this.N),this.Rt){for(const t in this.Rt)this.Rt[t]&&this.Rt[t].jointTexture&&this.Rt[t].jointTexture.destroy();delete this.Rt}this.ht&&(this.ht.geometry.dispose(),this.ht.dispose(),delete this.ht),this.S&&this.S.forEach((t=>{t.dispose(),t.properties.bloomMesh&&(t.properties.bloomMesh.dispose(),delete t.properties.bloomMesh)})),this.B=!1,delete this.L,delete this.gltfPack,super.remove()}show(){return super.updateSymbol({visible:!0}),this}hide(){super.updateSymbol({visible:!1})}setBloom(t){return this.updateSymbol({bloom:t}),this}isBloom(){const t=this._getInternalSymbol();return t&&t.bloom}setCastShadow(t){return super.updateSymbol({shadow:t}),this}isCastShadow(){const t=this._getInternalSymbol();return t&&(t.shadow||void 0===t.shadow)}outlineNodes(t){const e=this.S;return e?(e.forEach((e=>{t.indexOf(e.properties.nodeIndex)>-1&&(e.properties.outline=!0)})),this.u=!0,this):this}outline(){this.updateSymbol({outline:!0});const t=this.S;return t?(t.forEach((t=>{t.properties.outline=!0})),this.u=!0,this):this}cancelOutline(t){this.updateSymbol({outline:!1});const e=this.S;return e?(e.forEach((e=>{t?t.indexOf(e.properties.nodeIndex)>-1&&(e.properties.outline=!1):e.properties.outline=!1})),this.u=!0,this):this}isOutline(){const t=this._getInternalSymbol();return!(!t||!IX(t.outline))&&t.outline}isVisible(){const t=this._getInternalSymbol();return!t||!IX(t.visible)||t.visible}setCoordinates(t){return super.setCoordinates(t),this.u=!0,this.m=!0,this}copy(){const t=this.toJSON(),e=ct.fromJSON(t);return e.setZoomOnAdded(this.Et),e}setShader(t){return super.updateSymbol({shader:t}),this}getShader(){const t=this._getInternalSymbol();return t&&t.shader||"pbr"}setUniforms(t){return super.updateSymbol({uniforms:t}),this.G=!0,this}getUniforms(){const t=this._getInternalSymbol();return t&&t.uniforms}setUniform(t,e){const n=this.getUniforms()||{};return n[t]=e,super.updateSymbol({uniforms:n}),this.G=!0,this}getUniform(t){const e=this._getInternalSymbol();return e&&e.uniforms&&e.uniforms[t]}isAnimated(){const t=this._getInternalSymbol();return t&&t.animation&&this.L&&this.L.animations}isDashAnimated(){const t=this._getInternalSymbol();return t&&t.uniforms&&t.uniforms.dashEnabled&&t.uniforms.dashAnimate}setAnimation(t){return super.updateSymbol({animation:t}),delete this.jt,this}setAnimationLoop(t){return super.updateSymbol({loop:t}),delete this.jt,this.u=!0,this}isAnimationLooped(){const t=this._getInternalSymbol();return t&&t.loop}getAnimationSpeed(){const t=this._getInternalSymbol();return t&&IX(t.speed)?t.speed:1}setAnimationSpeed(t){return super.updateSymbol({speed:t}),this}Ut(t){const e=this.getMap();return e?OX(e,t||this.getCoordinates()):null}setTRS(t,e,n){const i=t||this.p.translation;return this.updateSymbol({translationX:i[0],translationY:i[1],translationZ:i[2],rotationX:e[0],rotationY:e[1],rotationZ:e[2],scaleX:n[0],scaleY:n[1],scaleZ:n[2]}),this}zt(){const t=this.J(),e=this.Ut();return e?Ny(t,t,e):t}updateSymbol(t){for(const e in t)if("bloom"===e&&this.S&&this.S.forEach((n=>{n.bloom=+!!t[e]})),hJ.has(e)){this.m=!0;break}return super.updateSymbol(t)}setTranslation(t,e,n){return this.updateSymbol({translationX:t,translationY:e,translationZ:n}),this}setRotation(t,e,n){return this.updateSymbol({rotationX:t,rotationY:e,rotationZ:n}),this}rotateAround(t,e){const n=this.getMap();if(!n)return;const i=n.getGLRes();let o=this.getCoordinates();const s=n.coordinateToPointAtRes(o,i),a=n.coordinateToPointAtRes(t,i),l=s.x-a.x,h=s.y-a.y,c=180*Math.atan2(h,l)/Math.PI+e,u=Math.sqrt(l*l+h*h),f=Math.PI*c/180,g=u*Math.cos(f)+a.x,A=u*Math.sin(f)+a.y;sJ.set(g,A),o=n.pointAtResToCoordinate(sJ,i),this.setCoordinates(o),this.updateSymbol({rotationZ:c})}setScale(t,e,n){return this.updateSymbol({scaleX:t,scaleY:e,scaleZ:n}),this}getTranslation(){const t=this._getInternalSymbol();return Fy(this.p.translation,t&&t.translationX||0,t&&t.translationY||0,t&&t.translationZ||0)}J(){const t=this.getTranslation();return this.getMap()?this.Jt(t):this.p.translation}Jt(t){const e=this.getMap(),n=e.distanceToPointAtRes(t[0],t[1],e.getGLRes(),sJ),i=e.altitudeToPoint(t[2],e.getGLRes());return Fy(eJ,EX(n.x,t[0]),EX(n.y,t[1]),EX(i,t[2]))}getRotation(){const t=this._getInternalSymbol();return Fy(this.p.rotation,t&&t.rotationX||0,t&&t.rotationY||0,t&&t.rotationZ||0)}getScale(){const t=this._getInternalSymbol();if(!t)return Fy(this.p.scale,1,1,1);const e=hs.isNil(t.scaleX)?1:t.scaleX,n=hs.isNil(t.scaleY)?1:t.scaleY,i=hs.isNil(t.scaleZ)?1:t.scaleZ;return Fy(this.p.scale,e,n,i)}ut(){const t=this.getScale();if(this.lt){const e=this.T(),n=this.getModelHeight();if(e&&e>0){const n=this.dt(nJ,e);return By(n,n,t)}if(n){const e=this.ft(nJ,n);return By(e,e,t)}}return t}cancelMarkerPixelHeight(){return this.updateSymbol({markerPixelHeight:null})}setAnchorZ(t){return this.updateSymbol({anchorZ:t}),this}getAnchorZ(){const t=this._getInternalSymbol();return t&&t.anchorZ||"bottom"}_setExternSymbol(t){return this.u=!0,super._setExternSymbol(t)}Ht(t){return xk(t,(()=>{const t=this.getMap();return t?[t.getZoom()]:null}))}_prepareSymbol(t){super._prepareSymbol(t);const e=this.Ht(t);return e&&e.uniforms&&(e.uniforms=this.Ht(t.uniforms)),delete this.Vt,e}hasFunctionDefinition(){if(IX(this.Vt))return this.Vt;const t=this._getInternalSymbol();return this.Vt=yk(t)||t&&t.uniforms&&yk(t.uniforms),this.Vt}setModelMatrix(t){const e=yy(this.p.translation,t),n=vy(this.p.rotation,t),i=_y(this.p.scale,t);return this.setTranslation(e[0],e[1],e[2]),this.setRotation(n[0],n[1],n[2]),this.setScale(i[0],i[1],i[2]),this}getModelMatrix(){return this.h}_(){const t=this.zt(),e=this.getRotation(),n=Q_(JX,e[0],e[1],e[2]),i=this.ut();this.h=xy(this.h,n,t,i)}isDirty(){return this.u}C(t){return this.u=t,this}Zt(){const t=this.toJSON();return t.zoomOnAdded=this.Et,t}toJSON(){const t=JSON.parse(JSON.stringify({coordinates:this.getCoordinates(),options:this.options||{},type:"GLTFMarker"})),e=this.getId();hs.isNil(e)||(t.options.id=e);const n=this.getProperties();n&&(t.options.properties=JSON.parse(JSON.stringify(n)));const i=this.getSymbol();return i&&(t.options.symbol=JSON.parse(JSON.stringify(i))),t}setZoomOnAdded(t){this.Et=t}getZoomOnAdded(){return this.Et}W(){return this.M()<1}M(){const t=this.getUniforms(),e=this.getShader();return"pbr"===e||"phong"===e?t&&IX(t.polygonOpacity)?t.polygonOpacity:1:"wireframe"===e&&t&&IX(t.lineOpacity)?t.lineOpacity:1}R(t){this.o=t}isLoaded(){return this.o}getGLTFMarkerType(){return this.l}qt(t){this.Wt=t}X(){return this.Wt}getCount(){return 1}getContainerExtent(){return this.Nt()}getGLTFAsset(){return this.L&&this.L.asset}openInfoWindow(t){this.L?super.openInfoWindow(t):this.once("load",(()=>{super.openInfoWindow(t)}))}getAnimations(){if(!this.L)return null;const t=this.L,e=t.animations?t.animations.map(((t,e)=>({name:IX(t.name)?t.name:e}))):null;return e?e.map(((t,e)=>t.name||e)):null}getCurrentAnimation(){const t=this._getInternalSymbol();return t&&t.animationName}xt(){const t=this.getAnimations();if(!t)return null;let e=this.getCurrentAnimation();if(!IX(e))return t.slice(0,1);const n=[];e=Array.isArray(e)?e:[e];for(let i=0;i<e.length;i++)t.indexOf(e[i])>-1&&n.push(e[i]);return n.length?n:null}setCurrentAnimation(t){this.updateSymbol({animationName:t})}yt(t){IX(this.jt)||(this.jt=t)}vt(){return this.jt||0}_t(){return this.Rt=this.Rt||{},this.Rt}T(){const t=this._getInternalSymbol();return t&&t.markerPixelHeight}setModelHeight(t){return this.updateSymbol({modelHeight:t}),this}getModelHeight(){const t=this._getInternalSymbol();return t&&t.modelHeight}getGLTFBBox(){return this.lt}zoomTo(t={animation:!0},e){const n=this.getBoundingBox(),i=this.getMap();if(!i||!n)return;const{min:o,max:s}=n;sJ.set((o[0]+s[0])/2,(o[1]+s[1])/2);const a=i.getGLRes(),l=i.pointAtResToCoordinate(sJ,a);return l.z=(o[2]+s[2])/2/i.altitudeToPoint(1,a),this.Xt(l,t,e)}Xt(t,e,n){const i=this.getMap(),o=e.pitch||i.getPitch(),s=e.bearing||i.getBearing(),a=e.duration||500,l=e.easing||"linear",h=this.Yt(e.heightOffset||0)+(e.zoomOffset||0);return e.animation||void 0===e.animation?i.animateTo({center:t,zoom:h,bearing:s,pitch:o},{duration:a,easing:l},n):i.setView({center:t,zoom:h,bearing:s,pitch:o}),this}Yt(t){const e=this.getMap(),n=e.getGLRes(),i=e.distanceToPointAtRes(100,0,n).x/100,o=this.getBoundingBox(),{min:s,max:a}=o,l=a[2]/e.altitudeToPoint(1,n)+t,h=e.getFitZoomForAltitude(l*i);sJ.set(s[0],s[1]);const c=e.pointAtResToCoordinate(sJ,e.getGLRes());sJ.set(a[0],a[1]);const u=e.pointAtResToCoordinate(sJ,e.getGLRes()),f=new Ph(c,u),g=e.getFitZoom(f);return h<g?h:g}q(){return this.G}$t(){this.G=!1}setAnimationTimeframe(t){const e=this.vt(),n=this._t();this.gltfPack.updateAnimation(t,this.isAnimationLooped(),this.getAnimationSpeed(),e,{},n)}Bt(){delete this.At,delete this.Et}gt(){return"effectmarker"!==this.getGLTFMarkerType()&&"glowmarker"!==this.getGLTFMarkerType()}_onEvent(t,e){const n=this.getLayer();if(!n)return;const i=n.getId();this.Kt=t.gltfPickingInfo&&t.gltfPickingInfo[i]||{},super._onEvent(t,e)}_fireEvent(t,e){for(const t in this.Kt)e[t]=this.Kt[t];delete this.Kt,super._fireEvent(t,e)}Qt(){let t=[];return this.S&&this.isVisible()&&this.M()?this.isOutline&&this.isOutline()?this.S:(t=this.S.filter((t=>t.properties.outline)),t):t}highlightNodes(t){const e=this.S;e?this.te(t,e):this.once("load",(()=>{this.te(t,this.S)}),this)}te(t,e){t.forEach((t=>{e.forEach((e=>{e.properties.nodeIndex===t.nodeIndex&&this.ee(e,t.color,t.opacity,t.bloom)}))})),this.u=!0}highlight(t){const{color:e,opacity:n,bloom:i}=t,o=this.S;o?(o.forEach((t=>{this.ee(t,e,n,i)})),this.u=!0):this.once("load",(()=>{this.S.forEach((t=>{this.ee(t,e,n,i)})),this.u=!0}),this)}ee(t,e,n,i){t.properties.polygonFill||(t.properties.polygonFill=t.getUniform("polygonFill")||aJ),t.properties.polygonOpacity||(t.properties.polygonOpacity=t.getUniform("polygonOpacity")||1),t.setUniform("polygonFill",e||aJ),t.setUniform("polygonOpacity",n||1),t.bloom=i}ie(){if(this.se)if(Array.isArray(this.se)){const t=this.se.map((t=>t.nodeIndex));this.cancelHighlight(t)}else this.cancelHighlight(this.se.nodeIndex)}cancelHighlight(t){const e=this.getLayer();if(!e)return;const n=e.getRenderer();if(!n)return;let i=this.S;if(i){if(t){let e=t;Array.isArray(e)||(e=[e]),i=i.filter((t=>e.indexOf(t.properties.nodeIndex)>-1))}i.forEach((t=>{const{polygonFill:e,polygonOpacity:n}=t.properties;t.setUniform("polygonFill",e),t.setUniform("polygonOpacity",n),t.bloom=!1})),n.setToRedraw()}}setNodeTRS(t,e={}){const n=this.S;if(!n)return;const i=e.translation||this.p.translation,o=e.rotation||this.p.rotation,s=Q_(JX,o[0],o[1],o[2]),a=e.scale||this.p.scale;return n.forEach((e=>{e.properties.nodeIndex===t&&(e.et=xy(e.et||[],s,i,a))})),this.A(n),this.u=!0,this}}ct.mergeOptions({symbol:null}),ct.registerJSONType("GLTFMarker");const dJ=[1,1,1,1],gJ=[],pJ=[],AJ=[1,1,1],mJ=new gh(0,0),yJ=[1,1,1],_J=[1,1,1];class _t extends ct{constructor(t,e){super(null,e),this.kt=t||[],this.ne=[],this.re=[0,0,0],this.oe=ay([]),this.l="multigltfmarker",this.he=[]}static fromJSON(t){return new _t(t.data,t.options)}setCoordinates(t){if(!Array.isArray(t)){const e=this.getCenter(),n=t.sub(e);for(let t=0;t<this.kt.length;t++)this.kt[t].coordinates instanceof gh?this.kt[t].coordinates=this.kt[t].coordinates.add(n):(this.kt[t].coordinates[0]+=n.x,this.kt[t].coordinates[1]+=n.y);return this.u=!0,this}return this.ae=Array.isArray(t[0])?t.map((t=>new gh(t))):t,this.updateAllData("coordinates",this.ae),this.u=!0,this}getCoordinates(t){if(t&&this.kt&&this.kt.length){return this.kt[t.index].coordinates}return null}addData(t){this.kt||(this.kt=[]),this.kt.push(t);const e=this.getLayer();return e&&e.ce(),this.u=!0,this}removeData(t){this.kt.splice(t,1),this.ne&&this.ne.splice(t,1);const e=this.getLayer();return e&&e.ce(),this.u=!0,this}getData(t){return this.kt[t]}updateData(t,e,n){return this.kt[t][e]=n,this.u=!0,this}getAllData(){return this.kt}updateAllData(t,e){for(let n=0;n<this.kt.length;n++)this.updateData(n,t,e[n]);return this}removeAllData(){this.kt&&(this.kt=[],this.ne=[],this.u=!0)}Lt(){const t=this.getMap();if(this.kt&&t){this.le(),this.ne=this.ne||[];for(let t=0;t<this.kt.length;t++)if(!1!==this.kt[t].visible){const e=this.ue(t);this.ne[t]=e}}}openInfoWindow(t){let e=null;e=IX(t)&&this.kt[t]?this.kt[t].coordinates:this.getCenter(),super.openInfoWindow(e)}getCenter(){let t=0,e=0,n=0,i=0;for(let o=0,s=this.kt.length;o<s;o++){let s=this.kt[o].coordinates;s instanceof gh&&(s=s.toArray()),t+=s[0],e+=s[1],n+=s[2]||0,i++}return 0===i?null:mJ.set(t/i,e/i,n/i)}getMap(){return super.getMap()||this.i&&this.i.getMap()}fe(t){this.i=t}getLayer(){return super.getLayer()||this.i}le(){const t=this.getMap(),e=this.getCenter();if(!e)return;this.re=OX(t,e);const n=Q_(pJ,0,0,0);xy(this.oe,n,this.re,AJ)}ue(t){const e=this.kt[t],n=this.Ut(e.coordinates);if(!n)return null;const i=e_(gJ,n,this.re),o=this.Jt(e.translation||this.p.translation),s=Ny(gJ,o||this.p.translation,i||this.p.translation),a=e.rotation||this.p.rotation,l=this.de(t),h=Q_(pJ,a[0]||0,a[1]||0,a[2]||0);return xy(this.ne[t]||[],h,s,l)}de(t){const e=this.kt[t],{modelHeight:n,markerPixelHeight:i}=e,o=e.scale||this.p.scale;if(this.lt){if(i&&i>0){const t=this.dt(yJ,i);return By(t,t,o)}if(n){const t=this.ft(yJ,n);return By(t,t,o)}}return o}R(t){if(super.R(t),this.kt)for(let e=0;e<this.kt.length;e++){const n=this.kt[e];n.target&&n.target instanceof ct&&n.target.R(t)}}_(){super._(),this.Lt()}me(){this.ge={instance_vectorA:[],instance_vectorB:[],instance_vectorC:[],instance_color:[],aPickingId:[],aOutline:[],highlight_color:[],aBloom:[]},this.pe={instance_vectorA:[],instance_vectorB:[],instance_vectorC:[],instance_color:[],aPickingId:[],aOutline:[],highlight_color:[],aBloom:[]};for(let t=0;t<this.ne.length;t++){let e=this.ge;this.kt[t].bloom&&(e=this.pe);const n=this.ne[t],i=e.instance_vectorA.length/4;this._e(e,"instance_vectorA",i,n,0),this._e(e,"instance_vectorB",i,n,1),this._e(e,"instance_vectorC",i,n,2);const o=this.kt[t].color||dJ,s=this.kt[t].highlightColor||dJ;e.instance_color[4*i]=o[0],e.instance_color[4*i+1]=o[1],e.instance_color[4*i+2]=o[2],e.instance_color[4*i+3]=o[3],e.aPickingId[i]=this.X()+t,e.aOutline[i]=this.kt[t].outline?1:0,e.highlight_color[4*i]=s[0],e.highlight_color[4*i+1]=s[1],e.highlight_color[4*i+2]=s[2],e.highlight_color[4*i+3]=s[3],e.aBloom[i]=this.kt[t].bloom?1:0}return{attributesData:this.ge,bloomAttributesData:this.pe}}st(t){const{attributesData:e,bloomAttributesData:n}=this.It();for(const n in e)t.updateInstancedData(n,e[n]);if(this.regl?t.generateInstancedBuffers(this.regl):(this.Dt=this.Dt||[],this.Dt.push(t)),t.instanceCount=this.ge.instance_vectorA.length/4,this.xe()){const e=n,i=e.aBloom.length;t.properties.bloomMesh=t.properties.bloomMesh||new lw(e,i,t.geometry,t.material);const o=t.properties.bloomMesh;o.positionMatrix=t.positionMatrix,o.localTransform=t.localTransform;for(const t in e)o.updateInstancedData(t,e[t]);o.generateInstancedBuffers(this.regl);const s=t.getDefines();o.setDefines(s),o.uniforms=t.uniforms,o.bloom=1,o.instanceCount=i}else t.properties.bloomMesh&&(t.properties.bloomMesh.dispose(),delete t.properties.bloomMesh)}ye(t,e,n,i){this.pe[t]&&n&&(this.pe[t][4*e]=n[i],this.pe[t][4*e+1]=n[i+4],this.pe[t][4*e+2]=n[i+8],this.pe[t][4*e+3]=n[i+12])}xe(){return this.pe&&this.pe.aBloom.length}_e(t,e,n,i,o){t[e]&&i&&(t[e][4*n]=i[o],t[e][4*n+1]=i[o+4],t[e][4*n+2]=i[o+8],t[e][4*n+3]=i[o+12])}It(t){return!this.u&&this.ge?{attributesData:this.ge,bloomAttributesData:this.pe}:this.me(t)}it(){return this.oe}getCount(){return this.kt.length}ve(){return this.Lt(),this.pe?this.pe.aBloom.length:0}Ft(){return this.getCount()-this.ve()}toJSON(){const t=JSON.parse(JSON.stringify({data:this.kt,options:this.options,type:"MultiGLTFMarker"})),e=this.getProperties();return t.options&&(t.options.properties=e),t}getIndexByPickingId(t){return t-this.X()}outline(t){return IX(t)&&this.updateData(t,"outline",!0),this}cancelOutline(t){return IX(t)&&this.updateData(t,"outline",!1),this}isOutline(){if(!this.kt||!this.kt.length)return!1;for(let t=0;t<this.kt.length;t++)if(this.kt[t].outline)return!0;return!1}W(){const t=this.getAllData();for(let e=0;e<t.length;e++){const n=t[e].color;if(n&&n[3]<1)return!0}return!1}highlightNodes(t,e){const n=this.S;if(!n)return;const i=this.kt[t];i&&(e.forEach((t=>{n.forEach((e=>{if(e.properties.nodeIndex===t.nodeIndex){const{color:n,opacity:o,bloom:s}=t;i.highlightColor=n||_J,i.highlightColor[3]=o||1,i.highlightBloom=s;const a=e.getDefines();a.HAS_INSTANCE_HIGHLIGHT=1,e.setDefines(a)}}))})),this.u=!0)}highlight(t,e){const{color:n,opacity:i,bloom:o}=e,s=this.S;if(!s)return;const a=this.kt[t];a&&(a.highlightColor=n||_J,a.highlightColor[3]=i||1,a.highlightBloom=o,s.forEach((t=>{const e=t.getDefines();e.HAS_INSTANCE_HIGHLIGHT=1,t.setDefines(e)})),this.u=!0)}cancelHighlight(t,e){let n=this.S;if(!n)return;const i=this.kt[t];if(i){if(e){let t=e;Array.isArray(t)||(t=[t]),n=n.filter((e=>t.indexOf(e.properties.nodeIndex)>-1))}n.forEach((t=>{const e=t.getDefines();delete e.HAS_INSTANCE_HIGHLIGHT,t.setDefines(e),i.highlightColor=_J,i.highlightColor[3]=1,i.highlightBloom=0})),this.u=!0}}zoomAt(t,e={animation:!0,zoomOffset:0},n){const i=this.kt[t];if(!i)throw new Error("data item is not exist");const o=new gh(i.coordinates);return this.Xt(o,e,n)}}_t.registerJSONType("MultiGLTFMarker");const vJ=[],xJ=[],bJ=["points","lines","line strip","line loop"];class wt extends(SI(vm.OverlayLayerCanvasRenderer)){constructor(t){super(t),this.we={},this.be=[],this.Me={}}onAdd(){super.onAdd(),this.prepareWorker()}draw(t,e){this.prepareCanvas(),this.Se(e,t)}drawOnInteracting(t,e,n){this.Se(n,e)}Se(t,e){this.Oe=t,this.Te=e;let n=0;this.Ae(t),this.ke={},this.Pe(t);const i=this.Ce(t);this.Le(e);const o=t&&t.renderTarget?t.renderTarget.fbo:null;let s=0;for(const e in this.we){if("pointline"===e)continue;if(t){const{newShader:n,uniforms:o}=this.Ie(t,e);this.we[e].shader=n,hs.extend(i,o)}const a=this.Fe(e),l=this.we[e].shader;l.filter=t&&t.sceneFilter||null,s+=this.renderer.render(l,i,a,o),n++}const a=this.Fe("pointline");if(a.getMeshes().length){i.pointSize=this.layer.options.pointSize||1;const e=this.we.pointline.shader;e.filter=t&&t.sceneFilter||null,s+=this.renderer.render(e,i,a,o),n++}this.De(i,o),s&&this.layer.fire("canvasisdirty",{renderCount:s}),this.Ge=!0,this.completeRender(),this.layer.fire("rendercomplete-debug",{count:n})}De(t,e){this.Ne||(this.Ne=new _w);const n=this.layer.getGeometries(),i=[];for(let t=0;t<n.length;t++){if(!n[t].options.showDebugBoundingBox)continue;const e=n[t].ot();e&&i.push(e)}i.length&&(this.Ne.setMeshes(i),this.renderer.render(this.we.wireframe.shader,t,this.Ne,e))}Ee(t){const e=t.getUniform("polygonFill")||[1,1,1,1],n=t.getUniform("polygonOpacity")||1;return e[3]=n,{coordinates:t.getCoordinates(),translation:t.getTranslation(),rotation:t.getRotation(),scale:t.getScale(),visible:t.isVisible(),color:e,bloom:t.isBloom(),outline:t.isOutline(),modelHeight:t.getModelHeight(),markerPixelHeight:t.T(),anchorZ:t.getAnchorZ(),pickingId:t.X(),target:t}}Be(t){const e=this.Ee(t),n=new _t([e],{symbol:{url:t.getUrl(),shader:t.getShader(),shadow:t.isCastShadow()}});return n.Re=n.Re||[],t.je=!0,n.Re.push(t),n.fe(t.getLayer()),n}Ue(){for(const t in this.Me)this.Me[t].removeAllData()}ze(t,e){const n=t.getMeshes(this.N,this.regl,e),i=t.getShader();if(n.length){this.be.push(t),this.ke[i]=this.ke[i]||[],hs.pushIn(this.ke[i],n);for(let t=0;t<n.length;t++)n[t].properties.bloomMesh&&this.ke[i].push(n[t].properties.bloomMesh)}}Le(t){this.be.length=0;const e=this.layer.getGeometries();this.Je()&&this.Ue();for(let n=0;n<e.length;n++){const i=e[n],o=i.getUrl();if(i instanceof _t||i.isAnimated()||!i.je)this.ze(i,t);else if(this.Je()){const t=`${o}_${i.getShader()}_${i.isCastShadow()?1:0}`;this.Me[t]?this.Me[t].addData(this.Ee(i)):this.Me[t]=this.Be(i)}}for(const e in this.Me){const n=this.Me[e];n.createdBygltfmarker=!0,this.ze(n,t)}}Ce(){const t={};this.He.outSize=[this.canvas.width,this.canvas.height],this.He.halton=[0,0];t.layerOpacity=this.canvas.gl&&this.canvas.gl.wrap?this.layer.options.opacity||0:1,hs.extend(t,this.He);const e=this.getMaskUniforms();return hs.extend(t,e),t}Fe(t){const e=[],n=[];if("pointline"===t){for(const t in this.ke)"wireframe"!==t&&this.ke[t].forEach((t=>{bJ.indexOf(t.geometry.desc.primitive)>-1&&e.push(t)}));const t=new _w(e);return t.sortMeshes(this.He.cameraPosition),t}for(const e in this.ke){e===t&&this.ke[e].forEach((e=>{(bJ.indexOf(e.geometry.desc.primitive)<0||"wireframe"===t)&&n.push(e)}))}const i=this.Ve=this.Ve||new _w;return i.setMeshes(n),i.sortMeshes(this.He.cameraPosition),i}needToRedraw(){return!!super.needToRedraw()||this.Je()}Je(){const t=this.layer.getGeometries();for(let e=0;e<t.length;e++)if(this.be.indexOf(t[e])>-1&&(t[e].isDirty()||t[e].isAnimated()))return!0;return!1}onRemove(){this.workerConn&&(this.workerConn.removeLayer(this.layer.getId(),(t=>{if(t)throw t})),this.workerConn.remove(),delete this.workerConn),super.onRemove()}hitDetect(){return!1}createContext(){const t=this.canvas.gl&&this.canvas.gl.wrap;if(t)this.gl=this.canvas.gl.wrap(),this.regl=this.canvas.gl.regl;else{const t=this.layer.options.glOptions||{alpha:!0,depth:!0,stencil:!0};this.glOptions=t,this.gl=this.gl||this.Ze(this.canvas,t),this.regl=Dm({gl:this.gl,optionalExtensions:["ANGLE_instanced_arrays","OES_element_index_uint","OES_standard_derivatives","OES_vertex_array_object","OES_texture_half_float","OES_texture_half_float_linear","OES_texture_float","OES_texture_float_linear","WEBGL_depth_texture","EXT_shader_texture_lod","WEBGL_compressed_texture_s3tc"]})}t&&(this.canvas.pickingFBO=this.canvas.pickingFBO||this.regl.framebuffer(this.canvas.width,this.canvas.height)),this.pickingFBO=this.canvas.pickingFBO||this.regl.framebuffer(this.canvas.width,this.canvas.height),this.N=this.regl.gltfManager=this.regl.gltfManager||this.qe(),this.We(),this.Dt&&this.Dt.forEach((t=>{t.generateInstancedBuffers(this.regl)})),this.Ct&&this.Ct.forEach((t=>{t.generateBuffers(this.regl)})),this.layer.fire("contextcreate",{regl:this.regl})}getGLTFManager(){return this.N}qe(){return new tM(this.regl)}We(){const t=this.layer.getMap(),e=new cw(this.regl);this.renderer=e,this.He={projMatrix:t.projMatrix,projViewMatrix:t.projViewMatrix,viewMatrix:t.viewMatrix,cameraPosition:t.cameraPosition,altitudeScale:1},xC.PBRUtils.loginIBLResOnCanvas(this.canvas,this.regl,t),this.Xe=new zM(e,{vert:"#include <gl2_vert>\nattribute vec3 aPosition;\nuniform mat4 projMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 positionMatrix;\nuniform mat4 modelViewMatrix;\nuniform float pointSize;\n#include <fbo_picking_vert>\n#include <get_output>\nvoid main()\n{\n    mat4 localPositionMatrix = getPositionMatrix();\n    gl_Position = projMatrix * modelViewMatrix * localPositionMatrix * getPosition(aPosition);\n    gl_PointSize = pointSize;\n    fbo_picking_setData(gl_Position.w, true);\n}\n",uniforms:[{name:"modelViewMatrix",type:"function",fn:function(t,e){return cy([],e.viewMatrix,e.modelMatrix)}}]},this.pickingFBO,t)}prepareWorker(){this.workerConn||(this.workerConn=new NX("@ispace/gltf-layer",this.layer));const t=this.workerConn;if(!t.isActive())return;const e=this.layer.options||{},n=this.layer.getId();t.addLayer(n,{markerType:e.markerTypes,pointSize:e.pointSize},(t=>{if(t)throw t;this.layer&&(this.ready=!0,this.layer.fire("workerready"))}))}H(t){let e;if(this.layer.getURLModifier()){e=ZX(null,t,this.layer.options.fetchOptions,(t=>{const e=this.layer.getURLModifier();return e?e(t):t}))}else e=this.workerConn.loadGLTF(t);return e.then((t=>(this.setToRedraw(),this.Ye=!0,t))).catch((e=>{console.error(e),this.layer.fire("modelerror",{type:"modelerror",url:t,info:e})}))}Pe(t){const e=DX;for(const n in e){if(this.we[n])continue;const i=e[n];this.$e(t,i.name,i.type,i.config)}}$e(t,e,n,i){this.viewport||(this.viewport={x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1}),i.extraCommandProps||(i.extraCommandProps={});const o={};t&&this.Ke(o,vJ,t);const s=hs.extend({},i);s.extraCommandProps=hs.extend({},i.extraCommandProps),s.extraCommandProps.viewport=this.viewport,s.uniforms=hs.extend([],i.uniforms,vJ),s.defines=hs.extend({},s.defines,o),n.indexOf(".")>-1?(n=n.split("."),this.we[e]={shader:new wC[n[0]][n[1]](s),type:n}):this.we[e]={shader:new wC[n](s),type:n}}remove(){this.Qe();const t=this.we;for(const e in t)t[e].shader.dispose();this.extentShader&&this.extentShader.dispose(),super.remove()}clearCanvas(){this.canvas&&(this.regl.clear({color:[0,0,0,0],depth:1,stencil:0}),super.clearCanvas())}resizeCanvas(t){super.resizeCanvas(t),this.pickingFBO&&this.pickingFBO.resize(this.canvas.width,this.canvas.height),this.layer.fire("resizecanvas",{size:t})}getFrameTimestamp(){return this.Te}getFrameContext(){return this.Oe}needRetireFrames(){return this.Ye}Ke(t,e,n){const i=n&&n.includes;if(i)for(const o in i)i[o]&&(n[o].uniformDeclares&&(e.length=0,e.push(...n[o].uniformDeclares)),n[o].defines&&hs.extend(t,n[o].defines))}ti(t,e){const n=e&&e.includes;if(n)for(const i in n)n[i]&&e[i].renderUniforms&&hs.extend(t,e[i].renderUniforms)}Ie(t,e){const{shader:n,type:i}=this.we[e];let o=null;const s={};if(this.ti(s,t),t.states.includesChanged){const e={};this.Ke(e,vJ,t);const s={vert:n.vert,frag:n.frag,uniforms:n.uniforms,extraCommandProps:n.extraCommandProps};s.defines=e,s.uniforms=hs.extend([],s.uniforms,vJ),o=Array.isArray(i)?new wC[i[0]][i[1]](s):new wC[i](s),n.dispose()}else o=n;return{uniforms:s,newShader:o}}ei(t,e,n){if(t.viewshed){for(const e in t.viewshed.renderUniforms)n[e]=t.viewshed.renderUniforms[e];hs.extend(e.shaderDefines,t.viewshed.defines)}if(t.floodAnalysis){for(const e in t.floodAnalysis.renderUniforms)n[e]=t.floodAnalysis.renderUniforms[e];hs.extend(e.shaderDefines,t.floodAnalysis.defines)}return n}getShadowMeshes(){const t=[];if(!this.layer||!this.layer.isVisible()||!this.ke)return t;const e=this.layer.getGeometries();for(let n=0;n<e.length;n++)if(e[n].isCastShadow()&&e[n].isVisible()&&e[n].M()&&!e[n].je){hs.pushIn(t,e[n].S||[])}for(const e in this.Me){const n=this.Me[e];if(n.isCastShadow()&&n.isVisible()&&n.M()){hs.pushIn(t,n.S||[])}}return t}ii(){const t=[];if(!this.ke||!Object.keys(this.ke).length)return t;for(const e in this.ke)hs.pushIn(t,this.ke[e]);return t}getAnalysisMeshes(){return this.ii()}getRayCastData(t){const e=this.layer.getGeometries();for(let n=0;n<e.length;n++){const i=e[n].S;if(i&&i.indexOf(t)>-1)return e[n]}return null}drawOutline(t){this.extentShader||(this.extentShader=new zw({vert:"attribute vec3 aPosition;\nattribute float aOutline;\nuniform mat4 projMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 positionMatrix;\nuniform float instance;\n#include <get_output>\nvarying float vOutline;\nvoid main()\n{\n    mat4 localPositionMatrix = getPositionMatrix();\n    gl_Position = projMatrix * modelViewMatrix * localPositionMatrix * getPosition(aPosition);\n    if (instance == 0.0) {\n        vOutline = 1.0;\n    } else {\n        vOutline = aOutline;\n    }\n}\n",frag:"precision highp float;\nvarying float vOutline;\nvoid main() {\n    gl_FragColor = vec4(vOutline);\n}\n",uniforms:[{name:"modelViewMatrix",type:"function",fn:(t,e)=>cy([],e.viewMatrix,e.modelMatrix)}],positionAttribute:"POSITION",extraCommandProps:{viewport:this.viewport,cull:{enable:!1},blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}}));const e=this.getOutlineMeshes();e.length&&(this.si=this.si||new _w,this.si.setMeshes(e),this.renderer.render(this.extentShader,{projMatrix:this.He.projMatrix,viewMatrix:this.He.viewMatrix},this.si,t))}getOutlineMeshes(){const t=[];if(!this.layer)return t;const e=this.layer.getGeometries();for(let n=0;n<e.length;n++){if(e[n].je)continue;const i=e[n].Qt();hs.pushIn(t,i)}for(const e in this.Me){const n=this.Me[e].Qt();hs.pushIn(t,n)}return t}Qe(){this.canvas&&xC.PBRUtils.logoutIBLResOnCanvas(this.canvas,this.getMap())}Ae(t){const e=this.layer.getMap(),{iblTexes:n,dfgLUT:i}=xC.PBRUtils.getIBLResOnCanvas(this.canvas);if(e&&e.getLights()){const o=xC.PBRUtils.getPBRUniforms(e,n,i,t&&t.ssr,t&&t.jitter),s=e.getLights();this.He.ambientColor=s.ambient&&s.ambient.color?s.ambient.color:[.2,.2,.2],o&&hs.extend(this.He,o)}else{const n=xC.PBRUtils.getPBRUniforms(e,null,i,t&&t.ssr,t&&t.jitter);hs.extend(this.He,n)}}Ze(t,e){const n=["webgl","experimental-webgl"];let i=null;for(let o=0;o<n.length;++o){try{i=t.getContext(n[o],e)}catch(t){}if(i)break}return i}ni(t,e,n={}){if(!this.Xe||!this.layer.isVisible())return null;const i=this.layer.getMap();if(this.Ge||this.canvas.gl&&this.canvas.gl.wrap){if(!this.ke||!Object.keys(this.ke).length)return null;const t=this.ii(),e=hs.extend({},this.He);e.pointSize=this.layer.options.pointSize||1,this.Xe.render(t,e,!0),this.Ge=!1}const o=this.Xe[n.returnAll?"pickAll":"pick"](t,e,n.tolerance||3,{projMatrix:i.projMatrix,viewMatrix:i.viewMatrix,pointSize:this.layer.options.pointSize||1},{viewMatrix:i.viewMatrix,projMatrix:i.projMatrix,returnPoint:!0});if(o.length){const t={},e=[];for(let n=0;n<o.length;n++)if(!t[o[n].pickingId]){const i=this.ri(o[n]);t[o[n].pickingId]=!0,e.push(i)}return e}return this.ri(o)}ri(t){const{meshId:e,pickingId:n,point:i,coordinate:o}=t,s=this.ii()[e],a=this.oi(n);return{meshId:e,mesh:s,data:this.layer.hi()[a],pickingId:n,point:i,coordinate:o,index:n-a,nodeIndex:this.ai(e)}}ai(t){const e=this.ii()[t];return e&&e.properties.nodeIndex}oi(t){if(!IX(t))return null;if(this.layer.hi()[t])return t;const e=Object.keys(this.layer.hi()),n=e.length;let i=0,o=n-1,s=Math.floor((i+o)/2);for(;i<=n-1&&o>=0;){if(i===o)return e[i];if(e[s]<=t&&t<e[s+1])return e[s];t<e[s]?(o=s-1,s=Math.floor((i+o)/2)):e[s+1]<t&&(i=s+1,s=Math.floor((i+o)/2))}return null}isInFrustum(t){const e=this.layer.getMap(),n=t.getBoundingBox();if(!n||"multigltfmarker"===t.getGLTFMarkerType())return!0;const i=Ev(xJ,n.min,n.max);return!!Hj(e.projViewMatrix,i)}getRenderMeshesTest(){return this.ii()}isMarkerTransparent(t){return t.W()}getMarkerFitSizeScale(t){return t.ci()}getMarkerFitTranslate(t){return t.li()}getFBORayPicking(){return this.Xe}getShaderList(){return this.we}}const wJ=/\{ *([\w_]+) *\}/g;class Mt extends ct{constructor(t,e){super(t,e),this.l="effectmarker"}static fromJSON(t){return new Mt(t.coordinates,t.options)}isAnimated(){return!0}setTexture(t){const e=this.getLayer()&&this.getLayer().getRenderer();if(e){const n=this.getTextureUrl();e.ui(n),e.fi(t)}return super.updateSymbol({textureUrl:t}),this}di(t){const e=this.getTextureUrl(),n=this.getLayer()&&this.getLayer().getRenderer();if(n){let i=e;const o=this.mi();if(o){const n=this.isAnimationLooped(),s=this.getAnimationSpeed()||1,a=n?Math.floor(.01*t*s)%o.length:Math.floor(.01*t);i=e.replace(wJ,o[a]),this.setUniform("width",1),this.setUniform("height",1),this.setUniform("uvOffset",[0,0])}return n.gi(i,this.X())}return null}mi(){const t=this._getInternalSymbol();return t&&t.textureNames}getTextureUrl(){const t=this._getInternalSymbol();return t&&t.textureUrl||"default"}getUrl(){return"plane"}getShader(){return"effect"}setTransparent(t){return this.options.symbol.transparent=t,this}isTransparent(){return this.options.symbol.transparent}updateUV(t){const e=this.isAnimationLooped(),n=this.getAnimationSpeed()||1,i=this.getUniforms()||{},o=i.width||1,s=i.height||1;let a;const l=this.getEffectType();"uv"===l?a=e?.01*t*n%(o*s):.01*t:"sequence"===l&&(a=e?Math.floor(.01*t*n)%(o*s):Math.floor(.01*t));const h=Math.floor(a%o),c=Math.floor(a/o),u=this.di(t);this._getSymbol()?(this.setUniform("uvOffset",[h,c]),this.setUniform("width",o),this.setUniform("height",s),this.setUniform("texture",u)):this.D("uniforms",{uvOffset:[h,c],width:o,height:s,texture:u})}_setExternSymbol(t){super._setExternSymbol(t);const e=this.getLayer()&&this.getLayer().getRenderer();if(e){const t=this.getTextureUrl();e.fi(t)}}getEffectType(){const t=this._getInternalSymbol();return t&&t.effect||"uv"}setEffectType(t){return this._getInternalSymbol().effect=t,this}remove(){const t=this.getLayer()&&this.getLayer().getRenderer();if(t){const e=this.getTextureUrl();t.ui(e)}super.remove()}}const TJ=["Point","Polygon","LineString","MultiPoint","MultiPolygon","MultiLineString","GeometryCollection","Feature","FeatureCollection"].reduce(((t,e)=>(t[e]=!0,t)),{}),MJ={toGeometry:function(t,e){if(hs.isString(t)&&(t=hs.parseJSON(t)),Array.isArray(t)){const n=[];for(let i=0,o=t.length;i<o;i++){const o=MJ.pi(t[i],e);Array.isArray(o)?hs.pushIn(n,o):n.push(o)}return n}return MJ.pi(t,e)},pi:function(t,e){if(!t||hs.isNil(t.type))return null;const n=t.type;if("Feature"===n){const n=MJ.pi(t.geometry,e);return n?(n.setId(t.id),n.setProperties(t.properties),n):null}if("FeatureCollection"===n){const n=t.features;return n?MJ.toGeometry(n,e):null}if("Point"===n)return function(t,e){return"EffectLayer"===e?new Mt(t):new ct(t)}(t.coordinates,e);if("GeometryCollection"===n){const n=t.geometries,i=[],o=n.length;for(let t=0;t<o;t++)i.push(MJ.pi(n[t],e));return i}throw new Error("geometry's type is invalid, only support type of Point")},isGeoJSON:function(t){return!(!t||"object"!=typeof t||!t.type||!TJ[t.type]||t instanceof cf)}},CJ=/\{*(\$root)*\}/g;class At extends Wd{constructor(t,e,n){!e||e instanceof cf||Array.isArray(e)||TJ[e.type]||(n=e,e=null),super(t,null,n),this.pickingId=0,this._i={},this.xi={},this.yi={};this.setStyle(n&&n.style),e&&this.addGeometry(e)}static registerShader(t,e,n,i){DX[t]={name:t,type:e,config:n,uniforms:i}}static removeShader(t){delete DX[t]}static getShaders(){const t=[];for(const e in DX)t.push({shader:e,uniforms:DX[e].uniforms});return t}static getShaderMap(){return DX}addGeometry(t,e){let n=MJ.isGeoJSON(t)?MJ.toGeometry(t,this.getJSONType()):t;n=Array.isArray(n)?n:[n];for(let t=0;t<n.length;t++)if(!this.vi(n[t]))return void console.error("type of geometry is invalid");super.addGeometry(n,e),Array.isArray(n)&&this.addMarker(n)}addMarker(t){for(let e=0;e<t.length;e++){const n=t[e];n.qt(this.pickingId),this._i[this.pickingId]=n;const i=n.getId();i&&(this.yi[i]=n),n.fire("add",{type:"add",target:n,layer:this});const o=n.getUrl(),s=this.getRenderer();if(s&&s.Me[o]){n.fire("load",{type:"load",target:n,data:s.Me[o].I()})}if("multigltfmarker"===n.getGLTFMarkerType()){const t=n.getCount()||1;this.pickingId+=t}else this.pickingId++}}wi(t){const e=this.getRenderer();e&&e.loginGLTFMarker(t)}toJSON(t){t||(t={});const e={type:this.getJSONType(),id:this.getId(),options:this.config()};if((PX(t.style)||t.style)&&(e.style=this.getStyle()),PX(t.geometries)||t.geometries){const t=[],n=this._geoList;for(let e=0;e<n.length;e++){const i=n[e].Zt();t.push(i)}e.geometries=t}return e}vi(t){return!!t.getGLTFMarkerType&&this.options.markerTypes.indexOf(t.getGLTFMarkerType())>-1}setStyle(t){return t?(this.options.style=t,this.bi=JSON.parse(JSON.stringify(t)),this.Mi(),this.fire("setstyle",{target:this,style:this.bi}),this):(delete this.bi,delete this.options.style,this)}getStyle(){return this.options.style}updateSymbol(t,e){const n=this.getStyle();this.Si(t,e,n),this.Si(t,e,this.bi),this.Mi(),this.fire("updatesymbol",{target:this,index:t,symbol:e})}Si(t,e,n){if(!n)return;const i=(n.style?n.style:n)[t].symbol||{};for(const t in e)i[t]=e[t]}Mi(){this._processRootUrl(this.bi);this.Oi=qk(this.bi.style?this.bi.style:this.bi),this._geoList.forEach((function(t){this.Ti(t)}),this)}getGLTFUrls(){return Object.keys(this.xi)}_processRootUrl(t){hs.isString(t.$root)&&t.style.forEach((e=>{const n=e.symbol.url;n&&n.indexOf("{$root}")>-1&&(e.symbol.url=n.replace(CJ,t.$root))}))}Ti(t){if(!this.Oi)return!1;for(let e=0,n=this.Oi.length;e<n;e++)if(!0===this.Oi[e].filter({properties:t.getProperties()})){const n=this.Oi[e].symbol;return t.D("url",n.url),t.updateSymbol(n),!0}return!1}Ai(t){if(this.Oi)for(let e=0,n=this.Oi.length;e<n;e++)!0===this.Oi[e].filter({properties:t.getProperties()})&&this.Oi[e].outline&&t.outline()}ki(t){const e=hs.isString(t)?this.yi[t].X():t.X(),n=this.getRenderer();n&&n.Pi(e),delete this._i[e],delete this.yi[t]}clear(){return super.clear(),this._i={},this.yi={},this}hi(){return this._i}ni(t,e,n){const i=this.getRenderer();return i?i.ni(t,e,n):null}_isModelsLoadComplete(){const t=this._geoList;for(let e=0;e<t.length;e++)if(!t[e].isLoaded())return!1;return!0}Nt(t){const e=this.getRenderer();return e?e.Nt(t):null}U(t){const e=this.getRenderer();e&&e.U(t)}outlineBatch(t){const e=this.bi.style?this.bi.style:this.bi;e[t].outline=!0,this.Oi=qk(e),this._geoList.forEach((t=>{this.Ai(t)}))}outlineAll(){this._geoList.forEach((t=>{t.outline()}))}cancelOutline(){this.bi&&(this.bi.style?this.bi.style:this.bi).forEach((t=>{delete t.outline})),this._geoList.forEach((t=>{t.cancelOutline()}))}}At.mergeOptions({renderer:"gl",doubleBuffer:!1,glOptions:null,markerEvents:!0,forceRenderOnZooming:!0,forceRenderOnMoving:!0,forceRenderOnRotating:!0});class kt extends(aO(At)){static initDefaultShader(){const t={shader:{positionAttribute:"POSITION",normalAttribute:"NORMAL",extraCommandProps:{blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}},material:new $b};kt.registerShader("phong","PhongShader",t.shader,t.material.getUniforms());const e={shader:{positionAttribute:"POSITION",normalAttribute:"NORMAL",tangentAttribute:"TANGENT",colorAttribute:"COLOR_0",uv0Attribute:"TEXCOORD_0",uv1Attribute:"TEXCOORD_1",extraCommandProps:{cull:{enable:!0},frontFace:"ccw",blend:{enable:(t,e)=>!!e.meshConfig.transparent,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one minus src alpha",dstAlpha:"one minus src alpha"},equation:"add"}}},material:new xC.StandardMaterial({})};kt.registerShader("pbr","pbr.StandardShader",e.shader,e.material.getUniforms()),kt.registerShader("depth","pbr.StandardDepthShader",e.shader,e.material.getUniforms());const n={shader:{positionAttribute:"POSITION",color0Attribute:"COLOR_0",extraCommandProps:{blend:{enable:!1,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}},material:new Qb};kt.registerShader("pointline","PointLineShader",n.shader,n.material.getUniforms());const i={shader:{positionAttribute:"POSITION",extraCommandProps:{blend:{enable:!0,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one minus src alpha",dstAlpha:"one minus src alpha"},equation:"add"}}},material:new Qb({lineColor:[0,0,0,1],lineOpacity:1})};kt.registerShader("wireframe","EdgeShader",i.shader,i.material.getUniforms());const o={shader:{positionAttribute:"POSITION",normalAttribute:"NORMAL",extraCommandProps:{blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}},material:new ew};kt.registerShader("pbr-lite","StandardLiteShader",o.shader,o.material.getUniforms())}static fromJSON(t){if(!t||"GLTFLayer"!==t.type)return null;const e=new kt(t.id,t.options),n=t.geometries,i=[];for(let t=0;t<n.length;t++){const e=n[t].type,o=ct.getJSONClass(e);if(!o||!o.fromJSON)throw new Error("unsupported gltfmarker type:"+e);const s=o.fromJSON(n[t]);s&&i.push(s)}return e.addGeometry(i),t.style&&e.setStyle(t.style),e}setURLModifier(t){return this.Ci=t,this}getURLModifier(){return this.Ci}onAdd(){const t=this.getMap();this._geoList.forEach((e=>{IX(e.getZoomOnAdded())||e.setZoomOnAdded(t.getZoom())})),super.onAdd()}onRemove(){super.onRemove(),this.clear()}identify(t,e){const n=this.getMap();if(!n)return[];const i=n.coordinateToContainerPoint(new gh(t));return this.identifyAtPoint(i,e)}identifyAtPoint(t,e={}){const n=[];if(!e.excludeMasks){const i=this.identifyMask(t,e);i&&i.length&&hs.pushIn(n,i)}const i=this.getMap();if(!i)return[];const o=i.getDevicePixelRatio(),s=this.ni(t.x*o,t.y*o,e);if(s&&(s.data||s.length))if(e.includeInternals&&!e.excludeMasks){n.push(s.data);const t=e.domEvent;t&&(t.gltfPickingInfo=t.gltfPickingInfo||{},t.gltfPickingInfo[this.getId()]=s)}else n.push(s);return e&&e.filter&&!e.excludeMasks?n.filter((t=>e.filter(t.data||t))):n}ce(){this.pickingId=0;const t={};for(const e in this._i){const n=this._i[e];n.qt(this.pickingId),n.C(!0),t[this.pickingId]=n;const i=n.getCount()||1;this.pickingId+=i}this._i=t}_onGeometryEvent(t){if(!t||!t.target)return;const e=t.type;if("meshcreate"===e)this.Li(t);else if("modelerror"===e)this.Ii(t);else if("positionchange"===e){const t=this.getRenderer();t&&t.setToRedraw()}super._onGeometryEvent(t)}Ii(t){const{url:e,info:n}=t;console.error(n),this.fire("modelerror",{type:"modelerror",url:e,info:n})}Li(t){this.xi[t.url]=1,this.getRenderer().setToRedraw(),this._isModelsLoadComplete()&&this.fire("modelload",{models:this.getGLTFUrls()})}}kt.initDefaultShader(),kt.mergeOptions({markerTypes:["gltfmarker","multigltfmarker"],pointSize:1}),kt.registerJSONType("GLTFLayer"),kt.registerRenderer("gl",wt);const SJ=new gh(0,0),PJ=new _e(0,0),IJ=new _e(0,0),OJ=new _e(0,0);const EJ=new gh(0,0),kJ=[],RJ=new _e(0,0),LJ=new _e(0,0);class Rt extends _t{constructor(t,e){super(null,e),this.on("load",(()=>{this.setCoordinates(t)}))}static fromJSON(t){return new Rt(t.data,t.options)}setCoordinates(t){this.ae=t,this.Fi()}getCoordinates(){return this.ae}toJSON(){const t=JSON.parse(JSON.stringify({coordinates:this.ae,options:this.options,type:"GLTFLineString"})),e=this.getId();hs.isNil(e)||(t.options.id=e);const n=this.getProperties();return t.options&&(t.options.properties=n),t}Fi(){const t=this.ae;if(!t)return;this.removeAllData();const e=this.getMap(),n=e.getGLRes(),i=e.getProjection(),o=this.Di();for(let s=0;s<t.length-1;s++){const a=this.Gi(t[s]),l=this.Gi(t[s+1]),h=e.coordinateToPointAtRes(a,n,RJ),c=e.coordinateToPointAtRes(l,n,LJ),u=this.Ni(a,l),f=i.measureLenBetween(a,l);this.gltfPack.arrangeAlongLine(h,c,f,o,u,this.options).forEach((t=>{t.coordinates=DJ(a,l,t.t),this.addData(t)}))}this.u=!0}Di(){const t=[1,1,1],e=this.getModelHeight();e&&this.ft(t,e);const n=this.getSymbol();return Fy(kJ,hs.isNil(n.scaleX)?1:n.scaleX,hs.isNil(n.scaleY)?1:n.scaleY,hs.isNil(n.scaleZ)?1:n.scaleZ),By(t,t,kJ)}Ni(t,e){const n=this.getMap(),i=n.getGLRes();return EJ.set(0,(t.y+e.y)/2),n.altitudeToPoint(100,i,EJ)/n.altitudeToPoint(100,i)}Gi(t){return Array.isArray(t)?new gh(t):t}}function DJ(t,e,n){const i=FJ(t.x,e.x,n),o=FJ(t.y,e.y,n),s=FJ(t.z||0,e.z||0,n);return new t.constructor(i,o,s)}function FJ(t,e,n){return t+n*(e-t)}Rt.mergeOptions({direction:0,gapLength:0,scaleVertex:!0}),Rt.registerJSONType("GLTFLineString");const NJ=new Iw({url:void 0,mag:"linear"});class Jt extends(SI(wt)){constructor(t){super(t),this._textureMap={}}gi(t){return this.regl&&this._textureMap[t]?this._textureMap[t].texture.getREGLTexture(this.regl):NJ}fi(t){if(this._textureMap[t])this._textureMap[t].count++;else{this.Ei=this.Ei||new dw;const e=new Iw({url:"default"===t?void 0:t,mag:"linear"},this.Ei);e.once("complete",(()=>{this.setToRedraw()}),this),this._textureMap[t]={count:1,texture:e}}}ui(t){this._textureMap[t]&&(this._textureMap[t].count--,this._textureMap[t].count<1&&(this._textureMap[t].texture.dispose(),delete this._textureMap[t]))}}class Ht extends(aO(At)){static initDefaultShader(){const t={shader:{vert:"\n        attribute vec3 aPosition;\n        attribute vec2 aTexCoord;\n        uniform mat4 projViewMatrix;\n        uniform mat4 modelMatrix;\n        uniform vec2 uvOffset;\n        uniform float width;\n        uniform float height;\n        varying vec2 vTexCoords;\n        void main()\n        {\n            gl_Position = projViewMatrix * modelMatrix * vec4(aPosition, 1.0);\n            vTexCoords = (uvOffset + aTexCoord) * vec2(1.0 / width, 1.0 / height);\n        }\n    ",frag:"\n        precision mediump float;\n        uniform sampler2D texture;\n\n        varying vec2 vTexCoords;\n        void main() {\n            vec4 color = texture2D(texture, vTexCoords);\n            gl_FragColor = vec4(color.rgb, color.a) * color.a;\n        }\n    ",positionAttribute:"POSITION",extraCommandProps:{blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"},depth:{enable:!0,func:"always",mask:!0,range:[0,0]}}},material:new Qb};Ht.registerShader("effect","MeshShader",t.shader,t.material.getUniforms())}onAddGeometry(t){super.onAddGeometry(t);const e=t.getTextureUrl(),n=this.getRenderer();n?n.fi(e):this.on("renderercreate",(t=>{t.renderer.fi(e)}))}remove(){const t=this.getRenderer();t&&this._geoList.forEach((e=>{const n=e.getTextureUrl();t.ui(n)})),super.remove()}clear(){const t=this.getRenderer();t&&this._geoList.forEach((e=>{const n=e.getTextureUrl();t.ui(n)})),super.clear()}getTextureMapTest(){const t=this.getRenderer();return t?t._textureMap:null}}Ht.initDefaultShader(),Ht.mergeOptions({markerTypes:["effectmarker"]}),Ht.registerJSONType("EffectLayer"),Ht.registerRenderer("gl",Jt);class Vt extends ct{constructor(t,e){super(t,e),this.l="glowmarker"}static fromJSON(t){return new Vt(t.coordinates,t.options)}getUrl(){return"plane"}setSpeed(t){this.setUniform("speed",t)}getSpeed(){return this._getInternalSymbol().uniforms.speed}getShader(){return"glowmarker"}isAnimated(){const t=this._getInternalSymbol();return t&&t.animation}Z(){let t=this._getInternalSymbol().uniforms.time||0;t+=.01,this.setUniform("time",t)}}Vt.mergeOptions({visible:!0});class Zt extends At{static initDefaultShader(){const t=function(){const t={vert:"\n        #ifdef GL_ES\n            precision highp float;\n        #endif\n        attribute vec3 aPosition;\n        uniform mat4 projViewModelMatrix;\n        uniform mat4 modelMatrix;\n        uniform mat4 positionMatrix;\n        varying vec3 v_FragPos;\n        varying vec3 v_center;\n        #include <get_output>\n        void main(){\n            mat4 localPositionMatrix = getPositionMatrix();\n            vec4 localVertex = getPosition(aPosition);\n            vec4 position = localPositionMatrix * localVertex;\n            gl_Position = projViewModelMatrix * position;\n            vec4 worldPos = modelMatrix * position;\n            v_FragPos = worldPos.xyz;\n            v_center = (modelMatrix * vec4(0.0, 0.0, 0.0, 1.0)).xyz;\n        }\n    ",frag:"\n        #ifdef GL_ES\n            precision highp float;\n        #endif\n        #define pi 3.14159\n        const float dotsnb = 30.0; // Number of dots\n\n        varying vec3 v_FragPos;\n        varying vec3 v_center;\n        uniform float time;\n        uniform float radius;\n        uniform vec3 color;\n        uniform float speed;\n        vec3 hsb2rgb(in vec3 c)\n        {\n            vec3 rgb = clamp(abs(mod(c.x*6.0+vec3(0.0,4.0,2.0),6.0)-3.0)-1.0,0.0,1.0 );\n            rgb = rgb*rgb*(4.0-2.0*rgb);\n            return c.z * mix( vec3(1.0), rgb, c.y);\n        }\n\n        void main()\n        {\n            float r = length(v_FragPos - v_center);\n            r = r*2.-1.;\n            if(r>radius) {\n                gl_FragColor = vec4(1.0,1.0,1.0, 0.0);\n            } else {\n                //vec3 color = hsb2rgb(vec3(fract(time*.1),.7,.4));\n                vec3 color = color;\n                float s = abs(sin(pow(r+5.0, 1.5)-time*speed+sin(r*0.9))*sin(r+.99));\n                color *= (abs(1./(s*10.8))-.01);\n                gl_FragColor = vec4(color, (color.x + color.y + color.z) / 1.0);\n            }\n        }\n    ",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){return cy([],e.projViewMatrix,e.modelMatrix)}}],positionAttribute:"POSITION",extraCommandProps:{blend:{enable:!0,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one",dstAlpha:1},equation:{rgb:"add",alpha:"add"},color:[0,0,0,0]}}};return{shader:t,material:new Qb}}();Zt.registerShader("glowmarker","MeshShader",t.shader,t.material.getUniforms())}}Zt.initDefaultShader(),Zt.mergeOptions({markerTypes:["glowmarker"]}),Zt.registerJSONType("GlowMarkerLayer"),Zt.registerRenderer("gl",wt);const HJ={url:"plane",animation:!0,loop:!0,rotation:[0,0,0],translation:[0,0,30],scale:[1,1,30]},BJ={width:1,height:1,modelHeight:60,startOpacity:0,endOpacity:1};class Yt extends At{static initDefaultShader(){const t={shader:{vert:"\n        attribute vec3 aPosition;\n        attribute vec2 aTexCoord;\n        uniform mat4 projViewMatrix;\n        uniform mat4 modelMatrix;\n        uniform vec2 uvOffset;\n        uniform float width;\n        uniform float height;\n        varying vec2 vTexCoords;\n        varying float vHeight;\n        void main()\n        {\n            vec4 worldPosition = modelMatrix * vec4(aPosition, 1.0);\n            gl_Position = projViewMatrix * worldPosition;\n            vHeight = worldPosition.z;\n            vTexCoords = (uvOffset + aTexCoord) * vec2(1.0 / width, 1.0 / height);\n        }\n    ",frag:"\n        precision mediump float;\n        uniform sampler2D texture;\n        uniform float modelHeight;\n        uniform float startOpacity;\n        uniform float endOpacity;\n        varying float vHeight;\n        varying vec2 vTexCoords;\n        void main() {\n            vec4 color = texture2D(texture, vTexCoords);\n            float opacity = (endOpacity - startOpacity) * (1.0 - vHeight / modelHeight);\n            gl_FragColor = vec4(color.rgb, color.a) * color.a * opacity;\n        }\n    ",positionAttribute:"POSITION",extraCommandProps:{blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"}}},material:new Qb};Yt.registerShader("effectline","MeshShader",t.shader)}}Yt.initDefaultShader(),Yt.mergeOptions({markerTypes:["effectmarker"]}),Yt.registerJSONType("EffectLineLayer"),Yt.registerRenderer("gl",Jt);const zJ={offsetX:0,offsetY:0,uReflectivity:.8,opacity:.9,color:[.9,0,0,1]};class Qt extends At{static initDefaultShader(){const t=function(){const t={vert:"\n        attribute vec3 aPosition;\n        attribute vec2 aTexCoord;\n        attribute vec3 aNormal;\n        uniform mat4 projViewMatrix;\n        uniform mat4 modelMatrix;\n        uniform mat4 normalMatrix;\n        uniform float offsetX;\n        uniform float offsetY;\n        varying vec2 uv;\n        void main()\n        {\n            gl_Position = projViewMatrix * modelMatrix * vec4(aPosition, 1.0);\n            uv = vec2(aTexCoord.x + offsetX, aTexCoord.y + offsetY);\n        }\n    ",frag:"\n        precision mediump float;\n        uniform sampler2D effectTexture;\n        uniform vec3 uCameraPosition;\n        uniform mat4 viewMatrix;\n        uniform float uReflectivity;\n        uniform vec4 color;\n        uniform float opacity;\n\n        varying vec2 uv;\n\n        vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {\n            return normalize((vec4(dir, 0.0) * matrix).xyz);\n        }\n\n        const float GAMMA_FACTOR = 2.0;\n        vec4 GammaToLinear(in vec4 value, in float gammaFactor) {\n            return vec4(pow(value.xyz, vec3(gammaFactor)), value.w);\n        }\n\n        vec4 mixTexelToLinear(vec4 value) {\n            return GammaToLinear(value, float(GAMMA_FACTOR));\n        }\n\n        void main() {\n            vec4 texColor = texture2D(effectTexture, uv);\n            if (color.a == 0.0) {\n                discard;\n            }\n            vec4 mixColor = mixTexelToLinear(color);\n            texColor.rgb += mixColor.xyz * uReflectivity;\n            texColor.a*= opacity;\n            gl_FragColor = texColor;\n        }\n    ",uniforms:[{name:"normalMatrix",type:"function",fn:function(t,e){const n=[];return hy(n,e.modelMatrix),ly(n,n),n}}],positionAttribute:"POSITION",extraCommandProps:{depth:{enable:!0,mask:!1},blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"}}};return{shader:t,material:new Qb}}();Qt.registerShader("effectring","MeshShader",t.shader)}}Qt.initDefaultShader(),Qt.mergeOptions({markerTypes:["effectring"]}),Qt.registerJSONType("EffectRingLayer"),Qt.registerRenderer("gl",wt);const GJ={animation:!0,loop:!0,url:"plane",effect:"sequence",speed:1,scale:[1,1,1],rotation:[90,0,0]},jJ={width:9,height:5};if(GC){const t=Lf.VERSION;if(t.indexOf("1.0.0-beta")>=0||t.indexOf("1.0.0-alpha")>=0){va("@ispace/gltf-layer",GC.inject(SX))}else va("@ispace/gltf-layer",(function(){return GC.inject(SX)}))}else va("@ispace/gltf-layer",SX);"undefined"!=typeof console&&console.log("@ispace/gltf-layer v0.105.4");
/*!
   * @ispace/transform-control v0.105.9
   * LICENSE : UNLICENSED
   * (c) 2016-2026 ispace.org
   */
const UJ={yuanhuan:{accessors:[{name:"_1_0_positions",componentType:5126,count:104,min:[-5.407599925994873,-5.404099941253662,0],max:[5.405200004577637,5.406300067901611,0],type:"VEC3",bufferView:0,byteOffset:0},{name:"_1_0_normals",componentType:5126,count:104,min:[0,0,1],max:[0,0,1],type:"VEC3",bufferView:1,byteOffset:0},{name:"_1_0_indices",componentType:5123,count:288,min:[0],max:[103],type:"SCALAR",bufferView:2,byteOffset:0}],asset:{generator:"obj2gltf",version:"2.0"},buffers:[{name:"-",byteLength:3072,uri:"data:application/octet-stream;base64,KVyjQLbzPT4AAAAAZvesQLbzPT4AAAAAhsmqQC7/YT8AAAAAZ0ShQDC7Vz8AAAAA+u2lwGKhxr8AAAAArK2cwLpJvL8AAAAAEFihwB04V78AAAAAXdyqwE7RYb8AAAAAat6lQEaUxj8AAAAAApqcQG+BvD8AAAAAB18EQFOWlcAAAAAA+u0LQLBynsAAAAAARPoxQNSalMAAAAAAJzEoQIxKjMAAAAAAQBNVQFyPiMAAAAAAIEFJQMDsgMAAAAAA0950QK36dMAAAAAAejZnQFRSZ8AAAAAAXdyAQBBYScAAAAAA+n6IQI0oVcAAAAAAcoqUQAMJMsAAAAAAKjqMQIlBKMAAAAAAXdyAQFdbSUAAAAAA+n6IQDsBVUAAAAAA0950QBTQdEAAAAAAejZnQA5PZ0AAAAAA+n6IwI0oVcAAAAAAwOyAwBBYScAAAAAAXkuMwIlBKMAAAAAA0ZGUwAMJMsAAAAAA5j+8P9ejnMAAAAAAkDFXP65HocAAAAAA1JrGPz7opcAAAAAA/7I7PvhTo8AAAAAA/7I7PmPurMAAAAAAM8RhP/vLqsAAAAAADwutwLbzPT4AAAAA0m+jwLbzPT4AAAAAEFihwDC7Vz8AAAAAXdyqwC7/YT8AAAAArK2cwG+BvD8AAAAA+u2lwEaUxj8AAAAADXGewN/gC0AAAAAAa5qVwIV8BEAAAAAAXkuMwAFNKEAAAAAA0ZGUwD7oMUAAAAAAlIeVQIV8BEAAAAAAlWWeQN/gC0AAAAAAcoqUQD7oMUAAAAAAKjqMQAFNKEAAAAAAQBNVQBB6iEAAAAAAIEFJQKfogEAAAAAAW9N0wK36dMAAAAAAsVBnwFRSZ8AAAAAAlWWeQM/3C8AAAAAAlIeVQNxoBMAAAAAA+n6IwDsBVUAAAAAAwOyAwFdbSUAAAAAAsVBnwA5PZ0AAAAAAW9N0wBTQdEAAAAAAd74LwLBynsAAAAAAkxi8v9ejnMAAAAAAwFsEwFOWlcAAAAAARpRWv65HocAAAAAAayvGvz7opcAAAAAA2c43vvhTo8AAAAAA2c43vmPurMAAAAAAt9Fgv/vLqsAAAAAAt9Fgv7fRqkAAAAAAayvGvybkpUAAAAAAd74LwAponkAAAAAA2c43vv5lo0AAAAAA2c43vmkArUAAAAAARpRWvzxOoUAAAAAAkxi8v9ejnEAAAAAAOdYxwHKKlEAAAAAAwFsEwDqSlUAAAAAA+zoowNBEjEAAAAAAJlNJwKfogEAAAAAAUPxUwBB6iEAAAAAAat6lQGKhxr8AAAAAApqcQLpJvL8AAAAAhsmqQE7RYb8AAAAAZ0ShQB04V78AAAAAZvesQP+yO74AAAAAKVyjQP+yO74AAAAAM8RhP7fRqkAAAAAA/7I7PmkArUAAAAAA/7I7Pv5lo0AAAAAA+u0LQAponkAAAAAA1JrGPybkpUAAAAAAkDFXPzxOoUAAAAAA5j+8P9ejnEAAAAAARPoxQHKKlEAAAAAAB18EQDqSlUAAAAAAJzEoQNBEjEAAAAAA+zoowIxKjMAAAAAAOdYxwNSalMAAAAAAUPxUwFyPiMAAAAAAJlNJwMDsgMAAAAAAa5qVwNxoBMAAAAAADXGewM/3C8AAAAAA0m+jwP+yO74AAAAADwutwP+yO74AAAAAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAABAAIAAAACAAMABAAFAAYABAAGAAcAAwACAAgAAwAIAAkACgALAAwACgAMAA0ADQAMAA4ADQAOAA8ADwAOABAADwAQABEAEgATABQAEgAUABUAFgAXABgAFgAYABkAGgAbABwAGgAcAB0AHgALAAoAHwALAB4AHwAgAAsAIQAgAB8AIgAjACAAIgAgACEAJAAlACYAJAAmACcAJwAmACgAJwAoACkAKgArACwAKgAsAC0ALgAvADAALgAwADEAGQAYADIAGQAyADMANAA1ABsANAAbABoAFQAUADYAFQA2ADcAOAA5ADoAOAA6ADsAPAA9AD4APAA/AD0AQAA/ADwAQABBAD8AQgBBAEAAQgBAAEMARABFAEYARABGAEcARABHAEgARgBJAEcARgBKAEkASwBKAEYASwBMAEoASwBNAEwACQAIAC8ACQAvAC4ALQAsADkALQA5ADgAOwA6AE4AOwBOAE8ATwBOAE0ATwBNAEsAKQAoACsAKQArACoANwA2AFAANwBQAFEAUQBQAFIAUQBSAFMAUwBSAFQAUwBUAFUAVgBXAFgAVgBYAFkAVgBZAFoAWwBZAFgAXABZAFsAXABdAFkAXgBdAFwAXwBdAF4APAA+AGAAPABgAGEAMQAwABcAMQAXABYAYgBjADUAYgA1ADQAYQBgAGMAYQBjAGIAMwAyAF0AMwBdAF8AHQAcAGQAHQBkAGUAZQBkAAUAZQAFAAQAZgBnAAcAZgAHAAYAEQAQABMAEQATABIA"}],bufferViews:[{name:"bufferView_0",buffer:0,byteLength:1248,byteOffset:0,byteStride:12,target:34962},{name:"bufferView_1",buffer:0,byteLength:1248,byteOffset:1248,byteStride:12,target:34962},{name:"bufferView_2",buffer:0,byteLength:576,byteOffset:2496,target:34963}],materials:[{name:"SVGMat_001",pbrMetallicRoughness:{baseColorFactor:[.5,.5,.5,1],metallicFactor:0,roughnessFactor:1},emissiveFactor:[0,0,0],alphaMode:"OPAQUE",doubleSided:!1}],meshes:[{name:"_1",primitives:[{attributes:{POSITION:0,NORMAL:1},indices:2,material:0,mode:4}]}],nodes:[{name:"",mesh:0}],scene:0,scenes:[{nodes:[0]}]},yuanhuan41:{accessors:[{name:"_1_0_positions",componentType:5126,count:39,min:[0,0,0],max:[5.489999771118164,0,5.488900184631348],type:"VEC3",bufferView:0,byteOffset:0},{name:"_1_0_normals",componentType:5126,count:39,min:[0,-.999939501285553,-1],max:[.13969914615154266,1,1],type:"VEC3",bufferView:1,byteOffset:0},{name:"_1_0_indices",componentType:5123,count:105,min:[0],max:[38],type:"SCALAR",bufferView:2,byteOffset:0}],asset:{generator:"obj2gltf",version:"2.0"},buffers:[{name:"yh41",byteLength:1148,uri:"data:application/octet-stream;base64,8tKXQAAAAACoNU09FK6vQAAAAAB1Ako/FK6vQAAAAAAAAACATfOAQAAAAAACmkg+K4dWQAAAAAAIrNw+WvUtQAAAAABbsT8/X5gIQAAAAACMSpI/OUWbQAAAAAD0/VQ/LbKHQAAAAAD0/XQ/W0JqQAAAAAC6SZQ/dLXNPwAAAACfq80/H4VHQAAAAAB0JLc/ZognQAAAAAA1XuI/YVSSPwAAAAAukAhABaMKQAAAAAB4nApABcU/PwAAAACF6y1Aw2TiPwAAAACRfidASS63PwAAAABKe0dAJLncPgAAAACze1ZAj1OUPwAAAADjNmpAAppIPgAAAADu64BAnRF1PwAAAAD8qYdAqDVNPQAAAADBypdAgQRVPwAAAAAIPZtAAAAAAAAAAAASpa9AAwlKPwAAAAASpa9AJJd/PAAAAAASpa9AAwlKPwAAAAASpa9AAAAAAAAAAAASpa9Asp1vPQAAAAASpa9AJLn8PQAAAAASpa9AqoJRPgAAAAASpa9ARwOYPgAAAAASpa9AHhbKPgAAAAASpa9A2hv8PgAAAAASpa9A5q4VPwAAAAASpa9A+n4qPwAAAAASpa9AQxw7PwAAAAASpa9AwhdGPwAAAAASpa9AAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAJ5X/OwL+fz8AAACAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAIC/Kzs0PAn8f78AAACApLK/PA7uf78AAACAeJkZPefRfz8AAACA+ZldPQSgf78AAACA6XSTPelVfz8AAACALLO3PdT3fr8AAACAfkjZPR2Ofr8AAACANf32Paohfj8AAACAeUYHPqDBfT8AAACASw0PPlt9fb8AAACAAAABAAIAAwABAAAABAABAAMABQABAAQABgAHAAUABwABAAUABgAIAAcABgAJAAgACgAJAAYACgALAAkACgAMAAsADQAMAAoADQAOAAwADwAOAA0ADwAQAA4ADwARABAAEgARAA8AEgATABEAFAATABIAFAAVABMAFgAVABQAFgAXABUAGAAXABYAGAAZABcAGgAbABwAHQAbABoAHgAbAB0AHwAbAB4AIAAbAB8AIQAbACAAIgAbACEAIwAbACIAJAAbACMAJQAbACQAJgAbACUAAAA="}],bufferViews:[{name:"bufferView_0",buffer:0,byteLength:468,byteOffset:0,byteStride:12,target:34962},{name:"bufferView_1",buffer:0,byteLength:468,byteOffset:468,byteStride:12,target:34962},{name:"bufferView_2",buffer:0,byteLength:212,byteOffset:936,target:34963}],materials:[{name:"SVGMat_002",pbrMetallicRoughness:{baseColorFactor:[.588,.588,.588,1],metallicFactor:0,roughnessFactor:.99},emissiveFactor:[0,0,0],alphaMode:"OPAQUE",doubleSided:!1}],meshes:[{name:"_1",primitives:[{attributes:{POSITION:0,NORMAL:1},indices:2,material:0,mode:4}]}],nodes:[{name:"",mesh:0}],scene:0,scenes:[{nodes:[0]}]},yuanhuan411:{accessors:[{name:"_1_0_positions",componentType:5126,count:28,min:[.026000000536441803,-4.6834001541137695,0],max:[4.696700096130371,-.014800000004470348,0],type:"VEC3",bufferView:0,byteOffset:0},{name:"_1_0_normals",componentType:5126,count:28,min:[0,0,1],max:[0,0,1],type:"VEC3",bufferView:1,byteOffset:0},{name:"_1_0_indices",componentType:5123,count:78,min:[0],max:[27],type:"SCALAR",bufferView:2,byteOffset:0}],asset:{generator:"obj2gltf",version:"2.0"},buffers:[{name:"yuanhuan411",byteLength:828,uri:"data:application/octet-stream;base64,ufwXQLN7Mr8AAAAAObRAQLFQK78AAAAA1ediQMWP8b4AAAAAGQQ6QCv2174AAAAAqFdeQHUCWr4AAAAA7FGCQL6fmr0AAAAAHHyDQDLmrr4AAAAAXkuWQJf/kL4AAAAAXkuWQLN7crwAAAAAMCrxP2RdhL8AAAAA/BgDQJeQn78AAAAADeARQAg9i78AAAAAukkIQISeXb8AAAAAZaogQH/Zbb8AAAAA7Q3ePr4wOcAAAAAA5IMuP9/gP8AAAAAAJQZxPwrXH8AAAAAAPZs1P6UsF8AAAAAAdy2hP0VHAsAAAAAAb/CFP5eQ778AAAAA0ES4P32utr8AAAAAAprQPyL9zr8AAAAAi/1lPqqCXcAAAAAA9dv3PtcSYsAAAAAADi2yPZvmgcAAAAAAYTK1PssQg8AAAAAA9P3UPGrelcAAAAAA4liXPmrelcAAAAAAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAABAAIAAAACAAMAAwACAAQABQAGAAcABQAHAAgABAACAAYABAAGAAUACQAKAAsACQALAAwAAAANAAEADgAPABAADgAQABEAEQAQABIAEQASABMAFAAVAAoAFAAKAAkADAALAA0ADAANAAAAFgAXAA8AFgAPAA4AGAAZABcAGAAXABYAGgAZABgAGgAbABkAEwASABUAEwAVABQA"}],bufferViews:[{name:"bufferView_0",buffer:0,byteLength:336,byteOffset:0,byteStride:12,target:34962},{name:"bufferView_1",buffer:0,byteLength:336,byteOffset:336,byteStride:12,target:34962},{name:"bufferView_2",buffer:0,byteLength:156,byteOffset:672,target:34963}],materials:[{name:"SVGMat",pbrMetallicRoughness:{baseColorFactor:[.588,.588,.588,1],metallicFactor:0,roughnessFactor:.99},emissiveFactor:[0,0,0],alphaMode:"OPAQUE",doubleSided:!1}],meshes:[{name:"_1",primitives:[{attributes:{POSITION:0,NORMAL:1},indices:2,material:0,mode:4}]}],nodes:[{name:"",mesh:0}],scene:0,scenes:[{nodes:[0]}]},yuanpan:{accessors:[{name:"Circle001_1_0_positions",componentType:5126,count:28,min:[-1.9510999917984009,0,-1.9510999917984009],max:[1.9510999917984009,0,1.9510999917984009],type:"VEC3",bufferView:0,byteOffset:0},{name:"Circle001_1_0_normals",componentType:5126,count:28,min:[0,1,0],max:[0,1,0],type:"VEC3",bufferView:1,byteOffset:0},{name:"Circle001_1_0_indices",componentType:5123,count:78,min:[0],max:[27],type:"SCALAR",bufferView:2,byteOffset:0}],asset:{generator:"obj2gltf",version:"2.0"},buffers:[{name:"yuanpan",byteLength:828,uri:"data:application/octet-stream;base64,S+rkvgAAAADRIvM/AAAAAAAAAAClvfk/S+rkPgAAAADRIvM/0SLzvwAAAABL6uQ+MlXgvwAAAACsi1s/c9fCvwAAAACvJZw/pb35vwAAAAAAAAAA0SLzvwAAAABL6uS+MlXgvwAAAACsi1u/c9fCvwAAAACvJZy/ryWcvwAAAABz18K/rItbvwAAAAAyVeC/S+rkvgAAAADRIvO/AAAAgAAAAAClvfm/S+rkPgAAAADRIvO/rItbPwAAAAAyVeC/ryWcPwAAAABz18K/c9fCPwAAAACvJZy/MlXgPwAAAACsi1u/0SLzPwAAAABL6uS+pb35PwAAAAAAAACA0SLzPwAAAABL6uQ+MlXgPwAAAACsi1s/c9fCPwAAAACvJZw/ryWcvwAAAABz18I/ryWcPwAAAABz18I/rItbvwAAAAAyVeA/rItbPwAAAAAyVeA/AAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAABAAIAAwAEAAUABgADAAUABwAGAAUACAAHAAUACQAIAAUACgAJAAUACwAKAAUADAALAAUADQAMAAUADgANAAUADwAOAAUAEAAPAAUAEQAQAAUAEgARAAUAEwASAAUAFAATAAUAFQAUAAUAFgAVAAUAFwAWAAUAFwAFABgAGQAXABgAGQAYABoAGwAZABoAAgAbABoAAAACABoA"}],bufferViews:[{name:"bufferView_0",buffer:0,byteLength:336,byteOffset:0,byteStride:12,target:34962},{name:"bufferView_1",buffer:0,byteLength:336,byteOffset:336,byteStride:12,target:34962},{name:"bufferView_2",buffer:0,byteLength:156,byteOffset:672,target:34963}],materials:[{name:"wire_008110135",pbrMetallicRoughness:{baseColorFactor:[.0314,.4314,.5294,1],metallicFactor:0,roughnessFactor:.968},emissiveFactor:[0,0,0],alphaMode:"OPAQUE",doubleSided:!1}],meshes:[{name:"Circle001_1",primitives:[{attributes:{POSITION:0,NORMAL:1},indices:2,material:0,mode:4}]}],nodes:[{name:"Circle001",mesh:0}],scene:0,scenes:[{nodes:[0]}]},zzhou:{accessors:[{name:"Cube.001-Mesh_0_positions",componentType:5126,count:45,min:[-.2711470127105713,-5.473427772521973,-.2711470127105713],max:[.2711470127105713,.46298399567604065,.2711470127105713],type:"VEC3",bufferView:0,byteOffset:0},{name:"Cube.001-Mesh_0_normals",componentType:5126,count:45,min:[-1,-1,-1],max:[1,1,1],type:"VEC3",bufferView:1,byteOffset:0},{name:"Cube.001-Mesh_0_texcoords",componentType:5126,count:45,min:[.125,0],max:[.875,1],type:"VEC2",bufferView:2,byteOffset:0},{name:"Cube.001-Mesh_0_indices",componentType:5123,count:72,min:[0],max:[44],type:"SCALAR",bufferView:3,byteOffset:0}],asset:{generator:"obj2gltf",version:"2.0"},buffers:[{name:"Z",byteLength:1584,uri:"data:application/octet-stream;base64,/waNvZMdK77/Bo09/waNPZMdK77/Bo09/waNPR4Kr8D/Bo09l+KKPVImr8D/Bo09/waNvVImr8D/Bo09yNOKPsjTir7I04o+AAAAAD0M7T4AAAAAyNOKvsjTir7I04o+yNOKvsjTir7I04o+AAAAAD0M7T4AAAAAyNOKvsjTir7I04q+yNOKvsjTir7I04q+yNOKPsjTir7I04q+yNOKPsjTir7I04o+yNOKvsjTir7I04o+yNOKPsjTir7I04q+AAAAAD0M7T4AAAAAyNOKPsjTir7I04o+yNOKvsjTir7I04q+AAAAAD0M7T4AAAAAyNOKPsjTir7I04q+/waNPZMdK77/Bo09/waNPZMdK77/Bo29/waNPVImr8D/Bo29/waNPVImr8D/Bo09/waNPR4Kr8D/Bo09/waNvZMdK77/Bo09/waNvVImr8D/Bo09/waNvVImr8D/Bo29/waNvZMdK77/Bo29/waNvZMdK77/Bo29/waNvVImr8D/Bo29/waNPVImr8D/Bo29/waNPZMdK77/Bo29/waNPZMdK77/Bo09/waNvZMdK77/Bo09/waNvZMdK77/Bo29/waNPZMdK77/Bo29/waNvVImr8D/Bo09cooOO1Imr8BAMTI7/waNvVImr8D/Bo29/waNPVImr8D/Bo29/waNPVImr8D/Bo09l+KKPVImr8D/Bo09/waNPVImr8D/Bo09AAAAAAAAAAAAAIC/AAAAAAAAAAAAAIC/AAAAAAAAAAAAAIC/AAAAAAAAAAAAAIC/AAAAAAAAAAAAAIC/AAAAAFFmsT5wJHA/AAAAAFFmsT5wJHA/AAAAAFFmsT5wJHA/cCRwv1FmsT4AAAAAcCRwv1FmsT4AAAAAcCRwv1FmsT4AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAcCRwP1FmsT4AAAAAcCRwP1FmsT4AAAAAcCRwP1FmsT4AAAAAAAAAAFFmsT5wJHC/AAAAAFFmsT5wJHC/AAAAAFFmsT5wJHC/AACAvwAAAAAAAAAAAACAvwAAAAAAAAAAAACAvwAAAAAAAAAAAACAvwAAAAAAAAAAAACAvwAAAAAAAAAAAACAPwAAAAAAAAAAAACAPwAAAAAAAAAAAACAPwAAAAAAAAAAAACAPwAAAAAAAAAAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgD8AAAAAAAAAAAAAgD8AAAAAAAAAAAAAgD8AAAAAAAAAAAAAgD8AAAAAAAAAAAAAAAAAAIC/AAAAAAAAgD8AAAAAAAAAAAAAgD8AAAAAAADAPgAAQD8AAMA+AACAP2L1Hz8AAIA/AAAgP3uDfz8AACA/AABAPwAAwD4AAIA+AAAgPwAAAAAAAMA+AAAAAAAAwD4AAIA/AAAgPwAAQD8AAMA+AABAPwAAAD4AAAA/AADAPgAAAD8AAMA+AACAPgAAAD4AAIA+AADAPgAAAD8AACA/AACAPgAAwD4AAIA+AADAPgAAQD8AACA/AAAAPwAAwD4AAAA/AADAPgAAAD8AAMA+AABAPwAAID8AAEA/AAAgPwAAAD9i9R8/AAAAPwAAwD4AAAA/AAAgPwAAAD8AACA/AACAPgAAwD4AAIA+AADAPgAAgD4AACA/AACAPgAAID8AAAAAAADAPgAAAAAAAAA+AAAAPwAAwD4AAAA/AADAPgAAgD4AAAA+AACAPgAAID8AAAA/vAJBP/mGwj4AACA/AACAPgAAYD8AAIA+AAAgPwAAgD97g18/AAAAPwAAYD8AAAA/AAABAAIAAgADAAQAAgAEAAAABQAGAAcACAAJAAoACwAMAA0ACwANAA4ADwAQABEAEgATABQAFQAWABcAFwAYABkAFwAZABUAGgAbABwAGgAcAB0AHgAfACAAHgAgACEAIgAjACQAIgAkACUAJgAnACgAKAAnACkAAwACACoAKQAnACsAKQArACwAJwAmACsA"}],bufferViews:[{name:"bufferView_0",buffer:0,byteLength:540,byteOffset:0,byteStride:12,target:34962},{name:"bufferView_1",buffer:0,byteLength:540,byteOffset:540,byteStride:12,target:34962},{name:"bufferView_2",buffer:0,byteLength:360,byteOffset:1080,byteStride:8,target:34962},{name:"bufferView_3",buffer:0,byteLength:144,byteOffset:1440,target:34963}],materials:[{name:"Material.001",pbrMetallicRoughness:{baseColorFactor:[.8,.8,.8,1],metallicFactor:0,roughnessFactor:.676000006},emissiveFactor:[0,0,0],alphaMode:"OPAQUE",doubleSided:!1}],meshes:[{name:"Cube.001-Mesh",primitives:[{attributes:{POSITION:0,NORMAL:1,TEXCOORD_0:2},indices:3,material:0,mode:4}]}],nodes:[{name:"Cube.001",mesh:0}],scene:0,scenes:[{nodes:[0]}]},jiantou:{accessors:[{name:"_1_0_positions",componentType:5126,count:7,min:[-.47690001130104065,-.8044000267982483,0],max:[.47780001163482666,0,0],type:"VEC3",bufferView:0,byteOffset:0},{name:"_1_0_normals",componentType:5126,count:7,min:[0,0,1],max:[0,0,1],type:"VEC3",bufferView:1,byteOffset:0},{name:"_1_0_indices",componentType:5123,count:15,min:[0],max:[6],type:"SCALAR",bufferView:2,byteOffset:0}],asset:{generator:"obj2gltf",version:"2.0"},buffers:[{name:"jiantou",byteLength:200,uri:"data:application/octet-stream;base64,bxIDOintTb8AAAAAH/RsvsKGp74AAAAAPSz0vsKGp74AAAAANs17PsKGp74AAAAANKL0PsKGp74AAAAANs17PgAAAAAAAAAAH/RsvgAAAAAAAAAAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAABAAIAAAADAAEAAAAEAAMAAQAFAAYAAQADAAUAAAA="}],bufferViews:[{name:"bufferView_0",buffer:0,byteLength:84,byteOffset:0,byteStride:12,target:34962},{name:"bufferView_1",buffer:0,byteLength:84,byteOffset:84,byteStride:12,target:34962},{name:"bufferView_2",buffer:0,byteLength:32,byteOffset:168,target:34963}],materials:[{name:"SVGMat_003",pbrMetallicRoughness:{baseColorFactor:[.588,.588,.588,1],metallicFactor:0,roughnessFactor:.99},emissiveFactor:[0,0,0],alphaMode:"OPAQUE",doubleSided:!1}],meshes:[{name:"_1",primitives:[{attributes:{POSITION:0,NORMAL:1},indices:2,material:0,mode:4}]}],nodes:[{name:"",mesh:0}],scene:0,scenes:[{nodes:[0]}]},xuanzhuan:{accessors:[{name:"001_1_0_positions",componentType:5126,count:369,min:[-6.572299957275391,-7.298999786376953,0],max:[6.5742998123168945,7.298299789428711,0],type:"VEC3",bufferView:0,byteOffset:0},{name:"001_1_0_normals",componentType:5126,count:369,min:[0,-1,0],max:[0,0,1],type:"VEC3",bufferView:1,byteOffset:0},{name:"001_1_0_indices",componentType:5123,count:1089,min:[0],max:[368],type:"SCALAR",bufferView:2,byteOffset:0}],asset:{generator:"obj2gltf",version:"2.0"},buffers:[{name:"-",byteLength:11036,uri:"data:application/octet-stream;base64,1zQDwHql3kAAAAAA48e4vgMJ1kAAAAAAQmD1v6yL6UAAAAAA2qxqv1Fr0EAAAAAAVHSkvnuD1UAAAAAAF7eRvjXv1EAAAAAAyeV/vqVO1EAAAAAA5INevsuh00AAAAAAW7E/vpHt0kAAAAAAZogjvoMv0kAAAAAAAwkKvrpr0UAAAAAA+aDnvTSi0EAAAAAAXCDBvWfVz0AAAAAAqoLZv4NRy0AAAAAALv+hvfcGz0AAAAAAAwmKvVg5zkAAAAAA/Yd0vYtszUAAAAAAak1zvSBBzUAAAAAA1xJyveQUzUAAAAAAIEFxvTLmzEAAAAAARdhwvd21zEAAAAAARdhwvbaEzEAAAAAAIEFxvb1SzEAAAAAAs3tyvSEfzEAAAAAARrZzvYXry0AAAAAAayt2vRe3y0AAAAAAkKB4vQaBy0AAAAAASFB8vfVKy0AAAAAAhXwcwLRZw0AAAAAAbjSAveQUy0AAAAAA3EaDvcX+ykAAAAAAb/CFvTLmykAAAAAAcM6IvRTQykAAAAAAcayLvSS5ykAAAAAAcoqOvQWjykAAAAAA4XqUvWx4ykAAAAAAUI2XvSBjykAAAAAACD2bvQFNykAAAAAAUrievbU3ykAAAAAAeJyivTojykAAAAAA5x2nve0NykAAAAAAMCqpvaMBykAAAAAAVp+rvVr1yUAAAAAAexSuvbPqyUAAAAAAxSCwvTvfyUAAAAAA6pWyvfLSyUAAAAAAoda0vUvIyUAAAAAAx0u3vQK8yUAAAAAAWvW5vVuxyUAAAAAA7Z68vYenyUAAAAAA7ny/veCcyUAAAAAAgSbCvQyTyUAAAAAAgQTFvQmKyUAAAAAA1CvlvRUdyUAAAAAAXW0FviS5yEAAAAAALNQavjVeyEAAAAAADi0yvqYKyEAAAAAAlkNLvki/x0AAAAAA5q5lvhx8x0AAAAAAZaqAvqs+x0AAAAAA4L6OvsgHx0AAAAAAyAedvnPXxkAAAAAAlkOrvqytxkAAAAAAEFi5vs6IxkAAAAAAH4XLvpVlxkAAAAAAAwnKvjhnxkAAAAAA54zIvjhnxkAAAAAAsAPHvgpoxkAAAAAAOwHNvsNkxkAAAAAAO3DOvvFjxkAAAAAA0ETYvpJcxkAAAAAAV+zPvk5ixkAAAAAAV1vRvtlfxkAAAAAAWMrSvgdfxkAAAAAAWDnUvmRdxkAAAAAAIo7VvpJcxkAAAAAA6+LWvpJcxkAAAAAAiIXavgRWxkAAAAAAJLncvkhQxkAAAAAA2/nevl5LxkAAAAAAkzrhvhdIxkAAAAAASnvjvtBExkAAAAAAMzPzvoY4xkAAAAAAArzlvrhAxkAAAAAAufznvkI+xkAAAAAAcT3qvs07xkAAAAAAKH7svlg5xkAAAAAAxLHuvoY4xkAAAAAAfPLwvoY4xkAAAAAA9Gz2vsoyxkAAAAAAtab5vj0sxkAAAAAAduD8vlInxkAAAAAAqRMAvzojxkAAAAAApb0Bv08exkAAAAAAE2EDvzcaxkAAAAAAnREFv00VxkAAAAAAC7UGvzQRxkAAAAAAlWUIv0oMxkAAAAAAHhYKv18HxkAAAAAAGsALv6MBxkAAAAAADk8Pv7n8xUAAAAAAgEgPv7n8xUAAAAAApHANv7n8xUAAAAAAUwWrv90kwkAAAAAASS4Pv7n8xUAAAAAApHANv7n8xUAAAAAAgEgPv7n8xUAAAAAA9wYPv7n8xUAAAAAAidIOv7n8xUAAAAAAG54Ov7n8xUAAAAAAIGMOv7n8xUAAAAAAJCgOv7n8xUAAAAAAKe0Nv7n8xUAAAAAASL8Nv7n8xUAAAAAA9pcNv7n8xUAAAAAAv30Nv7n8xUAAAAAABoFJwDm0uEAAAAAAZvcEwJtVu0AAAAAAwcoxwOzAsUAAAAAARiUFQFdbu8AAAAAAdZMcQM9mw8AAAAAA9pdJQIPAuMAAAAAAtvMxQEvIscAAAAAA2IFzQISeq8AAAAAAjLlbQECkpcAAAAAAZveMQPkxnMAAAAAAPQqBQNEil8AAAAAA+zqeQJOpisAAAAAAdk+SQPd1hsAAAAAAA3ihQFafZ8AAAAAAnl6tQN5xbsAAAAAAsi66QCEfRMAAAAAASFCuQLTIPsAAAAAA4XrEQPW5FsAAAAAAHqe4QJ/NEsAAAAAA1xLMQJhMzb8AAAAA6UjAQFInyL8AAAAAnMTQQM4ZUb8AAAAAsAPFQKMBTL8AAAAAduCMwKMjWcAAAAAA9P1wwOauOcAAAAAA6GqDwG1WGcAAAAAA46WZwA5PM8AAAAAANKLGQBe30TkAAAAAqmDSQBe30TkAAAAAdQLMwEYlzT8AAAAALUPAwAAAyD8AAAAAvp+4wFK4EkAAAAAArWnEwAWjFkAAAAAAF0iuwGizPkAAAAAATx66wI4GREAAAAAAXW2hwAmKZ0AAAAAAPE6twEtZbkAAAAAAW0KSwFFrhkAAAAAAayuewO2eikAAAAAAUPyAwPwYl0AAAAAA1eeMwK8lnEAAAAAAyJhbwA+cpUAAAAAAoWdzwDqSq0AAAAAA6GqrP8cpwsAAAAAA+zoQP6MBxsAAAAAAbqPZPxNhy8AAAAAAYHYPPxsNxsAAAAAAukkMPzQRxsAAAAAA0gAOPxsNxsAAAAAARPoNPxsNxsAAAAAAexQOPxsNxsAAAAAAPzUOPxsNxsAAAAAAIGMOPxsNxsAAAAAAcooOPxsNxsAAAAAAUrgOPxsNxsAAAAAAMuYOPxsNxsAAAAAAoBoPPxsNxsAAAAAAZDsPPxsNxsAAAAAAKVwPPxsNxsAAAAAA0m8PPxsNxsAAAAAAMZkKP00VxsAAAAAAp+gIPzcaxsAAAAAAqz4HPyEfxsAAAAAAIo4FP90kxsAAAAAAmN0DP2srxsAAAAAADi0CPycxxsAAAAAAhXwAP+M2xsAAAAAA9pf9PnE9xsAAAAAA/kP6PltCxsAAAAAA6+L2PqJFxsAAAAAA2IHzPulIxsAAAAAAc2jxPl5LxsAAAAAADk/vPtNNxsAAAAAAqDXtPkhQxsAAAAAAKA/rPr1SxsAAAAAAjNvoPmFUxsAAAAAAC7XmPjJVxsAAAAAAVHTkPgRWxsAAAAAA003iPnlYxsAAAAAAGw3gPh1axsAAAAAAZMzdPpJcxsAAAAAArIvbPgdfxsAAAAAA9UrZPnxhxsAAAAAA2c7XPvFjxsAAAAAA2V/WPpVlxsAAAAAA2PDUPgpoxsAAAAAA847TPn9qxsAAAAAA8x/SPiJsxsAAAAAA8rDQPvRsxsAAAAAA8kHPPphuxsAAAAAAKe3NPg1xxsAAAAAAKH7MPt5xxsAAAAAADALLPlR0xsAAAAAADJPJPsl2xsAAAAAA8BbIPj55xsAAAAAA4za6PryWxsAAAAAATRWsPvW5xsAAAAAASL+dPuvixsAAAAAAYHaPPp0Rx8AAAAAA5WGBPgtGx8AAAAAAi2xnPtiBx8AAAAAAOwFNPtbFx8AAAAAA6gQ0PmIQyMAAAAAAP8YcPiBjyMAAAAAA3pMHPrG/yMAAAAAAZ0TpPdEiycAAAAAAg1HJPcWPycAAAAAAy6HFPQ+cycAAAAAA7lrCPYenycAAAAAAEhS/PdCzycAAAAAAowG8PRrAycAAAAAAEFi5PZLLycAAAAAAfa62PdzXycAAAAAA6gS0PVTjycAAAAAAxY+xPZ7vycAAAAAADk+vPef7ycAAAAAA6NmsPV8HysAAAAAAn82qPakTysAAAAAAeVioPfMfysAAAAAAwaikPT81ysAAAAAA5WGhPYxKysAAAAAACRuePapgysAAAAAACD2bPcl2ysAAAAAAB1+YPbmNysAAAAAAdLWVPamkysAAAAAAvJaQPVvTysAAAAAABFaOPRzrysAAAAAA3+CLPd4Cy8AAAAAAldSJPXEby8AAAAAAcF+HPTMzy8AAAAAA3bWEPc9my8AAAAAALNRqP1Z90MAAAAAAuECCPciYy8AAAAAA3GiAPZLLy8AAAAAAtvN9PS7/y8AAAAAASFB8PScxzMAAAAAA/kN6PSBjzMAAAAAAI9t5PUaUzMAAAAAAI9t5PRHHzMAAAAAAI9t5PTj4zMAAAAAA/kN6PV8pzcAAAAAAkX57PYZazcAAAAAAJLl8PQmKzcAAAAAAcoqOPdZWzsAAAAAAMEymPaMjz8AAAAAAXW3FPZ7vz8AAAAAAjLnrPfW50MAAAAAAqz4DQN213sAAAAAAgy8MPmN/0cAAAAAA5q4lPrhA0sAAAAAAE/JBPn/70sAAAAAAnMRgPhSu08AAAAAAJQaBPnlY1MAAAAAAPL2SPpT21MAAAAAAeHqlPgmK1cAAAAAAhxa5Pr8O1sAAAAAA63P1P2iR6cAAAAAApb1Bv4xKsEAAAAAAMlVAP4xKsEAAAAAAw2QquxDpsUAAAAAAMne9v/OOq0AAAAAA3bW8P/OOq0AAAAAAYqEKwG/wo0AAAAAAcT0KQG/wo0AAAAAA/7IzwG6jmUAAAAAAak0zQG6jmUAAAAAA8IVZwAHejEAAAAAAHcklvw6+lkAAAAAAw2Qqu8UgmEAAAAAAxm0kPw6+lkAAAAAAuB5ZQAHejEAAAAAAc2ihP5aykkAAAAAA1xKiv5aykkAAAAAAKH7sP+AtjEAAAAAAjSjtv+AtjEAAAAAAuK97wBSue0AAAAAAOUV7QBSue0AAAAAAnl4ZQHBfg0AAAAAAdLUZwHBfg0AAAAAAXro5QGDlcEAAAAAA7Q06wGDlcEAAAAAAduCMwPCFWUAAAAAAZaqMQPCFWUAAAAAAqvFWQJAxV0AAAAAA3EZXwJAxV0AAAAAA46WZwEa2M0AAAAAA0m+ZQEa2M0AAAAAAHqdwQIv9OUAAAAAA9P1wwIv9OUAAAAAAIEGDQLWmGUAAAAAA6GqDwLWmGUAAAAAAnzyMwMZt7L8AAAAAiPSjwHE9CsAAAAAAIEGDQG1WGcAAAAAA0m+ZQA5PM8AAAAAA07yjQHE9CsAAAAAANBGMQMZt7L8AAAAA+1yrQAisvL8AAAAA6pWSQBBYob8AAAAAOpKrwAisvL8AAAAAVcGSwBBYob8AAAAA+8uWwI9TJL8AAAAA002wwG40QL8AAAAAYqGWQMbcJT8AAAAA8BawQPfkQT8AAAAA+1yrQE2EvT8AAAAA6pWSQJEPoj8AAAAAVTCYwInSXjsAAAAA+u2xwInSXjsAAAAA6gSYQInSXjsAAAAARraxQInSXjsAAAAAObTQwEXYUD8AAAAAIv3EwBrASz8AAAAAYqGWQI9TJL8AAAAA8BawQG40QL8AAAAA+8uWwMbcJT8AAAAA002wwPfkQT8AAAAAVcGSwJEPoj8AAAAAOpKrwE2EvT8AAAAAnzyMwOQU7T8AAAAAiPSjwEymCkAAAAAA07yjQEymCkAAAAAANBGMQOQU7T8AAAAAHqdwQOauOcAAAAAAZaqMQKMjWcAAAAAA3EZXwOviVsAAAAAAqvFWQOviVsAAAAAA7Q06wLyWcMAAAAAAXro5QLyWcMAAAAAAOUV7QMdLe8AAAAAAuK97wMdLe8AAAAAAdLUZwHo2g8AAAAAAnl4ZQHo2g8AAAAAAuB5ZQE+vjMAAAAAA8IVZwE+vjMAAAAAAjSjtv+oEjMAAAAAAKH7sP+oEjMAAAAAA1xKiv86IksAAAAAAc2ihP86IksAAAAAAak0zQGB2mcAAAAAA/7IzwGB2mcAAAAAAHcklv0aUlsAAAAAAxm0kP0aUlsAAAAAAw2Qqu/32l8AAAAAAcT0KQDPEo8AAAAAAYqEKwDPEo8AAAAAA3bW8P4hjq8AAAAAAMne9v4hjq8AAAAAAMlVAPyEfsMAAAAAApb1BvyEfsMAAAAAAw2Qqu3e+scAAAAAASFDSwG8Sg7oAAAAASZ3GwG8Sg7oAAAAAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAABAAIAAwABAAAAAwAEAAEAAwAFAAQAAwAGAAUAAwAHAAYAAwAIAAcAAwAJAAgAAwAKAAkAAwALAAoAAwAMAAsADQAMAAMADQAOAAwADQAPAA4ADQAQAA8ADQARABAADQASABEADQATABIADQAUABMADQAVABQADQAWABUADQAXABYADQAYABcADQAZABgADQAaABkADQAbABoAHAAbAA0AHAAdABsAHAAeAB0AHAAfAB4AHAAgAB8AHAAhACAAHAAiACEAHAAjACIAHAAkACMAHAAlACQAHAAmACUAHAAnACYAHAAoACcAHAApACgAHAAqACkAHAArACoAHAAsACsAHAAtACwAHAAuAC0AHAAvAC4AHAAwAC8AHAAxADAAHAAyADEAHAAzADIAHAA0ADMAHAA1ADQAHAA2ADUAHAA3ADYAHAA4ADcAHAA5ADgAHAA6ADkAHAA7ADoAHAA8ADsAHAA9ADwAHAA+AD0AHAA/AD4AHABAAD8AQABBAD8AQQBCAD8AQgBDAD8AHABAAEQAHABEAEUAHABGAEUARgBHAEUARgBIAEcARgBJAEgARgBKAEkARgBLAEoARgBMAEsAHABNAEYAHABOAE0AHABPAE4AHABQAE8AHABRAFAAHABSAFEAUgBTAFEAUgBUAFMAUgBVAFQAUgBWAFUAUgBXAFYAUgBYAFcAHABZAFIAHABaAFkAHABbAFoAHABcAFsAHABdAFwAHABeAF0AHABfAF4AHABgAF8AHABhAGAAHABiAGEAHABjAGIAHABjAGQAZABlAGMAZQBmAGMAHABnAGQAaABpAGoAawBpAGgAbABpAGsAbQBpAGwAbgBpAG0AbwBpAG4AcABpAG8AcQBpAHAAcgBpAHEAcwBpAHIAdABnABwAdAB1AGcAdAB2AHUAdwB4AHkAdwB5AHoAegB5AHsAegB7AHwAfAB7AH0AfAB9AH4AfgB9AH8AfgB/AIAAgQCCAIMAgQCDAIQAhACDAIUAhACFAIYAhgCFAIcAhgCHAIgAiACHAIkAiACJAIoAiwCMAI0AiwCNAI4AjwCKAJAAigCJAJAAkQCSAJMAkQCTAJQAlACTAJUAlACVAJYAlgCVAJcAlgCXAJgAgAB/AIIAgACCAIEAmACXAJkAmACZAJoAmgCZAJsAmgCbAJwAnACbAJ0AnACdAJ4AngCdAHYAngB2AHQAnwB4AHcAoAB4AJ8AoAChAHgAogChAKAAowCkAKUAowCmAKQAowCnAKYAowCoAKcAowCpAKgAowCqAKkAowCrAKoAowCsAKsAowCtAKwAowCuAK0AowCvAK4AowCiAK8AowChAKIAsAChAKMAsQChALAAsgChALEAswChALIAtAChALMAtQChALQAtgChALUAtwChALYAuAChALcAuQChALgAugChALkAuwChALoAvAChALsAvQChALwAvgChAL0AvwChAL4AwAChAL8AwQChAMAAwgChAMEAwwChAMIAxAChAMMAxQChAMQAxgChAMUAxwChAMYAyAChAMcAyQChAMgAygChAMkAywChAMoAzAChAMsAzQChAMwAzgChAM0AzwChAM4A0AChAM8A0QChANAA0gChANEA0wChANIA1AChANMA1QChANQA1gChANUA1wChANYA2AChANcA2QChANgA2gChANkA2wChANoA3AChANsA3QChANwA3gChAN0A3wChAN4A4AChAN8A4QChAOAA4gChAOEA4wChAOIA5AChAOMA5QChAOQA5gChAOUA5wChAOYA6AChAOcA6QChAOgA6gChAOkA6wChAOoA7AChAOsA7QChAOwA7gChAO0A7wChAO4A8AChAO8A8QChAO8A8gChAPEA8wChAPIA9AChAPMA9QChAPQA9gChAPUA9gD3AKEA+AD3APYA+QD3APgA+gD3APkA+wD3APoA/AD3APsA/QD3APwA/gD3AP0A/wD3AP4AAAH3AP8AAQH3AAABAgH3AAEBAwH3AAIBBAH3AAMBBQH3AAQBBgH3AAUBBgEHAfcACAEHAQYBCQEHAQgBCgEHAQkBCwEHAQoBDAEHAQsBDQEHAQwBDgEHAQ0BDwEHAQ4BEAEHAQ8BEQESARMBFAESAREBFAEVARIBFgEVARQBFgEXARUBGAEXARYBGAEZARcBGgEbARgBGwEcARgBHAEZARgBHAEdARkBHQEeARkBHwEeAR0BGgEgARsBIQEeAR8BGgEiASABIwEiARoBIQEkAR4BJQEkASEBIwEmASIBJwEkASUBIwEoASYBKQEoASMBJwEqASQBKwEqAScBKQEsASgBLQEsASkBKwEuASoBLwEuASsBLQEwASwBMQEuAS8BLQEyATABjgCNADMBjgAzATQBNQE2ATcBNQE3ATgBOAE3ATkBOAE5AToBOwE8AT0BOwE9AT4BPwFAAUEBPwFBAUIBPgE9AUMBPgFDAUQBRQFGAUABRQFAAT8BRwFIAZIARwGSAJEASQFKAUYBSQFGAUUBRAFDAUsBRAFLAUwBOgE5AUoBOgFKAUkBTAFLAU0BTAFNAU4BTgFNAU8BTgFPAVABQgFBAVEBQgFRAVIBUgFRAS4BUgEuATEBNAEzATwBNAE8ATsBUwFUATYBUwE2ATUBUAFPATIBUAEyAS0BiwBVAYwAVgFUAVMBiwBXAVUBWAFUAVYBWAFZAVQBWgFXAYsAWgFbAVcBXAFZAVgBXAFdAVkBXgFbAVoBXgFfAVsBYAFdAVwBXgFhAV8BYgFdAWABYgFjAV0BZAFhAV4BZAFlAWEBZgFjAWIBZAFnAWUBZwFjAWYBZAFjAWcBZAFoAWMBaQFoAWQBaQFqAWgBawFqAWkBawFsAWoBbQFsAWsBbQFuAWwBbwFwAUgBbwFIAUcBAAA="}],bufferViews:[{name:"bufferView_0",buffer:0,byteLength:4428,byteOffset:0,byteStride:12,target:34962},{name:"bufferView_1",buffer:0,byteLength:4428,byteOffset:4428,byteStride:12,target:34962},{name:"bufferView_2",buffer:0,byteLength:2180,byteOffset:8856,target:34963}],materials:[{name:"SVGMat",pbrMetallicRoughness:{baseColorFactor:[.5,.5,.5,1],metallicFactor:0,roughnessFactor:1},emissiveFactor:[0,0,0],alphaMode:"OPAQUE",doubleSided:!1}],meshes:[{name:"001_1",primitives:[{attributes:{POSITION:0,NORMAL:1},indices:2,material:0,mode:4}]}],nodes:[{name:"001",mesh:0}],scene:0,scenes:[{nodes:[0]}]},plane:{accessors:[{name:"Rectangle001_1_0_positions",componentType:5126,count:4,min:[-5,-5,0],max:[5,5,0],type:"VEC3",bufferView:0,byteOffset:0},{name:"Rectangle001_1_0_normals",componentType:5126,count:4,min:[0,0,1],max:[0,0,1],type:"VEC3",bufferView:1,byteOffset:0},{name:"Rectangle001_1_0_indices",componentType:5123,count:6,min:[0],max:[3],type:"SCALAR",bufferView:2,byteOffset:0}],asset:{generator:"obj2gltf",version:"2.0"},buffers:[{name:"plane",byteLength:108,uri:"data:application/octet-stream;base64,AACgQAAAoEAAAAAAAACgwAAAoEAAAAAAAACgwAAAoMAAAAAAAACgQAAAoMAAAAAAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAABAAIAAgADAAAA"}],bufferViews:[{name:"bufferView_0",buffer:0,byteLength:48,byteOffset:0,byteStride:12,target:34962},{name:"bufferView_1",buffer:0,byteLength:48,byteOffset:48,byteStride:12,target:34962},{name:"bufferView_2",buffer:0,byteLength:12,byteOffset:96,target:34963}],materials:[{name:"wire_225198087",pbrMetallicRoughness:{baseColorFactor:[.8824,.7765,.3412,1],metallicFactor:0,roughnessFactor:.968},emissiveFactor:[0,0,0],alphaMode:"OPAQUE",doubleSided:!1}],meshes:[{name:"Rectangle001_1",primitives:[{attributes:{POSITION:0,NORMAL:1},indices:2,material:0,mode:4}]}],nodes:[{name:"Rectangle001",mesh:0}],scene:0,scenes:[{nodes:[0]}]},xyzScale:{asset:{generator:"Khronos glTF Blender I/O v1.6.16",version:"2.0"},scene:0,scenes:[{name:"Scene",nodes:[0,1,2,3,4,5,6]}],nodes:[{mesh:0,name:"Cube",scale:[.7008190751075745,.014999999664723873,.014999999664723873]},{mesh:1,name:"Cube.001",scale:[.10000000149011612,.10000000149011612,.10000000149011612]},{mesh:2,name:"Cube.004",rotation:[0,-.7071068286895752,0,.7071068286895752],scale:[.7008190751075745,.014999999664723873,.014999999664723873]},{mesh:3,name:"Cube.003",rotation:[0,-.7071068286895752,0,.7071068286895752],scale:[.10000000149011612,.10000000149011612,.10000000149011612]},{mesh:4,name:"Cube.006",rotation:[0,0,.7071068286895752,.7071068286895752],scale:[.7008190751075745,.014999999664723873,.014999999664723873]},{mesh:5,name:"Cube.005",rotation:[0,0,.7071068286895752,.7071068286895752],scale:[.10000000149011612,.10000000149011612,.10000000149011612]},{mesh:6,name:"Cube.002",scale:[.10000000149011612,.10000000149011612,.10000000149011612]}],materials:[{doubleSided:!0,name:"Material",pbrMetallicRoughness:{baseColorFactor:[.6938720345497131,.020288480445742607,.011612260714173317,1],metallicFactor:0,roughnessFactor:.4000000059604645}},{doubleSided:!0,name:"Material.001",pbrMetallicRoughness:{baseColorFactor:[.6938720345497131,.020288480445742607,.011612260714173317,1],metallicFactor:0,roughnessFactor:.4000000059604645}},{doubleSided:!0,name:"Material.002",pbrMetallicRoughness:{baseColorFactor:[.626582869887352,.626582869887352,.626582869887352,1],metallicFactor:0,roughnessFactor:.4000000059604645}},{doubleSided:!0,name:"Material.006",pbrMetallicRoughness:{baseColorFactor:[.11193240433931351,.5583405494689941,.033104799687862396,1],metallicFactor:0,roughnessFactor:.4000000059604645}},{doubleSided:!0,name:"Material.005",pbrMetallicRoughness:{baseColorFactor:[.11193240433931351,.5583405494689941,.033104799687862396,1],metallicFactor:0,roughnessFactor:.4000000059604645}},{doubleSided:!0,name:"Material.010",pbrMetallicRoughness:{baseColorFactor:[.004391402006149292,.21223078668117523,.5209956169128418,1],metallicFactor:0,roughnessFactor:.4000000059604645}},{doubleSided:!0,name:"Material.009",pbrMetallicRoughness:{baseColorFactor:[.004391402006149292,.21223078668117523,.5209956169128418,1],metallicFactor:0,roughnessFactor:.4000000059604645}}],meshes:[{name:"Cube",primitives:[{attributes:{POSITION:0,NORMAL:1,TEXCOORD_0:2},indices:3,material:0}]},{name:"Cube.001",primitives:[{attributes:{POSITION:4,NORMAL:5,TEXCOORD_0:6},indices:3,material:1}]},{name:"Cube.006",primitives:[{attributes:{POSITION:10,NORMAL:11,TEXCOORD_0:12},indices:3,material:3}]},{name:"Cube.005",primitives:[{attributes:{POSITION:13,NORMAL:14,TEXCOORD_0:15},indices:3,material:4}]},{name:"Cube.010",primitives:[{attributes:{POSITION:16,NORMAL:17,TEXCOORD_0:18},indices:3,material:5}]},{name:"Cube.009",primitives:[{attributes:{POSITION:19,NORMAL:20,TEXCOORD_0:21},indices:3,material:6}]},{name:"Cube.002",primitives:[{attributes:{POSITION:7,NORMAL:8,TEXCOORD_0:9},indices:3,material:2}]}],accessors:[{bufferView:0,componentType:5126,count:24,max:[2.0003609657287598,1,1],min:[.0003610849380493164,-1,-1],type:"VEC3"},{bufferView:1,componentType:5126,count:24,type:"VEC3"},{bufferView:2,componentType:5126,count:24,type:"VEC2"},{bufferView:3,componentType:5123,count:36,type:"SCALAR"},{bufferView:4,componentType:5126,count:24,max:[14.549108505249023,1,1],min:[12.549108505249023,-1,-1],type:"VEC3"},{bufferView:5,componentType:5126,count:24,type:"VEC3"},{bufferView:6,componentType:5126,count:24,type:"VEC2"},{bufferView:7,componentType:5126,count:24,max:[1,1,1],min:[-1,-1,-1],type:"VEC3"},{bufferView:8,componentType:5126,count:24,type:"VEC3"},{bufferView:9,componentType:5126,count:24,type:"VEC2"},{bufferView:10,componentType:5126,count:24,max:[2.0003609657287598,1,1],min:[.0003610849380493164,-1,-1],type:"VEC3"},{bufferView:11,componentType:5126,count:24,type:"VEC3"},{bufferView:12,componentType:5126,count:24,type:"VEC2"},{bufferView:13,componentType:5126,count:24,max:[14.549108505249023,1,1],min:[12.549108505249023,-1,-1],type:"VEC3"},{bufferView:14,componentType:5126,count:24,type:"VEC3"},{bufferView:15,componentType:5126,count:24,type:"VEC2"},{bufferView:16,componentType:5126,count:24,max:[2.0003609657287598,1,1],min:[.0003610849380493164,-1,-1],type:"VEC3"},{bufferView:17,componentType:5126,count:24,type:"VEC3"},{bufferView:18,componentType:5126,count:24,type:"VEC2"},{bufferView:19,componentType:5126,count:24,max:[14.549108505249023,1,1],min:[12.549108505249023,-1,-1],type:"VEC3"},{bufferView:20,componentType:5126,count:24,type:"VEC3"},{bufferView:21,componentType:5126,count:24,type:"VEC2"}],bufferViews:[{buffer:0,byteLength:288,byteOffset:0},{buffer:0,byteLength:288,byteOffset:288},{buffer:0,byteLength:192,byteOffset:576},{buffer:0,byteLength:72,byteOffset:768},{buffer:0,byteLength:288,byteOffset:840},{buffer:0,byteLength:288,byteOffset:1128},{buffer:0,byteLength:192,byteOffset:1416},{buffer:0,byteLength:288,byteOffset:1608},{buffer:0,byteLength:288,byteOffset:1896},{buffer:0,byteLength:192,byteOffset:2184},{buffer:0,byteLength:288,byteOffset:2376},{buffer:0,byteLength:288,byteOffset:2664},{buffer:0,byteLength:192,byteOffset:2952},{buffer:0,byteLength:288,byteOffset:3144},{buffer:0,byteLength:288,byteOffset:3432},{buffer:0,byteLength:192,byteOffset:3720},{buffer:0,byteLength:288,byteOffset:3912},{buffer:0,byteLength:288,byteOffset:4200},{buffer:0,byteLength:192,byteOffset:4488},{buffer:0,byteLength:288,byteOffset:4680},{buffer:0,byteLength:288,byteOffset:4968},{buffer:0,byteLength:192,byteOffset:5256}],buffers:[{byteLength:5448,uri:"data:application/octet-stream;base64,6gUAQAAAgD8AAIC/6gUAQAAAgD8AAIC/6gUAQAAAgD8AAIC/6gUAQAAAgL8AAIC/6gUAQAAAgL8AAIC/6gUAQAAAgL8AAIC/6gUAQAAAgD8AAIA/6gUAQAAAgD8AAIA/6gUAQAAAgD8AAIA/6gUAQAAAgL8AAIA/6gUAQAAAgL8AAIA/6gUAQAAAgL8AAIA/AFC9OQAAgD8AAIC/AFC9OQAAgD8AAIC/AFC9OQAAgD8AAIC/AFC9OQAAgL8AAIC/AFC9OQAAgL8AAIC/AFC9OQAAgL8AAIC/AFC9OQAAgD8AAIA/AFC9OQAAgD8AAIA/AFC9OQAAgD8AAIA/AFC9OQAAgL8AAIA/AFC9OQAAgL8AAIA/AFC9OQAAgL8AAIA/AAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAPwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AACAPwAAAAAAAACAAACAvwAAAAAAAACAAAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAvwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AAAgPwAAAD8AACA/AAAAPwAAID8AAAA/AADAPgAAAD8AAMA+AAAAPwAAwD4AAAA/AAAgPwAAgD4AACA/AACAPgAAID8AAIA+AADAPgAAgD4AAMA+AACAPgAAwD4AAIA+AAAgPwAAQD8AACA/AABAPwAAYD8AAAA/AADAPgAAQD8AAAA+AAAAPwAAwD4AAEA/AAAgPwAAgD8AACA/AAAAAAAAYD8AAIA+AADAPgAAgD8AAAA+AACAPgAAwD4AAAAAAQAOABQAAQAUAAcACgAGABMACgATABcAFQASAAwAFQAMAA8AEAADAAkAEAAJABYABQACAAgABQAIAAsAEQANAAAAEQAAAAQAJsloQQAAgD8AAIC/JsloQQAAgD8AAIC/JsloQQAAgD8AAIC/JsloQQAAgL8AAIC/JsloQQAAgL8AAIC/JsloQQAAgL8AAIC/JsloQQAAgD8AAIA/JsloQQAAgD8AAIA/JsloQQAAgD8AAIA/JsloQQAAgL8AAIA/JsloQQAAgL8AAIA/JsloQQAAgL8AAIA/JslIQQAAgD8AAIC/JslIQQAAgD8AAIC/JslIQQAAgD8AAIC/JslIQQAAgL8AAIC/JslIQQAAgL8AAIC/JslIQQAAgL8AAIC/JslIQQAAgD8AAIA/JslIQQAAgD8AAIA/JslIQQAAgD8AAIA/JslIQQAAgL8AAIA/JslIQQAAgL8AAIA/JslIQQAAgL8AAIA/AAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAPwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AACAPwAAAAAAAACAAACAvwAAAAAAAACAAAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAvwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AAAgPwAAAD8AACA/AAAAPwAAID8AAAA/AADAPgAAAD8AAMA+AAAAPwAAwD4AAAA/AAAgPwAAgD4AACA/AACAPgAAID8AAIA+AADAPgAAgD4AAMA+AACAPgAAwD4AAIA+AAAgPwAAQD8AACA/AABAPwAAYD8AAAA/AADAPgAAQD8AAAA+AAAAPwAAwD4AAEA/AAAgPwAAgD8AACA/AAAAAAAAYD8AAIA+AADAPgAAgD8AAAA+AACAPgAAwD4AAAAAAACAPwAAgD8AAIC/AACAPwAAgD8AAIC/AACAPwAAgD8AAIC/AACAPwAAgL8AAIC/AACAPwAAgL8AAIC/AACAPwAAgL8AAIC/AACAPwAAgD8AAIA/AACAPwAAgD8AAIA/AACAPwAAgD8AAIA/AACAPwAAgL8AAIA/AACAPwAAgL8AAIA/AACAPwAAgL8AAIA/AACAvwAAgD8AAIC/AACAvwAAgD8AAIC/AACAvwAAgD8AAIC/AACAvwAAgL8AAIC/AACAvwAAgL8AAIC/AACAvwAAgL8AAIC/AACAvwAAgD8AAIA/AACAvwAAgD8AAIA/AACAvwAAgD8AAIA/AACAvwAAgL8AAIA/AACAvwAAgL8AAIA/AACAvwAAgL8AAIA/AAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAPwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AACAPwAAAAAAAACAAACAvwAAAAAAAACAAAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAvwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AAAgPwAAAD8AACA/AAAAPwAAID8AAAA/AADAPgAAAD8AAMA+AAAAPwAAwD4AAAA/AAAgPwAAgD4AACA/AACAPgAAID8AAIA+AADAPgAAgD4AAMA+AACAPgAAwD4AAIA+AAAgPwAAQD8AACA/AABAPwAAYD8AAAA/AADAPgAAQD8AAAA+AAAAPwAAwD4AAEA/AAAgPwAAgD8AACA/AAAAAAAAYD8AAIA+AADAPgAAgD8AAAA+AACAPgAAwD4AAAAA6gUAQAAAgD8AAIC/6gUAQAAAgD8AAIC/6gUAQAAAgD8AAIC/6gUAQAAAgL8AAIC/6gUAQAAAgL8AAIC/6gUAQAAAgL8AAIC/6gUAQAAAgD8AAIA/6gUAQAAAgD8AAIA/6gUAQAAAgD8AAIA/6gUAQAAAgL8AAIA/6gUAQAAAgL8AAIA/6gUAQAAAgL8AAIA/AFC9OQAAgD8AAIC/AFC9OQAAgD8AAIC/AFC9OQAAgD8AAIC/AFC9OQAAgL8AAIC/AFC9OQAAgL8AAIC/AFC9OQAAgL8AAIC/AFC9OQAAgD8AAIA/AFC9OQAAgD8AAIA/AFC9OQAAgD8AAIA/AFC9OQAAgL8AAIA/AFC9OQAAgL8AAIA/AFC9OQAAgL8AAIA/AAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAPwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AACAPwAAAAAAAACAAACAvwAAAAAAAACAAAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAvwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AAAgPwAAAD8AACA/AAAAPwAAID8AAAA/AADAPgAAAD8AAMA+AAAAPwAAwD4AAAA/AAAgPwAAgD4AACA/AACAPgAAID8AAIA+AADAPgAAgD4AAMA+AACAPgAAwD4AAIA+AAAgPwAAQD8AACA/AABAPwAAYD8AAAA/AADAPgAAQD8AAAA+AAAAPwAAwD4AAEA/AAAgPwAAgD8AACA/AAAAAAAAYD8AAIA+AADAPgAAgD8AAAA+AACAPgAAwD4AAAAAJsloQQAAgD8AAIC/JsloQQAAgD8AAIC/JsloQQAAgD8AAIC/JsloQQAAgL8AAIC/JsloQQAAgL8AAIC/JsloQQAAgL8AAIC/JsloQQAAgD8AAIA/JsloQQAAgD8AAIA/JsloQQAAgD8AAIA/JsloQQAAgL8AAIA/JsloQQAAgL8AAIA/JsloQQAAgL8AAIA/JslIQQAAgD8AAIC/JslIQQAAgD8AAIC/JslIQQAAgD8AAIC/JslIQQAAgL8AAIC/JslIQQAAgL8AAIC/JslIQQAAgL8AAIC/JslIQQAAgD8AAIA/JslIQQAAgD8AAIA/JslIQQAAgD8AAIA/JslIQQAAgL8AAIA/JslIQQAAgL8AAIA/JslIQQAAgL8AAIA/AAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAPwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AACAPwAAAAAAAACAAACAvwAAAAAAAACAAAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAvwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AAAgPwAAAD8AACA/AAAAPwAAID8AAAA/AADAPgAAAD8AAMA+AAAAPwAAwD4AAAA/AAAgPwAAgD4AACA/AACAPgAAID8AAIA+AADAPgAAgD4AAMA+AACAPgAAwD4AAIA+AAAgPwAAQD8AACA/AABAPwAAYD8AAAA/AADAPgAAQD8AAAA+AAAAPwAAwD4AAEA/AAAgPwAAgD8AACA/AAAAAAAAYD8AAIA+AADAPgAAgD8AAAA+AACAPgAAwD4AAAAA6gUAQAAAgD8AAIC/6gUAQAAAgD8AAIC/6gUAQAAAgD8AAIC/6gUAQAAAgL8AAIC/6gUAQAAAgL8AAIC/6gUAQAAAgL8AAIC/6gUAQAAAgD8AAIA/6gUAQAAAgD8AAIA/6gUAQAAAgD8AAIA/6gUAQAAAgL8AAIA/6gUAQAAAgL8AAIA/6gUAQAAAgL8AAIA/AFC9OQAAgD8AAIC/AFC9OQAAgD8AAIC/AFC9OQAAgD8AAIC/AFC9OQAAgL8AAIC/AFC9OQAAgL8AAIC/AFC9OQAAgL8AAIC/AFC9OQAAgD8AAIA/AFC9OQAAgD8AAIA/AFC9OQAAgD8AAIA/AFC9OQAAgL8AAIA/AFC9OQAAgL8AAIA/AFC9OQAAgL8AAIA/AAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAPwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AACAPwAAAAAAAACAAACAvwAAAAAAAACAAAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAvwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AAAgPwAAAD8AACA/AAAAPwAAID8AAAA/AADAPgAAAD8AAMA+AAAAPwAAwD4AAAA/AAAgPwAAgD4AACA/AACAPgAAID8AAIA+AADAPgAAgD4AAMA+AACAPgAAwD4AAIA+AAAgPwAAQD8AACA/AABAPwAAYD8AAAA/AADAPgAAQD8AAAA+AAAAPwAAwD4AAEA/AAAgPwAAgD8AACA/AAAAAAAAYD8AAIA+AADAPgAAgD8AAAA+AACAPgAAwD4AAAAAJsloQQAAgD8AAIC/JsloQQAAgD8AAIC/JsloQQAAgD8AAIC/JsloQQAAgL8AAIC/JsloQQAAgL8AAIC/JsloQQAAgL8AAIC/JsloQQAAgD8AAIA/JsloQQAAgD8AAIA/JsloQQAAgD8AAIA/JsloQQAAgL8AAIA/JsloQQAAgL8AAIA/JsloQQAAgL8AAIA/JslIQQAAgD8AAIC/JslIQQAAgD8AAIC/JslIQQAAgD8AAIC/JslIQQAAgL8AAIC/JslIQQAAgL8AAIC/JslIQQAAgL8AAIC/JslIQQAAgD8AAIA/JslIQQAAgD8AAIA/JslIQQAAgD8AAIA/JslIQQAAgL8AAIA/JslIQQAAgL8AAIA/JslIQQAAgL8AAIA/AAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAPwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AACAPwAAAAAAAACAAACAvwAAAAAAAACAAAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAvwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AAAgPwAAAD8AACA/AAAAPwAAID8AAAA/AADAPgAAAD8AAMA+AAAAPwAAwD4AAAA/AAAgPwAAgD4AACA/AACAPgAAID8AAIA+AADAPgAAgD4AAMA+AACAPgAAwD4AAIA+AAAgPwAAQD8AACA/AABAPwAAYD8AAAA/AADAPgAAQD8AAAA+AAAAPwAAwD4AAEA/AAAgPwAAgD8AACA/AAAAAAAAYD8AAIA+AADAPgAAgD8AAAA+AACAPgAAwD4AAAAA"}]}},VJ=function(){if("undefined"!=typeof globalThis)return globalThis;if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("unable to locate global object")},WJ=VJ(),ZJ=WJ.gl_trans__coders=WJ.gl_trans__coders||{};ZJ.inject=function(t){const e=t.toString(),n=e.indexOf("{")+1,i=e.substring(0,n),o=WJ.gl_trans__coders=WJ.gl_trans__coders||{};let s=`${i}\n    const _____getGlobal = ${VJ.toString()};\n    const g___lobals = _____getGlobal()\n    const tran_____scoders = g___lobals['gl_trans__coders'] = g___lobals['gl_trans__coders'] || {};`;for(const t in o)"inject"!==t&&"getTranscoder"!==t&&"registerTranscoder"!==t&&(s+='tran_____scoders["'+t+'"] ='+o[t].toString()+"\n;");return s+="\n("+VJ().ispace_gltf_loader_bundle.toString()+")({});\n",s+="\n"+e.substring(i.length),s},ZJ.registerTranscoder=function(t,e){ZJ[t]=e},ZJ.getTranscoder=function(t){return ZJ[t]};const qJ=VJ().ispace_gltf_loader;function XJ(t,e,n,i,o,s){const a=[],l=xy([],Q_([],n[0],n[1],n[2]),e,i),h=function(t){return new qJ.GLTFLoader("",JSON.parse(JSON.stringify(UJ[t]))).load().then((t=>t))}(t);return h.then((t=>{qT.exportGLTFPack(t).getMeshesInfo().forEach(((t,h)=>{const c=new Qb({color:o||t.materialInfo.baseColorFactor}),u=new aw(t.geometry,c);u.setUniform("uPickingId",s+h);const f=u.getDefines();f.HAS_PICKING_ID=2,u.setDefines(f),u.translate=e,u.rotation=n,u.scaling=i,cy(u.localTransform,l,t.nodeMatrix),u.originTransform=sy([],u.localTransform),u.originColor=o||t.materialInfo.baseColorFactor,a.push(u)})),s>100&&(a[0].properties.relatedMeshes=a.slice(1,2),a[1].properties.relatedMeshes=a.slice(0,1),a[2].properties.relatedMeshes=a.slice(3,4),a[3].properties.relatedMeshes=a.slice(2,3),a[4].properties.relatedMeshes=a.slice(5,6),a[5].properties.relatedMeshes=a.slice(4,5),a[6].properties.relatedMeshes=a.slice(0,6))})),a}function JJ(t,e){return Math.abs(t)*Math.sign(e)}function QJ(t,e){const n=t.getCoordinates(),i=e.coordinateToPointAtRes(n,e.getGLRes()),o=[i.x,i.y,0];Ny(o,o,YJ(e,t.getTranslation()));const s=function(t,e,n,i){return t._pointAtResToContainerPoint(e,n,void 0)}(e,new _e(o[0],o[1]),e.getGLRes());s.x+=85;const a=function(t,e,n,i){{const i=t.containerPointToCoordinate(e);return t.coordinateToPointAtRes(i,n)}}(e,s,e.getGLRes());return Math.sqrt(Math.pow(a.x-o[0],2)+Math.pow(a.y-o[1],2))/5.272881136101205}function YJ(t,e){if(!t)return e;const n=t.distanceToPointAtRes(e[0],e[1],t.getGLRes()),i=t.altitudeToPoint(e[2],t.getGLRes());return Fy([],JJ(n.x,e[0]),JJ(n.y,e[1]),JJ(i,e[2]))}class B{constructor(t){this.A=t,this._meshes=this.t()}setCoordinate(t){this.A=t}t(){const t=[],e=340/177,n=XJ("jiantou",[1.2*e,0,0],[0,0,90],[e,e,e],[89/255,206/255,147/255,0],7),i=XJ("jiantou",[0,1.2*e,0],[0,0,180],[e,e,e],[89/255,206/255,147/255,0],8),o=XJ("jiantou",[-1.2*e,0,0],[0,0,270],[e,e,e],[89/255,206/255,147/255,0],9),s=XJ("jiantou",[0,-1.2*e,0],[0,0,0],[e,e,e],[89/255,206/255,147/255,0],10);return t.push(n,i,o,s),t}getMeshes(){return this._meshes}}let KJ=class y{constructor(t){this.A=t,this._meshes=this.t()}setCoordinate(t){this.A=t}t(){const t=[],e=340/177,n=XJ("xuanzhuan",[0,0,0],[180,0,0],[.5*e,.5*e,.5*e],[50/255,130/255,184/255,.8],11);return t.push(n),t}getMeshes(){return this._meshes}},$J=class p{constructor(t){this.A=t,this._meshes=this.t()}setCoordinate(t){this.A=t}t(){const t=[],e=340/177,n=XJ("yuanhuan",[0,0,0],[0,0,0],[.5*e,.5*e,.5*e],[149/255,179/255,199/255,.5],12);return t.push(n),t}getMeshes(){return this._meshes}},tQ=class v{constructor(t){this.A=t,this._meshes=this.t()}setCoordinate(t){this.A=t}t(){const t=[],e=XJ("plane",[0,0,0],[0,0,0],[10,10,10],[1,0,0,.5],16);return t.push(e),t}getMeshes(){return this._meshes}};class d{constructor(t){this.A=t,this._meshes=this.t()}setCoordinate(t){this.A=t}t(){const t=[],e=XJ("xyzScale",[0,0,0],[0,0,0],[2,2,2],null,113);return t.push(e),t}getMeshes(){return this._meshes}}const eQ=[],nQ=[],iQ=[],rQ=[],oQ=[],sQ=[177/170,177/170,177/170],aQ=[],lQ=[1,2,3,4,12];class S{constructor(){this.translate=new B,this.rotation=new KJ,this.scaling=new $J,this.planeHelper=new tQ,this.xyzScaleHelper=new d,this._meshes=this.t(),this.i=!0}t(){const t={};t.translate=this.translate.getMeshes(),t.rotation=this.rotation.getMeshes(),t.scaling=this.scaling.getMeshes(),t.planeHelper=this.planeHelper.getMeshes(),t.xyzScale=this.xyzScaleHelper.getMeshes();const e=340/177,n=XJ("yuanhuan41",[-2.745*e,2.745*e,0],[90,0,0],[.5*e,.5*e,.5*e],[149/255,179/255,199/255,.6],1),i=XJ("yuanhuan41",[2.745*e,2.745*e,0],[-90,0,180],[.5*e,.5*e,.5*e],[50/255,130/255,184/255,.5],2),o=XJ("yuanhuan41",[2.745*e,-2.745*e,0],[90,0,180],[.5*e,.5*e,.5*e],[149/255,179/255,199/255,.6],3),s=XJ("yuanhuan41",[-2.745*e,-2.745*e,0],[-90,0,0],[.5*e,.5*e,.5*e],[50/255,130/255,184/255,.5],4),a=XJ("yuanpan",[0,0,0],[90,0,0],[.5*e,.5*e,.5*e],[89/255,206/255,147/255,.5],5),l=XJ("zzhou",[0,0,6.5],[90,0,0],[1,1,1],[14/255,127/255,191/255,1],6);return t.translate.push(n,i,o,s,a,l),t}updateMatrix(t,e,n,i,o){const s=e.getCoordinates(),a=t.coordinateToPointAtRes(s,t.getGLRes()),l=e.I();Fy(nQ,a.x,a.y,l);const h=Dy(eQ,o),c=YJ(t,e.getTranslation());Ny(nQ,nQ,c),Ny(nQ,nQ,h);for(const o in this._meshes)for(let s=0;s<this._meshes[o].length;s++){const a=this._meshes[o][s];for(let s=0;s<a.length;s++){const l=a[s],h=l.getUniform("uPickingId"),c=Dy(eQ,l.translate);let u=Dy(aQ,l.rotation);const f=l.scaling;if(11===h&&(this.i?(u[2]+=n,l.rotation[2]+=n):this.i||(u[2]+=n,l.rotation[2]+=n,u[0]=360,u[2]-=90)),h>100&&1===e.getTargets().length&&(u=e.getTargets()[0].getRotation()),lQ.indexOf(h)>-1)if(12!==h)f[0]+=i,f[1]+=i,f[2]+=i;else{const t=this._meshes.translate[4][0];f[0]=1.2*t.scaling[0],f[1]=1.2*t.scaling[0],f[2]=1.2*t.scaling[0]}let g=QJ(e,t);if(g=Fy(iQ,g,g,g),By(c,c,g),By(g,g,f),1===h||2===h||3===h||4===h){const t=By(oQ,f,sQ);By(c,c,t)}const A=Q_(rQ,u[0],u[1],u[2]);if(Ny(c,c,nQ),"xyzScale"===o){const t=xy([],A,c,g);cy(l.localTransform,t,l.originTransform)}else xy(l.localTransform,A,c,g)}}}getMeshes(t){const e={};return t?("xyzScale"===t?e[t]=this._meshes[t]:(e.translate=this._meshes.translate,"translate"!==t&&(e[t]=this._meshes[t])),e):e}o(t){this.i=t}dispose(){for(const t in this._meshes)for(let e=0;e<this._meshes[t].length;e++){const n=this._meshes[t][e];for(let t=0;t<n.length;t++){const e=n[t];e.geometry.dispose(),e.dispose()}}}}const hQ=[],cQ=[],uQ=[],fQ=new _e(0,0),dQ=[],gQ=[],pQ=[],AQ=[0,0,0];class z{constructor(){this.C=[],this.h=[0,0,0],this.l=[1,1,1],this.P=[0,0,0]}D(t){Array.isArray(t)?t.forEach((t=>{this.D(t)})):(t.on("remove",this.u,this),t.m={coordinate:t.getCoordinates(),translation:t.getTranslation(),rotation:t.getRotation(),scale:t.getScale()},this.C.push(t))}B(){this.C.forEach((t=>{t.off("remove",this.u,this)})),this.C=[]}p(t,e,n,i,o,s,a){for(let a=0;a<this.C.length;a++){const l=this.C[a],h=l.getRotation(),c=l.getScale(),u=this.v(s,l,i,n,e);let f=null;f=i>=0?i:i*(this.options&&this.options.scaleStrength||1);const g=Ny(pQ,Fy(hQ,f*c[0],f*c[1],f*c[2]),c),A=Math.min(...g);if(Math.abs(A)<o){const t=Math.abs(A);g[0]=g[0]*(o/t),g[1]=g[1]*(o/t),g[2]=g[2]*(o/t)}const m=Ny(h,n,h);l.setCoordinates(u),this.L(t,g,c);const w=l.getTranslation();l.setTRS(w,m,g)}Fy(pQ,i,i,i),Ny(this.P,n,this.P),Ny(this.l,pQ,this.l),Ny(this.h,e,this.h),t.indexOf("translate")>-1?a.fire("positionchange",{action:t,type:"positionchange",transformtarget:this.C,center:this.getCoordinates(),scale:this.l,rotation:this.P,translation:this.h,deltaTranslate:e,deltaRotation:n,deltaScale:i}):a.fire("transforming",{action:t,type:"transforming",transformtarget:this.C,center:this.C[0].getTransformOrigin(),scale:this.l,rotation:this.P,translation:this.h,deltaTranslate:e,deltaRotation:n,deltaScale:i})}v(t,e,n,i,o){const s=e.getCenter(),a=e.getTransformOrigin(),l=t.getGLRes(),h=t.coordinateToPointAtRes(s,l,fQ);h.z=t.altitudeToPoint(s.z,l),Fy(dQ,h.x,h.y,h.z||0);const c=t.coordinateToPointAtRes(a,l,fQ);c.z=t.altitudeToPoint(a.z,l),Fy(gQ,c.x,c.y,c.z||0);const u=e_(hQ,dQ,gQ),f=Q_(cQ,0,0,i[2]);Fy(pQ,n+1,n+1,n+1);Jy(u,u,xy(uQ,f,o,pQ)),Ny(u,u,gQ),fQ.set(u[0],u[1]);const g=t.pointAtResToCoordinate(fQ,l);return g.z=u[2]/t.altitudeToPoint(1,l),g}L(t,e,n){return"x-scale"===t&&(e[1]=n[1],e[2]=n[2]),"y-scale"===t&&(e[0]=n[0],e[2]=n[2]),"z-scale"===t&&(e[0]=n[0],e[1]=n[1]),e}M(){this.C.forEach((t=>{if(t.m){const{coordinate:e,translation:n,rotation:i,scale:o}=t.m;t.setCoordinates(e),t.setTRS(n,i,o)}}))}getScale(){return this.l}getTranslation(){return 1===this.C.length&&this.C[0].getTranslation()||AQ}getRotation(){return this.P}O(){return this.C[0]?this.C[0].getLayer():null}getCoordinates(){let t=0,e=0,n=0;const i=this.C.length;if(!i)return null;for(let o=0;o<i;o++){const i=this.C[o].getCenter();t+=i.x,e+=i.y,n+=i.z||0}t/=i,e/=i,n/=i;const o=new gh(t,e,n);for(let t=0;t<i;t++)this.C[t].setTransformOrigin(o);return o}u(t){const e=t.target,n=this.C.indexOf(e);n>-1&&(delete e.m,this.C.splice(n,1))}getTargets(){return this.C}I(){let t=0;const e=this.C.length;for(let n=0;n<e;n++)t+=this.C[n].getPointZ();return t/=e,t}F(){for(let t=0;t<this.C.length;t++)if(this.C[t].isVisible())return!0;return!1}}const mQ=[5,6,7,8,9,10],yQ=[5,7,8,9,10],_Q=[2,4,11],vQ=[1,3,12],xQ=[12,16],bQ=[1,2,3,4],wQ=[1,2,3,4,12],TQ=[],MQ=[],CQ=[],SQ=[],PQ=[],IQ=[],OQ=[];class IA extends(Xl(hh(Ql))){constructor(t={}){super(t),this.options=t,this.mouseAction="moving",this.U=this.options.mode||"translate",this.V=!0,this.TransformHelper=new S,this.S=new z,this.helperScene=new _w([]),this.addToMapCount=0,this.k()}setCoordinates(t){this.T.setCoordinates(t),this.transform(this.T)}enable(){return this.V=!0,this.layerRenderer&&this.layerRenderer.setToRedraw(),this}disable(){return this.V=!1,this.layerRenderer&&this.layerRenderer.setToRedraw(),this.map&&this.map.resetCursor(),this}setMode(t){this.U=t,this._(),this.layerRenderer&&this.layerRenderer.setToRedraw(),this.fire("modechange",{mode:t,type:"modechange"})}getMode(){return this.U}isEnable(){return this.V}H(t){mQ.indexOf(t)>-1?this.U="translate":_Q.indexOf(t)>-1?this.U="rotation":vQ.indexOf(t)>-1?this.U="scaling":"xyzScale"!==this.U&&(this.U="translate")}J(){return this.U}addTo(t){if(this.map)return this.N(),void console.warn("transform control has been added to a map, it suggest remove from the map before");this.addToMapCount++,this.map=t,this.R.addTo(this.map),this.container=t.getContainer(),t.on("dom:mousemove",this.K,this),t.on("dom:mousedown",this.G,this),t.on("dom:mouseup",this.j,this),t.on("zooming moving dragrotating",this.Z,this),this.Y()}k(){this.R=new kt(`${Fn}_transformcontrol`),this.T=new ct([0,0],{symbol:{url:"cube",modelHeight:1,uniforms:{polygonOpacity:.01}}}).addTo(this.R)}remove(){this.map&&(this.N(),this.TransformHelper.dispose(),this.R.remove(),this.layerRenderer&&this.layerRenderer.setToRedraw(),delete this.T,delete this.R,delete this.map,delete this.layer,delete this.layerRenderer,delete this.container,delete this.S)}N(){this.container&&this.map&&(this.map.off("dom:mousemove",this.K,this),this.map.off("dom:mousedown",this.G,this),this.map.off("dom:mouseup",this.j,this),this.map.off("zooming moving dragrotating",this.Z,this),this.layer&&this.layer.off("renderend",this.render,this))}K(t){if(this.W()){if(this.currentMousePosition={x:t.containerPoint.x,y:t.containerPoint.y},"moving"===this.mouseAction){const t=this.q();this.currentPickingObject=this.X(this.currentMousePosition,t,"meshes"),this.currentPickingObject&&null!=this.currentPickingObject.pickingId?(this.H(this.currentPickingObject.pickingId),this.$(6===this.currentPickingObject.pickingId)):(this.$(!1),this.H()),this.AA()}this.eA(this.currentMousePosition)}}G(t){if(!this.W()||0!==t.domEvent.button)return;const e=this.q();this.currentMousePosition={x:t.containerPoint.x,y:t.containerPoint.y},this.tA=!0,this.currentPickingObject=this.X(this.currentMousePosition,e,"meshes"),this.firstDownPoint=this.X(this.currentMousePosition,e,"meshes"),this.currentPickingObject&&null!=this.currentPickingObject.meshId?(this.mouseAction="transform",this.sA(this.currentPickingObject.pickingId),this.map.config("zoomable",!1),this.map.config("draggable",!1),this.layerRenderer&&this.layerRenderer.setToRedraw()):(this.mouseAction="pan",this.map.config("zoomable",!0),this.map.config("draggable",!0),this._()),this.lastMousePosition=this.currentMousePosition,this.lastPickingObject=this.currentPickingObject,this.lastPickingMesh=e[this.currentPickingObject.meshId]}j(){"transform"===this.mouseAction&&(this.firstDownPoint=null,this._(),this.tA=!0,this.fire("transformend",{action:this.iA,type:"transformend",transformtarget:this.S.getTargets()})),this.mouseAction="moving","xyzScale"!==this.U&&(this.U="translate"),this.map.config("zoomable",!0),this.map.config("draggable",!0),this.layerRenderer&&this.layerRenderer.setToRedraw()}Z(){const t=this.TransformHelper.planeHelper.getMeshes()[0][0],e=this.map.getBearing();t.rotation[2]=-e,this.nA()}nA(){this.W()&&(this.TransformHelper.updateMatrix(this.map,this.S,0,0,[0,0,0]),this.tA=!0)}picked(t){if(!this.layerRenderer)return!1;const e=this.q();let n=t;t instanceof _e||(n=this.map.coordinateToContainerPoint(new gh(t)));const i=this.X(n,e,"picked");return!(!i||null===i.meshId)}_(){const t=this.TransformHelper.getMeshes("scaling").scaling[0][0],e=340/177;t.scaling=[.6*e,.6*e,.6*e],this.layerRenderer&&(this.IA(t),this.oA())}oA(){this.TransformHelper._meshes.translate.forEach((t=>{for(let e=0;e<t.length;e++){const n=t[e];bQ.indexOf(n.getUniform("uPickingId"))>-1&&n.material.set("color",n.originColor)}}))}IA(t){const e=this.S.getCoordinates(),n=this.map.coordinateToPointAtRes(e,this.map.getGLRes()),i=[n.x,n.y,0],o=YJ(this.map,this.S.getTranslation());Ny(i,i,o);const s=Dy([],t.translate),a=t.scaling;let l=QJ(this.S,this.map);l=Fy([],l,l,l),By(s,s,l),By(l,l,a),Ny(s,s,i),xy(t.localTransform,[0,0,0,1],s,l),this.q().forEach((t=>{const e=t.getUniform("uPickingId");if(1===e||3===e||2===e||4===e){const e=Dy([],t.translate),n=170/177;t.scaling=[n,n,n];const o=t.scaling,s=t.rotation;let a=QJ(this.S,this.map);a=Fy([],a,a,a),By(e,e,a),By(a,a,o),Ny(e,e,i);const l=Q_([],s[0],s[1],s[2]);xy(t.localTransform,l,e,a)}}))}gA(t){const e=this.map.containerPointToCoordinate(t),n=this.map.coordinateToPointAtRes(e,this.map.getGLRes());return{point:[n.x,n.y]}}eA(t){if("transform"===this.mouseAction){const t=this.J(),e=YJ(this.map,this.S.getTranslation()),n=this.S.I();let i=null,o=null;if(e[2]+n<.01&&"z-translate"!==this.iA)i=this.gA(this.currentMousePosition),o=this.gA(this.lastMousePosition);else{const t=this.TransformHelper.planeHelper.getMeshes()[0];if(i=this.X(this.currentMousePosition,t,"plane"),o=this.X(this.lastMousePosition,t,"plane"),!i||null===i.meshId||!o||null===o.meshId)return}const s=[0,0,0],a=[0,0,0];let l=0,h=0,c=0;if("translate"===t){if("xy-translate"===this.iA){const t=i.point[1]-o.point[1];s[0]=i.point[0]-o.point[0],s[1]=t}else if("x-translate"===this.iA){s[0]=i.point[0]-o.point[0]}else if("y-translate"===this.iA){s[1]=i.point[1]-o.point[1]}else if("z-translate"===this.iA){let t=0;if(this.rA()){const e=this.map.getGLRes(),n=this.map._pointAtResToContainerPoint(new _e(o.point[0],o.point[1]),e),s=this.map._pointAtResToContainerPoint(new _e(i.point[0],i.point[1]),e),a=Bv(Ev(SQ,i.point[0]-o.point[0],i.point[1]-o.point[1]));t=s.y<n.y?a:-a}else t=i.point[2]-o.point[2];s[2]=t}}else if("rotation"===t)h=this.aA(i.point,o.point),this.TransformHelper.o(h>=0),a[2]+=h;else if("scaling"===t||"xyzScale"===t){const t=this.CA(),e=Bv(Ev(SQ,this.firstDownPoint.point[0]-t[0],this.firstDownPoint.point[1]-t[1])),n=Bv(Ev(SQ,o.point[0]-t[0],o.point[1]-t[1]));l=this.hA(i.point,o.point,t,n),c=this.hA(i.point,o.point,t,e)}this.TransformHelper.updateMatrix(this.map,this.S,h,c,s),this.S.p(this.iA,s,a,l,.01,this.map,this)}this.lastMousePosition=t,this.lastPickingObject=this.currentPickingObject;const e=this.q();this.lastPickingMesh=e[this.currentPickingObject.meshId]}hA(t,e,n,i,o){const s=(Bv(Ev(SQ,t[0]-n[0],t[1]-n[1]))-Bv(Ev(SQ,e[0]-n[0],e[1]-n[1])))/i;return o?(o[0]-.01)*s:s}CA(){const t=this.map,e=this.S.getCoordinates(),n=t.coordinateToPointAtRes(e,t.getGLRes()),i=Fy(PQ,n.x,n.y,0);return Ny(i,i,YJ(t,this.S.getTranslation())),i}$(t){const e=this.TransformHelper.planeHelper.getMeshes()[0][0],n=yy(CQ,e.localTransform),i=_y(MQ,e.localTransform);let o=Q_(TQ,0,0,0);const s=this.map.getBearing();t&&!this.rA()?(o=Q_(TQ,90,0,-s),0===e.rotation[0]&&(this.tA=!0),Fy(e.rotation,90,0,-s)):(90===e.rotation[0]&&(this.tA=!0),Fy(e.rotation,0,0,-s)),xy(e.localTransform,o,n,i)}rA(){if(this.map.getPitch())return!1;const t=this.map.cameraPosition,e=this.map.coordinateToPointAtRes(this.map.getCenter(),this.map.getGLRes());Fy(e,e.x,e.y,0);const n=this.S.getCoordinates(),i=this.map.coordinateToPointAtRes(n,this.map.getGLRes()),o=YJ(this.map,this.S.getTranslation()),s=Fy(CQ,i.x,i.y,0);return Yy(Hy([],t,Ny(s,s,o)),Hy([],t,e))<1/180*Math.PI}AA(){const t=this.q();if(this.currentPickingObject&&null!=this.currentPickingObject.meshId){this.wA(),this.lastPickingObject&&null!=this.lastPickingObject.meshId&&this.lastPickingObject.meshId!==this.currentPickingObject.meshId&&this.cA();const e=t[this.currentPickingObject.meshId];if(e&&xQ.indexOf(this.currentPickingObject.pickingId)<0)if(this.currentPickingObject.pickingId>100)this.QA(e);else{e.material.set("color",[e.originColor[0],e.originColor[1],e.originColor[2],.8]),this.fA(e,.5)}this.layerRenderer.setToRedraw()}else this.lastPickingObject&&null!=this.lastPickingObject.meshId&&(this.map.resetCursor(),this.cA(),this.layerRenderer.setToRedraw())}QA(t){const e=[1,179/255,2/255,1];t.material.set("color",e),t.properties.relatedMeshes&&t.properties.relatedMeshes.forEach((t=>{t.material.set("color",e)}))}wA(){6===this.currentPickingObject.pickingId?this.map.setCursor("ns-resize"):yQ.indexOf(this.currentPickingObject.pickingId)>-1?this.map.setCursor("move"):this.map.setCursor("pointer")}cA(){const t=this.lastPickingMesh;if(!t)return;const e=t.getUniform("uPickingId"),n=this.q();yQ.indexOf(e)>-1?n.forEach((t=>{yQ.indexOf(t.getUniform("uPickingId"))>-1&&t.material.set("color",t.originColor)})):wQ.indexOf(e)>-1?n.forEach((t=>{const e=t.getUniform("uPickingId");bQ.indexOf(e)>-1&&t.material.set("color",t.originColor)})):11===e&&n.forEach((t=>{bQ.indexOf(t.getUniform("uPickingId"))>-1&&t.material.set("color",t.originColor)})),t.material.set("color",t.originColor),t.properties.relatedMeshes&&t.properties.relatedMeshes.forEach((t=>{t.material.set("color",t.originColor)}))}fA(t,e){const n=t.getUniform("uPickingId"),i=this.q();yQ.indexOf(n)>-1?i.forEach((n=>{if(yQ.indexOf(n.getUniform("uPickingId"))>-1&&n.getUniform("uPickingId")!==t.getUniform("uPickingId")){n.material.set("color",[n.originColor[0],n.originColor[1],n.originColor[2],e])}})):"scaling"===this.U?i.forEach((t=>{const e=t.getUniform("uPickingId");if(1===e||3===e||2===e||4===e){t.material.set("color",[149/255,179/255,199/255,.8])}})):"rotation"===this.U&&i.forEach((t=>{const e=t.getUniform("uPickingId");if(1===e||3===e||2===e||4===e){const e=t.originColor;t.material.set("color",[e[0],e[1],e[2],0])}}))}reset(){this.map&&this.S&&(this.S.M(),this.TransformHelper.updateMatrix(this.map,this.S,0,0,[0,0,0]))}aA(t,e){const n=this.CA(),i=Ev(IQ,e[0]-n[0],e[1]-n[1]),o=Ev(OQ,t[0]-n[0],t[1]-n[1]),s=Math.atan2(i[1],i[0]);return(Math.atan2(o[1],o[0])-s)/Math.PI*180}sA(t){return this.iA=113===t||114===t?"x-scale":115===t||116===t?"z-scale":117===t||118===t?"y-scale":119===t?"xyz-scale":5===t?"xy-translate":6===t?"z-translate":7===t||9===t?"x-translate":8===t||10===t?"y-translate":11===t?"z-rotate":"scale",this.iA}transform(t){if(!t)return;if(this.layerRenderer&&this.layerRenderer.layer&&(this.layerRenderer.layer.off("renderend",this.render),this.layerRenderer.layer.off("resizeCanvas",this.lA)),!this.map)return void console.error("should add to a target first");if(this.S&&(this.S.B(),this.S.D(t)),!this.S.getTargets().length)return;this.TransformHelper.updateMatrix(this.map,this.S,0,0,[0,0,0]),this.PA(),this.tA=!0}getTransformTarget(){return this.S}u(){delete this.S}PA(){const t=this.S.O();t&&(t.off("renderend",this.render),t.off("resizeCanvas",this.lA));const e=this.map,n=t.getRenderer();this.layerRenderer=n,this.regl=n.regl,this.renderer=n.renderer,this.DA=this.layerRenderer.getFBORayPicking(),this.uA={projViewMatrix:e.projViewMatrix,projMatrix:e.projMatrix,viewMatrix:e.viewMatrix,pointSize:1},t.on("renderend",this.render,this),t.on("resizeCanvas",this.lA,this),n.setToRedraw()}lA(){this.DA.clear(),this.tA=!0}X(t,e,n){const i=this.map;if(!(i&&this.DA&&this.layerRenderer&&this.layerRenderer.canvas))return null;const o=i.getDevicePixelRatio(),s=t.x*o,a=t.y*o,l=this.uA;return(this.tA||this.layerRenderer.canvas.gl&&this.layerRenderer.canvas.gl.wrap||!this.mA||this.mA!==n)&&(this.DA.render(e,l,!0),this.mA=n,this.tA=!1),this.DA.pick(s,a,10,l,{viewMatrix:this.map.viewMatrix,projMatrix:this.map.projMatrix,returnPoint:!0})}Y(){const t=this.map.getDevicePixelRatio();this.bA=new zw({vert:"attribute vec3 aPosition;\nuniform mat4 projViewModelMatrix;\nvoid main()\n{\n    gl_Position = projViewModelMatrix * vec4(aPosition, 1.0);\n}\n",frag:"precision mediump float;\nuniform vec4 color;\nvoid main() {\n    gl_FragColor = color;\n}\n",uniforms:["color",{name:"projViewModelMatrix",type:"function",fn:function(t,e){return cy([],e.projViewMatrix,e.modelMatrix)}}],extraCommandProps:{viewport:{x:0,y:0,width:()=>this.map?this.map.width*t:1,height:()=>this.map?this.map.height*t:1},depth:{enable:!0,func:"always",mask:!0,range:[0,0]},blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}},defines:{}})}render(){if(!this.W())return;const t=this.q();this.helperScene.setMeshes(t);const e=this.layerRenderer.getFrameContext();if(e&&e.renderTarget&&this.layerRenderer.getFrameTimestamp()!==e.timestamp)return;this.nA(),this.bA.filter=e&&e.sceneFilter;this.renderer.render(this.bA,this.uA,this.helperScene,e&&e.renderTarget&&e.renderTarget.fbo)}q(){let t=[];const e=this.TransformHelper.getMeshes(this.U);for(const n in e){if("translate"===n)continue;const i=e[n];for(let e=0;e<i.length;e++)t=t.concat(i[e])}const n=e.translate;if(n)for(let e=0;e<n.length;e++)t=t.concat(n[e]);return t}W(){const t=this.layerRenderer,e=t&&t.layer;return t&&this.S&&e&&e.isVisible()&&this.S.F()&&this.regl&&this.V}}IA.mergeOptions({scaleStrength:2}),"undefined"!=typeof console&&console.log("@ispace/transform-control v0.105.9");
/*!
   * @ispace/video-layer v0.102.8
   * LICENSE : UNLICENSED
   * (c) 2016-2026 ispace.org
   */
/*!
  * Contains code from THREE.js
  * MIT License
  * https://github.com/mrdoob/three.js
  */
for(var EQ=[],kQ=0;kQ<6;kQ++)EQ[kQ]=[];var RQ=[];function LQ(t,e,n){var i,o,s,a,l,h,c,u,f,g,A,m,w,T,M,C,P;o=(i=t)[0],s=i[1],a=i[2],c=i[5],u=i[6],A=i[9],m=i[10],M=i[13],C=i[14],DQ(EQ[0],(l=i[3])-o,(f=i[7])-(h=i[4]),(w=i[11])-(g=i[8]),(P=i[15])-(T=i[12])),DQ(EQ[1],l+o,f+h,w+g,P+T),DQ(EQ[2],l+s,f+c,w+A,P+M),DQ(EQ[3],l-s,f-c,w-A,P-M),DQ(EQ[4],l-a,f-u,w-m,P-C),DQ(EQ[5],l+a,f+u,w+m,P+C);for(var I=0;I<6;I++){var O=EQ[I];if(RQ[0]=O[0]>0?e[1][0]:e[0][0],RQ[1]=O[1]>0?e[1][1]:e[0][1],RQ[2]=O[2]>0?e[1][2]:e[0][2],FQ(O,RQ)<0)return!1}return!0}function DQ(t,e,n,i,o){var s=1/Math.sqrt(e*e+n*n+i*i);return t[0]=e*s,t[1]=n*s,t[2]=i*s,t[3]=o*s,t}function FQ(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]}const NQ={vert:"\n    attribute vec3 aPosition;\n    attribute vec2 aTexCoord;\n    uniform mat4 projViewModelMatrix;\n    uniform mat4 positionMatrix;\n    uniform mat4 modelMatrix;\n    varying vec2 vTexCoords;\n    #include <get_output>\n    void main()\n    {\n        mat4 localPositionMatrix = getPositionMatrix();\n        vec4 localPosition = getPosition(aPosition);\n        gl_Position = projViewModelMatrix * localPositionMatrix * localPosition;\n        vTexCoords = aTexCoord;\n    }\n",frag:"\n    precision mediump float;\n    uniform sampler2D videoTexture;\n    uniform float opacity;\n\n    varying vec2 vTexCoords;\n    void main() {\n        vec4 color = texture2D(videoTexture, vTexCoords);\n        gl_FragColor = color * opacity;\n    }\n",uniforms:[{name:"projViewModelMatrix",type:"function",fn:(t,e)=>cy([],e.projViewMatrix,e.modelMatrix)},"texture","opacity"],positionAttribute:"POSITION",extraCommandProps:{depth:{enable:!0,func:"always"},cull:{enable:!1,face:"back"},frontFace:"cw",blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}},HQ=[1,0,3,3,2,1];function BQ(t,e,n){if(!t)return null;const i=t.coordinateToPointAtRes(e,t.getGLRes());return[i.x,i.y,n]}class y extends(Xl(hh(Ql))){constructor(t,e){super(e),this.setCoordinates(t),this.I()}setCoordinates(t){this.R=t}getCoordinates(){return this.R}setVideo(t){this.D="stop",this.options.url=t,delete this.options.elementId,this.I()}setElementId(t){this.D="stop",this.options.elementId=t,delete this.options.url,this.I()}I(){this.D="stop";const t=this.options.url;let e=document.getElementById(this.options.elementId);if(t&&(e=document.createElement("video"),e.src=t),!e)throw new Error("there is no element or url setting for video mask");e.autoplay=!0,e.loop=!0,e.muted=!0,e.play(),e.addEventListener("playing",(()=>{this.D="playing",this.fire("playing",{state:this.D,url:t})})),e.addEventListener("pause",(()=>{this.D="pause",this.fire("pause",{state:this.D,url:t})})),e.addEventListener("error",(()=>{throw this.D="pause",this.fire("error",{state:this.D,url:t}),new Error("video resource load error")})),this.video=e}getVideo(){return this.video}L(t){this.j=t}C(){return this.j}addTo(t){if(this.F)throw new Error("VideoSurface cannot be added to two or more layers at the same time.");return t.addSurfaces(this),this}show(){return this.options.visible=!0,this}hide(){return this.options.visible=!1,this}isVisible(){return this.options.visible}play(){this.video&&this.video.play()}pause(){this.video&&this.video.pause()}setAudio(t){this.video.muted=t}setOpacity(t){this.options.opacity=t}getOpacity(){return this.options.opacity}remove(){delete this.video;const t=this.getLayer();t&&t.removeVideoSurfaces(this),this.endEdit()}getLayer(){return this.F}A(){return"playing"===this.D}startEdit(){const t=this.getLayer();if(!t)return void console.warn("videosurface should be added to a map before edit");const e=t.getMap();if(!e)return void console.warn("videosurface should be added to a map before edit");if(this.N(),!this.G){const n=t.getId();this.G=new pA(`internal_${n}_edit`,{enableAltitude:!0}).addTo(e)}const n=this.getCoordinates();this.H=new od(n,{symbol:{lineColor:"#34495e",lineWidth:2,polygonFill:"rgb(135,196,240)",polygonOpacity:.1}}).addTo(this.G),this.H.startEdit({newVertexHandleSymbol:{polygonFill:"rgba(0, 0, 0, 0)",polygonOpacity:0,markerType:"ellipse",markerWidth:1,markerHeight:1}}),this.H.on("shapechange",(e=>{const n=e.target.getCoordinates()[0].slice(0,4).map((t=>[t.x,t.y,0]));this.setCoordinates(n),t.getRenderer().M(this)}),this)}endEdit(){this.G&&(this.H.endEdit(),this.H.remove(),this.G.remove()),delete this.G,delete this.H}N(){this.G&&this.G.clear(),delete this.H}}y.mergeOptions({opacity:1,visible:!0});class b extends Pf{constructor(t,e,n){!e||Array.isArray(e)||e instanceof y||(n=e,e=null),super(t,n),this.W={},this.videoId=0,this.W={},this.videoId=0,e&&this.addSurfaces(e)}addSurfaces(t){if(t)if(Array.isArray(t))t.forEach((t=>{this.addMarker(t)}));else{t.F=this,this.W[this.videoId]=t,t.L(this.videoId);const e=this.getRenderer();e?e.m()&&e.u(t):this.on("renderercreate",(e=>{e.renderer.m()&&e.renderer.u(t)})),this.videoId++}}showTopAlways(t){this.options.showTopAlways=t;const e=this.getRenderer();e&&e.v()}setDoubleSide(t){this.options.doubleSide=t;const e=this.getRenderer();e&&e.v()}getVideoSurfaces(){const t=[];for(const e in this.W)t.push(this.W[e]);return t}removeVideoSurfaces(t){if(Array.isArray(t))t.forEach((t=>{this.removeVideoSurfaces(t)}));else{const e=t.C(),n=this.getRenderer();n&&n.k(e),delete this.W[e]}}remove(){this.clear(),super.remove()}clear(){const t=this.getVideoSurfaces();for(let e=0;e<t.length;e++)t[e].remove()}}b.mergeOptions({renderer:"gl",doubleBuffer:!1,glOptions:null,markerEvents:!0,forceRenderOnZooming:!0,forceRenderOnMoving:!0,forceRenderOnRotating:!0,showTopAlways:!0,doubleSide:!0}),b.registerJSONType("VideoLayer"),b.registerRenderer("gl",class x extends vm.CanvasRenderer{constructor(t){super(t),this.t={}}draw(t,e){this.prepareCanvas(),this.i(e)}drawOnInteracting(t,e,n){this.i(n)}needToRedraw(){return!0}hitDetect(){return!1}createContext(){if(this.canvas.gl&&this.canvas.gl.wrap)this.gl=this.canvas.gl.wrap(),this.regl=this.canvas.gl.regl;else{const t=this.layer.options.glOptions||{alpha:!0,depth:!0,stencil:!0};this.glOptions=t,this.gl=this.gl||this.o(this.canvas,t),this.regl=Dm({gl:this.gl,extensions:["ANGLE_instanced_arrays","OES_texture_float","OES_texture_half_float","OES_texture_float_linear","OES_texture_half_float_linear","EXT_shader_texture_lod","OES_element_index_uint","OES_standard_derivatives","WEBGL_depth_texture"],optionalExtensions:this.layer.options.glExtensions||[]})}this.h(),this.l();const t=this.layer.getVideoSurfaces();for(let e=0;e<t.length;e++)this.u(t[e])}o(t,e){const n=["webgl","experimental-webgl"];let i=null;for(let o=0;o<n.length;++o){try{i=t.getContext(n[o],e)}catch(t){}if(i)break}return i}l(){const t=this.layer.getMap(),e=new cw(this.regl);this.renderer=e,this.p={projMatrix:t.projMatrix,projViewMatrix:t.projViewMatrix,viewMatrix:t.viewMatrix,halton:[.2107,-.0202],uHalton:[.2107,-.0202],uCameraPosition:t.cameraPosition,cameraPosition:t.cameraPosition,globalTexSize:[t.width,t.height]}}m(){return this.regl}h(){this.viewport={x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1},this.v()}v(){this._&&this._.dispose(),this.layer.options.showTopAlways?(NQ.extraCommandProps.depth.mask=!1,NQ.extraCommandProps.depth.range=[0,0]):(delete NQ.extraCommandProps.depth.mask,delete NQ.extraCommandProps.depth.range),NQ.extraCommandProps.cull.enable=!this.layer.options.doubleSide,this._=new zw(NQ)}u(t){const e=this.regl.texture(),n=new Qb({videoTexture:e,opacity:1}),i=t.getCoordinates(),{worldCenter:o,points:s}=this.O(i),a=this.S(s),l=new aw(a,n);this.T(l,o);const h=new _w(l),c=t.C();this.t[c]=h}M(t){const e=t.C(),n=this.t[e].getMeshes()[0],i=t.getCoordinates();n.geometry.dispose();const{worldCenter:o,points:s}=this.O(i),a=this.S(s);n.geometry=a,this.T(n,o)}i(t){const e=this.layer.getVideoSurfaces().filter((t=>t.isVisible()));if(!e.length)return;const n=this.P(e);if(!n)return;let i=null;t&&(i=t.renderTarget&&t.renderTarget.fbo),this.renderer.render(this._,this.p,n,i)}S(t){return new vb({POSITION:t,TEXCOORD:[0,0,1,0,1,1,0,1]},HQ,0,{primitive:"triangles",positionAttribute:"POSITION",uv0Attribute:"TEXCOORD",normalAttribute:"NORMAL",positionSize:3})}O(t){let e=[];const n=this.getMap(),i=new od(t).getCenter(),o=BQ(n,i,0);return this.V=o,n&&t.forEach((t=>{const i=new gh(t[0],t[1]),s=n.altitudeToPoint(t[2]||0,n.getGLRes()),a=BQ(n,i,s);a[0]=a[0]-o[0],a[1]=a[1]-o[1],e=e.concat(a)})),{worldCenter:o,points:e}}P(t){const e=[],n=this.layer.getMap();for(let i=0;i<t.length;i++){const o=t[i],s=this.t[o.C()];if(!s)continue;const a=s.getMeshes();for(let t=0;t<a.length;t++){const i=a[t],s=i.getMaterial(),l=s.get("videoTexture");l&&o.A()&&(l(o.video),s.set("opacity",o.getOpacity())),LQ(n.projViewMatrix,i.getBoundingBox())&&e.push(i)}}return e.length?new _w(e):null}T(t,e){xy(t.localTransform,Q_([],0,0,0),e,[1,1,1])}remove(){this._&&this._.dispose(),super.remove()}clearCanvas(){this.canvas&&(this.regl.clear({color:[0,0,0,0],depth:1,stencil:0}),super.clearCanvas())}k(t){const e=this.t[t];e&&e.getMeshes().forEach((t=>{t.geometry.dispose(),t.material&&t.material.dispose(),t.dispose()}))}}),"undefined"!=typeof console&&console.log("@ispace/video-layer v0.102.8"),"undefined"!=typeof window&&(window.ispacegl=window.ispacegl||{},window.ispacegl.transcoders=window.ispacegl.transcoders||GC),t.AEMarker=class ie extends Mt{constructor(t,e){super(t,e);const n=hs.extend({},GJ,this.options.symbol);this.setSymbol(n);const i=hs.extend({},jJ,this.options.symbol.uniforms);this.setUniforms(i)}},t.Ajax=cr,t.ArcConnectorLine=jd,t.ArcCurve=Ed,t.Area3DTool=class Area3DTool extends Measure3DTool{_addHelperLayer(){super._addHelperLayer(),this._helperLayer=new pA(Fn+"_area3dtool",{enableAltitude:!0}).addTo(this._map),this._markerLayer=new pA(Fn+"_area3dtool_marker",{enableAltitude:!0}).addTo(this._map)}_drawVertexMarker(){const t=this._getPolygonCoordinates(this._drawCoordinates);this._helperGeometry.setCoordinates(t),this._polygon.setCoordinates(t);const e=this._markerLayer.getGeometries(),n=this._helperLayer.getGeometries().length;for(let t=0;t<e.length;t++){const i=e[t].getId();i!=="label"+n&&i.indexOf(`${n}_`)>-1&&e[t].remove()}for(let t=0;t<this._drawCoordinates.length;t++)new ld(this._drawCoordinates[t],{id:n+"_"+t,symbol:this.options.vertexSymbol}).addTo(this._markerLayer);this._drawLabel()}_getPolygonCoordinates(t){const e=t.map((t=>t));return t.length>2&&e.push(t[0]),e}_drawLabel(){const t=this.getMeasureResult(),e=(("zh-CN"===this.options.language?0:1)?"area: ":": ")+this._getUnitContent(t),n=this._drawCoordinates[this._drawCoordinates.length-1],i=this._helperLayer.getGeometries().length,o=hs.extend({id:"label"+i},this.options.labelSymbol);this._label?(this._label.setContent(e),this._label.setCoordinates(n)):this._label=new Hd(e,n,o).addTo(this._markerLayer)}_getUnitContent(t){let e;e="zh-CN"===this.options.language?[" "," "," "," "]:[" sq.m"," sq.km"," sq.ft"," sq.mi"];let n="";if(this.options.metric&&(this._measure=t<1e6?t.toFixed(2):(t/1e6).toFixed(2),this._units=t<1e6?e[0]:e[1]),this.options.imperial){n.length>0&&(n+="\n");const i=27878400;this._measure=(t*=3.2808399)<i?t.toFixed(2):(t/i).toFixed(2),this._units=t<i?e[2]:e[3]}return n+=this._measure+this._units,n}_addHelperGeometry(t){this._helperGeometry||(this._helperGeometry=new cd([t],{symbol:this.options.symbol}).addTo(this._helperLayer),this._polygon=new od([t])),this._drawVertexMarker(),this._first=!0}getMeasureResult(){return this._polygon.getArea()}},t.AreaTool=Cg,t.B3DMLoader=ni,t.BBOXUtil=Ds,t.BillBoardPainter=Do,t.BillBoardPlugin=Jz,t.BoxInsideClipMask=class BoxInsideClipper extends BoxClipMask{constructor(t,e){super(t,e),this._mode="clip-inside"}},t.BoxOutsideClipMask=class BoxOutsideClipper extends BoxClipMask{constructor(t,e){super(t,e),this._mode="clip-outside"}},t.Browser=Gt,t.CMPTLoader=mi,t.COLOR_PROPERTIES=Vn,t.CRS=ph,t.Canvas=zl,t.CanvasLayer=yA,t.CanvasTileLayer=jp,t.Circle=Md,t.Class=Ql,t.ClipInsideMask=class ClipInsideMask extends ClipMask{constructor(t,e){super(t,e),this._mode="clip-inside"}},t.ClipOutsideMask=ClipOutsideMask,t.CollisionIndex=yl,t.ColorMask=class ColorMask extends Mask{constructor(t,e){super(t,e),this._mode="color"}setHeightRange(t){this.options.heightRange=t,this._fireEvent("heightrangechange")}_createMesh(t){const e=this._createGeometry(t),n=new aw(e);return this._setDefines(n),this._setLocalTransform(n),n}_updateUniforms(t,e,n){const i=this._getMaskMode();t.setUniform("maskMode",i);const o=this._getMaskColor();if(t.setUniform("maskColor",o),NS(e)){const i=this._getHeightRange();i[0]=(i[0]-n)*e,i[1]=(i[1]-n)*e,t.setUniform("heightRange",i)}}_setDefines(t){const e=t.getDefines();e.HAS_MASK_COLOR=1,t.setDefines(e)}_getHeightRange(){const t=[0,0];return this.options.heightRange&&(t[0]=this._altitudeToPoint(this.options.heightRange[0]),t[1]=this._altitudeToPoint(this.options.heightRange[1])),t}},t.ConnectorLine=Gd,t.ContextUtil=gI,t.Coordinate=gh,t.CubicBezierCurve=kd,t.Curve=Od,t.DEFAULT_TEXT_SIZE=Wn,t.Distance3DTool=class Distance3DTool extends Measure3DTool{_addHelperLayer(){super._addHelperLayer(),this._helperLayer=new pA(Fn+"_distance3dtool",{enableAltitude:!0}).addTo(this._map),this._markerLayer=new pA(Fn+"_distance3dtool_marker",{enableAltitude:!0}).addTo(this._map)}_drawVertexMarker(){this._helperGeometry.setCoordinates(this._drawCoordinates);const t=this._markerLayer.getGeometries(),e=this._helperLayer.getGeometries().length;for(let n=0;n<t.length;n++){const i=t[n].getId();i!=="label"+e&&i.indexOf(`${e}_`)>-1&&t[n].remove()}for(let t=0;t<this._drawCoordinates.length;t++)new ld(this._drawCoordinates[t],{id:e+"_"+t,symbol:this.options.vertexSymbol}).addTo(this._markerLayer);this._drawLabel()}_drawLabel(){const t=this.getMeasureResult(),e=(("zh-CN"===this.options.language?0:1)?"distance: ":": ")+this._getUnitContent(t),n=this._drawCoordinates[this._drawCoordinates.length-1],i=this._helperLayer.getGeometries().length,o=hs.extend({id:"label"+i},this.options.labelSymbol);this._label?(this._label.setContent(e),this._label.setCoordinates(n)):this._label=new Hd(e,n,o).addTo(this._markerLayer)}_getUnitContent(t){let e;e="zh-CN"===this.options.language?[" "," "," "," "]:[" m"," km"," feet"," mile"];let n="";return this.options.metric&&(this._measure=t<1e3?t.toFixed(1):(t/1e3).toFixed(2),this._units=t<1e3?e[0]:e[1]),this.options.imperial&&(n.length>0&&(n+="\n"),this._measure=(t*=3.2808399)<5280?t.toFixed(1):(t/5280).toFixed(2),this._units=t<5280?e[2]:e[3]),n+=this._measure+this._units,n}_addHelperGeometry(t){this._helperGeometry||(this._helperGeometry=new cd([t],{symbol:this.options.symbol}).addTo(this._helperLayer)),this._drawVertexMarker(),this._first=!0}getMeasureResult(){return this._helperGeometry.getLength()}},t.DistanceTool=Mg,t.DomUtil=hr,t.DragHandler=dh,t.DrawTool=Yd,t.DrawToolLayer=Zd,t.EffectLayer=Ht,t.EffectLine=class Xt extends Mt{constructor(t,e){super(t,e);const n=hs.extend({},HJ,this.options.symbol);this.setSymbol(n);const i=hs.extend({},BJ,this.options.symbol.uniforms);this.setUniforms(i),this.setShader("effectline"),this.l="effectmarker"}getEffectType(){return"sequence"}setTexture(t){return this.setUniform("texture",t),this}setHeight(t){return this.setUniform("modelHeight",t),this}setStartOpacity(t){return this.setUniform("startOpacity",t),this}setEndOpacity(t){return this.setUniform("endOpacity",t),this}},t.EffectLineLayer=Yt,t.EffectMarker=Mt,t.EffectRing=class Kt extends ct{constructor(t,e){super(t,e);const n=hs.extend({},zJ,this.options.symbol.uniforms);this.setUniforms(n),this.setShader("effectring"),this.l="effectring"}},t.EffectRingLayer=Qt,t.ElevateMask=class ElevateMask extends FlatMask{constructor(t,e){super(t,e),this.setElevation(e.elevation),this._mode="elevate"}setElevation(t){this.options.elevation=t,this.setFlatheight(this.options.elevation)}},t.Ellipse=Sd,t.Eventable=Xl,t.Extent=Ph,t.ExtrudePolygonLayer=Ul,t.FillPainter=FF,t.FillPlugin=Dz,t.FilterUtil=Ej,t.FlatInsideMask=class FlatInsideMask extends FlatMask{constructor(t,e){super(t,e),this._mode="flat-inside"}},t.FlatOutsideMask=class FlatInsideMask extends FlatMask{constructor(t,e){super(t,e),this._mode="flat-outside"}},t.GEOJSON_TYPES=Hn,t.GEOMETRY_COLLECTION_TYPES=Nn,t.GLContext=DC,t.GLTFGeometry=class Pt extends ct{tt(t){const e=this.getMap(),n=e.getGLRes(),i=e.distanceToPointAtRes(100,100,n,this.getCenter()),o=e.altitudeToPoint(100,n);return t[0]*=i.x/100,t[1]*=i.y/100,t[2]*=o/100,t}},t.GLTFLayer=kt,t.GLTFLineString=Rt,t.GLTFMarker=ct,t.GLTFMercatorGeometry=class Dt extends ct{tt(t){const e=this.getMap(),n=e.getGLRes(),i=this.getCoordinates(),o=e.coordToPointAtRes(i,n,IJ),s=xc.EPSG3857.project(i,SJ)._add(1,1),a=xc.EPSG3857.unproject(s,PJ),l=e.coordToPointAtRes(a,n,OJ),h=l.x-o.x,c=l.y-o.y,u=e.altitudeToPoint(100,n);return t[0]*=h,t[1]*=c,t[2]*=u/100,t}},t.GLTFPhongPlugin=Wz,t.GLTFStandardPlugin=Zz,t.Geo3DTilesLayer=qs,t.Geo3DTilesUtil=aV,t.Geo3DTransform=qV,t.GeoJSON=Td,t.GeoJSONVectorTileLayer=Qo,t.Geometry=cf,t.GeometryCollection=fd,t.GlobalConfig=s,t.GlobalEvent=Kl,t.GlowMarker=Vt,t.GlowMarkerLayer=Zt,t.GroundPainter=GroundPainter,t.GroupGLLayer=GroupGLLayer,t.GroupTileLayer=Np,t.Handler=Jl,t.Handlerable=hh,t.HeatmapPlugin=qz,t.HeatmapProcess=HeatmapProcess,t.Height3DTool=class Height3DTool extends Measure3DTool{_addHelperLayer(){super._addHelperLayer(),this._markerLayer=new pA(Fn+"_height3dtool_marker",{enableAltitude:!0}).addTo(this._map).bringToFront(),this._helperLayer=new pA(Fn+"_height3dtool",{enableAltitude:!0}).addTo(this._map).bringToFront()}_msOnDrawVertex(t){super._msOnDrawVertex(t),this._drawCoordinates.length>1&&(this._drawEnd(),this.disable())}_drawVertexMarker(){const t=this._markerLayer.getGeometries(),e=this._helperLayer.getGeometries().length;for(let n=0;n<t.length;n++){const i=t[n].getId();i!=="label"+e+"_"+n&&0===i.indexOf(`${e}_`)&&t[n].remove()}for(let t=0;t<this._drawCoordinates.length;t++)new ld(this._drawCoordinates[t],{id:e+"_"+t,symbol:this.options.vertexSymbol}).addTo(this._markerLayer);const n=this._drawCoordinates.length;if(n>1){const t=new gh([this._drawCoordinates[n-1].x,this._drawCoordinates[n-1].y,this._drawCoordinates[n-2].z]);new ld(t,{id:e+"_2",symbol:this.options.vertexSymbol}).addTo(this._markerLayer);const i=[].concat(this._drawCoordinates);i.push(t),i.push(this._drawCoordinates[0]);const o=i.map((t=>t.z));this._helperGeometry.setCoordinates(i),this._helperGeometry.setProperties({altitude:o});const s=this._map.getProjection().measureLenBetween(i[0],i[2]),a=i[1].z-i[2].z,l=Math.sqrt(Math.pow(s,2)+Math.pow(a,2));this._drawLabel(i,[l,a,s])}}_drawLabel(t,e){for(let n=0;n<t.length-1;n++){const i=t[n],o=t[n+1],s="zh-CN"===this.options.language?0:1,a=this._getUnitContent(e[n]),l=aE[s][n]+":"+a,h="label"+this._helperLayer.getGeometries().length+"_"+n,c=JSON.parse(JSON.stringify(this.options.labelSymbol));c.id=h,n<2&&(c.boxStyle.symbol.textDx*=-1);const u=1===n?i:new gh((i.x+o.x)/2,(i.y+o.y)/2,(i.z+o.z)/2),f=this._markerLayer.getGeometryById(h),g=`${h}_marker`,A=this._markerLayer.getGeometryById(g);f?(f.setContent(l),f.setCoordinates(u),A.setCoordinates(u)):(new Hd(l,u,c).addTo(this._markerLayer),new ld(u,{id:g,symbol:this.options.vertexSymbol}).addTo(this._markerLayer))}}_getUnitContent(t){let e;e="zh-CN"===this.options.language?[" "," "," "," "]:[" m"," km"," feet"," mile"];let n="";return this.options.metric&&(this._measure=t<1e3?t.toFixed(1):(t/1e3).toFixed(2),this._units=t<1e3?e[0]:e[1]),this.options.imperial&&(n.length>0&&(n+="\n"),this._measure=(t*=3.2808399)<5280?t.toFixed(1):(t/5280).toFixed(2),this._units=t<5280?e[2]:e[3]),n+=this._measure+this._units,n}_addHelperGeometry(t){this._helperGeometry||(this._helperGeometry=new cd([t],{symbol:this.options.symbol}).addTo(this._helperLayer)),this._drawVertexMarker(),this._first=!0}getMeasureResult(){return this._helperGeometry.getLength()}},t.HighlightUtil=eE,t.INTERNAL_LAYER_PREFIX=Fn,t.IconPainter=kH,t.IconPlugin=Hz,t.ImageLayer=lA,t.ImageMask=class ImageMask extends Mask{constructor(t,e){super(t,e),this._mode="texture"}setUrl(t){this.options.url=t;const e=this._mesh;if(e&&e.material){const t=e.material.get("maskTexture");if(t){this._createTexture(t);const e=this.getLayer();e&&e.getRenderer().setToRedraw()}}}_createMesh(t){const{geometry:e,copyGeometry:n}=this._createGeometry(t),i=new aw(e),o=t.texture();return this._createTexture(o),i.material=new Qb({maskTexture:o}),this._setDefines(i),this._setLocalTransform(i),this._copyMesh=new aw(n),this._setLocalTransform(this._copyMesh),i}_updateUniforms(t){const e=this._getMaskMode();t.setUniform("maskMode",e);const n=this._getMaskColor();if(t.setUniform("maskColor",n),this._positions&&this._positions.length)for(let e=0;e<4;e++)t.setUniform("mask_position"+e,this._positions.slice(3*e,3*e+3))}_setDefines(t){const e=t.getDefines();e.HAS_TEXTURE=1,t.setDefines(e)}_createTexture(t){const e=new Image;e.src=this.options.url,e.crossOrigin="anonymous",e.onload=function(){t(e)},e.onerror=function(){console.warn("Image load error")}}getBBox(){return this._copyMesh.getBoundingBox()}},t.JSONAble=lh,t.LRUCache=Xa,t.Label=Hd,t.Layer=Pf,t.LineGradientPlugin=Nz,t.LinePainter=zF,t.LinePlugin=Fz,t.LineString=cd,t.LineStringLayer=Ia,t.LitPlugin=Uz,t.Map=Lf,t.MapTool=Xd,t.MapboxUtil=Po,t.MapboxVectorTileLayer=Jo,t.Marker=ld,t.MaskLayerMixin=aO,t.MaskRendererMixin=SI,t.Measure3DTool=Measure3DTool,t.MicroTask=qa,t.MultiGLTFMarker=_t,t.MultiLineString=yd,t.MultiPoint=Ad,t.MultiPolygon=_d,t.NUMERICAL_PROPERTIES=Gn,t.NativeLinePainter=EB,t.NativeLinePlugin=zz,t.NativePointPainter=PB,t.OverlayLayer=Wd,t.PackUtil=Oj,t.ParticleLayer=vA,t.PhongPainter=WB,t.PhongPlugin=Gz,t.Point=_e,t.PointExtent=Oh,t.PointLayer=Ma,t.Polygon=od,t.PolygonLayer=Fa,t.QuadBezierCurve=Rd,t.RESOURCE_PROPERTIES=Bn,t.RESOURCE_SIZE_PROPERTIES=zn,t.RayCaster=RayCaster,t.Rectangle=Pd,t.ResourceProxy=_r,t.SYMBOLS_NEED_REBUILD_IN_VECTOR=Rj,t.SYMBOLS_NEED_REBUILD_IN_VT=kj,t.Sector=Id,t.Size=qn,t.SpatialReference=sf,t.StringUtil=xi,t.TextBox=Nd,t.TextMarker=Fd,t.TextPainter=wB,t.TextPlugin=Bz,t.TileConfig=lp,t.TileLayer=kp,t.TileSystem=sp,t.TransformControl=IA,t.Transformation=Eh,t.TubePlugin=Vz,t.Util=hs,t.Vector3DLayer=MD,t.VectorLayer=pA,t.VectorTileLayer=yD,t.VectorTileLayerRenderer=oD,t.VideoLayer=b,t.VideoMask=class VideoMask extends Mask{constructor(t,e){super(t,e),this._mode="texture"}play(){this._video&&this._video.play()}pause(){this._video&&this._video.pause()}setAudio(t){this._video&&(this.video.muted=t)}setUrl(t){this.options.url=t,this._createVideo(t)}getState(){return this._videoState}_createMesh(t){const{geometry:e,copyGeometry:n}=this._createGeometry(t),i=new aw(e),o=this._createVideoTexture(t);return i.material=new Qb({maskTexture:o}),this._setDefines(i),this._setLocalTransform(i),this._copyMesh=new aw(n),this._setLocalTransform(this._copyMesh),i}_updateUniforms(t){const e=this._getMaskMode();if(t.setUniform("maskMode",e),this._positions&&this._positions.length)for(let e=0;e<4;e++)t.setUniform("mask_position"+e,this._positions.slice(3*e,3*e+3));const n=this._getMaskColor();t.setUniform("maskColor",n)}_setDefines(t){const e=t.getDefines();e.HAS_TEXTURE=1,t.setDefines(e)}_createVideoTexture(t){this._createVideo();return t.texture()}_createVideo(){this._videoState="stop";const t=this.options.url;let e=document.getElementById(this.options.elementId);if(t&&(e=document.createElement("video"),e.src=t),!e)throw new Error("there is no element or url setting for video mask");e.autoplay=this.options.autoplay||!0,e.loop=this.options.loop||!0,e.muted=this.options.muted||!0,e.play(),e.addEventListener("playing",(()=>{this._videoState="playing"})),e.addEventListener("pause",(()=>{this._videoState="pause"})),this._video=e}_update(){const t=this._mesh;if(t&&t.material){const e=t.material.get("maskTexture");e&&this._video&&this._needUpdate()&&e(this._video)}}_needUpdate(){return"playing"===this._videoState}},t.VideoSurface=y,t.WMSTileLayer=Gp,t.WaterPlugin=Xz,t.WireframePainter=qB,t.WireframePlugin=jz,t.animate=Kf,t.animation=$f,t.color=kS,t.control=op,t.createREGL=Dm,t.earcut=bC,t.formatResourceUrl=vr,t.getDefaultSpatialReference=function(){return JSON.parse(JSON.stringify(of()))},t.getResouceCacheInstance=zs,t.glMatrix=zm,t.mat2=Wm,t.mat2d=Xm,t.mat3=ry,t.mat4=Ey,t.math=fa,t.measurer=Zh,t.parseSVG=Ir,t.projection=xc,t.quat=bv,t.quat2=Pv,t.registerWorkerAdapter=va,t.renderer=vm,t.reshader=wC,t.symbolizer=Lu,t.transcoders=GC,t.ui=Zg,t.vec2=Kv,t.vec3=h_,t.vec4=H_,t.worker=Em,"undefined"!=typeof console&&console.log("ispace-gl v0.112.1")}));
//# sourceMappingURL=ispace-gl.js.map
