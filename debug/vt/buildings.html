<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>pbr-buildings</title>

  <link rel="stylesheet" href="/maptalks/dist/maptalks.css" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="screen.css" />
  <!-- 需要用 maptalks worker 分支下的版本 -->
  <script src="/maptalks/dist/maptalks.js"></script>
  <script src="/maptalksgl/dist/maptalksgl-dev.js"></script>
  <script src="buildings.js"></script>
  <script src="../../packages/vt/dist/maptalks.vt.js"></script>
  <script src="../../packages/vt.basic/dist/maptalks.vt.basic.js"></script>
  <script src="js/dat.gui.min.js"></script>
</head>

<body>

  <div id="main">
    <div id="map2" style="position:absolute;top:80px;width:1100px;height:1000px;background-color:#fff;"></div>
    <!-- <canvas id="shadow" width=512 height=512 style="float:left;border:1px red solid"></canvas>
    <canvas id="shadow2" width=512 height=512 style="float:left;border:1px red solid"></canvas> -->

  </div>

  <script>
    var accessToken = 'pk.eyJ1IjoiemhlbmZ1IiwiYSI6ImNqamY2OXF0azA1M3kzdnF0enRoZm83aXQifQ.WpJebxPjCnmszaxHDRBrtw';
    var mapboxURL = 'https://api.mapbox.com/v4/mapbox.mapbox-streets-v7/{z}/{x}/{y}.vector.pbf?access_token=' + accessToken
    var map = new maptalks.Map('map2', {
      center: [13.416935229170008, 52.529564137540376],
      zoom: 11,
      pitch : 45,
      baseLayer: new maptalks.MapboxVectorTileLayer('vt', {
        urlTemplate: mapboxURL,
        background: [0.925,0.878,0.792,1],
        style: 'mbtiles.json'
      }),
      "center":[13.414627196474385,52.52909578112681],"zoom":16.309955844160633,"pitch":52.20000000000007,"bearing":0,
      "center":[13.418531244478004,52.533396361654326],"zoom":18.582413946875466,"pitch":52.20000000000007,"bearing":0,

      //纽约
      // "center":[-74.00621804388925,40.70693481549321],"zoom":17.45624930433703,"pitch":0,"bearing":-15.59999999999991,

      // "center":[13.420845330196812,52.53554217055179],"zoom":19,"pitch":33.00000000000021,"bearing":145.20000000000005,

      // //阴影有裂缝
      // "center":[13.414905354183702,52.52913153292073],"zoom":20,"pitch":33.00000000000021,"bearing":145.20000000000005,

      // bearing : -42,
      // baseLayer: osm
    });

    const mapPostProcessConfig = {
      enable: false,
      filmicGrain: {
        enable: true,
        factor: 0.15
      },
      vignette: {
        enable: true
      },
      colorLUT: {
        enable: true,
        // lut: './lookup_miss_etikate.png'
        lut: './lookup.png'
      }
    };
    // map.setPostProcessConfig(mapPostProcessConfig);

    var id = 0;
    var data = buildings.reduce(function (v, b) {
      for (let i = 0, l = b.features.length; i < l; i++) {
        b.features[i].id = id++;
        v.features.push(b.features[i]);
      }
      return v;
    }, {
      "type" : "FeatureCollection",
      "features" : []
    })

    console.log(data.features.length);

    const renderPlugin = {
        type : 'lit',
        dataConfig : {
          type : '3d-extrusion',
          altitudeProperty : 'height',
          altitudeScale : 1,
          defaultAltitude : 1,
          normal : true,
          uv : true,
          uvScale : [1, 1],
          // tangent: true
          // shadowVolume : true,
          // shadowDir : [-1, -1, 0]
        },
        sceneConfig : {
          animation : 'easeOutBounce',
          shadow : {
            type : 'esm',
            // type : 'stencil',
            enable : true,
            quality : 'high',
            opacity : 0.0,
            color : [0, 0, 0],
            blurOffset : 1,
            // debug : ['shadow', 'shadow2']
          },
          lights : {
            ambient: {
              resource: {
                url: './resources/industrial_room.hdr',
                sh: [[0.31809728408416826,0.31401226619030004,0.3134470104662589],[0.008704758145334807,0.011318408263042232,0.013078388966477488],[-0.0022599058076237222,0.002440201090172905,0.008080601204569696],[-0.006376439243529652,-0.008455040017515722,-0.010142167789138118],[-0.0010644849511110555,0.00010224644653697268,0.00048268834013221514],[-0.0021339277623529307,-0.0012152300796112823,-0.001073690833185554],[-0.0035723423448581156,-0.0030887617072984245,-0.003414213495055618],[-0.014779247139674757,-0.016330747724572967,-0.021623674274630286],[-0.010174472132809637,-0.009184355154793666,-0.006837585033142022]]
                ////echarts-gl上的例子
                // url: './resources/pisa.hdr',
                // sh: [
                //   [0.8216, 0.6652, 0.5816],
                //   [0.0265, -0.0286, -0.0697],
                //   [-0.0170, -0.0221, 0.0129],
                //   [-0.0024, 0.0028, 0.0057],
                //   [-0.0017, 0.0098, 0.0140],
                //   [-0.0026, -0.0008, 0.0014],
                //   [0.0197, -0.0080, -0.0268],
                //   [0.0269, 0.0155, 0.0024],
                //   [0.0294, 0.0102, -0.0056]
                // ]
                // exposure: 1.5
              },
              // color: [0.05, 0.05, 0.05],
              exposure: 1.0
            },
            directional: {
              color : [0.1, 0.1, 0.1],
              direction : [1, 0, -1],
              // intensity: 80000
            }
          }
        }
      };
      // #E9E7EC
    const litMaterial = {
      // 'baseColor': [233, 231, 236],
      // 'baseColorFactor': [233 / 255, 231 / 255, 236 / 255, 1],
      // 'metallicFactor' : 0,
      // 'roughnessFactor' : 0.7,
      // 'reflectance': 0.5,
      // 'clearCoat': 0,
      // // 'clearCoatNormalTexture': CLEAR_COAT_NORMAL_TEXTURE,
      // 'clearCoatRoughness': 0.5,
      // 'clearCoatIorChange': false,
      // 'normalTexture': 'http://localhost/maptalksgl-dev/debug/reshader/ibl/resources/rusted_iron/609-normal.jpg',
      // 'metallicRoughnessTexture': ROUGHNESS_METALLIC_TEXTURE,
      // 'uAlbedoTexture': 'http://localhost/maptalksgl-dev/debug/reshader/ibl/resources/not-power-of-2.jpg',
      // 'anisotropy': 0,
      // 'uvScale': [1, 1],  //纹理坐标的缩放比例
      // 'uvScaleFactor': 1,
      // 'uvOffset': [0, 0],      //纹理坐标的偏移量
      'uAlbedoPBR': [1, 1, 1, 1],
      'uRoughnessPBRFactor': 0,
      'uMetalnessPBRFactor': 0,
      'uOutputLinear': 1
    };

    const style =  {
      $root: '.',
      resources: [
        {
          // type: 'ambient',
          // url: '{$root}/resources/aft_lounge.hdr',
          // sh: [
          //   [0.08225932717323303, 0.1296476572751999, 0.18428272008895874],
          //   [-0.004491398110985756, -0.0062361168675124645, -0.005997033789753914],
          //   [0.02749081887304783, 0.057795193046331406, 0.1145947203040123],
          //   [0.03964025899767876, 0.03352731838822365, 0.020897403359413147],
          //   [-0.005459152162075043, -0.008918278850615025, -0.011838626116514206],
          //   [0.017447197809815407, 0.016732292249798775, 0.012003022246062756],
          //   [-0.003052285173907876, -0.00440911715850234, -0.004788860213011503],
          //   [0.01575229875743389, 0.017373336479067802, 0.015197779051959515],
          //   [0.018414868041872978, 0.027235284447669983, 0.030140453949570656]
          // ]
        }
      ],
      style: [
        {
          filter : true,
          renderPlugin,
          symbol: {
            material: litMaterial,
            polygonOpacity: 1,
            polygonFill: '#fff'/*{
              property : 'levels',
              stops : [
                [5, '#313695'],
                [3, '#4575b4'],
                [1, '#74add1']
              ]
            }*/
          }
        }
      ]
    };
    //'#313695', '#4575b4', '#74add1', '#abd9e9', '#e0f3f8', '#ffffbf', '#fee090', '#fdae61', '#f46d43', '#d73027', '#a50026'
    // test tile clipping mask
    var layer = new maptalks.GeoJSONVectorTileLayer('polygon1', {
      debug : false,
      // canvas: debugCanvas,
      data: data,
      hitDetect : false,
      antialias: false,
      pickingPoint: true,
      cascadeTiles: true
    });
    layer.setStyle(style);

    // style.style[0].filter = [
    //   "==",
    //   "$layer",
    //   "building"
    // ];

    // var layer = new maptalks.MapboxVectorTileLayer('buildings', {
    //   urlTemplate: mapboxURL,
    //   style,
    //   cascadeTiles: true
    // })

    // map.on('click', function (e) {
    //   alert(JSON.stringify(layer.identify(e.coordinate)));
    // });
    const sceneConfig = {
      shadow : {
        type : 'esm',
        // type : 'stencil',
        enable : true,
        quality : 'high',
        opacity : 1.0,
        color : [0, 0, 0],
        blurOffset : 1,
        lightDirection : renderPlugin.sceneConfig.lights.directional.direction
        // debug : ['shadow', 'shadow2']
      },
      postProcess: {
        enable: true,
        antialias: {
          enable: true
        },
        ssao: {
          enable: false
        },
        taa: {
          enable: true
        }
      }
    };
    // map.addLayer(layer);
    var groupLayer = new maptalks.GroupGLLayer('group', [layer], { antialias: false, sceneConfig }).addTo(map);

    function addLayer() {
      groupLayer.addTo(map);
    }

    function update() {
      litMaterial.uAlbedoPBR = [1, 0, 0, 1];
      layer.updateSymbol(0, style.style[0].symbol);
    }

    var bearing = 0;
    var paused = false;
    function changeView() {
      map.setBearing(bearing++);
      if (!paused) {
        requestAnimationFrame(changeView);
      }
    }

    // changeView();

    map.on('click', e => {
      // console.log(JSON.stringify(map.getBaseLayer().identify(e.coordinate)));
    });

    initGUI();

    function initGUI() {
      const gui = new dat.GUI( { width: 250 } );
      const dirConfig = renderPlugin.sceneConfig.lights.directional.direction;
      const direction = {
        x: dirConfig[0],
        y: dirConfig[1],
        z: dirConfig[2],
      };
      const folder = gui.addFolder('direction');
      folder.open();
      const xCtrl = folder.add(direction, 'x', -1, 1, 0.1);
      const yCtrl = folder.add(direction, 'y', -1, 1, 0.1);
      const zCtrl = folder.add(direction, 'z', -1, 1, 0.1);
      xCtrl.onChange(function () {
        dirConfig[0] = direction.x;
        layer.updateSceneConfig(0, renderPlugin.sceneConfig);
        groupLayer.setSceneConfig(sceneConfig);
      });
      yCtrl.onChange(function () {
        dirConfig[1] = direction.y;
        layer.updateSceneConfig(0, renderPlugin.sceneConfig);
        groupLayer.setSceneConfig(sceneConfig);
      });
      zCtrl.onChange(function () {
        dirConfig[2] = direction.z;
        layer.updateSceneConfig(0, renderPlugin.sceneConfig);
        groupLayer.setSceneConfig(sceneConfig);
      });

    }

    function updateMaterial(key, value) {
      const material = {};
      material[key] = value;
      if (key === 'baseColor') {
        material['baseColorFactor'] = [material.baseColor[0] / 255, material.baseColor[1] / 255, material.baseColor[2] / 255, 1];
      } else if (key === 'subsurface') {
        material['subsurfaceColor'] = [material.subsurface[0] / 255, material.subsurface[1] / 255, material.subsurface[2] / 255];
      }
      layer.updateSymbol(0, {
        material
      });
    }

  </script>
</body>

</html>
